<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/kubernetes-notes/setup/installer/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/kubernetes-notes/setup/installer/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>部署k8s集群 | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="部署k8s集群" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/kubernetes-notes/setup/installer/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="部署k8s集群">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="部署k8s集群"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/kubernetes-notes/" ><span class="active">Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/k8s-source-code-analysis/" ><span>Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/linux-notes/" ><span>Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.631e111c3229dd44ec629a51228d8fdf.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/kubernetes-notes/setup/installer/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">部署k8s集群</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-463cd148d535d90f13fd41ca8c743267">使用kubeadm部署生产环境kubernetes集群</a></li>


    
  
    
    
	
<li>2: <a href="#pg-46874a0d5c85725f7a95eacfdeaee161">使用kubespray安装kubernetes</a></li>


    
  
    
    
	
<li>3: <a href="#pg-1e3c685682ed41951a80a02b1a236fcc">使用minikube安装kubernetes</a></li>


    
  
    
    
	
<li>4: <a href="#pg-06181b6bb8970c2b2814c3aed2e7944d">使用kind安装kubernetes</a></li>


    
  
    
    
	
<li>5: <a href="#pg-eee653beaa5313391bca6e7f1ffaf477">安装k8s dashboard</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-463cd148d535d90f13fd41ca8c743267">1 - 使用kubeadm部署生产环境kubernetes集群</h1>
    
	<blockquote>
<p>本文为基于<code>kubeadm</code>搭建<code>生产环境</code>级别<code>高可用</code>的k8s集群。</p>
</blockquote>
<h1 id="1-环境准备">1. 环境准备</h1>
<h2 id="1-0-master硬件配置">1.0. master硬件配置</h2>
<p>参考：</p>
<ul>
<li>
<p><a href="https://help.aliyun.com/document_detail/98886.html">Master节点规格</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/document_detail/94292.html">高可靠推荐配置 - 容器服务 ACK - 阿里云</a></p>
</li>
</ul>
<p>Kubernetes集群Master节点上运行着etcd、kube-apiserver、kube-controller等核心组件，对于Kubernetes集群的稳定性有着至关重要的影响，对于生产环境的集群，必须慎重选择Master规格。Master规格跟集群规模有关，集群规模越大，所需要的Master规格也越高。</p>
<p><strong>说明</strong> ：可从多个角度衡量集群规模，例如节点数量、Pod数量、部署频率、访问量。这里简单的认为集群规模就是集群里的节点数量。</p>
<p>对于常见的集群规模，可以参见如下的方式选择Master节点的规格（对于测试环境，规格可以小一些。下面的选择能尽量保证Master负载维持在一个较低的水平上）。</p>
<table>
<thead>
<tr>
<th>节点规模</th>
<th>Master规格</th>
<th>磁盘</th>
</tr>
</thead>
<tbody>
<tr>
<td>1~5个节点</td>
<td>4核8 GB（不建议2核4 GB）</td>
<td></td>
</tr>
<tr>
<td>6~20个节点</td>
<td>4核16 GB</td>
<td></td>
</tr>
<tr>
<td>21~100个节点</td>
<td>8核32 GB</td>
<td></td>
</tr>
<tr>
<td><strong>100~200个节点</strong></td>
<td><strong>16核64 GB</strong></td>
<td></td>
</tr>
<tr>
<td><strong>1000个节点</strong></td>
<td><strong>32核128GB</strong></td>
<td><strong>1T SSD</strong></td>
</tr>
</tbody>
</table>
<p><strong>注意事项：</strong></p>
<ul>
<li>
<p><strong>由于Etcd的性能瓶颈，Etcd的数据存储盘尽量选择SSD磁盘。</strong></p>
</li>
<li>
<p><strong>为了实现多机房容灾，可将三台master分布在一个可用区下三个不同机房。</strong>（机房之间的网络延迟在10毫秒及以下级别）</p>
</li>
<li>
<p><strong>申请LB来做master节点的负载均衡实现高可用，LB作为apiserver的访问地址。</strong></p>
</li>
</ul>
<h2 id="1-1-设置防火墙端口策略">1.1. 设置防火墙端口策略</h2>
<p>生产环境设置k8s节点的iptables端口访问规则。</p>
<h3 id="1-1-1-master节点端口配置">1.1.1. master节点端口配置</h3>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>目的</th>
<th>使用者</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>入站</td>
<td>6443</td>
<td>Kubernetes API server</td>
<td>所有</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>2379-2380</td>
<td>etcd server client API</td>
<td>kube-apiserver, etcd</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td>Kubelet API</td>
<td>自身, 控制面</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10259</td>
<td>kube-scheduler</td>
<td>自身</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10257</td>
<td>kube-controller-manager</td>
<td>自身</td>
</tr>
</tbody>
</table>
<h3 id="1-1-2-worker节点端口配置">1.1.2. worker节点端口配置</h3>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>目的</th>
<th>使用者</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td>Kubelet API</td>
<td>自身, 控制面</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>30000-32767</td>
<td>NodePort Services</td>
<td>所有</td>
</tr>
</tbody>
</table>
<p>添加防火墙iptables规则</p>
<p>master节点开放6443、2379、2380端口。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>iptables -A INPUT -p tcp -m multiport --dports 6443,2379,2380,10250 -j ACCEPT
</span></span></code></pre></div><h2 id="1-2-关闭-swap-分区">1.2. 关闭​​swap​​分区</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@master ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">#swapoff -a</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@master ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@master ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># free -m</span>
</span></span><span style="display:flex;"><span>              total        used        free      shared  buff/cache   available
</span></span><span style="display:flex;"><span>Mem:            <span style="color:#0000cf;font-weight:bold">976</span>         <span style="color:#0000cf;font-weight:bold">366</span>         <span style="color:#0000cf;font-weight:bold">135</span>           <span style="color:#0000cf;font-weight:bold">6</span>         <span style="color:#0000cf;font-weight:bold">474</span>         <span style="color:#0000cf;font-weight:bold">393</span>
</span></span><span style="display:flex;"><span>Swap:             <span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># swap 一栏为0，表示已经关闭了swap</span>
</span></span></code></pre></div><h2 id="1-3-开启br-netfilter和bridge-nf-call-iptables">1.3.  开启br_netfilter和bridge-nf-call-iptables</h2>
<p>参考：https://imroc.cc/post/202105/why-enable-bridge-nf-call-iptables/</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置加载br_netfilter模块</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">overlay
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo modprobe overlay
</span></span><span style="display:flex;"><span>sudo modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 开启bridge-nf-call-iptables ，设置所需的 sysctl 参数，参数在重新启动后保持不变</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">net.bridge.bridge-nf-call-iptables  = 1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">net.ipv4.ip_forward                 = 1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 应用 sysctl 参数而不重新启动</span>
</span></span><span style="display:flex;"><span>sudo sysctl --system
</span></span></code></pre></div><h1 id="2-安装容器运行时">2. 安装容器运行时</h1>
<p>在所有主机上安装容器运行时，<code>推荐使用containerd为runtime</code>。以下分别是containerd与docker的安装命令。</p>
<h2 id="2-1-containerd">2.1. Containerd</h2>
<p>1、参考：<a href="../runtime/containerd/install-containerd.md">安装containerd</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for ubuntu</span>
</span></span><span style="display:flex;"><span>apt install -y containerd.io
</span></span></code></pre></div><p>2、生成默认配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>containerd config default &gt; /etc/containerd/config.toml
</span></span></code></pre></div><p>3、修改CgroupDriver为systemd</p>
<p>k8s官方推荐使用systemd类型的CgroupDriver。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>plugins.<span style="color:#4e9a06">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">[</span>plugins.<span style="color:#4e9a06">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc.options<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">SystemdCgroup</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>
</span></span></code></pre></div><p>4、重启containerd</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl restart containerd
</span></span></code></pre></div><h2 id="2-2-docker">2.2. Docker</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for ubuntu</span>
</span></span><span style="display:flex;"><span>apt install -y docker.io
</span></span></code></pre></div><p>官方建议配置cgroupdriver为systemd。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 修改docker进程管理器</span>
</span></span><span style="display:flex;"><span>vi /etc/docker/daemon.json
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;exec-opts&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> systemctl restart docker
</span></span><span style="display:flex;"><span>docker info <span style="color:#000;font-weight:bold">|</span> grep -i cgroup
</span></span></code></pre></div><h2 id="2-3-container-socket">2.3. Container Socket</h2>
<table>
<thead>
<tr>
<th>运行时</th>
<th>Unix 域套接字</th>
</tr>
</thead>
<tbody>
<tr>
<td>Containerd</td>
<td><code>unix:///var/run/containerd/containerd.sock</code></td>
</tr>
<tr>
<td>CRI-O</td>
<td><code>unix:///var/run/crio/crio.sock</code></td>
</tr>
<tr>
<td>Docker Engine (使用 cri-dockerd)</td>
<td><code>unix:///var/run/cri-dockerd.sock</code></td>
</tr>
</tbody>
</table>
<h1 id="3-安装kubeadm-kubelet-kubectl">3. 安装kubeadm,kubelet,kubectl</h1>
<blockquote>
<p>安装脚本可参考仓库：https://github.com/huweihuang/kubeadm-scripts.git</p>
</blockquote>
<p>在所有主机上安装kubeadm，kubelet，kubectl。最好版本与需要安装的k8s的版本一致。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 以Ubuntu系统为例</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装仓库依赖</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get install -y apt-transport-https ca-certificates curl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># use google registry</span>
</span></span><span style="display:flex;"><span>sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&#34;</span> <span style="color:#000;font-weight:bold">|</span> sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># or use aliyun registry</span>
</span></span><span style="display:flex;"><span>curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span style="color:#000;font-weight:bold">|</span> sudo apt-key add -
</span></span><span style="display:flex;"><span>tee /etc/apt/sources.list.d/kubernetes.list <span style="color:#4e9a06">&lt;&lt;EOF 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装指定版本的kubeadm, kubelet, kubectl</span>
</span></span><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install -y <span style="color:#000">kubelet</span><span style="color:#ce5c00;font-weight:bold">=</span>1.24.2-00 <span style="color:#000">kubeadm</span><span style="color:#ce5c00;font-weight:bold">=</span>1.24.2-00 <span style="color:#000">kubectl</span><span style="color:#ce5c00;font-weight:bold">=</span>1.24.2-00
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查询有哪些版本</span>
</span></span><span style="display:flex;"><span>apt-cache madison kubeadm
</span></span></code></pre></div><p><strong>离线下载安装</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">Version</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">Version</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">.24.2</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>wget https://dl.k8s.io/release/v<span style="color:#4e9a06">${</span><span style="color:#000">Version</span><span style="color:#4e9a06">}</span>/bin/linux/amd64/kubeadm
</span></span><span style="display:flex;"><span>wget https://dl.k8s.io/release/v<span style="color:#4e9a06">${</span><span style="color:#000">Version</span><span style="color:#4e9a06">}</span>/bin/linux/amd64/kubelet
</span></span><span style="display:flex;"><span>wget https://dl.k8s.io/release/v<span style="color:#4e9a06">${</span><span style="color:#000">Version</span><span style="color:#4e9a06">}</span>/bin/linux/amd64/kubectl
</span></span><span style="display:flex;"><span>chmod +x kubeadm kubelet kubectl
</span></span><span style="display:flex;"><span>cp kubeadm kubelet kubectl /usr/bin/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># add kubelet serivce</span>
</span></span><span style="display:flex;"><span>cat &gt; /lib/systemd/system/kubelet.service <span style="color:#4e9a06">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Description=kubelet: The Kubernetes Node Agent
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Documentation=https://kubernetes.io/docs/home/
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=/usr/bin/kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">StartLimitInterval=0
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">RestartSec=10
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/systemd/system/kubelet.service.d
</span></span><span style="display:flex;"><span>cat &gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf <span style="color:#4e9a06">&lt;&lt; \EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"># Note: This dropin only works with kubeadm and kubelet v1.11+
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=&#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=&#34;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"># This is a file that &#34;kubeadm init&#34; and &#34;kubeadm join&#34; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EnvironmentFile=-/etc/default/kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl <span style="color:#204a87">enable</span> kubelet
</span></span><span style="display:flex;"><span>systemctl restart kubelet
</span></span></code></pre></div><h1 id="4-配置kubeadm-config">4. 配置kubeadm config</h1>
<p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/">kubeadm Configuration (v1beta3) | Kubernetes</a></li>
<li><a href="https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta2/">kubeadm Configuration (v1beta2) | Kubernetes</a></li>
</ul>
<h2 id="4-1-配置项说明">4.1. 配置项说明</h2>
<h3 id="4-1-1-配置类型">4.1.1. 配置类型</h3>
<p>kubeadm config支持以下几类配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">InitConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubelet.config.k8s.io/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">KubeletConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeproxy.config.k8s.io/v1alpha1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">KubeProxyConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">JoinConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>可以使用以下命令打印init和join的默认配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm config print init-defaults
</span></span><span style="display:flex;"><span>kubeadm config print join-defaults
</span></span></code></pre></div><h3 id="4-1-2-init配置">4.1.2. Init配置</h3>
<p>kubeadm init配置中只有<code>InitConfiguration</code> 和 <code>ClusterConfiguration</code> 是必须的。</p>
<p><strong>InitConfiguration:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">InitConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">bootstrapTokens</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">nodeRegistration</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>bootstrapTokens</li>
<li>nodeRegistration
<ul>
<li>criSocket：runtime的socket</li>
<li>name：节点名称</li>
</ul>
</li>
<li>localAPIEndpoint
<ul>
<li>advertiseAddress：apiserver的广播IP</li>
<li>bindPort：k8s控制面安全端口</li>
</ul>
</li>
</ul>
<p><strong>ClusterConfiguration:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">networking</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiServer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">extraArgs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">extraVolumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>
<p>networking:</p>
<ul>
<li>podSubnet：Pod CIDR范围</li>
<li>serviceSubnet： service CIDR范围</li>
<li>dnsDomain</li>
</ul>
</li>
<li>
<p>etcd:</p>
<ul>
<li>dataDir：Etcd的数据存储目录</li>
</ul>
</li>
<li>
<p>apiserver</p>
<ul>
<li>certSANs：设置额外的apiserver的域名签名证书</li>
</ul>
</li>
<li>
<p>imageRepository：镜像仓库</p>
</li>
<li>
<p>controlPlaneEndpoint：控制面LB的域名</p>
</li>
<li>
<p>kubernetesVersion：k8s版本</p>
</li>
</ul>
<h2 id="4-2-init配置示例">4.2. Init配置示例</h2>
<p>在master节点生成默认配置，并修改配置参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm config print init-defaults &gt; kubeadm-config.yaml
</span></span></code></pre></div><p>修改配置内容</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">bootstrapTokens</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">groups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">system:bootstrappers:kubeadm:default-node-token</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">token</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abcdef.0123456789abcdef</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ttl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">24h0m0s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">usages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">signing</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">authentication</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">InitConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">localAPIEndpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">advertiseAddress</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1.2.3.4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 修改为apiserver的IP 或者去掉localAPIEndpoint则会读取默认IP。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bindPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6443</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">nodeRegistration</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">criSocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">unix:///var/run/containerd/containerd.sock</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">IfNotPresent</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">taints</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiServer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">certSANs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">lb.k8s.domain </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 添加额外的apiserver的域名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">&lt;vip/lb_ip&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">timeoutForControlPlane</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">4m0s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">certificatesDir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/kubernetes/pki</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">clusterName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">controllerManager</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">dns</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 默认为coredns</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">dataDir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/data/etcd  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 修改etcd的存储盘目录</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">imageRepository</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s.gcr.io </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 修改镜像仓库地址</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">controlPlaneEndpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lb.k8s.domain </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 修改控制面域名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kubernetesVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1.24.0</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># k8s 版本</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">networking</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dnsDomain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cluster.local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">serviceSubnet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.96.0.0</span><span style="color:#000">/12</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">podSubnet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.244.0.0</span><span style="color:#000">/16 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 设置pod的IP范围</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">scheduler</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">KubeletConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubelet.config.k8s.io/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">cgroupDriver</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">systemd  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 设置为systemd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>安装完成后可以查看kubeadm config</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get cm -n kube-system kubeadm-config -oyaml
</span></span></code></pre></div><h1 id="5-安装master控制面">5. 安装Master控制面</h1>
<p>提前拉取镜像：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm config images pull
</span></span></code></pre></div><h2 id="5-1-安装master">5.1. 安装master</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo kubeadm init --config kubeadm-config.yaml --upload-certs  --node-name &lt;nodename&gt;
</span></span></code></pre></div><p>部署参数说明：</p>
<ul>
<li>
<p>--control-plane-endpoint：指定控制面(kube-apiserver)的IP或DNS域名地址。</p>
</li>
<li>
<p>--apiserver-advertise-address：kube-apiserver的IP地址。</p>
</li>
<li>
<p>--pod-network-cidr：pod network范围，控制面会自动给每个节点分配CIDR。</p>
</li>
<li>
<p>--service-cidr：service的IP范围，default &quot;10.96.0.0/12&quot;。</p>
</li>
<li>
<p>--kubernetes-version：指定k8s的版本。</p>
</li>
<li>
<p>--image-repository：指定k8s镜像仓库地址。</p>
</li>
<li>
<p>--upload-certs ：标志用来将在所有控制平面实例之间的共享证书上传到集群。</p>
</li>
<li>
<p>--node-name：hostname-override，作为节点名称。</p>
</li>
</ul>
<p>执行完毕会输出添加master和添加worker的命令如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>You can now join any number of control-plane node by running the following <span style="color:#204a87">command</span> on each as a root:
</span></span><span style="display:flex;"><span>    kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 --control-plane --certificate-key f8902e114ef118304e561c3ecd4d0b543adc226b7a07f675f56564185ffe0c07
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span style="display:flex;"><span>As a safeguard, uploaded-certs will be deleted in two hours<span style="color:#000;font-weight:bold">;</span> If necessary, you can use kubeadm init phase upload-certs to reload certs afterward.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span>    kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866
</span></span></code></pre></div><h2 id="5-2-添加其他master">5.2. 添加其他master</h2>
<p>添加<code>master</code>和添加<code>worker</code>的差别在于添加<code>master</code>多了<code>--control-plane</code> 参数来表示添加类型为<code>master</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm join &lt;control-plane-endpoint&gt;:6443 --token &lt;token&gt; <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--discovery-token-ca-cert-hash sha256:&lt;hash&gt; <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--control-plane --certificate-key &lt;certificate-key&gt; <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--node-name &lt;nodename&gt;
</span></span></code></pre></div><h1 id="6-添加node节点">6. 添加Node节点</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm join &lt;control-plane-endpoint&gt;:6443 --token &lt;token&gt; <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--discovery-token-ca-cert-hash sha256:&lt;hash&gt; <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--cri-socket /run/containerd/containerd.sock <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--node-name &lt;nodename&gt;
</span></span></code></pre></div><h1 id="7-安装网络插件">7. 安装网络插件</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">## 如果安装之后node的状态都改为ready，即为成功</span>
</span></span><span style="display:flex;"><span>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>kubectl apply -f ./kube-flannel.yml
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span></code></pre></div><p>如果Pod CIDR的网段不是<code>10.244.0.0/16</code>，则需要加flannel配置中的网段更改为与Pod CIDR的网段一致。</p>
<h2 id="7-1-问题">7.1. 问题</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  Warning  FailedCreatePodSandBox  4m6s                kubelet            Failed to create pod sandbox: rpc error: <span style="color:#000">code</span> <span style="color:#ce5c00;font-weight:bold">=</span> Unknown <span style="color:#000">desc</span> <span style="color:#ce5c00;font-weight:bold">=</span> failed to setup network <span style="color:#204a87;font-weight:bold">for</span> sandbox <span style="color:#4e9a06">&#34;300d9b570cc1e23b6335c407b8e7d0ef2c74dc2fe5d7a110678c2dc919c62edf&#34;</span>: plugin <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;flannel&#34;</span> failed <span style="color:#ce5c00;font-weight:bold">(</span>add<span style="color:#ce5c00;font-weight:bold">)</span>: failed to delegate add: failed to <span style="color:#204a87">set</span> bridge addr: <span style="color:#4e9a06">&#34;cni0&#34;</span> already has an IP address different from 10.244.3.1/24
</span></span></code></pre></div><p><strong>原因：</strong></p>
<p>宿主机节点有<code>cni0</code>网卡，且网卡的IP段与flannel的CIDR网段不同，因此需要删除该网卡，让其重建。</p>
<p>查看cni0网卡</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ifconfig cni0 |grep -w inet</span>
</span></span><span style="display:flex;"><span>        inet 10.244.5.1  netmask 255.255.255.0  broadcast 10.244.116.255
</span></span></code></pre></div><p>查看flannel配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cat /run/flannel/subnet.env</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_NETWORK</span><span style="color:#ce5c00;font-weight:bold">=</span>10.244.0.0/16
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_SUBNET</span><span style="color:#ce5c00;font-weight:bold">=</span>10.244.116.1/24
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_MTU</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1450</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_IPMASQ</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span></code></pre></div><p>发现cni0 IP与FLANNEL_SUBNET网段不一致，因此删除cni0重建。</p>
<p><strong>解决：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ifconfig cni0 down    
</span></span><span style="display:flex;"><span>ip link delete cni0
</span></span></code></pre></div><h1 id="8-部署dashboard">8. 部署dashboard</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.0/aio/deploy/recommended.yaml
</span></span></code></pre></div><p>镜像： kubernetesui/dashboard:v2.5.0</p>
<p>默认端口：8443</p>
<p>登录页面需要填入token或kubeconfig</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1658371511/article/kubernetes/dashboard/dashboard_token.png" alt=""></p>
<p>参考：<a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">dashboard/creating-sample-user</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes-dashboard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cluster-admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes-dashboard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建用户</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n kubernetes-dashboard create token admin-user
</span></span></code></pre></div><h1 id="9-重置部署">9. 重置部署</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubeadm重置</span>
</span></span><span style="display:flex;"><span>kubeadm reset
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 清空数据目录</span>
</span></span><span style="display:flex;"><span>rm -fr /data/etcd
</span></span><span style="display:flex;"><span>rm -fr /etc/kubernetes
</span></span><span style="display:flex;"><span>rm -fr ~/.kube/
</span></span></code></pre></div><p>删除flannel</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ifconfig cni0 down
</span></span><span style="display:flex;"><span>ip link delete cni0
</span></span><span style="display:flex;"><span>ifconfig flannel.1 down
</span></span><span style="display:flex;"><span>ip link delete flannel.1
</span></span><span style="display:flex;"><span>rm -rf /var/lib/cni/
</span></span><span style="display:flex;"><span>rm -f /etc/cni/net.d/*
</span></span></code></pre></div><h1 id="10-问题排查">10. 问题排查</h1>
<h2 id="10-1-kubeadm-token过期">10.1. kubeadm token过期</h2>
<p>问题描述:</p>
<p>添加节点时报以下错误：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>discovery<span style="color:#ce5c00;font-weight:bold">]</span> The cluster-info ConfigMap does not yet contain a JWS signature <span style="color:#204a87;font-weight:bold">for</span> token ID <span style="color:#4e9a06">&#34;abcdef&#34;</span>, will try again
</span></span></code></pre></div><p>原因：token过期，初始化token后会在24小时候会被master删除。</p>
<p>解决办法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重新生成token</span>
</span></span><span style="display:flex;"><span>kubeadm token create --print-join-command
</span></span><span style="display:flex;"><span>kubeadm token list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubeadm token create</span>
</span></span><span style="display:flex;"><span>oumnnc.aqlxuvdbntlvzoiv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重新生成hash</span>
</span></span><span style="display:flex;"><span>openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt <span style="color:#000;font-weight:bold">|</span> openssl rsa -pubin -outform der 2&gt;/dev/null <span style="color:#000;font-weight:bold">|</span> openssl dgst -sha256 -hex <span style="color:#000;font-weight:bold">|</span> sed <span style="color:#4e9a06">&#39;s/^.* //&#39;</span>
</span></span></code></pre></div><p>基于新生成的token重新添加节点。</p>
<h2 id="10-2-修改kubeadm-join的master-ip或端口">10.2. 修改kubeadm join的master IP或端口</h2>
<p><code>kubeadm join</code>命令会去<code>kube-public</code>命名空间获取名为<code>cluster-info</code>的<code>ConfigMap</code>。如果需要修改kubeadm join使用的master的IP或端口，则需要修改cluster-info的configmap。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看cluster-info</span>
</span></span><span style="display:flex;"><span>kubectl -n kube-public get configmaps cluster-info -o yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 修改cluster-info</span>
</span></span><span style="display:flex;"><span>kubectl -n kube-public edit configmaps cluster-info
</span></span></code></pre></div><p>修改配置文件中的<code>server</code>字段</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">clusters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">certificate-authority-data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">xxx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://lb.k8s.domain:36443</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>执行kubeadm join的命令时指定新修改的master地址。</p>
<h2 id="10-3-conntrack-not-found">10.3. conntrack not found</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>preflight<span style="color:#ce5c00;font-weight:bold">]</span> Some fatal errors occurred:
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">[</span>ERROR FileExisting-conntrack<span style="color:#ce5c00;font-weight:bold">]</span>: conntrack not found in system path
</span></span></code></pre></div><p>解决方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt -y install conntrack
</span></span></code></pre></div><h2 id="10-4-kubelet-unable-to-determine-runtime-api-version">10.4. Kubelet: unable to determine runtime API version</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Error: failed to run Kubelet: unable to determine runtime API version: rpc error:code <span style="color:#ce5c00;font-weight:bold">=</span> Unavailable <span style="color:#000">desc</span> <span style="color:#ce5c00;font-weight:bold">=</span> connection error: <span style="color:#000">desc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;transport: Error while dialing dial unix: missing address&#34;</span> 
</span></span></code></pre></div><p>解决方法：</p>
<p>检查kubelet的启动参数，可以用二进制直接添加参数debug</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看启动参数是否遗漏，比如10-kubeadm.conf 文件参数缺失</span>
</span></span><span style="display:flex;"><span>systemctl cat --no-pager kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat /lib/systemd/system/kubelet.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/high-availability/">利用 kubeadm 创建高可用集群 | Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">使用 kubeadm 创建集群 | Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/ha-topology/">高可用拓扑选项 | Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/kubeadm-init/#custom-images">kubeadm init | Kubernetes</a></li>
<li><a href="https://pkg.go.dev/k8s.io/kubernetes@v1.24.2/cmd/kubeadm/app/apis/kubeadm/v1beta3">v1.24.2|kubeadm|v1beta3</a></li>
<li><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">Installing kubeadm | Kubernetes</a></li>
<li><a href="https://kubernetes.io/docs/reference/ports-and-protocols/">Ports and Protocols | Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/">容器运行时 | Kubernetes</a></li>
<li><a href="https://github.com/Mirantis/cri-dockerd">https://github.com/Mirantis/cri-dockerd</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/">配置 cgroup 驱动|Kubernetes</a></li>
<li><a href="https://github.com/flannel-io/flannel">GitHub: flannel is a network fabric for containers</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/web-ui-dashboard/">部署和访问 Kubernetes 仪表板（Dashboard） | Kubernetes</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-46874a0d5c85725f7a95eacfdeaee161">2 - 使用kubespray安装kubernetes</h1>
    
	<h1 id="1-环境准备">1. 环境准备</h1>
<h2 id="1-1-部署机器">1.1. 部署机器</h2>
<blockquote>
<p>以下机器为虚拟机</p>
</blockquote>
<table>
<thead>
<tr>
<th>机器IP</th>
<th>主机名</th>
<th>角色</th>
<th>系统版本</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>172.16.94.140</td>
<td>kube-master-0</td>
<td>k8s master</td>
<td>Centos 4.17.14</td>
<td>内存：3G</td>
</tr>
<tr>
<td>172.16.94.141</td>
<td>kube-node-41</td>
<td>k8s node</td>
<td>Centos 4.17.14</td>
<td>内存：3G</td>
</tr>
<tr>
<td>172.16.94.142</td>
<td>kube-node-42</td>
<td>k8s node</td>
<td>Centos 4.17.14</td>
<td>内存：3G</td>
</tr>
<tr>
<td>172.16.94.135</td>
<td></td>
<td>部署管理机</td>
<td></td>
<td>-</td>
</tr>
</tbody>
</table>
<h2 id="1-2-配置管理机">1.2. 配置管理机</h2>
<p>管理机主要用来部署k8s集群，需要安装以下版本的软件，具体可参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes-incubator/kubespray#requirements">https://github.com/kubernetes-incubator/kubespray#requirements</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes-incubator/kubespray/blob/master/requirements.txt">https://github.com/kubernetes-incubator/kubespray/blob/master/requirements.txt</a></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible&gt;<span style="color:#ce5c00;font-weight:bold">=</span>2.4.0
</span></span><span style="display:flex;"><span>jinja2&gt;<span style="color:#ce5c00;font-weight:bold">=</span>2.9.6
</span></span><span style="display:flex;"><span>netaddr
</span></span><span style="display:flex;"><span>pbr&gt;<span style="color:#ce5c00;font-weight:bold">=</span>1.6
</span></span><span style="display:flex;"><span>ansible-modules-hashivault&gt;<span style="color:#ce5c00;font-weight:bold">=</span>3.9.4
</span></span><span style="display:flex;"><span>hvac
</span></span></code></pre></div><p><strong>1、安装及配置ansible</strong></p>
<ul>
<li>参考<a href="https://blog.csdn.net/huwh_/article/details/81215579">ansible的使用</a>。</li>
<li>给部署机器配置SSH的免密登录权限，具体参考<a href="https://blog.csdn.net/huwh_/article/details/78006127">ssh免密登录</a>。</li>
</ul>
<p><strong>2、安装python-netaddr</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装pip</span>
</span></span><span style="display:flex;"><span>yum -y install epel-release
</span></span><span style="display:flex;"><span>yum -y install python-pip
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装python-netaddr</span>
</span></span><span style="display:flex;"><span>pip install netaddr
</span></span></code></pre></div><p><strong>3、升级Jinja</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Jinja 2.9 (or newer)</span>
</span></span><span style="display:flex;"><span>pip install --upgrade jinja2
</span></span></code></pre></div><h2 id="1-3-配置部署机器">1.3. 配置部署机器</h2>
<p>部署机器即用来运行k8s集群的机器，包括<code>Master</code>和<code>Node</code>。</p>
<p><strong>1、确认系统版本</strong></p>
<p>本文采用<code>centos7</code>的系统，建议将系统内核升级到<code>4.x.x</code>以上。</p>
<p><strong>2、关闭防火墙</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl stop firewalld
</span></span><span style="display:flex;"><span>systemctl disable firewalld
</span></span><span style="display:flex;"><span>iptables -F
</span></span></code></pre></div><p><strong>3、关闭swap</strong></p>
<p>Kubespary <code>v2.5.0</code>的版本需要关闭swap，具体参考</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/kubespray/blob/02cd5418c22d51e40261775908d55bc562206023/roles/kubernetes/preinstall/tasks/verify-settings.yml#L75">https://github.com/kubernetes-incubator/kubespray/blob/02cd5418c22d51e40261775908d55bc562206023/roles/kubernetes/preinstall/tasks/verify-settings.yml#L75</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Stop if swap enabled</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">assert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">that</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ansible_swaptotal_mb == 0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">when</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubelet_fail_swap_on|default(true)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ignore_errors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{{ ignore_assert_errors }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<p><code>V2.6.0</code> 版本去除了swap的检查，具体参考：</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/kubespray/commit/b902602d161f8c147f3d155d2ac5360244577127#diff-b92ae64dd18d34a96fbeb7f7e48a6a9b">https://github.com/kubernetes-incubator/kubespray/commit/b902602d161f8c147f3d155d2ac5360244577127#diff-b92ae64dd18d34a96fbeb7f7e48a6a9b</a></li>
</ul>
</blockquote>
<p>执行关闭swap命令<code>swapoff -a</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@master ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">#swapoff -a</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@master ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@master ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># free -m</span>
</span></span><span style="display:flex;"><span>              total        used        free      shared  buff/cache   available
</span></span><span style="display:flex;"><span>Mem:            <span style="color:#0000cf;font-weight:bold">976</span>         <span style="color:#0000cf;font-weight:bold">366</span>         <span style="color:#0000cf;font-weight:bold">135</span>           <span style="color:#0000cf;font-weight:bold">6</span>         <span style="color:#0000cf;font-weight:bold">474</span>         <span style="color:#0000cf;font-weight:bold">393</span>
</span></span><span style="display:flex;"><span>Swap:             <span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># swap 一栏为0，表示已经关闭了swap</span>
</span></span></code></pre></div><p><strong>4、确认部署机器内存</strong></p>
<p>由于本文采用虚拟机部署，内存可能存在不足的问题，因此将虚拟机内存调整为3G或以上；如果是物理机一般不会有内存不足的问题。具体参考：</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/kubespray/blob/95f1e4634a1c50fa77312d058a2b713353f4307e/roles/kubernetes/preinstall/tasks/verify-settings.yml#L52">https://github.com/kubernetes-incubator/kubespray/blob/95f1e4634a1c50fa77312d058a2b713353f4307e/roles/kubernetes/preinstall/tasks/verify-settings.yml#L52</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Stop if memory is too small for masters</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">assert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">that</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ansible_memtotal_mb &gt;= 1500</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ignore_errors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{{ ignore_assert_errors }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">when</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inventory_hostname in groups[&#39;kube-master&#39;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Stop if memory is too small for nodes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">assert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">that</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ansible_memtotal_mb &gt;= 1024</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ignore_errors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{{ ignore_assert_errors }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">when</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inventory_hostname in groups[&#39;kube-node&#39;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="1-4-涉及镜像">1.4. 涉及镜像</h2>
<p><code>Docker</code>版本为<code>17.03.2-ce</code>。</p>
<p><strong>1、Master节点</strong></p>
<table>
<thead>
<tr>
<th>镜像</th>
<th>版本</th>
<th>大小</th>
<th>镜像ID</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>gcr.io/google-containers/hyperkube</td>
<td>v1.9.5</td>
<td>620 MB</td>
<td>a7e7fdbc5fee</td>
<td>k8s</td>
</tr>
<tr>
<td>quay.io/coreos/etcd</td>
<td>v3.2.4</td>
<td>35.7 MB</td>
<td>498ffffcfd05</td>
<td></td>
</tr>
<tr>
<td>gcr.io/google_containers/pause-amd64</td>
<td>3.0</td>
<td>747 kB</td>
<td>99e59f495ffa</td>
<td></td>
</tr>
<tr>
<td>quay.io/calico/node</td>
<td>v2.6.8</td>
<td>282 MB</td>
<td>e96a297310fd</td>
<td>calico</td>
</tr>
<tr>
<td>quay.io/calico/cni</td>
<td>v1.11.4</td>
<td>70.8 MB</td>
<td>4c4cb67d7a88</td>
<td>calico</td>
</tr>
<tr>
<td>quay.io/calico/ctl</td>
<td>v1.6.3</td>
<td>44.4 MB</td>
<td>46d3aace8bc6</td>
<td>calico</td>
</tr>
</tbody>
</table>
<p><strong>2、Node节点</strong></p>
<table>
<thead>
<tr>
<th>镜像</th>
<th>版本</th>
<th>大小</th>
<th>镜像ID</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>gcr.io/google-containers/hyperkube</td>
<td>v1.9.5</td>
<td>620 MB</td>
<td>a7e7fdbc5fee</td>
<td>k8s</td>
</tr>
<tr>
<td>gcr.io/google_containers/pause-amd64</td>
<td>3.0</td>
<td>747 kB</td>
<td>99e59f495ffa</td>
<td></td>
</tr>
<tr>
<td>quay.io/calico/node</td>
<td>v2.6.8</td>
<td>282 MB</td>
<td>e96a297310fd</td>
<td>calico</td>
</tr>
<tr>
<td>quay.io/calico/cni</td>
<td>v1.11.4</td>
<td>70.8 MB</td>
<td>4c4cb67d7a88</td>
<td>calico</td>
</tr>
<tr>
<td>quay.io/calico/ctl</td>
<td>v1.6.3</td>
<td>44.4 MB</td>
<td>46d3aace8bc6</td>
<td>calico</td>
</tr>
<tr>
<td>gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64</td>
<td>1.14.8</td>
<td>40.9 MB</td>
<td>c2ce1ffb51ed</td>
<td>dns</td>
</tr>
<tr>
<td>gcr.io/google_containers/k8s-dns-sidecar-amd64</td>
<td>1.14.8</td>
<td>42.2 MB</td>
<td>6f7f2dc7fab5</td>
<td>dns</td>
</tr>
<tr>
<td>gcr.io/google_containers/k8s-dns-kube-dns-amd64</td>
<td>1.14.8</td>
<td>50.5 MB</td>
<td>80cc5ea4b547</td>
<td>dns</td>
</tr>
<tr>
<td>gcr.io/google_containers/cluster-proportional-autoscaler-amd64</td>
<td>1.1.2</td>
<td>50.5 MB</td>
<td>78cf3f492e6b</td>
<td></td>
</tr>
<tr>
<td>gcr.io/google_containers/kubernetes-dashboard-amd64</td>
<td>v1.8.3</td>
<td>102 MB</td>
<td>0c60bcf89900</td>
<td>dashboard</td>
</tr>
<tr>
<td>nginx</td>
<td>1.13</td>
<td>109 MB</td>
<td>ae513a47849c</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>3、说明</strong></p>
<ul>
<li>镜像被墙并且全部镜像下载需要较多时间，建议提前下载到部署机器上。</li>
<li>hyperkube镜像主要用来运行k8s核心组件（例如kube-apiserver等）。</li>
<li>此处使用的网络组件为calico。</li>
</ul>
<h1 id="2-部署集群">2. 部署集群</h1>
<h2 id="2-1-下载kubespary的源码">2.1. 下载kubespary的源码</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/kubernetes-incubator/kubespray.git
</span></span></code></pre></div><h2 id="2-2-编辑配置文件">2.2. 编辑配置文件</h2>
<h3 id="2-2-1-hosts-ini">2.2.1. hosts.ini</h3>
<p><code>hosts.ini</code>主要为部署节点机器信息的文件，路径为：<code>kubespray/inventory/sample/hosts.ini</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> kubespray
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 复制一份配置进行修改</span>
</span></span><span style="display:flex;"><span>cp -rfp inventory/sample inventory/k8s
</span></span><span style="display:flex;"><span>vi inventory/k8s/hosts.ini
</span></span></code></pre></div><p>例如：</p>
<blockquote>
<p>hosts.ini文件可以填写部署机器的登录密码，也可以不填密码而设置ssh的免密登录。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Configure &#39;ip&#39; variable to bind kubernetes services on a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># different ip than the default iface</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 主机名             ssh登陆IP                        ssh用户名               ssh登陆密码                 机器IP          子网掩码</span>
</span></span><span style="display:flex;"><span>kube-master-0     <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.140   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.140   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-41      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.141   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.141   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-42      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.142   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.142   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># configure a bastion host if your nodes are not directly reachable</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># bastion ansible_ssh_host=x.x.x.x</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>kube-master<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-master-0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>etcd<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-master-0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>kube-node<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-node-41
</span></span><span style="display:flex;"><span>kube-node-42
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>k8s-cluster:children<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-node
</span></span><span style="display:flex;"><span>kube-master
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>calico-rr<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h3 id="2-2-2-k8s-cluster-yml">2.2.2. k8s-cluster.yml</h3>
<p><code>k8s-cluster.yml</code>主要为k8s集群的配置文件，路径为：<code>kubespray/inventory/k8s/group_vars/k8s-cluster.yml</code>。该文件可以修改安装的k8s集群的版本，参数为：kube_version: v1.9.5。具体可参考：</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/kubespray/blob/master/inventory/sample/group_vars/k8s-cluster.yml#L22">https://github.com/kubernetes-incubator/kubespray/blob/master/inventory/sample/group_vars/k8s-cluster.yml#L22</a></li>
</ul>
<h2 id="2-3-执行部署操作">2.3. 执行部署操作</h2>
<p>涉及文件为<code>cluster.yml</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 进入主目录</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> kubespray
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 执行部署命令</span>
</span></span><span style="display:flex;"><span>ansible-playbook -i inventory/k8s/hosts.ini cluster.yml -b -vvv
</span></span></code></pre></div><blockquote>
<p>-vvv 参数表示输出运行日志</p>
</blockquote>
<p>如果需要<code>重置</code>可以执行以下命令：</p>
<p>涉及文件为<code>reset.yml</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-playbook -i inventory/k8s/hosts.ini reset.yml -b -vvv
</span></span></code></pre></div><h1 id="3-确认部署结果">3. 确认部署结果</h1>
<h2 id="3-1-ansible的部署结果">3.1. ansible的部署结果</h2>
<p>ansible命令执行完，出现以下日志，则说明部署成功，否则根据报错内容进行修改。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PLAY RECAP *****************************************************************************
</span></span><span style="display:flex;"><span>kube-master-0              : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">309</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">30</span>   <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>kube-node-41               : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">203</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span>    <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>kube-node-42               : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">203</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span>    <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>localhost                  : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>    <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><p>以下为部分部署执行日志：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubernetes/preinstall : Update package management cache <span style="color:#ce5c00;font-weight:bold">(</span>YUM<span style="color:#ce5c00;font-weight:bold">)</span> --------------------23.96s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes/preinstall/tasks/main.yml:121 
</span></span><span style="display:flex;"><span>kubernetes/master : Master <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">wait</span> <span style="color:#204a87;font-weight:bold">for</span> the apiserver to be running ----------------23.44s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes/master/handlers/main.yml:79 
</span></span><span style="display:flex;"><span>kubernetes/preinstall : Install packages requirements ----------------------------20.20s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes/preinstall/tasks/main.yml:203 
</span></span><span style="display:flex;"><span>kubernetes/secrets : Check certs <span style="color:#000;font-weight:bold">|</span> check <span style="color:#204a87;font-weight:bold">if</span> a cert already exists on node --------13.94s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes/secrets/tasks/check-certs.yml:17 
</span></span><span style="display:flex;"><span>gather facts from all instances --------------------------------------------------9.98s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/cluster.yml:25 
</span></span><span style="display:flex;"><span>kubernetes/node : install <span style="color:#000;font-weight:bold">|</span> Compare host kubelet with hyperkube container --------9.66s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes/node/tasks/install_host.yml:2 
</span></span><span style="display:flex;"><span>kubernetes-apps/ansible : Kubernetes Apps <span style="color:#000;font-weight:bold">|</span> Start Resources -----------------------9.27s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes-apps/ansible/tasks/main.yml:37 
</span></span><span style="display:flex;"><span>kubernetes-apps/ansible : Kubernetes Apps <span style="color:#000;font-weight:bold">|</span> Lay Down KubeDNS Template ------------8.47s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes-apps/ansible/tasks/kubedns.yml:3
</span></span><span style="display:flex;"><span>download : Sync container ---------------------------------------------------------8.23s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:15 
</span></span><span style="display:flex;"><span>kubernetes-apps/network_plugin/calico : Start Calico resources --------------------7.82s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes-apps/network_plugin/calico/tasks/main.yml:2 
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------7.67s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6 
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------7.48s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6 
</span></span><span style="display:flex;"><span>download : Sync container ---------------------------------------------------------7.35s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:15 
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------7.16s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6 
</span></span><span style="display:flex;"><span>network_plugin/calico : Calico <span style="color:#000;font-weight:bold">|</span> Copy cni plugins from calico/cni container -------7.10s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/network_plugin/calico/tasks/main.yml:62 
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------7.04s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------7.01s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6 
</span></span><span style="display:flex;"><span>download : Sync container ---------------------------------------------------------7.00s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:15 
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------6.98s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6 
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------6.79s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6 
</span></span></code></pre></div><h2 id="3-2-k8s集群运行结果">3.2. k8s集群运行结果</h2>
<p><strong>1、k8s组件信息</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get all --namespace=kube-system</span>
</span></span><span style="display:flex;"><span>NAME             DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
</span></span><span style="display:flex;"><span>ds/calico-node   <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>            <span style="color:#0000cf;font-weight:bold">3</span>           &lt;none&gt;          2h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                          DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deploy/kube-dns               <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>            <span style="color:#0000cf;font-weight:bold">2</span>           2h
</span></span><span style="display:flex;"><span>deploy/kubedns-autoscaler     <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           2h
</span></span><span style="display:flex;"><span>deploy/kubernetes-dashboard   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           2h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                 DESIRED   CURRENT   READY     AGE
</span></span><span style="display:flex;"><span>rs/kube-dns-79d99cdcd5               <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         2h
</span></span><span style="display:flex;"><span>rs/kubedns-autoscaler-5564b5585f     <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         2h
</span></span><span style="display:flex;"><span>rs/kubernetes-dashboard-69cb58d748   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         2h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME             DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
</span></span><span style="display:flex;"><span>ds/calico-node   <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>            <span style="color:#0000cf;font-weight:bold">3</span>           &lt;none&gt;          2h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                          DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deploy/kube-dns               <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>            <span style="color:#0000cf;font-weight:bold">2</span>           2h
</span></span><span style="display:flex;"><span>deploy/kubedns-autoscaler     <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           2h
</span></span><span style="display:flex;"><span>deploy/kubernetes-dashboard   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           2h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                 DESIRED   CURRENT   READY     AGE
</span></span><span style="display:flex;"><span>rs/kube-dns-79d99cdcd5               <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         2h
</span></span><span style="display:flex;"><span>rs/kubedns-autoscaler-5564b5585f     <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         2h
</span></span><span style="display:flex;"><span>rs/kubernetes-dashboard-69cb58d748   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         2h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                       READY     STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>po/calico-node-22vsg                       1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/calico-node-t7zgw                       1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/calico-node-zqnx8                       1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/kube-apiserver-kube-master-0            1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          22h
</span></span><span style="display:flex;"><span>po/kube-controller-manager-kube-master-0   1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/kube-dns-79d99cdcd5-f2t6t               3/3       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/kube-dns-79d99cdcd5-gw944               3/3       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/kube-proxy-kube-master-0                1/1       Running   <span style="color:#0000cf;font-weight:bold">2</span>          22h
</span></span><span style="display:flex;"><span>po/kube-proxy-kube-node-41                 1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          22h
</span></span><span style="display:flex;"><span>po/kube-proxy-kube-node-42                 1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          22h
</span></span><span style="display:flex;"><span>po/kube-scheduler-kube-master-0            1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/kubedns-autoscaler-5564b5585f-lt9bb     1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/kubernetes-dashboard-69cb58d748-wmb9x   1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/nginx-proxy-kube-node-41                1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          22h
</span></span><span style="display:flex;"><span>po/nginx-proxy-kube-node-42                1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          22h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>         AGE
</span></span><span style="display:flex;"><span>svc/kube-dns               ClusterIP   10.233.0.3     &lt;none&gt;        53/UDP,53/TCP   2h
</span></span><span style="display:flex;"><span>svc/kubernetes-dashboard   ClusterIP   10.233.27.24   &lt;none&gt;        443/TCP         2h
</span></span></code></pre></div><p><strong>2、k8s节点信息</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get nodes</span>
</span></span><span style="display:flex;"><span>NAME            STATUS    ROLES     AGE       VERSION
</span></span><span style="display:flex;"><span>kube-master-0   Ready     master    22h       v1.9.5
</span></span><span style="display:flex;"><span>kube-node-41    Ready     node      22h       v1.9.5
</span></span><span style="display:flex;"><span>kube-node-42    Ready     node      22h       v1.9.5
</span></span></code></pre></div><p><strong>3、组件健康信息</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get cs</span>
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE              ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;health&#34;</span>: <span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-k8s集群扩容节点">4. k8s集群扩容节点</h1>
<h2 id="4-1-修改hosts-ini文件">4.1. 修改hosts.ini文件</h2>
<p>如果需要扩容<code>Node</code>节点，则修改<code>hosts.ini</code>文件，增加新增的机器信息。例如，要增加节点机器kube-node-43（IP为172.16.94.143），修改后的文件内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Configure &#39;ip&#39; variable to bind kubernetes services on a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># different ip than the default iface</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 主机名             ssh登陆IP                        ssh用户名               ssh登陆密码                 机器IP          子网掩码</span>
</span></span><span style="display:flex;"><span>kube-master-0     <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.140   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.140   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-41      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.141   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.141   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-42      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.142   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.142   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-43      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.143   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.143   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># configure a bastion host if your nodes are not directly reachable</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># bastion ansible_ssh_host=x.x.x.x</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>kube-master<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-master-0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>etcd<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-master-0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>kube-node<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-node-41
</span></span><span style="display:flex;"><span>kube-node-42
</span></span><span style="display:flex;"><span>kube-node-43
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>k8s-cluster:children<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-node
</span></span><span style="display:flex;"><span>kube-master
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>calico-rr<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h2 id="4-2-执行扩容命令">4.2. 执行扩容命令</h2>
<p>涉及文件为<code>scale.yml</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 进入主目录</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> kubespray
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 执行部署命令</span>
</span></span><span style="display:flex;"><span>ansible-playbook -i inventory/k8s/hosts.ini scale.yml -b -vvv
</span></span></code></pre></div><h2 id="4-3-检查扩容结果">4.3. 检查扩容结果</h2>
<p><strong>1、ansible的执行结果</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PLAY RECAP ***************************************
</span></span><span style="display:flex;"><span>kube-node-41               : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">228</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">11</span>   <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>kube-node-42               : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">197</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">6</span>    <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>kube-node-43               : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">227</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">69</span>   <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#8f5902;font-style:italic"># 新增Node节点</span>
</span></span><span style="display:flex;"><span>localhost                  : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>    <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><p><strong>2、k8s的节点信息</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get nodes</span>
</span></span><span style="display:flex;"><span>NAME            STATUS    ROLES     AGE       VERSION
</span></span><span style="display:flex;"><span>kube-master-0   Ready     master    1d        v1.9.5
</span></span><span style="display:flex;"><span>kube-node-41    Ready     node      1d        v1.9.5
</span></span><span style="display:flex;"><span>kube-node-42    Ready     node      1d        v1.9.5
</span></span><span style="display:flex;"><span>kube-node-43    Ready     node      1m        v1.9.5   <span style="color:#8f5902;font-style:italic">#该节点为新增Node节点</span>
</span></span></code></pre></div><p>可以看到新增的<code>kube-node-43</code>节点已经扩容完成。</p>
<p><strong>3、k8s组件信息</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get po --namespace=kube-system -o wide</span>
</span></span><span style="display:flex;"><span>NAME                                    READY     STATUS    RESTARTS   AGE       IP               NODE
</span></span><span style="display:flex;"><span>calico-node-22vsg                       1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       172.16.94.140    kube-master-0
</span></span><span style="display:flex;"><span>calico-node-8fz9x                       1/1       Running   <span style="color:#0000cf;font-weight:bold">2</span>          27m       172.16.94.143    kube-node-43
</span></span><span style="display:flex;"><span>calico-node-t7zgw                       1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       172.16.94.142    kube-node-42
</span></span><span style="display:flex;"><span>calico-node-zqnx8                       1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       172.16.94.141    kube-node-41
</span></span><span style="display:flex;"><span>kube-apiserver-kube-master-0            1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          1d        172.16.94.140    kube-master-0
</span></span><span style="display:flex;"><span>kube-controller-manager-kube-master-0   1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       172.16.94.140    kube-master-0
</span></span><span style="display:flex;"><span>kube-dns-79d99cdcd5-f2t6t               3/3       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       10.233.100.194   kube-node-41
</span></span><span style="display:flex;"><span>kube-dns-79d99cdcd5-gw944               3/3       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       10.233.107.1     kube-node-42
</span></span><span style="display:flex;"><span>kube-proxy-kube-master-0                1/1       Running   <span style="color:#0000cf;font-weight:bold">2</span>          1d        172.16.94.140    kube-master-0
</span></span><span style="display:flex;"><span>kube-proxy-kube-node-41                 1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          1d        172.16.94.141    kube-node-41
</span></span><span style="display:flex;"><span>kube-proxy-kube-node-42                 1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          1d        172.16.94.142    kube-node-42
</span></span><span style="display:flex;"><span>kube-proxy-kube-node-43                 1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          26m       172.16.94.143    kube-node-43
</span></span><span style="display:flex;"><span>kube-scheduler-kube-master-0            1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       172.16.94.140    kube-master-0
</span></span><span style="display:flex;"><span>kubedns-autoscaler-5564b5585f-lt9bb     1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       10.233.100.193   kube-node-41
</span></span><span style="display:flex;"><span>kubernetes-dashboard-69cb58d748-wmb9x   1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       10.233.107.2     kube-node-42
</span></span><span style="display:flex;"><span>nginx-proxy-kube-node-41                1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          1d        172.16.94.141    kube-node-41
</span></span><span style="display:flex;"><span>nginx-proxy-kube-node-42                1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          1d        172.16.94.142    kube-node-42
</span></span><span style="display:flex;"><span>nginx-proxy-kube-node-43                1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          26m       172.16.94.143    kube-node-43
</span></span></code></pre></div><h1 id="5-部署高可用集群">5. 部署高可用集群</h1>
<p>将<code>hosts.ini</code>文件中的master和etcd的机器增加到多台，执行部署命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-playbook -i inventory/k8s/hosts.ini cluster.yml -b -vvv
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Configure &#39;ip&#39; variable to bind kubernetes services on a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># different ip than the default iface</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 主机名             ssh登陆IP                        ssh用户名               ssh登陆密码                 机器IP          子网掩码</span>
</span></span><span style="display:flex;"><span>kube-master-0     <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.140   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.140   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-master-1     <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.144   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.144   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-master-2     <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.145   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.145   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-41      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.141   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.141   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-42      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.142   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.142   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-43      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.143   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.143   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># configure a bastion host if your nodes are not directly reachable</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># bastion ansible_ssh_host=x.x.x.x</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>kube-master<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-master-0
</span></span><span style="display:flex;"><span>kube-master-1
</span></span><span style="display:flex;"><span>kube-master-2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>etcd<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-master-0
</span></span><span style="display:flex;"><span>kube-master-1
</span></span><span style="display:flex;"><span>kube-master-2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>kube-node<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-node-41
</span></span><span style="display:flex;"><span>kube-node-42
</span></span><span style="display:flex;"><span>kube-node-43
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>k8s-cluster:children<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-node
</span></span><span style="display:flex;"><span>kube-master
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>calico-rr<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h1 id="6-升级k8s集群">6. 升级k8s集群</h1>
<p>选择对应的k8s版本信息，执行升级命令。涉及文件为<code>upgrade-cluster.yml</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-playbook upgrade-cluster.yml -b -i inventory/k8s/hosts.ini -e <span style="color:#000">kube_version</span><span style="color:#ce5c00;font-weight:bold">=</span>v1.10.4 -vvv
</span></span></code></pre></div><h1 id="7-troubles-shooting">7. troubles shooting</h1>
<p>在使用kubespary部署k8s集群时，主要遇到以下报错。</p>
<h2 id="7-1-python-netaddr未安装">7.1. python-netaddr未安装</h2>
<ul>
<li>报错内容：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>node1<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;failed&#34;</span>: true, <span style="color:#4e9a06">&#34;msg&#34;</span>: <span style="color:#4e9a06">&#34;The ipaddr filter requires python-netaddr be installed on the ansible controller&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>解决方法：</li>
</ul>
<p>需要安装 python-netaddr，具体参考上述[环境准备]内容。</p>
<h2 id="7-2-swap未关闭">7.2. swap未关闭</h2>
<ul>
<li>报错内容：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>kube-master-0<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;assertion&#34;</span>: <span style="color:#4e9a06">&#34;ansible_swaptotal_mb == 0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;evaluated_to&#34;</span>: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>kube-node-41<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;assertion&#34;</span>: <span style="color:#4e9a06">&#34;ansible_swaptotal_mb == 0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;evaluated_to&#34;</span>: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>kube-node-42<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;assertion&#34;</span>: <span style="color:#4e9a06">&#34;ansible_swaptotal_mb == 0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;evaluated_to&#34;</span>: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>解决方法：</li>
</ul>
<p>所有部署机器执行<code>swapoff -a</code>关闭swap，具体参考上述[环境准备]内容。</p>
<h2 id="7-3-部署机器内存过小">7.3. 部署机器内存过小</h2>
<ul>
<li>报错内容：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>TASK <span style="color:#ce5c00;font-weight:bold">[</span>kubernetes/preinstall : Stop <span style="color:#204a87;font-weight:bold">if</span> memory is too small <span style="color:#204a87;font-weight:bold">for</span> masters<span style="color:#ce5c00;font-weight:bold">]</span> *********************************************************************************************************************************************************************************************************
</span></span><span style="display:flex;"><span>task path: /root/gopath/src/kubespray/roles/kubernetes/preinstall/tasks/verify-settings.yml:52
</span></span><span style="display:flex;"><span>Friday <span style="color:#0000cf;font-weight:bold">10</span> August <span style="color:#0000cf;font-weight:bold">2018</span>  21:50:26 +0800 <span style="color:#ce5c00;font-weight:bold">(</span>0:00:00.940<span style="color:#ce5c00;font-weight:bold">)</span>       0:01:14.088 *********
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>kube-master-0<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;assertion&#34;</span>: <span style="color:#4e9a06">&#34;ansible_memtotal_mb &gt;= 1500&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;evaluated_to&#34;</span>: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#ce5c00;font-weight:bold">[</span>kubernetes/preinstall : Stop <span style="color:#204a87;font-weight:bold">if</span> memory is too small <span style="color:#204a87;font-weight:bold">for</span> nodes<span style="color:#ce5c00;font-weight:bold">]</span> ***********************************************************************************************************************************************************************************************************
</span></span><span style="display:flex;"><span>task path: /root/gopath/src/kubespray/roles/kubernetes/preinstall/tasks/verify-settings.yml:58
</span></span><span style="display:flex;"><span>Friday <span style="color:#0000cf;font-weight:bold">10</span> August <span style="color:#0000cf;font-weight:bold">2018</span>  21:50:27 +0800 <span style="color:#ce5c00;font-weight:bold">(</span>0:00:00.570<span style="color:#ce5c00;font-weight:bold">)</span>       0:01:14.659 *********
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>kube-node-41<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;assertion&#34;</span>: <span style="color:#4e9a06">&#34;ansible_memtotal_mb &gt;= 1024&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;evaluated_to&#34;</span>: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>kube-node-42<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;assertion&#34;</span>: <span style="color:#4e9a06">&#34;ansible_memtotal_mb &gt;= 1024&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;evaluated_to&#34;</span>: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	to retry, use: --limit @/root/gopath/src/kubespray/cluster.retry
</span></span></code></pre></div><ul>
<li>解决方法：</li>
</ul>
<p>调大所有部署机器的内存，本示例中调整为3G或以上。</p>
<h2 id="7-4-kube-scheduler组件运行失败">7.4. kube-scheduler组件运行失败</h2>
<p>kube-scheduler组件运行失败，导致http://localhost:10251/healthz调用失败。</p>
<ul>
<li>报错内容：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>FAILED - RETRYING: Master <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">wait</span> <span style="color:#204a87;font-weight:bold">for</span> kube-scheduler <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> retries left<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>FAILED - RETRYING: Master <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">wait</span> <span style="color:#204a87;font-weight:bold">for</span> kube-scheduler <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> retries left<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>node1<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;attempts&#34;</span>: 60, <span style="color:#4e9a06">&#34;changed&#34;</span>: false, <span style="color:#4e9a06">&#34;content&#34;</span>: <span style="color:#4e9a06">&#34;&#34;</span>, <span style="color:#4e9a06">&#34;failed&#34;</span>: true, <span style="color:#4e9a06">&#34;msg&#34;</span>: <span style="color:#4e9a06">&#34;Status code was not [200]: Request failed: &lt;urlopen error [Errno 111] Connection refused&gt;&#34;</span>, <span style="color:#4e9a06">&#34;redirected&#34;</span>: false, <span style="color:#4e9a06">&#34;status&#34;</span>: -1, <span style="color:#4e9a06">&#34;url&#34;</span>: <span style="color:#4e9a06">&#34;http://localhost:10251/healthz&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>解决方法：</li>
</ul>
<p>可能是内存不足导致，本示例中调大了部署机器的内存。</p>
<h2 id="7-5-docker安装包冲突">7.5. docker安装包冲突</h2>
<ul>
<li>报错内容：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>failed: <span style="color:#ce5c00;font-weight:bold">[</span>k8s-node-1<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">item</span><span style="color:#ce5c00;font-weight:bold">={</span>u<span style="color:#4e9a06">&#39;name&#39;</span>: u<span style="color:#4e9a06">&#39;docker-engine-1.13.1-1.el7.centos&#39;</span><span style="color:#ce5c00;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;attempts&#34;</span>: 4,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;item&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;name&#34;</span>: <span style="color:#4e9a06">&#34;docker-engine-1.13.1-1.el7.centos&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;msg&#34;</span>: <span style="color:#4e9a06">&#34;Error: docker-ce-selinux conflicts with 2:container-selinux-2.66-1.el7.noarch\n&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;rc&#34;</span>: 1,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;results&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;Loaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n * elrepo: mirrors.tuna.tsinghua.edu.cn\n * epel: mirrors.tongji.edu.cn\nPackage docker-engine is obsoleted by docker-ce, trying to install docker-ce-17.03.2.ce-1.el7.centos.x86_64 instead\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package docker-ce.x86_64 0:17.03.2.ce-1.el7.centos will be installed\n--&gt; Processing Dependency: docker-ce-selinux &gt;= 17.03.2.ce-1.el7.centos for package: docker-ce-17.03.2.ce-1.el7.centos.x86_64\n--&gt; Processing Dependency: libltdl.so.7()(64bit) for package: docker-ce-17.03.2.ce-1.el7.centos.x86_64\n--&gt; Running transaction check\n---&gt; Package docker-ce-selinux.noarch 0:17.03.2.ce-1.el7.centos will be installed\n---&gt; Package libtool-ltdl.x86_64 0:2.4.2-22.el7_3 will be installed\n--&gt; Processing Conflict: docker-ce-selinux-17.03.2.ce-1.el7.centos.noarch conflicts docker-selinux\n--&gt; Restarting Dependency Resolution with new changes.\n--&gt; Running transaction check\n---&gt; Package container-selinux.noarch 2:2.55-1.el7 will be updated\n---&gt; Package container-selinux.noarch 2:2.66-1.el7 will be an update\n--&gt; Processing Conflict: docker-ce-selinux-17.03.2.ce-1.el7.centos.noarch conflicts docker-selinux\n--&gt; Finished Dependency Resolution\n You could try using --skip-broken to work around the problem\n You could try running: rpm -Va --nofiles --nodigest\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>解决方法：</li>
</ul>
<p>卸载旧的docker版本，由kubespary自动安装。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo yum remove -y docker <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-client <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-client-latest <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-common <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-latest <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-latest-logrotate <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-logrotate <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-selinux <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-engine-selinux <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-engine
</span></span></code></pre></div><p>参考文章：</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/kubespray">https://github.com/kubernetes-incubator/kubespray</a></li>
<li><a href="https://github.com/kubernetes-incubator/kubespray/blob/master/docs/upgrades.md">https://github.com/kubernetes-incubator/kubespray/blob/master/docs/upgrades.md</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1e3c685682ed41951a80a02b1a236fcc">3 - 使用minikube安装kubernetes</h1>
    
	<blockquote>
<p>以下内容基于Linux系统，特别为Ubuntu系统</p>
</blockquote>
<h1 id="1-安装kubectl">1. 安装kubectl</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -LO https://storage.googleapis.com/kubernetes-release/release/<span style="color:#204a87;font-weight:bold">$(</span>curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt<span style="color:#204a87;font-weight:bold">)</span>/bin/linux/amd64/kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chmod +x kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo mv kubectl /usr/local/bin/
</span></span></code></pre></div><p>下载指定版本，例如下载v1.9.0版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.9.0/bin/linux/amd64/kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chmod +x kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo mv kubectl /usr/local/bin/
</span></span></code></pre></div><h1 id="2-安装minikube">2. 安装minikube</h1>
<p><code>minikube</code>的源码地址：https://github.com/kubernetes/minikube</p>
<h2 id="2-1-安装minikube">2.1 安装minikube</h2>
<p>以下命令为安装<code>latest</code>版本的<code>minikube</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chmod +x minikube <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo mv minikube /usr/local/bin/
</span></span></code></pre></div><p>安装指定版本可到https://github.com/kubernetes/minikube/releases下载对应版本。</p>
<p>例如：以下为安装<code>v0.28.2</code>版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.28.2/minikube-linux-amd64 <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chmod +x minikube <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo mv minikube /usr/local/bin/
</span></span></code></pre></div><h2 id="2-2-minikube命令帮助">2.2 minikube命令帮助</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Minikube is a CLI tool that provisions and manages single-node Kubernetes clusters optimized <span style="color:#204a87;font-weight:bold">for</span> development workflows.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  minikube <span style="color:#ce5c00;font-weight:bold">[</span>command<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available Commands:
</span></span><span style="display:flex;"><span>  addons           Modify minikube<span style="color:#4e9a06">&#39;s kubernetes addons
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  cache            Add or delete an image from the local cache.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  completion       Outputs minikube shell completion for the given shell (bash or zsh)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  config           Modify minikube config
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  dashboard        Opens/displays the kubernetes dashboard URL for your local cluster
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  delete           Deletes a local kubernetes cluster
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  docker-env       Sets up docker env variables; similar to &#39;</span><span style="color:#204a87;font-weight:bold">$(</span>docker-machine env<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  get-k8s-versions Gets the list of Kubernetes versions available for minikube when using the localkube bootstrapper
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  ip               Retrieves the IP address of the running cluster
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  logs             Gets the logs of the running localkube instance, used for debugging minikube, not user code
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  mount            Mounts the specified directory into minikube
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  profile          Profile sets the current minikube profile
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  service          Gets the kubernetes URL(s) for the specified service in your local cluster
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  ssh              Log into or run a command on a machine with SSH; similar to &#39;</span>docker-machine ssh<span style="color:#a40000">&#39;</span>
</span></span><span style="display:flex;"><span>  ssh-key          Retrieve the ssh identity key path of the specified cluster
</span></span><span style="display:flex;"><span>  start            Starts a <span style="color:#204a87">local</span> kubernetes cluster
</span></span><span style="display:flex;"><span>  status           Gets the status of a <span style="color:#204a87">local</span> kubernetes cluster
</span></span><span style="display:flex;"><span>  stop             Stops a running <span style="color:#204a87">local</span> kubernetes cluster
</span></span><span style="display:flex;"><span>  update-check     Print current and latest version number
</span></span><span style="display:flex;"><span>  update-context   Verify the IP address of the running cluster in kubeconfig.
</span></span><span style="display:flex;"><span>  version          Print the version of minikube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>      --alsologtostderr                  log to standard error as well as files
</span></span><span style="display:flex;"><span>  -b, --bootstrapper string              The name of the cluster bootstrapper that will <span style="color:#204a87">set</span> up the kubernetes cluster. <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;localkube&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --log_backtrace_at traceLocation   when logging hits line file:N, emit a stack trace <span style="color:#ce5c00;font-weight:bold">(</span>default :0<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --log_dir string                   If non-empty, write log files in this directory
</span></span><span style="display:flex;"><span>      --loglevel int                     Log level <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">0</span> <span style="color:#ce5c00;font-weight:bold">=</span> DEBUG, <span style="color:#000">5</span> <span style="color:#ce5c00;font-weight:bold">=</span> FATAL<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>default 1<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --logtostderr                      log to standard error instead of files
</span></span><span style="display:flex;"><span>  -p, --profile string                   The name of the minikube VM being used.
</span></span><span style="display:flex;"><span>	This can be modified to allow <span style="color:#204a87;font-weight:bold">for</span> multiple minikube instances to be run independently <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;minikube&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --stderrthreshold severity         logs at or above this threshold go to stderr <span style="color:#ce5c00;font-weight:bold">(</span>default 2<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -v, --v Level                          log level <span style="color:#204a87;font-weight:bold">for</span> V logs
</span></span><span style="display:flex;"><span>      --vmodule moduleSpec               comma-separated list of <span style="color:#000">pattern</span><span style="color:#ce5c00;font-weight:bold">=</span>N settings <span style="color:#204a87;font-weight:bold">for</span> file-filtered logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;minikube [command] --help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information about a command.
</span></span></code></pre></div><h1 id="3-使用minikube安装k8s集群">3. 使用minikube安装k8s集群</h1>
<h2 id="3-1-minikube-start">3.1. minikube start</h2>
<p>可以以<code>Docker</code>的方式运行k8s的组件，但需要先安装Docker(可参考<a href="">Docker安装</a>)，启动参数使用<code>--vm-driver=none</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minikube start --vm-driver<span style="color:#ce5c00;font-weight:bold">=</span>none
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@ubuntu:~# minikube start --vm-driver<span style="color:#ce5c00;font-weight:bold">=</span>none
</span></span><span style="display:flex;"><span>Starting <span style="color:#204a87">local</span> Kubernetes v1.10.0 cluster...
</span></span><span style="display:flex;"><span>Starting VM...
</span></span><span style="display:flex;"><span>Getting VM IP address...
</span></span><span style="display:flex;"><span>Moving files into cluster...
</span></span><span style="display:flex;"><span>Downloading kubeadm v1.10.0
</span></span><span style="display:flex;"><span>Downloading kubelet v1.10.0
</span></span><span style="display:flex;"><span>^<span style="color:#ce5c00;font-weight:bold">[[</span>DFinished Downloading kubelet v1.10.0
</span></span><span style="display:flex;"><span>Finished Downloading kubeadm v1.10.0
</span></span><span style="display:flex;"><span>Setting up certs...
</span></span><span style="display:flex;"><span>Connecting to cluster...
</span></span><span style="display:flex;"><span>Setting up kubeconfig...
</span></span><span style="display:flex;"><span>Starting cluster components...
</span></span><span style="display:flex;"><span>Kubectl is now configured to use the cluster.
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">===================</span>
</span></span><span style="display:flex;"><span>WARNING: IT IS RECOMMENDED NOT TO RUN THE NONE DRIVER ON PERSONAL WORKSTATIONS
</span></span><span style="display:flex;"><span>	The <span style="color:#4e9a06">&#39;none&#39;</span> driver will run an insecure kubernetes apiserver as root that may leave the host vulnerable to CSRF attacks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>When using the none driver, the kubectl config and credentials generated will be root owned and will appear in the root home directory.
</span></span><span style="display:flex;"><span>You will need to move the files to the appropriate location and <span style="color:#204a87;font-weight:bold">then</span> <span style="color:#204a87">set</span> the correct permissions.  An example of this is below:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sudo mv /root/.kube <span style="color:#000">$HOME</span>/.kube <span style="color:#8f5902;font-style:italic"># this will write over any previous configuration</span>
</span></span><span style="display:flex;"><span>	sudo chown -R <span style="color:#000">$USER</span> <span style="color:#000">$HOME</span>/.kube
</span></span><span style="display:flex;"><span>	sudo chgrp -R <span style="color:#000">$USER</span> <span style="color:#000">$HOME</span>/.kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sudo mv /root/.minikube <span style="color:#000">$HOME</span>/.minikube <span style="color:#8f5902;font-style:italic"># this will write over any previous configuration</span>
</span></span><span style="display:flex;"><span>	sudo chown -R <span style="color:#000">$USER</span> <span style="color:#000">$HOME</span>/.minikube
</span></span><span style="display:flex;"><span>	sudo chgrp -R <span style="color:#000">$USER</span> <span style="color:#000">$HOME</span>/.minikube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>This can also be <span style="color:#204a87;font-weight:bold">done</span> automatically by setting the env var <span style="color:#000">CHANGE_MINIKUBE_NONE_USER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>Loading cached images from config file.
</span></span></code></pre></div><p>安装指定版本的kubernetes集群</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查阅版本</span>
</span></span><span style="display:flex;"><span>minikube get-k8s-versions
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 选择版本启动</span>
</span></span><span style="display:flex;"><span>minikube start --kubernetes-version v1.7.3 --vm-driver<span style="color:#ce5c00;font-weight:bold">=</span>none
</span></span></code></pre></div><h2 id="3-2-minikube-status">3.2. minikube status</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ minikube status
</span></span><span style="display:flex;"><span>minikube: Running
</span></span><span style="display:flex;"><span>cluster: Running
</span></span><span style="display:flex;"><span>kubectl: Correctly Configured: pointing to minikube-vm at 172.16.94.139
</span></span></code></pre></div><h2 id="3-3-minikube-stop">3.3. minikube stop</h2>
<p><code>minikube stop</code> 命令可以用来停止集群。 该命令会关闭 minikube 虚拟机，但将保留所有集群状态和数据。 再次启动集群将恢复到之前的状态。</p>
<h2 id="3-4-minikube-delete">3.4. minikube delete</h2>
<p><code>minikube delete</code> 命令可以用来删除集群。 该命令将关闭并删除 minikube 虚拟机。没有数据或状态会被保存下来。</p>
<h1 id="4-查看部署结果">4. 查看部署结果</h1>
<h2 id="4-1-部署组件">4.1. 部署组件</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@ubuntu:~# kubectl get all --namespace<span style="color:#ce5c00;font-weight:bold">=</span>kube-system
</span></span><span style="display:flex;"><span>NAME                                        READY     STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/etcd-minikube                           1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/kube-addon-manager-minikube             1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/kube-apiserver-minikube                 1/1       Running   <span style="color:#0000cf;font-weight:bold">1</span>          39m
</span></span><span style="display:flex;"><span>pod/kube-controller-manager-minikube        1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/kube-dns-86f4d74b45-bdfnx               3/3       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/kube-proxy-dqdvg                        1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/kube-scheduler-minikube                 1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/kubernetes-dashboard-5498ccf677-c2gnh   1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/storage-provisioner                     1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>         AGE
</span></span><span style="display:flex;"><span>service/kube-dns               ClusterIP   10.96.0.10      &lt;none&gt;        53/UDP,53/TCP   38m
</span></span><span style="display:flex;"><span>service/kubernetes-dashboard   NodePort    10.104.48.227   &lt;none&gt;        80:30000/TCP    38m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                        DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
</span></span><span style="display:flex;"><span>daemonset.apps/kube-proxy   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           &lt;none&gt;          38m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/kube-dns               <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           38m
</span></span><span style="display:flex;"><span>deployment.apps/kubernetes-dashboard   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           38m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                              DESIRED   CURRENT   READY     AGE
</span></span><span style="display:flex;"><span>replicaset.apps/kube-dns-86f4d74b45               <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         38m
</span></span><span style="display:flex;"><span>replicaset.apps/kubernetes-dashboard-5498ccf677   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         38m
</span></span></code></pre></div><h2 id="4-2-dashboard">4.2. dashboard</h2>
<p>通过访问<code>ip:port</code>，例如：http://172.16.94.139:30000/，可以访问k8s的<code>dashboard</code>控制台。</p>
<p>&lt;img src=&quot;http://res.cloudinary.com/dqxtn0ick/image/upload/v1533695750/article/kubernetes/arch/dashboard.png&quot; width = &quot;100%&quot;/&gt;</p>
<h1 id="5-troubleshooting">5. troubleshooting</h1>
<h2 id="5-1-没有安装virtualbox">5.1. 没有安装VirtualBox</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@minikube ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># minikube start</span>
</span></span><span style="display:flex;"><span>Starting <span style="color:#204a87">local</span> Kubernetes v1.10.0 cluster...
</span></span><span style="display:flex;"><span>Starting VM...
</span></span><span style="display:flex;"><span>Downloading Minikube ISO
</span></span><span style="display:flex;"><span> 160.27 MB / 160.27 MB <span style="color:#ce5c00;font-weight:bold">[============================================]</span> 100.00% 0s
</span></span><span style="display:flex;"><span>E0727 15:47:08.655647    <span style="color:#0000cf;font-weight:bold">9407</span> start.go:174<span style="color:#ce5c00;font-weight:bold">]</span> Error starting host: Error creating host: Error executing step: Running precreate checks.
</span></span><span style="display:flex;"><span>: VBoxManage not found. Make sure VirtualBox is installed and VBoxManage is in the path.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Retrying.
</span></span><span style="display:flex;"><span>E0727 15:47:08.656994    <span style="color:#0000cf;font-weight:bold">9407</span> start.go:180<span style="color:#ce5c00;font-weight:bold">]</span> Error starting host:  Error creating host: Error executing step: Running precreate checks.
</span></span><span style="display:flex;"><span>: VBoxManage not found. Make sure VirtualBox is installed and VBoxManage is in the <span style="color:#000">path</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">================================================================================</span>
</span></span><span style="display:flex;"><span>An error has occurred. Would you like to opt in to sending anonymized crash
</span></span><span style="display:flex;"><span>information to minikube to <span style="color:#204a87">help</span> prevent future errors?
</span></span><span style="display:flex;"><span>To opt out of these messages, run the command:
</span></span><span style="display:flex;"><span>	minikube config <span style="color:#204a87">set</span> WantReportErrorPrompt <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">================================================================================</span>
</span></span><span style="display:flex;"><span>Please enter your response <span style="color:#ce5c00;font-weight:bold">[</span>Y/n<span style="color:#ce5c00;font-weight:bold">]</span>:
</span></span></code></pre></div><p>解决方法，先安装VirtualBox。</p>
<h2 id="5-2-没有安装docker">5.2. 没有安装Docker</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@minikube ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># minikube start --vm-driver=none</span>
</span></span><span style="display:flex;"><span>Starting <span style="color:#204a87">local</span> Kubernetes v1.10.0 cluster...
</span></span><span style="display:flex;"><span>Starting VM...
</span></span><span style="display:flex;"><span>E0727 15:56:54.936706    <span style="color:#0000cf;font-weight:bold">9441</span> start.go:174<span style="color:#ce5c00;font-weight:bold">]</span> Error starting host: Error creating host: Error executing step: Running precreate checks.
</span></span><span style="display:flex;"><span>: docker cannot be found on the path <span style="color:#204a87;font-weight:bold">for</span> this machine. A docker installation is a requirement <span style="color:#204a87;font-weight:bold">for</span> using the none driver: exec: <span style="color:#4e9a06">&#34;docker&#34;</span>: executable file not found in <span style="color:#000">$PATH</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Retrying.
</span></span><span style="display:flex;"><span>E0727 15:56:54.938930    <span style="color:#0000cf;font-weight:bold">9441</span> start.go:180<span style="color:#ce5c00;font-weight:bold">]</span> Error starting host:  Error creating host: Error executing step: Running precreate checks.
</span></span><span style="display:flex;"><span>: docker cannot be found on the path <span style="color:#204a87;font-weight:bold">for</span> this machine. A docker installation is a requirement <span style="color:#204a87;font-weight:bold">for</span> using the none driver: exec: <span style="color:#4e9a06">&#34;docker&#34;</span>: executable file not found in <span style="color:#000">$PATH</span>
</span></span></code></pre></div><p>解决方法，先安装Docker。</p>
<p>文章参考：</p>
<p><a href="https://github.com/kubernetes/minikube">https://github.com/kubernetes/minikube</a></p>
<p><a href="https://kubernetes.io/docs/setup/minikube/">https://kubernetes.io/docs/setup/minikube/</a></p>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">https://kubernetes.io/docs/tasks/tools/install-minikube/</a></p>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-06181b6bb8970c2b2814c3aed2e7944d">4 - 使用kind安装kubernetes</h1>
    
	<h1 id="1-安装kind">1. 安装kind</h1>
<p>On mac or linux</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -Lo ./kind <span style="color:#4e9a06">&#34;https://github.com/kubernetes-sigs/kind/releases/download/v0.7.0/kind-</span><span style="color:#204a87;font-weight:bold">$(</span>uname<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">-amd64&#34;</span>
</span></span><span style="display:flex;"><span>chmod +x ./kind
</span></span><span style="display:flex;"><span>mv ./kind /some-dir-in-your-PATH/kind
</span></span></code></pre></div><h1 id="2-创建k8s集群">2. 创建k8s集群</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kind create cluster
</span></span><span style="display:flex;"><span>Creating cluster <span style="color:#4e9a06">&#34;kind&#34;</span> ...
</span></span><span style="display:flex;"><span> ✓ Ensuring node image <span style="color:#ce5c00;font-weight:bold">(</span>kindest/node:v1.17.0<span style="color:#ce5c00;font-weight:bold">)</span> 🖼
</span></span><span style="display:flex;"><span> ✓ Preparing nodes 📦
</span></span><span style="display:flex;"><span> ✓ Writing configuration 📜
</span></span><span style="display:flex;"><span> ✓ Starting control-plane 🕹️
</span></span><span style="display:flex;"><span> ✓ Installing CNI 🔌
</span></span><span style="display:flex;"><span> ✓ Installing StorageClass 💾
</span></span><span style="display:flex;"><span>Set kubectl context to <span style="color:#4e9a06">&#34;kind-kind&#34;</span>
</span></span><span style="display:flex;"><span>You can now use your cluster with:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl cluster-info --context kind-kind
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Not sure what to <span style="color:#204a87;font-weight:bold">do</span> next? 😅 Check out https://kind.sigs.k8s.io/docs/user/quick-start/
</span></span></code></pre></div><p>查看集群信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl cluster-info --context kind-kind
</span></span><span style="display:flex;"><span>Kubernetes master is running at https://127.0.0.1:32768
</span></span><span style="display:flex;"><span>KubeDNS is running at https://127.0.0.1:32768/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</span></span></code></pre></div><p>查看node</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get node -o wide
</span></span><span style="display:flex;"><span>NAME                 STATUS   ROLES    AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE       KERNEL-VERSION                      CONTAINER-RUNTIME
</span></span><span style="display:flex;"><span>kind-control-plane   Ready    master   35h   v1.17.0   172.17.0.2    &lt;none&gt;        Ubuntu 19.10   3.10.107-1-tlinux2_kvm_guest-0049   containerd://1.3.2
</span></span></code></pre></div><p>查看pod</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get po --all-namespaces -o wide
</span></span><span style="display:flex;"><span>NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE   IP           NODE                 NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>kube-system          coredns-6955765f44-lqk9v                     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   10.244.0.4   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          coredns-6955765f44-zpsmc                     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   10.244.0.3   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          etcd-kind-control-plane                      1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   172.17.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          kindnet-8mt7d                                1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   172.17.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          kube-apiserver-kind-control-plane            1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   172.17.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          kube-controller-manager-kind-control-plane   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   172.17.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          kube-proxy-5w25s                             1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   172.17.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          kube-scheduler-kind-control-plane            1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   172.17.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>local-path-storage   local-path-provisioner-7745554f7f-dckzr      1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   10.244.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>docker ps</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID        IMAGE                  COMMAND                  CREATED             STATUS              PORTS                       NAMES
</span></span><span style="display:flex;"><span>93b291f99dd4        kindest/node:v1.17.0   <span style="color:#4e9a06">&#34;/usr/local/bin/entr…&#34;</span>   <span style="color:#0000cf;font-weight:bold">2</span> minutes ago       Up <span style="color:#0000cf;font-weight:bold">2</span> minutes        127.0.0.1:32768-&gt;6443/tcp   kind-control-plane
</span></span></code></pre></div><h1 id="3-kindest-node容器内进程">3. kindest/node容器内进程</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker <span style="color:#204a87">exec</span> -it 93b291f99dd4 bash
</span></span><span style="display:flex;"><span>root@kind-control-plane:/# ps auxw
</span></span><span style="display:flex;"><span>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span style="display:flex;"><span>root         <span style="color:#0000cf;font-weight:bold">1</span>  0.1  0.0  <span style="color:#0000cf;font-weight:bold">19512</span>  <span style="color:#0000cf;font-weight:bold">7480</span> ?        Ss   03:18   0:00 /sbin/init
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">105</span>  0.0  0.0  <span style="color:#0000cf;font-weight:bold">26396</span>  <span style="color:#0000cf;font-weight:bold">7344</span> ?        S&lt;s  03:18   0:00 /lib/systemd/systemd-journald
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">141</span>  2.3  0.3 <span style="color:#0000cf;font-weight:bold">2374736</span> <span style="color:#0000cf;font-weight:bold">51564</span> ?       Ssl  03:18   0:06 /usr/local/bin/containerd
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">325</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">5036</span> ?        Sl   03:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 3f415d609e15ef12b9f53557891c311c156b912d5a326544a25c8b29cfa9d366 -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">346</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:18   0:00 /pause
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">370</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">5108</span> ?        Sl   03:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1e1f3eed09f701fb621325e7b9e96d1c3de60ebd3bd64e0aec376e9490cf0e57 -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">397</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">4684</span> ?        Sl   03:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id c5e451089a1a5b3dfb2cc68ee27ac7d414285be55ecfdc5bd59180fbfbc7df2e -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">424</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">4924</span> ?        Sl   03:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 81e35f29ac8c2dda344125a10e3791be7ccf788a88f1efbc3397fa319f02881f -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">443</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:18   0:00 /pause
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">458</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:18   0:00 /pause
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">465</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:18   0:00 /pause
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">548</span>  0.7  0.1 <span style="color:#0000cf;font-weight:bold">145500</span> <span style="color:#0000cf;font-weight:bold">27724</span> ?        Ssl  03:18   0:02 kube-scheduler --authentication-kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/scheduler.conf --authorization-kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/scheduler.conf --bind-address<span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1 --kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/scheduler.conf --leader-elect<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">589</span>  1.0  0.3 <span style="color:#0000cf;font-weight:bold">159536</span> <span style="color:#0000cf;font-weight:bold">54384</span> ?        Ssl  03:18   0:02 kube-controller-manager --allocate-node-cidrs<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --authentication-kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/controller-manager.conf --authorization-kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/controller-manager.conf --bind-address<span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1 --client-ca-file<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/pki/ca.cr
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">613</span>  3.8  1.6 <span style="color:#0000cf;font-weight:bold">445780</span> <span style="color:#0000cf;font-weight:bold">273484</span> ?       Ssl  03:18   0:10 kube-apiserver --advertise-address<span style="color:#ce5c00;font-weight:bold">=</span>172.17.0.2 --allow-privileged<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --authorization-mode<span style="color:#ce5c00;font-weight:bold">=</span>Node,RBAC --client-ca-file<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/pki/ca.crt --enable-admission-plugins<span style="color:#ce5c00;font-weight:bold">=</span>NodeRestriction --enable-bootstrap-token-auth<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --etcd-cafile<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">660</span>  1.4  0.2 <span style="color:#0000cf;font-weight:bold">10613604</span> <span style="color:#0000cf;font-weight:bold">37448</span> ?      Ssl  03:18   0:04 etcd --advertise-client-urls<span style="color:#ce5c00;font-weight:bold">=</span>https://172.17.0.2:2379 --cert-file<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/pki/etcd/server.crt --client-cert-auth<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --data-dir<span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/etcd --initial-advertise-peer-urls<span style="color:#ce5c00;font-weight:bold">=</span>https://172.17.0.2:2380 --initial-cluster<span style="color:#ce5c00;font-weight:bold">=</span>kind-control-plane<span style="color:#ce5c00;font-weight:bold">=</span>https://172.
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">718</span>  1.3  0.3 <span style="color:#0000cf;font-weight:bold">2084848</span> <span style="color:#0000cf;font-weight:bold">52772</span> ?       Ssl  03:18   0:03 /usr/bin/kubelet --bootstrap-kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/kubelet.conf --config<span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/kubelet/config.yaml --container-runtime<span style="color:#ce5c00;font-weight:bold">=</span>remote --container-runtime-endpoint<span style="color:#ce5c00;font-weight:bold">=</span>/run/containerd/containerd.sock --fail
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">876</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">5084</span> ?        Sl   03:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id adfbea8fec5ac6986407291f5bfc5aecead176954e5dabbe1517b98dd77bf78b -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">893</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">4796</span> ?        Sl   03:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 53bdce023626b60ffaa0548b5888e457dc9c3bc45c7808a385dd0f63dcc90327 -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">924</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:18   0:00 /pause
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">931</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:18   0:00 /pause
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1000</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">127616</span> <span style="color:#0000cf;font-weight:bold">11100</span> ?        Ssl  03:18   0:00 /bin/kindnetd
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1017</span>  0.0  0.1 <span style="color:#0000cf;font-weight:bold">141060</span> <span style="color:#0000cf;font-weight:bold">19420</span> ?        Ssl  03:18   0:00 /usr/local/bin/kube-proxy --config<span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/kube-proxy/config.conf --hostname-override<span style="color:#ce5c00;font-weight:bold">=</span>kind-control-plane
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1066</span>  0.0  0.0      <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span> ?        Z    03:18   0:00 <span style="color:#ce5c00;font-weight:bold">[</span>iptables-nft-sa<span style="color:#ce5c00;font-weight:bold">]</span> &lt;defunct&gt;
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1080</span>  0.0  0.0      <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span> ?        Z    03:18   0:00 <span style="color:#ce5c00;font-weight:bold">[</span>iptables-nft-sa<span style="color:#ce5c00;font-weight:bold">]</span> &lt;defunct&gt;
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1241</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">5156</span> ?        Sl   03:19   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 5cbd7bbe186cf5847786c7a03aa4c6f82e6c805d0a189f0f3e8fb1750594260d -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1262</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:19   0:00 /pause
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1303</span>  0.1  0.0 <span style="color:#0000cf;font-weight:bold">134372</span> <span style="color:#0000cf;font-weight:bold">14088</span> ?        Ssl  03:19   0:00 local-path-provisioner --debug start --helper-image k8s.gcr.io/debian-base:v2.0.0 --config /etc/config/config.json
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1411</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">4876</span> ?        Sl   03:19   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 196b440345cb5ef47a6c31222323d35bbfef85d1d79c149ec0e3a6e22022a5f0 -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1437</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:19   0:00 /pause
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1450</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">4380</span> ?        Sl   03:19   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id de7bdf052083978c78708383f842567d4fb38adff22a56792437a4de82425afe -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1480</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:19   0:00 /pause
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1530</span>  0.1  0.1 <span style="color:#0000cf;font-weight:bold">144324</span> <span style="color:#0000cf;font-weight:bold">19056</span> ?        Ssl  03:19   0:00 /coredns -conf /etc/coredns/Corefile
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1531</span>  0.1  0.1 <span style="color:#0000cf;font-weight:bold">144580</span> <span style="color:#0000cf;font-weight:bold">19204</span> ?        Ssl  03:19   0:00 /coredns -conf /etc/coredns/Corefile
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes-sigs/kind">https://github.com/kubernetes-sigs/kind</a></li>
<li><a href="https://kind.sigs.k8s.io/docs/user/quick-start/">https://kind.sigs.k8s.io/docs/user/quick-start/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-eee653beaa5313391bca6e7f1ffaf477">5 - 安装k8s dashboard</h1>
    
	<h2 id="1-部署dashboard">1. 部署dashboard</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
</span></span></code></pre></div><p>镜像： kubernetesui/dashboard:v2.5.0</p>
<p>默认端口：8443</p>
<p>登录页面需要填入token或kubeconfig</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1658371511/article/kubernetes/dashboard/dashboard_token.png" alt=""></p>
<h2 id="2-登录dashboard">2. 登录dashboard</h2>
<h3 id="2-1-创建超级管理员">2.1. 创建超级管理员</h3>
<p>参考：<a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">dashboard/creating-sample-user</a></p>
<p>创建dashboard-adminuser.yaml文件如下：</p>
<blockquote>
<p>k8s 1.24+版本需要自行创建secret绑定serviceaccount</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes-dashboard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cluster-admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes-dashboard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes-dashboard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">kubernetes.io/service-account.name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;admin-user&#34;</span><span style="color:#f8f8f8;text-decoration:underline">   
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes.io/service-account-token  </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建serviceaccount和ClusterRoleBinding，绑定cluster-admin的超级管理员的权限。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f dashboard-adminuser.yaml 
</span></span></code></pre></div><p>创建用户token</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n kubernetes-dashboard create token admin-user --duration 8760h
</span></span></code></pre></div><p>或者通过secret查询token</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get secret admin-user-secret -n kubernetes-dashboard -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">={</span><span style="color:#4e9a06">&#34;.data.token&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">|</span> base64 -d
</span></span></code></pre></div><p>移除账号</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n kubernetes-dashboard delete serviceaccount admin-user
</span></span><span style="display:flex;"><span>kubectl -n kubernetes-dashboard delete clusterrolebinding admin-user
</span></span></code></pre></div><h3 id="2-2-创建namespace管理员">2.2. 创建Namespace管理员</h3>
<p>1、创建角色权限（role）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#4e9a06">&#39;*&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#4e9a06">&#39;*&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#4e9a06">&#39;*&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>2、创建用户账号（ServiceAccount）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建secret 可自动生成token</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Secret
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: <span style="color:#4e9a06">${</span><span style="color:#000">SecretName</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>  namespace: <span style="color:#4e9a06">${</span><span style="color:#000">ServiceAccountNS</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>  annotations:
</span></span><span style="display:flex;"><span>    kubernetes.io/service-account.name: <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">ServiceAccountName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>   
</span></span><span style="display:flex;"><span>type: kubernetes.io/service-account-token
</span></span></code></pre></div><p>3、创建角色绑定关系</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>4、生成token</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n &lt;namespace&gt; create token &lt;ServiceAccount&gt; --duration 8760h
</span></span></code></pre></div><p>或者通过上述secret中的token获得</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get secret <span style="color:#4e9a06">${</span><span style="color:#000">SecretName</span><span style="color:#4e9a06">}</span> -n <span style="color:#4e9a06">${</span><span style="color:#000">ServiceAccountNS</span><span style="color:#4e9a06">}</span> -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">={</span><span style="color:#4e9a06">&#34;.data.token&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">|</span> base64 -d
</span></span></code></pre></div><h3 id="2-3-创建只读账户">2.3. 创建只读账户</h3>
<p>集群默认提供了几种命名空间级别的权限，分别设置ClusterRole: [admin, edit, view], 将授权设置为<code>ClusterRole</code>为<code>view</code>即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">view</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="3-集成sso登录">3. 集成SSO登录</h1>
<p>社区提供了添加<code>Authorization header</code>的方式来集成自定义的SSO登录。即在HTTP请求中增加<strong>Header:  <code>Authorization: Bearer &lt;token&gt;</code></strong>。该操作可以通过apisix或Nginx等插件注入Header。</p>
<p>参考：</p>
<ul>
<li>
<p><a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/web-ui-dashboard/">部署和访问 Kubernetes 仪表板（Dashboard） | Kubernetes</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">dashboard/creating-sample-user.md at master · kubernetes/dashboard · GitHub</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/dashboard/tree/master/docs/user/access-control">dashboard/docs/user/access-control at master · kubernetes/dashboard · GitHub</a></p>
</li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2025 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
