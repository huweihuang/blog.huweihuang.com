<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/kubernetes-notes/serverless/iac/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/kubernetes-notes/serverless/iac/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>IaC | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="IaC" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/kubernetes-notes/serverless/iac/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="IaC">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="IaC"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/kubernetes-notes/" ><span class="active">Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/k8s-source-code-analysis/" ><span>Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/linux-notes/" ><span>Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.30ad7a1fd246a9f12d8fa8e396e5428b.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/kubernetes-notes/serverless/iac/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">IaC</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-46685ef45663498ab635a9ab162c785a">Terraform的使用</a></li>


    
  
    
    
	
<li>2: <a href="#pg-bf0fbb771d80524c8359a906cd4fe4ee">Terraform的基本概念</a></li>


    
  
    
    
	
<li>3: <a href="#pg-e48abb517180f08f5738fa9863d9944f">Terraform的模块及依赖引用</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-46685ef45663498ab635a9ab162c785a">1 - Terraform的使用</h1>
    
	<h1 id="1-安装terraform">1. 安装terraform</h1>
<p>mac</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>brew tap hashicorp/tap
</span></span><span style="display:flex;"><span>brew install hashicorp/tap/terraform
</span></span></code></pre></div><p>linux: centos</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo yum install -y yum-utils
</span></span><span style="display:flex;"><span>sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo
</span></span><span style="display:flex;"><span>sudo yum -y install terraform
</span></span></code></pre></div><h1 id="2-terraform命令">2. terraform命令</h1>
<p>编写terraform的部署文本，常用命令：</p>
<ol>
<li>
<p>terraform init：项目初始化</p>
</li>
<li>
<p>terraform plan：预览</p>
</li>
<li>
<p>terraform apply：部署</p>
</li>
<li>
<p>terraform destroy：销毁</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform --help
</span></span><span style="display:flex;"><span>Usage: terraform <span style="color:#ce5c00;font-weight:bold">[</span>global options<span style="color:#ce5c00;font-weight:bold">]</span> &lt;subcommand&gt; <span style="color:#ce5c00;font-weight:bold">[</span>args<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The available commands <span style="color:#204a87;font-weight:bold">for</span> execution are listed below.
</span></span><span style="display:flex;"><span>The primary workflow commands are given first, followed by
</span></span><span style="display:flex;"><span>less common or more advanced commands.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Main commands:
</span></span><span style="display:flex;"><span>  init          Prepare your working directory <span style="color:#204a87;font-weight:bold">for</span> other commands
</span></span><span style="display:flex;"><span>  validate      Check whether the configuration is valid
</span></span><span style="display:flex;"><span>  plan          Show changes required by the current configuration
</span></span><span style="display:flex;"><span>  apply         Create or update infrastructure
</span></span><span style="display:flex;"><span>  destroy       Destroy previously-created infrastructure
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>All other commands:
</span></span><span style="display:flex;"><span>  console       Try Terraform expressions at an interactive <span style="color:#204a87">command</span> prompt
</span></span><span style="display:flex;"><span>  fmt           Reformat your configuration in the standard style
</span></span><span style="display:flex;"><span>  force-unlock  Release a stuck lock on the current workspace
</span></span><span style="display:flex;"><span>  get           Install or upgrade remote Terraform modules
</span></span><span style="display:flex;"><span>  graph         Generate a Graphviz graph of the steps in an operation
</span></span><span style="display:flex;"><span>  import        Associate existing infrastructure with a Terraform resource
</span></span><span style="display:flex;"><span>  login         Obtain and save credentials <span style="color:#204a87;font-weight:bold">for</span> a remote host
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">logout</span>        Remove locally-stored credentials <span style="color:#204a87;font-weight:bold">for</span> a remote host
</span></span><span style="display:flex;"><span>  metadata      Metadata related commands
</span></span><span style="display:flex;"><span>  modules       Show all declared modules in a working directory
</span></span><span style="display:flex;"><span>  output        Show output values from your root module
</span></span><span style="display:flex;"><span>  providers     Show the providers required <span style="color:#204a87;font-weight:bold">for</span> this configuration
</span></span><span style="display:flex;"><span>  refresh       Update the state to match remote systems
</span></span><span style="display:flex;"><span>  show          Show the current state or a saved plan
</span></span><span style="display:flex;"><span>  stacks        Manage HCP Terraform stack operations
</span></span><span style="display:flex;"><span>  state         Advanced state management
</span></span><span style="display:flex;"><span>  taint         Mark a resource instance as not fully functional
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">test</span>          Execute integration tests <span style="color:#204a87;font-weight:bold">for</span> Terraform modules
</span></span><span style="display:flex;"><span>  untaint       Remove the <span style="color:#4e9a06">&#39;tainted&#39;</span> state from a resource instance
</span></span><span style="display:flex;"><span>  version       Show the current Terraform version
</span></span><span style="display:flex;"><span>  workspace     Workspace management
</span></span></code></pre></div><h1 id="3-通过terraform部署k8s应用">3. 通过terraform部署k8s应用</h1>
<h2 id="3-1-创建部署文件">3.1. 创建部署文件</h2>
<p>创建应用目录，并在本地创建<code>main.tf</code>文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  required_providers <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">kubernetes</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87">source</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;hashicorp/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&gt;= 2.0.0&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>provider <span style="color:#4e9a06">&#34;kubernetes&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">config_path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;~/.kube/config&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>resource <span style="color:#4e9a06">&#34;kubernetes_namespace&#34;</span> <span style="color:#4e9a06">&#34;test&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  metadata <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>resource <span style="color:#4e9a06">&#34;kubernetes_deployment&#34;</span> <span style="color:#4e9a06">&#34;test&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  metadata <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span>      <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">namespace</span> <span style="color:#ce5c00;font-weight:bold">=</span> kubernetes_namespace.test.metadata.0.name
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  spec <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">replicas</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>    selector <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">match_labels</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;MyTestApp&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    template <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      metadata <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">labels</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;MyTestApp&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      spec <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        container <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">image</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#000">name</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;nginx-container&#34;</span>
</span></span><span style="display:flex;"><span>          port <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">container_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>resource <span style="color:#4e9a06">&#34;kubernetes_service&#34;</span> <span style="color:#4e9a06">&#34;test&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  metadata <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span>      <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">namespace</span> <span style="color:#ce5c00;font-weight:bold">=</span> kubernetes_namespace.test.metadata.0.name
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  spec <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">selector</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> kubernetes_deployment.test.spec.0.template.0.metadata.0.labels.app
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;NodePort&#34;</span>
</span></span><span style="display:flex;"><span>    port <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node_port</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">30201</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">port</span>        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">target_port</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-执行部署命令">3.2. 执行部署命令</h2>
<ul>
<li><strong>terraform init</strong></li>
</ul>
<p>初始化terraform provider数据。会在本地的<code>.terraform</code>目录下生成provider相关的二进制文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.terraform
</span></span><span style="display:flex;"><span>└── providers
</span></span><span style="display:flex;"><span>    └── registry.terraform.io
</span></span><span style="display:flex;"><span>        └── hashicorp
</span></span><span style="display:flex;"><span>            └── kubernetes
</span></span><span style="display:flex;"><span>                └── 2.38.0
</span></span><span style="display:flex;"><span>                    └── linux_amd64
</span></span><span style="display:flex;"><span>                        ├── LICENSE.txt
</span></span><span style="display:flex;"><span>                        └── terraform-provider-kubernetes_v2.38.0_x5
</span></span></code></pre></div><ul>
<li><strong>terraform plan</strong></li>
</ul>
<p>部署之前预览<code>diff</code>数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># terraform plan</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span></span><span style="display:flex;"><span>  + create
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Terraform will perform the following actions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># kubernetes_deployment.test will be created</span>
</span></span><span style="display:flex;"><span>  + resource <span style="color:#4e9a06">&#34;kubernetes_deployment&#34;</span> <span style="color:#4e9a06">&#34;test&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      + <span style="color:#000">id</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span>known after apply<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      + <span style="color:#000">wait_for_rollout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      + metadata <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          + <span style="color:#000">generation</span>       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span>known after apply<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>          + <span style="color:#000">name</span>             <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>          + <span style="color:#000">namespace</span>        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>          + <span style="color:#000">resource_version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span>known after apply<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>          + <span style="color:#000">uid</span>              <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span>known after apply<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      + spec <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          + <span style="color:#000">min_ready_seconds</span>         <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>          + <span style="color:#000">paused</span>                    <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>          + <span style="color:#000">progress_deadline_seconds</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">600</span>
</span></span><span style="display:flex;"><span>          + <span style="color:#000">replicas</span>                  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;2&#34;</span>
</span></span><span style="display:flex;"><span>          + <span style="color:#000">revision_history_limit</span>    <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>....
</span></span><span style="display:flex;"><span>Plan: <span style="color:#0000cf;font-weight:bold">3</span> to add, <span style="color:#0000cf;font-weight:bold">0</span> to change, <span style="color:#0000cf;font-weight:bold">0</span> to destroy.
</span></span><span style="display:flex;"><span>──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span style="display:flex;"><span>Note: You didn<span style="color:#4e9a06">&#39;t use the -out option to save this plan, so Terraform can&#39;</span>t guarantee to take exactly these actions <span style="color:#204a87;font-weight:bold">if</span> you run <span style="color:#4e9a06">&#34;terraform apply&#34;</span> now.
</span></span></code></pre></div><ul>
<li><strong>terraform apply</strong></li>
</ul>
<p>执行部署的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># terraform apply</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
</span></span><span style="display:flex;"><span>  + create
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Terraform will perform the following actions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># kubernetes_deployment.test will be created</span>
</span></span><span style="display:flex;"><span>  + resource <span style="color:#4e9a06">&#34;kubernetes_deployment&#34;</span> <span style="color:#4e9a06">&#34;test&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      + <span style="color:#000">id</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span>known after apply<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      + <span style="color:#000">wait_for_rollout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Plan: <span style="color:#0000cf;font-weight:bold">3</span> to add, <span style="color:#0000cf;font-weight:bold">0</span> to change, <span style="color:#0000cf;font-weight:bold">0</span> to destroy.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Do you want to perform these actions?
</span></span><span style="display:flex;"><span>  Terraform will perform the actions described above.
</span></span><span style="display:flex;"><span>  Only <span style="color:#4e9a06">&#39;yes&#39;</span> will be accepted to approve.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Enter a value: yes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubernetes_namespace.test: Creating...
</span></span><span style="display:flex;"><span>kubernetes_namespace.test: Creation <span style="color:#204a87">complete</span> after 0s <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">=</span>nginx<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kubernetes_deployment.test: Creating...
</span></span><span style="display:flex;"><span>kubernetes_deployment.test: Creation <span style="color:#204a87">complete</span> after 4s <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">=</span>nginx/nginx<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kubernetes_service.test: Creating...
</span></span><span style="display:flex;"><span>kubernetes_service.test: Creation <span style="color:#204a87">complete</span> after 0s <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">=</span>nginx/nginx<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Apply complete! Resources: <span style="color:#0000cf;font-weight:bold">3</span> added, <span style="color:#0000cf;font-weight:bold">0</span> changed, <span style="color:#0000cf;font-weight:bold">0</span> destroyed.
</span></span></code></pre></div><p><strong>查看部署结果</strong></p>
<p>terraform共创建了三个资源，即对应k8s的三个对象：namespace，deployment，service。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get all -n nginx</span>
</span></span><span style="display:flex;"><span>NAME                        READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/nginx-658c56bc8-djhrx   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          30m
</span></span><span style="display:flex;"><span>pod/nginx-658c56bc8-mh67k   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          30m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>        AGE
</span></span><span style="display:flex;"><span>service/nginx   NodePort   10.96.65.155   &lt;none&gt;        80:30201/TCP   30m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/nginx   2/2     <span style="color:#0000cf;font-weight:bold">2</span>            <span style="color:#0000cf;font-weight:bold">2</span>           30m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                              DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>replicaset.apps/nginx-658c56bc8   <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>       30m
</span></span></code></pre></div><p>部署后会生成terraform.tfstate本地状态记录文件。</p>
<ul>
<li>terraform destroy</li>
</ul>
<p>如果需要清理数据，则可以使用destroy命令清理。</p>
<h1 id="4-总结">4. 总结</h1>
<p>本文以k8s平台为例展示了terraform的基本使用步骤，相比于kubectl和helm的k8s部署工具，terraform无根本区别。</p>
<ul>
<li>
<p><strong>terraform的优势在于以IaC（基础设施即代码）和GitOps的思想把将基础设施相关的运维部署操作以<code>声明式</code>的方式记录在代码中，通过Git去管理期望的最终状态和版本迭代</strong>。</p>
</li>
<li>
<p>同时terraform可以对接绝大部分的基础设施，例如MySQL，Redis等，可以对接各个不同的部署平台和系统，例如阿里云，aws等，也可以针对公司内部的平台，单独写内部平台对接的provider，<strong>从而实现一套工具管理所有的基础设施</strong>。</p>
</li>
</ul>
<p>参考：</p>
<ul>
<li>
<p><a href="https://developer.hashicorp.com/terraform/install">https://developer.hashicorp.com/terraform/install</a></p>
</li>
<li>
<p><a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/guides/getting-started.html">terraform部署k8s服务</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bf0fbb771d80524c8359a906cd4fe4ee">2 - Terraform的基本概念</h1>
    
	<p>本文主要描述编写Terraform部署文件的基本概念。</p>
<h1 id="1-基本概念">1. 基本概念</h1>
<h2 id="1-1-提供商-provider">1.1. 提供商（Provider）</h2>
<p>Provider实现了每一种可配置的资源类型。可以理解为实现了资源增删改查的通用接口。</p>
<p>提供商通常定义在 providers.tf 文件中，您需要指定包含提供商定义的 Terraform 块。当声明了提供商后，Terraform 通过 init 命令自动下载提供商插件。</p>
<p>官方provider的仓库：<a href="https://registry.terraform.io/">https://registry.terraform.io/</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>terraform <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  required_providers <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">alicloud</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;aliyun/alicloud&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.225.0&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>provider <span style="color:#4e9a06">&#34;alicloud&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># 配置你的阿里云凭据和地域信息</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># 出于安全考虑，建议不要在这个文件中直接包含你的阿里云AccessKey和SecretKey，推荐使用环境变量或其它安全方式设置凭据：</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># export ALICLOUD_ACCESS_KEY=&#34;&lt;你的阿里云Access Key&gt;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># export ALICLOUD_SECRET_KEY=&#34;&lt;你的阿里云Secret Key&gt;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">region</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;cn-hangzhou&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-2-资源-resources">1.2. 资源（Resources）</h2>
<p>资源（Resources）是定义基础设施组件的代码块，可以按照资源类型单独使用一个独立的 .tf 文件来存放，例如：database.tf。资源通过关键字 resource 来标识，之后是具体的资源类型和自定义名称。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>resource <span style="color:#4e9a06">&#34;resource_type&#34;</span> <span style="color:#4e9a06">&#34;resource_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># 指定资源类型的参数（Argument）</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-2-1-属性参数引用">1.2.1. 属性参数引用</h3>
<p>当从一个资源块访问另一个资源属性时，使用格式：<code>&lt;resource_type&gt;.&lt;resource_name&gt;.&lt;attribute&gt;</code>。</p>
<h3 id="1-2-2-资源定义考虑事项">1.2.2. 资源定义考虑事项</h3>
<ul>
<li>
<p>resource_name 必须唯一。</p>
</li>
<li>
<p>resource_type 资源类型是与提供商关联的关键字，不能由用户自定义。</p>
</li>
<li>
<p>所有配置参数必须包含在资源块体内，即大括号之间。</p>
</li>
<li>
<p>所有必填参数必须设置。</p>
</li>
</ul>
<h2 id="1-3-变量-variables">1.3. 变量（Variables）</h2>
<p>变量用于参数化你的 Terraform 配置。输入变量作为参数供给 Terraform 使用，使其允许在无需更改源配置代码的情况下轻松定制和共享配置。在 Terraform 运行时可以有多种不同的方式来设置其值：环境变量、CLI 参数、键值文件等。</p>
<p>变量必须在 variable 块中声明。建议将所有的变量声明保存在一个名为 variables.tf 的文件中。变量没有必选的参数，因此变量块可以为空，Terraform 可以根据变量值自动推断类型和默认值。</p>
<p>变量名称有两个设置规则：</p>
<ul>
<li>
<p>变量名在模块内必须唯一</p>
</li>
<li>
<p>变量名不能是关键字，例如：count，for_each等</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>variable <span style="color:#4e9a06">&#34;variable_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;变量类型&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;变量的描述&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;赋予变量的默认值&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#000">sensitive</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;是否是敏感信息&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#000">validation</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;变量值的验证规则&gt;
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-3-1-type">1.3.1. type</h3>
<p>type 参数指定了变量接受的值的类型。Terraform 支持以下基本变量类型：</p>
<ul>
<li>
<p><strong>bool</strong>，用于二进制值，如 true 或 false（不带引号）</p>
</li>
<li>
<p><strong>number</strong>，用于数值变量</p>
</li>
<li>
<p><strong>string</strong>，用于字符序列</p>
</li>
</ul>
<h3 id="1-3-2-default">1.3.2. default</h3>
<p>要访问模块内声明的变量值，可以使用表达式 <code>var.</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>resource <span style="color:#4e9a06">&#34;alicloud_vpc&#34;</span> <span style="color:#4e9a06">&#34;my_vpc&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vpc_name</span>    <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;main-vpc&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cidr_block</span>  <span style="color:#ce5c00;font-weight:bold">=</span> var.vpc_cidr_block
</span></span><span style="display:flex;"><span>  <span style="color:#000">description</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>variable <span style="color:#4e9a06">&#34;vpc_cidr_block&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">default</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;10.0.0.0/16&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>默认值可以通过分配值在环境变量或 .tfvars 文件或 -var 选项中被覆盖，如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过 CLI -var 选项覆盖变量默认值</span>
</span></span><span style="display:flex;"><span>$ terraform plan -var <span style="color:#000">vpc_cidr_block</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;172.16.0.0/16&#34;</span>
</span></span></code></pre></div><h3 id="1-3-3-sensitive">1.3.3. sensitive</h3>
<p>敏感值的可接受值为true。当设置为true时，变量的值在 terraform plan 或terraform apply 的输出中标记为敏感。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ terraform plan
</span></span><span style="display:flex;"><span>Terraform will perform the following actions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># alicloud_vpc.my-vpc will be created</span>
</span></span><span style="display:flex;"><span>  + resource <span style="color:#4e9a06">&#34;alicloud_vpc&#34;</span> <span style="color:#4e9a06">&#34;my-vpc&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      + <span style="color:#000">cidr_block</span>            <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span>sensitive value<span style="color:#ce5c00;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic"># 标记为敏感信息</span>
</span></span><span style="display:flex;"><span>      + <span style="color:#000">create_time</span>           <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span>known after apply<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      + <span style="color:#000">id</span>                    <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span>known after apply<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      + <span style="color:#000">status</span>                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span>known after apply<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      + <span style="color:#000">user_cidrs</span>            <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span>known after apply<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      + <span style="color:#000">vpc_name</span>              <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;main-vpc&#34;</span>
</span></span><span style="display:flex;"><span>      ...
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-3-4-validation">1.3.4. validation</h3>
<p>验证块包含一个条件参数，用于指定验证规则。你可以通过在变量块中包含验证子块来验证赋给变量的值。</p>
<p>在如下示例中，length 和 substr 用作条件参数，验证 vpc_name 的值是否长度超过 4 并且是否以 tf- 为开头：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>variable <span style="color:#4e9a06">&#34;vpc_name&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  validation <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">condition</span>     <span style="color:#ce5c00;font-weight:bold">=</span> length<span style="color:#ce5c00;font-weight:bold">(</span>var.vpc_name<span style="color:#ce5c00;font-weight:bold">)</span> &gt; <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> substr<span style="color:#ce5c00;font-weight:bold">(</span>var.vpc_name, 0, 3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;tf-&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">error_message</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;The vpc name must start with &#39;tf-&#39; and be longer than 4 characters.&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-3-5-变量的设置方式">1.3.5. 变量的设置方式</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># .tfvars 文件（推荐）</span>
</span></span><span style="display:flex;"><span>$ terraform apply -var-file my-vars.tfvars
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># CLI 选项</span>
</span></span><span style="display:flex;"><span>$ terraform apply -var <span style="color:#000">vpc_cidr_block</span><span style="color:#ce5c00;font-weight:bold">=</span>“172.16.0.0/16”
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 环境变量</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#204a87">export</span> <span style="color:#000">TF_VAR_vpc_dicr_block</span><span style="color:#ce5c00;font-weight:bold">=</span>“172.16.0.0/16”
</span></span><span style="display:flex;"><span>$ terraform apply
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 默认的变量文件 terraform.tfvars</span>
</span></span><span style="display:flex;"><span>$ terraform apply
</span></span></code></pre></div><h3 id="1-3-6-变量的最佳实践">1.3.6. 变量的最佳实践</h3>
<ul>
<li>
<p><strong>只参数化每个实例或环境中会变化的值</strong></p>
</li>
<li>
<p><strong>尽可能使用 .tfvars 变量文件</strong></p>
</li>
<li>
<p><strong>给变量起与其使用目的相关的名称</strong></p>
</li>
<li>
<p><strong>变量必须要有描述，增强 Terraform 配置文件的可读性和可维护性。</strong></p>
</li>
</ul>
<h2 id="1-4-输出-outputs">1.4. 输出（Outputs）</h2>
<p>outputs.tf 文件保存了资源的输出值。由 Terraform 管理的每个资源实例都可以导出属性，这些属性的值可在 Terraform 配置的其他地方被引用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>output <span style="color:#4e9a06">&#34;vswitch_id&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> alicloud_vswitch.main_vswitch.id
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-5-状态-state">1.5. 状态（State）</h2>
<p>Terraform 在状态文件中保存它管理的资源的状态。默认情况下，状态文件是存储在本地，但它也可以远端存储。在团队协作场景中，远端存储通常是首选方法。</p>
<p>不要修改或触碰此文件，它是自动创建和更新的，一旦状态文件损坏，将会导致继续执行 Terraform 失败或者重复创建新的资源。</p>
<h1 id="2-terraform目录">2. Terraform目录</h1>
<ul>
<li>
<p><strong>根模块</strong></p>
<p>根模块也被称为根配置文件，是运行 Terraform 命令的工作目录。</p>
</li>
<li>
<p><strong>子模块</strong></p>
<p>子模块是可选的，每个子模块可以是出于对某类复用功能的抽象，也可以是出于对根模块复杂逻辑的简化。根模块通过对子模块的引用来降低根模块的编写复杂度，提升复用性和可读性。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>├── main.tf
</span></span><span style="display:flex;"><span>├── modules
</span></span><span style="display:flex;"><span> ├── network
</span></span><span style="display:flex;"><span> │ ├── main.tf
</span></span><span style="display:flex;"><span> │ ├── variables.tf
</span></span><span style="display:flex;"><span> │ └── outputs.tf
</span></span><span style="display:flex;"><span> └── server
</span></span><span style="display:flex;"><span>   ├── main.tf
</span></span><span style="display:flex;"><span>   ├── variables.tf
</span></span><span style="display:flex;"><span>   └── outputs.tf
</span></span></code></pre></div><p>输出调用关系图</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># install graphviz for mac</span>
</span></span><span style="display:flex;"><span>brew install graphviz
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 生成调用关系</span>
</span></span><span style="display:flex;"><span>terraform graph <span style="color:#000;font-weight:bold">|</span> dot -Tsvg &gt; graph.svg
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://help.aliyun.com/zh/terraform/basic-terms?spm=a2c4g.11186623.help-menu-95817.d_3_0_1.1a42673dZFDpQ9&amp;scm=20140722.H_2837056._.OR_help-T_cn~zh-V_1">基本术语_Terraform</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/zh/terraform/resource-introduction?spm=a2c4g.11186623.help-menu-95817.d_3_2_0.16133193brrXl6&amp;scm=20140722.H_2837062._.OR_help-T_cn~zh-V_1">Resource 介绍_Terraform</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e48abb517180f08f5738fa9863d9944f">3 - Terraform的模块及依赖引用</h1>
    
	<h1 id="1-模块-modules">1. 模块（Modules）</h1>
<h2 id="1-1-module简介">1.1. module简介</h2>
<p>Terraform 模块是一组位于单个目录中的 Terraform 配置文件，即使是一个包含了一个或多个 .tf 文件的单一目录的简单配置也被视为一个模块。模块是 Terraform 中代码复用的主要方法，它们通过指定可以检索代码的源来重复使用。</p>
<p><strong>模块可以多层嵌套，类似代码中的函数。</strong></p>
<blockquote>
<p><strong>Module 就是一组 <code>.tf</code> 文件的集合</strong>，用来创建一组相关的基础设施资源。</p>
</blockquote>
<p>比如：</p>
<ul>
<li>一个 <code>vpc</code> 模块：创建 VPC、子网、路由表</li>
<li>一个 <code>rds</code> 模块：创建数据库实例、安全组</li>
<li>一个 <code>eks</code> 模块：创建 Kubernetes 集群</li>
</ul>
<h2 id="1-2-module-的基本结构">1.2. Module 的基本结构</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>modules/
</span></span><span style="display:flex;"><span>└── vpc/
</span></span><span style="display:flex;"><span>    ├── main.tf          <span style="color:#8f5902;font-style:italic"># 资源定义</span>
</span></span><span style="display:flex;"><span>    ├── variables.tf     <span style="color:#8f5902;font-style:italic"># 输入参数</span>
</span></span><span style="display:flex;"><span>    └── outputs.tf       <span style="color:#8f5902;font-style:italic"># 输出结果</span>
</span></span></code></pre></div><p><code>modules/vpc/main.tf</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>resource <span style="color:#4e9a06">&#34;aws_vpc&#34;</span> <span style="color:#4e9a06">&#34;main&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cidr_block</span> <span style="color:#ce5c00;font-weight:bold">=</span> var.cidr_block
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">tags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Name</span> <span style="color:#ce5c00;font-weight:bold">=</span> var.name
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>resource <span style="color:#4e9a06">&#34;aws_subnet&#34;</span> <span style="color:#4e9a06">&#34;private&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">=</span> length<span style="color:#ce5c00;font-weight:bold">(</span>var.private_subnets<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vpc_id</span>            <span style="color:#ce5c00;font-weight:bold">=</span> aws_vpc.main.id
</span></span><span style="display:flex;"><span>  <span style="color:#000">cidr_block</span>        <span style="color:#ce5c00;font-weight:bold">=</span> var.private_subnets<span style="color:#ce5c00;font-weight:bold">[</span>count.index<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">availability_zone</span> <span style="color:#ce5c00;font-weight:bold">=</span> element<span style="color:#ce5c00;font-weight:bold">(</span>var.azs, count.index<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">tags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;private-</span><span style="color:#4e9a06">${</span><span style="color:#000">element</span><span style="color:#000;font-weight:bold">(var.azs, count.index)</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>variables.tf</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>variable <span style="color:#4e9a06">&#34;cidr_block&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> string
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>variable <span style="color:#4e9a06">&#34;name&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> string
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>variable <span style="color:#4e9a06">&#34;private_subnets&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> list<span style="color:#ce5c00;font-weight:bold">(</span>string<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>variable <span style="color:#4e9a06">&#34;azs&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> list<span style="color:#ce5c00;font-weight:bold">(</span>string<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>outputs.tf</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>output <span style="color:#4e9a06">&#34;vpc_id&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> aws_vpc.main.id
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#4e9a06">&#34;private_subnet_ids&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> aws_subnet.private<span style="color:#ce5c00;font-weight:bold">[</span>*<span style="color:#ce5c00;font-weight:bold">]</span>.id
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-3-在根模块中使用-module">1.3. 在根模块中使用 Module</h2>
<p>方法 1：本地模块</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>module <span style="color:#4e9a06">&#34;prod_vpc&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;./modules/vpc&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cidr_block</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;10.0.0.0/16&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;prod-vpc&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">private_subnets</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;10.0.1.0/24&#34;</span>, <span style="color:#4e9a06">&#34;10.0.2.0/24&#34;</span>, <span style="color:#4e9a06">&#34;10.0.3.0/24&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">azs</span>             <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;us-west-2a&#34;</span>, <span style="color:#4e9a06">&#34;us-west-2b&#34;</span>, <span style="color:#4e9a06">&#34;us-west-2c&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>方法 2：远程模块</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>module <span style="color:#4e9a06">&#34;vpc&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;git::https://github.com/your-org/terraform-modules.git//vpc?ref=v1.0.0&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cidr_block</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;10.10.0.0/16&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;dev-vpc&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># ... 其他参数</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>支持来源类型：</p>
<ul>
<li><code>./path/to/module</code> — 本地</li>
<li><code>github.com/org/repo//dir</code></li>
<li><code>git::https://...</code></li>
<li><code>terraform-registry-mirror/internal/modules/vpc</code></li>
</ul>
<h2 id="1-4-module-的输入与输出">1.4. Module 的输入与输出</h2>
<p><strong>1. 输入（Input Variables）</strong></p>
<p>通过 <code>variables.tf</code> 定义参数，在调用时传入。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>module <span style="color:#4e9a06">&#34;xxx&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;...&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">param1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;value1&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">param2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>2. 输出（Outputs）</strong></p>
<p>其他模块或根配置可以通过 <code>module.&lt;name&gt;.&lt;output&gt;</code> 引用输出值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 假设 module.vpc 输出了 vpc_id 和 subnet_ids</span>
</span></span><span style="display:flex;"><span>resource <span style="color:#4e9a06">&#34;aws_instance&#34;</span> <span style="color:#4e9a06">&#34;app&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">subnet_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> module.prod_vpc.private_subnet_ids<span style="color:#ce5c00;font-weight:bold">[</span>0<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># ...</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-5-实际使用场景示例">1.5. 实际使用场景示例</h2>
<p><strong>VPC 模块创建网络，RDS 模块使用它的输出来部署数据库</strong>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># main.tf</span>
</span></span><span style="display:flex;"><span>module <span style="color:#4e9a06">&#34;network&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;./modules/vpc&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cidr_block</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;10.0.0.0/16&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">name</span>       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;my-app-network&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">private_subnets</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;10.0.1.0/24&#34;</span>, <span style="color:#4e9a06">&#34;10.0.2.0/24&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">azs</span>             <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;us-west-2a&#34;</span>, <span style="color:#4e9a06">&#34;us-west-2b&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>module <span style="color:#4e9a06">&#34;database&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;./modules/rds&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vpc_id</span>         <span style="color:#ce5c00;font-weight:bold">=</span> module.network.vpc_id
</span></span><span style="display:flex;"><span>  <span style="color:#000">subnet_ids</span>     <span style="color:#ce5c00;font-weight:bold">=</span> module.network.private_subnet_ids
</span></span><span style="display:flex;"><span>  <span style="color:#000">instance_class</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;db.t3.micro&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-资源依赖">2. 资源依赖</h1>
<p>Terraform 有两种依赖关系：<code>隐式依赖</code>（Implicit Dependence）和`显式依赖``（Explicit Dependence）。隐式依赖是 Terraform 已知的，而显式依赖是未知的。</p>
<h2 id="2-1-隐式依赖-implicit-dependence">2.1. 隐式依赖（Implicit Dependence）</h2>
<p><strong>隐式依赖简单来讲就是对于变量引用的依赖</strong>。当一个资源的创建依赖于另一个资源创建后的信息时，需要用到隐式依赖来让 Terraform 知晓依赖关系。</p>
<p>针对隐式依赖关系，Terraform 通过属性值引用赋值的方式来知晓。</p>
<h2 id="2-2-显式依赖-explicit-dependence">2.2. 显式依赖（Explicit Dependence）</h2>
<p>显式依赖就是Terraform无法通过变量之间的引用关系推断出来，需要用户明确指出的依赖。可以使用 depends_on 来显式声明依赖关系。无论资源类型是什么，depends_on 可以在模块内使用，该值可以是指向资源的表达式。</p>
<h2 id="2-3-平级module的变量引用">2.3. 平级module的变量引用</h2>
<p><strong>Terraform 中：Module 之间不能直接访问对方的内部资源或输出，除非通过根模块中显式传递。</strong></p>
<p>但你可以通过 <strong>根模块作为“中介”</strong>，将一个 module 的输出传给另一个 module 作为输入。</p>
<p><strong>示例：两个平级模块通信</strong></p>
<p>假设我们有两个模块：</p>
<ul>
<li><code>vpc</code>：创建 VPC 和子网</li>
<li><code>eks</code>：创建 EKS 集群，需要使用 VPC 创建的子网 ID</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── main.tf
</span></span><span style="display:flex;"><span>├── variables.tf
</span></span><span style="display:flex;"><span>├── outputs.tf
</span></span><span style="display:flex;"><span>└── modules/
</span></span><span style="display:flex;"><span>    ├── vpc/
</span></span><span style="display:flex;"><span>    │   ├── main.tf
</span></span><span style="display:flex;"><span>    │   └── outputs.tf
</span></span><span style="display:flex;"><span>    └── eks/
</span></span><span style="display:flex;"><span>        ├── main.tf
</span></span><span style="display:flex;"><span>        └── variables.tf
</span></span></code></pre></div><p><strong>步骤 1：为 <code>vpc</code> 模块定义输出（<code>modules/vpc/outputs.tf</code>）</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>output <span style="color:#4e9a06">&#34;private_subnet_ids&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> aws_subnet.private<span style="color:#ce5c00;font-weight:bold">[</span>*<span style="color:#ce5c00;font-weight:bold">]</span>.id
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>output <span style="color:#4e9a06">&#34;vpc_id&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> aws_vpc.main.id
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>步骤 2：为 <code>eks</code> 模块定义输入变量（<code>modules/eks/variables.tf</code>）</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>variable <span style="color:#4e9a06">&#34;vpc_id&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> string
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>variable <span style="color:#4e9a06">&#34;subnet_ids&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">type</span> <span style="color:#ce5c00;font-weight:bold">=</span> list<span style="color:#ce5c00;font-weight:bold">(</span>string<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>步骤 3：在根模块中调用并连接两个模块（<code>main.tf</code>）</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 VPC 模块</span>
</span></span><span style="display:flex;"><span>module <span style="color:#4e9a06">&#34;network&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;./modules/vpc&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># 输入变量...</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 EKS 模块，使用 network 模块的输出作为输入</span>
</span></span><span style="display:flex;"><span>module <span style="color:#4e9a06">&#34;cluster&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;./modules/eks&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vpc_id</span>     <span style="color:#ce5c00;font-weight:bold">=</span> module.network.vpc_id
</span></span><span style="display:flex;"><span>  <span style="color:#000">subnet_ids</span> <span style="color:#ce5c00;font-weight:bold">=</span> module.network.private_subnet_ids
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>这样就实现了：<strong><code>eks</code> 模块使用了平级 <code>vpc</code> 模块的输出值</strong>。</p>
<h2 id="2-4-父级模块的变量引用">2.4. 父级模块的变量引用</h2>
<p><strong>核心原则：Terraform 模块的引用方向是 单向向下的。</strong></p>
<blockquote>
<p>🔹 <strong>Terraform 只能引用当前模块直接调用的“子模块”的 <code>output</code> 字段。</strong><br>
🔹 <strong>不能向上引用父级、也不能横向引用兄弟模块。</strong><br>
🔹 <strong>所有跨模块通信都必须通过“调用者”显式传递（通常是根模块）。</strong></p>
</blockquote>
<p>依赖必须由“上层模块”显式传递，通过 <strong>根模块中转</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>module <span style="color:#4e9a06">&#34;A&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;./modules/a&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>module <span style="color:#4e9a06">&#34;B&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;./modules/b&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># 正确！根模块把 A 的输出传给 B 的输入</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vpc_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> module.A.vpc_id
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-5-推荐架构设计原则">2.5. 推荐架构设计原则</h2>
<ol>
<li>
<p><strong>扁平化优于深层嵌套</strong></p>
<ul>
<li>尽量让多个模块由根模块统一调用</li>
<li>减少层级，便于管理依赖</li>
</ul>
</li>
<li>
<p><strong>接口清晰化</strong></p>
<ul>
<li>每个模块通过 <code>outputs.tf</code> 明确暴露哪些值</li>
<li>通过 <code>variables.tf</code> 明确需要哪些输入</li>
</ul>
</li>
<li>
<p><strong>避免循环依赖</strong></p>
<ul>
<li>A → B → C → A 是非法的</li>
<li>如果出现，说明模块职责不清，需重构</li>
</ul>
</li>
<li>
<p><strong>用 locals 或 variables 统一配置</strong></p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>locals <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">common_tags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#000">Environment</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;prod&#34;</span> <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>module <span style="color:#4e9a06">&#34;vpc&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;./modules/vpc&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">tags</span>   <span style="color:#ce5c00;font-weight:bold">=</span> local.common_tags
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>module <span style="color:#4e9a06">&#34;rds&#34;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">source</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;./modules/rds&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">tags</span>   <span style="color:#ce5c00;font-weight:bold">=</span> local.common_tags
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://help.aliyun.com/zh/terraform/resource-dependence?spm=a2c4g.11186623.help-menu-95817.d_3_2_3.5ca03e1cAvq0zp&amp;scm=20140722.H_2837069._.OR_help-T_cn~zh-V_1">资源依赖_Terraform</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/zh/terraform/depends-on?spm=a2c4g.11186623.help-menu-95817.d_3_3_0_0.3ac96fd4IO0YM0&amp;scm=20140722.H_2875514._.OR_help-T_cn~zh-V_1">depends_on,显示依赖_Terraform</a></p>
</li>
<li>
<p><a href="https://docs.aws.amazon.com/zh_cn/prescriptive-guidance/latest/terraform-aws-provider-best-practices/structure.html">代码库结构和组织的最佳实践 - AWS 规范性指导</a></p>
</li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2025 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
