<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/kubernetes-notes/monitor/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/kubernetes-notes/monitor/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>监控体系 | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="监控体系" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/kubernetes-notes/monitor/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="监控体系">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="监控体系"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/kubernetes-notes/" ><span class="active">Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/k8s-source-code-analysis/" ><span>Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/linux-notes/" ><span>Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.13204a7ec230d4c82f66156939ed196d.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/kubernetes-notes/monitor/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">监控体系</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-0246871f1f5b13bc1876ca30494b9e94">kube-prometheus-stack的使用</a></li>


    
  
    
    
	
<li>2: <a href="#pg-ba6ff3e130589d9a22b217a89ee69d71">Kubernetes集群监控</a></li>


    
  
    
    
	
<li>3: <a href="#pg-063a156fcf744316e09eb6d743179121">cAdvisor介绍</a></li>


    
  
    
    
	
<li>4: <a href="#pg-c35df90033980941ba5c63379e5cfcbe">Heapster介绍</a></li>


    
  
    
    
	
<li>5: <a href="#pg-5a2ec7c9c0c23b6304b5fdd306263b4c">Influxdb介绍</a></li>


    
  
    
    
	
<li>6: <a href="#pg-92606946619161c3d94670cf180b1a17">Grafana部署</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0246871f1f5b13bc1876ca30494b9e94">1 - kube-prometheus-stack的使用</h1>
    
	<h1 id="1-kube-prometheus-stack简介">1. kube-prometheus-stack简介</h1>
<p>kube-prometheus-stack是prometheus监控k8s集群的套件，可以通过helm一键安装，同时带有监控的模板。</p>
<p>各组件包括</p>
<ul>
<li>grafana</li>
<li>kube-state-metrics</li>
<li>prometheus</li>
<li>alertmanager</li>
<li>node-exporter</li>
</ul>
<h1 id="2-安装kube-prometheus-stack">2. 安装kube-prometheus-stack</h1>
<p>执行以下命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack -n prometheus
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># helm install kube-prometheus-stack  prometheus-community/kube-prometheus-stack -n prometheus</span>
</span></span><span style="display:flex;"><span>NAME: kube-prometheus-stack
</span></span><span style="display:flex;"><span>LAST DEPLOYED: Wed May <span style="color:#0000cf;font-weight:bold">17</span> 17:12:24 <span style="color:#0000cf;font-weight:bold">2023</span>
</span></span><span style="display:flex;"><span>NAMESPACE: prometheus
</span></span><span style="display:flex;"><span>STATUS: deployed
</span></span><span style="display:flex;"><span>REVISION: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>NOTES:
</span></span><span style="display:flex;"><span>kube-prometheus-stack has been installed. Check its status by running:
</span></span><span style="display:flex;"><span>  kubectl --namespace prometheus get pods -l <span style="color:#4e9a06">&#34;release=kube-prometheus-stack&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Visit https://github.com/prometheus-operator/kube-prometheus <span style="color:#204a87;font-weight:bold">for</span> instructions on how to create <span style="color:#000;font-weight:bold">&amp;</span> configure Alertmanager and Prometheus instances using the Operator.
</span></span></code></pre></div><h1 id="3-查看安装结果">3. 查看安装结果</h1>
<ul>
<li>
<p>deployment</p>
<ul>
<li>kube-prometheus-stack-grafana</li>
<li>kube-prometheus-stack-kube-state-metrics</li>
<li>kube-prometheus-stack-operator</li>
</ul>
</li>
<li>
<p>statefulset</p>
<ul>
<li>prometheus-kube-prometheus-stack-prometheus</li>
<li>alertmanager-kube-prometheus-stack-alertmanager</li>
</ul>
</li>
<li>
<p>daemonset</p>
<ul>
<li>kube-prometheus-stack-prometheus-node-exporter</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kg all -n prometheus</span>
</span></span><span style="display:flex;"><span>NAME                                                            READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/alertmanager-kube-prometheus-stack-alertmanager-0           2/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m34s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-grafana-5bb7689dc8-lgrws              3/3     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m35s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-kube-state-metrics-5d6578867c-25xbq   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m35s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-operator-9c5fbdc68-nrn7h              1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m35s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-prometheus-node-exporter-8ghd8        1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          48s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-prometheus-node-exporter-brtp9        1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          29s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-prometheus-node-exporter-n4kdp        1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          88s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-prometheus-node-exporter-ttksv        1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35s
</span></span><span style="display:flex;"><span>pod/prometheus-kube-prometheus-stack-prometheus-0               2/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m34s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>                      AGE
</span></span><span style="display:flex;"><span>service/alertmanager-operated                            ClusterIP   None             &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP   9m34s
</span></span><span style="display:flex;"><span>service/kube-prometheus-stack-alertmanager               ClusterIP   10.99.108.180    &lt;none&gt;        9093/TCP                     9m36s
</span></span><span style="display:flex;"><span>service/kube-prometheus-stack-grafana                    ClusterIP   10.110.62.28     &lt;none&gt;        80/TCP                       9m36s
</span></span><span style="display:flex;"><span>service/kube-prometheus-stack-kube-state-metrics         ClusterIP   10.110.105.139   &lt;none&gt;        8080/TCP                     9m35s
</span></span><span style="display:flex;"><span>service/kube-prometheus-stack-operator                   ClusterIP   10.96.147.204    &lt;none&gt;        443/TCP                      9m36s
</span></span><span style="display:flex;"><span>service/kube-prometheus-stack-prometheus                 ClusterIP   10.98.235.203    &lt;none&gt;        9090/TCP                     9m36s
</span></span><span style="display:flex;"><span>service/kube-prometheus-stack-prometheus-node-exporter   ClusterIP   10.105.99.77     &lt;none&gt;        9100/TCP                     9m36s
</span></span><span style="display:flex;"><span>service/prometheus-operated                              ClusterIP   None             &lt;none&gt;        9090/TCP                     9m34s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                                            DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
</span></span><span style="display:flex;"><span>daemonset.apps/kube-prometheus-stack-prometheus-node-exporter   <span style="color:#0000cf;font-weight:bold">4</span>         <span style="color:#0000cf;font-weight:bold">4</span>         <span style="color:#0000cf;font-weight:bold">4</span>       <span style="color:#0000cf;font-weight:bold">4</span>            <span style="color:#0000cf;font-weight:bold">4</span>           &lt;none&gt;          9m35s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                                       READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/kube-prometheus-stack-grafana              1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           9m35s
</span></span><span style="display:flex;"><span>deployment.apps/kube-prometheus-stack-kube-state-metrics   1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           9m35s
</span></span><span style="display:flex;"><span>deployment.apps/kube-prometheus-stack-operator             1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           9m35s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                                               READY   AGE
</span></span><span style="display:flex;"><span>statefulset.apps/alertmanager-kube-prometheus-stack-alertmanager   1/1     9m34s
</span></span><span style="display:flex;"><span>statefulset.apps/prometheus-kube-prometheus-stack-prometheus       1/1     9m34s
</span></span></code></pre></div><h1 id="4-登录grafana">4. 登录grafana</h1>
<p>默认账号密码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>账号：admin
</span></span><span style="display:flex;"><span>密码：prom-operator
</span></span></code></pre></div><p>默认账号密码位于secret中，通过base64解码可得上述密码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kg secret -n prometheus kube-prometheus-stack-grafana -oyaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  admin-password: <span style="color:#000">cHJvbS1vcGVyYXRvcg</span><span style="color:#ce5c00;font-weight:bold">==</span>
</span></span><span style="display:flex;"><span>  admin-user: <span style="color:#000">YWRtaW4</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span></code></pre></div><p>模板内容：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1684392039/article/kubernetes/monitor/grafana.png" alt=""></p>
<p>pod数据：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1684392101/article/kubernetes/monitor/pod-stats.png" alt=""></p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack">https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack</a></li>
<li><a href="https://github.com/prometheus-operator/kube-prometheus">https://github.com/prometheus-operator/kube-prometheus</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ba6ff3e130589d9a22b217a89ee69d71">2 - Kubernetes集群监控</h1>
    
	<h1 id="1-概述">1. 概述</h1>
<h2 id="1-1-cadvisor">1.1. cAdvisor</h2>
<p>cAdvisor对Node机器上的资源及容器进行实时监控和性能数据采集，包括CPU使用情况、内存使用情况、网络吞吐量及文件系统使用情况，cAdvisor集成在Kubelet中，当kubelet启动时会自动启动cAdvisor，即一个cAdvisor仅对一台Node机器进行监控。kubelet的启动参数--cadvisor-port可以定义cAdvisor对外提供服务的端口，默认为4194。可以通过浏览器<code>Node_IP:port</code>访问。项目主页：http://github.com/google/cadvisor。</p>
<h2 id="1-2-heapster">1.2. Heapster</h2>
<p>是对集群中的各个Node、Pod的资源使用数据进行采集，通过访问每个Node上Kubelet的API，再通过Kubelet调用cAdvisor的API来采集该节点上所有容器的性能数据。由Heapster进行数据汇聚，保存到后端存储系统中，例如InfluxDB，Google Cloud Logging等。项目主页为：https://github.com/kubernetes/heapster。</p>
<h2 id="1-3-influxdb">1.3. InfluxDB</h2>
<p>是分布式时序数据库（每条记录带有时间戳属性），主要用于实时数据采集、事件跟踪记录、存储时间图表、原始数据等。提供REST API用于数据的存储和查询。项目主页为http://InfluxDB.com。</p>
<h2 id="1-4-grafana">1.4. Grafana</h2>
<p>通过Dashboard将InfluxDB的时序数据展现成图表形式，便于查看集群运行状态。项目主页为http://Grafana.org。</p>
<h2 id="1-5-总体架构图">1.5. 总体架构图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579058/article/kubernetes/monitor/k8s-monitor-arch.png" alt="k8s监控架构图"></p>
<p>其中当前Kubernetes中，Heapster、InfluxDB、Grafana均以Pod的形式启动和运行。Heapster与Master需配置安全连接。</p>
<h1 id="2-部署与使用">2. 部署与使用</h1>
<h2 id="2-1-cadvisor">2.1. cAdvisor</h2>
<p>kubelet的启动参数--cadvisor-port可以定义cAdvisor对外提供服务的端口，默认为4194。可以通过浏览器<code>Node_IP:port</code>访问。也提供了REST API供客户端远程调用，API返回的格式为JSON，可以采用URL访问：http://<code>hostname</code>:<code>port</code>/api/<code>version</code>/<code>request</code>/</p>
<p>例如：<a href="http://14.152.49.100:4194/api/v1.3/machine">http://14.152.49.100:4194/api/v1.3/machine</a> 获取主机信息。</p>
<h2 id="2-2-service">2.2. Service</h2>
<h2 id="2-2-1-heapster-service">2.2.1. heapster-service</h2>
<p><strong>heapster-service.yaml</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">apiVersion:v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">kind:Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">label</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">kubenetes.io/cluster-service:&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">kubernetes.io/name:Heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">namespace:kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">port:80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">targetPort:8082</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">k8s-app:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-2-2-influxdb-service">2.2.2. influxdb-service</h2>
<p><strong>influxdb-service.yaml</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">apiVersion:v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">kind:Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">label:null</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name:monitoring-InfluxDB</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">namespace:kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">type:Nodeport</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">name:http</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">port:80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">targetPort:8083</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">name:api</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">port:8086</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">targetPort:8086</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">Nodeport:8086</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name:influxGrafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-2-3-grafana-service">2.2.3. grafana-service</h2>
<p><strong>grafana-service.yaml</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">apiVersion:v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">kind:Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">label</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">kubenetes.io/cluster-service:&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">kubernetes.io/name:monitoring-Grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name:monitoring-Grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">namespace:kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">type:Nodeport</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">port:80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">targetPort:8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">Nodeport:8085</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name:influxGrafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>使用type=NodePort将InfluxDB和Grafana暴露在Node的端口上，以便通过浏览器进行访问。</p>
<h2 id="2-2-4-创建service">2.2.4. 创建service</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create -f heapster-service.yaml
</span></span><span style="display:flex;"><span>kubectl create -f InfluxDB-service.yaml
</span></span><span style="display:flex;"><span>kubectl create -f Grafana-service.yaml
</span></span></code></pre></div><h2 id="2-3-replicationcontroller">2.3. ReplicationController</h2>
<h2 id="2-3-1-influxdb-grafana-controller">2.3.1. influxdb-grafana-controller</h2>
<p><strong>influxdb-grafana-controller-v3.yaml</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">apiVersion:v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">kind:ReplicationController</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name:monitoring-influxdb-grafana-v3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">namespace:kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">k8s-app:influxGrafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">version:v3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">kubernetes.io/cluster-service:&#34;true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">replicas:1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">k8s-app:influxGrafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">version:v3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">k8s-app:influxGrafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">version:v3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">kubernetes.io/cluster-service:&#34;true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">image:gcr.io/google_containers/heapster_influxdb:v0.5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">name:influxdb</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">cpu:100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">memory:500Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">cpu:100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">memory:500Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">containerPort:8083</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">containerPort:8086</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>-<span style="color:#000">name:influxdb-persistent-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">mountPath:/data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">image:grc.io/google_containers/heapster_grafana:v2.6.0-2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">name:grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">cpu:100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">memory:100Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">cpu:100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">memory:100Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">name:INFLUXDB_SERVICE_URL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">value:http://monitoring-influxdb:8086</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">name:GF_AUTH_BASIC_ENABLED</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">value:&#34;false&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">name:GF_AUTH_ANONYMOUS_ENABLED</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">value:&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">name:GF_AUTH_ANONYMOUS_ORG_ROLE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">value:Admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">name:GF_SERVER_ROOT_URL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">value:/api/v1/proxy/namespace/kube-system/services/monitoring-grafana/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">name:grafana-persistent-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">mountPath:/var</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">name:influxdb-persistent-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">emptyDir{}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">name:grafana-persistent-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">emptyDir{}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-3-2-heapster-controller">2.3.2. heapster-controller</h2>
<p><strong>heapster-controller.yaml</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">apiVersion:v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">kind:ReplicationController</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">k8s-app:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">name:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">version:v6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">namespace:kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">replicas:1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">name:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">k8s-app:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">version:v6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000">k8s-app:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000">version:v6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span>- <span style="color:#000">image:gcr.io/google_containers/heapster:v0.17.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#000">name:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span>- <span style="color:#000">/heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span>- --<span style="color:#000">source=kubernetes:http://192.168.1.128:8080?inClusterConfig=flase&amp;kubeletHttps=true&amp;useServiceAccount=true&amp;auth=</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span>- --<span style="color:#000">sink=InfluxDB:http://monitoring-InfluxDB:8086</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Heapster设置启动参数说明：</p>
<p>1、–source</p>
<p>配置监控来源，本例中表示从k8s-Master获取各个Node的信息。在URL的参数部分，修改kubeletHttps、inClusterConfig、useServiceAccount的值。</p>
<p>2、–sink</p>
<p>配置后端的存储系统，本例中使用InfluxDB。URL中主机名的地址是InfluxDB的Service名字，需要DNS服务正常工作，如果没有配置DNS服务可使用Service的ClusterIP地址。</p>
<h2 id="2-3-3-创建replicationcontroller">2.3.3. 创建ReplicationController</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubelet create -f InfluxDB-Grafana-controller.yaml
</span></span><span style="display:flex;"><span>kubelet create -f heapster-controller.yaml
</span></span></code></pre></div><h1 id="3-查看界面及数据">3. 查看界面及数据</h1>
<h2 id="3-1-influxdb">3.1. InfluxDB</h2>
<p>访问任意一台Node机器的30083端口。</p>
<h2 id="3-2-grafana">3.2. Grafana</h2>
<p>访问任意一台Node机器的30080端口。</p>
<h1 id="4-容器化部署">4. 容器化部署</h1>
<h2 id="4-1-拉取镜像">4.1. 拉取镜像</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker pull influxdb:latest
</span></span><span style="display:flex;"><span>docker pull cadvisor:latest
</span></span><span style="display:flex;"><span>docker pull grafana:latest
</span></span><span style="display:flex;"><span>docker pull heapster:latest
</span></span></code></pre></div><h2 id="4-2-运行容器">4.2. 运行容器</h2>
<h2 id="4-2-1-influxdb">4.2.1. influxdb</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#influxdb</span>
</span></span><span style="display:flex;"><span>docker run -d -p 8083:8083 -p 8086:8086 --expose <span style="color:#0000cf;font-weight:bold">8090</span> --expose <span style="color:#0000cf;font-weight:bold">8099</span> --volume<span style="color:#ce5c00;font-weight:bold">=</span>/opt/data/influxdb:/data --name influxsrv influxdb:latest
</span></span></code></pre></div><h2 id="4-2-2-cadvisor">4.2.2. cadvisor</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#cadvisor</span>
</span></span><span style="display:flex;"><span>docker run --volume<span style="color:#ce5c00;font-weight:bold">=</span>/:/rootfs:ro --volume<span style="color:#ce5c00;font-weight:bold">=</span>/var/run:/var/run:rw --volume<span style="color:#ce5c00;font-weight:bold">=</span>/sys:/sys:ro --volume<span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/docker/:/var/lib/docker:ro --publish<span style="color:#ce5c00;font-weight:bold">=</span>8080:8080 --detach<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --link influxsrv:influxsrv --name<span style="color:#ce5c00;font-weight:bold">=</span>cadvisor cadvisor:latest -storage_driver<span style="color:#ce5c00;font-weight:bold">=</span>influxdb -storage_driver_db<span style="color:#ce5c00;font-weight:bold">=</span>cadvisor -storage_driver_host<span style="color:#ce5c00;font-weight:bold">=</span>influxsrv:8086
</span></span></code></pre></div><h2 id="4-2-3-grafana">4.2.3. grafana</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#grafana</span>
</span></span><span style="display:flex;"><span>docker run -d -p 3000:3000 -e <span style="color:#000">INFLUXDB_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span>influxsrv -e <span style="color:#000">INFLUXDB_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8086</span> -e <span style="color:#000">INFLUXDB_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>cadvisor -e <span style="color:#000">INFLUXDB_USER</span><span style="color:#ce5c00;font-weight:bold">=</span>root -e <span style="color:#000">INFLUXDB_PASS</span><span style="color:#ce5c00;font-weight:bold">=</span>root --link influxsrv:influxsrv --name grafana grafana:latest
</span></span></code></pre></div><h2 id="4-2-4-heapster">4.2.4. heapster</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d -p 8082:8082 --net<span style="color:#ce5c00;font-weight:bold">=</span>host heapster:canary --source<span style="color:#ce5c00;font-weight:bold">=</span>kubernetes:http://<span style="color:#4e9a06">`</span>k8s-server-ip<span style="color:#4e9a06">`</span>:8080?inClusterConfig<span style="color:#ce5c00;font-weight:bold">=</span>false/<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000">useServiceAccount</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span> --sink<span style="color:#ce5c00;font-weight:bold">=</span>influxdb:http://<span style="color:#4e9a06">`</span>influxdb-ip<span style="color:#4e9a06">`</span>:8086
</span></span></code></pre></div><h2 id="4-3-访问">4.3. 访问</h2>
<p>在浏览器输入<code>IP</code>:<code>PORT</code></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-063a156fcf744316e09eb6d743179121">3 - cAdvisor介绍</h1>
    
	<h1 id="1-cadvisor简介">1. cAdvisor简介</h1>
<p>​    cAdvisor对Node机器上的资源及容器进行实时监控和性能数据采集，包括CPU使用情况、内存使用情况、网络吞吐量及文件系统使用情况，cAdvisor集成在Kubelet中，当kubelet启动时会自动启动cAdvisor，即一个cAdvisor仅对一台Node机器进行监控。kubelet的启动参数--cadvisor-port可以定义cAdvisor对外提供服务的端口，默认为4194。可以通过浏览器&lt;Node_IP:port&gt;访问。项目主页：<a href="">http://github.com/google/cadvisor。</a></p>
<h1 id="2-cadvisor结构图">2. cAdvisor结构图</h1>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579058/article/kubernetes/monitor/cAdvisor.png" alt="cAdvisor"></p>
<h1 id="3-metrics">3. Metrics</h1>
<table>
<thead>
<tr>
<th>分类</th>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpu</td>
<td>cpu_usage_total</td>
<td></td>
</tr>
<tr>
<td></td>
<td>cpu_usage_system</td>
<td></td>
</tr>
<tr>
<td></td>
<td>cpu_usage_user</td>
<td></td>
</tr>
<tr>
<td></td>
<td>cpu_usage_per_cpu</td>
<td></td>
</tr>
<tr>
<td></td>
<td>load_average</td>
<td>Smoothed average of number of runnable threads x 1000</td>
</tr>
<tr>
<td>memory</td>
<td>memory_usage</td>
<td>Memory Usage</td>
</tr>
<tr>
<td></td>
<td>memory_working_set</td>
<td>Working set size</td>
</tr>
<tr>
<td>network</td>
<td>rx_bytes</td>
<td>Cumulative count of bytes received</td>
</tr>
<tr>
<td></td>
<td>rx_errors</td>
<td>Cumulative count of receive errors encountered</td>
</tr>
<tr>
<td></td>
<td>tx_bytes</td>
<td>Cumulative count of bytes transmitted</td>
</tr>
<tr>
<td></td>
<td>tx_errors</td>
<td>Cumulative count of transmit errors encountered</td>
</tr>
<tr>
<td>filesystem</td>
<td>fs_device</td>
<td>Filesystem device</td>
</tr>
<tr>
<td></td>
<td>fs_limit</td>
<td>Filesystem limit</td>
</tr>
<tr>
<td></td>
<td>fs_usage</td>
<td>Filesystem usage</td>
</tr>
</tbody>
</table>
<h1 id="4-cadvisor源码">4. cAdvisor源码</h1>
<h2 id="4-1-cadvisor入口函数">4.1. cAdvisor入口函数</h2>
<p><strong>cadvisor.go</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flush</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">versionFlag</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cAdvisor version %s (%s)/n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;version&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;revision&#34;</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">setMaxProcs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">memoryStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewMemoryStorage</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to initialize storage driver: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sysFs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sysfs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRealSysFs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create a system interface: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">collectorHttpClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createCollectorHttpClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">collectorCert</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">collectorKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">memoryStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sysFs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">maxHousekeepingInterval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">allowDynamicHousekeeping</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ignoreMetrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MetricSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">collectorHttpClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create a Container Manager: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mux</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServeMux</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">enableProfiling</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Index</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/cmdline&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cmdline</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/profile&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Profile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/symbol&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Symbol</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Register all HTTP handlers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cadvisorhttp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterHandlers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mux</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">httpAuthFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">httpAuthRealm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">httpDigestFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">httpDigestRealm</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to register HTTP handlers: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cadvisorhttp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPrometheusHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mux</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prometheusEndpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Start the manager.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to start container manager: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Install signal handler.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">installSignalHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting cAdvisor version: %s-%s on port %d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;version&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;revision&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argPort</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">addr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s:%d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argIp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argPort</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">memoryStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewMemoryStorage</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sysFs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sysfs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRealSysFs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">#</span><span style="color:#000">创建containerManager</span>
</span></span><span style="display:flex;"><span><span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">memoryStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sysFs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">maxHousekeepingInterval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">allowDynamicHousekeeping</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ignoreMetrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MetricSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">collectorHttpClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">#</span><span style="color:#000">启动containerManager</span>
</span></span><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h2 id="4-2-cadvisor-client的使用">4.2. cAdvisor Client的使用</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;github.com/google/cadvisor/client&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http://192.168.19.30:4194/&#34;</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic">//http://&lt;host-ip&gt;:&lt;port&gt;/
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-2-1-client定义">4.2.1 client定义</h2>
<p><strong>cadvisor/client/client.go</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Client represents the base URL for a cAdvisor client.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Client</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">baseUrl</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewClient returns a new v1.3 client with the specified base URL.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">url</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HasSuffix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">url</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#4e9a06">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">baseUrl</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%sapi/v1.3/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">url</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-2-2-client方法">4.2.2. client方法</h2>
<p><strong>1）MachineInfo</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// MachineInfo returns the JSON machine information for this client.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// A non-nil error result indicates a problem with obtaining
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the JSON machine information data.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">MachineInfo</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">minfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MachineInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">machineInfoUrl</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MachineInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">httpGetJsonData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;machine info&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">minfo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ret</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>2）ContainerInfo</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ContainerInfo returns the JSON container information for the specified
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// container and request.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfoRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cinfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerInfoUrl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">httpGetJsonData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;container info for %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">cinfo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ret</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>3）DockerContainer</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Returns the JSON container information for the specified
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Docker container and request.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">DockerContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfoRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cinfo</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dockerInfoUrl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">httpGetJsonData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Docker container info for %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;expected to only receive 1 Docker container: %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cont</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">ret</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000">cinfo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cont</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>4）AllDockerContainers</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Returns the JSON container information for all Docker containers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">AllDockerContainers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfoRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cinfo</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dockerInfoUrl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">httpGetJsonData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all Docker containers info&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">cinfo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cont</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">ret</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000">cinfo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cinfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cont</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c35df90033980941ba5c63379e5cfcbe">4 - Heapster介绍</h1>
    
	<h1 id="1-heapster简介">1. heapster简介</h1>
<p>Heapster是容器集群监控和性能分析工具，天然的支持Kubernetes和CoreOS。
Kubernetes有个出名的监控agent—cAdvisor。在每个kubernetes Node上都会运行cAdvisor，它会收集本机以及容器的监控数据(cpu,memory,filesystem,network,uptime)。</p>
<h1 id="2-heapster部署与配置">2. heapster部署与配置</h1>
<h2 id="2-1-注意事项">2.1. 注意事项</h2>
<p>需同步部署机器和被采集机器的时间：ntpdate time.windows.com</p>
<p>加入定时任务，定期同步时间</p>
<p>crontab –e</p>
<p>30 5 * * *          /usr/sbin/ntpdate time.windows.com          //每天早晨5点半执行</p>
<h2 id="2-2-容器式部署">2.2. 容器式部署</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#拉取镜像</span>
</span></span><span style="display:flex;"><span>docker pull heapster:latest
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#运行容器</span>
</span></span><span style="display:flex;"><span>docker run -d -p 8082:8082 --net<span style="color:#ce5c00;font-weight:bold">=</span>host heapster:latest --source<span style="color:#ce5c00;font-weight:bold">=</span>kubernetes:http://&lt;k8s-server-ip&gt;:8080?inClusterConfig<span style="color:#ce5c00;font-weight:bold">=</span>false<span style="color:#4e9a06">\&amp;</span><span style="color:#000">useServiceAccount</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span> --sink<span style="color:#ce5c00;font-weight:bold">=</span>influxdb:http://&lt;influxdb-ip&gt;:8086?db<span style="color:#ce5c00;font-weight:bold">=</span>&lt;k8s_env_zone&gt;
</span></span></code></pre></div><h2 id="2-3-配置说明">2.3. 配置说明</h2>
<p>可以参考<a href="https://github.com/kubernetes/heapster/tree/master/docs">官方文档</a></p>
<h2 id="2-3-1-source">2.3.1. –source</h2>
<p>–source: 指定数据获取源。这里指定kube-apiserver即可。
后缀参数：
inClusterConfig:
kubeletPort: 指定kubelet的使用端口，默认10255
kubeletHttps: 是否使用https去连接kubelets(默认：false)
apiVersion: 指定K8S的apiversion
insecure: 是否使用安全证书(默认：false)
auth: 安全认证
useServiceAccount: 是否使用K8S的安全令牌</p>
<h2 id="2-3-2-sink">2.3.2. –sink</h2>
<p>–sink: 指定后端数据存储。这里指定influxdb数据库。
后缀参数：
user: InfluxDB用户
pw: InfluxDB密码
db: 数据库名
secure: 安全连接到InfluxDB(默认：false)
withfields： 使用InfluxDB fields(默认：false)。</p>
<h1 id="3-metrics">3. Metrics</h1>
<table>
<thead>
<tr>
<th>分类</th>
<th>Metric Name</th>
<th>Description</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpu</td>
<td>cpu/limit</td>
<td>CPU hard limit in millicores.</td>
<td>CPU上限</td>
</tr>
<tr>
<td></td>
<td>cpu/node_capacity</td>
<td>Cpu capacity of a node.</td>
<td>Node节点的CPU容量</td>
</tr>
<tr>
<td></td>
<td>cpu/node_allocatable</td>
<td>Cpu allocatable of a node.</td>
<td>Node节点可分配的CPU</td>
</tr>
<tr>
<td></td>
<td>cpu/node_reservation</td>
<td>Share of cpu that is reserved on the node allocatable.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>cpu/node_utilization</td>
<td>CPU utilization as a share of node allocatable.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>cpu/request</td>
<td>CPU request (the guaranteed amount of resources) in millicores.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>cpu/usage</td>
<td>Cumulative CPU usage on all cores.</td>
<td>CPU总使用量</td>
</tr>
<tr>
<td></td>
<td>cpu/usage_rate</td>
<td>CPU usage on all cores in millicores.</td>
<td></td>
</tr>
<tr>
<td>filesystem</td>
<td>filesystem/usage</td>
<td>Total number of bytes consumed on a filesystem.</td>
<td>文件系统的使用量</td>
</tr>
<tr>
<td></td>
<td>filesystem/limit</td>
<td>The total size of filesystem in bytes.</td>
<td>文件系统的使用上限</td>
</tr>
<tr>
<td></td>
<td>filesystem/available</td>
<td>The number of available bytes remaining in a the filesystem</td>
<td>可用的文件系统容量</td>
</tr>
<tr>
<td></td>
<td>filesystem/inodes</td>
<td>The number of available inodes in a the filesystem</td>
<td></td>
</tr>
<tr>
<td></td>
<td>filesystem/inodes_free</td>
<td>The number of free inodes remaining in a the filesystem</td>
<td></td>
</tr>
<tr>
<td>memory</td>
<td>memory/limit</td>
<td>Memory hard limit in bytes.</td>
<td>内存上限</td>
</tr>
<tr>
<td></td>
<td>memory/major_page_faults</td>
<td>Number of major page faults.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/major_page_faults_rate</td>
<td>Number of major page faults per second.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/node_capacity</td>
<td>Memory capacity of a node.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/node_allocatable</td>
<td>Memory allocatable of a node.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/node_reservation</td>
<td>Share of memory that is reserved on the node allocatable.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/node_utilization</td>
<td>Memory utilization as a share of memory allocatable.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/page_faults</td>
<td>Number of page faults.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/page_faults_rate</td>
<td>Number of page faults per second.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/request</td>
<td>Memory request (the guaranteed amount of resources) in bytes.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/usage</td>
<td>Total memory usage.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/cache</td>
<td>Cache memory usage.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/rss</td>
<td>RSS memory usage.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/working_set</td>
<td>Total working set usage. Working set is the memory being used and not easily dropped by the kernel.</td>
<td></td>
</tr>
<tr>
<td>network</td>
<td>network/rx</td>
<td>Cumulative number of bytes received over the network.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/rx_errors</td>
<td>Cumulative number of errors while receiving over the network.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/rx_errors_rate</td>
<td>Number of errors while receiving over the network per second.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/rx_rate</td>
<td>Number of bytes received over the network per second.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/tx</td>
<td>Cumulative number of bytes sent over the network</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/tx_errors</td>
<td>Cumulative number of errors while sending over the network</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/tx_errors_rate</td>
<td>Number of errors while sending over the network</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/tx_rate</td>
<td>Number of bytes sent over the network per second.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>uptime</td>
<td>Number of milliseconds since the container was started.</td>
<td>-</td>
</tr>
</tbody>
</table>
<h1 id="4-labels">4. Labels</h1>
<table>
<thead>
<tr>
<th>Label Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>pod_id</td>
<td>Unique ID of a Pod</td>
</tr>
<tr>
<td>pod_name</td>
<td>User-provided name of a Pod</td>
</tr>
<tr>
<td>pod_namespace</td>
<td>The namespace of a Pod</td>
</tr>
<tr>
<td>container_base_image</td>
<td>Base image for the container</td>
</tr>
<tr>
<td>container_name</td>
<td>User-provided name of the container or full cgroup name for system containers</td>
</tr>
<tr>
<td>host_id</td>
<td>Cloud-provider specified or user specified Identifier of a node</td>
</tr>
<tr>
<td>hostname</td>
<td>Hostname where the container ran</td>
</tr>
<tr>
<td>labels</td>
<td>Comma-separated(Default) list of user-provided labels. Format is 'key:value'</td>
</tr>
<tr>
<td>namespace_id</td>
<td>UID of the namespace of a Pod</td>
</tr>
<tr>
<td>resource_id</td>
<td>A unique identifier used to differentiate multiple metrics of the same type. e.x. Fs partitions under filesystem/usage</td>
</tr>
</tbody>
</table>
<h1 id="5-heapster-api">5. heapster API</h1>
<p>见官方文档：<a href="https://github.com/kubernetes/heapster/blob/master/docs/model.md">https://github.com/kubernetes/heapster/blob/master/docs/model.md</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5a2ec7c9c0c23b6304b5fdd306263b4c">5 - Influxdb介绍</h1>
    
	<h1 id="1-influxdb简介">1. InfluxDB简介</h1>
<p>InfluxDB是一个当下比较流行的时序数据库，InfluxDB使用 Go 语言编写，无需外部依赖，安装配置非常方便，适合构建大型分布式系统的监控系统。</p>
<p>主要特色功能：</p>
<p>1）基于时间序列，支持与时间有关的相关函数（如最大，最小，求和等）</p>
<p>2）可度量性：你可以实时对大量数据进行计算</p>
<p>3）基于事件：它支持任意的事件数据</p>
<h1 id="2-influxdb安装">2. InfluxDB安装</h1>
<h2 id="1-安装">1）安装</h2>
<p>wget <a href="https://dl.influxdata.com/influxdb/releases/influxdb-0.13.0.x86_64.rpm">https://dl.influxdata.com/influxdb/releases/influxdb-0.13.0.x86_64.rpm</a></p>
<p>yum localinstall influxdb-0.13.0.armhf.rpm</p>
<h2 id="2-启动">2）启动</h2>
<p>service influxdb start</p>
<h2 id="3-访问">3）访问</h2>
<p>http://服务器IP:8083</p>
<h2 id="4-docker-image方式安装">4）docker image方式安装</h2>
<p>docker pull influxdb</p>
<p>docker run -d -p 8083:8083 -p 8086:8086 --expose 8090 --expose 8099 --volume=/opt/data/influxdb:/data --name influxsrv influxdb:latest</p>
<h1 id="3-influxdb的基本概念">3. InfluxDB的基本概念</h1>
<h2 id="3-1-与传统数据库中的名词做比较">3.1. 与传统数据库中的名词做比较</h2>
<table>
<thead>
<tr>
<th>influxDB中的名词</th>
<th>传统数据库中的概念</th>
</tr>
</thead>
<tbody>
<tr>
<td>database</td>
<td>数据库</td>
</tr>
<tr>
<td>measurement</td>
<td>数据库中的表</td>
</tr>
<tr>
<td>points</td>
<td>表里面的一行数据</td>
</tr>
</tbody>
</table>
<h2 id="3-2-influxdb中独有的概念">3.2. InfluxDB中独有的概念</h2>
<h2 id="3-2-1-point">3.2.1. Point</h2>
<p>Point由时间戳（time）、数据（field）、标签（tags）组成。</p>
<p>Point相当于传统数据库里的一行数据，如下表所示：</p>
<table>
<thead>
<tr>
<th>Point属性</th>
<th>传统数据库中的概念</th>
</tr>
</thead>
<tbody>
<tr>
<td>time</td>
<td>每个数据记录时间，是数据库中的主索引(会自动生成)</td>
</tr>
<tr>
<td>fields</td>
<td>各种记录值（没有索引的属性）也就是记录的值：温度， 湿度</td>
</tr>
<tr>
<td>tags</td>
<td>各种有索引的属性：地区，海拔</td>
</tr>
</tbody>
</table>
<h2 id="3-2-2-series">3.2.2. series</h2>
<p>所有在数据库中的数据，都需要通过图表来展示，而这个series表示这个表里面的数据，可以在图表上画成几条线：通过tags排列组合算出来</p>
<p>show series from cpu</p>
<h1 id="4-influxdb的基本操作">4. InfluxDB的基本操作</h1>
<p>InfluxDB提供三种操作方式：</p>
<p>1）客户端命令行方式</p>
<p>2）HTTP API接口</p>
<p>3）各语言API库</p>
<h2 id="4-1-influxdb数据库操作">4.1. InfluxDB数据库操作</h2>
<table>
<thead>
<tr>
<th>操作</th>
<th>命令</th>
</tr>
</thead>
<tbody>
<tr>
<td>显示数据库</td>
<td>show databases</td>
</tr>
<tr>
<td>创建数据库</td>
<td>create database <code>db_name</code></td>
</tr>
<tr>
<td>删除数据库</td>
<td>drop database <code>db_name</code></td>
</tr>
<tr>
<td>使用某个数据库</td>
<td>use <code>db_name</code></td>
</tr>
</tbody>
</table>
<h2 id="4-2-influxdb数据表操作">4.2. InfluxDB数据表操作</h2>
<table>
<thead>
<tr>
<th>操作</th>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>显示所有表</td>
<td>SHOW MEASUREMENTS</td>
<td></td>
</tr>
<tr>
<td>创建数据表</td>
<td>insert <code>table_name</code>,hostname=server01 value=442221834240i 1435362189575692182</td>
<td>其中 disk_free 就是表名，hostname是索引，value=xx是记录值，记录值可以有多个，最后是指定的时间</td>
</tr>
<tr>
<td>删除数据表</td>
<td>drop measurement <code>table_name</code></td>
<td></td>
</tr>
<tr>
<td>查看表内容</td>
<td>select * from <code>table_name</code></td>
<td></td>
</tr>
<tr>
<td>查看series</td>
<td>show series from <code>table_name</code></td>
<td>series表示这个表里面的数据，可以在图表上画成几条线，series主要通过tags排列组合算出来</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-92606946619161c3d94670cf180b1a17">6 - Grafana部署</h1>
    
	<h1 id="docker部署">Docker部署</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d -p 3000:3000 grafana/grafana:latest
</span></span></code></pre></div><h1 id="k8s部署">K8S部署</h1>
<p>helm部署</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add grafana https://grafana.github.io/helm-charts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helm search repo grafana
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://grafana.com/docs/grafana/latest/setup-grafana/installation/">Install Grafana | Grafana documentation</a></p>
</li>
<li>
<p><a href="https://grafana.com/docs/grafana/latest/setup-grafana/installation/kubernetes/">Deploy Grafana on Kubernetes | Grafana documentation</a></p>
</li>
<li>
<p><a href="https://github.com/grafana/helm-charts">GitHub - grafana/helm-charts</a></p>
</li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2025 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
