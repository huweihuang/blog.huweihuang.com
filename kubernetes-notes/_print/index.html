<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/kubernetes-notes/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/kubernetes-notes/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Kubernetes学习笔记 | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="Kubernetes学习笔记" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/kubernetes-notes/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="Kubernetes学习笔记">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes学习笔记"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/kubernetes-notes/" ><span class="active">Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/k8s-source-code-analysis/" ><span>Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/linux-notes/" ><span>Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.80f7be66b8edc629c786d20dc8ccd095.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/kubernetes-notes/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">Kubernetes学习笔记</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-3d690eea3c8305f91e77f46a9747e3f1">云原生体系</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-037e9ec9d1a34af844272292d23386a8">k8s知识体系</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-43670d4eda8b41a1481da3d83878ebb3">12 Factor</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-30329299a44716819522c0e1ceb75650">安装与配置</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-a41f0ac4c2bce9bc82f0f882ec3ece1e">部署k8s集群</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1.1: <a href="#pg-463cd148d535d90f13fd41ca8c743267">使用kubeadm部署生产环境kubernetes集群</a></li>


    
  
    
    
	
<li>2.1.2: <a href="#pg-46874a0d5c85725f7a95eacfdeaee161">使用kubespray安装kubernetes</a></li>


    
  
    
    
	
<li>2.1.3: <a href="#pg-1e3c685682ed41951a80a02b1a236fcc">使用minikube安装kubernetes</a></li>


    
  
    
    
	
<li>2.1.4: <a href="#pg-06181b6bb8970c2b2814c3aed2e7944d">使用kind安装kubernetes</a></li>


    
  
    
    
	
<li>2.1.5: <a href="#pg-eee653beaa5313391bca6e7f1ffaf477">安装k8s dashboard</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2.2: <a href="#pg-090c38942225ddadebc0c1de1ff9b279">kubeadm升级k8s集群</a></li>


    
  
    
    
	
<li>2.3: <a href="#pg-8b5896446b13b6b1c7a2979417ce8141">k8s证书及秘钥</a></li>


    
  
    
    
	
<li>2.4: <a href="#pg-ac77b6330ad5ce632acdc4c0ae8b80df">kubeadm管理证书</a></li>


    
  
    
    
	
<li>2.5: <a href="#pg-cd5e466e5a3dfa8653fdc2627ae724ed">k8s版本说明</a></li>


    
  
    
    
	
<li>2.6: <a href="#pg-b9af691092b47cf424aad2224adad987">k8s版本记录</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-9568044c7a7292363ca18ec04ca309a4">基本概念</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-de32fae571e364e320e9c4fbf60e7384">kubernetes架构</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1.1: <a href="#pg-b545a2ca17b93b0d5b41f439c5c49f76">Kubernetes总架构图</a></li>


    
  
    
    
	
<li>3.1.2: <a href="#pg-765e34ca75800e04fc456ceb521a5c40"> 基于Docker及Kubernetes技术构建容器云（PaaS）平台</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3.2: <a href="#pg-9de22f41eb289fe9a19743bc4cc793ff">kubernetes对象</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.2.1: <a href="#pg-466c1b420cb16e44f962be13caafa2ec">Kubernetes基本概念</a></li>


    
  
    
    
	
<li>3.2.2: <a href="#pg-96fe330e8ab07dd38ff1d1c60fbc950f">理解kubernetes对象</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3.3: <a href="#pg-8c4dce12f691e4d3b4ce5485de3575e0">Pod对象</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.3.1: <a href="#pg-ad3d37233d0ef73ff0433086563ab781">Pod介绍</a></li>


    
  
    
    
	
<li>3.3.2: <a href="#pg-dfe3dc8e698614b183a38620c6373d26">Pod定义文件</a></li>


    
  
    
    
	
<li>3.3.3: <a href="#pg-2ce568b236047ef5eb3a0c713a4ef70d">Pod生命周期</a></li>


    
  
    
    
	
<li>3.3.4: <a href="#pg-f8cc746df04add11975d611fdc6db65f">Pod健康检查</a></li>


    
  
    
    
	
<li>3.3.5: <a href="#pg-e9050fa070dd1f1567bd49d2d8fb0629">Pod存储卷</a></li>


    
  
    
    
	
<li>3.3.6: <a href="#pg-61971721a88dac7a1e8a7796dc21b6d3">Pod调度</a></li>


    
  
    
    
	
<li>3.3.7: <a href="#pg-e8afcbe09f3cadc6988fab9470d287a9">Pod伸缩与升级</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3.4: <a href="#pg-0d04a1bda6875a57535ee9e5c3a27a52">配置</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.4.1: <a href="#pg-8e56be8a3b34365d46ef8a4fcb36166e">ConfigMap</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-a1fb9fa332b58bfec12b112c1675a9dd">核心原理</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-85131cb1d1fb89a36d60974812fecf91">核心组件</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1.1: <a href="#pg-f4746143a48e6f2b14964ad1a0450bb8">Kubernetes核心原理（一）之API Server</a></li>


    
  
    
    
	
<li>4.1.2: <a href="#pg-c35d2525fdbbca71b0b7b9a0ae97c5be">Kubernetes核心原理（二）之Controller Manager</a></li>


    
  
    
    
	
<li>4.1.3: <a href="#pg-67eda864e92e5d867c04aa5fa67daa80">Kubernetes核心原理（三）之Scheduler</a></li>


    
  
    
    
	
<li>4.1.4: <a href="#pg-92b084b3a33d2d7ac8c805d194373c41">Kubernetes核心原理（四）之kubelet</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4.2: <a href="#pg-ce4750ad230938f535c1a8c7dd249b84">流程图</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.2.1: <a href="#pg-0a2151d9e7e2405e81ad7ee678a8d04f">Pod创建流程</a></li>


    
  
    
    
	
<li>4.2.2: <a href="#pg-1ad6828622f1c7fea352dccf193d0db2">PVC创建流程</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-0b25fffd51613bdef564a5a70491d831">容器网络</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-74c4bd794700f9208344a668233bf9d0">Docker网络</a></li>


    
  
    
    
	
<li>5.2: <a href="#pg-522f5907d7543b0318052a0b43976cfc">K8S网络</a></li>


    
  
    
    
	
<li>5.3: <a href="#pg-435753e3e1914db8cc781fc833cde51c">Pod的DNS策略</a></li>


    
  
    
    
	
<li>5.4: <a href="#pg-7939a3d9fca50e5749edc0a71a21c9c5">CNI</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.4.1: <a href="#pg-2615520272860bbbdde444e096c7575e">CNI接口介绍</a></li>


    
  
    
    
	
<li>5.4.2: <a href="#pg-129b1f198fb56635dc5baed9387d2ce4">CNI插件选型</a></li>


    
  
    
    
	
<li>5.4.3: <a href="#pg-480ce0e572d2437e06aed1bd69e4be63">Macvlan介绍</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5.5: <a href="#pg-88a4539d1d63c4a8a931f76e2fb0b364">Flannel</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.5.1: <a href="#pg-eb3c09512e1faea3fd031b7ff83f4b4c">Flannel介绍</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5.6: <a href="#pg-caea0fdc09153c5bf2a00683735e5c5c">Calico</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.6.1: <a href="#pg-b7d5f8098709f945fc638e3c2853de6b">Calico介绍</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5.7: <a href="#pg-af84a8f11d81303df4a59c14ff718766">Cilium</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.7.1: <a href="#pg-b3be6cf6bdb3650e526c70a6622dce49">Cilium介绍</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5.8: <a href="#pg-e1622b1588cb7127df05e7691bb911bd">k8s网关</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.8.1: <a href="#pg-181eada22ecde3bdfce4c31dff04e635">安装APISIX</a></li>


    
  
    
    
	
<li>5.8.2: <a href="#pg-152c1f49b08d537c43d684c68bdb1e9b">创建路由</a></li>


    
  
    
    
	
<li>5.8.3: <a href="#pg-dcc4be6cc2df9826bdbfe0119d889b8f">ingress-controller原理</a></li>


    
  
    
    
	
<li>5.8.4: <a href="#pg-b54bad948da2580c7317a90981df893e">APISIX配置</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-68204f31aa6371f04c5528350bbd9dbc">容器存储</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-acce2f199395a38fa545d621e87d4fcc">存储卷概念</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1.1: <a href="#pg-69916651c080b1448214bcc3834b3bed">Volume介绍</a></li>


    
  
    
    
	
<li>6.1.2: <a href="#pg-b639cd59796d543959dd36a9a8d277cf">PersistentVolume 介绍</a></li>


    
  
    
    
	
<li>6.1.3: <a href="#pg-2c8f8b6ee717f78cb80b00011c9c2e2f">PersistentVolumeClaim 介绍</a></li>


    
  
    
    
	
<li>6.1.4: <a href="#pg-d1cc6e58a4338c8077a47f605ca6d5b7">StorageClass 介绍</a></li>


    
  
    
    
	
<li>6.1.5: <a href="#pg-04b9e34f8799e1a90314832d503a015e">Dynamic Volume Provisioning 介绍</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6.2: <a href="#pg-7d4ddc2dc93bb706e954d8380bb26646">CSI</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.2.1: <a href="#pg-bbd68015d5f325aa1d6f47d4c27eb87f">csi-cephfs-plugin</a></li>


    
  
    
    
	
<li>6.2.2: <a href="#pg-78953da03ebebfc47dbb2dd88764145e">部署csi-cephfs</a></li>


    
  
    
    
	
<li>6.2.3: <a href="#pg-a76dfd266c67a36d479c10fe7a33d631">部署cephfs-provisioner</a></li>


    
  
    
    
	
<li>6.2.4: <a href="#pg-fe767b97f892ebc9ba161de84c2bea4b">FlexVolume介绍</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-ee74de49b2ff835b2179a03c732c20ef">资源隔离</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-90a635123dea70113f6dcf68fb2e7363">资源配额</a></li>


    
  
    
    
	
<li>7.2: <a href="#pg-796d3b5bc860b32a099f00baf9e008f2">资源配额</a></li>


    
  
    
    
	
<li>7.3: <a href="#pg-2c52aafd2af1a9cb401a3aa6ee690663">资源服务质量</a></li>


    
  
    
    
	
<li>7.4: <a href="#pg-fd3c3a410347b1bb7067ca48715d2dbe">Lxcfs资源视图隔离</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-0a93c2b2a683132635d874129a40fc3f">运维指南</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.1: <a href="#pg-0a7fd438eac53912c7bdc3b6f6fcbc2a">Kubernetes集群问题排查</a></li>


    
  
    
    
	
<li>8.2: <a href="#pg-4636def6f640761d9a6d52a310eec2ce">kubectl工具</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.2.1: <a href="#pg-22f0195f73c944ee47a2e9c5921b05e9">kubectl安装与配置</a></li>


    
  
    
    
	
<li>8.2.2: <a href="#pg-580791bea464f97f9c44ba2cd0c9e6ec">kubectl命令使用</a></li>


    
  
    
    
	
<li>8.2.3: <a href="#pg-b6a39ccb3e2087cb00af1a7e430cac22">kubectl命令别名</a></li>


    
  
    
    
	
<li>8.2.4: <a href="#pg-32ca647b0526bb2667f33718069312c1">kubectl进入node shell</a></li>


    
  
    
    
	
<li>8.2.5: <a href="#pg-ada877dc6e2d7b482edcb6caffb98648">kubeconfig的使用</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8.3: <a href="#pg-6e74d886e5b15f816335ffec854ee6d3">节点迁移</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.3.1: <a href="#pg-ebf0ed02e505f9821b61779a584ab361">指定节点调度与隔离</a></li>


    
  
    
    
	
<li>8.3.2: <a href="#pg-35b75b0abb0e69e39b5c84c9866abbdb">安全迁移节点</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8.4: <a href="#pg-8a02de6992a0ee51b948d425469c1b12">镜像仓库</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.4.1: <a href="#pg-d91c32303bf218d01b7b2bf7e997cbf2">配置私有镜像仓库</a></li>


    
  
    
    
	
<li>8.4.2: <a href="#pg-55fc99faaf344a60b08326a55b017398">拉取私有镜像</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8.5: <a href="#pg-938bc65964a09b965ab8e21d08b4607f">版本发布</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.5.1: <a href="#pg-95b06c53cc40973b00b544beeff601fb">金丝雀发布</a></li>


    
  
    
    
	
<li>8.5.2: <a href="#pg-ddbe76ac51f4a462cea597dd4e0c1726">Kruise Rollout发布</a></li>


    
  
    
    
	
<li>8.5.3: <a href="#pg-41c516f97d3e1fa8b834aa015c334c1e">HPA[自动扩缩容]配置</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8.6: <a href="#pg-55df644ab8d0bc55eb3a49b48ef9de4b">helm工具</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.6.1: <a href="#pg-5f1a6eca050380d9ae4ce6be33a6e1a5">helm的使用</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8.7: <a href="#pg-3047f06db94255d847014b8b4927fc13">访问控制</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.7.1: <a href="#pg-9f77a82cda922f86b06a443f2d02911d">使用 RBAC 鉴权</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>9: <a href="#pg-37ac2d29c744460e3073c9d6dabb1f4d">开发指南</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>9.1: <a href="#pg-73557ed651edbfdf7203caf9eea45f16">client-go的使用及源码分析</a></li>


    
  
    
    
	
<li>9.2: <a href="#pg-75c48100cb89c80d973b7c57a96377f6">operator开发</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>9.2.1: <a href="#pg-15fa0d56cfe1e152b7d82dfc0c656c29">kubebuilder的使用</a></li>


    
  
    
    
	
<li>9.2.2: <a href="#pg-e0f9d77a375a891566ac10e26e32ae95">如何开发一个Operator</a></li>


    
  

    </ul>
    
  
    
    
	
<li>9.3: <a href="#pg-c891529cb3c8cef200ec4a9ae6cf4cb7">CSI插件开发</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>9.3.1: <a href="#pg-3b99a3043c0685804c1f4dcda6d8a2d1">csi-provisioner源码分析</a></li>


    
  
    
    
	
<li>9.3.2: <a href="#pg-8e67c5a44cf8290f780929adc85773bf">nfs-client-provisioner源码分析</a></li>


    
  

    </ul>
    
  
    
    
	
<li>9.4: <a href="#pg-7b4726c5697dc81fca76b5397c272027">k8s社区开发指南</a></li>


    
  

    </ul>
    
  
    
    
	
<li>10: <a href="#pg-e5b0b10d7e44efa0120c5bdefe84fea4">问题排查</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1: <a href="#pg-5e242ea47c9c787791d59cd163945da5">节点问题</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1.1: <a href="#pg-9266a42ddd092ba43bf3d72f0dce8cad">keycreate permission denied</a></li>


    
  
    
    
	
<li>10.1.2: <a href="#pg-97ba76b50b571d95b673a250d703d2c2">Cgroup不支持pid资源</a></li>


    
  
    
    
	
<li>10.1.3: <a href="#pg-53caa084b28bad6e76e4c0659db83524">Cgroup子系统无法挂载</a></li>


    
  
    
    
	
<li>10.1.4: <a href="#pg-be6ea3f2a598a7462ad23ef96ba1c6c7">runc-v1.1.3-exec-failed</a></li>


    
  
    
    
	
<li>10.1.5: <a href="#pg-a78e18cade1826f4b4c0178fa69df716">increase the mlock limit</a></li>


    
  

    </ul>
    
  
    
    
	
<li>10.2: <a href="#pg-6e5d6353511fecf4ee5dd3d2d1c2d36a">Pod驱逐</a></li>


    
  
    
    
	
<li>10.3: <a href="#pg-4a6e864a3e311d3029ea0182a946f368">镜像拉取失败问题</a></li>


    
  
    
    
	
<li>10.4: <a href="#pg-f2cc121604cda28beccb98599cfa50cc">PVC Terminating</a></li>


    
  
    
    
	
<li>10.5: <a href="#pg-1fc63b5dc9513028d22327de8b197dcf">ConfigMap多行格式</a></li>


    
  

    </ul>
    
  
    
    
	
<li>11: <a href="#pg-cc290a6b08c06fd53ff80f9edd1faff8">Runtime</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>11.1: <a href="#pg-4542a7279531f26869f9880a7bd736f1">Runc和Containerd概述</a></li>


    
  
    
    
	
<li>11.2: <a href="#pg-939a4f85ffb9827c83d36ce3b932727c">Containerd</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>11.2.1: <a href="#pg-327a4852c169f4c39279a96c5f8eb746">安装Containerd</a></li>


    
  
    
    
	
<li>11.2.2: <a href="#pg-ddb2c99e7e7e60a18822203aab640d61">Containerd命令工具</a></li>


    
  
    
    
	
<li>11.2.3: <a href="#pg-c8cd64aecf7162ea570173434ed6088e">移除Dockershim</a></li>


    
  

    </ul>
    
  
    
    
	
<li>11.3: <a href="#pg-7a1cc3e84a51fcefd1499d526a0d38c1">Docker</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>11.3.1: <a href="#pg-34bb4ac2d1c394f76c16574dd5d3a1ba">Docker学习笔记</a></li>


    
  
    
    
	
<li>11.3.2: <a href="#pg-dd85cfdb2acadbca2d8720874a926b22">安装Docker</a></li>


    
  
    
    
	
<li>11.3.3: <a href="#pg-9a9f44020c9279f0a6805428f476a86d">Docker整体架构图</a></li>


    
  
    
    
	
<li>11.3.4: <a href="#pg-91b754723c0e10706ccf129e1b4dde7f">Docker常用命令原理图</a></li>


    
  
    
    
	
<li>11.3.5: <a href="#pg-890423223e32d1c3cfd58de38eb8a618">Dockerfile使用说明</a></li>


    
  

    </ul>
    
  
    
    
	
<li>11.4: <a href="#pg-1f7c30a0df89f622b955131c82bdde89">Kata Container</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>11.4.1: <a href="#pg-f6d0e42132cf59c4455d3bc527f08915">Kata容器简介</a></li>


    
  
    
    
	
<li>11.4.2: <a href="#pg-d53643562cec15a3be0d3899bd08c3cf">kata配置</a></li>


    
  

    </ul>
    
  
    
    
	
<li>11.5: <a href="#pg-cba4865f0c62d8a96a9e6684f7ae0c1b">GPU</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>11.5.1: <a href="#pg-12ead326c82e6173f626603c3a12ae76">nvidia-device-plugin介绍</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>12: <a href="#pg-0b0df9b2a3c93389c481d84c8562db2e">Etcd集群</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.1: <a href="#pg-790c9f020791536f12a8f4f2e60bb914">Etcd介绍</a></li>


    
  
    
    
	
<li>12.2: <a href="#pg-2153ad1a70a2192ad6ff5dcb8c29bd49">部署Etcd集群</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.2.1: <a href="#pg-31e195c42dfd9340fbf23dfba270e363">使用etcdadm部署Etcd集群</a></li>


    
  

    </ul>
    
  
    
    
	
<li>12.3: <a href="#pg-8bd6848988eb003ae620bdb956eab247">Raft算法</a></li>


    
  
    
    
	
<li>12.4: <a href="#pg-f59fc1654fa973038724952697876837">etcdctl命令工具</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.4.1: <a href="#pg-1b0fb3194b02b6bcfc867e444706d68a">etcdctl-V3</a></li>


    
  
    
    
	
<li>12.4.2: <a href="#pg-5ffa00ab05d9d30dfcd302587e50d29c">etcdctl-V2</a></li>


    
  

    </ul>
    
  
    
    
	
<li>12.5: <a href="#pg-d37dcd0642e22e58b477424b99aae67a">Etcd访问控制</a></li>


    
  
    
    
	
<li>12.6: <a href="#pg-b579ae1cd3d66837e46a7cfa1d995677">Etcd启动配置参数</a></li>


    
  
    
    
	
<li>12.7: <a href="#pg-f0607d0d7eaa382cf2171ad2fb4c6485">Etcd中的k8s数据</a></li>


    
  
    
    
	
<li>12.8: <a href="#pg-71893bf7906a4195ee237a3f2ab53af1">etcd-operator的使用</a></li>


    
  

    </ul>
    
  
    
    
	
<li>13: <a href="#pg-1d30deba06eddecda47c5dae6b467635">多集群管理</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>13.1: <a href="#pg-0fae2b50f9bdb013eab3a200dc8b2e9a">k8s多集群管理的思考</a></li>


    
  
    
    
	
<li>13.2: <a href="#pg-0bfa29d1cbb95cee9ae2c6409c50d04d">Virtual Kubelet</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>13.2.1: <a href="#pg-ce149f4dfb2997092b6b388ae5dda17e">Virtual Kubelet介绍</a></li>


    
  
    
    
	
<li>13.2.2: <a href="#pg-67292fc70226b6bdc2365d752a4e8eb3">Virtual Kubelet命令</a></li>


    
  

    </ul>
    
  
    
    
	
<li>13.3: <a href="#pg-cc8a5dcb3a7129ec93a2c678792dbc72">Karmada</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>13.3.1: <a href="#pg-9ef0c83954fd29dd94465f383242df3d">Karmada介绍</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>14: <a href="#pg-c4977ab2e03e75819e765edea4579afa">边缘容器</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>14.1: <a href="#pg-0968bbb4adc6aa435ad759c90307bb98">KubeEdge</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>14.1.1: <a href="#pg-996e093c65c41f7360acc920c5f48e28">KubeEdge介绍</a></li>


    
  
    
    
	
<li>14.1.2: <a href="#pg-b753fdb4b0d5561c106c3c07d2715d9e">KubeEdge源码分析</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>14.1.2.1: <a href="#pg-aca9a0997212b2f4813435f23c188a3d">Kubeedge之cloudcore 源码分析</a></li>


    
  
    
    
	
<li>14.1.2.2: <a href="#pg-46c48a2a09bc26250f3bd1939c76797f">Kubeedge之edgecore 源码分析</a></li>


    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>14.2: <a href="#pg-4e40ff60e81cf41810e8f710325c3732">OpenYurt</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>14.2.1: <a href="#pg-168a4f39638381fbf3c73746ce7bf5de">OpenYurt部署</a></li>


    
  
    
    
	
<li>14.2.2: <a href="#pg-7f94c71d7e452edb45aebaf5597df77f">OpenYurt 安装相关Kubernetes配置调整</a></li>


    
  
    
    
	
<li>14.2.3: <a href="#pg-6d600212dc5f4e80d93baefe76275030">OpenYurt源码分析</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>14.2.3.1: <a href="#pg-44aac785c423d0dcd0ca0cfde0575633">OpenYurt之YurtHub源码分析</a></li>


    
  
    
    
	
<li>14.2.3.2: <a href="#pg-1069f62a63aea9ada9ee4b47caf8d66a">OpenYurt之TunnelServer源码分析</a></li>


    
  
    
    
	
<li>14.2.3.3: <a href="#pg-3b9e3758058f48d61627e36fd3599ee0">OpenYurt之Tunnel-Agent源码分析</a></li>


    
  

    </ul>
    
  

    </ul>
    
  

    </ul>
    
  
    
    
	
<li>15: <a href="#pg-c210a0cb3a647f8bd4de63d3a48b034f">虚拟化</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>15.1: <a href="#pg-2cbec24cf3dfd6c5ed1aa52ae9544fe0">虚拟化相关概念</a></li>


    
  
    
    
	
<li>15.2: <a href="#pg-a2a32a829cbd887bf197ef0680184dee">KubeVirt</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>15.2.1: <a href="#pg-2a8b79a417dc27c130946b2e968a1afe">KubeVirt的介绍</a></li>


    
  
    
    
	
<li>15.2.2: <a href="#pg-cd3e11634344ad9f892ec11fda6e4058">KubeVirt的使用</a></li>


    
  

    </ul>
    
  
    
    
	
<li>15.3: <a href="#pg-73293b67b2766ce22d69ea8c7756120a">qemu创建虚拟机</a></li>


    
  

    </ul>
    
  
    
    
	
<li>16: <a href="#pg-a6b67c3e1104112907046f1806bd86e3">监控体系</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>16.1: <a href="#pg-0246871f1f5b13bc1876ca30494b9e94">kube-prometheus-stack的使用</a></li>


    
  
    
    
	
<li>16.2: <a href="#pg-ba6ff3e130589d9a22b217a89ee69d71">Kubernetes集群监控</a></li>


    
  
    
    
	
<li>16.3: <a href="#pg-063a156fcf744316e09eb6d743179121">cAdvisor介绍</a></li>


    
  
    
    
	
<li>16.4: <a href="#pg-c35df90033980941ba5c63379e5cfcbe">Heapster介绍</a></li>


    
  
    
    
	
<li>16.5: <a href="#pg-5a2ec7c9c0c23b6304b5fdd306263b4c">Influxdb介绍</a></li>


    
  
    
    
	
<li>16.6: <a href="#pg-92606946619161c3d94670cf180b1a17">Grafana部署</a></li>


    
  

    </ul>
    
  
    
    
	
<li>17: <a href="#pg-7b4b96a3a83b45c497c96ca31639e4fe">Serverless</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>17.1: <a href="#pg-e44de3d390def178636536ce707a8319">knative介绍</a></li>


    
  

    </ul>
    
  
    
    
	
<li>18: <a href="#pg-0b0757037fa2d97bf46505f9dd60576d"></a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-3d690eea3c8305f91e77f46a9747e3f1">1 - 云原生体系</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-037e9ec9d1a34af844272292d23386a8">1.1 - k8s知识体系</h1>
    
	<h1 id="1-k8s知识体系">1. k8s知识体系</h1>
<p>以下整理了k8s涉及的相关知识体系。</p>
<p><img src="http://assets.processon.com/chart_image/5d7f7cafe4b08987f55cbee3.png" alt="k8s体系"></p>
<p>思维导图：https://www.processon.com/view/link/5d7f7d08e4b03461a3a937e2</p>
<h1 id="2-k8s重点开源项目">2. k8s重点开源项目</h1>
<blockquote>
<p>TODO</p>
</blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-43670d4eda8b41a1481da3d83878ebb3">1.2 - 12 Factor</h1>
    
	<blockquote>
<p>以下主要介绍<code>PaaS</code>平台设计架构中使用到的方法论，统称为<code>12-Factor(要素)</code></p>
</blockquote>
<h1 id="简介">简介</h1>
<p>软件通常会作为一种服务来交付，即软件即服务(SaaS)。<code>12-Factor</code>原则为构建SaaS应用提供了以下的<code>方法论</code>：</p>
<ul>
<li>使用标准化流程自动配置，减少开发者的学习成本。</li>
<li>和操作系统解耦，使其可以在各个系统间提供最大的移植性。</li>
<li>适合部署在现代的云计算平台上，从而在服务器和系统管理方面节省资源。</li>
<li>将开发环境与生产环境的差异降至最低，并使用持续交付实施敏捷开发。</li>
<li>可以在工具、架构和开发流程不发生明显变化的前提下实现拓展</li>
</ul>
<p>该理论适应于任何语言和后端服务(数据库、消息队列、缓存等)开发的应用程序。</p>
<h1 id="1-基准代码">1. 基准代码</h1>
<blockquote>
<p>一份基准代码，多份部署</p>
</blockquote>
<p>应用代码使用<code>版本控制系统</code>来管理，常用的有<code>Git</code>、<code>SVN</code>等。一份用来跟踪代码所有修订版本的数据库称为<code>代码库</code>。</p>
<h2 id="1-1-一份基准代码">1.1. 一份基准代码</h2>
<p>基准代码和应用之间总是保持一一对应的关系：</p>
<ul>
<li>一旦有多个基准代码，则不能称之为一个应用，而是一个分布式系统。分布式系统中的每个组件都是一个应用，每个应用都可以使用<code>12-Factor</code>原则进行开发。</li>
<li>多个应用共享一份基准代码有悖于<code>12-Factor</code>原则。解决方法是将共享的代码拆成独立的类库，通过依赖管理去使用它们。</li>
</ul>
<h2 id="1-2-多份部署">1.2. 多份部署</h2>
<p>每个应用只对应一份基准代码，但可以同时存在多份的部署，每份部署相当于运行了一个应用的实例。</p>
<p>多份部署的区别在于：</p>
<ul>
<li>可以存在不同的配置文件对应不同的环境。例如开发环境、预发布环境、生产环境等。</li>
<li>可以使用不同的版本。例如开发环境的版本可能高于预发布环境版本，还没同步到预发布环境版本，同理，预发布环境版本可能高于生产环境版本。</li>
</ul>
<h1 id="2-依赖">2. 依赖</h1>
<blockquote>
<p>显式声明依赖关系</p>
</blockquote>
<p>大多数的编程语言都会提供一个<code>包管理系统</code>或工具，其中包含所有的<code>依赖库</code>，例如Golang的vendor目录存放了该应用的所有依赖包。</p>
<p>12-Factor原则下的应用会通过<code>依赖清单</code>来显式确切地声明所有的依赖项。在运行工程中通过<code>依赖隔离工具</code>来保证应用不会去调用系统中存在但依赖清单中未声明的依赖项。</p>
<p>显式声明依赖项的优点在于可以简化环境配置流程，开发者关注应用的基准代码，而依赖库则由依赖库管理工具来管理和配置。例如，Golang中的包管理工具dep等。</p>
<h1 id="3-配置">3. 配置</h1>
<blockquote>
<p>在环境中存储配置</p>
</blockquote>
<p>通常，应用的配置在不同的发布环境中(例如：开发、预发布、生产环境)会有很大的差异，其中包括：</p>
<ul>
<li>数据库、Redis等后端服务的配置</li>
<li>每份部署特有的配置，例如域名</li>
<li>第三方服务的证书等</li>
</ul>
<p>12-Factor原则要求代码和配置严格分离，而不应该通过代码常量的形式写在代理里面。配置在不同的部署环境中存在大幅差异，但是代码却是完全一致的。</p>
<p>判断一个应用是否正确地将配置排除在代码外，可以看应用的基准代码是否可以立即开源而不担心暴露敏感信息。</p>
<p>12-Factor原则建议将应用的配置存储在环境变量中，环境变量可以方便在不同的部署环境中修改，而不侵入原有的代码。(例如，k8s的大部分代码配置是通过环境变量的方式来传入的)。</p>
<p>12-Factor应用中，环境变量的粒度要足够小且相对独立。当应用需要拓展时，可以平滑过渡。</p>
<h1 id="4-后端服务">4. 后端服务</h1>
<blockquote>
<p>把后端服务当作附加资源</p>
</blockquote>
<p>后端服务指程序运行时所需要通过网络调用的各种服务，例如：数据库（<a href="http://dev.mysql.com/">MySQL</a>，<a href="http://couchdb.apache.org/">CouchDB</a>），消息/队列系统（<a href="http://www.rabbitmq.com/">RabbitMQ</a>，<a href="https://beanstalkd.github.io/">Beanstalkd</a>），SMTP 邮件发送服务（<a href="http://www.postfix.org/">Postfix</a>），以及缓存系统（<a href="http://memcached.org/">Memcached</a>）。</p>
<p>其中可以根据管理对象分为<code>本地服务</code>(例如本地数据库)和<code>第三方服务</code>(例如Amason S3)。对于12-Factor应用来说都是附加资源，没有区别对待，当其中一份后端服务失效后，可以通过切换到原先备份的后端服务中，而不需要修改代码(但可能需要修改配置)。12-Factor应用与后端服务保持松耦合的关系。</p>
<h1 id="5-构建-发布-运行">5. 构建，发布，运行</h1>
<blockquote>
<p>严格分离构建和运行</p>
</blockquote>
<p>基准代码转化成一份部署需要经过三个阶段：</p>
<ul>
<li>构建阶段：指代码转化为可执行包的过程。构建过程会使用指定版本的代码，获取依赖项，编译生成二进制文件和资源文件。</li>
<li>发布阶段：将构建的结果与当前部署所需的配置结合，并可以在运行环境中使用。</li>
<li>运行阶段（运行时）：指针对指定的发布版本在执行环境中启动一系列应用程序的进程。</li>
</ul>
<p>12-Factor应用严格区分构建、发布、运行三个步骤，每一个发布版本对应一个唯一的发布ID，可以使用时间戳或递增的版本序列号。</p>
<p>如果需要修改则需要产生一个新的发布版本，如果需要回退，则回退到之前指定的发布版本。</p>
<p>新代码部署之前，由开发人员触发构建操作，构建阶段可以相对复杂一些，方便错误信息可以展示出来得到妥善处理。运行阶段可以人为触发或自动运行，运行阶段应该保持尽可能少的模块。</p>
<h1 id="6-进程">6. 进程</h1>
<blockquote>
<p>以一个或多个无状态进程运行应用</p>
</blockquote>
<p>12-Factor应有的进程必须是无状态且无共享的，任何需要持久化的数据存储在后端服务中，例如数据库。</p>
<p>内存区域和磁盘空间可以作为进程的缓存，12-Factor应用不需要关注这些缓存的持久化，而是允许其丢失，例如重启的时候。</p>
<p>进程的二进制文件应该在构建阶段执行编译而不是运行阶段。</p>
<p>当应用使用到<code>粘性Session</code>，即将用户的session数据缓存到进程的内存中，将同一用户的后续请求路由到同一个进程。12-Factor应用反对这种处理方式，而是建议将session的数据保存在redis/memcached带有过期时间的缓存中。</p>
<h1 id="7-端口绑定">7. 端口绑定</h1>
<blockquote>
<p>通过端口绑定提供服务</p>
</blockquote>
<p>应用通过端口绑定来提供服务，并监听发送至该端口的请求。端口绑定的方式意味着一个应用也可以成为另一个应用的后端服务，例如提供某些API请求。</p>
<h1 id="8-并发">8. 并发</h1>
<blockquote>
<p>通过进程模型进行扩展</p>
</blockquote>
<p>12-Factor应用中，开发人员可以将不同的工作分配给不同类型进程，例如HTTP请求由web进程来处理，常驻的后台工作由worker进程来处理（k8s的设计中就经常用不同类型的manager来处理不同的任务）。</p>
<p>12-Factor应用的进程具备无共享、水平分区的特性，使得水平扩展较为容易。</p>
<p>12-Factor应用的进程不需要守护进程或是写入PID文件，而是通过进程管理器（例如 systemd）来管理输出流，响应崩溃的进程，以及处理用户触发的重启或关闭超级进程的操作。</p>
<h1 id="9-易处理">9. 易处理</h1>
<blockquote>
<p>快速启动和优雅终止可最大化健壮性</p>
</blockquote>
<p>12-Factor应用的进程是<code>易处理</code>的，即它们可以快速的开启或停止，这样有利于快速部署迭代和弹性伸缩实例。</p>
<p>进程应该追求最小的启动时间，这样可以敏捷发布，增加健壮性，当出现问题可以快速在别的机器部署一个实例。</p>
<p>进程一旦接收到<code>终止信号(SIGTERM)</code>就会<code>优雅终止</code>。优雅终止指停止监听服务的端口，拒绝所有新的请求，并继续执行当前已接收的请求，然后退出。</p>
<p>进程还需在面对突然挂掉的情况下保持健壮性，例如通过<code>任务队列</code>的方式来解决进程突然挂掉而没有完成处理的事情，所以应该设计为任务执行是<code>幂等</code>的，可以被重复执行，重复执行的结果是一致的。</p>
<h1 id="10-开发环境与线上环境等价">10. 开发环境与线上环境等价</h1>
<blockquote>
<p>尽可能的保持开发，预发布，线上环境相同</p>
</blockquote>
<p>不同的发布环境可能存在以下差异：</p>
<ul>
<li>时间差异：开发到部署的周期较长。</li>
<li>人员差异：开发人员只负责开发，运维人员只负责部署。分工过于隔离。</li>
<li>工具差异：不同环境的配置和运行环境，使用的后端类型可能存在不同。</li>
</ul>
<p>应尽量缩小本地与线上的差异，缩短上线周期，开发运维一体化，保证开发环境与线上运行的环境一致（例如，可以通过Docker容器的方式）。</p>
<h1 id="11-日志">11. 日志</h1>
<blockquote>
<p>把日志当作事件流</p>
</blockquote>
<p>日志应该是<code>事件流</code>的汇总。12-Factor应用本身不考虑存储自己的日志输出流，不去写或管理日志文件，而是通过标准输出（stdout）的方式。</p>
<p>日志的标准输出流可以通过其他组件截获，整合其他的日志输出流，一并发给统一的日志中心处理，用于查看或存档。例如：日志收集开源工具Fluentd。</p>
<p>截获的日志流可以输出至文件，或者在终端实时查看。最重要的是可以发送到<code>Splunk</code>这样的日志索引及分析系统，提供后续的分析统计及监控告警等功能。例如：</p>
<ul>
<li>找出过去一段时间的特殊事件。</li>
<li>图形化一个大规模的趋势，如每分钟的请求量。</li>
<li>根据用户定义的条件触发告警，如每分钟报错数超过某个警戒线。</li>
</ul>
<h1 id="12-管理进程">12. 管理进程</h1>
<blockquote>
<p>后台管理任务当作一次性进程运行</p>
</blockquote>
<p>开发人员经常需要执行一些管理或维护应用的一次性任务，一次性管理进程应该和常驻进程使用相同的运行环境，开发人员可以通过ssh方式来执行一次性脚本或任务。</p>
<p>参考：</p>
<ul>
<li><a href="https://12factor.net/">https://12factor.net/</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-30329299a44716819522c0e1ceb75650">2 - 安装与配置</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-a41f0ac4c2bce9bc82f0f882ec3ece1e">2.1 - 部署k8s集群</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-463cd148d535d90f13fd41ca8c743267">2.1.1 - 使用kubeadm部署生产环境kubernetes集群</h1>
    
	<blockquote>
<p>本文为基于<code>kubeadm</code>搭建<code>生产环境</code>级别<code>高可用</code>的k8s集群。</p>
</blockquote>
<h1 id="1-环境准备">1. 环境准备</h1>
<h2 id="1-0-master硬件配置">1.0. master硬件配置</h2>
<p>参考：</p>
<ul>
<li>
<p><a href="https://help.aliyun.com/document_detail/98886.html">Master节点规格</a></p>
</li>
<li>
<p><a href="https://help.aliyun.com/document_detail/94292.html">高可靠推荐配置 - 容器服务 ACK - 阿里云</a></p>
</li>
</ul>
<p>Kubernetes集群Master节点上运行着etcd、kube-apiserver、kube-controller等核心组件，对于Kubernetes集群的稳定性有着至关重要的影响，对于生产环境的集群，必须慎重选择Master规格。Master规格跟集群规模有关，集群规模越大，所需要的Master规格也越高。</p>
<p><strong>说明</strong> ：可从多个角度衡量集群规模，例如节点数量、Pod数量、部署频率、访问量。这里简单的认为集群规模就是集群里的节点数量。</p>
<p>对于常见的集群规模，可以参见如下的方式选择Master节点的规格（对于测试环境，规格可以小一些。下面的选择能尽量保证Master负载维持在一个较低的水平上）。</p>
<table>
<thead>
<tr>
<th>节点规模</th>
<th>Master规格</th>
<th>磁盘</th>
</tr>
</thead>
<tbody>
<tr>
<td>1~5个节点</td>
<td>4核8 GB（不建议2核4 GB）</td>
<td></td>
</tr>
<tr>
<td>6~20个节点</td>
<td>4核16 GB</td>
<td></td>
</tr>
<tr>
<td>21~100个节点</td>
<td>8核32 GB</td>
<td></td>
</tr>
<tr>
<td><strong>100~200个节点</strong></td>
<td><strong>16核64 GB</strong></td>
<td></td>
</tr>
<tr>
<td><strong>1000个节点</strong></td>
<td><strong>32核128GB</strong></td>
<td><strong>1T SSD</strong></td>
</tr>
</tbody>
</table>
<p><strong>注意事项：</strong></p>
<ul>
<li>
<p><strong>由于Etcd的性能瓶颈，Etcd的数据存储盘尽量选择SSD磁盘。</strong></p>
</li>
<li>
<p><strong>为了实现多机房容灾，可将三台master分布在一个可用区下三个不同机房。</strong>（机房之间的网络延迟在10毫秒及以下级别）</p>
</li>
<li>
<p><strong>申请LB来做master节点的负载均衡实现高可用，LB作为apiserver的访问地址。</strong></p>
</li>
</ul>
<h2 id="1-1-设置防火墙端口策略">1.1. 设置防火墙端口策略</h2>
<p>生产环境设置k8s节点的iptables端口访问规则。</p>
<h3 id="1-1-1-master节点端口配置">1.1.1. master节点端口配置</h3>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>目的</th>
<th>使用者</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>入站</td>
<td>6443</td>
<td>Kubernetes API server</td>
<td>所有</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>2379-2380</td>
<td>etcd server client API</td>
<td>kube-apiserver, etcd</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td>Kubelet API</td>
<td>自身, 控制面</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10259</td>
<td>kube-scheduler</td>
<td>自身</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10257</td>
<td>kube-controller-manager</td>
<td>自身</td>
</tr>
</tbody>
</table>
<h3 id="1-1-2-worker节点端口配置">1.1.2. worker节点端口配置</h3>
<table>
<thead>
<tr>
<th>协议</th>
<th>方向</th>
<th>端口范围</th>
<th>目的</th>
<th>使用者</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>入站</td>
<td>10250</td>
<td>Kubelet API</td>
<td>自身, 控制面</td>
</tr>
<tr>
<td>TCP</td>
<td>入站</td>
<td>30000-32767</td>
<td>NodePort Services</td>
<td>所有</td>
</tr>
</tbody>
</table>
<p>添加防火墙iptables规则</p>
<p>master节点开放6443、2379、2380端口。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>iptables -A INPUT -p tcp -m multiport --dports 6443,2379,2380,10250 -j ACCEPT
</span></span></code></pre></div><h2 id="1-2-关闭-swap-分区">1.2. 关闭​​swap​​分区</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@master ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">#swapoff -a</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@master ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@master ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># free -m</span>
</span></span><span style="display:flex;"><span>              total        used        free      shared  buff/cache   available
</span></span><span style="display:flex;"><span>Mem:            <span style="color:#0000cf;font-weight:bold">976</span>         <span style="color:#0000cf;font-weight:bold">366</span>         <span style="color:#0000cf;font-weight:bold">135</span>           <span style="color:#0000cf;font-weight:bold">6</span>         <span style="color:#0000cf;font-weight:bold">474</span>         <span style="color:#0000cf;font-weight:bold">393</span>
</span></span><span style="display:flex;"><span>Swap:             <span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># swap 一栏为0，表示已经关闭了swap</span>
</span></span></code></pre></div><h2 id="1-3-开启br-netfilter和bridge-nf-call-iptables">1.3.  开启br_netfilter和bridge-nf-call-iptables</h2>
<p>参考：https://imroc.cc/post/202105/why-enable-bridge-nf-call-iptables/</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置加载br_netfilter模块</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">overlay
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">br_netfilter
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo modprobe overlay
</span></span><span style="display:flex;"><span>sudo modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 开启bridge-nf-call-iptables ，设置所需的 sysctl 参数，参数在重新启动后保持不变</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">net.bridge.bridge-nf-call-iptables  = 1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">net.ipv4.ip_forward                 = 1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 应用 sysctl 参数而不重新启动</span>
</span></span><span style="display:flex;"><span>sudo sysctl --system
</span></span></code></pre></div><h1 id="2-安装容器运行时">2. 安装容器运行时</h1>
<p>在所有主机上安装容器运行时，<code>推荐使用containerd为runtime</code>。以下分别是containerd与docker的安装命令。</p>
<h2 id="2-1-containerd">2.1. Containerd</h2>
<p>1、参考：<a href="../runtime/containerd/install-containerd.md">安装containerd</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for ubuntu</span>
</span></span><span style="display:flex;"><span>apt install -y containerd.io
</span></span></code></pre></div><p>2、生成默认配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>containerd config default &gt; /etc/containerd/config.toml
</span></span></code></pre></div><p>3、修改CgroupDriver为systemd</p>
<p>k8s官方推荐使用systemd类型的CgroupDriver。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>plugins.<span style="color:#4e9a06">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">[</span>plugins.<span style="color:#4e9a06">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc.options<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">SystemdCgroup</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>
</span></span></code></pre></div><p>4、重启containerd</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl restart containerd
</span></span></code></pre></div><h2 id="2-2-docker">2.2. Docker</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for ubuntu</span>
</span></span><span style="display:flex;"><span>apt install -y docker.io
</span></span></code></pre></div><p>官方建议配置cgroupdriver为systemd。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 修改docker进程管理器</span>
</span></span><span style="display:flex;"><span>vi /etc/docker/daemon.json
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;exec-opts&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;native.cgroupdriver=systemd&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> systemctl restart docker
</span></span><span style="display:flex;"><span>docker info <span style="color:#000;font-weight:bold">|</span> grep -i cgroup
</span></span></code></pre></div><h2 id="2-3-container-socket">2.3. Container Socket</h2>
<table>
<thead>
<tr>
<th>运行时</th>
<th>Unix 域套接字</th>
</tr>
</thead>
<tbody>
<tr>
<td>Containerd</td>
<td><code>unix:///var/run/containerd/containerd.sock</code></td>
</tr>
<tr>
<td>CRI-O</td>
<td><code>unix:///var/run/crio/crio.sock</code></td>
</tr>
<tr>
<td>Docker Engine (使用 cri-dockerd)</td>
<td><code>unix:///var/run/cri-dockerd.sock</code></td>
</tr>
</tbody>
</table>
<h1 id="3-安装kubeadm-kubelet-kubectl">3. 安装kubeadm,kubelet,kubectl</h1>
<blockquote>
<p>安装脚本可参考仓库：https://github.com/huweihuang/kubeadm-scripts.git</p>
</blockquote>
<p>在所有主机上安装kubeadm，kubelet，kubectl。最好版本与需要安装的k8s的版本一致。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 以Ubuntu系统为例</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装仓库依赖</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get install -y apt-transport-https ca-certificates curl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># use google registry</span>
</span></span><span style="display:flex;"><span>sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&#34;</span> <span style="color:#000;font-weight:bold">|</span> sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># or use aliyun registry</span>
</span></span><span style="display:flex;"><span>curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span style="color:#000;font-weight:bold">|</span> sudo apt-key add -
</span></span><span style="display:flex;"><span>tee /etc/apt/sources.list.d/kubernetes.list <span style="color:#4e9a06">&lt;&lt;EOF 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装指定版本的kubeadm, kubelet, kubectl</span>
</span></span><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install -y <span style="color:#000">kubelet</span><span style="color:#ce5c00;font-weight:bold">=</span>1.24.2-00 <span style="color:#000">kubeadm</span><span style="color:#ce5c00;font-weight:bold">=</span>1.24.2-00 <span style="color:#000">kubectl</span><span style="color:#ce5c00;font-weight:bold">=</span>1.24.2-00
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查询有哪些版本</span>
</span></span><span style="display:flex;"><span>apt-cache madison kubeadm
</span></span></code></pre></div><p><strong>离线下载安装</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">Version</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">Version</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">.24.2</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>wget https://dl.k8s.io/release/v<span style="color:#4e9a06">${</span><span style="color:#000">Version</span><span style="color:#4e9a06">}</span>/bin/linux/amd64/kubeadm
</span></span><span style="display:flex;"><span>wget https://dl.k8s.io/release/v<span style="color:#4e9a06">${</span><span style="color:#000">Version</span><span style="color:#4e9a06">}</span>/bin/linux/amd64/kubelet
</span></span><span style="display:flex;"><span>wget https://dl.k8s.io/release/v<span style="color:#4e9a06">${</span><span style="color:#000">Version</span><span style="color:#4e9a06">}</span>/bin/linux/amd64/kubectl
</span></span><span style="display:flex;"><span>chmod +x kubeadm kubelet kubectl
</span></span><span style="display:flex;"><span>cp kubeadm kubelet kubectl /usr/bin/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># add kubelet serivce</span>
</span></span><span style="display:flex;"><span>cat &gt; /lib/systemd/system/kubelet.service <span style="color:#4e9a06">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Description=kubelet: The Kubernetes Node Agent
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Documentation=https://kubernetes.io/docs/home/
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">After=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=/usr/bin/kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">StartLimitInterval=0
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">RestartSec=10
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/systemd/system/kubelet.service.d
</span></span><span style="display:flex;"><span>cat &gt; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf <span style="color:#4e9a06">&lt;&lt; \EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"># Note: This dropin only works with kubeadm and kubelet v1.11+
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=&#34;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=&#34;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"># This is a file that &#34;kubeadm init&#34; and &#34;kubeadm join&#34; generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EnvironmentFile=-/etc/default/kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl <span style="color:#204a87">enable</span> kubelet
</span></span><span style="display:flex;"><span>systemctl restart kubelet
</span></span></code></pre></div><h1 id="4-配置kubeadm-config">4. 配置kubeadm config</h1>
<p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/">kubeadm Configuration (v1beta3) | Kubernetes</a></li>
<li><a href="https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta2/">kubeadm Configuration (v1beta2) | Kubernetes</a></li>
</ul>
<h2 id="4-1-配置项说明">4.1. 配置项说明</h2>
<h3 id="4-1-1-配置类型">4.1.1. 配置类型</h3>
<p>kubeadm config支持以下几类配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">InitConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubelet.config.k8s.io/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">KubeletConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeproxy.config.k8s.io/v1alpha1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">KubeProxyConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">JoinConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>可以使用以下命令打印init和join的默认配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm config print init-defaults
</span></span><span style="display:flex;"><span>kubeadm config print join-defaults
</span></span></code></pre></div><h3 id="4-1-2-init配置">4.1.2. Init配置</h3>
<p>kubeadm init配置中只有<code>InitConfiguration</code> 和 <code>ClusterConfiguration</code> 是必须的。</p>
<p><strong>InitConfiguration:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">InitConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">bootstrapTokens</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">nodeRegistration</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>bootstrapTokens</li>
<li>nodeRegistration
<ul>
<li>criSocket：runtime的socket</li>
<li>name：节点名称</li>
</ul>
</li>
<li>localAPIEndpoint
<ul>
<li>advertiseAddress：apiserver的广播IP</li>
<li>bindPort：k8s控制面安全端口</li>
</ul>
</li>
</ul>
<p><strong>ClusterConfiguration:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">networking</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiServer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">extraArgs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">extraVolumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>
<p>networking:</p>
<ul>
<li>podSubnet：Pod CIDR范围</li>
<li>serviceSubnet： service CIDR范围</li>
<li>dnsDomain</li>
</ul>
</li>
<li>
<p>etcd:</p>
<ul>
<li>dataDir：Etcd的数据存储目录</li>
</ul>
</li>
<li>
<p>apiserver</p>
<ul>
<li>certSANs：设置额外的apiserver的域名签名证书</li>
</ul>
</li>
<li>
<p>imageRepository：镜像仓库</p>
</li>
<li>
<p>controlPlaneEndpoint：控制面LB的域名</p>
</li>
<li>
<p>kubernetesVersion：k8s版本</p>
</li>
</ul>
<h2 id="4-2-init配置示例">4.2. Init配置示例</h2>
<p>在master节点生成默认配置，并修改配置参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm config print init-defaults &gt; kubeadm-config.yaml
</span></span></code></pre></div><p>修改配置内容</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">bootstrapTokens</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">groups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">system:bootstrappers:kubeadm:default-node-token</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">token</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abcdef.0123456789abcdef</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ttl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">24h0m0s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">usages</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">signing</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">authentication</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">InitConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">localAPIEndpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">advertiseAddress</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1.2.3.4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 修改为apiserver的IP 或者去掉localAPIEndpoint则会读取默认IP。</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">bindPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6443</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">nodeRegistration</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">criSocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">unix:///var/run/containerd/containerd.sock</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">IfNotPresent</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">taints</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiServer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">certSANs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">lb.k8s.domain </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 添加额外的apiserver的域名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">&lt;vip/lb_ip&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">timeoutForControlPlane</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">4m0s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeadm.k8s.io/v1beta3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">certificatesDir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/kubernetes/pki</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">clusterName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">controllerManager</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">dns</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 默认为coredns</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">local</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">dataDir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/data/etcd  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 修改etcd的存储盘目录</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">imageRepository</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s.gcr.io </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 修改镜像仓库地址</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">controlPlaneEndpoint</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lb.k8s.domain </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 修改控制面域名</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kubernetesVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1.24.0</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># k8s 版本</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">networking</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dnsDomain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cluster.local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">serviceSubnet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.96.0.0</span><span style="color:#000">/12</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">podSubnet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10.244.0.0</span><span style="color:#000">/16 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 设置pod的IP范围</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">scheduler</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">KubeletConfiguration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubelet.config.k8s.io/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">cgroupDriver</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">systemd  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 设置为systemd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>安装完成后可以查看kubeadm config</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get cm -n kube-system kubeadm-config -oyaml
</span></span></code></pre></div><h1 id="5-安装master控制面">5. 安装Master控制面</h1>
<p>提前拉取镜像：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm config images pull
</span></span></code></pre></div><h2 id="5-1-安装master">5.1. 安装master</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo kubeadm init --config kubeadm-config.yaml --upload-certs  --node-name &lt;nodename&gt;
</span></span></code></pre></div><p>部署参数说明：</p>
<ul>
<li>
<p>--control-plane-endpoint：指定控制面(kube-apiserver)的IP或DNS域名地址。</p>
</li>
<li>
<p>--apiserver-advertise-address：kube-apiserver的IP地址。</p>
</li>
<li>
<p>--pod-network-cidr：pod network范围，控制面会自动给每个节点分配CIDR。</p>
</li>
<li>
<p>--service-cidr：service的IP范围，default &quot;10.96.0.0/12&quot;。</p>
</li>
<li>
<p>--kubernetes-version：指定k8s的版本。</p>
</li>
<li>
<p>--image-repository：指定k8s镜像仓库地址。</p>
</li>
<li>
<p>--upload-certs ：标志用来将在所有控制平面实例之间的共享证书上传到集群。</p>
</li>
<li>
<p>--node-name：hostname-override，作为节点名称。</p>
</li>
</ul>
<p>执行完毕会输出添加master和添加worker的命令如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>You can now join any number of control-plane node by running the following <span style="color:#204a87">command</span> on each as a root:
</span></span><span style="display:flex;"><span>    kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 --control-plane --certificate-key f8902e114ef118304e561c3ecd4d0b543adc226b7a07f675f56564185ffe0c07
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
</span></span><span style="display:flex;"><span>As a safeguard, uploaded-certs will be deleted in two hours<span style="color:#000;font-weight:bold">;</span> If necessary, you can use kubeadm init phase upload-certs to reload certs afterward.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Then you can join any number of worker nodes by running the following on each as root:
</span></span><span style="display:flex;"><span>    kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866
</span></span></code></pre></div><h2 id="5-2-添加其他master">5.2. 添加其他master</h2>
<p>添加<code>master</code>和添加<code>worker</code>的差别在于添加<code>master</code>多了<code>--control-plane</code> 参数来表示添加类型为<code>master</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm join &lt;control-plane-endpoint&gt;:6443 --token &lt;token&gt; <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--discovery-token-ca-cert-hash sha256:&lt;hash&gt; <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--control-plane --certificate-key &lt;certificate-key&gt; <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--node-name &lt;nodename&gt;
</span></span></code></pre></div><h1 id="6-添加node节点">6. 添加Node节点</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm join &lt;control-plane-endpoint&gt;:6443 --token &lt;token&gt; <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--discovery-token-ca-cert-hash sha256:&lt;hash&gt; <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--cri-socket /run/containerd/containerd.sock <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>--node-name &lt;nodename&gt;
</span></span></code></pre></div><h1 id="7-安装网络插件">7. 安装网络插件</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">## 如果安装之后node的状态都改为ready，即为成功</span>
</span></span><span style="display:flex;"><span>wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span><span style="display:flex;"><span>kubectl apply -f ./kube-flannel.yml
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span></code></pre></div><p>如果Pod CIDR的网段不是<code>10.244.0.0/16</code>，则需要加flannel配置中的网段更改为与Pod CIDR的网段一致。</p>
<h2 id="7-1-问题">7.1. 问题</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  Warning  FailedCreatePodSandBox  4m6s                kubelet            Failed to create pod sandbox: rpc error: <span style="color:#000">code</span> <span style="color:#ce5c00;font-weight:bold">=</span> Unknown <span style="color:#000">desc</span> <span style="color:#ce5c00;font-weight:bold">=</span> failed to setup network <span style="color:#204a87;font-weight:bold">for</span> sandbox <span style="color:#4e9a06">&#34;300d9b570cc1e23b6335c407b8e7d0ef2c74dc2fe5d7a110678c2dc919c62edf&#34;</span>: plugin <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;flannel&#34;</span> failed <span style="color:#ce5c00;font-weight:bold">(</span>add<span style="color:#ce5c00;font-weight:bold">)</span>: failed to delegate add: failed to <span style="color:#204a87">set</span> bridge addr: <span style="color:#4e9a06">&#34;cni0&#34;</span> already has an IP address different from 10.244.3.1/24
</span></span></code></pre></div><p><strong>原因：</strong></p>
<p>宿主机节点有<code>cni0</code>网卡，且网卡的IP段与flannel的CIDR网段不同，因此需要删除该网卡，让其重建。</p>
<p>查看cni0网卡</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ifconfig cni0 |grep -w inet</span>
</span></span><span style="display:flex;"><span>        inet 10.244.5.1  netmask 255.255.255.0  broadcast 10.244.116.255
</span></span></code></pre></div><p>查看flannel配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cat /run/flannel/subnet.env</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_NETWORK</span><span style="color:#ce5c00;font-weight:bold">=</span>10.244.0.0/16
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_SUBNET</span><span style="color:#ce5c00;font-weight:bold">=</span>10.244.116.1/24
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_MTU</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1450</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_IPMASQ</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span></code></pre></div><p>发现cni0 IP与FLANNEL_SUBNET网段不一致，因此删除cni0重建。</p>
<p><strong>解决：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ifconfig cni0 down    
</span></span><span style="display:flex;"><span>ip link delete cni0
</span></span></code></pre></div><h1 id="8-部署dashboard">8. 部署dashboard</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.5.0/aio/deploy/recommended.yaml
</span></span></code></pre></div><p>镜像： kubernetesui/dashboard:v2.5.0</p>
<p>默认端口：8443</p>
<p>登录页面需要填入token或kubeconfig</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1658371511/article/kubernetes/dashboard/dashboard_token.png" alt=""></p>
<p>参考：<a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">dashboard/creating-sample-user</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes-dashboard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cluster-admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes-dashboard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建用户</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n kubernetes-dashboard create token admin-user
</span></span></code></pre></div><h1 id="9-重置部署">9. 重置部署</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubeadm重置</span>
</span></span><span style="display:flex;"><span>kubeadm reset
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 清空数据目录</span>
</span></span><span style="display:flex;"><span>rm -fr /data/etcd
</span></span><span style="display:flex;"><span>rm -fr /etc/kubernetes
</span></span><span style="display:flex;"><span>rm -fr ~/.kube/
</span></span></code></pre></div><p>删除flannel</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ifconfig cni0 down
</span></span><span style="display:flex;"><span>ip link delete cni0
</span></span><span style="display:flex;"><span>ifconfig flannel.1 down
</span></span><span style="display:flex;"><span>ip link delete flannel.1
</span></span><span style="display:flex;"><span>rm -rf /var/lib/cni/
</span></span><span style="display:flex;"><span>rm -f /etc/cni/net.d/*
</span></span></code></pre></div><h1 id="10-问题排查">10. 问题排查</h1>
<h2 id="10-1-kubeadm-token过期">10.1. kubeadm token过期</h2>
<p>问题描述:</p>
<p>添加节点时报以下错误：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>discovery<span style="color:#ce5c00;font-weight:bold">]</span> The cluster-info ConfigMap does not yet contain a JWS signature <span style="color:#204a87;font-weight:bold">for</span> token ID <span style="color:#4e9a06">&#34;abcdef&#34;</span>, will try again
</span></span></code></pre></div><p>原因：token过期，初始化token后会在24小时候会被master删除。</p>
<p>解决办法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重新生成token</span>
</span></span><span style="display:flex;"><span>kubeadm token create --print-join-command
</span></span><span style="display:flex;"><span>kubeadm token list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubeadm token create</span>
</span></span><span style="display:flex;"><span>oumnnc.aqlxuvdbntlvzoiv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重新生成hash</span>
</span></span><span style="display:flex;"><span>openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt <span style="color:#000;font-weight:bold">|</span> openssl rsa -pubin -outform der 2&gt;/dev/null <span style="color:#000;font-weight:bold">|</span> openssl dgst -sha256 -hex <span style="color:#000;font-weight:bold">|</span> sed <span style="color:#4e9a06">&#39;s/^.* //&#39;</span>
</span></span></code></pre></div><p>基于新生成的token重新添加节点。</p>
<h2 id="10-2-修改kubeadm-join的master-ip或端口">10.2. 修改kubeadm join的master IP或端口</h2>
<p><code>kubeadm join</code>命令会去<code>kube-public</code>命名空间获取名为<code>cluster-info</code>的<code>ConfigMap</code>。如果需要修改kubeadm join使用的master的IP或端口，则需要修改cluster-info的configmap。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看cluster-info</span>
</span></span><span style="display:flex;"><span>kubectl -n kube-public get configmaps cluster-info -o yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 修改cluster-info</span>
</span></span><span style="display:flex;"><span>kubectl -n kube-public edit configmaps cluster-info
</span></span></code></pre></div><p>修改配置文件中的<code>server</code>字段</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">clusters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">certificate-authority-data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">xxx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://lb.k8s.domain:36443</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>执行kubeadm join的命令时指定新修改的master地址。</p>
<h2 id="10-3-conntrack-not-found">10.3. conntrack not found</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>preflight<span style="color:#ce5c00;font-weight:bold">]</span> Some fatal errors occurred:
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">[</span>ERROR FileExisting-conntrack<span style="color:#ce5c00;font-weight:bold">]</span>: conntrack not found in system path
</span></span></code></pre></div><p>解决方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apt -y install conntrack
</span></span></code></pre></div><h2 id="10-4-kubelet-unable-to-determine-runtime-api-version">10.4. Kubelet: unable to determine runtime API version</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Error: failed to run Kubelet: unable to determine runtime API version: rpc error:code <span style="color:#ce5c00;font-weight:bold">=</span> Unavailable <span style="color:#000">desc</span> <span style="color:#ce5c00;font-weight:bold">=</span> connection error: <span style="color:#000">desc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;transport: Error while dialing dial unix: missing address&#34;</span> 
</span></span></code></pre></div><p>解决方法：</p>
<p>检查kubelet的启动参数，可以用二进制直接添加参数debug</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看启动参数是否遗漏，比如10-kubeadm.conf 文件参数缺失</span>
</span></span><span style="display:flex;"><span>systemctl cat --no-pager kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat /lib/systemd/system/kubelet.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/high-availability/">利用 kubeadm 创建高可用集群 | Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">使用 kubeadm 创建集群 | Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/ha-topology/">高可用拓扑选项 | Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/kubeadm-init/#custom-images">kubeadm init | Kubernetes</a></li>
<li><a href="https://pkg.go.dev/k8s.io/kubernetes@v1.24.2/cmd/kubeadm/app/apis/kubeadm/v1beta3">v1.24.2|kubeadm|v1beta3</a></li>
<li><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">Installing kubeadm | Kubernetes</a></li>
<li><a href="https://kubernetes.io/docs/reference/ports-and-protocols/">Ports and Protocols | Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/">容器运行时 | Kubernetes</a></li>
<li><a href="https://github.com/Mirantis/cri-dockerd">https://github.com/Mirantis/cri-dockerd</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/">配置 cgroup 驱动|Kubernetes</a></li>
<li><a href="https://github.com/flannel-io/flannel">GitHub: flannel is a network fabric for containers</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/web-ui-dashboard/">部署和访问 Kubernetes 仪表板（Dashboard） | Kubernetes</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-46874a0d5c85725f7a95eacfdeaee161">2.1.2 - 使用kubespray安装kubernetes</h1>
    
	<h1 id="1-环境准备">1. 环境准备</h1>
<h2 id="1-1-部署机器">1.1. 部署机器</h2>
<blockquote>
<p>以下机器为虚拟机</p>
</blockquote>
<table>
<thead>
<tr>
<th>机器IP</th>
<th>主机名</th>
<th>角色</th>
<th>系统版本</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>172.16.94.140</td>
<td>kube-master-0</td>
<td>k8s master</td>
<td>Centos 4.17.14</td>
<td>内存：3G</td>
</tr>
<tr>
<td>172.16.94.141</td>
<td>kube-node-41</td>
<td>k8s node</td>
<td>Centos 4.17.14</td>
<td>内存：3G</td>
</tr>
<tr>
<td>172.16.94.142</td>
<td>kube-node-42</td>
<td>k8s node</td>
<td>Centos 4.17.14</td>
<td>内存：3G</td>
</tr>
<tr>
<td>172.16.94.135</td>
<td></td>
<td>部署管理机</td>
<td></td>
<td>-</td>
</tr>
</tbody>
</table>
<h2 id="1-2-配置管理机">1.2. 配置管理机</h2>
<p>管理机主要用来部署k8s集群，需要安装以下版本的软件，具体可参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes-incubator/kubespray#requirements">https://github.com/kubernetes-incubator/kubespray#requirements</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes-incubator/kubespray/blob/master/requirements.txt">https://github.com/kubernetes-incubator/kubespray/blob/master/requirements.txt</a></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible&gt;<span style="color:#ce5c00;font-weight:bold">=</span>2.4.0
</span></span><span style="display:flex;"><span>jinja2&gt;<span style="color:#ce5c00;font-weight:bold">=</span>2.9.6
</span></span><span style="display:flex;"><span>netaddr
</span></span><span style="display:flex;"><span>pbr&gt;<span style="color:#ce5c00;font-weight:bold">=</span>1.6
</span></span><span style="display:flex;"><span>ansible-modules-hashivault&gt;<span style="color:#ce5c00;font-weight:bold">=</span>3.9.4
</span></span><span style="display:flex;"><span>hvac
</span></span></code></pre></div><p><strong>1、安装及配置ansible</strong></p>
<ul>
<li>参考<a href="https://blog.csdn.net/huwh_/article/details/81215579">ansible的使用</a>。</li>
<li>给部署机器配置SSH的免密登录权限，具体参考<a href="https://blog.csdn.net/huwh_/article/details/78006127">ssh免密登录</a>。</li>
</ul>
<p><strong>2、安装python-netaddr</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装pip</span>
</span></span><span style="display:flex;"><span>yum -y install epel-release
</span></span><span style="display:flex;"><span>yum -y install python-pip
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装python-netaddr</span>
</span></span><span style="display:flex;"><span>pip install netaddr
</span></span></code></pre></div><p><strong>3、升级Jinja</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Jinja 2.9 (or newer)</span>
</span></span><span style="display:flex;"><span>pip install --upgrade jinja2
</span></span></code></pre></div><h2 id="1-3-配置部署机器">1.3. 配置部署机器</h2>
<p>部署机器即用来运行k8s集群的机器，包括<code>Master</code>和<code>Node</code>。</p>
<p><strong>1、确认系统版本</strong></p>
<p>本文采用<code>centos7</code>的系统，建议将系统内核升级到<code>4.x.x</code>以上。</p>
<p><strong>2、关闭防火墙</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl stop firewalld
</span></span><span style="display:flex;"><span>systemctl disable firewalld
</span></span><span style="display:flex;"><span>iptables -F
</span></span></code></pre></div><p><strong>3、关闭swap</strong></p>
<p>Kubespary <code>v2.5.0</code>的版本需要关闭swap，具体参考</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/kubespray/blob/02cd5418c22d51e40261775908d55bc562206023/roles/kubernetes/preinstall/tasks/verify-settings.yml#L75">https://github.com/kubernetes-incubator/kubespray/blob/02cd5418c22d51e40261775908d55bc562206023/roles/kubernetes/preinstall/tasks/verify-settings.yml#L75</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Stop if swap enabled</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">assert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">that</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ansible_swaptotal_mb == 0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">when</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubelet_fail_swap_on|default(true)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ignore_errors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{{ ignore_assert_errors }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<p><code>V2.6.0</code> 版本去除了swap的检查，具体参考：</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/kubespray/commit/b902602d161f8c147f3d155d2ac5360244577127#diff-b92ae64dd18d34a96fbeb7f7e48a6a9b">https://github.com/kubernetes-incubator/kubespray/commit/b902602d161f8c147f3d155d2ac5360244577127#diff-b92ae64dd18d34a96fbeb7f7e48a6a9b</a></li>
</ul>
</blockquote>
<p>执行关闭swap命令<code>swapoff -a</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@master ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">#swapoff -a</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@master ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@master ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># free -m</span>
</span></span><span style="display:flex;"><span>              total        used        free      shared  buff/cache   available
</span></span><span style="display:flex;"><span>Mem:            <span style="color:#0000cf;font-weight:bold">976</span>         <span style="color:#0000cf;font-weight:bold">366</span>         <span style="color:#0000cf;font-weight:bold">135</span>           <span style="color:#0000cf;font-weight:bold">6</span>         <span style="color:#0000cf;font-weight:bold">474</span>         <span style="color:#0000cf;font-weight:bold">393</span>
</span></span><span style="display:flex;"><span>Swap:             <span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># swap 一栏为0，表示已经关闭了swap</span>
</span></span></code></pre></div><p><strong>4、确认部署机器内存</strong></p>
<p>由于本文采用虚拟机部署，内存可能存在不足的问题，因此将虚拟机内存调整为3G或以上；如果是物理机一般不会有内存不足的问题。具体参考：</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/kubespray/blob/95f1e4634a1c50fa77312d058a2b713353f4307e/roles/kubernetes/preinstall/tasks/verify-settings.yml#L52">https://github.com/kubernetes-incubator/kubespray/blob/95f1e4634a1c50fa77312d058a2b713353f4307e/roles/kubernetes/preinstall/tasks/verify-settings.yml#L52</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Stop if memory is too small for masters</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">assert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">that</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ansible_memtotal_mb &gt;= 1500</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ignore_errors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{{ ignore_assert_errors }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">when</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inventory_hostname in groups[&#39;kube-master&#39;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Stop if memory is too small for nodes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">assert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">that</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ansible_memtotal_mb &gt;= 1024</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ignore_errors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;{{ ignore_assert_errors }}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">when</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">inventory_hostname in groups[&#39;kube-node&#39;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="1-4-涉及镜像">1.4. 涉及镜像</h2>
<p><code>Docker</code>版本为<code>17.03.2-ce</code>。</p>
<p><strong>1、Master节点</strong></p>
<table>
<thead>
<tr>
<th>镜像</th>
<th>版本</th>
<th>大小</th>
<th>镜像ID</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>gcr.io/google-containers/hyperkube</td>
<td>v1.9.5</td>
<td>620 MB</td>
<td>a7e7fdbc5fee</td>
<td>k8s</td>
</tr>
<tr>
<td>quay.io/coreos/etcd</td>
<td>v3.2.4</td>
<td>35.7 MB</td>
<td>498ffffcfd05</td>
<td></td>
</tr>
<tr>
<td>gcr.io/google_containers/pause-amd64</td>
<td>3.0</td>
<td>747 kB</td>
<td>99e59f495ffa</td>
<td></td>
</tr>
<tr>
<td>quay.io/calico/node</td>
<td>v2.6.8</td>
<td>282 MB</td>
<td>e96a297310fd</td>
<td>calico</td>
</tr>
<tr>
<td>quay.io/calico/cni</td>
<td>v1.11.4</td>
<td>70.8 MB</td>
<td>4c4cb67d7a88</td>
<td>calico</td>
</tr>
<tr>
<td>quay.io/calico/ctl</td>
<td>v1.6.3</td>
<td>44.4 MB</td>
<td>46d3aace8bc6</td>
<td>calico</td>
</tr>
</tbody>
</table>
<p><strong>2、Node节点</strong></p>
<table>
<thead>
<tr>
<th>镜像</th>
<th>版本</th>
<th>大小</th>
<th>镜像ID</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>gcr.io/google-containers/hyperkube</td>
<td>v1.9.5</td>
<td>620 MB</td>
<td>a7e7fdbc5fee</td>
<td>k8s</td>
</tr>
<tr>
<td>gcr.io/google_containers/pause-amd64</td>
<td>3.0</td>
<td>747 kB</td>
<td>99e59f495ffa</td>
<td></td>
</tr>
<tr>
<td>quay.io/calico/node</td>
<td>v2.6.8</td>
<td>282 MB</td>
<td>e96a297310fd</td>
<td>calico</td>
</tr>
<tr>
<td>quay.io/calico/cni</td>
<td>v1.11.4</td>
<td>70.8 MB</td>
<td>4c4cb67d7a88</td>
<td>calico</td>
</tr>
<tr>
<td>quay.io/calico/ctl</td>
<td>v1.6.3</td>
<td>44.4 MB</td>
<td>46d3aace8bc6</td>
<td>calico</td>
</tr>
<tr>
<td>gcr.io/google_containers/k8s-dns-dnsmasq-nanny-amd64</td>
<td>1.14.8</td>
<td>40.9 MB</td>
<td>c2ce1ffb51ed</td>
<td>dns</td>
</tr>
<tr>
<td>gcr.io/google_containers/k8s-dns-sidecar-amd64</td>
<td>1.14.8</td>
<td>42.2 MB</td>
<td>6f7f2dc7fab5</td>
<td>dns</td>
</tr>
<tr>
<td>gcr.io/google_containers/k8s-dns-kube-dns-amd64</td>
<td>1.14.8</td>
<td>50.5 MB</td>
<td>80cc5ea4b547</td>
<td>dns</td>
</tr>
<tr>
<td>gcr.io/google_containers/cluster-proportional-autoscaler-amd64</td>
<td>1.1.2</td>
<td>50.5 MB</td>
<td>78cf3f492e6b</td>
<td></td>
</tr>
<tr>
<td>gcr.io/google_containers/kubernetes-dashboard-amd64</td>
<td>v1.8.3</td>
<td>102 MB</td>
<td>0c60bcf89900</td>
<td>dashboard</td>
</tr>
<tr>
<td>nginx</td>
<td>1.13</td>
<td>109 MB</td>
<td>ae513a47849c</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>3、说明</strong></p>
<ul>
<li>镜像被墙并且全部镜像下载需要较多时间，建议提前下载到部署机器上。</li>
<li>hyperkube镜像主要用来运行k8s核心组件（例如kube-apiserver等）。</li>
<li>此处使用的网络组件为calico。</li>
</ul>
<h1 id="2-部署集群">2. 部署集群</h1>
<h2 id="2-1-下载kubespary的源码">2.1. 下载kubespary的源码</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/kubernetes-incubator/kubespray.git
</span></span></code></pre></div><h2 id="2-2-编辑配置文件">2.2. 编辑配置文件</h2>
<h3 id="2-2-1-hosts-ini">2.2.1. hosts.ini</h3>
<p><code>hosts.ini</code>主要为部署节点机器信息的文件，路径为：<code>kubespray/inventory/sample/hosts.ini</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> kubespray
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 复制一份配置进行修改</span>
</span></span><span style="display:flex;"><span>cp -rfp inventory/sample inventory/k8s
</span></span><span style="display:flex;"><span>vi inventory/k8s/hosts.ini
</span></span></code></pre></div><p>例如：</p>
<blockquote>
<p>hosts.ini文件可以填写部署机器的登录密码，也可以不填密码而设置ssh的免密登录。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Configure &#39;ip&#39; variable to bind kubernetes services on a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># different ip than the default iface</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 主机名             ssh登陆IP                        ssh用户名               ssh登陆密码                 机器IP          子网掩码</span>
</span></span><span style="display:flex;"><span>kube-master-0     <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.140   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.140   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-41      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.141   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.141   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-42      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.142   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.142   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># configure a bastion host if your nodes are not directly reachable</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># bastion ansible_ssh_host=x.x.x.x</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>kube-master<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-master-0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>etcd<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-master-0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>kube-node<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-node-41
</span></span><span style="display:flex;"><span>kube-node-42
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>k8s-cluster:children<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-node
</span></span><span style="display:flex;"><span>kube-master
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>calico-rr<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h3 id="2-2-2-k8s-cluster-yml">2.2.2. k8s-cluster.yml</h3>
<p><code>k8s-cluster.yml</code>主要为k8s集群的配置文件，路径为：<code>kubespray/inventory/k8s/group_vars/k8s-cluster.yml</code>。该文件可以修改安装的k8s集群的版本，参数为：kube_version: v1.9.5。具体可参考：</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/kubespray/blob/master/inventory/sample/group_vars/k8s-cluster.yml#L22">https://github.com/kubernetes-incubator/kubespray/blob/master/inventory/sample/group_vars/k8s-cluster.yml#L22</a></li>
</ul>
<h2 id="2-3-执行部署操作">2.3. 执行部署操作</h2>
<p>涉及文件为<code>cluster.yml</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 进入主目录</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> kubespray
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 执行部署命令</span>
</span></span><span style="display:flex;"><span>ansible-playbook -i inventory/k8s/hosts.ini cluster.yml -b -vvv
</span></span></code></pre></div><blockquote>
<p>-vvv 参数表示输出运行日志</p>
</blockquote>
<p>如果需要<code>重置</code>可以执行以下命令：</p>
<p>涉及文件为<code>reset.yml</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-playbook -i inventory/k8s/hosts.ini reset.yml -b -vvv
</span></span></code></pre></div><h1 id="3-确认部署结果">3. 确认部署结果</h1>
<h2 id="3-1-ansible的部署结果">3.1. ansible的部署结果</h2>
<p>ansible命令执行完，出现以下日志，则说明部署成功，否则根据报错内容进行修改。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PLAY RECAP *****************************************************************************
</span></span><span style="display:flex;"><span>kube-master-0              : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">309</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">30</span>   <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>kube-node-41               : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">203</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span>    <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>kube-node-42               : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">203</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8</span>    <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>localhost                  : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>    <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><p>以下为部分部署执行日志：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubernetes/preinstall : Update package management cache <span style="color:#ce5c00;font-weight:bold">(</span>YUM<span style="color:#ce5c00;font-weight:bold">)</span> --------------------23.96s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes/preinstall/tasks/main.yml:121 
</span></span><span style="display:flex;"><span>kubernetes/master : Master <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">wait</span> <span style="color:#204a87;font-weight:bold">for</span> the apiserver to be running ----------------23.44s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes/master/handlers/main.yml:79 
</span></span><span style="display:flex;"><span>kubernetes/preinstall : Install packages requirements ----------------------------20.20s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes/preinstall/tasks/main.yml:203 
</span></span><span style="display:flex;"><span>kubernetes/secrets : Check certs <span style="color:#000;font-weight:bold">|</span> check <span style="color:#204a87;font-weight:bold">if</span> a cert already exists on node --------13.94s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes/secrets/tasks/check-certs.yml:17 
</span></span><span style="display:flex;"><span>gather facts from all instances --------------------------------------------------9.98s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/cluster.yml:25 
</span></span><span style="display:flex;"><span>kubernetes/node : install <span style="color:#000;font-weight:bold">|</span> Compare host kubelet with hyperkube container --------9.66s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes/node/tasks/install_host.yml:2 
</span></span><span style="display:flex;"><span>kubernetes-apps/ansible : Kubernetes Apps <span style="color:#000;font-weight:bold">|</span> Start Resources -----------------------9.27s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes-apps/ansible/tasks/main.yml:37 
</span></span><span style="display:flex;"><span>kubernetes-apps/ansible : Kubernetes Apps <span style="color:#000;font-weight:bold">|</span> Lay Down KubeDNS Template ------------8.47s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes-apps/ansible/tasks/kubedns.yml:3
</span></span><span style="display:flex;"><span>download : Sync container ---------------------------------------------------------8.23s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:15 
</span></span><span style="display:flex;"><span>kubernetes-apps/network_plugin/calico : Start Calico resources --------------------7.82s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/kubernetes-apps/network_plugin/calico/tasks/main.yml:2 
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------7.67s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6 
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------7.48s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6 
</span></span><span style="display:flex;"><span>download : Sync container ---------------------------------------------------------7.35s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:15 
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------7.16s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6 
</span></span><span style="display:flex;"><span>network_plugin/calico : Calico <span style="color:#000;font-weight:bold">|</span> Copy cni plugins from calico/cni container -------7.10s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/network_plugin/calico/tasks/main.yml:62 
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------7.04s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------7.01s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6 
</span></span><span style="display:flex;"><span>download : Sync container ---------------------------------------------------------7.00s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:15 
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------6.98s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6 
</span></span><span style="display:flex;"><span>download : Download items ---------------------------------------------------------6.79s
</span></span><span style="display:flex;"><span>/root/gopath/src/kubespray/roles/download/tasks/main.yml:6 
</span></span></code></pre></div><h2 id="3-2-k8s集群运行结果">3.2. k8s集群运行结果</h2>
<p><strong>1、k8s组件信息</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get all --namespace=kube-system</span>
</span></span><span style="display:flex;"><span>NAME             DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
</span></span><span style="display:flex;"><span>ds/calico-node   <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>            <span style="color:#0000cf;font-weight:bold">3</span>           &lt;none&gt;          2h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                          DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deploy/kube-dns               <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>            <span style="color:#0000cf;font-weight:bold">2</span>           2h
</span></span><span style="display:flex;"><span>deploy/kubedns-autoscaler     <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           2h
</span></span><span style="display:flex;"><span>deploy/kubernetes-dashboard   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           2h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                 DESIRED   CURRENT   READY     AGE
</span></span><span style="display:flex;"><span>rs/kube-dns-79d99cdcd5               <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         2h
</span></span><span style="display:flex;"><span>rs/kubedns-autoscaler-5564b5585f     <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         2h
</span></span><span style="display:flex;"><span>rs/kubernetes-dashboard-69cb58d748   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         2h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME             DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
</span></span><span style="display:flex;"><span>ds/calico-node   <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>            <span style="color:#0000cf;font-weight:bold">3</span>           &lt;none&gt;          2h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                          DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deploy/kube-dns               <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>            <span style="color:#0000cf;font-weight:bold">2</span>           2h
</span></span><span style="display:flex;"><span>deploy/kubedns-autoscaler     <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           2h
</span></span><span style="display:flex;"><span>deploy/kubernetes-dashboard   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           2h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                 DESIRED   CURRENT   READY     AGE
</span></span><span style="display:flex;"><span>rs/kube-dns-79d99cdcd5               <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         2h
</span></span><span style="display:flex;"><span>rs/kubedns-autoscaler-5564b5585f     <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         2h
</span></span><span style="display:flex;"><span>rs/kubernetes-dashboard-69cb58d748   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         2h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                       READY     STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>po/calico-node-22vsg                       1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/calico-node-t7zgw                       1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/calico-node-zqnx8                       1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/kube-apiserver-kube-master-0            1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          22h
</span></span><span style="display:flex;"><span>po/kube-controller-manager-kube-master-0   1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/kube-dns-79d99cdcd5-f2t6t               3/3       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/kube-dns-79d99cdcd5-gw944               3/3       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/kube-proxy-kube-master-0                1/1       Running   <span style="color:#0000cf;font-weight:bold">2</span>          22h
</span></span><span style="display:flex;"><span>po/kube-proxy-kube-node-41                 1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          22h
</span></span><span style="display:flex;"><span>po/kube-proxy-kube-node-42                 1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          22h
</span></span><span style="display:flex;"><span>po/kube-scheduler-kube-master-0            1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/kubedns-autoscaler-5564b5585f-lt9bb     1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/kubernetes-dashboard-69cb58d748-wmb9x   1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          2h
</span></span><span style="display:flex;"><span>po/nginx-proxy-kube-node-41                1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          22h
</span></span><span style="display:flex;"><span>po/nginx-proxy-kube-node-42                1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          22h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>         AGE
</span></span><span style="display:flex;"><span>svc/kube-dns               ClusterIP   10.233.0.3     &lt;none&gt;        53/UDP,53/TCP   2h
</span></span><span style="display:flex;"><span>svc/kubernetes-dashboard   ClusterIP   10.233.27.24   &lt;none&gt;        443/TCP         2h
</span></span></code></pre></div><p><strong>2、k8s节点信息</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get nodes</span>
</span></span><span style="display:flex;"><span>NAME            STATUS    ROLES     AGE       VERSION
</span></span><span style="display:flex;"><span>kube-master-0   Ready     master    22h       v1.9.5
</span></span><span style="display:flex;"><span>kube-node-41    Ready     node      22h       v1.9.5
</span></span><span style="display:flex;"><span>kube-node-42    Ready     node      22h       v1.9.5
</span></span></code></pre></div><p><strong>3、组件健康信息</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get cs</span>
</span></span><span style="display:flex;"><span>NAME                 STATUS    MESSAGE              ERROR
</span></span><span style="display:flex;"><span>scheduler            Healthy   ok
</span></span><span style="display:flex;"><span>controller-manager   Healthy   ok
</span></span><span style="display:flex;"><span>etcd-0               Healthy   <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;health&#34;</span>: <span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-k8s集群扩容节点">4. k8s集群扩容节点</h1>
<h2 id="4-1-修改hosts-ini文件">4.1. 修改hosts.ini文件</h2>
<p>如果需要扩容<code>Node</code>节点，则修改<code>hosts.ini</code>文件，增加新增的机器信息。例如，要增加节点机器kube-node-43（IP为172.16.94.143），修改后的文件内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Configure &#39;ip&#39; variable to bind kubernetes services on a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># different ip than the default iface</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 主机名             ssh登陆IP                        ssh用户名               ssh登陆密码                 机器IP          子网掩码</span>
</span></span><span style="display:flex;"><span>kube-master-0     <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.140   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.140   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-41      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.141   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.141   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-42      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.142   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.142   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-43      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.143   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.143   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># configure a bastion host if your nodes are not directly reachable</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># bastion ansible_ssh_host=x.x.x.x</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>kube-master<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-master-0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>etcd<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-master-0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>kube-node<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-node-41
</span></span><span style="display:flex;"><span>kube-node-42
</span></span><span style="display:flex;"><span>kube-node-43
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>k8s-cluster:children<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-node
</span></span><span style="display:flex;"><span>kube-master
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>calico-rr<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h2 id="4-2-执行扩容命令">4.2. 执行扩容命令</h2>
<p>涉及文件为<code>scale.yml</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 进入主目录</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> kubespray
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 执行部署命令</span>
</span></span><span style="display:flex;"><span>ansible-playbook -i inventory/k8s/hosts.ini scale.yml -b -vvv
</span></span></code></pre></div><h2 id="4-3-检查扩容结果">4.3. 检查扩容结果</h2>
<p><strong>1、ansible的执行结果</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PLAY RECAP ***************************************
</span></span><span style="display:flex;"><span>kube-node-41               : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">228</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">11</span>   <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>kube-node-42               : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">197</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">6</span>    <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>kube-node-43               : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">227</span>  <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">69</span>   <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#8f5902;font-style:italic"># 新增Node节点</span>
</span></span><span style="display:flex;"><span>localhost                  : <span style="color:#000">ok</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>    <span style="color:#000">changed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">unreachable</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#000">failed</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><p><strong>2、k8s的节点信息</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get nodes</span>
</span></span><span style="display:flex;"><span>NAME            STATUS    ROLES     AGE       VERSION
</span></span><span style="display:flex;"><span>kube-master-0   Ready     master    1d        v1.9.5
</span></span><span style="display:flex;"><span>kube-node-41    Ready     node      1d        v1.9.5
</span></span><span style="display:flex;"><span>kube-node-42    Ready     node      1d        v1.9.5
</span></span><span style="display:flex;"><span>kube-node-43    Ready     node      1m        v1.9.5   <span style="color:#8f5902;font-style:italic">#该节点为新增Node节点</span>
</span></span></code></pre></div><p>可以看到新增的<code>kube-node-43</code>节点已经扩容完成。</p>
<p><strong>3、k8s组件信息</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get po --namespace=kube-system -o wide</span>
</span></span><span style="display:flex;"><span>NAME                                    READY     STATUS    RESTARTS   AGE       IP               NODE
</span></span><span style="display:flex;"><span>calico-node-22vsg                       1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       172.16.94.140    kube-master-0
</span></span><span style="display:flex;"><span>calico-node-8fz9x                       1/1       Running   <span style="color:#0000cf;font-weight:bold">2</span>          27m       172.16.94.143    kube-node-43
</span></span><span style="display:flex;"><span>calico-node-t7zgw                       1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       172.16.94.142    kube-node-42
</span></span><span style="display:flex;"><span>calico-node-zqnx8                       1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       172.16.94.141    kube-node-41
</span></span><span style="display:flex;"><span>kube-apiserver-kube-master-0            1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          1d        172.16.94.140    kube-master-0
</span></span><span style="display:flex;"><span>kube-controller-manager-kube-master-0   1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       172.16.94.140    kube-master-0
</span></span><span style="display:flex;"><span>kube-dns-79d99cdcd5-f2t6t               3/3       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       10.233.100.194   kube-node-41
</span></span><span style="display:flex;"><span>kube-dns-79d99cdcd5-gw944               3/3       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       10.233.107.1     kube-node-42
</span></span><span style="display:flex;"><span>kube-proxy-kube-master-0                1/1       Running   <span style="color:#0000cf;font-weight:bold">2</span>          1d        172.16.94.140    kube-master-0
</span></span><span style="display:flex;"><span>kube-proxy-kube-node-41                 1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          1d        172.16.94.141    kube-node-41
</span></span><span style="display:flex;"><span>kube-proxy-kube-node-42                 1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          1d        172.16.94.142    kube-node-42
</span></span><span style="display:flex;"><span>kube-proxy-kube-node-43                 1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          26m       172.16.94.143    kube-node-43
</span></span><span style="display:flex;"><span>kube-scheduler-kube-master-0            1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       172.16.94.140    kube-master-0
</span></span><span style="display:flex;"><span>kubedns-autoscaler-5564b5585f-lt9bb     1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       10.233.100.193   kube-node-41
</span></span><span style="display:flex;"><span>kubernetes-dashboard-69cb58d748-wmb9x   1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          10h       10.233.107.2     kube-node-42
</span></span><span style="display:flex;"><span>nginx-proxy-kube-node-41                1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          1d        172.16.94.141    kube-node-41
</span></span><span style="display:flex;"><span>nginx-proxy-kube-node-42                1/1       Running   <span style="color:#0000cf;font-weight:bold">3</span>          1d        172.16.94.142    kube-node-42
</span></span><span style="display:flex;"><span>nginx-proxy-kube-node-43                1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          26m       172.16.94.143    kube-node-43
</span></span></code></pre></div><h1 id="5-部署高可用集群">5. 部署高可用集群</h1>
<p>将<code>hosts.ini</code>文件中的master和etcd的机器增加到多台，执行部署命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-playbook -i inventory/k8s/hosts.ini cluster.yml -b -vvv
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Configure &#39;ip&#39; variable to bind kubernetes services on a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># different ip than the default iface</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 主机名             ssh登陆IP                        ssh用户名               ssh登陆密码                 机器IP          子网掩码</span>
</span></span><span style="display:flex;"><span>kube-master-0     <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.140   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.140   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-master-1     <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.144   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.144   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-master-2     <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.145   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.145   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-41      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.141   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.141   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-42      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.142   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.142   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>kube-node-43      <span style="color:#000">ansible_ssh_host</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.143   <span style="color:#000">ansible_ssh_user</span><span style="color:#ce5c00;font-weight:bold">=</span>root   <span style="color:#000">ansible_ssh_pass</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">123</span>  <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">=</span>172.16.94.143   <span style="color:#000">mask</span><span style="color:#ce5c00;font-weight:bold">=</span>/24
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># configure a bastion host if your nodes are not directly reachable</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># bastion ansible_ssh_host=x.x.x.x</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>kube-master<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-master-0
</span></span><span style="display:flex;"><span>kube-master-1
</span></span><span style="display:flex;"><span>kube-master-2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>etcd<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-master-0
</span></span><span style="display:flex;"><span>kube-master-1
</span></span><span style="display:flex;"><span>kube-master-2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>kube-node<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-node-41
</span></span><span style="display:flex;"><span>kube-node-42
</span></span><span style="display:flex;"><span>kube-node-43
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>k8s-cluster:children<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>kube-node
</span></span><span style="display:flex;"><span>kube-master
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>calico-rr<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h1 id="6-升级k8s集群">6. 升级k8s集群</h1>
<p>选择对应的k8s版本信息，执行升级命令。涉及文件为<code>upgrade-cluster.yml</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ansible-playbook upgrade-cluster.yml -b -i inventory/k8s/hosts.ini -e <span style="color:#000">kube_version</span><span style="color:#ce5c00;font-weight:bold">=</span>v1.10.4 -vvv
</span></span></code></pre></div><h1 id="7-troubles-shooting">7. troubles shooting</h1>
<p>在使用kubespary部署k8s集群时，主要遇到以下报错。</p>
<h2 id="7-1-python-netaddr未安装">7.1. python-netaddr未安装</h2>
<ul>
<li>报错内容：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>node1<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;failed&#34;</span>: true, <span style="color:#4e9a06">&#34;msg&#34;</span>: <span style="color:#4e9a06">&#34;The ipaddr filter requires python-netaddr be installed on the ansible controller&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>解决方法：</li>
</ul>
<p>需要安装 python-netaddr，具体参考上述[环境准备]内容。</p>
<h2 id="7-2-swap未关闭">7.2. swap未关闭</h2>
<ul>
<li>报错内容：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>kube-master-0<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;assertion&#34;</span>: <span style="color:#4e9a06">&#34;ansible_swaptotal_mb == 0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;evaluated_to&#34;</span>: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>kube-node-41<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;assertion&#34;</span>: <span style="color:#4e9a06">&#34;ansible_swaptotal_mb == 0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;evaluated_to&#34;</span>: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>kube-node-42<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;assertion&#34;</span>: <span style="color:#4e9a06">&#34;ansible_swaptotal_mb == 0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;evaluated_to&#34;</span>: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>解决方法：</li>
</ul>
<p>所有部署机器执行<code>swapoff -a</code>关闭swap，具体参考上述[环境准备]内容。</p>
<h2 id="7-3-部署机器内存过小">7.3. 部署机器内存过小</h2>
<ul>
<li>报错内容：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>TASK <span style="color:#ce5c00;font-weight:bold">[</span>kubernetes/preinstall : Stop <span style="color:#204a87;font-weight:bold">if</span> memory is too small <span style="color:#204a87;font-weight:bold">for</span> masters<span style="color:#ce5c00;font-weight:bold">]</span> *********************************************************************************************************************************************************************************************************
</span></span><span style="display:flex;"><span>task path: /root/gopath/src/kubespray/roles/kubernetes/preinstall/tasks/verify-settings.yml:52
</span></span><span style="display:flex;"><span>Friday <span style="color:#0000cf;font-weight:bold">10</span> August <span style="color:#0000cf;font-weight:bold">2018</span>  21:50:26 +0800 <span style="color:#ce5c00;font-weight:bold">(</span>0:00:00.940<span style="color:#ce5c00;font-weight:bold">)</span>       0:01:14.088 *********
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>kube-master-0<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;assertion&#34;</span>: <span style="color:#4e9a06">&#34;ansible_memtotal_mb &gt;= 1500&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;evaluated_to&#34;</span>: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK <span style="color:#ce5c00;font-weight:bold">[</span>kubernetes/preinstall : Stop <span style="color:#204a87;font-weight:bold">if</span> memory is too small <span style="color:#204a87;font-weight:bold">for</span> nodes<span style="color:#ce5c00;font-weight:bold">]</span> ***********************************************************************************************************************************************************************************************************
</span></span><span style="display:flex;"><span>task path: /root/gopath/src/kubespray/roles/kubernetes/preinstall/tasks/verify-settings.yml:58
</span></span><span style="display:flex;"><span>Friday <span style="color:#0000cf;font-weight:bold">10</span> August <span style="color:#0000cf;font-weight:bold">2018</span>  21:50:27 +0800 <span style="color:#ce5c00;font-weight:bold">(</span>0:00:00.570<span style="color:#ce5c00;font-weight:bold">)</span>       0:01:14.659 *********
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>kube-node-41<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;assertion&#34;</span>: <span style="color:#4e9a06">&#34;ansible_memtotal_mb &gt;= 1024&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;evaluated_to&#34;</span>: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>kube-node-42<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;assertion&#34;</span>: <span style="color:#4e9a06">&#34;ansible_memtotal_mb &gt;= 1024&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;evaluated_to&#34;</span>: <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	to retry, use: --limit @/root/gopath/src/kubespray/cluster.retry
</span></span></code></pre></div><ul>
<li>解决方法：</li>
</ul>
<p>调大所有部署机器的内存，本示例中调整为3G或以上。</p>
<h2 id="7-4-kube-scheduler组件运行失败">7.4. kube-scheduler组件运行失败</h2>
<p>kube-scheduler组件运行失败，导致http://localhost:10251/healthz调用失败。</p>
<ul>
<li>报错内容：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>FAILED - RETRYING: Master <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">wait</span> <span style="color:#204a87;font-weight:bold">for</span> kube-scheduler <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> retries left<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>FAILED - RETRYING: Master <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">wait</span> <span style="color:#204a87;font-weight:bold">for</span> kube-scheduler <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> retries left<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>fatal: <span style="color:#ce5c00;font-weight:bold">[</span>node1<span style="color:#ce5c00;font-weight:bold">]</span>: FAILED! <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;attempts&#34;</span>: 60, <span style="color:#4e9a06">&#34;changed&#34;</span>: false, <span style="color:#4e9a06">&#34;content&#34;</span>: <span style="color:#4e9a06">&#34;&#34;</span>, <span style="color:#4e9a06">&#34;failed&#34;</span>: true, <span style="color:#4e9a06">&#34;msg&#34;</span>: <span style="color:#4e9a06">&#34;Status code was not [200]: Request failed: &lt;urlopen error [Errno 111] Connection refused&gt;&#34;</span>, <span style="color:#4e9a06">&#34;redirected&#34;</span>: false, <span style="color:#4e9a06">&#34;status&#34;</span>: -1, <span style="color:#4e9a06">&#34;url&#34;</span>: <span style="color:#4e9a06">&#34;http://localhost:10251/healthz&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>解决方法：</li>
</ul>
<p>可能是内存不足导致，本示例中调大了部署机器的内存。</p>
<h2 id="7-5-docker安装包冲突">7.5. docker安装包冲突</h2>
<ul>
<li>报错内容：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>failed: <span style="color:#ce5c00;font-weight:bold">[</span>k8s-node-1<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">item</span><span style="color:#ce5c00;font-weight:bold">={</span>u<span style="color:#4e9a06">&#39;name&#39;</span>: u<span style="color:#4e9a06">&#39;docker-engine-1.13.1-1.el7.centos&#39;</span><span style="color:#ce5c00;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=</span>&gt; <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;attempts&#34;</span>: 4,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;changed&#34;</span>: false,
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;item&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;name&#34;</span>: <span style="color:#4e9a06">&#34;docker-engine-1.13.1-1.el7.centos&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;msg&#34;</span>: <span style="color:#4e9a06">&#34;Error: docker-ce-selinux conflicts with 2:container-selinux-2.66-1.el7.noarch\n&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;rc&#34;</span>: 1,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;results&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;Loaded plugins: fastestmirror\nLoading mirror speeds from cached hostfile\n * elrepo: mirrors.tuna.tsinghua.edu.cn\n * epel: mirrors.tongji.edu.cn\nPackage docker-engine is obsoleted by docker-ce, trying to install docker-ce-17.03.2.ce-1.el7.centos.x86_64 instead\nResolving Dependencies\n--&gt; Running transaction check\n---&gt; Package docker-ce.x86_64 0:17.03.2.ce-1.el7.centos will be installed\n--&gt; Processing Dependency: docker-ce-selinux &gt;= 17.03.2.ce-1.el7.centos for package: docker-ce-17.03.2.ce-1.el7.centos.x86_64\n--&gt; Processing Dependency: libltdl.so.7()(64bit) for package: docker-ce-17.03.2.ce-1.el7.centos.x86_64\n--&gt; Running transaction check\n---&gt; Package docker-ce-selinux.noarch 0:17.03.2.ce-1.el7.centos will be installed\n---&gt; Package libtool-ltdl.x86_64 0:2.4.2-22.el7_3 will be installed\n--&gt; Processing Conflict: docker-ce-selinux-17.03.2.ce-1.el7.centos.noarch conflicts docker-selinux\n--&gt; Restarting Dependency Resolution with new changes.\n--&gt; Running transaction check\n---&gt; Package container-selinux.noarch 2:2.55-1.el7 will be updated\n---&gt; Package container-selinux.noarch 2:2.66-1.el7 will be an update\n--&gt; Processing Conflict: docker-ce-selinux-17.03.2.ce-1.el7.centos.noarch conflicts docker-selinux\n--&gt; Finished Dependency Resolution\n You could try using --skip-broken to work around the problem\n You could try running: rpm -Va --nofiles --nodigest\n&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>解决方法：</li>
</ul>
<p>卸载旧的docker版本，由kubespary自动安装。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo yum remove -y docker <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-client <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-client-latest <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-common <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-latest <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-latest-logrotate <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-logrotate <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-selinux <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-engine-selinux <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-engine
</span></span></code></pre></div><p>参考文章：</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/kubespray">https://github.com/kubernetes-incubator/kubespray</a></li>
<li><a href="https://github.com/kubernetes-incubator/kubespray/blob/master/docs/upgrades.md">https://github.com/kubernetes-incubator/kubespray/blob/master/docs/upgrades.md</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1e3c685682ed41951a80a02b1a236fcc">2.1.3 - 使用minikube安装kubernetes</h1>
    
	<blockquote>
<p>以下内容基于Linux系统，特别为Ubuntu系统</p>
</blockquote>
<h1 id="1-安装kubectl">1. 安装kubectl</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -LO https://storage.googleapis.com/kubernetes-release/release/<span style="color:#204a87;font-weight:bold">$(</span>curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt<span style="color:#204a87;font-weight:bold">)</span>/bin/linux/amd64/kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chmod +x kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo mv kubectl /usr/local/bin/
</span></span></code></pre></div><p>下载指定版本，例如下载v1.9.0版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.9.0/bin/linux/amd64/kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chmod +x kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo mv kubectl /usr/local/bin/
</span></span></code></pre></div><h1 id="2-安装minikube">2. 安装minikube</h1>
<p><code>minikube</code>的源码地址：https://github.com/kubernetes/minikube</p>
<h2 id="2-1-安装minikube">2.1 安装minikube</h2>
<p>以下命令为安装<code>latest</code>版本的<code>minikube</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chmod +x minikube <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo mv minikube /usr/local/bin/
</span></span></code></pre></div><p>安装指定版本可到https://github.com/kubernetes/minikube/releases下载对应版本。</p>
<p>例如：以下为安装<code>v0.28.2</code>版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.28.2/minikube-linux-amd64 <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chmod +x minikube <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo mv minikube /usr/local/bin/
</span></span></code></pre></div><h2 id="2-2-minikube命令帮助">2.2 minikube命令帮助</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Minikube is a CLI tool that provisions and manages single-node Kubernetes clusters optimized <span style="color:#204a87;font-weight:bold">for</span> development workflows.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  minikube <span style="color:#ce5c00;font-weight:bold">[</span>command<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available Commands:
</span></span><span style="display:flex;"><span>  addons           Modify minikube<span style="color:#4e9a06">&#39;s kubernetes addons
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  cache            Add or delete an image from the local cache.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  completion       Outputs minikube shell completion for the given shell (bash or zsh)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  config           Modify minikube config
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  dashboard        Opens/displays the kubernetes dashboard URL for your local cluster
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  delete           Deletes a local kubernetes cluster
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  docker-env       Sets up docker env variables; similar to &#39;</span><span style="color:#204a87;font-weight:bold">$(</span>docker-machine env<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  get-k8s-versions Gets the list of Kubernetes versions available for minikube when using the localkube bootstrapper
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  ip               Retrieves the IP address of the running cluster
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  logs             Gets the logs of the running localkube instance, used for debugging minikube, not user code
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  mount            Mounts the specified directory into minikube
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  profile          Profile sets the current minikube profile
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  service          Gets the kubernetes URL(s) for the specified service in your local cluster
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  ssh              Log into or run a command on a machine with SSH; similar to &#39;</span>docker-machine ssh<span style="color:#a40000">&#39;</span>
</span></span><span style="display:flex;"><span>  ssh-key          Retrieve the ssh identity key path of the specified cluster
</span></span><span style="display:flex;"><span>  start            Starts a <span style="color:#204a87">local</span> kubernetes cluster
</span></span><span style="display:flex;"><span>  status           Gets the status of a <span style="color:#204a87">local</span> kubernetes cluster
</span></span><span style="display:flex;"><span>  stop             Stops a running <span style="color:#204a87">local</span> kubernetes cluster
</span></span><span style="display:flex;"><span>  update-check     Print current and latest version number
</span></span><span style="display:flex;"><span>  update-context   Verify the IP address of the running cluster in kubeconfig.
</span></span><span style="display:flex;"><span>  version          Print the version of minikube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>      --alsologtostderr                  log to standard error as well as files
</span></span><span style="display:flex;"><span>  -b, --bootstrapper string              The name of the cluster bootstrapper that will <span style="color:#204a87">set</span> up the kubernetes cluster. <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;localkube&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --log_backtrace_at traceLocation   when logging hits line file:N, emit a stack trace <span style="color:#ce5c00;font-weight:bold">(</span>default :0<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --log_dir string                   If non-empty, write log files in this directory
</span></span><span style="display:flex;"><span>      --loglevel int                     Log level <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">0</span> <span style="color:#ce5c00;font-weight:bold">=</span> DEBUG, <span style="color:#000">5</span> <span style="color:#ce5c00;font-weight:bold">=</span> FATAL<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>default 1<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --logtostderr                      log to standard error instead of files
</span></span><span style="display:flex;"><span>  -p, --profile string                   The name of the minikube VM being used.
</span></span><span style="display:flex;"><span>	This can be modified to allow <span style="color:#204a87;font-weight:bold">for</span> multiple minikube instances to be run independently <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;minikube&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --stderrthreshold severity         logs at or above this threshold go to stderr <span style="color:#ce5c00;font-weight:bold">(</span>default 2<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -v, --v Level                          log level <span style="color:#204a87;font-weight:bold">for</span> V logs
</span></span><span style="display:flex;"><span>      --vmodule moduleSpec               comma-separated list of <span style="color:#000">pattern</span><span style="color:#ce5c00;font-weight:bold">=</span>N settings <span style="color:#204a87;font-weight:bold">for</span> file-filtered logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;minikube [command] --help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information about a command.
</span></span></code></pre></div><h1 id="3-使用minikube安装k8s集群">3. 使用minikube安装k8s集群</h1>
<h2 id="3-1-minikube-start">3.1. minikube start</h2>
<p>可以以<code>Docker</code>的方式运行k8s的组件，但需要先安装Docker(可参考<a href="">Docker安装</a>)，启动参数使用<code>--vm-driver=none</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>minikube start --vm-driver<span style="color:#ce5c00;font-weight:bold">=</span>none
</span></span></code></pre></div><p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@ubuntu:~# minikube start --vm-driver<span style="color:#ce5c00;font-weight:bold">=</span>none
</span></span><span style="display:flex;"><span>Starting <span style="color:#204a87">local</span> Kubernetes v1.10.0 cluster...
</span></span><span style="display:flex;"><span>Starting VM...
</span></span><span style="display:flex;"><span>Getting VM IP address...
</span></span><span style="display:flex;"><span>Moving files into cluster...
</span></span><span style="display:flex;"><span>Downloading kubeadm v1.10.0
</span></span><span style="display:flex;"><span>Downloading kubelet v1.10.0
</span></span><span style="display:flex;"><span>^<span style="color:#ce5c00;font-weight:bold">[[</span>DFinished Downloading kubelet v1.10.0
</span></span><span style="display:flex;"><span>Finished Downloading kubeadm v1.10.0
</span></span><span style="display:flex;"><span>Setting up certs...
</span></span><span style="display:flex;"><span>Connecting to cluster...
</span></span><span style="display:flex;"><span>Setting up kubeconfig...
</span></span><span style="display:flex;"><span>Starting cluster components...
</span></span><span style="display:flex;"><span>Kubectl is now configured to use the cluster.
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">===================</span>
</span></span><span style="display:flex;"><span>WARNING: IT IS RECOMMENDED NOT TO RUN THE NONE DRIVER ON PERSONAL WORKSTATIONS
</span></span><span style="display:flex;"><span>	The <span style="color:#4e9a06">&#39;none&#39;</span> driver will run an insecure kubernetes apiserver as root that may leave the host vulnerable to CSRF attacks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>When using the none driver, the kubectl config and credentials generated will be root owned and will appear in the root home directory.
</span></span><span style="display:flex;"><span>You will need to move the files to the appropriate location and <span style="color:#204a87;font-weight:bold">then</span> <span style="color:#204a87">set</span> the correct permissions.  An example of this is below:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sudo mv /root/.kube <span style="color:#000">$HOME</span>/.kube <span style="color:#8f5902;font-style:italic"># this will write over any previous configuration</span>
</span></span><span style="display:flex;"><span>	sudo chown -R <span style="color:#000">$USER</span> <span style="color:#000">$HOME</span>/.kube
</span></span><span style="display:flex;"><span>	sudo chgrp -R <span style="color:#000">$USER</span> <span style="color:#000">$HOME</span>/.kube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sudo mv /root/.minikube <span style="color:#000">$HOME</span>/.minikube <span style="color:#8f5902;font-style:italic"># this will write over any previous configuration</span>
</span></span><span style="display:flex;"><span>	sudo chown -R <span style="color:#000">$USER</span> <span style="color:#000">$HOME</span>/.minikube
</span></span><span style="display:flex;"><span>	sudo chgrp -R <span style="color:#000">$USER</span> <span style="color:#000">$HOME</span>/.minikube
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>This can also be <span style="color:#204a87;font-weight:bold">done</span> automatically by setting the env var <span style="color:#000">CHANGE_MINIKUBE_NONE_USER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>Loading cached images from config file.
</span></span></code></pre></div><p>安装指定版本的kubernetes集群</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查阅版本</span>
</span></span><span style="display:flex;"><span>minikube get-k8s-versions
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 选择版本启动</span>
</span></span><span style="display:flex;"><span>minikube start --kubernetes-version v1.7.3 --vm-driver<span style="color:#ce5c00;font-weight:bold">=</span>none
</span></span></code></pre></div><h2 id="3-2-minikube-status">3.2. minikube status</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ minikube status
</span></span><span style="display:flex;"><span>minikube: Running
</span></span><span style="display:flex;"><span>cluster: Running
</span></span><span style="display:flex;"><span>kubectl: Correctly Configured: pointing to minikube-vm at 172.16.94.139
</span></span></code></pre></div><h2 id="3-3-minikube-stop">3.3. minikube stop</h2>
<p><code>minikube stop</code> 命令可以用来停止集群。 该命令会关闭 minikube 虚拟机，但将保留所有集群状态和数据。 再次启动集群将恢复到之前的状态。</p>
<h2 id="3-4-minikube-delete">3.4. minikube delete</h2>
<p><code>minikube delete</code> 命令可以用来删除集群。 该命令将关闭并删除 minikube 虚拟机。没有数据或状态会被保存下来。</p>
<h1 id="4-查看部署结果">4. 查看部署结果</h1>
<h2 id="4-1-部署组件">4.1. 部署组件</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@ubuntu:~# kubectl get all --namespace<span style="color:#ce5c00;font-weight:bold">=</span>kube-system
</span></span><span style="display:flex;"><span>NAME                                        READY     STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/etcd-minikube                           1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/kube-addon-manager-minikube             1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/kube-apiserver-minikube                 1/1       Running   <span style="color:#0000cf;font-weight:bold">1</span>          39m
</span></span><span style="display:flex;"><span>pod/kube-controller-manager-minikube        1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/kube-dns-86f4d74b45-bdfnx               3/3       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/kube-proxy-dqdvg                        1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/kube-scheduler-minikube                 1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/kubernetes-dashboard-5498ccf677-c2gnh   1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>pod/storage-provisioner                     1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          38m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>         AGE
</span></span><span style="display:flex;"><span>service/kube-dns               ClusterIP   10.96.0.10      &lt;none&gt;        53/UDP,53/TCP   38m
</span></span><span style="display:flex;"><span>service/kubernetes-dashboard   NodePort    10.104.48.227   &lt;none&gt;        80:30000/TCP    38m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                        DESIRED   CURRENT   READY     UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
</span></span><span style="display:flex;"><span>daemonset.apps/kube-proxy   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           &lt;none&gt;          38m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/kube-dns               <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           38m
</span></span><span style="display:flex;"><span>deployment.apps/kubernetes-dashboard   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           38m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                              DESIRED   CURRENT   READY     AGE
</span></span><span style="display:flex;"><span>replicaset.apps/kube-dns-86f4d74b45               <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         38m
</span></span><span style="display:flex;"><span>replicaset.apps/kubernetes-dashboard-5498ccf677   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         38m
</span></span></code></pre></div><h2 id="4-2-dashboard">4.2. dashboard</h2>
<p>通过访问<code>ip:port</code>，例如：http://172.16.94.139:30000/，可以访问k8s的<code>dashboard</code>控制台。</p>
<p>&lt;img src=&quot;http://res.cloudinary.com/dqxtn0ick/image/upload/v1533695750/article/kubernetes/arch/dashboard.png&quot; width = &quot;100%&quot;/&gt;</p>
<h1 id="5-troubleshooting">5. troubleshooting</h1>
<h2 id="5-1-没有安装virtualbox">5.1. 没有安装VirtualBox</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@minikube ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># minikube start</span>
</span></span><span style="display:flex;"><span>Starting <span style="color:#204a87">local</span> Kubernetes v1.10.0 cluster...
</span></span><span style="display:flex;"><span>Starting VM...
</span></span><span style="display:flex;"><span>Downloading Minikube ISO
</span></span><span style="display:flex;"><span> 160.27 MB / 160.27 MB <span style="color:#ce5c00;font-weight:bold">[============================================]</span> 100.00% 0s
</span></span><span style="display:flex;"><span>E0727 15:47:08.655647    <span style="color:#0000cf;font-weight:bold">9407</span> start.go:174<span style="color:#ce5c00;font-weight:bold">]</span> Error starting host: Error creating host: Error executing step: Running precreate checks.
</span></span><span style="display:flex;"><span>: VBoxManage not found. Make sure VirtualBox is installed and VBoxManage is in the path.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Retrying.
</span></span><span style="display:flex;"><span>E0727 15:47:08.656994    <span style="color:#0000cf;font-weight:bold">9407</span> start.go:180<span style="color:#ce5c00;font-weight:bold">]</span> Error starting host:  Error creating host: Error executing step: Running precreate checks.
</span></span><span style="display:flex;"><span>: VBoxManage not found. Make sure VirtualBox is installed and VBoxManage is in the <span style="color:#000">path</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">================================================================================</span>
</span></span><span style="display:flex;"><span>An error has occurred. Would you like to opt in to sending anonymized crash
</span></span><span style="display:flex;"><span>information to minikube to <span style="color:#204a87">help</span> prevent future errors?
</span></span><span style="display:flex;"><span>To opt out of these messages, run the command:
</span></span><span style="display:flex;"><span>	minikube config <span style="color:#204a87">set</span> WantReportErrorPrompt <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">================================================================================</span>
</span></span><span style="display:flex;"><span>Please enter your response <span style="color:#ce5c00;font-weight:bold">[</span>Y/n<span style="color:#ce5c00;font-weight:bold">]</span>:
</span></span></code></pre></div><p>解决方法，先安装VirtualBox。</p>
<h2 id="5-2-没有安装docker">5.2. 没有安装Docker</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@minikube ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># minikube start --vm-driver=none</span>
</span></span><span style="display:flex;"><span>Starting <span style="color:#204a87">local</span> Kubernetes v1.10.0 cluster...
</span></span><span style="display:flex;"><span>Starting VM...
</span></span><span style="display:flex;"><span>E0727 15:56:54.936706    <span style="color:#0000cf;font-weight:bold">9441</span> start.go:174<span style="color:#ce5c00;font-weight:bold">]</span> Error starting host: Error creating host: Error executing step: Running precreate checks.
</span></span><span style="display:flex;"><span>: docker cannot be found on the path <span style="color:#204a87;font-weight:bold">for</span> this machine. A docker installation is a requirement <span style="color:#204a87;font-weight:bold">for</span> using the none driver: exec: <span style="color:#4e9a06">&#34;docker&#34;</span>: executable file not found in <span style="color:#000">$PATH</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> Retrying.
</span></span><span style="display:flex;"><span>E0727 15:56:54.938930    <span style="color:#0000cf;font-weight:bold">9441</span> start.go:180<span style="color:#ce5c00;font-weight:bold">]</span> Error starting host:  Error creating host: Error executing step: Running precreate checks.
</span></span><span style="display:flex;"><span>: docker cannot be found on the path <span style="color:#204a87;font-weight:bold">for</span> this machine. A docker installation is a requirement <span style="color:#204a87;font-weight:bold">for</span> using the none driver: exec: <span style="color:#4e9a06">&#34;docker&#34;</span>: executable file not found in <span style="color:#000">$PATH</span>
</span></span></code></pre></div><p>解决方法，先安装Docker。</p>
<p>文章参考：</p>
<p><a href="https://github.com/kubernetes/minikube">https://github.com/kubernetes/minikube</a></p>
<p><a href="https://kubernetes.io/docs/setup/minikube/">https://kubernetes.io/docs/setup/minikube/</a></p>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-minikube/">https://kubernetes.io/docs/tasks/tools/install-minikube/</a></p>
<p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-06181b6bb8970c2b2814c3aed2e7944d">2.1.4 - 使用kind安装kubernetes</h1>
    
	<h1 id="1-安装kind">1. 安装kind</h1>
<p>On mac or linux</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -Lo ./kind <span style="color:#4e9a06">&#34;https://github.com/kubernetes-sigs/kind/releases/download/v0.7.0/kind-</span><span style="color:#204a87;font-weight:bold">$(</span>uname<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">-amd64&#34;</span>
</span></span><span style="display:flex;"><span>chmod +x ./kind
</span></span><span style="display:flex;"><span>mv ./kind /some-dir-in-your-PATH/kind
</span></span></code></pre></div><h1 id="2-创建k8s集群">2. 创建k8s集群</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kind create cluster
</span></span><span style="display:flex;"><span>Creating cluster <span style="color:#4e9a06">&#34;kind&#34;</span> ...
</span></span><span style="display:flex;"><span> ✓ Ensuring node image <span style="color:#ce5c00;font-weight:bold">(</span>kindest/node:v1.17.0<span style="color:#ce5c00;font-weight:bold">)</span> 🖼
</span></span><span style="display:flex;"><span> ✓ Preparing nodes 📦
</span></span><span style="display:flex;"><span> ✓ Writing configuration 📜
</span></span><span style="display:flex;"><span> ✓ Starting control-plane 🕹️
</span></span><span style="display:flex;"><span> ✓ Installing CNI 🔌
</span></span><span style="display:flex;"><span> ✓ Installing StorageClass 💾
</span></span><span style="display:flex;"><span>Set kubectl context to <span style="color:#4e9a06">&#34;kind-kind&#34;</span>
</span></span><span style="display:flex;"><span>You can now use your cluster with:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl cluster-info --context kind-kind
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Not sure what to <span style="color:#204a87;font-weight:bold">do</span> next? 😅 Check out https://kind.sigs.k8s.io/docs/user/quick-start/
</span></span></code></pre></div><p>查看集群信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl cluster-info --context kind-kind
</span></span><span style="display:flex;"><span>Kubernetes master is running at https://127.0.0.1:32768
</span></span><span style="display:flex;"><span>KubeDNS is running at https://127.0.0.1:32768/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
</span></span></code></pre></div><p>查看node</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get node -o wide
</span></span><span style="display:flex;"><span>NAME                 STATUS   ROLES    AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE       KERNEL-VERSION                      CONTAINER-RUNTIME
</span></span><span style="display:flex;"><span>kind-control-plane   Ready    master   35h   v1.17.0   172.17.0.2    &lt;none&gt;        Ubuntu 19.10   3.10.107-1-tlinux2_kvm_guest-0049   containerd://1.3.2
</span></span></code></pre></div><p>查看pod</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get po --all-namespaces -o wide
</span></span><span style="display:flex;"><span>NAMESPACE            NAME                                         READY   STATUS    RESTARTS   AGE   IP           NODE                 NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>kube-system          coredns-6955765f44-lqk9v                     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   10.244.0.4   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          coredns-6955765f44-zpsmc                     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   10.244.0.3   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          etcd-kind-control-plane                      1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   172.17.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          kindnet-8mt7d                                1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   172.17.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          kube-apiserver-kind-control-plane            1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   172.17.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          kube-controller-manager-kind-control-plane   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   172.17.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          kube-proxy-5w25s                             1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   172.17.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system          kube-scheduler-kind-control-plane            1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   172.17.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>local-path-storage   local-path-provisioner-7745554f7f-dckzr      1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35h   10.244.0.2   kind-control-plane   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>docker ps</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID        IMAGE                  COMMAND                  CREATED             STATUS              PORTS                       NAMES
</span></span><span style="display:flex;"><span>93b291f99dd4        kindest/node:v1.17.0   <span style="color:#4e9a06">&#34;/usr/local/bin/entr…&#34;</span>   <span style="color:#0000cf;font-weight:bold">2</span> minutes ago       Up <span style="color:#0000cf;font-weight:bold">2</span> minutes        127.0.0.1:32768-&gt;6443/tcp   kind-control-plane
</span></span></code></pre></div><h1 id="3-kindest-node容器内进程">3. kindest/node容器内进程</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker <span style="color:#204a87">exec</span> -it 93b291f99dd4 bash
</span></span><span style="display:flex;"><span>root@kind-control-plane:/# ps auxw
</span></span><span style="display:flex;"><span>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span style="display:flex;"><span>root         <span style="color:#0000cf;font-weight:bold">1</span>  0.1  0.0  <span style="color:#0000cf;font-weight:bold">19512</span>  <span style="color:#0000cf;font-weight:bold">7480</span> ?        Ss   03:18   0:00 /sbin/init
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">105</span>  0.0  0.0  <span style="color:#0000cf;font-weight:bold">26396</span>  <span style="color:#0000cf;font-weight:bold">7344</span> ?        S&lt;s  03:18   0:00 /lib/systemd/systemd-journald
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">141</span>  2.3  0.3 <span style="color:#0000cf;font-weight:bold">2374736</span> <span style="color:#0000cf;font-weight:bold">51564</span> ?       Ssl  03:18   0:06 /usr/local/bin/containerd
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">325</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">5036</span> ?        Sl   03:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 3f415d609e15ef12b9f53557891c311c156b912d5a326544a25c8b29cfa9d366 -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">346</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:18   0:00 /pause
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">370</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">5108</span> ?        Sl   03:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1e1f3eed09f701fb621325e7b9e96d1c3de60ebd3bd64e0aec376e9490cf0e57 -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">397</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">4684</span> ?        Sl   03:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id c5e451089a1a5b3dfb2cc68ee27ac7d414285be55ecfdc5bd59180fbfbc7df2e -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">424</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">4924</span> ?        Sl   03:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 81e35f29ac8c2dda344125a10e3791be7ccf788a88f1efbc3397fa319f02881f -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">443</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:18   0:00 /pause
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">458</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:18   0:00 /pause
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">465</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:18   0:00 /pause
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">548</span>  0.7  0.1 <span style="color:#0000cf;font-weight:bold">145500</span> <span style="color:#0000cf;font-weight:bold">27724</span> ?        Ssl  03:18   0:02 kube-scheduler --authentication-kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/scheduler.conf --authorization-kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/scheduler.conf --bind-address<span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1 --kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/scheduler.conf --leader-elect<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">589</span>  1.0  0.3 <span style="color:#0000cf;font-weight:bold">159536</span> <span style="color:#0000cf;font-weight:bold">54384</span> ?        Ssl  03:18   0:02 kube-controller-manager --allocate-node-cidrs<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --authentication-kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/controller-manager.conf --authorization-kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/controller-manager.conf --bind-address<span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1 --client-ca-file<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/pki/ca.cr
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">613</span>  3.8  1.6 <span style="color:#0000cf;font-weight:bold">445780</span> <span style="color:#0000cf;font-weight:bold">273484</span> ?       Ssl  03:18   0:10 kube-apiserver --advertise-address<span style="color:#ce5c00;font-weight:bold">=</span>172.17.0.2 --allow-privileged<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --authorization-mode<span style="color:#ce5c00;font-weight:bold">=</span>Node,RBAC --client-ca-file<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/pki/ca.crt --enable-admission-plugins<span style="color:#ce5c00;font-weight:bold">=</span>NodeRestriction --enable-bootstrap-token-auth<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --etcd-cafile<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">660</span>  1.4  0.2 <span style="color:#0000cf;font-weight:bold">10613604</span> <span style="color:#0000cf;font-weight:bold">37448</span> ?      Ssl  03:18   0:04 etcd --advertise-client-urls<span style="color:#ce5c00;font-weight:bold">=</span>https://172.17.0.2:2379 --cert-file<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/pki/etcd/server.crt --client-cert-auth<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --data-dir<span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/etcd --initial-advertise-peer-urls<span style="color:#ce5c00;font-weight:bold">=</span>https://172.17.0.2:2380 --initial-cluster<span style="color:#ce5c00;font-weight:bold">=</span>kind-control-plane<span style="color:#ce5c00;font-weight:bold">=</span>https://172.
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">718</span>  1.3  0.3 <span style="color:#0000cf;font-weight:bold">2084848</span> <span style="color:#0000cf;font-weight:bold">52772</span> ?       Ssl  03:18   0:03 /usr/bin/kubelet --bootstrap-kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/kubelet.conf --config<span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/kubelet/config.yaml --container-runtime<span style="color:#ce5c00;font-weight:bold">=</span>remote --container-runtime-endpoint<span style="color:#ce5c00;font-weight:bold">=</span>/run/containerd/containerd.sock --fail
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">876</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">5084</span> ?        Sl   03:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id adfbea8fec5ac6986407291f5bfc5aecead176954e5dabbe1517b98dd77bf78b -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">893</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">4796</span> ?        Sl   03:18   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 53bdce023626b60ffaa0548b5888e457dc9c3bc45c7808a385dd0f63dcc90327 -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">924</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:18   0:00 /pause
</span></span><span style="display:flex;"><span>root       <span style="color:#0000cf;font-weight:bold">931</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:18   0:00 /pause
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1000</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">127616</span> <span style="color:#0000cf;font-weight:bold">11100</span> ?        Ssl  03:18   0:00 /bin/kindnetd
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1017</span>  0.0  0.1 <span style="color:#0000cf;font-weight:bold">141060</span> <span style="color:#0000cf;font-weight:bold">19420</span> ?        Ssl  03:18   0:00 /usr/local/bin/kube-proxy --config<span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/kube-proxy/config.conf --hostname-override<span style="color:#ce5c00;font-weight:bold">=</span>kind-control-plane
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1066</span>  0.0  0.0      <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span> ?        Z    03:18   0:00 <span style="color:#ce5c00;font-weight:bold">[</span>iptables-nft-sa<span style="color:#ce5c00;font-weight:bold">]</span> &lt;defunct&gt;
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1080</span>  0.0  0.0      <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span> ?        Z    03:18   0:00 <span style="color:#ce5c00;font-weight:bold">[</span>iptables-nft-sa<span style="color:#ce5c00;font-weight:bold">]</span> &lt;defunct&gt;
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1241</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">5156</span> ?        Sl   03:19   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 5cbd7bbe186cf5847786c7a03aa4c6f82e6c805d0a189f0f3e8fb1750594260d -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1262</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:19   0:00 /pause
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1303</span>  0.1  0.0 <span style="color:#0000cf;font-weight:bold">134372</span> <span style="color:#0000cf;font-weight:bold">14088</span> ?        Ssl  03:19   0:00 local-path-provisioner --debug start --helper-image k8s.gcr.io/debian-base:v2.0.0 --config /etc/config/config.json
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1411</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">4876</span> ?        Sl   03:19   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id 196b440345cb5ef47a6c31222323d35bbfef85d1d79c149ec0e3a6e22022a5f0 -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1437</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:19   0:00 /pause
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1450</span>  0.0  0.0 <span style="color:#0000cf;font-weight:bold">112540</span>  <span style="color:#0000cf;font-weight:bold">4380</span> ?        Sl   03:19   0:00 /usr/local/bin/containerd-shim-runc-v2 -namespace k8s.io -id de7bdf052083978c78708383f842567d4fb38adff22a56792437a4de82425afe -address /run/containerd/containerd.sock
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1480</span>  0.0  0.0   <span style="color:#0000cf;font-weight:bold">1012</span>     <span style="color:#0000cf;font-weight:bold">4</span> ?        Ss   03:19   0:00 /pause
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1530</span>  0.1  0.1 <span style="color:#0000cf;font-weight:bold">144324</span> <span style="color:#0000cf;font-weight:bold">19056</span> ?        Ssl  03:19   0:00 /coredns -conf /etc/coredns/Corefile
</span></span><span style="display:flex;"><span>root      <span style="color:#0000cf;font-weight:bold">1531</span>  0.1  0.1 <span style="color:#0000cf;font-weight:bold">144580</span> <span style="color:#0000cf;font-weight:bold">19204</span> ?        Ssl  03:19   0:00 /coredns -conf /etc/coredns/Corefile
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes-sigs/kind">https://github.com/kubernetes-sigs/kind</a></li>
<li><a href="https://kind.sigs.k8s.io/docs/user/quick-start/">https://kind.sigs.k8s.io/docs/user/quick-start/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-eee653beaa5313391bca6e7f1ffaf477">2.1.5 - 安装k8s dashboard</h1>
    
	<h2 id="1-部署dashboard">1. 部署dashboard</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
</span></span></code></pre></div><p>镜像： kubernetesui/dashboard:v2.5.0</p>
<p>默认端口：8443</p>
<p>登录页面需要填入token或kubeconfig</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1658371511/article/kubernetes/dashboard/dashboard_token.png" alt=""></p>
<h2 id="2-登录dashboard">2. 登录dashboard</h2>
<h3 id="2-1-创建超级管理员">2.1. 创建超级管理员</h3>
<p>参考：<a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">dashboard/creating-sample-user</a></p>
<p>创建dashboard-adminuser.yaml文件如下：</p>
<blockquote>
<p>k8s 1.24+版本需要自行创建secret绑定serviceaccount</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes-dashboard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cluster-admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes-dashboard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin-user-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes-dashboard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">kubernetes.io/service-account.name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;admin-user&#34;</span><span style="color:#f8f8f8;text-decoration:underline">   
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes.io/service-account-token  </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建serviceaccount和ClusterRoleBinding，绑定cluster-admin的超级管理员的权限。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f dashboard-adminuser.yaml 
</span></span></code></pre></div><p>创建用户token</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n kubernetes-dashboard create token admin-user --duration 8760h
</span></span></code></pre></div><p>或者通过secret查询token</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get secret admin-user-secret -n kubernetes-dashboard -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">={</span><span style="color:#4e9a06">&#34;.data.token&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">|</span> base64 -d
</span></span></code></pre></div><p>移除账号</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n kubernetes-dashboard delete serviceaccount admin-user
</span></span><span style="display:flex;"><span>kubectl -n kubernetes-dashboard delete clusterrolebinding admin-user
</span></span></code></pre></div><h3 id="2-2-创建namespace管理员">2.2. 创建Namespace管理员</h3>
<p>1、创建角色权限（role）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#4e9a06">&#39;*&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#4e9a06">&#39;*&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#4e9a06">&#39;*&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>2、创建用户账号（ServiceAccount）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建secret 可自动生成token</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Secret
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: <span style="color:#4e9a06">${</span><span style="color:#000">SecretName</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>  namespace: <span style="color:#4e9a06">${</span><span style="color:#000">ServiceAccountNS</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>  annotations:
</span></span><span style="display:flex;"><span>    kubernetes.io/service-account.name: <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">ServiceAccountName</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>   
</span></span><span style="display:flex;"><span>type: kubernetes.io/service-account-token
</span></span></code></pre></div><p>3、创建角色绑定关系</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>4、生成token</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n &lt;namespace&gt; create token &lt;ServiceAccount&gt; --duration 8760h
</span></span></code></pre></div><p>或者通过上述secret中的token获得</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get secret <span style="color:#4e9a06">${</span><span style="color:#000">SecretName</span><span style="color:#4e9a06">}</span> -n <span style="color:#4e9a06">${</span><span style="color:#000">ServiceAccountNS</span><span style="color:#4e9a06">}</span> -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">={</span><span style="color:#4e9a06">&#34;.data.token&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">|</span> base64 -d
</span></span></code></pre></div><h3 id="2-3-创建只读账户">2.3. 创建只读账户</h3>
<p>集群默认提供了几种命名空间级别的权限，分别设置ClusterRole: [admin, edit, view], 将授权设置为<code>ClusterRole</code>为<code>view</code>即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">view</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;-admin-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="3-集成sso登录">3. 集成SSO登录</h1>
<p>社区提供了添加<code>Authorization header</code>的方式来集成自定义的SSO登录。即在HTTP请求中增加<strong>Header:  <code>Authorization: Bearer &lt;token&gt;</code></strong>。该操作可以通过apisix或Nginx等插件注入Header。</p>
<p>参考：</p>
<ul>
<li>
<p><a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/web-ui-dashboard/">部署和访问 Kubernetes 仪表板（Dashboard） | Kubernetes</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">dashboard/creating-sample-user.md at master · kubernetes/dashboard · GitHub</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/dashboard/tree/master/docs/user/access-control">dashboard/docs/user/access-control at master · kubernetes/dashboard · GitHub</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-090c38942225ddadebc0c1de1ff9b279">2.2 - kubeadm升级k8s集群</h1>
    
	<p>本文主要说明如何使用<code>kubeadm</code>来升级k8s集群。</p>
<h1 id="1-版本注意事项">1. 版本注意事项</h1>
<p>假设k8s的版本格式为<code>x.y.z</code>，那么使用kubeadm最多只能升级到<code>y+1</code>版本，或者是当前<code>y</code>版本的最新版本。例如你k8s集群的版本为<code>1.24.x</code>，那么你最大版本只能下载<code>1.25.x</code>的kubeadm来升级版本。</p>
<p>因此升级前需要执行以下命令来验证可升级的版本。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm upgrade plan
</span></span></code></pre></div><h2 id="1-1-版本跨度过大">1.1. 版本跨度过大</h2>
<p>如果出现以下报错，说明升级的版本跨度过大。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubeadm的版本为v1.26.7</span>
</span></span><span style="display:flex;"><span>./kubeadm version
</span></span><span style="display:flex;"><span>kubeadm version: <span style="color:#000;font-weight:bold">&amp;</span>version.Info<span style="color:#ce5c00;font-weight:bold">{</span>Major:<span style="color:#4e9a06">&#34;1&#34;</span>, Minor:<span style="color:#4e9a06">&#34;26&#34;</span>, GitVersion:<span style="color:#4e9a06">&#34;v1.26.7&#34;</span>, GitCommit:<span style="color:#4e9a06">&#34;84e1fc493a47446df2e155e70fca768d2653a398&#34;</span>, GitTreeState:<span style="color:#4e9a06">&#34;clean&#34;</span>, BuildDate:<span style="color:#4e9a06">&#34;2023-07-19T12:22:13Z&#34;</span>, GoVersion:<span style="color:#4e9a06">&#34;go1.20.6&#34;</span>, Compiler:<span style="color:#4e9a06">&#34;gc&#34;</span>, Platform:<span style="color:#4e9a06">&#34;linux/amd64&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当前k8s集群版本1.24.2 版本跨度过大。</span>
</span></span><span style="display:flex;"><span>./kubeadm upgrade plan
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/config<span style="color:#ce5c00;font-weight:bold">]</span> Making sure the configuration is correct:
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/config<span style="color:#ce5c00;font-weight:bold">]</span> Reading configuration from the cluster...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/config<span style="color:#ce5c00;font-weight:bold">]</span> FYI: You can look at this config file with <span style="color:#4e9a06">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/config<span style="color:#ce5c00;font-weight:bold">]</span> FATAL: this version of kubeadm only supports deploying clusters with the control plane version &gt;<span style="color:#ce5c00;font-weight:bold">=</span> 1.25.0. Current version: v1.24.2
</span></span><span style="display:flex;"><span>To see the stack trace of this error execute with --v<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5</span> or higher
</span></span></code></pre></div><h2 id="1-2-可升级的版本计划">1.2. 可升级的版本计划</h2>
<p>可升级的版本计划如下</p>
<p>当前的k8s版本为<code>1.24.2</code>，可升级的版本是<code>1.24.16</code>或<code>1.25.12</code>，其中etcd升级的版本为<code>3.5.6-0</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./kubeadm upgrade plan
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/config<span style="color:#ce5c00;font-weight:bold">]</span> Making sure the configuration is correct:
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/config<span style="color:#ce5c00;font-weight:bold">]</span> Reading configuration from the cluster...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/config<span style="color:#ce5c00;font-weight:bold">]</span> FYI: You can look at this config file with <span style="color:#4e9a06">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upload-config<span style="color:#ce5c00;font-weight:bold">]</span> Storing the configuration used in ConfigMap <span style="color:#4e9a06">&#34;kubeadm-config&#34;</span> in the <span style="color:#4e9a06">&#34;kube-system&#34;</span> Namespace
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>preflight<span style="color:#ce5c00;font-weight:bold">]</span> Running pre-flight checks.
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade<span style="color:#ce5c00;font-weight:bold">]</span> Running cluster health checks
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade<span style="color:#ce5c00;font-weight:bold">]</span> Fetching available versions to upgrade to
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/versions<span style="color:#ce5c00;font-weight:bold">]</span> Cluster version: v1.24.2
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/versions<span style="color:#ce5c00;font-weight:bold">]</span> kubeadm version: v1.25.12
</span></span><span style="display:flex;"><span>I0815 21:41:34.096199 <span style="color:#0000cf;font-weight:bold">2934255</span> version.go:256<span style="color:#ce5c00;font-weight:bold">]</span> remote version is much newer: v1.27.4<span style="color:#000;font-weight:bold">;</span> falling back to: stable-1.25
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/versions<span style="color:#ce5c00;font-weight:bold">]</span> Target version: v1.25.12
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/versions<span style="color:#ce5c00;font-weight:bold">]</span> Latest version in the v1.24 series: v1.24.16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Components that must be upgraded manually after you have upgraded the control plane with <span style="color:#4e9a06">&#39;kubeadm upgrade apply&#39;</span>:
</span></span><span style="display:flex;"><span>COMPONENT   CURRENT       TARGET
</span></span><span style="display:flex;"><span>kubelet     <span style="color:#0000cf;font-weight:bold">4</span> x v1.24.2   v1.24.16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Upgrade to the latest version in the v1.24 series:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMPONENT                 CURRENT   TARGET
</span></span><span style="display:flex;"><span>kube-apiserver            v1.24.2   v1.24.16
</span></span><span style="display:flex;"><span>kube-controller-manager   v1.24.2   v1.24.16
</span></span><span style="display:flex;"><span>kube-scheduler            v1.24.2   v1.24.16
</span></span><span style="display:flex;"><span>kube-proxy                v1.24.2   v1.24.16
</span></span><span style="display:flex;"><span>CoreDNS                   v1.8.6    v1.9.3
</span></span><span style="display:flex;"><span>etcd                      3.5.3-0   3.5.6-0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You can now apply the upgrade by executing the following command:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    kubeadm upgrade apply v1.24.16
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_____________________________________________________________________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Components that must be upgraded manually after you have upgraded the control plane with <span style="color:#4e9a06">&#39;kubeadm upgrade apply&#39;</span>:
</span></span><span style="display:flex;"><span>COMPONENT   CURRENT       TARGET
</span></span><span style="display:flex;"><span>kubelet     <span style="color:#0000cf;font-weight:bold">4</span> x v1.24.2   v1.25.12
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Upgrade to the latest stable version:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMPONENT                 CURRENT   TARGET
</span></span><span style="display:flex;"><span>kube-apiserver            v1.24.2   v1.25.12
</span></span><span style="display:flex;"><span>kube-controller-manager   v1.24.2   v1.25.12
</span></span><span style="display:flex;"><span>kube-scheduler            v1.24.2   v1.25.12
</span></span><span style="display:flex;"><span>kube-proxy                v1.24.2   v1.25.12
</span></span><span style="display:flex;"><span>CoreDNS                   v1.8.6    v1.9.3
</span></span><span style="display:flex;"><span>etcd                      3.5.3-0   3.5.6-0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You can now apply the upgrade by executing the following command:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    kubeadm upgrade apply v1.25.12
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_____________________________________________________________________
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The table below shows the current state of component configs as understood by this version of kubeadm.
</span></span><span style="display:flex;"><span>Configs that have a <span style="color:#4e9a06">&#34;yes&#34;</span> mark in the <span style="color:#4e9a06">&#34;MANUAL UPGRADE REQUIRED&#34;</span> column require manual config upgrade or
</span></span><span style="display:flex;"><span>resetting to kubeadm defaults before a successful upgrade can be performed. The version to manually
</span></span><span style="display:flex;"><span>upgrade to is denoted in the <span style="color:#4e9a06">&#34;PREFERRED VERSION&#34;</span> column.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>API GROUP                 CURRENT VERSION   PREFERRED VERSION   MANUAL UPGRADE REQUIRED
</span></span><span style="display:flex;"><span>kubeproxy.config.k8s.io   v1alpha1          v1alpha1            no
</span></span><span style="display:flex;"><span>kubelet.config.k8s.io     v1beta1           v1beta1             no
</span></span><span style="display:flex;"><span>_____________________________________________________________________
</span></span></code></pre></div><h1 id="2-版本升级步骤">2. 版本升级步骤</h1>
<h2 id="2-1-准备工作">2.1. 准备工作</h2>
<ol>
<li>
<p>下载指定版本的kubeadm二进制</p>
</li>
<li>
<p>查看升级计划：kubeadm upgrade plan</p>
</li>
</ol>
<h2 id="2-2-升级master节点">2.2. 升级master节点</h2>
<h3 id="2-2-1-升级第一个master节点">2.2.1. 升级第一个master节点</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm upgrade apply v1.25.x -f
</span></span></code></pre></div><p>升级结束会查看都以下输出：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/successful<span style="color:#ce5c00;font-weight:bold">]</span> SUCCESS! Your cluster was upgraded to <span style="color:#4e9a06">&#34;v1.25.x&#34;</span>. Enjoy!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>upgrade/kubelet<span style="color:#ce5c00;font-weight:bold">]</span> Now that your control plane is upgraded, please proceed with upgrading your kubelets <span style="color:#204a87;font-weight:bold">if</span> you haven<span style="color:#a40000">&#39;</span>t already <span style="color:#204a87;font-weight:bold">done</span> so.
</span></span></code></pre></div><h3 id="2-2-2-手动升级你的-cni-驱动插件">2.2.2. 手动升级你的 CNI 驱动插件。</h3>
<p>你的容器网络接口（CNI）驱动应该提供了程序自身的升级说明。 参阅<a href="https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/addons/">插件</a>页面查找你的 CNI 驱动， 并查看是否需要其他升级步骤。</p>
<p>如果 CNI 驱动作为 DaemonSet 运行，则在其他控制平面节点上不需要此步骤。</p>
<h3 id="2-2-3-升级其他master节点">2.2.3. 升级其他master节点</h3>
<p>下载指定版本的kubeadm组件。使用以下命令升级，注意区别于第一个master的升级命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm upgrade node
</span></span></code></pre></div><h3 id="2-2-4-升级master的kubelet组件">2.2.4. 升级master的kubelet组件</h3>
<p>将节点标记为不可调度并驱逐所有负载，准备节点的维护：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将 &lt;node-to-drain&gt; 替换为你要腾空的控制面节点名称</span>
</span></span><span style="display:flex;"><span>kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets
</span></span></code></pre></div><p>下载kubelet和kubectl</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 用最新的补丁版本替换 1.27.x-00 中的 x</span>
</span></span><span style="display:flex;"><span>apt-mark unhold kubelet kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>apt-get update <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> apt-get install -y <span style="color:#000">kubelet</span><span style="color:#ce5c00;font-weight:bold">=</span>1.27.x-00 <span style="color:#000">kubectl</span><span style="color:#ce5c00;font-weight:bold">=</span>1.27.x-00 <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>apt-mark hold kubelet kubectl
</span></span></code></pre></div><p>重启kubelet</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>sudo systemctl restart kubelet
</span></span></code></pre></div><p>解除节点保护</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将 &lt;node-to-uncordon&gt; 替换为你的节点名称</span>
</span></span><span style="display:flex;"><span>kubectl uncordon &lt;node-to-uncordon&gt;
</span></span></code></pre></div><h2 id="2-3-升级worker节点">2.3. 升级worker节点</h2>
<p>同 <code>2.2.4. 升级master的kubelet组件</code>的步骤，worker节点只需要升级kubelet。</p>
<h1 id="3-升级版本回滚">3. 升级版本回滚</h1>
<p>kubeadm升级过程中会把相关目录备份到<code>/etc/kubernetes/tmp</code>目录，备份内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tmp/
</span></span><span style="display:flex;"><span>├── kubeadm-backup-etcd-2023-08-16-14-50-50
</span></span><span style="display:flex;"><span>│   └── etcd
</span></span><span style="display:flex;"><span>└── kubeadm-backup-manifests-2023-08-16-14-50-50
</span></span><span style="display:flex;"><span>    ├── etcd.yaml
</span></span><span style="display:flex;"><span>    ├── kube-apiserver.yaml
</span></span><span style="display:flex;"><span>    ├── kube-controller-manager.yaml
</span></span><span style="display:flex;"><span>    └── kube-scheduler.yaml
</span></span></code></pre></div><p>如果 <code>kubeadm upgrade</code> 失败并且没有回滚，例如由于执行期间节点意外关闭， 你可以再次运行 <code>kubeadm upgrade</code>。 此命令是幂等的，并最终确保实际状态是你声明的期望状态。</p>
<p>要从故障状态恢复，你还可以运行 <code>kubeadm upgrade apply --force</code> 而无需更改集群正在运行的版本。</p>
<p>在升级期间，kubeadm 向 <code>/etc/kubernetes/tmp</code> 目录下的如下备份文件夹写入数据：</p>
<ul>
<li><code>kubeadm-backup-etcd-&lt;date&gt;-&lt;time&gt;</code></li>
<li><code>kubeadm-backup-manifests-&lt;date&gt;-&lt;time&gt;</code></li>
</ul>
<p><code>kubeadm-backup-etcd</code> 包含当前控制面节点本地 etcd 成员数据的备份。 如果 etcd 升级失败并且自动回滚也无法修复，则可以将此文件夹中的内容复制到 <code>/var/lib/etcd</code> 进行手工修复。如果使用的是外部的 etcd，则此备份文件夹为空。</p>
<p><code>kubeadm-backup-manifests</code> 包含当前控制面节点的静态 Pod 清单文件的备份版本。 如果升级失败并且无法自动回滚，则此文件夹中的内容可以复制到 <code>/etc/kubernetes/manifests</code> 目录实现手工恢复。 如果由于某些原因，在升级前后某个组件的清单未发生变化，则 kubeadm 也不会为之生成备份版本。</p>
<h1 id="4-问题排查">4. 问题排查</h1>
<p>在升级k8s 从1.25.12到1.26.7的过程中，遇到master节点的服务起不来，报错如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#4e9a06">&#34;CreatePodSandbox for pod failed&#34;</span> <span style="color:#000">err</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;open /run/systemd/resolve/resolv.conf: no such file or directory&#34;</span> <span style="color:#000">pod</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;kube-system/kube-apiserver&#34;</span>
</span></span></code></pre></div><p>现象主要是静态pod起不来，包括etcd等。</p>
<p>具体解决方法参考：<a href="https://ask.kubesphere.io/forum/d/6474-v321masterrunsystemdresolvconfworker/3">open /run/systemd/resolve/resolv.conf</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看以下的resolv.conf是否存在</span>
</span></span><span style="display:flex;"><span>cat /var/lib/kubelet/config.yaml <span style="color:#000;font-weight:bold">|</span> grep resolvConf
</span></span><span style="display:flex;"><span>/run/systemd/resolve/resolv.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果不存在，检查systemd-resolved是否正常运行，</span>
</span></span><span style="display:flex;"><span>systemctl status systemd-resolved
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果没有运行，则运行该服务</span>
</span></span><span style="display:flex;"><span>systemctl start systemd-resolved
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或者新建文件/run/systemd/resolve/resolv.conf，并将其他master的文件拷贝过来。</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/">升级 kubeadm 集群 | Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/upgrading-linux-nodes/">升级 Linux 节点 | Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/addons/">安装扩展（Addon） | Kubernetes</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8b5896446b13b6b1c7a2979417ce8141">2.3 - k8s证书及秘钥</h1>
    
	<h1 id="1-证书分类">1. 证书分类</h1>
<ul>
<li>
<p>服务器证书：server cert，用于客户端验证服务端的身份。</p>
</li>
<li>
<p>客户端证书：client cert，用于服务端验证客户端的身份。</p>
</li>
<li>
<p>对等证书：peer cert（既是<code>server cert</code>又是<code>client cert</code>），用户成员之间的身份验证，例如 etcd。</p>
</li>
</ul>
<h2 id="1-1-k8s集群的证书分类">1.1. k8s集群的证书分类</h2>
<ul>
<li><code>etcd节点</code>：需要标识自己服务的<code>server cert</code>，也需要<code>client cert</code>与<code>etcd</code>集群其他节点交互，因此需要一个对等证书。</li>
<li><code>master节点</code>：需要标识 apiserver服务的<code>server cert</code>，也需要<code>client cert</code>连接<code>etcd</code>集群，也需要一个对等证书。</li>
<li><code>kubelet</code>：需要标识自己服务的<code>server cert</code>，也需要<code>client cert</code>请求<code>apiserver</code>，也使用一个对等证书。</li>
<li><code>kubectl、kube-proxy、calico</code>：需要client证书。</li>
</ul>
<h1 id="2-ca证书及秘钥">2. CA证书及秘钥</h1>
<p>目录：<code>/etc/kubernetes/ssl</code></p>
<table>
<thead>
<tr>
<th>分类</th>
<th>证书/秘钥</th>
<th>说明</th>
<th>组件</th>
</tr>
</thead>
<tbody>
<tr>
<td>ca</td>
<td>ca-key.pem</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>ca.pem</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>ca.csr</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Kubernetes</td>
<td>kubernetes-key.pem</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>kubernetes.pem</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>kubernetes.csr</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Admin</td>
<td>admin-key.pem</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>admin.pem</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>admin.csr</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Kubelet</td>
<td>kubelet.crt</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>kubelet.key</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>配置文件</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>证书/秘钥</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ca</td>
<td>ca-config.json</td>
<td></td>
</tr>
<tr>
<td></td>
<td>ca-csr.json</td>
<td></td>
</tr>
<tr>
<td>Kubernetes</td>
<td>kubernetes-csr.json</td>
<td></td>
</tr>
<tr>
<td>Admin</td>
<td>admin-csr.json</td>
<td></td>
</tr>
<tr>
<td>Kube-proxy</td>
<td>kube-proxy-csr.json</td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="3-cfssl工具">3. cfssl工具</h1>
<p>安装cfssl：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下载cfssl</span>
</span></span><span style="display:flex;"><span>$ curl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -o /usr/local/bin/cfssl
</span></span><span style="display:flex;"><span>$ curl https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -o /usr/local/bin/cfssljson
</span></span><span style="display:flex;"><span>$ curl https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -o /usr/local/bin/cfssl-certinfo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加可执行权限</span>
</span></span><span style="display:flex;"><span>$ chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson /usr/local/bin/cfssl-certinfo
</span></span></code></pre></div><h1 id="4-创建-ca-certificate-authority">4. 创建 CA (Certificate Authority)</h1>
<h2 id="4-1-配置源文件">4.1. 配置源文件</h2>
<p><strong>创建 CA 配置文件</strong></p>
<p><strong>ca-config.json</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a40000">cat</span> <span style="color:#a40000">&lt;&lt;</span> <span style="color:#a40000">EOF</span> <span style="color:#a40000">&gt;</span> <span style="color:#a40000">ca-config.json</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;signing&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;default&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;expiry&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;87600h&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;profiles&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;kubernetes&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;usages&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;signing&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;key encipherment&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;server auth&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;client auth&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;expiry&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;876000h&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">EOF</span>
</span></span></code></pre></div><p><strong>参数说明</strong></p>
<ul>
<li><code>ca-config.json</code>：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；</li>
<li><code>signing</code>：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 <code>CA=TRUE</code>；</li>
<li><code>server auth</code>：表示client可以用该 CA 对server提供的证书进行验证；</li>
<li><code>client auth</code>：表示server可以用该CA对client提供的证书进行验证；</li>
</ul>
<p><strong>创建 CA 证书签名请求</strong></p>
<p><strong>ca-csr.json</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt; EOF &gt; ca-csr.json
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">{
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;CN&#34;: &#34;kubernetes&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  },
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    {
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      &#34;ST&#34;: &#34;ShenZhen&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      &#34;L&#34;: &#34;ShenZhen&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      &#34;O&#34;: &#34;k8s&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    }
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  ]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">}
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><p><strong>参数说明</strong></p>
<p>ca-csr.json的参数</p>
<ul>
<li>CN：<code>Common Name</code>，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</li>
</ul>
<p>names中的字段：</p>
<ul>
<li>C : country，国家</li>
<li>ST: state，州或省份</li>
<li>L：location，城市</li>
<li>O：organization，组织，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)</li>
<li>OU：organization unit</li>
</ul>
<h2 id="4-2-执行命令">4.2. 执行命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cfssl gencert -initca ca-csr.json <span style="color:#000;font-weight:bold">|</span> cfssljson -bare ca
</span></span></code></pre></div><p>输出如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span>
</span></span><span style="display:flex;"><span>2019/12/13 14:35:52 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> generating a new CA key and certificate from CSR
</span></span><span style="display:flex;"><span>2019/12/13 14:35:52 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> generate received request
</span></span><span style="display:flex;"><span>2019/12/13 14:35:52 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> received CSR
</span></span><span style="display:flex;"><span>2019/12/13 14:35:52 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> generating key: rsa-2048
</span></span><span style="display:flex;"><span>2019/12/13 14:35:52 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> encoded CSR
</span></span><span style="display:flex;"><span>2019/12/13 14:35:52 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> signed certificate with serial number <span style="color:#0000cf;font-weight:bold">248379771349454958117219047414671162179070747780</span>
</span></span></code></pre></div><p>生成以下文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 生成文件</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">1005</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 11:32 ca.csr
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">1675</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 11:32 ca-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">1363</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 11:32 ca.pem
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 配置源文件</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root  <span style="color:#0000cf;font-weight:bold">293</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 11:31 ca-config.json
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root  <span style="color:#0000cf;font-weight:bold">210</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 11:31 ca-csr.json
</span></span></code></pre></div><h1 id="5-创建-kubernetes-证书">5. 创建 kubernetes 证书</h1>
<h2 id="5-1-配置源文件">5.1. 配置源文件</h2>
<p>创建 kubernetes 证书签名请求文件kubernetes-csr.json。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">cat &lt;&lt; EOF &gt; kubernetes-csr.json</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>{<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">&#34;CN&#34;: </span><span style="color:#4e9a06">&#34;kubernetes&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">&#34;hosts&#34;: </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;&lt;MASTER_IP&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;&lt;MASTER_CLUSTER_IP&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> 
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;kubernetes&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;kubernetes.default&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;kubernetes.default.svc&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;kubernetes.default.svc.cluster&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#4e9a06">&#34;kubernetes.default.svc.cluster.local&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">],</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">&#34;key&#34;: </span>{<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">&#34;algo&#34;: </span><span style="color:#4e9a06">&#34;rsa&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">&#34;size&#34;: </span><span style="color:#0000cf;font-weight:bold">2048</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">&#34;names&#34;: </span><span style="color:#000;font-weight:bold">[</span>{<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">&#34;C&#34;: </span><span style="color:#4e9a06">&#34;&lt;country&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">&#34;ST&#34;: </span><span style="color:#4e9a06">&#34;&lt;state&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">&#34;L&#34;: </span><span style="color:#4e9a06">&#34;&lt;city&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">&#34;O&#34;: </span><span style="color:#4e9a06">&#34;&lt;organization&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">&#34;OU&#34;: </span><span style="color:#4e9a06">&#34;&lt;organization unit&gt;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">EOF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>参数说明：</p>
<ul>
<li><code>MASTER_IP</code>：master节点的IP或域名</li>
<li><code>MASTER_CLUSTER_IP</code>：<code>kube-apiserver</code> 指定的 <code>service-cluster-ip-range</code> 网段的第一个IP，例如（10.254.0.1）。</li>
</ul>
<h2 id="5-2-执行命令">5.2. 执行命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#ce5c00;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#ce5c00;font-weight:bold">=</span>ca-key.pem -config<span style="color:#ce5c00;font-weight:bold">=</span>ca-config.json -profile<span style="color:#ce5c00;font-weight:bold">=</span>kubernetes kubernetes-csr.json <span style="color:#000;font-weight:bold">|</span> cfssljson -bare kubernetes
</span></span></code></pre></div><p>输出如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span>
</span></span><span style="display:flex;"><span>2019/12/13 14:40:28 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> generate received request
</span></span><span style="display:flex;"><span>2019/12/13 14:40:28 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> received CSR
</span></span><span style="display:flex;"><span>2019/12/13 14:40:28 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> generating key: rsa-2048
</span></span><span style="display:flex;"><span>2019/12/13 14:40:28 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> encoded CSR
</span></span><span style="display:flex;"><span>2019/12/13 14:40:28 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> signed certificate with serial number <span style="color:#0000cf;font-weight:bold">392795299385191732458211386861696542628305189374</span>
</span></span><span style="display:flex;"><span>2019/12/13 14:40:28 <span style="color:#ce5c00;font-weight:bold">[</span>WARNING<span style="color:#ce5c00;font-weight:bold">]</span> This certificate lacks a <span style="color:#4e9a06">&#34;hosts&#34;</span> field. This makes it unsuitable <span style="color:#204a87;font-weight:bold">for</span>
</span></span><span style="display:flex;"><span>websites. For more information see the Baseline Requirements <span style="color:#204a87;font-weight:bold">for</span> the Issuance and Management
</span></span><span style="display:flex;"><span>of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span style="color:#ce5c00;font-weight:bold">(</span>https://cabforum.org<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>specifically, section 10.2.3 <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Information Requirements&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span></code></pre></div><p>生成以下文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 生成文件</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">1269</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 14:40 kubernetes.csr
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">1679</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 14:40 kubernetes-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">1643</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 14:40 kubernetes.pem
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 配置源文件</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root  <span style="color:#0000cf;font-weight:bold">580</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 14:40 kubernetes-csr.json
</span></span></code></pre></div><h1 id="6-创建-admin-证书">6. 创建 admin 证书</h1>
<h2 id="6-1-配置源文件">6.1. 配置源文件</h2>
<p>创建 admin 证书签名请求文件 <code>admin-csr.json</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt; EOF &gt; admin-csr.json
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">{
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;CN&#34;: &#34;admin&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;hosts&#34;: [],
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;key&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;algo&#34;: &#34;rsa&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;size&#34;: 2048
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  },
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;names&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    {
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      &#34;C&#34;: &#34;CN&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      &#34;ST&#34;: &#34;ShenZhen&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      &#34;L&#34;: &#34;ShenZhen&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      &#34;O&#34;: &#34;system:masters&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      &#34;OU&#34;: &#34;System&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    }
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  ]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">}
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><h2 id="6-2-执行命令">6.2. 执行命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#ce5c00;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#ce5c00;font-weight:bold">=</span>ca-key.pem -config<span style="color:#ce5c00;font-weight:bold">=</span>ca-config.json -profile<span style="color:#ce5c00;font-weight:bold">=</span>kubernetes admin-csr.json <span style="color:#000;font-weight:bold">|</span> cfssljson -bare admin
</span></span></code></pre></div><p>输出如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span>
</span></span><span style="display:flex;"><span>2019/12/13 14:52:37 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> generate received request
</span></span><span style="display:flex;"><span>2019/12/13 14:52:37 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> received CSR
</span></span><span style="display:flex;"><span>2019/12/13 14:52:37 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> generating key: rsa-2048
</span></span><span style="display:flex;"><span>2019/12/13 14:52:37 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> encoded CSR
</span></span><span style="display:flex;"><span>2019/12/13 14:52:37 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> signed certificate with serial number <span style="color:#0000cf;font-weight:bold">465422983473444224050765004141217688748259757371</span>
</span></span><span style="display:flex;"><span>2019/12/13 14:52:37 <span style="color:#ce5c00;font-weight:bold">[</span>WARNING<span style="color:#ce5c00;font-weight:bold">]</span> This certificate lacks a <span style="color:#4e9a06">&#34;hosts&#34;</span> field. This makes it unsuitable <span style="color:#204a87;font-weight:bold">for</span>
</span></span><span style="display:flex;"><span>websites. For more information see the Baseline Requirements <span style="color:#204a87;font-weight:bold">for</span> the Issuance and Management
</span></span><span style="display:flex;"><span>of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span style="color:#ce5c00;font-weight:bold">(</span>https://cabforum.org<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>specifically, section 10.2.3 <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Information Requirements&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span></code></pre></div><p>生成文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 生成文件</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">1013</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 14:52 admin.csr
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">1675</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 14:52 admin-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">1407</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 14:52 admin.pem
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 配置源文件</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root  <span style="color:#0000cf;font-weight:bold">231</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 14:49 admin-csr.json
</span></span></code></pre></div><h1 id="7-创建-kube-proxy-证书">7. 创建 kube-proxy 证书</h1>
<h2 id="7-1-配置源文件">7.1. 配置源文件</h2>
<p>创建 kube-proxy 证书签名请求文件 <code>kube-proxy-csr.json</code>：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">cat &lt;&lt; EOF &gt; kube-proxy-csr.json</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>{<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">&#34;CN&#34;: </span><span style="color:#4e9a06">&#34;system:kube-proxy&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">&#34;hosts&#34;: </span><span style="color:#000;font-weight:bold">[],</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">&#34;key&#34;: </span>{<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">&#34;algo&#34;: </span><span style="color:#4e9a06">&#34;rsa&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">&#34;size&#34;: </span><span style="color:#0000cf;font-weight:bold">2048</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>}<span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">&#34;names&#34;: </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>{<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">&#34;C&#34;: </span><span style="color:#4e9a06">&#34;CN&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">&#34;ST&#34;: </span><span style="color:#4e9a06">&#34;BeiJing&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">&#34;L&#34;: </span><span style="color:#4e9a06">&#34;BeiJing&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">&#34;O&#34;: </span><span style="color:#4e9a06">&#34;k8s&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">&#34;OU&#34;: </span><span style="color:#4e9a06">&#34;System&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">EOF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="7-2-执行命令">7.2. 执行命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cfssl gencert -ca<span style="color:#ce5c00;font-weight:bold">=</span>ca.pem -ca-key<span style="color:#ce5c00;font-weight:bold">=</span>ca-key.pem -config<span style="color:#ce5c00;font-weight:bold">=</span>ca-config.json -profile<span style="color:#ce5c00;font-weight:bold">=</span>kubernetes  kube-proxy-csr.json <span style="color:#000;font-weight:bold">|</span> cfssljson -bare kube-proxy
</span></span></code></pre></div><p>输出如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span>
</span></span><span style="display:flex;"><span>2019/12/13 19:37:48 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> generate received request
</span></span><span style="display:flex;"><span>2019/12/13 19:37:48 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> received CSR
</span></span><span style="display:flex;"><span>2019/12/13 19:37:48 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> generating key: rsa-2048
</span></span><span style="display:flex;"><span>2019/12/13 19:37:48 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> encoded CSR
</span></span><span style="display:flex;"><span>2019/12/13 19:37:48 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> signed certificate with serial number <span style="color:#0000cf;font-weight:bold">526712749765692443642491255093816136154324531741</span>
</span></span><span style="display:flex;"><span>2019/12/13 19:37:48 <span style="color:#ce5c00;font-weight:bold">[</span>WARNING<span style="color:#ce5c00;font-weight:bold">]</span> This certificate lacks a <span style="color:#4e9a06">&#34;hosts&#34;</span> field. This makes it unsuitable <span style="color:#204a87;font-weight:bold">for</span>
</span></span><span style="display:flex;"><span>websites. For more information see the Baseline Requirements <span style="color:#204a87;font-weight:bold">for</span> the Issuance and Management
</span></span><span style="display:flex;"><span>of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span style="color:#ce5c00;font-weight:bold">(</span>https://cabforum.org<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>specifically, section 10.2.3 <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Information Requirements&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span></code></pre></div><p>生成文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 生成文件</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">1009</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 19:37 kube-proxy.csr
</span></span><span style="display:flex;"><span>-rw------- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">1675</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 19:37 kube-proxy-key.pem
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">1407</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 19:37 kube-proxy.pem
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 配置源文件</span>
</span></span><span style="display:flex;"><span>-rw-r--r-- <span style="color:#0000cf;font-weight:bold">1</span> root root  <span style="color:#0000cf;font-weight:bold">230</span> 12月 <span style="color:#0000cf;font-weight:bold">13</span> 19:37 kube-proxy-csr.json
</span></span></code></pre></div><h1 id="8-校验证书">8. 校验证书</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>openssl x509  -noout -text -in  kubernetes.pem
</span></span></code></pre></div><p>输出如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># openssl x509  -noout -text -in  kubernetes.pem</span>
</span></span><span style="display:flex;"><span>Certificate:
</span></span><span style="display:flex;"><span>    Data:
</span></span><span style="display:flex;"><span>        Version: <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">(</span>0x2<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        Serial Number:
</span></span><span style="display:flex;"><span>            44:cd:8c:e6:a4:60:ff:3f:09:af:02:e7:68:5e:f2:0f:e6:a0:39:fe
</span></span><span style="display:flex;"><span>    Signature Algorithm: sha256WithRSAEncryption
</span></span><span style="display:flex;"><span>        Issuer: <span style="color:#000">C</span><span style="color:#ce5c00;font-weight:bold">=</span>CN, <span style="color:#000">ST</span><span style="color:#ce5c00;font-weight:bold">=</span>ShenZhen, <span style="color:#000">L</span><span style="color:#ce5c00;font-weight:bold">=</span>ShenZhen, <span style="color:#000">O</span><span style="color:#ce5c00;font-weight:bold">=</span>k8s, <span style="color:#000">OU</span><span style="color:#ce5c00;font-weight:bold">=</span>System, <span style="color:#000">CN</span><span style="color:#ce5c00;font-weight:bold">=</span>kubernetes
</span></span><span style="display:flex;"><span>        Validity
</span></span><span style="display:flex;"><span>            Not Before: Dec <span style="color:#0000cf;font-weight:bold">13</span> 06:35:00 <span style="color:#0000cf;font-weight:bold">2019</span> GMT
</span></span><span style="display:flex;"><span>            Not After : Nov <span style="color:#0000cf;font-weight:bold">19</span> 06:35:00 <span style="color:#0000cf;font-weight:bold">2119</span> GMT
</span></span><span style="display:flex;"><span>        Subject: <span style="color:#000">C</span><span style="color:#ce5c00;font-weight:bold">=</span>CN, <span style="color:#000">ST</span><span style="color:#ce5c00;font-weight:bold">=</span>ShenZhen, <span style="color:#000">L</span><span style="color:#ce5c00;font-weight:bold">=</span>ShenZhen, <span style="color:#000">O</span><span style="color:#ce5c00;font-weight:bold">=</span>k8s, <span style="color:#000">OU</span><span style="color:#ce5c00;font-weight:bold">=</span>System, <span style="color:#000">CN</span><span style="color:#ce5c00;font-weight:bold">=</span>kubernetes
</span></span><span style="display:flex;"><span>        Subject Public Key Info:
</span></span><span style="display:flex;"><span>            Public Key Algorithm: rsaEncryption
</span></span><span style="display:flex;"><span>                Public-Key: <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2048</span> bit<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                Modulus:
</span></span><span style="display:flex;"><span>                    00:d7:91:4f:90:56:fb:ab:a9:de:c4:98:9e:d7:e6:
</span></span><span style="display:flex;"><span>                    45:db:5a:14:9a:76:78:6a:4c:db:3c:47:3c:e7:1c:
</span></span><span style="display:flex;"><span>                    3c:37:4e:8a:cf:9c:a1:8a:4c:51:4c:cd:45:b0:03:
</span></span><span style="display:flex;"><span>                    87:06:b9:20:2c:3a:51:f9:21:55:1c:90:7c:f8:93:
</span></span><span style="display:flex;"><span>                    bc:6a:48:05:3d:8b:74:fd:f2:f1:e6:5e:ad:b4:a8:
</span></span><span style="display:flex;"><span>                    f6:6d:f9:63:9e:e4:b4:cc:68:9e:90:d7:ef:de:ce:
</span></span><span style="display:flex;"><span>                    c1:1d:1b:68:59:68:5e:5f:7d:5c:f3:49:4f:18:72:
</span></span><span style="display:flex;"><span>                    be:b5:c8:af:e2:8d:34:9c:d2:68:b7:8c:26:69:cc:
</span></span><span style="display:flex;"><span>                    a5:f4:ca:69:2d:d7:21:f5:19:2e:b2:b5:97:16:87:
</span></span><span style="display:flex;"><span>                    9f:9c:fd:01:97:c2:0e:20:b4:88:27:9a:37:9a:af:
</span></span><span style="display:flex;"><span>                    0a:cf:82:4f:26:24:cb:07:ac:8c:b1:34:20:42:22:
</span></span><span style="display:flex;"><span>                    00:b2:b0:98:c5:53:01:fb:32:aa:15:1b:7e:39:44:
</span></span><span style="display:flex;"><span>                    ae:af:6e:c3:65:96:f6:38:7a:87:37:d0:31:63:d8:
</span></span><span style="display:flex;"><span>                    a4:15:13:f2:56:da:e6:09:45:2b:46:2c:cb:63:db:
</span></span><span style="display:flex;"><span>                    f7:ba:7f:44:0a:36:39:7c:cc:5b:42:e5:56:c7:7f:
</span></span><span style="display:flex;"><span>                    dd:64:5c:f2:4a:af:d3:a9:d1:6e:06:27:57:09:4d:
</span></span><span style="display:flex;"><span>                    db:08:62:87:66:c8:2c:36:00:41:f1:90:f6:5f:68:
</span></span><span style="display:flex;"><span>                    20:3d
</span></span><span style="display:flex;"><span>                Exponent: <span style="color:#0000cf;font-weight:bold">65537</span> <span style="color:#ce5c00;font-weight:bold">(</span>0x10001<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        X509v3 extensions:
</span></span><span style="display:flex;"><span>            X509v3 Key Usage: critical
</span></span><span style="display:flex;"><span>                Digital Signature, Key Encipherment
</span></span><span style="display:flex;"><span>            X509v3 Extended Key Usage:
</span></span><span style="display:flex;"><span>                TLS Web Server Authentication, TLS Web Client Authentication
</span></span><span style="display:flex;"><span>            X509v3 Basic Constraints: critical
</span></span><span style="display:flex;"><span>                CA:FALSE
</span></span><span style="display:flex;"><span>            X509v3 Subject Key Identifier:
</span></span><span style="display:flex;"><span>                3D:3F:FA:B8:36:D7:FE:B1:59:BE:B1:F5:C1:5D:88:3D:BC:78:9F:87
</span></span><span style="display:flex;"><span>            X509v3 Authority Key Identifier:
</span></span><span style="display:flex;"><span>                keyid:40:A2:D4:30:22:12:2E:C2:FB:A2:55:2C:CB:F0:F6:3E:4D:B8:02:03
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            X509v3 Subject Alternative Name:
</span></span><span style="display:flex;"><span>                DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster, DNS:kubernetes.default.svc.cluster.local, IP Address:127.0.0.1, IP Address:172.20.0.112, IP Address:172.20.0.113, IP Address:172.20.0.114, IP Address:172.20.0.115, IP Address:10.254.0.1
</span></span><span style="display:flex;"><span>    Signature Algorithm: sha256WithRSAEncryption
</span></span><span style="display:flex;"><span>         63:50:f6:2a:03:c7:35:dd:e9:10:8d:2f:b3:27:9a:64:f3:e1:
</span></span><span style="display:flex;"><span>         11:8a:18:1e:fa:6d:85:30:11:b4:59:a3:6c:86:cd:2b:5c:67:
</span></span><span style="display:flex;"><span>         17:4f:aa:0d:bb:4c:ee:c8:af:e7:3d:61:6d:03:9d:14:6f:00:
</span></span><span style="display:flex;"><span>         48:56:59:b5:76:13:a9:30:23:e0:b2:d2:12:64:0c:60:0d:76:
</span></span><span style="display:flex;"><span>         ec:c6:4f:b1:bc:24:01:7a:48:c6:fd:9e:5d:68:da:b9:a1:ad:
</span></span><span style="display:flex;"><span>         30:7a:ba:90:e2:e3:4e:b4:92:1b:c5:f2:8c:c1:b0:3d:fc:14:
</span></span><span style="display:flex;"><span>         d2:46:e8:f8:22:8f:d9:4d:85:4f:58:6b:0f:84:78:06:b4:b9:
</span></span><span style="display:flex;"><span>         92:b9:0d:bd:1d:95:e9:0d:42:d3:fd:dd:2a:59:60:3f:63:35:
</span></span><span style="display:flex;"><span>         eb:07:25:d2:ea:0d:19:a6:f3:dc:92:8e:ee:73:04:15:5e:97:
</span></span><span style="display:flex;"><span>         e8:da:51:c3:69:49:96:36:c7:cc:5b:e5:e5:cb:e5:ce:9f:21:
</span></span><span style="display:flex;"><span>         6f:6b:56:16:bf:85:ad:1c:8c:91:c1:91:0a:90:18:e2:4a:b0:
</span></span><span style="display:flex;"><span>         32:58:33:ef:55:8e:8f:4a:e3:0f:b8:f7:41:04:65:89:e1:1b:
</span></span><span style="display:flex;"><span>         d8:41:28:6e:84:c3:1c:8e:a9:a0:8a:42:e4:fe:d7:fe:0e:24:
</span></span><span style="display:flex;"><span>         dc:74:37:fa:5e:be:20:69:c5:9a:5a:e6:83:1c:0b:9e:e1:43:
</span></span><span style="display:flex;"><span>         ef:4f:7a:37
</span></span></code></pre></div><p>字段说明：</p>
<ul>
<li>确认 <code>Issuer</code> 字段的内容和 <code>ca-csr.json</code> 一致；</li>
<li>确认 <code>Subject</code> 字段的内容和 <code>kubernetes-csr.json</code> 一致；</li>
<li>确认 <code>X509v3 Subject Alternative Name</code> 字段的内容和 <code>kubernetes-csr.json</code> 一致；</li>
<li>确认 <code>X509v3 Key Usage、Extended Key Usage</code> 字段的内容和 <code>ca-config.json</code> 中 <code>kubernetes</code> profile 一致；</li>
</ul>
<h1 id="9-分发证书">9. 分发证书</h1>
<p>将生成的证书和秘钥文件（后缀名为<code>.pem</code>）拷贝到所有机器的 <code>/etc/kubernetes/ssl</code> 目录下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /etc/kubernetes/ssl
</span></span><span style="display:flex;"><span>cp *.pem /etc/kubernetes/ssl
</span></span></code></pre></div><p>参考文章：</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/cluster-administration/certificates/">https://kubernetes.io/docs/concepts/cluster-administration/certificates/</a></li>
<li><a href="https://coreos.com/os/docs/latest/generate-self-signed-certificates.html">https://coreos.com/os/docs/latest/generate-self-signed-certificates.html</a></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/practice/create-tls-and-secret-key.html">https://jimmysong.io/kubernetes-handbook/practice/create-tls-and-secret-key.html</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ac77b6330ad5ce632acdc4c0ae8b80df">2.4 - kubeadm管理证书</h1>
    
	<p>通过kubeadm搭建的集群<strong>默认的证书时间是1年</strong>（由于官方期望每年更新一次k8s的版本，在更新的时候会默认更新证书），当你执行命令出现以下报错，说明你的证书已经到期了，则需要手动更新证书。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get node</span>
</span></span><span style="display:flex;"><span>Unable to connect to the server: x509: certificate has expired or is not yet valid: current <span style="color:#204a87">time</span> 2023-08-03T18:06:23+08:00 is after 2023-07-04T06:30:54Z
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或者出现以下报错</span>
</span></span><span style="display:flex;"><span>You must be logged in to the server<span style="color:#ce5c00;font-weight:bold">(</span>unauthorized<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>以下说明手动更新证书的流程。</p>
<p>具体可以参考：<a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/">使用 kubeadm 进行证书管理 | Kubernetes</a></p>
<h1 id="1-检查证书是否过期">1. 检查证书是否过期</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm certs check-expiration
</span></span></code></pre></div><p>会输出以下的内容：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>CERTIFICATE                EXPIRES                  RESIDUAL TIME   CERTIFICATE AUTHORITY   EXTERNALLY MANAGED
</span></span><span style="display:flex;"><span>admin.conf                 Dec 30, <span style="color:#0000cf;font-weight:bold">2020</span> 23:36 UTC   364d                                    no
</span></span><span style="display:flex;"><span>apiserver                  Dec 30, <span style="color:#0000cf;font-weight:bold">2020</span> 23:36 UTC   364d            ca                      no
</span></span><span style="display:flex;"><span>apiserver-etcd-client      Dec 30, <span style="color:#0000cf;font-weight:bold">2020</span> 23:36 UTC   364d            etcd-ca                 no
</span></span><span style="display:flex;"><span>apiserver-kubelet-client   Dec 30, <span style="color:#0000cf;font-weight:bold">2020</span> 23:36 UTC   364d            ca                      no
</span></span><span style="display:flex;"><span>controller-manager.conf    Dec 30, <span style="color:#0000cf;font-weight:bold">2020</span> 23:36 UTC   364d                                    no
</span></span><span style="display:flex;"><span>etcd-healthcheck-client    Dec 30, <span style="color:#0000cf;font-weight:bold">2020</span> 23:36 UTC   364d            etcd-ca                 no
</span></span><span style="display:flex;"><span>etcd-peer                  Dec 30, <span style="color:#0000cf;font-weight:bold">2020</span> 23:36 UTC   364d            etcd-ca                 no
</span></span><span style="display:flex;"><span>etcd-server                Dec 30, <span style="color:#0000cf;font-weight:bold">2020</span> 23:36 UTC   364d            etcd-ca                 no
</span></span><span style="display:flex;"><span>front-proxy-client         Dec 30, <span style="color:#0000cf;font-weight:bold">2020</span> 23:36 UTC   364d            front-proxy-ca          no
</span></span><span style="display:flex;"><span>scheduler.conf             Dec 30, <span style="color:#0000cf;font-weight:bold">2020</span> 23:36 UTC   364d                                    no
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CERTIFICATE AUTHORITY   EXPIRES                  RESIDUAL TIME   EXTERNALLY MANAGED
</span></span><span style="display:flex;"><span>ca                      Dec 28, <span style="color:#0000cf;font-weight:bold">2029</span> 23:36 UTC   9y              no
</span></span><span style="display:flex;"><span>etcd-ca                 Dec 28, <span style="color:#0000cf;font-weight:bold">2029</span> 23:36 UTC   9y              no
</span></span><span style="display:flex;"><span>front-proxy-ca          Dec 28, <span style="color:#0000cf;font-weight:bold">2029</span> 23:36 UTC   9y              no
</span></span></code></pre></div><h1 id="2-手动更新过期的证书">2. 手动更新过期的证书</h1>
<p>分别在<code>master节点</code>执行以下命令。</p>
<h2 id="2-1-备份-etc-kubernetes-目录">2.1. 备份<code>/etc/kubernetes</code>目录</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cp -fr /etc/kubernetes /etc/kubernetes.bak
</span></span><span style="display:flex;"><span>cp -fr ~/.kube ~/.kube.bak
</span></span></code></pre></div><h2 id="2-2-执行更新证书命令">2.2. 执行更新证书命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubeadm certs renew all
</span></span></code></pre></div><p>输出如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubeadm certs renew all</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>renew<span style="color:#ce5c00;font-weight:bold">]</span> Reading configuration from the cluster...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>renew<span style="color:#ce5c00;font-weight:bold">]</span> FYI: You can look at this config file with <span style="color:#4e9a06">&#39;kubectl -n kube-system get cm kubeadm-config -o yaml&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>renew<span style="color:#ce5c00;font-weight:bold">]</span> Error reading configuration from the Cluster. Falling back to default configuration
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>certificate embedded in the kubeconfig file <span style="color:#204a87;font-weight:bold">for</span> the admin to use and <span style="color:#204a87;font-weight:bold">for</span> kubeadm itself renewed
</span></span><span style="display:flex;"><span>certificate <span style="color:#204a87;font-weight:bold">for</span> serving the Kubernetes API renewed
</span></span><span style="display:flex;"><span>certificate the apiserver uses to access etcd renewed
</span></span><span style="display:flex;"><span>certificate <span style="color:#204a87;font-weight:bold">for</span> the API server to connect to kubelet renewed
</span></span><span style="display:flex;"><span>certificate embedded in the kubeconfig file <span style="color:#204a87;font-weight:bold">for</span> the controller manager to use renewed
</span></span><span style="display:flex;"><span>certificate <span style="color:#204a87;font-weight:bold">for</span> liveness probes to healthcheck etcd renewed
</span></span><span style="display:flex;"><span>certificate <span style="color:#204a87;font-weight:bold">for</span> etcd nodes to communicate with each other renewed
</span></span><span style="display:flex;"><span>certificate <span style="color:#204a87;font-weight:bold">for</span> serving etcd renewed
</span></span><span style="display:flex;"><span>certificate <span style="color:#204a87;font-weight:bold">for</span> the front proxy client renewed
</span></span><span style="display:flex;"><span>certificate embedded in the kubeconfig file <span style="color:#204a87;font-weight:bold">for</span> the scheduler manager to use renewed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Done renewing certificates. You must restart the kube-apiserver, kube-controller-manager, kube-scheduler and etcd, so that they can use the new certificates.
</span></span></code></pre></div><h2 id="2-3-重启k8s组件">2.3. 重启k8s组件</h2>
<p><strong>先重启etcd</strong></p>
<p><strong>注意事项：需要将三个master节点的证书都重新更新后，然后三个master的etcd服务一起重启，使得etcd集群使用新的证书可以正常运行，否则会导致kube-apiserver也启动失败。</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>crictl ps <span style="color:#000;font-weight:bold">|</span>grep <span style="color:#4e9a06">&#34;etcd&#34;</span><span style="color:#000;font-weight:bold">|</span>awk <span style="color:#4e9a06">&#39;{print $1}&#39;</span><span style="color:#000;font-weight:bold">|</span>xargs crictl stop 
</span></span></code></pre></div><p>再重启kube-apiserver、kube-controller、kube-scheduler容器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>crictl ps <span style="color:#000;font-weight:bold">|</span>egrep <span style="color:#4e9a06">&#34;kube-apiserver|kube-scheduler|kube-controller&#34;</span><span style="color:#000;font-weight:bold">|</span>awk <span style="color:#4e9a06">&#39;{print $1}&#39;</span><span style="color:#000;font-weight:bold">|</span>xargs crictl stop 
</span></span></code></pre></div><h2 id="2-4-更新默认的kubeconfig文件">2.4. 更新默认的kubeconfig文件</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cp -fr /etc/kubernetes/admin.conf <span style="color:#000">$HOME</span>/.kube/config
</span></span></code></pre></div><h2 id="2-5-配置kubelet证书轮转">2.5. 配置kubelet证书轮转</h2>
<p>由于kubelet默认支持证书轮转，当证书过期时，可以自动生成新的密钥，并从 Kubernetes API 申请新的证书。可以查看kubelet的配置检查是否已经开启。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cat /var/lib/kubelet/config.yaml |grep rotate</span>
</span></span><span style="display:flex;"><span>rotateCertificates: <span style="color:#204a87">true</span>
</span></span></code></pre></div><h1 id="3-修改kubeadm源码证书时间">3. 修改kubeadm源码证书时间</h1>
<p>由于社区不允许用户配置超过1年的证书，因此自定义证书时间的参数不被允许开发。</p>
<p>相关issue如下：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/issues/119350">https://github.com/kubernetes/kubernetes/issues/119350</a></li>
</ul>
<p>如果要实现自定义参数设置证书时间，可参考一下pr：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/pull/100907/files">https://github.com/kubernetes/kubernetes/pull/100907/files</a></li>
</ul>
<p>如果需要修改kubeadm源码证书可以参考如下代码修改。</p>
<p>kubeadm中跟证书相关的代码有：</p>
<h2 id="3-1-ca文件的有效期-默认为10年">3.1. ca文件的有效期（默认为10年）</h2>
<p>代码文件：<code>./staging/src/k8s.io/client-go/util/cert/cert.go</code> 中 <code>NewSelfSignedCACert</code> 函数的NotAfter字段</p>
<p>代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewSelfSignedCACert creates a CA certificate
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewSelfSignedCACert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span> <span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span> <span style="color:#000">crypto</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Signer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Certificate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">now</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// returns a uniform random value in [0, max-1), then add 1 to serial to make it a uniform random value in [1, max).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">serial</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cryptorand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cryptorand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">big</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">SetInt64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxInt64</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">serial</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">big</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serial</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">big</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">notBefore</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">now</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UTC</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NotBefore</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsZero</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">notBefore</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NotBefore</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UTC</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tmpl</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Certificate</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">SerialNumber</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">serial</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Subject</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">pkix</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">CommonName</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommonName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">Organization</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Organization</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">DNSNames</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommonName</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">NotBefore</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">notBefore</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">NotAfter</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">now</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">duration365d</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">UTC</span><span style="color:#000;font-weight:bold">(),</span>   <span style="color:#a40000">#</span> <span style="color:#000">默认为10年</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">KeyUsage</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyUsageKeyEncipherment</span> <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyUsageDigitalSignature</span> <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyUsageCertSign</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">BasicConstraintsValid</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">IsCA</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">certDERBytes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateCertificate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cryptorand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tmpl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">tmpl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Public</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseCertificate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">certDERBytes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-证书文件的有效期-默认为1年">3.2. 证书文件的有效期（默认为1年）</h2>
<p>代码文件：<code>cmd/kubeadm/app/util/pkiutil/pki_helpers.go</code>中 <code>NewSignedCert</code> 函数的 notAfter 字段</p>
<ul>
<li>常量参数kubeadmconstants.<code>CertificateValidity</code> ： /cmd/kubeadm/app/constants/constants.go</li>
</ul>
<p>代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewSignedCert creates a signed certificate using the given CA certificate and key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewSignedCert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CertConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span> <span style="color:#000">crypto</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Signer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">caCert</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Certificate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">caKey</span> <span style="color:#000">crypto</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Signer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isCA</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Certificate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// returns a uniform random value in [0, max-1), then add 1 to serial to make it a uniform random value in [1, max).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">serial</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cryptorand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cryptorand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">big</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">SetInt64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxInt64</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">serial</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">big</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serial</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">big</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommonName</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;must specify a CommonName&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">keyUsage</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyUsageKeyEncipherment</span> <span style="color:#000;font-weight:bold">|</span> <span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyUsageDigitalSignature</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isCA</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">keyUsage</span> <span style="color:#ce5c00;font-weight:bold">|=</span> <span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyUsageCertSign</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">RemoveDuplicateAltNames</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AltNames</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">#</span> <span style="color:#000">此处引用了一个常量</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">notAfter</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeadmconstants</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertificateValidity</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">UTC</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NotAfter</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">notAfter</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NotAfter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">certTmpl</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Certificate</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Subject</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">pkix</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">CommonName</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommonName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">Organization</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Organization</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">DNSNames</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AltNames</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DNSNames</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">IPAddresses</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AltNames</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IPs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">SerialNumber</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#000">serial</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">NotBefore</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">caCert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NotBefore</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">NotAfter</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">notAfter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">KeyUsage</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">keyUsage</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ExtKeyUsage</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Usages</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">BasicConstraintsValid</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">IsCA</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#000">isCA</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">certDERBytes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateCertificate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cryptorand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">certTmpl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">caCert</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Public</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">caKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">x509</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseCertificate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">certDERBytes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中常量文件为：</p>
<ul>
<li>/cmd/kubeadm/app/constants/constants.go</li>
</ul>
<p>代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#a40000">#</span> <span style="color:#000">常量默认证书为1年</span><span style="color:#a40000">。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// CertificateValidity defines the validity for all the signed certificates generated by kubeadm
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">CertificateValidity</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Hour</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">24</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">365</span>  
</span></span></code></pre></div><p>可以修改此处常量的值10年，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#a40000">#</span> <span style="color:#000">常量默认证书为1年</span><span style="color:#a40000">。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// CertificateValidity defines the validity for all the signed certificates generated by kubeadm
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">CertificateValidity</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Hour</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">24</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">365</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span></code></pre></div><p>修改源码后，就可以重新编译kubeadm二进制。生成10年的证书文件。</p>
<p>参考：</p>
<ul>
<li>
<p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/">使用 kubeadm 进行证书管理 | Kubernetes</a></p>
</li>
<li>
<p><a href="https://sysin.org/blog/kubernetes-kubeadm-cert-100y/">Kubernetes v1.25 编译 kubeadm 修改证书有效期到 100 年</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cd5e466e5a3dfa8653fdc2627ae724ed">2.5 - k8s版本说明</h1>
    
	<h1 id="1-k8s版本号说明">1. k8s版本号说明</h1>
<p>k8s维护最新三个版本的发布分支（[2022.7.2]当前<strong>最新三个版本为1.24、1.23、1.22</strong>），Kubernetes 1.19 和更新的版本获得大约 1 年的补丁支持。</p>
<p>Kubernetes 版本表示为 <strong>x.y.z</strong>， 其中 <strong>x</strong> 是主要版本，<strong>y</strong> 是次要版本，<strong>z</strong> 是补丁版本。遵循<a href="https://semver.org/">语义化版本规范</a>。</p>
<h1 id="2-版本偏差策略">2. 版本偏差策略</h1>
<h2 id="2-1-支持的版本偏差">2.1. 支持的版本偏差</h2>
<p>总结：</p>
<ul>
<li>
<p><code>kubelet</code> 版本不能比 <code>kube-apiserver</code> 版本新，最多只可落后两个次要版本。</p>
</li>
<li>
<p><code>kube-controller-manager</code>、<code>kube-scheduler</code> 和 <code>cloud-controller-manager</code> 不能比 <code>kube-apiserver</code> 版本新。最多落后一个次要版本（允许实时升级）。</p>
</li>
<li>
<p><code>kubectl</code> 在 <code>kube-apiserver</code> 的一个次要版本（较旧或较新）中支持。</p>
</li>
<li>
<p><code>kube-proxy</code> 和节点上的 <code>kubelet</code> 必须是相同的次要版本。</p>
</li>
</ul>
<h3 id="1-kube-apiserver">1）kube-apiserver</h3>
<p>在<a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/high-availability/">高可用性（HA）集群</a>中， 最新版和最老版的 <code>kube-apiserver</code> 实例版本偏差最多为一个次要版本。</p>
<p>例如：</p>
<ul>
<li>最新的 <code>kube-apiserver</code> 实例处于 <strong>1.24</strong> 版本</li>
<li>其他 <code>kube-apiserver</code> 实例支持 <strong>1.24</strong> 和 <strong>1.23</strong> 版本</li>
</ul>
<h3 id="2-kubelet">2）kubelet</h3>
<p><code>kubelet</code> 版本不能比 <code>kube-apiserver</code> 版本新，并且最多只可落后两个次要版本。</p>
<p>例如：</p>
<ul>
<li><code>kube-apiserver</code> 处于 <strong>1.24</strong> 版本</li>
<li><code>kubelet</code> 支持 <strong>1.24</strong>、<strong>1.23</strong> 和 <strong>1.22</strong> 版本</li>
</ul>
<p><strong>说明：</strong></p>
<p>如果 HA 集群中的 <code>kube-apiserver</code> 实例之间存在版本偏差，这会缩小允许的 <code>kubelet</code> 版本范围。</p>
<p>例如：</p>
<ul>
<li><code>kube-apiserver</code> 实例处于 <strong>1.24</strong> 和 <strong>1.23</strong> 版本</li>
<li><code>kubelet</code> 支持 <strong>1.23</strong> 和 <strong>1.22</strong> 版本， （不支持 <strong>1.24</strong> 版本，因为这将比 <code>kube-apiserver</code> <strong>1.23</strong> 版本的实例新）</li>
</ul>
<h3 id="3-kube-controller-manager-kube-scheduler-和-cloud-controller-manager">3）kube-controller-manager、kube-scheduler 和 cloud-controller-manager</h3>
<p><code>kube-controller-manager</code>、<code>kube-scheduler</code> 和 <code>cloud-controller-manager</code> 不能比与它们通信的 <code>kube-apiserver</code> 实例新。 它们应该与 <code>kube-apiserver</code> 次要版本相匹配，但可能最多旧一个次要版本（允许实时升级）。</p>
<p>例如：</p>
<ul>
<li><code>kube-apiserver</code> 处于 <strong>1.24</strong> 版本</li>
<li><code>kube-controller-manager</code>、<code>kube-scheduler</code> 和 <code>cloud-controller-manager</code> 支持 <strong>1.24</strong> 和 <strong>1.23</strong> 版本</li>
</ul>
<p><strong>说明：</strong></p>
<p>如果 HA 集群中的 <code>kube-apiserver</code> 实例之间存在版本偏差， 并且这些组件可以与集群中的任何 <code>kube-apiserver</code> 实例通信（例如，通过负载均衡器），这会缩小这些组件所允许的版本范围。</p>
<p>例如：</p>
<ul>
<li><code>kube-apiserver</code> 实例处于 <strong>1.24</strong> 和 <strong>1.23</strong> 版本</li>
<li><code>kube-controller-manager</code>、<code>kube-scheduler</code> 和 <code>cloud-controller-manager</code> 与可以路由到任何 <code>kube-apiserver</code> 实例的负载均衡器通信</li>
<li><code>kube-controller-manager</code>、<code>kube-scheduler</code> 和 <code>cloud-controller-manager</code> 支持 <strong>1.23</strong> 版本（不支持 <strong>1.24</strong> 版本，因为它比 <strong>1.23</strong> 版本的 <code>kube-apiserver</code> 实例新）</li>
</ul>
<h3 id="4-kubectl">4）kubectl</h3>
<p><code>kubectl</code> 在 <code>kube-apiserver</code> 的一个次要版本（较旧或较新）中支持。</p>
<p>例如：</p>
<ul>
<li><code>kube-apiserver</code> 处于 <strong>1.24</strong> 版本</li>
<li><code>kubectl</code> 支持 <strong>1.25</strong>、<strong>1.24</strong> 和 <strong>1.23</strong> 版本</li>
</ul>
<p><strong>说明：</strong></p>
<p>如果 HA 集群中的 <code>kube-apiserver</code> 实例之间存在版本偏差，这会缩小支持的 <code>kubectl</code> 版本范围。</p>
<p>例如：</p>
<ul>
<li><code>kube-apiserver</code> 实例处于 <strong>1.24</strong> 和 <strong>1.23</strong> 版本</li>
<li><code>kubectl</code> 支持 <strong>1.24</strong> 和 <strong>1.23</strong> 版本（其他版本将与 <code>kube-apiserver</code> 组件之一相差不止一个的次要版本）</li>
</ul>
<h3 id="5-kube-proxy">5）kube-proxy</h3>
<ul>
<li><code>kube-proxy</code> 和节点上的 <code>kubelet</code> 必须是相同的次要版本。</li>
<li><code>kube-proxy</code> 版本不能比 <code>kube-apiserver</code> 版本新。</li>
<li><code>kube-proxy</code> 最多只能比 <code>kube-apiserver</code> 落后两个次要版本。</li>
</ul>
<p>例如：</p>
<p>如果 <code>kube-proxy</code> 版本处于 <strong>1.22</strong> 版本：</p>
<ul>
<li><code>kubelet</code> 必须处于相同的次要版本 <strong>1.22</strong>。</li>
<li><code>kube-apiserver</code> 版本必须介于 <strong>1.22</strong> 和 <strong>1.24</strong> 之间，包括两者。</li>
</ul>
<h2 id="2-2-组件升级顺序">2.2. 组件升级顺序</h2>
<p>优先升级kube-apiserver，其他的组件按照上述的版本要求进行升级，最好保持一致的版本。</p>
<h1 id="3-k8s版本发布周期">3. k8s版本发布周期</h1>
<p>k8s每年大概发布三次，即3-4个月发布一次大版本（发布版本为 <code>vX.Y</code> 里程碑创建的 Git 分支 <code>release-X.Y</code>）。</p>
<p>发布过程可被认为具有三个主要阶段：</p>
<ul>
<li>特性增强定义</li>
<li>实现</li>
<li>稳定</li>
</ul>
<h2 id="3-1-发布周期">3.1. 发布周期</h2>
<p>1）正常开发（第 1-11 周）</p>
<ul>
<li>
<p>/sig {name}</p>
</li>
<li>
<p>/sig {name}</p>
</li>
<li>
<p>/kind {type}</p>
</li>
<li>
<p>/lgtm</p>
</li>
<li>
<p>/approved</p>
</li>
</ul>
<p>2）<a href="https://git.k8s.io/sig-release/releases/release_phases.md#code-freeze">代码冻结</a>（第 12-14 周）</p>
<ul>
<li>/milestone {v1.y}</li>
<li>/sig {name}</li>
<li>/kind {bug, failing-test}</li>
<li>/lgtm</li>
<li>/approved</li>
</ul>
<p>3）发布后（第 14 周以上）</p>
<p>回到“正常开发”阶段要求：</p>
<ul>
<li>/sig {name}</li>
<li>/kind {type}</li>
<li>/lgtm</li>
<li>/approved</li>
</ul>
<h1 id="参考">参考：</h1>
<ul>
<li>
<p><a href="https://kubernetes.io/zh-cn/releases/">发行版本 | Kubernetes</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG">kubernetes/CHANGELOG at master  · GitHub</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/sig-release/tree/master/releases">sig-release/releases at master · kubernetes/sig-release · GitHub</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/design-proposals-archive/blob/main/release/versioning.md#kubernetes-release-versioning">design-proposals-archive/versioning.md at main · kubernetes/design-proposals-archive · GitHub</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/zh-cn/releases/release/">Kubernetes 发布周期 | Kubernetes</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b9af691092b47cf424aad2224adad987">2.6 - k8s版本记录</h1>
    
	<h1 id="1-27">1.27</h1>
<p>参考：</p>
<ul>
<li>
<p><a href="https://kubernetes.io/zh-cn/blog/2023/03/17/upcoming-changes-in-kubernetes-v1-27/">Kubernetes 在 v1.27 中移除的特性和主要变更</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.27.md#changelog-since-v1260">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.27.md#changelog-since-v1260</a></p>
</li>
<li>
<p><a href="https://docs.daocloud.io/blogs/230412-k8s-1.27/">202304 | K8s 1.27 正式发布 - DaoCloud Enterprise</a></p>
</li>
</ul>
<h2 id="一-重要更新">（一）重要更新</h2>
<h3 id="k8s-gcr-io-重定向到-registry-k8s-io-相关说明">k8s.gcr.io 重定向到 registry.k8s.io 相关说明</h3>
<p> Kubernetes 项目为了托管其容器镜像，使用社区拥有的一个名为 registry.k8s.io. 的镜像仓库。从 3 月 20 日起，所有来自过期 <a href="https://cloud.google.com/container-registry/">k8s.gcr.io</a> 仓库的流量将被重定向到 <a href="https://github.com/kubernetes/registry.k8s.io">registry.k8s.io</a>。 已弃用的 k8s.gcr.io 仓库最终将被淘汰。Kubernetes v1.27 版本不会发布到旧的仓库。</p>
<h3 id="原地调整-pod-资源-alpha">原地调整 Pod 资源 (alpha)</h3>
<p>参考：<a href="https://kubernetes.io/zh-cn/blog/2023/05/12/in-place-pod-resize-alpha/">Kubernetes 1.27: 原地调整 Pod 资源 (alpha) | Kubernetes</a></p>
<p>在 Kubernetes v1.27 中，添加了一个新的 alpha 特性，允许用户调整分配给 Pod 的 CPU 和内存资源大小，而无需重新启动容器。 首先，API 层面现在允许修改 Pod 容器中的 <code>resources</code> 字段下的 <code>cpu</code> 和 <code>memory</code> 资源。资源修改只需 patch 正在运行的 pod 规约即可。</p>
<h3 id="statefulset-pvc-自动删除功能特性-beta">StatefulSet PVC 自动删除功能特性 Beta</h3>
<p>在 v1.23 中引入的 <strong>StatefulSetAutoDeletePVC 功能将在 1.27 版本中升级为 Beta，并默认开启。</strong> 然而，默认开启并不意味着所有 StatefulSet 的 PVC 都将自动删除。</p>
<h3 id="优化大型集群中-kube-proxy-的-iptables-模式性能">优化大型集群中 kube-proxy 的 iptables 模式性能</h3>
<p><strong>功能 MinimizeIPTablesRestore</strong> 在 1.26 版本中引入，并在 1.27 版本中升级为 Beta 并默认启用。 该功能旨在改善大型集群中 kube-proxy 的 iptables 模式性能。</p>
<p>如果您遇到 Service 信息未正确同步到 iptables 的问题，您可以通过将 kube-proxy 启动参数设置为 <code>--feature-gates=MinimizeIPTablesRestore=false</code> 来禁用该功能（并向社区提交问题）。 您还可以查看 kube-proxy 的 metrics 信息中的 sync_proxy_rules_iptables_partial_restore_failures_total 指标来监控规则同步失败的次数。</p>
<h3 id="kubelet-事件驱动-pleg-升级为-beta">Kubelet 事件驱动 PLEG 升级为 Beta</h3>
<p><strong>在节点 Pod 较多的情况下，通过容器运行时的 Event 驱动 Pod 状态更新，能够有效地提升效率。</strong> 在 1.27 中，该功能已经达到了 Beta 条件，基础的 E2E 测试任务已经添加。 之所以默认关闭该功能，是因为社区认为该功能还需要补充以下验证：压力测试、恢复测试和带退避逻辑的重试。</p>
<h3 id="pod-调度就绪态功能增强">Pod 调度就绪态功能增强</h3>
<p><strong>调度就绪态功能 PodSchedulingReadiness</strong>，在 v1.26 作为 Alpha 功能引入，<strong>从 v1.27 开始该功能升级为 Beta，默认开启。</strong></p>
<h3 id="deployment-滚动更新过程中的调度优化">Deployment 滚动更新过程中的调度优化</h3>
<p><strong>在 v1.27 中，PodTopologySpread 调度策略可以区分调度 Pod 标签的值</strong> （这里通常指 Pod 的 pod-template-hash 标签，不同 replica set 对应的 Pod 该标签的值不同）， 这样滚动更新后，<strong>新的 Pod 实例会被调度得更加均匀</strong> 。</p>
<h3 id="关于加快-pod-启动的进展">关于加快 Pod 启动的进展</h3>
<p>要启用并行镜像拉取，请在 kubelet 配置中将 <code>serializeImagePulls</code> 字段设置为 false。 当 <code>serializeImagePulls</code> 被禁用时，将立即向镜像服务发送镜像拉取请求，并可以并行拉取多个镜像。</p>
<p>为了在节点上具有多个 Pod 的场景中加快 Pod 启动，特别是在突然扩缩的情况下， kubelet 需要同步 Pod 状态并准备 ConfigMap、Secret 或卷。这就需要大带宽访问 kube-apiserver。在 v1.27 中，kubelet 为了提高 Pod 启动性能，将这些默认值分别提高到了 50 和 100。</p>
<h2 id="二-弃用变更">（二）弃用变更</h2>
<ul>
<li>
<p>kubelet 移除了命令行参数 --container-runtime。</p>
</li>
<li>
<p>弃用的命令行参数 <code>--pod-eviction-timeout</code> 将被从 kube-controller-manager 中移除。</p>
</li>
</ul>
<h1 id="1-26">1.26</h1>
<p>参考：</p>
<ul>
<li>
<p><a href="https://kubernetes.io/zh-cn/blog/2022/11/18/upcoming-changes-in-kubernetes-1-26/">Kubernetes 1.26 中的移除、弃用和主要变更 | Kubernetes</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.26.md#changelog-since-v1250">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.26.md#changelog-since-v1250</a></p>
</li>
<li>
<p><a href="https://docs.daocloud.io/blogs/221209-k8s-1.26/">https://docs.daocloud.io/blogs/221209-k8s-1.26/</a></p>
</li>
<li>
<p><a href="https://www.alibabacloud.com/help/zh/ack/product-overview/kubernetes-1-26-release-notes?spm=a2c63.p38356.0.0.64624df9xXfEkZ">https://www.alibabacloud.com/help/zh/ack/product-overview/kubernetes-1-26-release-notes?spm=a2c63.p38356.0.0.64624df9xXfEkZ</a></p>
</li>
</ul>
<h2 id="一-重要更新-1">（一）重要更新</h2>
<h3 id="kubelet-evented-pleg-for-better-performance">Kubelet Evented PLEG for Better Performance</h3>
<p>该功能让 kubelet 在跟踪节点中 Pod 状态时，通过尽可能依赖容器运行时接口(CRI) 的通知来减少定期轮训，这会减少 kubelet 对 CPU 的使用</p>
<p><strong>新增 Alpha Feature Gate</strong> —— EventedPLEG 来控制是否开启该功能。</p>
<h3 id="优化-kube-proxy-性能-它只发送在调用-iptables-restore-中更改的规则-而不是整个规则集">优化 kube-proxy 性能，它只发送在调用 iptables-restore 中更改的规则，而不是整个规则集</h3>
<h3 id="pr-112200-https-github-com-kubernetes-kubernetes-pull-112200-client-go-的-sharedinformerfactory-增加-shutdown-方法-来等待-factory-内所有运行的-informer-都结束"><a href="https://github.com/kubernetes/kubernetes/pull/112200">PR#112200</a> client-go 的 SharedInformerFactory 增加 Shutdown 方法，来等待 Factory 内所有运行的 informer 都结束。</h3>
<h2 id="二-弃用变更-1">（二）弃用变更</h2>
<ul>
<li>Kubelet 不再支持 v1alpha2 版本的 CRI，接入的容器运行时必须实现 v1 版本的容器运行时接口。</li>
</ul>
<p>Kubernetes v1.26 将不支持 containerd 1.5.x 及更早的版本；需要升级到 containerd 1.6.x 或更高版本后，才能将该节点的 kubelet 升级到 1.26。</p>
<h1 id="1-25">1.25</h1>
<p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.25.md#whats-new-major-themes">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.25.md#whats-new-major-themes</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/zh-cn/blog/2022/08/04/upcoming-changes-in-kubernetes-1-25/">Kubernetes 1.25 的移除说明和主要变更 | Kubernetes</a></p>
</li>
</ul>
<h2 id="一-重要更新-2">（一）重要更新</h2>
<h3 id="cgroup-v2-升级到-ga">cgroup v2 升级到 GA</h3>
<p>Kubernetes 1.25 将 cgroup v2 正式发布（GA）， 让kubelet使用最新的容器资源管理能力。一些 Kubernetes 特性专门使用 cgroup v2 来增强资源管理和隔离。 例如，<a href="https://kubernetes.io/blog/2021/11/26/qos-memory-resources/">MemoryQoS 特性</a>提高了内存利用率并依赖 cgroup v2 功能来启用它。kubelet 中的新资源管理特性也将利用新的 cgroup v2 特性向前发展。</p>
<h3 id="csi-内联存储卷正式发布ga">CSI 内联存储卷正式发布GA</h3>
<p>CSI 内联存储卷与其他类型的临时卷相似，如 <code>configMap</code>、<code>downwardAPI</code> 和 <code>secret</code>。 重要的区别是，存储是由 CSI 驱动提供的，它允许使用第三方供应商提供的临时存储。 卷被定义为 Pod 规约的一部分，并遵循 Pod 的生命周期，这意味着卷随着 Pod 的调度而创建，并随着 Pod 的销毁而销毁。</p>
<h3 id="ephemeral-containers进入稳定版本">Ephemeral Containers进入稳定版本</h3>
<p>当pod crash的时候，无法通过kubectl exec 进入容器，这个时候可以通过临时容器[Ephemeral Containers](<a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/ephemeral-containers/">临时容器 | Kubernetes</a>)</p>
<h2 id="二-弃用变更-2">（二）弃用变更</h2>
<ul>
<li>
<p>Kubernetes v1.25 将移除 PodSecurityPolicy，取而代之的是 Pod Security Admission（即 PodSecurity 安全准入控制器）。</p>
</li>
<li>
<p><a href="https://github.com/kubernetes/enhancements/issues/3178">清理 IPTables 链的所有权</a> </p>
<ul>
<li>
<p> 从 v1.25 开始，Kubelet 将逐渐迁移为不在 <code>nat</code> 表中创建以下 iptables 链：</p>
<ul>
<li><code>KUBE-MARK-DROP</code></li>
<li><code>KUBE-MARK-MASQ</code></li>
<li><code>KUBE-POSTROUTING</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="1-24">1.24</h1>
<p>最新发行版本：1.24.2 (发布日期: 2022-06-15）</p>
<p>不再支持：2023-09-29</p>
<p><strong>补丁版本：</strong> <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.24.md#v1241">1.24.1</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.24.md#v1242">1.24.2</a></p>
<p>Complete 1.24 <a href="https://kubernetes.io/releases/patch-releases/#1-24">Schedule</a> and <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.24.md">Changelog</a></p>
<p>Kubernetes 1.24 使用 <strong>go1.18</strong>构建，默认情况下将不再验证使用 SHA-1 哈希算法签名的证书。</p>
<h2 id="一-重要更新-3">（一）重要更新</h2>
<p>1.24.0主要参考<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.24.md#major-themes">kubernetes/CHANGELOG-1.24.major-themes</a></p>
<h3 id="1-kubelet完全移除dockershim-最重大更新">1）kubelet完全移除Dockershim【最重大更新】</h3>
<p>在 v1.20 中弃用后，dockershim 组件已从 kubelet 中删除。从 v1.24 开始，您将需要使用其他受支持的运行时之一（例如 containerd 或 CRI-O），或者如果您依赖 Docker 引擎作为容器运行时，则使用 cri-dockerd。有关确保您的集群已准备好进行此移除的更多信息，请参阅本[指南](<a href="https://kubernetes.io/blog/2022/03/31/ready-for-dockershim-removal/">Is Your Cluster Ready for v1.24? | Kubernetes</a>)。</p>
<h3 id="2-beta-api-默认关闭">2）Beta API 默认关闭</h3>
<p>默认情况下，不会在集群中启用新的 beta API。默认情况下，现有的 beta API 和现有 beta API 的新版本将继续启用。</p>
<h3 id="3-存储容量和卷扩展到ga">3）存储容量和卷扩展到GA</h3>
<p>存储容量跟踪支持通过 CSIStorageCapacity 对象公开当前可用的存储容量，并增强使用具有后期绑定的 CSI 卷的 pod 的调度。</p>
<p>卷扩展增加了对调整现有持久卷大小的支持。</p>
<h3 id="4-避免-ip-分配给service的冲突">4）避免 IP 分配给service的冲突</h3>
<p>Kubernetes 1.24 引入了一项新的选择加入功能，允许您为服务的静态 IP 地址分配软预留范围。通过手动启用此功能，集群将更喜欢从服务 IP 地址池中自动分配，从而降低冲突风险。</p>
<p>可以分配 Service ClusterIP：</p>
<ul>
<li>
<p>动态，这意味着集群将自动在配置的服务 IP 范围内选择一个空闲 IP。</p>
</li>
<li>
<p>静态，这意味着用户将在配置的服务 IP 范围内设置一个 IP。</p>
</li>
</ul>
<p>Service ClusterIP 是唯一的，因此，尝试使用已分配的 ClusterIP 创建 Service 将返回错误。</p>
<h2 id="二-弃用变更-3">（二）弃用变更</h2>
<h3 id="1-kubeadm">1）kubeadm</h3>
<ul>
<li>
<p><strong>kubeadm.k8s.io/v1beta2 已被弃用</strong>，并将在未来的版本中删除，可能在 3 个版本（一年）中。您应该开始将 <strong>kubeadm.k8s.io/v1beta3 用于新集群</strong>。要迁移磁盘上的旧配置文件，您可以使用 kubeadm config migrate 命令。</p>
</li>
<li>
<p><strong>默认 k​​ubeadm 配置为 containerd 套接字</strong>（Unix：unix:///var/run/containerd/containerd.sock，Windows：npipe:////./pipe/containerd-containerd）而不是 Docker 的配置.如果在集群创建期间 Init|JoinConfiguration.nodeRegistration.criSocket 字段为空，并且在主机上发现多个套接字，则总是会抛出错误并要求用户通过设置字段中的值来指定要使用的套接字。使用 crictl 与 CRI 套接字进行所有通信，以执行诸如拉取图像和获取正在运行的容器列表等操作，而不是在 Docker 的情况下使用 docker CLI。</p>
</li>
<li>
<p>kubeadm 迁移到标签和污点中不再使用 master 一词。对于新的集群，<strong>标签 node-role.kubernetes.io/master 将不再添加到控制平面节点，只会添加标签 node-role.kubernetes.io/control-plane</strong>。</p>
</li>
</ul>
<h3 id="2-kube-apiserver">2）kube-apiserver</h3>
<ul>
<li>
<p>不安全的地址标志 --address、--insecure-bind-address、--port 和 --insecure-port（自 1.20 起惰性）被删除</p>
</li>
<li>
<p>弃用了--master-countflag 和--endpoint-reconciler-type=master-countreconciler，转而使用 lease reconciler。</p>
</li>
<li>
<p>已弃用Service.Spec.LoadBalancerIP。</p>
</li>
</ul>
<h3 id="3-kube-controller-manager">3）kube-controller-manager</h3>
<ul>
<li>kube-controller-manager 中的不安全地址标志 --address 和 --port 自 v1.20 起无效，并在 v1.24 中被删除。</li>
</ul>
<h3 id="4-kubelet">4）kubelet</h3>
<ul>
<li>
<p>--pod-infra-container-image kubelet 标志已弃用，将在未来版本中删除。</p>
</li>
<li>
<p><strong>以下与 dockershim 相关的标志也与 dockershim 一起被删除 --experimental-dockershim-root-directory、--docker-endpoint、--image-pull-progress-deadline、--network-plugin、--cni-conf -dir，--cni-bin-dir，--cni-cache-dir，--network-plugin-mtu。(<a href="https://github.com/kubernetes/kubernetes/pull/106907">#106907</a>, <a href="https://github.com/cyclinder">@cyclinder</a>)</strong></p>
</li>
</ul>
<h1 id="1-23">1.23</h1>
<p>最新发行版本：1.23.8 (发布日期: 2022-06-15）</p>
<p>不再支持：2023-02-28</p>
<p><strong>补丁版本：</strong> <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.23.md#v1231">1.23.1</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.23.md#v1232">1.23.2</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.23.md#v1233">1.23.3</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.23.md#v1234">1.23.4</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.23.md#v1235">1.23.5</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.23.md#v1236">1.23.6</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.23.md#v1237">1.23.7</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.23.md#v1238">1.23.8</a></p>
<p>Complete 1.23 <a href="https://kubernetes.io/releases/patch-releases/#1-23">Schedule</a> and <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.23.md">Changelog</a></p>
<p>Kubernetes 是使用 <strong>golang 1.17</strong> 构建的。此版本的 go 删除了使用 GODEBUG=x509ignoreCN=0 环境设置来重新启用将 X.509 服务证书的 CommonName 视为主机名的已弃用旧行为的能力。</p>
<h2 id="一-重要更新-4">（一） 重要更新</h2>
<h3 id="1-flexvolume-已弃用">1）FlexVolume 已弃用</h3>
<p>FlexVolume 已弃用。 Out-of-tree CSI 驱动程序是在 Kubernetes 中编写卷驱动程序的推荐方式。FlexVolume 驱动程序的维护者应实施 CSI 驱动程序并将 FlexVolume 的用户转移到 CSI。 FlexVolume 的用户应将其工作负载转移到 CSI 驱动程序。</p>
<h3 id="2-ipv4-ipv6-双栈网络到-ga">2）IPv4/IPv6 双栈网络到 GA</h3>
<p>IPv4/IPv6 双栈网络从 GA 毕业。从 1.21 开始，Kubernetes 集群默认启用支持双栈网络。在 1.23 中，移除了 IPv6DualStack 功能门。双栈网络的使用不是强制性的。尽管启用了集群以支持双栈网络，但 Pod 和服务继续默认为单栈。要使用双栈网络：Kubernetes 节点具有可路由的 IPv4/IPv6 网络接口，使用支持双栈的 CNI 网络插件，Pod 配置为双栈，服务的 .spec.ipFamilyPolicy 字段设置为 PreferDualStack 或需要双栈。</p>
<h3 id="3-horizo-ntalpodautoscaler-v2-到-ga">3）Horizo​​ntalPodAutoscaler v2 到 GA</h3>
<p>Horizo​​ntalPodAutoscaler API 的第 2 版在 1.23 版本中逐渐稳定。 Horizo​​ntalPodAutoscaler autoscaling/v2beta2 API 已弃用，取而代之的是新的 autoscaling/v2 API，Kubernetes 项目建议将其用于所有用例。</p>
<h3 id="4-scheduler简化多点插件配置">4）Scheduler简化多点插件配置</h3>
<p>kube-scheduler 正在为插件添加一个新的、简化的配置字段，以允许在一个位置启用多个扩展点。新的 multiPoint 插件字段旨在为管理员简化大多数调度程序设置。通过 multiPoint 启用的插件将自动为它们实现的每个单独的扩展点注册。例如，实现 Score 和 Filter 扩展的插件可以同时为两者启用。这意味着可以启用和禁用整个插件，而无需手动编辑单个扩展点设置。这些扩展点现在可以被抽象出来，因为它们与大多数用户无关。</p>
<h2 id="二-已知问题">（二）已知问题</h2>
<p>在 1.22 Kubernetes 版本附带的 <strong>etcd v3.5.0 版本中发现了数据损坏问题</strong>。请阅读 etcd 的最新[生产建议](<a href="https://github.com/etcd-io/etcd/tree/main/CHANGELOG">etcd/CHANGELOG at main · etcd-io/etcd · GitHub</a>)。</p>
<p>运行etcd v3.5.2 v3.5.1和v3.5.0高负荷会导致数据损坏问题。如果etcd进程被杀,偶尔有些已提交的事务并不反映在所有的成员。建议升级到<strong>v3.5.3</strong>。</p>
<p><strong>最低推荐etcd版本运行在生产3.3.18 + 3.4.2 + v3.5.3 +。</strong></p>
<h1 id="1-22">1.22</h1>
<p>最新发行版本：1.22.11 (发布日期: 2022-06-15）</p>
<p>不再支持：2022-10-28</p>
<p><strong>补丁版本：</strong> <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.22.md#v1221">1.22.1</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.22.md#v1222">1.22.2</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.22.md#v1223">1.22.3</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.22.md#v1224">1.22.4</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.22.md#v1225">1.22.5</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.22.md#v1226">1.22.6</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.22.md#v1227">1.22.7</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.22.md#v1228">1.22.8</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.22.md#v1229">1.22.9</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.22.md#v12210">1.22.10</a>、 <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.22.md#v12211">1.22.11</a></p>
<p>Complete 1.22 <a href="https://kubernetes.io/releases/patch-releases/#1-22">Schedule</a> and <a href="https://git.k8s.io/kubernetes/CHANGELOG/CHANGELOG-1.22.md">Changelog</a></p>
<h2 id="重要更新">（—）重要更新</h2>
<h3 id="1-kubeadm-1">1）kubeadm</h3>
<ul>
<li>
<p>允许非root用户允许kubeadm。</p>
</li>
<li>
<p>现在V1beta3首选API版本;v1beta2 API也仍然是可用的,并没有弃用。</p>
</li>
<li>
<p>移除对docker cgroup driver的检查，kubeadm默认使用systemd cgroup driver，需要手动将runtime配置为systemd。</p>
</li>
<li>
<p>v1beta3中删除ClusterConfiguration.DNS字段，因为CoreDNS是唯一支持DNS类型。</p>
</li>
</ul>
<h3 id="2-etcd">2）etcd</h3>
<ul>
<li>etcd使用v3.5.0版本。（但是在1.23版本中发现v3.5.0有数据损坏的问题）</li>
</ul>
<h3 id="3-kubelet">3）kubelet</h3>
<ul>
<li>
<p>节点支持swap内存。</p>
</li>
<li>
<p>作为α特性,Kubernetes v1.22并且可以使用cgroup v2 API来控制内存分配和隔离。这个功能的目的是改善工作负载和节点可用性时对内存资源的争用。</p>
</li>
</ul>
<p>参考：</p>
<ul>
<li>
<p><a href="https://kubernetes.io/zh-cn/releases/">发行版本 | Kubernetes</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG">kubernetes/CHANGELOG at master · GitHub</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/sig-release/tree/master/releases">sig-release/releases at master · kubernetes/sig-release · GitHub</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/lizexiong/p/16223997.html">Kubernetes 1.24 正式发布，这里是更新功能总览</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9568044c7a7292363ca18ec04ca309a4">3 - 基本概念</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-de32fae571e364e320e9c4fbf60e7384">3.1 - kubernetes架构</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b545a2ca17b93b0d5b41f439c5c49f76">3.1.1 - Kubernetes总架构图</h1>
    
	<h1 id="1-kubernetes的总架构图">1. Kubernetes的总架构图</h1>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1512807164/article/kubernetes/arch/k8s-arch.jpg" width="100%">
<h1 id="2-kubernetes各个组件介绍">2. Kubernetes各个组件介绍</h1>
<h2 id="2-1-kube-master-控制节点">2.1 kube-master[控制节点]</h2>
<p><strong>master的工作流程图</strong></p>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510578888/article/kubernetes/arch/master.png" width="100%">
<ol>
<li>Kubecfg将特定的请求，比如创建Pod，发送给Kubernetes Client。</li>
<li>Kubernetes Client将请求发送给API server。</li>
<li>API Server根据请求的类型，比如创建Pod时storage类型是pods，然后依此选择何种REST Storage API对请求作出处理。</li>
<li>REST Storage API对的请求作相应的处理。</li>
<li>将处理的结果存入高可用键值存储系统Etcd中。</li>
<li>在API Server响应Kubecfg的请求后，Scheduler会根据Kubernetes Client获取集群中运行Pod及Minion/Node信息。</li>
<li>依据从Kubernetes Client获取的信息，Scheduler将未分发的Pod分发到可用的Minion/Node节点上。</li>
</ol>
<h2 id="2-1-1-api-server-资源操作入口">2.1.1 API Server[资源操作入口]</h2>
<ol>
<li>
<p>提供了资源对象的唯一操作入口，其他所有组件都必须通过它提供的API来操作资源数据，只有API Server与存储通信，其他模块通过API Server访问集群状态。</p>
<p>第一，是为了保证集群状态访问的安全。</p>
<p>第二，是为了隔离集群状态访问的方式和后端存储实现的方式：API Server是状态访问的方式，不会因为后端存储技术etcd的改变而改变。</p>
</li>
<li>
<p>作为kubernetes系统的入口，封装了核心对象的增删改查操作，以RESTFul接口方式提供给外部客户和内部组件调用。对相关的资源数据“全量查询”+“变化监听”，实时完成相关的业务功能。</p>
</li>
</ol>
<p>更多API Server信息请参考：<a href="http://www.huweihuang.com/article/kubernetes/core-principle/kubernetes-core-principle-api-server/">Kubernetes核心原理（一）之API Server</a></p>
<h2 id="2-1-2-controller-manager-内部管理控制中心">2.1.2 Controller Manager[内部管理控制中心]</h2>
<ol>
<li>实现集群故障检测和恢复的自动化工作，负责执行各种控制器，主要有：
<ul>
<li>endpoint-controller：定期关联service和pod(关联信息由endpoint对象维护)，保证service到pod的映射总是最新的。</li>
<li>replication-controller：定期关联replicationController和pod，保证replicationController定义的复制数量与实际运行pod的数量总是一致的。</li>
</ul>
</li>
</ol>
<p>更多Controller Manager信息请参考：<a href="http://www.huweihuang.com/article/kubernetes/core-principle/kubernetes-core-principle-controller-manager/">Kubernetes核心原理（二）之Controller Manager</a></p>
<h2 id="2-1-3-scheduler-集群分发调度器">2.1.3 Scheduler[集群分发调度器]</h2>
<ol>
<li>Scheduler收集和分析当前Kubernetes集群中所有Minion/Node节点的资源(内存、CPU)负载情况，然后依此分发新建的Pod到Kubernetes集群中可用的节点。</li>
<li>实时监测Kubernetes集群中未分发和已分发的所有运行的Pod。</li>
<li>Scheduler也监测Minion/Node节点信息，由于会频繁查找Minion/Node节点，Scheduler会缓存一份最新的信息在本地。</li>
<li>最后，Scheduler在分发Pod到指定的Minion/Node节点后，会把Pod相关的信息Binding写回API Server。</li>
</ol>
<p>更多Scheduler信息请参考：<a href="http://www.huweihuang.com/article/kubernetes/core-principle/kubernetes-core-principle-scheduler/">Kubernetes核心原理（三）之Scheduler</a></p>
<h2 id="2-2-kube-node-服务节点">2.2 kube-node[服务节点]</h2>
<p><strong>kubelet结构图</strong></p>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510578888/article/kubernetes/arch/kubelet.png" width="60%">
<h2 id="2-2-1-kubelet-节点上的pod管家">2.2.1 Kubelet[节点上的Pod管家]</h2>
<ol>
<li>
<p>负责Node节点上pod的创建、修改、监控、删除等全生命周期的管理</p>
</li>
<li>
<p>定时上报本Node的状态信息给API Server。</p>
</li>
<li>
<p>kubelet是Master API Server和Minion/Node之间的桥梁，接收Master API Server分配给它的commands和work，通过kube-apiserver间接与Etcd集群交互，读取配置信息。</p>
</li>
<li>
<p>具体的工作如下：</p>
<ol>
<li>
<p>设置容器的环境变量、给容器绑定Volume、给容器绑定Port、根据指定的Pod运行一个单一容器、给指定的Pod创建network 容器。</p>
</li>
<li>
<p>同步Pod的状态、同步Pod的状态、从cAdvisor获取container info、 pod info、 root info、 machine info。</p>
</li>
<li>
<p>在容器中运行命令、杀死容器、删除Pod的所有容器。</p>
</li>
</ol>
</li>
</ol>
<p>更多Kubelet信息请参考：<a href="http://www.huweihuang.com/article/kubernetes/core-principle/kubernetes-core-principle-kubelet/">Kubernetes核心原理（四）之Kubelet</a></p>
<h2 id="2-2-2-proxy-负载均衡-路由转发">2.2.2 Proxy[负载均衡、路由转发]</h2>
<ol>
<li>Proxy是为了解决外部网络能够访问跨机器集群中容器提供的应用服务而设计的，运行在每个Minion/Node上。Proxy提供TCP/UDP sockets的proxy，每创建一种Service，Proxy主要从etcd获取Services和Endpoints的配置信息（也可以从file获取），然后根据配置信息在Minion/Node上启动一个Proxy的进程并监听相应的服务端口，当外部请求发生时，Proxy会根据Load Balancer将请求分发到后端正确的容器处理。</li>
<li>Proxy不但解决了同一主宿机相同服务端口冲突的问题，还提供了Service转发服务端口对外提供服务的能力，Proxy后端使用了随机、轮循负载均衡算法。</li>
</ol>
<h2 id="2-2-3-kubectl-集群管理命令行工具集">2.2.3 kubectl[集群管理命令行工具集]</h2>
<ol>
<li>通过客户端的kubectl命令集操作，API Server响应对应的命令结果，从而达到对kubernetes集群的管理。</li>
</ol>
<p>参考文章：</p>
<p><a href="https://yq.aliyun.com/articles/47308?spm=5176.100240.searchblog.19.jF7FFa">https://yq.aliyun.com/articles/47308?spm=5176.100240.searchblog.19.jF7FFa</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-765e34ca75800e04fc456ceb521a5c40">3.1.2 -  基于Docker及Kubernetes技术构建容器云（PaaS）平台</h1>
    
	<p>[编者的话]</p>
<p>目前很多的容器云平台通过Docker及Kubernetes等技术提供应用运行平台，从而实现运维自动化，快速部署应用、弹性伸缩和动态调整应用环境资源，提高研发运营效率。</p>
<p>从宏观到微观（从抽象到具体）的思路来理解：云计算→PaaS→ App Engine→XAE[XXX App Engine] （XAE泛指一类应用运行平台，例如GAE、SAE、BAE等）。</p>
<p>本文简要介绍了与容器云相关的几个重要概念：PaaS、App Engine、Dokcer、Kubernetes。</p>
<h1 id="1-paas概述">1. PaaS概述</h1>
<h2 id="1-1-paas概念">1.1. PaaS概念</h2>
<ol>
<li>PaaS(Platform as a service)，平台即服务，指将软件研发的平台（或业务基础平台）作为一种服务，以SaaS的模式提交给用户。</li>
<li>PaaS是云计算服务的其中一种模式，云计算是一种按使用量付费的模式的服务，类似一种租赁服务，服务可以是基础设施计算资源（IaaS），平台（PaaS），软件（SaaS）。租用IT资源的方式来实现业务需要，如同水力、电力资源一样，计算、存储、网络将成为企业IT运行的一种被使用的资源，无需自己建设，可按需获得。</li>
<li>PaaS的实质是将互联网的资源服务化为可编程接口，为第三方开发者提供有商业价值的资源和服务平台。简而言之，<strong>IaaS就是卖硬件及计算资源，PaaS就是卖开发、运行环境，SaaS就是卖软件</strong>。</li>
</ol>
<h2 id="1-2-iaas-paas-saas说明">1.2. IaaS/PaaS/SaaS说明</h2>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577867/article/caas/cloud-computing.jpg" width="40%">
<table>
<thead>
<tr>
<th>类型</th>
<th>说明</th>
<th>比喻</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>IaaS:Infrastructure-as-a-Service(基础设施即服务)</td>
<td>提供的服务是计算基础设施</td>
<td>地皮，需要自己盖房子</td>
<td>Amazon EC2（亚马逊弹性云计算）</td>
</tr>
<tr>
<td>PaaS: Platform-as-a-Service(平台即服务)</td>
<td>提供的服务是软件研发的平台或业务基础平台</td>
<td>商品房，需要自己装修</td>
<td>GAE（谷歌开发者平台）</td>
</tr>
<tr>
<td>SaaS: Software-as-a-Service(软件即服务)</td>
<td>提供的服务是运行在云计算基础设施上的应用程序</td>
<td>酒店套房，可以直接入住</td>
<td>谷歌的Gmail邮箱</td>
</tr>
</tbody>
</table>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577869/article/caas/paas.jpg" width="70%">
<h2 id="1-3-paas的特点-三种层次">1.3. PaaS的特点（三种层次）</h2>
<table>
<thead>
<tr>
<th>特点</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>平台即服务</td>
<td>PaaS提供的服务就是个基础平台，一个环境，而不是具体的应用</td>
</tr>
<tr>
<td>平台及服务</td>
<td>不仅提供平台，还提供对该平台的技术支持、优化等服务</td>
</tr>
<tr>
<td>平台级服务</td>
<td>“平台级服务”即强大稳定的平台和专业的技术支持团队，保障应用的稳定使用</td>
</tr>
</tbody>
</table>
<h1 id="2-app-engine概述">2. App Engine概述</h1>
<h2 id="2-1-app-engine概念">2.1. App Engine概念</h2>
<p>App Engine是PaaS模式的一种实现方式，App Engine将应用运行所需的 IT 资源和基础设施以服务的方式提供给用户，包括了中间件服务、资源管理服务、弹性调度服务、消息服务等多种服务形式。App Engine的目标是对应用提供完整生命周期（包括设计、开发、测试和部署等阶段）的支持，从而减少了用户在购置和管理应用生命周期内所必须的软硬件以及部署应用和IT 基础设施的成本，同时简化了以上工作的复杂度。常见的App Engine有：GAE(Google App Engine)，SAE(Sina App Engine)，BAE(Baidu App Engine)。</p>
<p>App Engine利用虚拟化与自动化技术实现快速搭建部署应用运行环境和动态调整应用运行时环境资源这两个目标。一方面实现即时部署以及快速回收，降低了环境搭建时间，避免了手工配置错误，快速重复搭建环境，及时回收资源， 减少了低利用率硬件资源的空置。另一方面，根据应用运行时的需求对应用环境进行动态调整，实现了应用平台的弹性扩展和自优化，减少了非高峰时硬件资源的空置。</p>
<p>简而言之，<strong>App Engine主要目标是：Easy to maintain(维护), Easy to scale(扩容), Easy to build(构建)</strong>。</p>
<h2 id="2-2-架构设计">2.2. 架构设计</h2>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577868/article/caas/AppEngine.jpg" width="80%">
<h2 id="2-3-组成模块说明">2.3. 组成模块说明</h2>
<table>
<thead>
<tr>
<th>组成模块</th>
<th>模块说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>App Router[流量接入层]</td>
<td>接收用户请求，并转发到不同的App Runtime。</td>
</tr>
<tr>
<td>App Runtime[应用运行层]</td>
<td>应用运行环境，为各个应用提供基本的运行引擎，从而让app能够运行起来。</td>
</tr>
<tr>
<td>Services[基础服务层]</td>
<td>各个通用基础服务，主要是对主流的服务提供通用的接入，例如数据库等。</td>
</tr>
<tr>
<td>Platform Control[平台控制层]</td>
<td>整个平台的控制中心，实现业务调度，弹性扩容、资源审计、集群管理等相关工作。</td>
</tr>
<tr>
<td>Manage System[管理界面层]</td>
<td>提供友好可用的管理操作界面方便平台管理员来控制管理整个平台。</td>
</tr>
<tr>
<td>Platform Support[平台支持层]</td>
<td>为应用提供相关的支持，比如应用监控、问题定位、分布式日志重建、统计分析等。</td>
</tr>
<tr>
<td>Log Center[日志中心]</td>
<td>实时收集相关应用及系统的日志（日志收集），提供实时计算和分析平台（日志处理）。</td>
</tr>
<tr>
<td>Code Center[代码中心]</td>
<td>完成代码存储、部署上线相关的工作。</td>
</tr>
</tbody>
</table>
<h1 id="3-容器云平台技术栈">3. 容器云平台技术栈</h1>
<table>
<thead>
<tr>
<th>功能组成部分</th>
<th>使用工具</th>
</tr>
</thead>
<tbody>
<tr>
<td>应用载体</td>
<td>Docker</td>
</tr>
<tr>
<td>编排工具</td>
<td>Kubernetes</td>
</tr>
<tr>
<td>配置数据</td>
<td>Etcd</td>
</tr>
<tr>
<td>网络管理</td>
<td>Flannel</td>
</tr>
<tr>
<td>存储管理</td>
<td>Ceph</td>
</tr>
<tr>
<td>底层实现</td>
<td>Linux内核的Namespace[资源隔离]和CGroups[资源控制]</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>Namespace[资源隔离]</strong>
Namespaces机制提供一种资源隔离方案。PID,IPC,Network等系统资源不再是全局性的，而是属于某个特定的Namespace。每个namespace下的资源对于其他namespace下的资源都是透明，不可见的。</li>
<li><strong>CGroups[资源控制]</strong>
CGroup（control group）是将任意进程进行分组化管理的Linux内核功能。CGroup本身是提供将进程进行分组化管理的功能和接口的基础结构，I/O或内存的分配控制等具体的资源管理功能是通过这个功能来实现的。CGroups可以限制、记录、隔离进程组所使用的物理资源（包括：CPU、memory、IO等），为容器实现虚拟化提供了基本保证。CGroups本质是内核附加在程序上的一系列钩子（hooks），通过程序运行时对资源的调度触发相应的钩子以达到资源追踪和限制的目的。</li>
</ul>
<h1 id="4-docker概述">4. Docker概述</h1>
<p>更多详情请参考：<a href="http://www.huweihuang.com/article/docker/docker-architecture/">Docker整体架构图</a></p>
<h2 id="4-1-docker介绍">4.1. Docker介绍</h2>
<ol>
<li>Docker - Build, Ship, and Run Any App, Anywhere</li>
<li>Docker是一种Linux容器工具集，它是为“构建（Build）、交付（Ship）和运行（Run）”分布式应用而设计的。</li>
<li>Docker相当于把应用以及应用所依赖的环境完完整整地打成了一个包，这个包拿到哪里都能原生运行。因此可以在开发、测试、运维中保证环境的一致性。</li>
<li><strong>Docker的本质：Docker=LXC(Namespace+CGroups)+Docker Images，即在Linux内核的Namespace[资源隔离]和CGroups[资源控制]技术的基础上通过镜像管理机制来实现轻量化设计。</strong></li>
</ol>
<h2 id="4-2-docker的基本概念">4.2. Docker的基本概念</h2>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577868/article/caas/docker.png" width="70%">
<h2 id="4-2-1-镜像">4.2.1. 镜像</h2>
<p>Docker 镜像就是一个只读的模板，可以把镜像理解成一个模子（模具），由模子（镜像）制作的成品（容器）都是一样的（除非在生成时加额外参数），修改成品（容器）本身并不会对模子（镜像）产生影响（除非将成品提交成一个模子），容器重启时，即由模子（镜像）重新制作成一个成品（容器），与其他由该模子制作成的成品并无区别。</p>
<p>例如：一个镜像可以包含一个完整的 ubuntu 操作系统环境，里面仅安装了 Apache 或用户需要的其它应用程序。镜像可以用来创建 Docker 容器。Docker 提供了一个很简单的机制来创建镜像或者更新现有的镜像，用户可以直接从其他人那里下载一个已经做好的镜像来直接使用。</p>
<h2 id="4-2-2-容器">4.2.2. 容器</h2>
<p>Docker 利用容器来运行应用。容器是从镜像创建的运行实例。它可以被启动、开始、停止、删除。每个容器都是相互隔离的、保证安全的平台。可以把容器看做是一个简易版的 Linux 环境（包括root用户权限、进程空间、用户空间和网络空间等）和运行在其中的应用程序。</p>
<h2 id="4-2-3-仓库">4.2.3. 仓库</h2>
<p>仓库是集中存放镜像文件的场所。有时候会把仓库和仓库注册服务器（Registry）混为一谈，并不严格区分。实际上，仓库注册服务器上往往存放着多个仓库，每个仓库中又包含了多个镜像，每个镜像有不同的标签（tag）。</p>
<h2 id="4-3-docker的优势">4.3. Docker的优势</h2>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577868/article/caas/ContainerVSVMs.jpg" width="80%">
<ol>
<li>
<p>容器的快速轻量</p>
<p>容器的启动，停止和销毁都是以秒或毫秒为单位的，并且相比传统的虚拟化技术，使用容器在CPU、内存，网络IO等资源上的性能损耗都有同样水平甚至更优的表现。</p>
</li>
<li>
<p>一次构建，到处运行</p>
<p>当将容器固化成镜像后，就可以非常快速地加载到任何环境中部署运行。而构建出来的镜像打包了应用运行所需的程序、依赖和运行环境， 这是一个完整可用的应用集装箱，在任何环境下都能保证环境一致性。</p>
</li>
<li>
<p>完整的生态链</p>
<p>容器技术并不是Docker首创，但是以往的容器实现只关注于如何运行，而Docker站在巨人的肩膀上进行整合和创新，特别是Docker镜像的设计，完美地解决了容器从构建、交付到运行，提供了完整的生态链支持。</p>
</li>
</ol>
<h1 id="5-kubernetes概述">5. Kubernetes概述</h1>
<p>更多详情请参考：<a href="http://www.huweihuang.com/article/kubernetes/kubernetes-architecture/">Kubernetes总架构图</a></p>
<h2 id="5-1-kubernetes介绍">5.1. Kubernetes介绍</h2>
<p>Kubernetes是Google开源的容器集群管理系统。它构建Docker技术之上，为容器化的应用提供资源调度、部署运行、服务发现、扩容缩容等整一套功能，本质上可看作是基于容器技术的Micro-PaaS平台，即第三代PaaS的代表性项目。</p>
<h2 id="5-2-kubernetes的基本概念">5.2. Kubernetes的基本概念</h2>
<h2 id="5-2-1-pod">5.2.1. Pod</h2>
<p>Pod是若干个相关容器的组合，是一个逻辑概念，Pod包含的容器运行在同一个宿主机上，这些容器使用相同的网络命名空间、IP地址和端口，相互之间能通过localhost来发现和通信，共享一块存储卷空间。在Kubernetes中创建、调度和管理的最小单位是Pod。一个Pod一般只放一个业务容器和一个用于统一网络管理的网络容器。</p>
<h2 id="5-2-2-replication-controller">5.2.2. Replication Controller</h2>
<p>Replication Controller是用来控制管理Pod副本(Replica，或者称实例)，Replication Controller确保任何时候Kubernetes集群中有指定数量的Pod副本在运行，如果少于指定数量的Pod副本，Replication Controller会启动新的Pod副本，反之会杀死多余的以保证数量不变。另外Replication Controller是弹性伸缩、滚动升级的实现核心。</p>
<h2 id="5-2-3-service">5.2.3. Service</h2>
<p>Service是真实应用服务的抽象，定义了Pod的逻辑集合和访问这个Pod集合的策略，Service将代理Pod对外表现为一个单一访问接口，外部不需要了解后端Pod如何运行，这给扩展或维护带来很大的好处，提供了一套简化的服务代理和发现机制。</p>
<h2 id="5-2-4-label">5.2.4. Label</h2>
<p>Label是用于区分Pod、Service、Replication Controller的Key/Value键值对，实际上Kubernetes中的任意API对象都可以通过Label进行标识。每个API对象可以有多个Label，但是每个Label的Key只能对应一个Value。Label是Service和Replication Controller运行的基础，它们都通过Label来关联Pod，相比于强绑定模型，这是一种非常好的松耦合关系。</p>
<h2 id="5-2-5-node">5.2.5. Node</h2>
<p>Kubernets属于主从的分布式集群架构，Kubernets Node（简称为Node，早期版本叫做Minion）运行并管理容器。Node作为Kubernetes的操作单元，将用来分配给Pod（或者说容器）进行绑定，Pod最终运行在Node上，Node可以认为是Pod的宿主机。</p>
<h2 id="5-3-kubernetes架构">5.3. Kubernetes架构</h2>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1512807966/article/caas/architecture.png" width="100%">

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9de22f41eb289fe9a19743bc4cc793ff">3.2 - kubernetes对象</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-466c1b420cb16e44f962be13caafa2ec">3.2.1 - Kubernetes基本概念</h1>
    
	<h1 id="1-master">1. Master</h1>
<p>集群的控制节点，负责整个集群的管理和控制，kubernetes的所有的命令基本都是发给Master，由它来负责具体的执行过程。</p>
<h2 id="1-1-master的组件">1.1. Master的组件</h2>
<ul>
<li>kube-apiserver：资源增删改查的入口</li>
<li>kube-controller-manager：资源对象的大总管</li>
<li>kube-scheduler：负责资源调度（Pod调度）</li>
<li>etcd Server:kubernetes的所有的资源对象的数据保存在etcd中。</li>
</ul>
<h1 id="2-node">2. Node</h1>
<p>Node是集群的工作负载节点，默认情况kubelet会向Master注册自己，一旦Node被纳入集群管理范围，kubelet会定时向Master汇报自身的情报，包括操作系统，Docker版本，机器资源情况等。</p>
<p>如果Node超过指定时间不上报信息，会被Master判断为“失联”，标记为Not Ready，随后Master会触发Pod转移。</p>
<h2 id="2-1-node的组件">2.1. Node的组件</h2>
<ul>
<li>kubelet:Pod的管家，与Master通信</li>
<li>kube-proxy：实现kubernetes Service的通信与负载均衡机制的重要组件</li>
<li>Docker：容器的创建和管理</li>
</ul>
<h2 id="2-2-node相关命令">2.2. Node相关命令</h2>
<p>kubectl get nodes</p>
<p>kuebctl describe node {node_name}</p>
<h2 id="2-3-describe命令的node信息">2.3. describe命令的Node信息</h2>
<ul>
<li>Node基本信息：名称、标签、创建时间等</li>
<li>Node当前的状态，Node启动后会进行自检工作，磁盘是否满，内存是否不足，若都正常则切换为Ready状态。</li>
<li>Node的主机地址与主机名</li>
<li>Node上的资源总量：CPU,内存，最大可调度Pod数量等</li>
<li>Node可分配资源量：当前Node可用于分配的资源量</li>
<li>主机系统信息：主机唯一标识符UUID，Linux kernel版本号，操作系统，kubernetes版本，kubelet与kube-proxy版本</li>
<li>当前正在运行的Pod列表及概要信息</li>
<li>已分配的资源使用概要，例如资源申请的最低、最大允许使用量占系统总量的百分比</li>
<li>Node相关的Event信息。</li>
</ul>
<h1 id="3-pod">3. Pod</h1>
<p>Pod是Kubernetes中操作的基本单元。每个Pod中有个根容器(Pause容器)，Pause容器的状态代表整个容器组的状态，其他业务容器共享Pause的IP，即Pod IP，共享Pause挂载的Volume，这样简化了同个Pod中不同容器之间的网络问题和文件共享问题。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578930/article/kubernetes/concept/pod.png" alt="pod"></p>
<ol>
<li>Kubernetes集群中，同宿主机的或不同宿主机的Pod之间要求能够TCP/IP直接通信，因此采用虚拟二层网络技术来实现，例如Flannel，Openvswitch(OVS)等，这样在同个集群中，不同的宿主机的Pod IP为不同IP段的IP，集群中的所有Pod IP都是唯一的，不同Pod之间可以直接通信。</li>
<li>Pod有两种类型：普通Pod和静态Pod。静态Pod即不通过K8S调度和创建，直接在某个具体的Node机器上通过具体的文件来启动。普通Pod则是由K8S创建、调度，同时数据存放在ETCD中。</li>
<li>Pod IP和具体的容器端口（ContainnerPort）组成一个具体的通信地址，即Endpoint。一个Pod中可以存在多个容器，可以有多个端口，Pod IP一样，即有多个Endpoint。</li>
<li>Pod Volume是定义在Pod之上，被各个容器挂载到自己的文件系统中，可以用分布式文件系统实现后端存储功能。</li>
<li>Pod中的Event事件可以用来排查问题，可以通过kubectl describe pod xxx 来查看对应的事件。</li>
<li>每个Pod可以对其能使用的服务器上的计算资源设置限额，一般为CPU和Memory。K8S中一般将千分之一个的CPU配置作为最小单位，用m表示，是一个绝对值，即100m对于一个Core的机器还是48个Core的机器都是一样的大小。Memory配额也是个绝对值，单位为内存字节数。</li>
<li>资源配额的两个参数</li>
</ol>
<ul>
<li>Requests:该资源的最小申请量，系统必须满足要求。</li>
<li>Limits:该资源最大允许使用量，当超过该量，K8S会kill并重启Pod。</li>
</ul>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578930/article/kubernetes/concept/pod2.png" alt="pod2"></p>
<h1 id="4-label">4. Label</h1>
<ol>
<li>Label是一个键值对，可以附加在任何对象上，比如Node,Pod,Service,RC等。Label和资源对象是多对多的关系，即一个Label可以被添加到多个对象上，一个对象也可以定义多个Label。</li>
<li>Label的作用主要用来实现精细的、多维度的资源分组管理，以便进行资源分配，调度，配置，部署等工作。</li>
<li>Label通俗理解就是“标签”，通过标签来过滤筛选指定的对象，进行具体的操作。k8s通过Label Selector(标签选择器)来筛选指定Label的资源对象，类似SQL语句中的条件查询（WHERE语句）。</li>
<li>Label Selector有基于等式和基于集合的两种表达方式，可以多个条件进行组合使用。</li>
</ol>
<ul>
<li>基于等式：name=redis-slave（匹配name=redis-slave的资源对象）;env!=product(匹配所有不具有标签env=product的资源对象)</li>
<li>基于集合：name in (redis-slave,redis-master);name not in (php-frontend)（匹配所有不具有标签name=php-frontend的资源对象）</li>
</ul>
<p><strong>使用场景</strong></p>
<ol>
<li>kube-controller进程通过资源对象RC上定义的Label Selector来筛选要监控的Pod副本数，从而实现副本数始终保持预期数目。</li>
<li>kube-proxy进程通过Service的Label Selector来选择对应Pod，自动建立每个Service到对应Pod的请求转发路由表，从而实现Service的智能负载均衡机制。</li>
<li>kube-scheduler实现Pod定向调度：对Node定义特定的Label，并且在Pod定义文件中使用NodeSelector标签调度策略。</li>
</ol>
<h1 id="5-replication-controller-rc">5. Replication Controller(RC)</h1>
<p>RC是k8s系统中的核心概念，定义了一个期望的场景。</p>
<p>主要包括：</p>
<ul>
<li>Pod期望的副本数（replicas）</li>
<li>用于筛选目标Pod的Label Selector</li>
<li>用于创建Pod的模板（template）</li>
</ul>
<p>RC特性说明：</p>
<ol>
<li>Pod的缩放可以通过以下命令实现：kubectl scale rc redis-slave --replicas=3</li>
<li>删除RC并不会删除该RC创建的Pod，可以将副本数设置为0，即可删除对应Pod。或者通过kubectl stop /delete命令来一次性删除RC和其创建的Pod。</li>
<li>改变RC中Pod模板的镜像版本可以实现滚动升级（Rolling Update）。具体操作见<a href="https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/">https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/</a></li>
<li>Kubernetes1.2以上版本将RC升级为Replica Set，它与当前RC的唯一区别在于Replica Set支持基于集合的Label Selector(Set-based selector)，而旧版本RC只支持基于等式的Label Selector(equality-based selector)。</li>
<li>Kubernetes1.2以上版本通过Deployment来维护Replica Set而不是单独使用Replica Set。即控制流为：Delpoyment→Replica Set→Pod。即新版本的Deployment+Replica Set替代了RC的作用。</li>
</ol>
<h1 id="6-deployment">6. Deployment</h1>
<p>Deployment是kubernetes 1.2引入的概念，用来解决Pod的编排问题。Deployment可以理解为RC的升级版（RC+Reolicat Set）。特点在于可以随时知道Pod的部署进度，即对Pod的创建、调度、绑定节点、启动容器完整过程的进度展示。</p>
<p><strong>使用场景</strong></p>
<ol>
<li>创建一个Deployment对象来生成对应的Replica Set并完成Pod副本的创建过程。</li>
<li>检查Deployment的状态来确认部署动作是否完成（Pod副本的数量是否达到预期值）。</li>
<li>更新Deployment以创建新的Pod(例如镜像升级的场景)。</li>
<li>如果当前Deployment不稳定，回退到上一个Deployment版本。</li>
<li>挂起或恢复一个Deployment。</li>
</ol>
<p>可以通过kubectl describe deployment来查看Deployment控制的Pod的水平拓展过程。</p>
<h1 id="7-horizontal-pod-autoscaler-hpa">7. Horizontal Pod Autoscaler(HPA)</h1>
<p>Horizontal Pod Autoscaler(HPA)即Pod横向自动扩容，与RC一样也属于k8s的资源对象。</p>
<p>HPA原理：通过追踪分析RC控制的所有目标Pod的负载变化情况，来确定是否针对性调整Pod的副本数。</p>
<p>Pod负载度量指标：</p>
<ul>
<li>CPUUtilizationPercentage：Pod所有副本自身的CPU利用率的平均值。即当前Pod的CPU使用量除以Pod Request的值。</li>
<li>应用自定义的度量指标，比如服务每秒内响应的请求数（TPS/QPS）。</li>
</ul>
<h1 id="8-service-服务">8. Service(服务)</h1>
<h2 id="8-1-service概述">8.1. Service概述</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578930/article/kubernetes/concept/service.png" alt="service"></p>
<p>Service定义了一个服务的访问入口地址，前端应用通过这个入口地址访问其背后的一组由Pod副本组成的集群实例，Service与其后端的Pod副本集群之间是通过Label Selector来实现“无缝对接”。RC保证Service的Pod副本实例数目保持预期水平。</p>
<h2 id="8-2-kubernetes的服务发现机制">8.2. kubernetes的服务发现机制</h2>
<p>主要通过kube-dns这个组件来进行DNS方式的服务发现。</p>
<h2 id="8-3-外部系统访问service的问题">8.3. 外部系统访问Service的问题</h2>
<table>
<thead>
<tr>
<th>IP类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Node IP</td>
<td>Node节点的IP地址</td>
</tr>
<tr>
<td>Pod IP</td>
<td>Pod的IP地址</td>
</tr>
<tr>
<td>Cluster IP</td>
<td>Service的IP地址</td>
</tr>
</tbody>
</table>
<h2 id="8-3-1-node-ip">8.3.1. Node IP</h2>
<p>NodeIP是集群中每个节点的物理网卡IP地址，是真实存在的物理网络，kubernetes集群之外的节点访问kubernetes内的某个节点或TCP/IP服务的时候，需要通过NodeIP进行通信。</p>
<h2 id="8-3-2-pod-ip">8.3.2. Pod IP</h2>
<p>Pod IP是每个Pod的IP地址，是Docker Engine根据docker0网桥的IP段地址进行分配的，是一个虚拟二层网络，集群中一个Pod的容器访问另一个Pod中的容器，是通过Pod IP进行通信的，而真实的TCP/IP流量是通过Node IP所在的网卡流出的。</p>
<h2 id="8-3-3-cluster-ip">8.3.3. Cluster IP</h2>
<ol>
<li>Service的Cluster IP是一个虚拟IP，只作用于Service这个对象，由kubernetes管理和分配IP地址（来源于Cluster IP地址池）。</li>
<li>Cluster IP无法被ping通，因为没有一个实体网络对象来响应。</li>
<li>Cluster IP结合Service Port组成的具体通信端口才具备TCP/IP通信基础，属于kubernetes集群内，集群外访问该IP和端口需要额外处理。</li>
<li>k8s集群内Node IP 、Pod IP、Cluster IP之间的通信采取k8s自己的特殊的路由规则，与传统IP路由不同。</li>
</ol>
<h2 id="8-3-4-外部访问kubernetes集群">8.3.4. 外部访问Kubernetes集群</h2>
<p>通过宿主机与容器端口映射的方式进行访问，例如：Service定位文件如下：</p>
<p>可以通过任意Node的IP 加端口访问该服务。也可以通过Nginx或HAProxy来设置负载均衡。</p>
<h1 id="9-volume-存储卷">9. Volume(存储卷)</h1>
<h2 id="9-1-volume的功能">9.1. Volume的功能</h2>
<ol>
<li>Volume是Pod中能够被多个容器访问的共享目录，可以让容器的数据写到宿主机上或者写文件到网络存储中</li>
<li>可以实现容器配置文件集中化定义与管理，通过ConfigMap资源对象来实现。</li>
</ol>
<h2 id="9-2-volume的特点">9.2. Volume的特点</h2>
<p>k8s中的Volume与Docker的Volume相似，但不完全相同。</p>
<ol>
<li>k8s上Volume定义在Pod上，然后被一个Pod中的多个容器挂载到具体的文件目录下。</li>
<li>k8s的Volume与Pod生命周期相关而不是容器是生命周期，即容器挂掉，数据不会丢失但是Pod挂掉，数据则会丢失。</li>
<li>k8s中的Volume支持多种类型的Volume：Ceph、GlusterFS等分布式系统。</li>
</ol>
<h2 id="9-3-volume的使用方式">9.3. Volume的使用方式</h2>
<p>先在Pod上声明一个Volume，然后容器引用该Volume并Mount到容器的某个目录。</p>
<h2 id="9-4-volume类型">9.4. Volume类型</h2>
<h2 id="9-4-1-emptydir">9.4.1. emptyDir</h2>
<p>emptyDir Volume是在Pod分配到Node时创建的，初始内容为空，无须指定宿主机上对应的目录文件，由K8S自动分配一个目录，当Pod被删除时，对应的emptyDir数据也会永久删除。</p>
<p><strong>作用</strong>：</p>
<ol>
<li>临时空间，例如程序的临时文件，无须永久保留</li>
<li>长时间任务的中间过程CheckPoint的临时保存目录</li>
<li>一个容器需要从另一个容器中获取数据的目录（即多容器共享目录）</li>
</ol>
<p><strong>说明</strong>：</p>
<p>目前用户无法设置emptyVolume的使用介质，如果kubelet的配置使用硬盘则emptyDir将创建在该硬盘上。</p>
<h2 id="9-4-2-hostpath">9.4.2. hostPath</h2>
<p>hostPath是在Pod上挂载宿主机上的文件或目录。</p>
<p><strong>作用</strong>：</p>
<ol>
<li>容器应用日志需要持久化时，可以使用宿主机的高速文件系统进行存储</li>
<li>需要访问宿主机上Docker引擎内部数据结构的容器应用时，可以通过定义hostPath为宿主机/var/lib/docker目录，使容器内部应用可以直接访问Docker的文件系统。</li>
</ol>
<p><strong>注意点：</strong></p>
<ol>
<li>在不同的Node上具有相同配置的Pod可能会因为宿主机上的目录或文件不同导致对Volume上目录或文件的访问结果不一致。</li>
<li>如果使用了资源配额管理，则kubernetes无法将hostPath在宿主机上使用的资源纳入管理。</li>
</ol>
<h2 id="9-4-3-gcepersistentdisk">9.4.3. gcePersistentDisk</h2>
<p>表示使用谷歌公有云提供的永久磁盘（Persistent Disk ,PD）存放Volume的数据，它与EmptyDir不同，PD上的内容会被永久保存。当Pod被删除时，PD只是被卸载时，但不会被删除。需要先创建一个永久磁盘，才能使用gcePersistentDisk。</p>
<p>使用gcePersistentDisk的限制条件：</p>
<ul>
<li>Node(运行kubelet的节点)需要是GCE虚拟机。</li>
<li>虚拟机需要与PD存在于相同的GCE项目中和Zone中。</li>
</ul>
<h1 id="10-persistent-volume">10. Persistent Volume</h1>
<p>Volume定义在Pod上，属于“计算资源”的一部分，而Persistent Volume和Persistent Volume Claim是网络存储，简称PV和PVC，可以理解为k8s集群中某个网络存储中对应的一块存储。</p>
<ul>
<li>PV是网络存储，不属于任何Node，但可以在每个Node上访问。</li>
<li>PV不是定义在Pod上，而是独立于Pod之外定义。</li>
<li>PV常见类型：GCE Persistent Disks、NFS、RBD等。</li>
</ul>
<p>PV是有状态的对象，状态类型如下：</p>
<ul>
<li>Available:空闲状态</li>
<li>Bound:已经绑定到某个PVC上</li>
<li>Released:对应的PVC已经删除，但资源还没有回收</li>
<li>Failed:PV自动回收失败</li>
</ul>
<h1 id="11-namespace">11. Namespace</h1>
<p>Namespace即命名空间，主要用于多租户的资源隔离，通过将资源对象分配到不同的Namespace上，便于不同的分组在共享资源的同时可以被分别管理。</p>
<p>k8s集群启动后会默认创建一个“default”的Namespace。可以通过kubectl get namespaecs查看。</p>
<p>可以通过kubectl config use-context <code>namespace</code>配置当前k8s客户端的环境，通过kubectl get pods获取当前namespace的Pod。或者通过kubectl get pods --namespace=<code>NAMESPACE</code>来获取指定namespace的Pod。</p>
<p><strong>Namespace yaml文件的定义</strong></p>
<h1 id="12-annotation-注解">12. Annotation(注解)</h1>
<p>Annotation与Label类似，也使用key/value的形式进行定义，Label定义元数据（Metadata）,Annotation定义“附加”信息。</p>
<p>通常Annotation记录信息如下：</p>
<ul>
<li>build信息，release信息，Docker镜像信息等。</li>
<li>日志库、监控库等。</li>
</ul>
<p>参考《Kubernetes权威指南》</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-96fe330e8ab07dd38ff1d1c60fbc950f">3.2.2 - 理解kubernetes对象</h1>
    
	<h1 id="1-kubernetes对象概述">1. kubernetes对象概述</h1>
<p>kubernetes中的对象是一些持久化的实体，可以理解为是对<code>集群状态的描述或期望</code>。</p>
<p>包括：</p>
<ul>
<li>集群中哪些node上运行了哪些容器化应用</li>
<li>应用的资源是否满足使用</li>
<li>应用的执行策略，例如重启策略、更新策略、容错策略等。</li>
</ul>
<p><strong>kubernetes的对象是一种意图（期望）的记录，kubernetes会始终保持预期创建的对象存在和集群运行在预期的状态下</strong>。</p>
<p>操作kubernetes对象（增删改查）需要通过<a href="https://kubernetes.io/docs/reference/">kubernetes API</a>，一般有以下几种方式：</p>
<ul>
<li><code>kubectl</code>命令工具</li>
<li><code>Client library</code>的方式，例如 <a href="https://github.com/kubernetes/client-go">client-go</a></li>
</ul>
<h1 id="2-spec-and-status">2. Spec and Status</h1>
<p>每个kubernetes对象的结构描述都包含<code>spec</code>和<code>status</code>两个部分。</p>
<ul>
<li><code>spec</code>：该内容由用户提供，描述用户期望的对象特征及集群状态。</li>
<li><code>status</code>：该内容由kubernetes集群提供和更新，描述kubernetes对象的实时状态。</li>
</ul>
<p>任何时候，kubernetes都会控制集群的实时状态<code>status</code>与用户的预期状态<code>spec</code>一致。</p>
<p>例如：当你定义<code>Deployment</code>的描述文件，指定集群中运行3个实例，那么kubernetes会始终保持集群中运行3个实例，如果任何实例挂掉，kubernetes会自动重建新的实例来保持集群中始终运行用户预期的3个实例。</p>
<h1 id="3-对象描述文件">3. 对象描述文件</h1>
<p>当你要创建一个kubernetes对象的时候，需要提供该对象的描述信息<code>spec</code>，来描述你的对象在kubernetes中的预期状态。</p>
<p>一般使用kubernetes API来创建kubernetes对象，其中<code>spec</code>信息可以以<code>JSON</code>的形式存放在<code>request body</code>中，也可以以<code>.yaml</code>文件的形式通过<code>kubectl</code>工具创建。</p>
<p>例如，以下为<code>Deployment</code>对象对应的<code>yaml</code>文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1beta2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># for versions before 1.8.0 use apps/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx-deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx:1.7.9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>执行<code>kubectl create</code>的命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#create command</span>
</span></span><span style="display:flex;"><span>kubectl create -f https://k8s.io/docs/user-guide/nginx-deployment.yaml --record
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#output</span>
</span></span><span style="display:flex;"><span>deployment <span style="color:#4e9a06">&#34;nginx-deployment&#34;</span> created
</span></span></code></pre></div><h1 id="4-必须字段">4. 必须字段</h1>
<p>在对象描述文件<code>.yaml</code>中，必须包含以下字段。</p>
<ul>
<li>apiVersion：kubernetes API的版本</li>
<li>kind：kubernetes对象的类型</li>
<li>metadata：唯一标识该对象的元数据，包括<code>name</code>，UID，可选的<code>namespace</code></li>
<li>spec：标识对象的详细信息，不同对象的<code>spec</code>的格式不同，可以嵌套其他对象的字段。</li>
</ul>
<p>文章参考：</p>
<p><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/kubernetes-objects/">https://kubernetes.io/docs/concepts/overview/working-with-objects/kubernetes-objects/</a></p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8c4dce12f691e4d3b4ce5485de3575e0">3.3 - Pod对象</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-ad3d37233d0ef73ff0433086563ab781">3.3.1 - Pod介绍</h1>
    
	<h1 id="1-pod是什么-what">1. Pod是什么（what）</h1>
<h2 id="1-1-pod概念">1.1. Pod概念</h2>
<ul>
<li>Pod是kubernetes集群中最小的部署和管理的<code>基本单元</code>，协同寻址，协同调度。</li>
<li>Pod是一个或多个容器的集合，是一个或一组服务（进程）的抽象集合。</li>
<li>Pod中可以共享网络和存储（可以简单理解为一个逻辑上的虚拟机，但并不是虚拟机）。</li>
<li>Pod被创建后用一个<code>UID</code>来唯一标识，当Pod生命周期结束，被一个等价Pod替代，UID将重新生成。</li>
</ul>
<h3 id="1-1-1-pod与docker">1.1.1. Pod与Docker</h3>
<ul>
<li>Docker是目前Pod最常用的容器环境，但仍支持其他容器环境。</li>
<li>Pod是一组被模块化的拥有共享命名空间和共享存储卷的容器，但并没有共享PID 命名空间（即同个Pod的不同容器中进程的PID是独立的，互相看不到非自己容器的进程）。</li>
</ul>
<h3 id="1-1-2-pod中容器的运行方式">1.1.2. Pod中容器的运行方式</h3>
<ol>
<li><strong>只运行一个单独的容器</strong></li>
</ol>
<p>即<code>one-container-per-Pod</code>模式，是最常用的模式，可以把这样的Pod看成单独的一个容器去管理。</p>
<ol start="2">
<li><strong>运行多个强关联的容器</strong></li>
</ol>
<p>即<code>sidecar</code>模式，Pod 封装了一组紧耦合、共享资源、协同寻址的容器，将这组容器作为一个管理单元。</p>
<h2 id="1-2-pod管理多个容器">1.2. Pod管理多个容器</h2>
<p>Pod是一组紧耦合的容器的集合，Pod内的容器作为一个整体以Pod形式进行协同寻址，协同调度、协同管理。相同Pod内的容器共享网络和存储。</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1535286616/article/kubernetes/pod/pod.svg" width="50%" />
<h3 id="1-2-1-网络">1.2.1. 网络</h3>
<ul>
<li>每个Pod被分配了唯一的IP地址，该Pod内的所有容器共享一个网络空间，包括IP和端口。</li>
<li>同个Pod不同容器之间通过<code>localhos</code>t通信，Pod内端口不能冲突。</li>
<li>不同Pod之间的通信则通过IP+端口的形式来访问到Pod内的具体服务（容器）。</li>
</ul>
<h3 id="1-2-2-存储">1.2.2. 存储</h3>
<ul>
<li>可以在Pod中创建共享<code>存储卷</code>的方式来实现不同容器之间数据共享。</li>
</ul>
<h1 id="2-为什么需要pod-why">2. 为什么需要Pod(why)</h1>
<h2 id="2-1-管理需求">2.1. 管理需求</h2>
<p>Pod 是一种模式的抽象：互相协作的多个进程（容器）共同形成一个完整的服务。以一个或多个容器的方式组合成一个整体，作为管理的基本单元，通过Pod可以方便部署、水平扩展，协同调度等。</p>
<h2 id="2-2-资源共享和通信">2.2. 资源共享和通信</h2>
<p>Pod作为多个紧耦合的容器的集合，通过共享网络和存储的方式来简化紧耦合容器之间的通信，从这个角度，可以将Pod简单理解为一个逻辑上的“虚拟机”。而不同的Pod之间的通信则通过Pod的IP和端口的方式。</p>
<h2 id="2-3-pod设计的优势">2.3. Pod设计的优势</h2>
<ul>
<li>调度器和控制器的可拔插性。</li>
<li>将Pod 的生存期从 controller 中剥离出来，从而减少相互影响。</li>
<li>高可用--在终止和删除 Pod 前，需要提前生成替代 Pod。</li>
<li>集群级别的功能和 Kubelet（Pod Controller） 级别的功能组合更加清晰。</li>
</ul>
<h1 id="3-pod的使用-how">3. Pod的使用(how)</h1>
<p>Pod一般是通过各种不同类型的<code>Controller</code>对Pod进行管理和控制，包括自我恢复（例如Pod因异常退出，则会再起一个相同的Pod替代该Pod，而该Pod则会被清除）。也可以不通过Controller单独创建一个Pod，但一般很少这么操作，因为这个Pod是一个孤立的实体，并不会被Controller管理。</p>
<h2 id="3-1-controller">3.1. Controller</h2>
<p><code>Controller</code>是kubernetes中用于对Pod进行管理的控制器，通过该控制器让Pod始终维持在一个用户原本设定或期望的状态。如果节点宕机或者Pod因其他原因死亡，则会在其他节点起一个相同的Pod来替代该Pod。</p>
<p>常用的Controller有：</p>
<ul>
<li><code>Deployment</code></li>
<li><code>StatefulSet</code></li>
<li><code>DaemonSet</code></li>
</ul>
<p><code>Controller</code>是通过用户提供的Pod模板来创建和控制Pod。</p>
<h2 id="3-2-pod模板">3.2. Pod模板</h2>
<p>Pod模板用来定义Pod的各种属性，Controller通过Pod模板来生成对应的Pod。</p>
<p>Pod模板类似一个饼干模具，通过模具已经生成的饼干与原模具已经没有关系，即对原模具的修改不会影响已经生成的饼干，只会对通过修改后的模具生成的饼干有影响。这种方式可以更加方便地控制和管理Pod。</p>
<h1 id="4-pod的终止">4. Pod的终止</h1>
<p>用户发起一个删除Pod的请求，系统会先发送<code>TERM</code>信号给每个容器的主进程，如果在宽限期（默认30秒）主进程没有自主终止运行，则系统会发送<code>KILL</code>信号给该进程，接着Pod将被删除。</p>
<h2 id="4-1-pod终止的流程">4.1. Pod终止的流程</h2>
<ol>
<li>用户发送一个删除 Pod 的命令， 并使用默认的宽限期（30s)。</li>
<li>把 API server 上的 pod 的时间更新成 Pod 与宽限期一起被认为 “dead” 之外的时间点。</li>
<li>使用客户端的命令，显示出的Pod的状态为 <code>terminating</code>。</li>
<li>（与第3步同时发生）Kubelet 发现某一个 Pod 由于时间超过第2步的设置而被标志成 terminating 状态时， Kubelet 将启动一个停止进程。
<ol>
<li>如果 pod 已经被定义成一个 <code>preStop hook</code>，这会在 pod 内部进行调用。如果宽限期已经过期但 preStop 锚依然还在运行，将调用第2步并在原来的宽限期上加一个小的时间窗口（2 秒钟）。</li>
<li>把 Pod 里的进程发送到 <code>TERM </code>信号。</li>
</ol>
</li>
<li>（与第3步同时发生），Pod 被从终端的服务列表里移除，同时也不再被 replication controllers 看做时一组运行中的 pods。 在负载均衡（比如说 service proxy）会将它们从轮询中移除前， Pods 这种慢关闭的方式可以继续为流量提供服务。</li>
<li>当宽期限过期时， 任何还在 Pod 里运行的进程都会被 <code>SIGKILL </code>杀掉。</li>
<li>Kubelet 通过在 API server 把宽期限设置成0(立刻删除)的方式完成删除 Pod的过程。 这时 Pod 在 API 里消失，也不再能被用户看到。</li>
</ol>
<h2 id="4-2-强制删除pod">4.2. 强制删除Pod</h2>
<p>强制删除Pod是指从k8s集群状态和Etcd中立刻删除对应的Pod数据，API Server不会等待kubelet的确认信息。被强制删除后，即可重新创建一个相同名字的Pod。</p>
<p>删除默认的宽限期是30秒，通过将宽限期设置为0的方式可以强制删除Pod。</p>
<p>通过<code>kubectl delete</code> 命令后加<code>--force</code>和<code>--grace-period=0</code>的参数强制删除Pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl delete pod &lt;pod_name&gt; --namespace<span style="color:#ce5c00;font-weight:bold">=</span>&lt;namespace&gt;  --force --grace-period<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><h2 id="4-3-pod特权模式">4.3. Pod特权模式</h2>
<p>特权模式是指让Pod中的进程具有访问宿主机系统设备或使用网络栈操作等的能力，例如编写网络插件和卷插件。</p>
<p>通过将<code>container spec</code>中的<code>SecurityContext</code>设置为<code>privileged</code>即将该容器赋予了特权模式。特权模式的使用要求k8s版本高于<code>v1.1</code>。</p>
<p>参考文章：</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/">https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod/">https://kubernetes.io/docs/concepts/workloads/pods/pod/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dfe3dc8e698614b183a38620c6373d26">3.3.2 - Pod定义文件</h1>
    
	<h1 id="1-pod的基本用法">1. Pod的基本用法</h1>
<h2 id="1-1-说明">1.1. 说明</h2>
<ol>
<li>Pod实际上是<strong>容器的集合</strong>，在k8s中对运行容器的要求为：容器的主程序需要一直在前台运行，而不是后台运行。应用可以改造成前台运行的方式，例如Go语言的程序，直接运行二进制文件；java语言则运行主类；tomcat程序可以写个运行脚本。或者通过supervisor的进程管理工具，即supervisor在前台运行，应用程序由supervisor管理在后台运行。具体可参考<a href="http://blog.csdn.net/huwh_/article/details/77108245">supervisord</a>。</li>
<li>当多个应用之间是紧耦合的关系时，可以将多个应用一起放在一个Pod中，同个Pod中的多个容器之间互相访问可以通过localhost来通信（可以把Pod理解成一个虚拟机，共享网络和存储卷）。</li>
</ol>
<h2 id="1-2-pod相关命令">1.2. Pod相关命令</h2>
<table>
<thead>
<tr>
<th>操作</th>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>创建</td>
<td>kubectl create -f frontend-localredis-pod.yaml</td>
<td></td>
</tr>
<tr>
<td>查询Pod运行状态</td>
<td>kubectl get pods --namespace=<code>&lt;NAMESPACE&gt;</code></td>
<td></td>
</tr>
<tr>
<td>查询Pod详情</td>
<td>kebectl describe pod <code>&lt;POD_NAME&gt;</code> --namespace=<code>&lt;NAMESPACE&gt;</code></td>
<td>该命令常用来排查问题，查看Event事件</td>
</tr>
<tr>
<td>删除</td>
<td>kubectl delete pod <code>&lt;POD_NAME&gt;</code> ;kubectl delete pod --all</td>
<td></td>
</tr>
<tr>
<td>更新</td>
<td>kubectl replace pod.yaml</td>
<td>-</td>
</tr>
</tbody>
</table>
<h1 id="2-pod的定义文件">2. Pod的定义文件</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namaspace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">images</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">imagePullPolice</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Always | Never | IfNotPresent]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">string]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">string]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">workingDir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">readOnly</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">boolean</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">int</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hostPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">int</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">livenessProbe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">exec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">string]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">httpGet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">int</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">scheme</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">httpHeaders</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">tcpSocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">int</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">initialDelaySeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">number</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">timeoutSeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">number</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">periodSeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">number</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">successThreshold</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">failureThreshold</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">securityContext</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">privileged</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">restartPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Always | Never | OnFailure]   </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">nodeSelector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">object</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">imagePullSecrets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hostNetwork</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">emptyDir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">secret</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">secretName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">items</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">configMap</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">items</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">string</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="3-静态pod">3. 静态pod</h1>
<p>静态Pod是由kubelet进行管理，仅存在于特定Node上的Pod。它们不能通过API Server进行管理，无法与ReplicationController、Deployment或DaemonSet进行关联，并且kubelet也无法对其健康检查。</p>
<p>静态Pod总是由kubelet创建，并且总在kubelet所在的Node上运行。</p>
<p>创建静态Pod的方式：</p>
<h2 id="3-1-通过配置文件方式">3.1. 通过配置文件方式</h2>
<p>需要设置kubelet的启动参数“–config”，指定kubelet需要监控的配置文件所在目录，kubelet会定期扫描该目录，并根据该目录的.yaml或.json文件进行创建操作。静态Pod无法通过API Server删除（若删除会变成pending状态），如需删除该Pod则将yaml或json文件从这个目录中删除。</p>
<p>例如：</p>
<p>配置目录为/etc/kubelet.d/，配置启动参数：--config=/etc/kubelet.d/，该目录下放入static-web.yaml。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">static-web</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">static-web</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">static-web</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">web</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>参考文章</p>
<ul>
<li>《Kubernetes权威指南》</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2ce568b236047ef5eb3a0c713a4ef70d">3.3.3 - Pod生命周期</h1>
    
	<h1 id="1-pod-phase">1. Pod phase</h1>
<p>Pod的<code>phase</code>是Pod生命周期中的简单宏观描述，定义在Pod的<code>PodStatus</code>对象的<code>phase</code> 字段中。</p>
<p><code>phase</code>有以下几种值：</p>
<table>
<thead>
<tr>
<th>状态值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>挂起（Pending）</code></td>
<td>Pod 已被 Kubernetes 系统接受，但有一个或者多个容器镜像尚未创建。等待时间包括调度 Pod 的时间和通过网络下载镜像的时间。</td>
</tr>
<tr>
<td><code>运行中（Running）</code></td>
<td>该 Pod 已经绑定到了一个节点上，Pod 中所有的容器都已被创建。至少有一个容器正在运行，或者正处于启动或重启状态。</td>
</tr>
<tr>
<td><code>成功（Succeeded）</code></td>
<td>Pod 中的所有容器都被成功终止，并且不会再重启。</td>
</tr>
<tr>
<td><code>失败（Failed）</code></td>
<td>Pod 中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说，容器以非0状态退出或者被系统终止。</td>
</tr>
<tr>
<td><code>未知（Unknown）</code></td>
<td>因为某些原因无法取得 Pod 的状态，通常是因为与 Pod 所在主机通信失败。</td>
</tr>
</tbody>
</table>
<h1 id="2-pod-状态">2. Pod 状态</h1>
<p>Pod 有一个 <code>PodStatus</code> 对象，其中包含一个 <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#podcondition-v1-core">PodCondition</a> 数组。 <code>PodCondition</code>包含以下以下字段：</p>
<ul>
<li><code>lastProbeTime</code>：Pod condition最后一次被探测到的时间戳。</li>
<li><code>lastTransitionTime</code>：Pod最后一次状态转变的时间戳。</li>
<li><code>message</code>：状态转化的信息，一般为报错信息，例如：containers with unready status: [c-1]。</li>
<li><code>reason</code>：最后一次状态形成的原因，一般为报错原因，例如：ContainersNotReady。</li>
<li><code>status</code>：包含的值有 True、False 和 Unknown。</li>
<li><code>type</code>：Pod状态的几种类型。</li>
</ul>
<p>其中type字段包含以下几个值：</p>
<ul>
<li><code>PodScheduled</code>：Pod已经被调度到运行节点。</li>
<li><code>Ready</code>：Pod已经可以接收请求提供服务。</li>
<li><code>Initialized</code>：所有的init container已经成功启动。</li>
<li><code>Unschedulable</code>：无法调度该Pod，例如节点资源不够。</li>
<li><code>ContainersReady</code>：Pod中的所有容器已准备就绪。</li>
</ul>
<h1 id="3-重启策略">3. 重启策略</h1>
<p>Pod通过<code>restartPolicy</code>字段指定重启策略，重启策略类型为：Always、OnFailure 和 Never，默认为 Always。</p>
<p><code>restartPolicy</code> 仅指通过同一节点上的 kubelet 重新启动容器。</p>
<table>
<thead>
<tr>
<th>重启策略</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Always</td>
<td>当容器失效时，由kubelet自动重启该容器</td>
</tr>
<tr>
<td>OnFailure</td>
<td>当容器终止运行且退出码不为0时，由kubelet自动重启该容器</td>
</tr>
<tr>
<td>Never</td>
<td>不论容器运行状态如何，kubelet都不会重启该容器</td>
</tr>
</tbody>
</table>
<p><strong>说明</strong>：</p>
<p>可以管理Pod的控制器有Replication Controller，Job，DaemonSet，及kubelet（静态Pod）。</p>
<ol>
<li>RC和DaemonSet：必须设置为Always，需要保证该容器持续运行。</li>
<li>Job：OnFailure或Never，确保容器执行完后不再重启。</li>
<li>kubelet：在Pod失效的时候重启它，不论RestartPolicy设置为什么值，并且不会对Pod进行健康检查。</li>
</ol>
<h1 id="4-pod的生命">4. Pod的生命</h1>
<p>Pod的生命周期一般通过<code>Controler</code>	的方式管理，每种<code>Controller</code>都会包含<code>PodTemplate</code>来指明Pod的相关属性，Controller可以自动对pod的异常状态进行重新调度和恢复，除非通过Controller的方式删除其管理的Pod，不然kubernetes始终运行用户预期状态的Pod。</p>
<p><strong>控制器的分类</strong></p>
<ul>
<li>使用 <code>Job</code>运行预期会终止的 Pod，例如批量计算。Job 仅适用于重启策略为 <code>OnFailure</code> 或 <code>Never</code> 的 Pod。</li>
<li>对预期不会终止的 Pod 使用 <code>ReplicationController</code>、<code>ReplicaSet</code>和 <code>Deployment</code>，例如 Web 服务器。 ReplicationController 仅适用于具有 <code>restartPolicy</code> 为 Always 的 Pod。</li>
<li>提供特定于机器的系统服务，使用 <code>DaemonSet</code>为每台机器运行一个 Pod 。</li>
</ul>
<p>如果节点死亡或与集群的其余部分断开连接，则 Kubernetes 将应用一个策略将丢失节点上的所有 Pod 的 <code>phase</code> 设置为 <code>Failed</code>。</p>
<h1 id="5-pod状态转换">5. Pod状态转换</h1>
<p><strong>常见的状态转换</strong></p>
<table>
<thead>
<tr>
<th>Pod的容器数</th>
<th>Pod当前状态</th>
<th>发生的事件</th>
<th>Pod结果状态</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td></td>
<td></td>
<td>RestartPolicy=Always</td>
<td>RestartPolicy=OnFailure</td>
<td>RestartPolicy=Never</td>
</tr>
<tr>
<td>包含一个容器</td>
<td>Running</td>
<td>容器成功退出</td>
<td>Running</td>
<td>Succeeded</td>
<td>Succeeded</td>
</tr>
<tr>
<td>包含一个容器</td>
<td>Running</td>
<td>容器失败退出</td>
<td>Running</td>
<td>Running</td>
<td>Failure</td>
</tr>
<tr>
<td>包含两个容器</td>
<td>Running</td>
<td>1个容器失败退出</td>
<td>Running</td>
<td>Running</td>
<td>Running</td>
</tr>
<tr>
<td>包含两个容器</td>
<td>Running</td>
<td>容器被OOM杀掉</td>
<td>Running</td>
<td>Running</td>
<td>Failure</td>
</tr>
</tbody>
</table>
<h2 id="5-1-容器运行时内存超出限制">5.1. 容器运行时内存超出限制</h2>
<ul>
<li>容器以失败状态终止。</li>
<li>记录 OOM 事件。</li>
<li>如果<code>restartPolicy</code>为：
<ul>
<li>Always：重启容器；Pod <code>phase</code> 仍为 Running。</li>
<li>OnFailure：重启容器；Pod <code>phase</code> 仍为 Running。</li>
<li>Never: 记录失败事件；Pod <code>phase</code> 仍为 Failed。</li>
</ul>
</li>
</ul>
<h2 id="5-2-磁盘故障">5.2. 磁盘故障</h2>
<ul>
<li>杀掉所有容器。</li>
<li>记录适当事件。</li>
<li>Pod <code>phase</code> 变成 Failed。</li>
<li>如果使用控制器来运行，Pod 将在别处重建。</li>
</ul>
<h2 id="5-3-运行节点挂掉">5.3. 运行节点挂掉</h2>
<ul>
<li>节点控制器等待直到超时。</li>
<li>节点控制器将 Pod <code>phase</code> 设置为 Failed。</li>
<li>如果是用控制器来运行，Pod 将在别处重建。</li>
</ul>
<p>参考文章：</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/">https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f8cc746df04add11975d611fdc6db65f">3.3.4 - Pod健康检查</h1>
    
	<h1 id="pod健康检查">Pod健康检查</h1>
<p>Pod的健康状态由两类探针来检查：<code>LivenessProbe</code>和<code>ReadinessProbe</code>。</p>
<h2 id="1-探针类型">1. 探针类型</h2>
<p><strong>1. livenessProbe(存活探针)</strong></p>
<ul>
<li>表明容器是否正在运行。</li>
<li><strong>如果存活探测失败，则 kubelet 会杀死容器</strong>，并且容器将受到其 <code>重启策略</code>的影响。</li>
<li>如果容器不提供存活探针，则默认状态为 <code>Success</code>。</li>
</ul>
<p><strong>2. readinessProbe(就绪探针)</strong></p>
<ul>
<li>表明容器是否可以正常接受请求。</li>
<li><strong>如果就绪探测失败，端点控制器将从与 Pod 匹配的所有 Service 的端点中删除该 Pod 的 IP 地址</strong>。</li>
<li>初始延迟之前的就绪状态默认为 <code>Failure</code>。</li>
<li>如果容器不提供就绪探针，则默认状态为 <code>Success</code>。</li>
</ul>
<h2 id="2-探针使用场景">2. 探针使用场景</h2>
<ul>
<li>如果容器异常可以自动崩溃，则不一定要使用探针，可以由Pod的<code>restartPolicy</code>执行重启操作。</li>
<li><code>存活探针</code>适用于希望容器探测失败后被杀死并重新启动，需要指定<code>restartPolicy</code> 为 Always 或 OnFailure。</li>
<li><code>就绪探针</code>适用于希望Pod在不能正常接收流量的时候被剔除，并且在就绪探针探测成功后才接收流量。</li>
</ul>
<p><code>探针</code>是<code>kubelet</code>对容器执行定期的诊断，主要通过调用容器配置的四类<code>Handler</code>实现：</p>
<p><strong>Handler的类型</strong>：</p>
<ul>
<li><code>ExecAction</code>：在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功。</li>
<li><code>TCPSocketAction</code>：对指定端口上的容器的 IP 地址进行 TCP 检查。如果端口打开，则诊断被认为是成功的。</li>
<li><code>HTTPGetAction</code>：对指定的端口和路径上的容器的 IP 地址执行 HTTP Get 请求。如果响应的状态码大于等于200 且小于 400，则诊断被认为是成功的。</li>
<li><code>GRPCAction</code>：调用GRPC接口来判断服务是否健康。 如果响应的状态是 &quot;SERVING&quot;，则认为诊断成功。</li>
</ul>
<p><strong>探测结果</strong>为以下三种之一：</p>
<ul>
<li><code>成功</code>：容器通过了诊断。</li>
<li><code>失败</code>：容器未通过诊断。</li>
<li><code>未知</code>：诊断失败，因此不会采取任何行动。</li>
</ul>
<h2 id="3-探针的配置">3. 探针的配置</h2>
<p>探针配置在pod的container结构体下，<code>livenessProbe</code>和<code>readinessProbe</code>参数基本一致。</p>
<h3 id="3-1-探针通用参数">3.1. 探针通用参数</h3>
<p>常用的参数为<code>timeoutSeconds</code>、<code>periodSeconds</code>、<code>periodSeconds</code>，即接口超时时间，重试频率，重试次数三个值。</p>
<ul>
<li><code>initialDelaySeconds</code>：启动容器后首次进行健康检查的等待时间，单位为秒，<strong>默认值为0</strong>。</li>
<li><code>timeoutSeconds</code>:健康检查接口超时响应的时间，<strong>默认为1秒</strong>，最小值为1秒。</li>
<li><code>periodSeconds</code>：重试的频率，<strong>默认值为10秒</strong>，即10秒重试一次，最小值是1秒，<strong>建议可以设置为3-5秒</strong>。</li>
<li><code>failureThreshold</code>：失败重试的次数，<strong>默认值为3</strong>，最小值为1。</li>
<li><code>successThreshold</code>：最小探测成功次数，<strong>默认值为1</strong>，一般不设置。</li>
</ul>
<p>除了以上的通用参数外，<code>livenessProbe</code>和<code>readinessProbe</code>参数基本一致。以下以<code>readinessProbe</code>为例说明探针的使用方式。</p>
<h3 id="3-2-readinessprobe三种实现方式">3.2. ReadinessProbe三种实现方式</h3>
<h4 id="3-2-1-httpgetaction">3.2.1. HTTPGetAction</h4>
<p>通过容器的IP地址、端口号及路径调用HTTP Get方法，如果响应的状态码大于等于200且小于等于400，则认为容器健康。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pod-with-healthcheck</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">containnerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">readinessProbe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">httpGet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/_status/healthz</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">scheme</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">HTTP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">initialDelaySeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">periodSeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">timeoutSeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h4 id="3-2-2-tcpsocketaction">3.2.2. TCPSocketAction</h4>
<p>通过容器IP地址和端口号执行TCP检查，如果能够建立TCP连接，则表明容器健康。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pod-with-healthcheck</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">containnerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">readinessProbe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">tcpSocket</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">initialDelaySeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">timeoutSeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h4 id="3-2-3-execaction">3.2.3. ExecAction</h4>
<p>在一个容器内部执行一个命令，如果该命令状态返回值为0，则表明容器健康。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">readiness-exec</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">readiness</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tomcagcr.io/google_containers/busybox</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">/bin/sh</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- -<span style="color:#000">c</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">echo ok &gt; /tmp/health;sleep 10;rm -fr /tmp/health;sleep 600</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">readinessreadinessProbe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">exec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">cat</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">/tmp/health</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">initialDelaySeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">timeoutSeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="4-探针相关源码">4. 探针相关源码</h2>
<p>探针配置在pod的container结构体下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 存活探针
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">LivenessProbe</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Probe</span> <span style="color:#4e9a06">`json:&#34;livenessProbe,omitempty&#34; protobuf:&#34;bytes,10,opt,name=livenessProbe&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 就绪探针
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">ReadinessProbe</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Probe</span> <span style="color:#4e9a06">`json:&#34;readinessProbe,omitempty&#34; protobuf:&#34;bytes,11,opt,name=readinessProbe&#34;`</span>
</span></span></code></pre></div><h3 id="4-1-probe源码">4.1. Probe源码</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Probe</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// The action taken to determine the health of a container
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">ProbeHandler</span> <span style="color:#4e9a06">`json:&#34;,inline&#34; protobuf:&#34;bytes,1,opt,name=handler&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Number of seconds after the container has started before liveness probes are initiated.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">InitialDelaySeconds</span> <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#4e9a06">`json:&#34;initialDelaySeconds,omitempty&#34; protobuf:&#34;varint,2,opt,name=initialDelaySeconds&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Number of seconds after which the probe times out.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Defaults to 1 second. Minimum value is 1.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// More info: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle#container-probes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">TimeoutSeconds</span> <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#4e9a06">`json:&#34;timeoutSeconds,omitempty&#34; protobuf:&#34;varint,3,opt,name=timeoutSeconds&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// How often (in seconds) to perform the probe.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Default to 10 seconds. Minimum value is 1.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">PeriodSeconds</span> <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#4e9a06">`json:&#34;periodSeconds,omitempty&#34; protobuf:&#34;varint,4,opt,name=periodSeconds&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Minimum consecutive successes for the probe to be considered successful after having failed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Defaults to 1. Must be 1 for liveness and startup. Minimum value is 1.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">SuccessThreshold</span> <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#4e9a06">`json:&#34;successThreshold,omitempty&#34; protobuf:&#34;varint,5,opt,name=successThreshold&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Minimum consecutive failures for the probe to be considered failed after having succeeded.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Defaults to 3. Minimum value is 1.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">FailureThreshold</span> <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#4e9a06">`json:&#34;failureThreshold,omitempty&#34; protobuf:&#34;varint,6,opt,name=failureThreshold&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Optional duration in seconds the pod needs to terminate gracefully upon probe failure.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// The grace period is the duration in seconds after the processes running in the pod are sent
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// a termination signal and the time when the processes are forcibly halted with a kill signal.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Set this value longer than the expected cleanup time for your process.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// If this value is nil, the pod&#39;s terminationGracePeriodSeconds will be used. Otherwise, this
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// value overrides the value provided by the pod spec.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Value must be non-negative integer. The value zero indicates stop immediately via
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// the kill signal (no opportunity to shut down).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// This is a beta field and requires enabling ProbeTerminationGracePeriod feature gate.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Minimum value is 1. spec.terminationGracePeriodSeconds is used if unset.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">TerminationGracePeriodSeconds</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int64</span> <span style="color:#4e9a06">`json:&#34;terminationGracePeriodSeconds,omitempty&#34; protobuf:&#34;varint,7,opt,name=terminationGracePeriodSeconds&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-2-probehandler源码">4.2. ProbeHandler源码</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ProbeHandler defines a specific action that should be taken in a probe.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// One and only one of the fields must be specified.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ProbeHandler</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Exec specifies the action to take.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Exec</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ExecAction</span> <span style="color:#4e9a06">`json:&#34;exec,omitempty&#34; protobuf:&#34;bytes,1,opt,name=exec&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// HTTPGet specifies the http request to perform.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">HTTPGet</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">HTTPGetAction</span> <span style="color:#4e9a06">`json:&#34;httpGet,omitempty&#34; protobuf:&#34;bytes,2,opt,name=httpGet&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// TCPSocket specifies an action involving a TCP port.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">TCPSocket</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TCPSocketAction</span> <span style="color:#4e9a06">`json:&#34;tcpSocket,omitempty&#34; protobuf:&#34;bytes,3,opt,name=tcpSocket&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// GRPC specifies an action involving a GRPC port.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// This is a beta field and requires enabling GRPCContainerProbe feature gate.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +featureGate=GRPCContainerProbe
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">GRPC</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">GRPCAction</span> <span style="color:#4e9a06">`json:&#34;grpc,omitempty&#34; protobuf:&#34;bytes,4,opt,name=grpc&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-3-probeaction">4.3. ProbeAction</h3>
<h4 id="4-3-1-httpgetaction">4.3.1. HTTPGetAction</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HTTPHeader describes a custom header to be used in HTTP probes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">HTTPHeader</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// The header field name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;name&#34; protobuf:&#34;bytes,1,opt,name=name&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// The header field value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Value</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;value&#34; protobuf:&#34;bytes,2,opt,name=value&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HTTPGetAction describes an action based on HTTP Get requests.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">HTTPGetAction</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Path to access on the HTTP server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Path</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;path,omitempty&#34; protobuf:&#34;bytes,1,opt,name=path&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Name or number of the port to access on the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Number must be in the range 1 to 65534. 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Name must be an IANA_SVC_NAME.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Port</span> <span style="color:#000">intstr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IntOrString</span> <span style="color:#4e9a06">`json:&#34;port&#34; protobuf:&#34;bytes,2,opt,name=port&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Host name to connect to, defaults to the pod IP. You probably want to set
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// &#34;Host&#34; in httpHeaders instead.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Host</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;host,omitempty&#34; protobuf:&#34;bytes,3,opt,name=host&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Scheme to use for connecting to the host.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Defaults to HTTP.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Scheme</span> <span style="color:#000">URIScheme</span> <span style="color:#4e9a06">`json:&#34;scheme,omitempty&#34; protobuf:&#34;bytes,4,opt,name=scheme,casttype=URIScheme&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Custom headers to set in the request. HTTP allows repeated headers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">HTTPHeaders</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">HTTPHeader</span> <span style="color:#4e9a06">`json:&#34;httpHeaders,omitempty&#34; protobuf:&#34;bytes,5,rep,name=httpHeaders&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// URIScheme identifies the scheme used for connection to a host for Get actions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// +enum
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">URIScheme</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// URISchemeHTTP means that the scheme used will be http://
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">URISchemeHTTP</span> <span style="color:#000">URIScheme</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;HTTP&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// URISchemeHTTPS means that the scheme used will be https://
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">URISchemeHTTPS</span> <span style="color:#000">URIScheme</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;HTTPS&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h4 id="4-3-2-tcpsocketaction">4.3.2. TCPSocketAction</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TCPSocketAction describes an action based on opening a socket
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">TCPSocketAction</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Number or name of the port to access on the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Number must be in the range 1 to 65534. 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Name must be an IANA_SVC_NAME.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Port</span> <span style="color:#000">intstr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IntOrString</span> <span style="color:#4e9a06">`json:&#34;port&#34; protobuf:&#34;bytes,1,opt,name=port&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Optional: Host name to connect to, defaults to the pod IP.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Host</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;host,omitempty&#34; protobuf:&#34;bytes,2,opt,name=host&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="4-3-3-execaction">4.3.3. ExecAction</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ExecAction describes a &#34;run in container&#34; action.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ExecAction</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Command is the command line to execute inside the container, the working directory for the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// command  is root (&#39;/&#39;) in the container&#39;s filesystem. The command is simply exec&#39;d, it is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// not run inside a shell, so traditional shell instructions (&#39;|&#39;, etc) won&#39;t work. To use
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// a shell, you need to explicitly call out to that shell.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Exit status of 0 is treated as live/healthy and non-zero is unhealthy.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Command</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;command,omitempty&#34; protobuf:&#34;bytes,1,rep,name=command&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h4 id="4-3-4-grpcaction">4.3.4. GRPCAction</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">GRPCAction</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Port number of the gRPC service. Number must be in the range 1 to 65534. 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Port</span> <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#4e9a06">`json:&#34;port&#34; protobuf:&#34;bytes,1,opt,name=port&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Service is the name of the service to place in the gRPC HealthCheckRequest
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// (see https://github.com/grpc/grpc/blob/master/doc/health-checking.md).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// If this is not specified, the default behavior is defined by gRPC.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +optional
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +default=&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Service</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;service&#34; protobuf:&#34;bytes,2,opt,name=service&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考文章：</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/">https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">配置存活、就绪和启动探针 | Kubernetes</a></li>
<li><a href="https://mp.weixin.qq.com/s/ApD8D0_UAPftUjw-0Txcyw">https://mp.weixin.qq.com/s/ApD8D0_UAPftUjw-0Txcyw</a></li>
<li>《Kubernetes权威指南》</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e9050fa070dd1f1567bd49d2d8fb0629">3.3.5 - Pod存储卷</h1>
    
	<h1 id="pod-volume">Pod Volume</h1>
<p>同一个Pod中的多个容器可以共享Pod级别的存储卷Volume,Volume可以定义为各种类型，多个容器各自进行挂载，将Pod的Volume挂载为容器内部需要的目录。</p>
<p>例如：Pod级别的Volume:&quot;app-logs&quot;,用于tomcat向其中写日志文件，busybox读日志文件。</p>
<p><img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1512804287/article/kubernetes/pod/pod_volume.png" alt="这里写图片描述"></p>
<p><strong>pod-volumes-applogs.yaml</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">volume-pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tomcat</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tomcat</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app-logs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/usr/local/tomcat/logs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">busybox</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">busybox</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;sh&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;-c&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;tailf /logs/catalina*.log&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app-logs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/logs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app-logs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">emptuDir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>查看日志</strong></p>
<ol>
<li>kubectl logs <code>&lt;pod_name&gt;</code> -c <code>&lt;container_name&gt;</code></li>
<li>kubectl exec -it <code>&lt;pod_name&gt;</code> -c <code>&lt;container_name&gt;</code> – tail /usr/local/tomcat/logs/catalina.xx.log</li>
</ol>
<p>参考文章</p>
<ul>
<li>《Kubernetes权威指南》</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-61971721a88dac7a1e8a7796dc21b6d3">3.3.6 - Pod调度</h1>
    
	<h1 id="pod调度">Pod调度</h1>
<p>在kubernetes集群中，Pod（container）是应用的载体，一般通过RC、Deployment、DaemonSet、Job等对象来完成Pod的调度与自愈功能。</p>
<h2 id="1-rc-deployment-全自动调度">1. RC、Deployment:全自动调度</h2>
<p>RC的功能即保持集群中始终运行着指定个数的Pod。</p>
<p>在调度策略上主要有：</p>
<ul>
<li>系统内置调度算法[最优Node]</li>
<li>NodeSelector[定向调度]</li>
<li>NodeAffinity[亲和性调度]</li>
</ul>
<h2 id="2-nodeselector-定向调度">2. NodeSelector[定向调度]</h2>
<p>k8s中kube-scheduler负责实现Pod的调度，内部系统通过一系列算法最终计算出最佳的目标节点。如果需要将Pod调度到指定Node上，则可以通过Node的标签（Label）和Pod的nodeSelector属性相匹配来达到目的。</p>
<p>1、kubectl label nodes {node-name} {label-key}={label-value}</p>
<p>2、nodeSelector:
{label-key}:{label-value}</p>
<p>如果给多个Node打了相同的标签，则scheduler会根据调度算法从这组Node中选择一个可用的Node来调度。</p>
<p>如果Pod的nodeSelector的标签在Node中没有对应的标签，则该Pod无法被调度成功。</p>
<p><strong>Node标签的使用场景：</strong></p>
<p>对集群中不同类型的Node打上不同的标签，可控制应用运行Node的范围。例如role=frontend;role=backend;role=database。</p>
<h2 id="3-nodeaffinity-亲和性调度">3. NodeAffinity[亲和性调度]</h2>
<p>NodeAffinity意为Node亲和性调度策略，NodeSelector为精确匹配，NodeAffinity为条件范围匹配，通过In（属于）、NotIn（不属于）、Exists（存在一个条件）、DoesNotExist（不存在）、Gt（大于）、Lt（小于）等操作符来选择Node，使调度更加灵活。</p>
<ul>
<li>RequiredDuringSchedulingRequiredDuringExecution：类似于NodeSelector，但在Node不满足条件时，系统将从该Node上移除之前调度上的Pod。</li>
<li>RequiredDuringSchedulingIgnoredDuringExecution：与上一个类似，区别是在Node不满足条件时，系统不一定从该Node上移除之前调度上的Pod。</li>
<li>PreferredDuringSchedulingIgnoredDuringExecution：指定在满足调度条件的Node中，哪些Node应更优先地进行调度。同时在Node不满足条件时，系统不一定从该Node上移除之前调度上的Pod。</li>
</ul>
<p>如果同时设置了NodeSelector和NodeAffinity，则系统将需要同时满足两者的设置才能进行调度。</p>
<h2 id="4-daemonset-特定场景调度">4. DaemonSet：特定场景调度</h2>
<p>DaemonSet是kubernetes1.2版本新增的一种资源对象，用于管理在集群中<strong>每个Node</strong>上<strong>仅运行一份Pod</strong>的副本实例。</p>
<p><img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1512804287/article/kubernetes/pod/monitor_pod.png" alt="这里写图片描述"></p>
<p>该用法适用的应用场景：</p>
<ul>
<li>在每个Node上运行一个GlusterFS存储或者Ceph存储的daemon进程。</li>
<li>在每个Node上运行一个日志采集程序：fluentd或logstach。</li>
<li>在每个Node上运行一个健康程序，采集该Node的运行性能数据，例如：Prometheus Node Exportor、collectd、New Relic agent或Ganglia gmond等。</li>
</ul>
<p>DaemonSet的Pod调度策略与RC类似，除了使用系统内置算法在每台Node上进行调度，也可以通过NodeSelector或NodeAffinity来指定满足条件的Node范围进行调度。</p>
<h2 id="5-job-批处理调度">5. Job：批处理调度</h2>
<p>kubernetes从1.2版本开始支持批处理类型的应用，可以通过kubernetes Job资源对象来定义并启动一个批处理任务。批处理任务通常并行（或串行）启动多个计算进程去处理一批工作项（work item），处理完后，整个批处理任务结束。</p>
<h3 id="5-1-批处理的三种模式">5.1. 批处理的三种模式</h3>
<p><img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1512804286/article/kubernetes/pod/k8s_job.png" alt="这里写图片描述"></p>
<p>批处理按任务实现方式不同分为以下几种模式：</p>
<ul>
<li>
<p><strong>Job Template Expansion模式</strong>
一个Job对象对应一个待处理的Work item，有几个Work item就产生几个独立的Job，通过适用于Work item数量少，每个Work item要处理的数据量比较大的场景。例如有10个文件（Work item）,每个文件（Work item）为100G。</p>
</li>
<li>
<p><strong>Queue with Pod Per Work Item</strong>
采用一个任务队列存放Work item，一个Job对象作为消费者去完成这些Work item，其中Job会启动N个Pod，每个Pod对应一个Work item。</p>
</li>
<li>
<p><strong>Queue with Variable Pod Count</strong>
采用一个任务队列存放Work item，一个Job对象作为消费者去完成这些Work item，其中Job会启动N个Pod，每个Pod对应一个Work item。<strong>但Pod的数量是可变的</strong>。</p>
</li>
</ul>
<h3 id="5-2-job的三种类型">5.2. Job的三种类型</h3>
<p><strong>1）Non-parallel Jobs</strong></p>
<p>通常一个Job只启动一个Pod,除非Pod异常才会重启该Pod,一旦此Pod正常结束，Job将结束。</p>
<p><strong>2）Parallel Jobs with a fixed completion count</strong></p>
<p>并行Job会启动多个Pod，此时需要设定Job的.spec.completions参数为一个正数，当正常结束的Pod数量达到该值则Job结束。</p>
<p><strong>3）Parallel Jobs with a work queue</strong></p>
<p>任务队列方式的并行Job需要一个独立的Queue，Work item都在一个Queue中存放，不能设置Job的.spec.completions参数。</p>
<p>此时Job的特性：</p>
<ul>
<li>每个Pod能独立判断和决定是否还有任务项需要处理</li>
<li>如果某个Pod正常结束，则Job不会再启动新的Pod</li>
<li>如果一个Pod成功结束，则此时应该不存在其他Pod还在干活的情况，它们应该都处于即将结束、退出的状态</li>
<li>如果所有的Pod都结束了，且至少一个Pod成功结束，则整个Job算是成功结束</li>
</ul>
<p>参考文章</p>
<ul>
<li>《Kubernetes权威指南》</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e8afcbe09f3cadc6988fab9470d287a9">3.3.7 - Pod伸缩与升级</h1>
    
	<h1 id="1-pod伸缩">1. Pod伸缩</h1>
<p>k8s中RC的用来保持集群中始终运行指定数目的实例，通过RC的scale机制可以完成Pod的扩容和缩容（伸缩）。</p>
<h2 id="1-1-手动伸缩-scale">1.1. 手动伸缩（scale）</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl scale rc redis-slave --replicas<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span></code></pre></div><h2 id="1-2-自动伸缩-hpa">1.2. 自动伸缩（HPA）</h2>
<p>Horizontal Pod Autoscaler（HPA）控制器用于实现基于CPU使用率进行自动Pod伸缩的功能。HPA控制器基于Master的kube-controller-manager服务启动参数--horizontal-pod-autoscaler-sync-period定义是时长（默认30秒），周期性监控目标Pod的CPU使用率，并在满足条件时对ReplicationController或Deployment中的Pod副本数进行调整，以符合用户定义的平均Pod CPU使用率。Pod CPU使用率来源于heapster组件，因此需安装该组件。</p>
<p>可以通过kubectl autoscale命令进行快速创建或者使用yaml配置文件进行创建。创建之前需已存在一个RC或Deployment对象，并且该RC或Deployment中的Pod必须定义resources.requests.cpu的资源请求值，以便heapster采集到该Pod的CPU。</p>
<h3 id="1-2-1-通过kubectl-autoscale创建">1.2.1. 通过kubectl autoscale创建</h3>
<p>例如：</p>
<p>php-apache-rc.yaml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicationController</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">php-apache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">php-apache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">php-apache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">php-apache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gcr.io/google_containers/hpa-example</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">200m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建php-apache的RC</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create -f php-apache-rc.yaml
</span></span></code></pre></div><p>php-apache-svc.yaml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">php-apache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">php-apache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建php-apache的Service</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create -f php-apache-svc.yaml
</span></span></code></pre></div><p>创建HPA控制器</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl autoscale rc php-apache --min<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span> --max<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span> --cpu-percent<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">50</span>
</span></span></code></pre></div><h3 id="1-2-2-通过yaml配置文件创建">1.2.2. 通过yaml配置文件创建</h3>
<p>hpa-php-apache.yaml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">HorizontalPodAutoscaler</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">php-apache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">scaleTargetRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicationController</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">php-apache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">minReplicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">maxReplicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">targetCPUUtilizationPercentage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建hpa</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create -f hpa-php-apache.yaml
</span></span></code></pre></div><p>查看hpa</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get hpa
</span></span></code></pre></div><h1 id="2-pod滚动升级">2. Pod滚动升级</h1>
<p>k8s中的滚动升级通过执行kubectl rolling-update命令完成，该命令创建一个新的RC（与旧的RC在同一个命名空间中），然后自动控制旧的RC中的Pod副本数逐渐减少为0，同时新的RC中的Pod副本数从0逐渐增加到附加值，但滚动升级中Pod副本数（包括新Pod和旧Pod）保持原预期值。</p>
<h2 id="2-1-通过配置文件实现">2.1. 通过配置文件实现</h2>
<p>redis-master-controller-v2.yaml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicationController</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">redis-master-v2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">redis-master</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">redis-master</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">redis-master</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">master</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubeguide/redis-master:2.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6371</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>注意事项：</p>
<ol>
<li>RC的名字（name）不能与旧RC的名字相同</li>
<li>在selector中应至少有一个Label与旧的RC的Label不同，以标识其为新的RC。例如本例中新增了version的Label。</li>
</ol>
<p>运行kubectl rolling-update</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl rolling-update redis-master -f redis-master-controller-v2.yaml
</span></span></code></pre></div><h2 id="2-2-通过kubectl-rolling-update命令实现">2.2. 通过kubectl rolling-update命令实现</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl rolling-update redis-master --image<span style="color:#ce5c00;font-weight:bold">=</span>redis-master:2.0
</span></span></code></pre></div><p>与使用配置文件实现不同在于，该执行结果旧的RC被删除，新的RC仍使用旧的RC的名字。</p>
<h2 id="2-3-升级回滚">2.3. 升级回滚</h2>
<p>kubectl rolling-update加参数--rollback实现回滚操作</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl rolling-update redis-master --image<span style="color:#ce5c00;font-weight:bold">=</span>kubeguide/redis-master:2.0 --rollback
</span></span></code></pre></div><p>参考文章</p>
<ul>
<li>《Kubernetes权威指南》</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0d04a1bda6875a57535ee9e5c3a27a52">3.4 - 配置</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-8e56be8a3b34365d46ef8a4fcb36166e">3.4.1 - ConfigMap</h1>
    
	<h1 id="pod的配置管理">Pod的配置管理</h1>
<p>Kubernetes v1.2的版本提供统一的集群配置管理方案–ConfigMap。</p>
<h2 id="1-configmap-容器应用的配置管理">1. ConfigMap：容器应用的配置管理</h2>
<p>使用场景：</p>
<ol>
<li>生成为容器内的环境变量。</li>
<li>设置容器启动命令的启动参数（需设置为环境变量）。</li>
<li>以Volume的形式挂载为容器内部的文件或目录。</li>
</ol>
<p>ConfigMap以一个或多个key:value的形式保存在kubernetes系统中供应用使用，既可以表示一个变量的值（例如：apploglevel=info），也可以表示完整配置文件的内容（例如：server.xml=&lt;?xml...&gt;...）。</p>
<p>可以通过yaml配置文件或者使用kubectl create configmap命令的方式创建ConfigMap。</p>
<h2 id="2-创建configmap">2. 创建ConfigMap</h2>
<h3 id="2-1-通过yaml文件方式">2.1. 通过yaml文件方式</h3>
<p>cm-appvars.yaml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm-appvars</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apploglevel</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">info</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">appdatadir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>常用命令</p>
<p>kubectl create -f cm-appvars.yaml</p>
<p>kubectl get configmap</p>
<p>kubectl describe configmap cm-appvars</p>
<p>kubectl get configmap cm-appvars -o yaml</p>
<h3 id="2-2-通过kubectl命令行方式">2.2. 通过kubectl命令行方式</h3>
<p>通过kubectl create configmap创建，使用参数--from-file或--from-literal指定内容，可以在一行中指定多个参数。</p>
<p>1）通过--from-file参数从文件中进行创建，可以指定key的名称，也可以在一个命令行中创建包含多个key的ConfigMap。</p>
<p>kubectl create configmap NAME --from-file=[key=]source --from-file=[key=]source</p>
<p>2）通过--from-file参数从目录中进行创建，该目录下的每个配置文件名被设置为key，文件内容被设置为value。</p>
<p>kubectl create configmap NAME --from-file=config-files-dir</p>
<p>3）通过--from-literal从文本中进行创建，直接将指定的key=value创建为ConfigMap的内容。</p>
<p>kubectl create configmap NAME --from-literal=key1=value1 --from-literal=key2=value2</p>
<p>容器应用对ConfigMap的使用有两种方法：</p>
<ol>
<li>通过环境变量获取ConfigMap中的内容。</li>
<li>通过Volume挂载的方式将ConfigMap中的内容挂载为容器内部的文件或目录。</li>
</ol>
<h3 id="2-3-通过环境变量的方式">2.3. 通过环境变量的方式</h3>
<p>ConfigMap的yaml文件:cm-appvars.yaml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm-appvars</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apploglevel</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">info</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">appdatadir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Pod的yaml文件：cm-test-pod.yaml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm-test-pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm-test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">busybox</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;/bin/sh&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;-c&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;env|grep APP&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">APPLOGLEVEL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">valueFrom</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">configMapKeyRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm-appvars</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apploglevel</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">APPDATADIR</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">valueFrom</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">configMapKeyRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cm-appvars</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">appdatadir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建命令：</p>
<p>kubectl create -f cm-test-pod.yaml</p>
<p>kubectl get pods --show-all</p>
<p>kubectl logs cm-test-pod</p>
<h2 id="3-使用configmap的限制条件">3. 使用ConfigMap的限制条件</h2>
<ul>
<li>ConfigMap必须在Pod之前创建</li>
<li>ConfigMap也可以定义为属于某个Namespace。只有处于相同Namespace中的Pod可以引用它。</li>
<li>kubelet只支持可以被API Server管理的Pod使用ConfigMap。静态Pod无法引用。</li>
<li>在Pod对ConfigMap进行挂载操作时，容器内只能挂载为“目录”，无法挂载为文件。</li>
</ul>
<p>参考文章</p>
<ul>
<li>《Kubernetes权威指南》</li>
</ul>

</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a1fb9fa332b58bfec12b112c1675a9dd">4 - 核心原理</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-85131cb1d1fb89a36d60974812fecf91">4.1 - 核心组件</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-f4746143a48e6f2b14964ad1a0450bb8">4.1.1 - Kubernetes核心原理（一）之API Server</h1>
    
	<h1 id="1-api-server简介">1. API Server简介</h1>
<p>k8s API Server提供了k8s各类资源对象（pod,RC,Service等）的增删改查及watch等HTTP Rest接口，是整个系统的数据总线和数据中心。</p>
<p>kubernetes API Server的功能：</p>
<ol>
<li>提供了集群管理的REST API接口(包括认证授权、数据校验以及集群状态变更)；</li>
<li>提供其他模块之间的数据交互和通信的枢纽（其他模块通过API Server查询或修改数据，只有API Server才直接操作etcd）;</li>
<li>是资源配额控制的入口；</li>
<li>拥有完备的集群安全机制.</li>
</ol>
<p><strong>kube-apiserver工作原理图</strong></p>
<p><img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510579017/article/kubernetes/core/kube-apiserver.png" alt="kube-apiserver"></p>
<h1 id="2-如何访问kubernetes-api">2. 如何访问kubernetes API</h1>
<p>k8s通过kube-apiserver这个进程提供服务，该进程运行在单个k8s-master节点上。默认有两个端口。</p>
<h2 id="2-1-本地端口">2.1. 本地端口</h2>
<ol>
<li>该端口用于接收HTTP请求；</li>
<li>该端口默认值为8080，可以通过API Server的启动参数“--insecure-port”的值来修改默认值；</li>
<li>默认的IP地址为“localhost”，可以通过启动参数“--insecure-bind-address”的值来修改该IP地址；</li>
<li>非认证或授权的HTTP请求通过该端口访问API Server。</li>
</ol>
<h2 id="2-2-安全端口">2.2. 安全端口</h2>
<ol>
<li>该端口默认值为6443，可通过启动参数“--secure-port”的值来修改默认值；</li>
<li>默认IP地址为非本地（Non-Localhost）网络端口，通过启动参数“--bind-address”设置该值；</li>
<li>该端口用于接收HTTPS请求；</li>
<li>用于基于Tocken文件或客户端证书及HTTP Base的认证；</li>
<li>用于基于策略的授权；</li>
<li>默认不启动HTTPS安全访问控制。</li>
</ol>
<h2 id="2-3-访问方式">2.3. 访问方式</h2>
<p>Kubernetes REST API可参考<a href="https://kubernetes.io/docs/api-reference/v1.6/">https://kubernetes.io/docs/api-reference/v1.6/</a></p>
<h2 id="2-3-1-curl">2.3.1. curl</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl localhost:8080/api
</span></span><span style="display:flex;"><span>curl localhost:8080/api/v1/pods
</span></span><span style="display:flex;"><span>curl localhost:8080/api/v1/services
</span></span><span style="display:flex;"><span>curl localhost:8080/api/v1/replicationcontrollers
</span></span></code></pre></div><h2 id="2-3-2-kubectl-proxy">2.3.2. Kubectl Proxy</h2>
<p>Kubectl Proxy代理程序既能作为API Server的反向代理，也能作为普通客户端访问API Server的代理。通过master节点的8080端口来启动该代理程序。</p>
<p>kubectl proxy --port=8080 &amp;</p>
<p>具体见kubectl proxy --help</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@node5 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># kubectl proxy --help</span>
</span></span><span style="display:flex;"><span>To proxy all of the kubernetes api and nothing <span style="color:#204a87;font-weight:bold">else</span>, use:
</span></span><span style="display:flex;"><span>kubectl proxy --api-prefix<span style="color:#ce5c00;font-weight:bold">=</span>/
</span></span><span style="display:flex;"><span>To proxy only part of the kubernetes api and also some static files:
</span></span><span style="display:flex;"><span>kubectl proxy --www<span style="color:#ce5c00;font-weight:bold">=</span>/my/files --www-prefix<span style="color:#ce5c00;font-weight:bold">=</span>/static/ --api-prefix<span style="color:#ce5c00;font-weight:bold">=</span>/api/
</span></span><span style="display:flex;"><span>The above lets you <span style="color:#4e9a06">&#39;curl localhost:8001/api/v1/pods&#39;</span>.
</span></span><span style="display:flex;"><span>To proxy the entire kubernetes api at a different root, use:
</span></span><span style="display:flex;"><span>kubectl proxy --api-prefix<span style="color:#ce5c00;font-weight:bold">=</span>/custom/
</span></span><span style="display:flex;"><span>The above lets you <span style="color:#4e9a06">&#39;curl localhost:8001/custom/api/v1/pods&#39;</span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  kubectl proxy <span style="color:#ce5c00;font-weight:bold">[</span>--port<span style="color:#ce5c00;font-weight:bold">=</span>PORT<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>--www<span style="color:#ce5c00;font-weight:bold">=</span>static-dir<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>--www-prefix<span style="color:#ce5c00;font-weight:bold">=</span>prefix<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>--api-prefix<span style="color:#ce5c00;font-weight:bold">=</span>prefix<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>flags<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>Examples:
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Run a proxy to kubernetes apiserver on port 8011, serving static content from ./local/www/</span>
</span></span><span style="display:flex;"><span>$ kubectl proxy --port<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8011</span> --www<span style="color:#ce5c00;font-weight:bold">=</span>./local/www/
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Run a proxy to kubernetes apiserver on an arbitrary local port.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The chosen port for the server will be output to stdout.</span>
</span></span><span style="display:flex;"><span>$ kubectl proxy --port<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Run a proxy to kubernetes apiserver, changing the api prefix to k8s-api</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This makes e.g. the pods api available at localhost:8011/k8s-api/v1/pods/</span>
</span></span><span style="display:flex;"><span>$ kubectl proxy --api-prefix<span style="color:#ce5c00;font-weight:bold">=</span>/k8s-api
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>      --accept-hosts<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;^localhost</span>$<span style="color:#4e9a06">,^127//.0//.0//.1</span>$<span style="color:#4e9a06">,^//[::1//]</span>$<span style="color:#4e9a06">&#34;</span>: Regular expression <span style="color:#204a87;font-weight:bold">for</span> hosts that the proxy should accept.
</span></span><span style="display:flex;"><span>      --accept-paths<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;^/.*&#34;</span>: Regular expression <span style="color:#204a87;font-weight:bold">for</span> paths that the proxy should accept.
</span></span><span style="display:flex;"><span>      --api-prefix<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/&#34;</span>: Prefix to serve the proxied API under.
</span></span><span style="display:flex;"><span>      --disable-filter<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>: If true, disable request filtering in the proxy. This is dangerous, and can leave you vulnerable to XSRF attacks, when used with an accessible port.
</span></span><span style="display:flex;"><span>  -p, --port<span style="color:#ce5c00;font-weight:bold">=</span>8001: The port on which to run the proxy. Set to <span style="color:#0000cf;font-weight:bold">0</span> to pick a random port.
</span></span><span style="display:flex;"><span>      --reject-methods<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;POST,PUT,PATCH&#34;</span>: Regular expression <span style="color:#204a87;font-weight:bold">for</span> HTTP methods that the proxy should reject.
</span></span><span style="display:flex;"><span>      --reject-paths<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;^/api/.*/exec,^/api/.*/run&#34;</span>: Regular expression <span style="color:#204a87;font-weight:bold">for</span> paths that the proxy should reject.
</span></span><span style="display:flex;"><span>  -u, --unix-socket<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: Unix socket on which to run the proxy.
</span></span><span style="display:flex;"><span>  -w, --www<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: Also serve static files from the given directory under the specified prefix.
</span></span><span style="display:flex;"><span>  -P, --www-prefix<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/static/&#34;</span>: Prefix to serve static files under, <span style="color:#204a87;font-weight:bold">if</span> static file directory is specified.
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>Global Flags:
</span></span><span style="display:flex;"><span>      --alsologtostderr<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>: log to standard error as well as files
</span></span><span style="display:flex;"><span>      --api-version<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: The API version to use when talking to the server
</span></span><span style="display:flex;"><span>      --certificate-authority<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: Path to a cert. file <span style="color:#204a87;font-weight:bold">for</span> the certificate authority.
</span></span><span style="display:flex;"><span>      --client-certificate<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: Path to a client key file <span style="color:#204a87;font-weight:bold">for</span> TLS.
</span></span><span style="display:flex;"><span>      --client-key<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: Path to a client key file <span style="color:#204a87;font-weight:bold">for</span> TLS.
</span></span><span style="display:flex;"><span>      --cluster<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: The name of the kubeconfig cluster to use
</span></span><span style="display:flex;"><span>      --context<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: The name of the kubeconfig context to use
</span></span><span style="display:flex;"><span>      --insecure-skip-tls-verify<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>: If true, the server<span style="color:#a40000">&#39;</span>s certificate will not be checked <span style="color:#204a87;font-weight:bold">for</span> validity. This will make your HTTPS connections insecure.
</span></span><span style="display:flex;"><span>      --kubeconfig<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: Path to the kubeconfig file to use <span style="color:#204a87;font-weight:bold">for</span> CLI requests.
</span></span><span style="display:flex;"><span>      --log-backtrace-at<span style="color:#ce5c00;font-weight:bold">=</span>:0: when logging hits line file:N, emit a stack trace
</span></span><span style="display:flex;"><span>      --log-dir<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: If non-empty, write log files in this directory
</span></span><span style="display:flex;"><span>      --log-flush-frequency<span style="color:#ce5c00;font-weight:bold">=</span>5s: Maximum number of seconds between log flushes
</span></span><span style="display:flex;"><span>      --logtostderr<span style="color:#ce5c00;font-weight:bold">[=</span>true<span style="color:#ce5c00;font-weight:bold">]</span>: log to standard error instead of files
</span></span><span style="display:flex;"><span>      --match-server-version<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>: Require server version to match client version
</span></span><span style="display:flex;"><span>      --namespace<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: If present, the namespace scope <span style="color:#204a87;font-weight:bold">for</span> this CLI request.
</span></span><span style="display:flex;"><span>      --password<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: Password <span style="color:#204a87;font-weight:bold">for</span> basic authentication to the API server.
</span></span><span style="display:flex;"><span>  -s, --server<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: The address and port of the Kubernetes API server
</span></span><span style="display:flex;"><span>      --stderrthreshold<span style="color:#ce5c00;font-weight:bold">=</span>2: logs at or above this threshold go to stderr
</span></span><span style="display:flex;"><span>      --token<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: Bearer token <span style="color:#204a87;font-weight:bold">for</span> authentication to the API server.
</span></span><span style="display:flex;"><span>      --user<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: The name of the kubeconfig user to use
</span></span><span style="display:flex;"><span>      --username<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>: Username <span style="color:#204a87;font-weight:bold">for</span> basic authentication to the API server.
</span></span><span style="display:flex;"><span>      --v<span style="color:#ce5c00;font-weight:bold">=</span>0: log level <span style="color:#204a87;font-weight:bold">for</span> V logs
</span></span><span style="display:flex;"><span>      --vmodule<span style="color:#ce5c00;font-weight:bold">=</span>: comma-separated list of <span style="color:#000">pattern</span><span style="color:#ce5c00;font-weight:bold">=</span>N settings <span style="color:#204a87;font-weight:bold">for</span> file-filtered logging
</span></span></code></pre></div><h2 id="2-3-3-kubectl客户端">2.3.3. kubectl客户端</h2>
<p>命令行工具kubectl客户端，通过命令行参数转换为对API Server的REST API调用，并将调用结果输出。</p>
<p>命令格式：kubectl [command] [options]</p>
<p>具体可参考<a href="http://wiki.haplat.net/pages/viewpage.action?pageId=11899446">k8s常用命令</a></p>
<h2 id="2-3-4-编程方式调用">2.3.4. 编程方式调用</h2>
<p>使用场景：</p>
<p>1、运行在Pod里的用户进程调用kubernetes API,通常用来实现分布式集群搭建的目标。</p>
<p>2、开发基于kubernetes的管理平台，比如调用kubernetes API来完成Pod、Service、RC等资源对象的图形化创建和管理界面。可以使用kubernetes提供的Client Library。</p>
<p>具体可参考<a href="https://github.com/kubernetes/client-go">https://github.com/kubernetes/client-go</a>。</p>
<h1 id="3-通过api-server访问node-pod和service">3. 通过API Server访问Node、Pod和Service</h1>
<p>k8s API Server最主要的REST接口是资源对象的增删改查，另外还有一类特殊的REST接口—k8s Proxy API接口，这类接口的作用是代理REST请求，即kubernetes API Server把收到的REST请求转发到某个Node上的kubelet守护进程的REST端口上，由该kubelet进程负责响应。</p>
<h2 id="3-1-node相关接口">3.1. Node相关接口</h2>
<p>关于Node相关的接口的REST路径为：/api/v1/proxy/nodes/{name}，其中{name}为节点的名称或IP地址。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/api/v1/proxy/nodes/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/pods/    <span style="color:#8f5902;font-style:italic">#列出指定节点内所有Pod的信息</span>
</span></span><span style="display:flex;"><span>/api/v1/proxy/nodes/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/stats/   <span style="color:#8f5902;font-style:italic">#列出指定节点内物理资源的统计信息</span>
</span></span><span style="display:flex;"><span>/api/v1/prxoy/nodes/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/spec/    <span style="color:#8f5902;font-style:italic">#列出指定节点的概要信息</span>
</span></span></code></pre></div><p>这里获取的Pod信息来自Node而非etcd数据库，两者时间点可能存在偏差。如果在kubelet进程启动时加--enable-debugging-handles=true参数，那么kubernetes Proxy API还会增加以下接口：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/api/v1/proxy/nodes/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/run      <span style="color:#8f5902;font-style:italic">#在节点上运行某个容器</span>
</span></span><span style="display:flex;"><span>/api/v1/proxy/nodes/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/exec     <span style="color:#8f5902;font-style:italic">#在节点上的某个容器中运行某条命令</span>
</span></span><span style="display:flex;"><span>/api/v1/proxy/nodes/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/attach   <span style="color:#8f5902;font-style:italic">#在节点上attach某个容器</span>
</span></span><span style="display:flex;"><span>/api/v1/proxy/nodes/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/portForward   <span style="color:#8f5902;font-style:italic">#实现节点上的Pod端口转发</span>
</span></span><span style="display:flex;"><span>/api/v1/proxy/nodes/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/logs     <span style="color:#8f5902;font-style:italic">#列出节点的各类日志信息</span>
</span></span><span style="display:flex;"><span>/api/v1/proxy/nodes/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/metrics  <span style="color:#8f5902;font-style:italic">#列出和该节点相关的Metrics信息</span>
</span></span><span style="display:flex;"><span>/api/v1/proxy/nodes/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/runningpods  <span style="color:#8f5902;font-style:italic">#列出节点内运行中的Pod信息</span>
</span></span><span style="display:flex;"><span>/api/v1/proxy/nodes/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/debug/pprof  <span style="color:#8f5902;font-style:italic">#列出节点内当前web服务的状态，包括CPU和内存的使用情况</span>
</span></span></code></pre></div><h2 id="3-2-pod相关接口">3.2. Pod相关接口</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/api/v1/proxy/namespaces/<span style="color:#ce5c00;font-weight:bold">{</span>namespace<span style="color:#ce5c00;font-weight:bold">}</span>/pods/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/<span style="color:#ce5c00;font-weight:bold">{</span>path:*<span style="color:#ce5c00;font-weight:bold">}</span>      <span style="color:#8f5902;font-style:italic">#访问pod的某个服务接口</span>
</span></span><span style="display:flex;"><span>/api/v1/proxy/namespaces/<span style="color:#ce5c00;font-weight:bold">{</span>namespace<span style="color:#ce5c00;font-weight:bold">}</span>/pods/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>               <span style="color:#8f5902;font-style:italic">#访问Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#以下写法不同，功能一样</span>
</span></span><span style="display:flex;"><span>/api/v1/namespaces/<span style="color:#ce5c00;font-weight:bold">{</span>namespace<span style="color:#ce5c00;font-weight:bold">}</span>/pods/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/proxy/<span style="color:#ce5c00;font-weight:bold">{</span>path:*<span style="color:#ce5c00;font-weight:bold">}</span>      <span style="color:#8f5902;font-style:italic">#访问pod的某个服务接口</span>
</span></span><span style="display:flex;"><span>/api/v1/namespaces/<span style="color:#ce5c00;font-weight:bold">{</span>namespace<span style="color:#ce5c00;font-weight:bold">}</span>/pods/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>/proxy               <span style="color:#8f5902;font-style:italic">#访问Pod</span>
</span></span></code></pre></div><h2 id="3-3-service相关接口">3.3. Service相关接口</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/api/v1/proxy/namespaces/<span style="color:#ce5c00;font-weight:bold">{</span>namespace<span style="color:#ce5c00;font-weight:bold">}</span>/services/<span style="color:#ce5c00;font-weight:bold">{</span>name<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Pod的proxy接口的作用：在kubernetes集群之外访问某个pod容器的服务（HTTP服务），可以用Proxy API实现，这种场景多用于管理目的，比如逐一排查Service的Pod副本，检查哪些Pod的服务存在异常问题。</p>
<h1 id="4-集群功能模块之间的通信">4. 集群功能模块之间的通信</h1>
<p>kubernetes API Server作为集群的核心，负责集群各功能模块之间的通信，集群内各个功能模块通过API Server将信息存入etcd，当需要获取和操作这些数据时，通过API Server提供的REST接口（GET/LIST/WATCH方法）来实现，从而实现各模块之间的信息交互。</p>
<h2 id="4-1-kubelet与api-server交互">4.1. kubelet与API Server交互</h2>
<p>每个Node节点上的kubelet定期就会调用API Server的REST接口报告自身状态，API Server接收这些信息后，将节点状态信息更新到etcd中。kubelet也通过API Server的Watch接口监听Pod信息，从而对Node机器上的POD进行管理。</p>
<table>
<thead>
<tr>
<th>监听信息</th>
<th>kubelet动作</th>
</tr>
</thead>
<tbody>
<tr>
<td>新的POD副本被调度绑定到本节点</td>
<td>执行POD对应的容器的创建和启动逻辑</td>
</tr>
<tr>
<td>POD对象被删除</td>
<td>删除本节点上相应的POD容器</td>
</tr>
<tr>
<td>修改POD信息</td>
<td>修改本节点的POD容器</td>
</tr>
</tbody>
</table>
<h2 id="4-2-kube-controller-manager与api-server交互">4.2. kube-controller-manager与API Server交互</h2>
<p>kube-controller-manager中的Node Controller模块通过API Server提供的Watch接口，实时监控Node的信息，并做相应处理。</p>
<h2 id="4-3-kube-scheduler与api-server交互">4.3. kube-scheduler与API Server交互</h2>
<p>Scheduler通过API Server的Watch接口监听到新建Pod副本的信息后，它会检索所有符合该Pod要求的Node列表，开始执行Pod调度逻辑。调度成功后将Pod绑定到目标节点上。</p>
<h2 id="4-4-特别说明">4.4. 特别说明</h2>
<p>为了缓解各模块对API Server的访问压力，各功能模块都采用缓存机制来缓存数据，各功能模块定时从API Server获取指定的资源对象信息（LIST/WATCH方法），然后将信息保存到本地缓存，功能模块在某些情况下不直接访问API Server，而是通过访问缓存数据来间接访问API Server。</p>
<p>参考《kubernetes权威指南》</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c35d2525fdbbca71b0b7b9a0ae97c5be">4.1.2 - Kubernetes核心原理（二）之Controller Manager</h1>
    
	<h1 id="1-controller-manager简介">1. Controller Manager简介</h1>
<p>Controller Manager作为集群内部的管理控制中心，负责集群内的Node、Pod副本、服务端点（Endpoint）、命名空间（Namespace）、服务账号（ServiceAccount）、资源定额（ResourceQuota）的管理，当某个Node意外宕机时，Controller Manager会及时发现并执行自动化修复流程，确保集群始终处于预期的工作状态。</p>
<p><img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510579017/article/kubernetes/core/controller-manager.png" alt="controller manager"></p>
<p>每个Controller通过API Server提供的接口实时监控整个集群的每个资源对象的当前状态，当发生各种故障导致系统状态发生变化时，会尝试将系统状态修复到“期望状态”。</p>
<h1 id="2-replication-controller">2. Replication Controller</h1>
<p>为了区分，将资源对象Replication Controller简称RC,而本文中是指Controller Manager中的Replication Controller，称为副本控制器。副本控制器的作用即保证集群中一个RC所关联的Pod副本数始终保持预设值。</p>
<ol>
<li>只有当Pod的重启策略是Always的时候（RestartPolicy=Always），副本控制器才会管理该Pod的操作（创建、销毁、重启等）。</li>
<li>RC中的Pod模板就像一个模具，模具制造出来的东西一旦离开模具，它们之间就再没关系了。一旦Pod被创建，无论模板如何变化，也不会影响到已经创建的Pod。</li>
<li>Pod可以通过修改label来脱离RC的管控，该方法可以用于将Pod从集群中迁移，数据修复等调试。</li>
<li>删除一个RC不会影响它所创建的Pod，如果要删除Pod需要将RC的副本数属性设置为0。</li>
<li>不要越过RC创建Pod，因为RC可以实现自动化控制Pod，提高容灾能力。</li>
</ol>
<h2 id="2-1-replication-controller的职责">2.1. Replication Controller的职责</h2>
<ol>
<li>确保集群中有且仅有N个Pod实例，N是RC中定义的Pod副本数量。</li>
<li>通过调整RC中的spec.replicas属性值来实现系统扩容或缩容。</li>
<li>通过改变RC中的Pod模板来实现系统的滚动升级。</li>
</ol>
<h2 id="2-2-replication-controller使用场景">2.2. Replication Controller使用场景</h2>
<table>
<thead>
<tr>
<th>使用场景</th>
<th>说明</th>
<th>使用命令</th>
</tr>
</thead>
<tbody>
<tr>
<td>重新调度</td>
<td>当发生节点故障或Pod被意外终止运行时，可以重新调度保证集群中仍然运行指定的副本数。</td>
<td></td>
</tr>
<tr>
<td>弹性伸缩</td>
<td>通过手动或自动扩容代理修复副本控制器的spec.replicas属性，可以实现弹性伸缩。</td>
<td>kubectl scale</td>
</tr>
<tr>
<td>滚动更新</td>
<td>创建一个新的RC文件，通过kubectl 命令或API执行，则会新增一个新的副本同时删除旧的副本，当旧副本为0时，删除旧的RC。</td>
<td>kubectl rolling-update</td>
</tr>
</tbody>
</table>
<p>滚动升级，具体可参考kubectl rolling-update --help,官方文档：<a href="https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/">https://kubernetes.io/docs/tasks/run-application/rolling-update-replication-controller/</a></p>
<h1 id="3-node-controller">3. Node Controller</h1>
<p>kubelet在启动时会通过API Server注册自身的节点信息，并定时向API Server汇报状态信息，API Server接收到信息后将信息更新到etcd中。</p>
<p>Node Controller通过API Server实时获取Node的相关信息，实现管理和监控集群中的各个Node节点的相关控制功能。流程如下</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579017/article/kubernetes/core/NodeController.png" alt="Node Controller"></p>
<p>1、Controller Manager在启动时如果设置了--cluster-cidr参数，那么为每个没有设置Spec.PodCIDR的Node节点生成一个CIDR地址，并用该CIDR地址设置节点的Spec.PodCIDR属性，防止不同的节点的CIDR地址发生冲突。</p>
<p>2、具体流程见以上流程图。</p>
<p>3、逐个读取节点信息，如果节点状态变成非“就绪”状态，则将节点加入待删除队列，否则将节点从该队列删除。</p>
<h1 id="4-resourcequota-controller">4. ResourceQuota Controller</h1>
<p>资源配额管理确保指定的资源对象在任何时候都不会超量占用系统物理资源。</p>
<p>支持三个层次的资源配置管理：</p>
<p>1）容器级别：对CPU和Memory进行限制</p>
<p>2）Pod级别：对一个Pod内所有容器的可用资源进行限制</p>
<p>3）Namespace级别：包括</p>
<ul>
<li>Pod数量</li>
<li>Replication Controller数量</li>
<li>Service数量</li>
<li>ResourceQuota数量</li>
<li>Secret数量</li>
<li>可持有的PV（Persistent Volume）数量</li>
</ul>
<p>说明：</p>
<ol>
<li>k8s配额管理是通过Admission Control（准入控制）来控制的；</li>
<li>Admission Control提供两种配额约束方式：LimitRanger和ResourceQuota；</li>
<li>LimitRanger作用于Pod和Container；</li>
<li>ResourceQuota作用于Namespace上，限定一个Namespace里的各类资源的使用总额。</li>
</ol>
<p><strong>ResourceQuota Controller流程图</strong>：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579017/article/kubernetes/core/ResourceQuotaController.png" alt="ResourceQuota Controller"></p>
<h1 id="5-namespace-controller">5. Namespace Controller</h1>
<p>用户通过API Server可以创建新的Namespace并保存在etcd中，Namespace Controller定时通过API Server读取这些Namespace信息。</p>
<p>如果Namespace被API标记为优雅删除（即设置删除期限，DeletionTimestamp）,则将该Namespace状态设置为“Terminating”,并保存到etcd中。同时Namespace Controller删除该Namespace下的ServiceAccount、RC、Pod等资源对象。</p>
<h1 id="6-endpoint-controller">6. Endpoint Controller</h1>
<p><strong>Service、Endpoint、Pod的关系：</strong></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579017/article/kubernetes/core/EndpointController.png" alt="Endpoint Controller"></p>
<p>Endpoints表示了一个Service对应的所有Pod副本的访问地址，而Endpoints Controller负责生成和维护所有Endpoints对象的控制器。它负责监听Service和对应的Pod副本的变化。</p>
<ol>
<li>如果监测到Service被删除，则删除和该Service同名的Endpoints对象；</li>
<li>如果监测到新的Service被创建或修改，则根据该Service信息获得相关的Pod列表，然后创建或更新Service对应的Endpoints对象。</li>
<li>如果监测到Pod的事件，则更新它对应的Service的Endpoints对象。</li>
</ol>
<p>kube-proxy进程获取每个Service的Endpoints，实现Service的负载均衡功能。</p>
<h1 id="7-service-controller">7. Service Controller</h1>
<p>Service Controller是属于kubernetes集群与外部的云平台之间的一个接口控制器。Service Controller监听Service变化，如果是一个LoadBalancer类型的Service，则确保外部的云平台上对该Service对应的LoadBalancer实例被相应地创建、删除及更新路由转发表。</p>
<p>参考《Kubernetes权威指南》</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-67eda864e92e5d867c04aa5fa67daa80">4.1.3 - Kubernetes核心原理（三）之Scheduler</h1>
    
	<h1 id="1-scheduler简介">1. Scheduler简介</h1>
<p>Scheduler负责Pod调度。在整个系统中起&quot;承上启下&quot;作用，承上：负责接收Controller Manager创建的新的Pod，为其选择一个合适的Node；启下：Node上的kubelet接管Pod的生命周期。</p>
<p>Scheduler：</p>
<p>1）通过调度算法为待调度Pod列表的每个Pod从Node列表中选择一个最适合的Node，并将信息写入etcd中</p>
<p>2）kubelet通过API Server监听到kubernetes Scheduler产生的Pod绑定信息，然后获取对应的Pod清单，下载Image，并启动容器。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579017/article/kubernetes/core/scheduler.png" alt="scheduler"></p>
<h1 id="2-调度流程">2. 调度流程</h1>
<p>1、预选调度过程，即遍历所有目标Node,筛选出符合要求的候选节点，kubernetes内置了多种预选策略（xxx Predicates）供用户选择</p>
<p>2、确定最优节点，在第一步的基础上采用优选策略（xxx Priority）计算出每个候选节点的积分，取最高积分。</p>
<p>调度流程通过插件式加载的“调度算法提供者”（AlgorithmProvider）具体实现，一个调度算法提供者就是包括一组预选策略与一组优选策略的结构体。</p>
<h1 id="3-预选策略">3. 预选策略</h1>
<p>说明：返回true表示该节点满足该Pod的调度条件；返回false表示该节点不满足该Pod的调度条件。</p>
<h2 id="3-1-nodiskconflict">3.1. NoDiskConflict</h2>
<p>判断备选Pod的数据卷是否与该Node上已存在Pod挂载的数据卷冲突，如果是则返回false，否则返回true。</p>
<h2 id="3-2-podfitsresources">3.2. PodFitsResources</h2>
<p>判断备选节点的资源是否满足备选Pod的需求，即节点的剩余资源满不满足该Pod的资源使用。</p>
<ol>
<li>计算备选Pod和节点中已用资源（该节点所有Pod的使用资源）的总和。</li>
<li>获取备选节点的状态信息，包括节点资源信息。</li>
<li>如果（备选Pod+节点已用资源&gt;该节点总资源）则返回false，即剩余资源不满足该Pod使用；否则返回true。</li>
</ol>
<h2 id="3-3-podselectormatches">3.3. PodSelectorMatches</h2>
<p>判断节点是否包含备选Pod的标签选择器指定的标签，即通过标签来选择Node。</p>
<ol>
<li>如果Pod中没有指定spec.nodeSelector，则返回true。</li>
<li>否则获得备选节点的标签信息，判断该节点的标签信息中是否包含该Pod的spec.nodeSelector中指定的标签，如果包含返回true，否则返回false。</li>
</ol>
<h2 id="3-4-podfitshost">3.4. PodFitsHost</h2>
<p>判断备选Pod的spec.nodeName所指定的节点名称与备选节点名称是否一致，如果一致返回true，否则返回false。</p>
<h2 id="3-5-checknodelabelpresence">3.5. CheckNodeLabelPresence</h2>
<p>检查备选节点中是否有Scheduler配置的标签，如果有返回true，否则返回false。</p>
<h2 id="3-6-checkserviceaffinity">3.6. CheckServiceAffinity</h2>
<p>判断备选节点是否包含Scheduler配置的标签，如果有返回true，否则返回false。</p>
<h2 id="3-7-podfitsports">3.7. PodFitsPorts</h2>
<p>判断备选Pod所用的端口列表中的端口是否在备选节点中已被占用，如果被占用返回false，否则返回true。</p>
<h1 id="4-优选策略">4. 优选策略</h1>
<h2 id="4-1-leastrequestedpriority">4.1. LeastRequestedPriority</h2>
<p>优先从备选节点列表中选择资源消耗最小的节点（CPU+内存）。</p>
<h2 id="4-2-calculatenodelabelpriority">4.2. CalculateNodeLabelPriority</h2>
<p>优先选择含有指定Label的节点。</p>
<h2 id="4-3-balancedresourceallocation">4.3. BalancedResourceAllocation</h2>
<p>优先从备选节点列表中选择各项资源使用率最均衡的节点。</p>
<p>参考《Kubernetes权威指南》</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-92b084b3a33d2d7ac8c805d194373c41">4.1.4 - Kubernetes核心原理（四）之kubelet</h1>
    
	<h1 id="1-kubelet简介">1. kubelet简介</h1>
<p>在kubernetes集群中，每个Node节点都会启动kubelet进程，用来处理Master节点下发到本节点的任务，管理Pod和其中的容器。kubelet会在API Server上注册节点信息，定期向Master汇报节点资源使用情况，并通过cAdvisor监控容器和节点资源。可以把kubelet理解成【Server-Agent】架构中的agent，是Node上的pod管家。</p>
<p>更多kubelet配置参数信息可参考kubelet --help</p>
<h1 id="2-节点管理">2. 节点管理</h1>
<p>节点通过设置kubelet的启动参数“--register-node”，来决定是否向API Server注册自己，默认为true。可以通过kubelet --help或者查看kubernetes源码【cmd/kubelet/app/server.go中】来查看该参数。</p>
<p><strong>kubelet的配置文件</strong></p>
<p>默认配置文件在/etc/kubernetes/kubelet中，其中</p>
<ul>
<li>--api-servers：用来配置Master节点的IP和端口。</li>
<li>--kubeconfig：用来配置kubeconfig的路径，kubeconfig文件常用来指定证书。</li>
<li>--hostname-override：用来配置该节点在集群中显示的主机名。</li>
<li>--node-status-update-frequency：配置kubelet向Master心跳上报的频率，默认为10s。</li>
</ul>
<h1 id="3-pod管理">3. Pod管理</h1>
<p>kubelet有几种方式获取自身Node上所需要运行的Pod清单。但本文只讨论通过API Server监听etcd目录，同步Pod列表的方式。</p>
<p>kubelet通过API Server Client使用WatchAndList的方式监听etcd中/registry/nodes/${当前节点名称}和/registry/pods的目录，将获取的信息同步到本地缓存中。</p>
<p>kubelet监听etcd，执行对Pod的操作，对容器的操作则是通过Docker Client执行，例如启动删除容器等。</p>
<p><strong>kubelet创建和修改Pod流程：</strong></p>
<ol>
<li>为该Pod创建一个数据目录。</li>
<li>从API Server读取该Pod清单。</li>
<li>为该Pod挂载外部卷（External Volume）</li>
<li>下载Pod用到的Secret。</li>
<li>检查运行的Pod，执行Pod中未完成的任务。</li>
<li>先创建一个Pause容器，该容器接管Pod的网络，再创建其他容器。</li>
<li>Pod中容器的处理流程：
1）比较容器hash值并做相应处理。
2）如果容器被终止了且没有指定重启策略，则不做任何处理。
3）调用Docker Client下载容器镜像，调用Docker Client运行容器。</li>
</ol>
<h1 id="4-容器健康检查">4. 容器健康检查</h1>
<p>Pod通过探针的方式来检查容器的健康状态，具体可参考<a href="https://www.huweihuang.com/kubernetes-notes/concepts/pod/pod-probe.html">Pod详解#Pod健康检查</a>。</p>
<h1 id="5-cadvisor资源监控">5. cAdvisor资源监控</h1>
<p>kubelet通过cAdvisor获取本节点信息及容器的数据。cAdvisor为谷歌开源的容器资源分析工具，默认集成到kubernetes中。</p>
<p>cAdvisor自动采集CPU,内存，文件系统，网络使用情况，容器中运行的进程，默认端口为4194。可以通过Node IP+Port访问。</p>
<p>更多参考：<a href="http://github.com/google/cadvisor">http://github.com/google/cadvisor</a></p>
<p>参考《Kubernetes权威指南》</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ce4750ad230938f535c1a8c7dd249b84">4.2 - 流程图</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0a2151d9e7e2405e81ad7ee678a8d04f">4.2.1 - Pod创建流程</h1>
    
	<h1 id="pod创建基本流程图">Pod创建基本流程图</h1>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1597804292/article/kubernetes/flow/k8s-flow.png" width="100%">
<h1 id="pod创建完整流程图">Pod创建完整流程图</h1>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1631779724/article/kubernetes/pod/what-happens-when-k8s.svg">
<blockquote>
<p>图片来源：https://fuckcloudnative.io/posts/what-happens-when-k8s/</p>
</blockquote>
<p>参考:</p>
<ul>
<li><a href="https://fuckcloudnative.io/posts/what-happens-when-k8s/">https://fuckcloudnative.io/posts/what-happens-when-k8s/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1ad6828622f1c7fea352dccf193d0db2">4.2.2 - PVC创建流程</h1>
    
	<h1 id="pvc流程">pvc流程</h1>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1618759154/article/kubernetes/flow/pvc-flow.png" width="100%">
<p>流程如下：</p>
<ol>
<li>用户创建了一个包含 PVC 的 Pod，该 PVC 要求使用动态存储卷；</li>
<li>Scheduler 根据 Pod 配置、节点状态、PV 配置等信息，把 Pod 调度到一个合适的 Worker 节点上；</li>
<li>PV 控制器 watch 到该 Pod 使用的 PVC 处于 Pending 状态，于是调用 Volume Plugin（in-tree）创建存储卷，并创建 PV 对象（out-of-tree 由 External Provisioner 来处理）；</li>
<li>AD 控制器发现 Pod 和 PVC 处于待挂接状态，于是调用 Volume Plugin 挂接存储设备到目标 Worker 节点上</li>
<li>在 Worker 节点上，Kubelet 中的 Volume Manager 等待存储设备挂接完成，并通过 Volume Plugin 将设备挂载到全局目录：<strong>/var/lib/kubelet/pods/[pod uid]/volumes/kubernetes.io~iscsi/[PVname]</strong>（以 iscsi 为例）；</li>
<li>Kubelet 通过 Docker 启动 Pod 的 Containers，用 bind mount 方式将已挂载到本地全局目录的卷映射到容器中。</li>
</ol>
<h1 id="详细流程图">详细流程图</h1>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1618759154/article/kubernetes/flow/pvc-workflow.png" width="100%">
</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0b25fffd51613bdef564a5a70491d831">5 - 容器网络</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-74c4bd794700f9208344a668233bf9d0">5.1 - Docker网络</h1>
    
	<h1 id="1-docker的网络基础">1. Docker的网络基础</h1>
<h2 id="1-1-network-namespace">1.1. Network Namespace</h2>
<p>不同的网络命名空间中，协议栈是独立的，完全隔离，彼此之间无法通信。同一个网络命名空间有独立的路由表和独立的<code>Iptables/Netfilter</code>来提供包的转发、NAT、IP包过滤等功能。</p>
<h3 id="1-1-1-网络命名空间的实现">1.1.1. 网络命名空间的实现</h3>
<p>将与网络协议栈相关的全局变量变成一个<code>Net Namespace</code>变量的成员，然后在调用协议栈函数中加入一个Namepace参数。</p>
<h3 id="1-1-2-网络命名空间的操作">1.1.2. 网络命名空间的操作</h3>
<p>1、创建网络命名空间</p>
<p>ip netns add <code>name</code></p>
<p>2、在命名空间内执行命令</p>
<p>ip netns exec <code>name</code> <code>command</code></p>
<p>3、进入命名空间</p>
<p>ip netns exec <code>name</code> bash</p>
<h1 id="2-docker的网络实现">2. Docker的网络实现</h1>
<h2 id="2-1-容器网络">2.1. 容器网络</h2>
<p>Docker使用Linux桥接，在宿主机虚拟一个Docker容器网桥(docker0)，Docker启动一个容器时会根据Docker网桥的网段分配给容器一个IP地址，称为Container-IP，同时Docker网桥是每个容器的默认网关。因为在同一宿主机内的容器都接入同一个网桥，这样容器之间就能够通过容器的Container-IP直接通信。</p>
<p>Docker网桥是宿主机虚拟出来的，并不是真实存在的网络设备，外部网络是无法寻址到的，这也意味着外部网络无法通过直接Container-IP访问到容器。如果容器希望外部访问能够访问到，可以通过映射容器端口到宿主主机（端口映射），即docker run创建容器时候通过 -p 或 -P 参数来启用，访问容器的时候就通过[宿主机IP]:[容器端口]访问容器。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578957/article/kubernetes/network/container-network.png" alt="这里写图片描述"></p>
<h2 id="2-2-4类网络模式">2.2. 4类网络模式</h2>
<table>
<thead>
<tr>
<th>Docker网络模式</th>
<th>配置</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>host模式</td>
<td>--net=host</td>
<td>容器和宿主机共享Network namespace。</td>
</tr>
<tr>
<td>container模式</td>
<td>--net=container:NAME_or_ID</td>
<td>容器和另外一个容器共享Network namespace。 kubernetes中的pod就是多个容器共享一个Network namespace。</td>
</tr>
<tr>
<td>none模式</td>
<td>--net=none</td>
<td>容器有独立的Network namespace，但并没有对其进行任何网络设置，如分配veth pair 和网桥连接，配置IP等。</td>
</tr>
<tr>
<td>bridge模式</td>
<td>--net=bridge（默认为该模式）</td>
<td>桥接模式</td>
</tr>
</tbody>
</table>
<h1 id="3-docker网络模式">3. Docker网络模式</h1>
<h2 id="3-1-bridge桥接模式">3.1. bridge桥接模式</h2>
<p>在bridge模式下，Docker可以使用独立的网络栈。实现方式是父进程在创建子进程的时候通过传入<code>CLONE_NEWNET</code>的参数创建出一个网络命名空间。</p>
<p><strong>实现步骤：</strong></p>
<ol>
<li>Docker Daemon首次启动时会创建一个虚拟网桥docker0，地址通常为172.x.x.x开头，在私有的网络空间中给这个网络分配一个子网。</li>
<li>由Docker创建处理的每个容器，都会创建一个虚拟以太设备对（veth pair），一端关联到网桥，另一端使用Namespace技术映射到容器内的eth0设备，然后从网桥的地址段内给eth0接口分配一个IP地址。</li>
</ol>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578957/article/kubernetes/network/bridge.png" alt="这里写图片描述"></p>
<p>一般情况，宿主机IP与docker0 IP、容器IP是不同的IP段，默认情况，外部看不到docker0和容器IP，对于外部来说相当于docker0和容器的IP为内网IP。</p>
<h3 id="3-1-1-外部网络访问docker容器">3.1.1. 外部网络访问Docker容器</h3>
<p>外部访问docker容器可以通过<code>端口映射(NAT)</code>的方式，Docker使用NAT的方式将容器内部的服务与宿主机的某个端口port_1绑定。</p>
<p>外部访问容器的流程如下：</p>
<ol>
<li>外界网络通过宿主机的IP和映射的端口port_1访问。</li>
<li>当宿主机收到此类请求，会通过DNAT将请求的目标IP即宿主机IP和目标端口即映射端口port_1替换成容器的IP和容器的端口port_0。</li>
<li>由于宿主机上可以识别容器IP，所以宿主机将请求发给veth pair。</li>
<li>veth pair将请求发送给容器内部的eth0，由容器内部的服务进行处理。</li>
</ol>
<h3 id="3-1-2-docker容器访问外部网络">3.1.2. Docker容器访问外部网络</h3>
<p>docker容器访问外部网络的流程：</p>
<ol>
<li>
<p>docker容器向外部目标IP和目标端口port_2发起请求，请求报文中的源IP为容器IP。</p>
</li>
<li>
<p>请求通过容器内部的eth0到veth pair的另一端docker0网桥。</p>
</li>
<li>
<p>docker0网桥通过数据报转发功能将请求转发到宿主机的eth0。</p>
</li>
<li>
<p>宿主机处理请求时通过SNAT将请求中的源IP换成宿主机eth0的IP。</p>
</li>
<li>
<p>处理后的报文通过请求的目标IP发送到外部网络。</p>
</li>
</ol>
<h3 id="3-1-3-缺点">3.1.3. 缺点</h3>
<p>使用NAT的方式可能会带来性能的问题，影响网络传输效率。</p>
<h2 id="3-2-host模式">3.2. host模式</h2>
<p>host模式并没有给容器创建一个隔离的网络环境，而是和宿主机共用一个网络命名空间，容器使用宿主机的eth0和外界进行通信，同样容器也共用宿主机的端口资源，即分配端口可能存在与宿主机已分配的端口冲突的问题。</p>
<p>实现的方式即父进程在创建子进程的时候不传入<code>CLONE_NEWNET</code>的参数，从而和宿主机共享一个网络空间。</p>
<p>host模式没有通过NAT的方式进行转发因此性能上相对较好，但是不存在网络隔离性，可能产生端口冲突的问题。</p>
<h2 id="3-3-container模式">3.3. container模式</h2>
<p>container模式即docker容器可以使用其他容器的网络命名空间，即和其他容器处于同一个网络命名空间。</p>
<p>步骤：</p>
<ol>
<li>查找其他容器的网络命名空间。</li>
<li>新创建的容器的网络命名空间使用其他容器的网络命名空间。</li>
</ol>
<p>通过和其他容器共享网络命名空间的方式，可以让不同的容器之间处于相同的网络命名空间，可以直接通过localhost的方式进行通信，简化了强关联的多个容器之间的通信问题。</p>
<p>k8s中的pod的概念就是通过一组容器共享一个网络命名空间来达到pod内部的不同容器可以直接通过localhost的方式进行通信。</p>
<h2 id="3-4-none模式">3.4. none模式</h2>
<p>none模式即不为容器创建任何的网络环境，用户可以根据自己的需要手动去创建不同的网络定制配置。</p>
<p>参考：</p>
<ul>
<li>《Docker源码分析》</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-522f5907d7543b0318052a0b43976cfc">5.2 - K8S网络</h1>
    
	<h1 id="1-kubernetes网络模型">1. kubernetes网络模型</h1>
<h2 id="1-1-基础原则">1.1. 基础原则</h2>
<ol>
<li>每个Pod都拥有一个独立的IP地址，而且假定所有Pod都在一个可以直接连通的、扁平的网络空间中，不管是否运行在同一Node上都可以通过Pod的IP来访问。</li>
<li>k8s中Pod的IP是最小粒度IP。同一个Pod内所有的容器共享一个网络堆栈，该模型称为IP-per-Pod模型。</li>
<li>Pod由docker0实际分配的IP，Pod内部看到的IP地址和端口与外部保持一致。同一个Pod内的不同容器共享网络，可以通过localhost来访问对方的端口，类似同一个VM内的不同进程。</li>
<li>IP-per-Pod模型从端口分配、域名解析、服务发现、负载均衡、应用配置等角度看，Pod可以看作是一台独立的VM或物理机。</li>
</ol>
<h2 id="1-2-k8s对集群的网络要求">1.2. k8s对集群的网络要求</h2>
<ol>
<li>所有容器都可以不用NAT的方式同别的容器通信。</li>
<li>所有节点都可以在不同NAT的方式下同所有容器通信，反之亦然。</li>
<li>容器的地址和别人看到的地址是同一个地址。</li>
</ol>
<p>以上的集群网络要求可以通过第三方开源方案实现，例如flannel。</p>
<h2 id="1-3-网络架构图">1.3. 网络架构图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578957/article/kubernetes/network/network-arch.png" alt="这里写图片描述"></p>
<h2 id="1-4-k8s集群ip概念汇总">1.4. k8s集群IP概念汇总</h2>
<p>由集群外部到集群内部：</p>
<table>
<thead>
<tr>
<th>IP类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Proxy-IP</td>
<td>代理层公网地址IP，外部访问应用的网关服务器。[实际需要关注的IP]</td>
</tr>
<tr>
<td>Service-IP</td>
<td>Service的固定虚拟IP，Service-IP是内部，外部无法寻址到。</td>
</tr>
<tr>
<td>Node-IP</td>
<td>容器宿主机的主机IP。</td>
</tr>
<tr>
<td>Container-Bridge-IP</td>
<td>容器网桥（docker0）IP，容器的网络都需要通过容器网桥转发。</td>
</tr>
<tr>
<td>Pod-IP</td>
<td>Pod的IP，等效于Pod中网络容器的Container-IP。</td>
</tr>
<tr>
<td>Container-IP</td>
<td>容器的IP，容器的网络是个隔离的网络空间。</td>
</tr>
</tbody>
</table>
<h1 id="2-kubernetes的网络实现">2. kubernetes的网络实现</h1>
<p>k8s网络场景</p>
<ol>
<li>容器与容器之间的直接通信。</li>
<li>Pod与Pod之间的通信。</li>
<li>Pod到Service之间的通信。</li>
<li>集群外部与内部组件之间的通信。</li>
</ol>
<h2 id="2-1-pod网络">2.1. Pod网络</h2>
<p>Pod作为kubernetes的最小调度单元，Pod是容器的集合，是一个逻辑概念，Pod包含的容器都运行在同一个宿主机上，这些容器将拥有同样的网络空间，容器之间能够互相通信，它们能够在本地访问其它容器的端口。 实际上Pod都包含一个网络容器，它不做任何事情，只是用来接管Pod的网络，业务容器通过加入网络容器的网络从而实现网络共享。Pod网络本质上还是容器网络，所以Pod-IP就是网络容器的Container-IP。</p>
<p>一般将容器云平台的网络模型打造成一个扁平化网络平面，在这个网络平面内，Pod作为一个网络单元同Kubernetes Node的网络处于同一层级。</p>
<h2 id="2-2-pod内部容器之间的通信">2.2. Pod内部容器之间的通信</h2>
<p>同一个Pod之间的不同容器因为共享同一个网络命名空间，所以可以直接通过localhost直接通信。</p>
<h2 id="2-3-pod之间的通信">2.3. Pod之间的通信</h2>
<h3 id="2-3-1-同node的pod之间的通信">2.3.1. 同Node的Pod之间的通信</h3>
<p>同一个Node内，不同的Pod都有一个全局IP，可以直接通过Pod的IP进行通信。Pod地址和docker0在同一个网段。</p>
<p>在pause容器启动之前，会创建一个虚拟以太网接口对（veth pair），该接口对一端连着容器内部的eth0 ，一端连着容器外部的vethxxx，vethxxx会绑定到容器运行时配置使用的网桥bridge0上，从该网络的IP段中分配IP给容器的eth0。</p>
<p>当同节点上的Pod-A发包给Pod-B时，包传送路线如下：</p>
<pre tabindex="0"><code>pod-a的eth0—&gt;pod-a的vethxxx—&gt;bridge0—&gt;pod-b的vethxxx—&gt;pod-b的eth0
</code></pre><p>因为相同节点的bridge0是相通的，因此可以通过bridge0来完成不同pod直接的通信，但是不同节点的bridge0是不通的，因此不同节点的pod之间的通信需要将不同节点的bridge0给连接起来。</p>
<h3 id="2-3-2-不同node的pod之间的通信">2.3.2. 不同Node的Pod之间的通信</h3>
<p>不同的Node之间，Node的IP相当于外网IP，可以直接访问，而Node内的docker0和Pod的IP则是内网IP，无法直接跨Node访问。需要通过Node的网卡进行转发。</p>
<p>所以不同Node之间的通信需要达到两个条件：</p>
<ol>
<li>对整个集群中的Pod-IP分配进行规划，不能有冲突（可以通过第三方开源工具来管理，例如flannel）。</li>
<li>将Node-IP与该Node上的Pod-IP关联起来，通过Node-IP再转发到Pod-IP。</li>
</ol>
<p>不同节点的Pod之间的通信需要将不同节点的bridge0给连接起来。连接不同节点的bridge0的方式有好几种，主要有overlay和underlay，或常规的三层路由。</p>
<p>不同节点的bridge0需要不同的IP段，保证Pod IP分配不会冲突，节点的物理网卡eth0也要和该节点的网桥bridge0连接。因此，节点a上的pod-a发包给节点b上的pod-b，路线如下：</p>
<pre tabindex="0"><code>节点a上的pod-a的eth0—&gt;pod-a的vethxxx—&gt;节点a的bridge0—&gt;节点a的eth0—&gt;

节点b的eth0—&gt;节点b的bridge0—&gt;pod-b的vethxxx—&gt;pod-b的eth0
</code></pre><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578957/article/kubernetes/network/pod-network.png" alt="这里写图片描述"></p>
<p><strong>1. Pod间实现通信</strong></p>
<p>例如：Pod1和Pod2（同主机），Pod1和Pod3(跨主机)能够通信</p>
<p>实现：因为Pod的Pod-IP是Docker网桥分配的，Pod-IP是同Node下全局唯一的。所以将不同Kubernetes Node的 Docker网桥配置成不同的IP网段即可。</p>
<p><strong>2. Node与Pod间实现通信</strong></p>
<p>例如：Node1和Pod1/ Pod2(同主机)，Pod3(跨主机)能够通信</p>
<p>实现：在容器集群中创建一个覆盖网络(Overlay Network)，联通各个节点，目前可以通过第三方网络插件来创建覆盖网络，比如Flannel和Open vSwitch等。</p>
<p>不同节点间的Pod访问也可以通过calico形成的Pod IP的路由表来解决。</p>
<h2 id="2-4-service网络">2.4. Service网络</h2>
<p>Service的就是在Pod之间起到服务代理的作用，对外表现为一个单一访问接口，将请求转发给Pod，Service的网络转发是Kubernetes实现服务编排的关键一环。Service都会生成一个虚拟IP，称为Service-IP， Kuberenetes Porxy组件负责实现Service-IP路由和转发，在容器覆盖网络之上又实现了虚拟转发网络。</p>
<p>Kubernetes Porxy实现了以下功能：</p>
<ol>
<li>转发访问Service的Service-IP的请求到Endpoints(即Pod-IP)。</li>
<li>监控Service和Endpoints的变化，实时刷新转发规则。</li>
<li>负载均衡能力。</li>
</ol>
<h1 id="3-开源的网络组件">3. 开源的网络组件</h1>
<h2 id="3-1-flannel">3.1. Flannel</h2>
<p>具体参考<a href="flannel/flannel-introduction.md">Flannel介绍</a></p>
<p>参考《Kubernetes权威指南》</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-435753e3e1914db8cc781fc833cde51c">5.3 - Pod的DNS策略</h1>
    
	<h1 id="1-pod的dns策略">1. Pod的DNS策略</h1>
<p>可以在pod中定义<code>dnsPolicy</code>字段来设置dns的策略。</p>
<ul>
<li>
<p>&quot;<code>Default</code>&quot;: Pod 从运行所在的节点继承名称解析配置。就是该Pod的DNS配置会跟宿主机完全一致。</p>
</li>
<li>
<p>&quot;<code>ClusterFirst</code>&quot;: 如果没有配置，即为默认的DNS策略。预先把kube-dns（或CoreDNS）的信息当作预设参数写入到该Pod内的DNS配置。与配置的集群域后缀不匹配的任何 DNS 查询（例如 &quot;www.kubernetes.io&quot;） 都会由 DNS 服务器转发到上游名称服务器。</p>
</li>
<li>
<p>&quot;<code>ClusterFirstWithHostNet</code>&quot;: 对于以 hostNetwork 方式运行的 Pod，应将其 DNS 策略显式设置为 &quot;<code>ClusterFirstWithHostNet</code>&quot;。否则，以 hostNetwork 方式和 <code>&quot;ClusterFirst&quot;</code> 策略运行的 Pod 将会做出回退至 <code>&quot;Default&quot;</code> 策略的行为。</p>
</li>
<li>
<p>&quot;<code>None</code>&quot;: 此设置允许 Pod 忽略 Kubernetes 环境中的 DNS 设置。Pod 会使用其 <code>dnsConfig</code> 字段所提供的 DNS 设置。</p>
</li>
</ul>
<h1 id="2-pod-dns的配置">2. Pod DNS的配置</h1>
<p>当 Pod 的 <code>dnsPolicy</code> 设置为 &quot;<code>None</code>&quot; 时，必须指定 <code>dnsConfig</code> 字段。</p>
<p><code>dnsConfig</code> 字段中属性：</p>
<ul>
<li>
<p><code>nameservers</code>：将用作于 Pod 的 DNS 服务器的 IP 地址列表。 最多可以指定 3 个 IP 地址。例如 coredns的Cluster IP。</p>
</li>
<li>
<p><code>searches</code>：用于在 Pod 中查找主机名的 DNS 搜索域的列表。此属性是可选的。</p>
</li>
<li>
<p><code>options</code>：可选的对象列表，其中每个对象可能具有 <code>name</code> 属性（必需）和 <code>value</code> 属性（可选）。</p>
</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dns-example</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dnsPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;None&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dnsConfig</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">nameservers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#0000cf;font-weight:bold">1.2.3.4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">searches</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">ns1.svc.cluster-domain.example</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">my.dns.search.suffix</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ndots</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">edns0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>通过以上配置，容器内的<code>/etc/resolv.conf</code>文件内容为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl <span style="color:#204a87">exec</span> -it dns-example -- cat /etc/resolv.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nameserver 1.2.3.4
</span></span><span style="display:flex;"><span>search ns1.svc.cluster-domain.example my.dns.search.suffix
</span></span><span style="display:flex;"><span>options ndots:2 edns0
</span></span></code></pre></div><h1 id="3-自定义dns服务">3. 自定义DNS服务</h1>
<p>默认一般使用coredns来作为k8s的dns服务器。默认使用deployment的方式来运行coredns，会创建一个名为<code>kube-dns</code>的service，并用ClusterIP（默认为10.96.0.10）来作为集群内的pod的nameserver。</p>
<p>kubelet 使用 <code>--cluster-dns=&lt;DNS 服务 IP&gt;</code> 标志将 DNS 解析器的信息传递给每个容器。使用 <code>--cluster-domain=&lt;默认本地域名&gt;</code> 标志配置本地域名。</p>
<p>可查看默认配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cat /var/lib/kubelet/config.yaml</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>clusterDNS:
</span></span><span style="display:flex;"><span>- 10.96.0.10
</span></span><span style="display:flex;"><span>clusterDomain: cluster.local
</span></span></code></pre></div><p>总结：</p>
<p>当没有给pod设置任何dns策略时，则默认使用ClusterFirst的策略，即nameserver的IP为coredns的ClusterIP。通过coredns来解析服务。</p>
<h2 id="3-1-配置继承节点的dns解析">3.1. 配置继承节点的DNS解析</h2>
<ul>
<li>
<p>如果 Pod 的 <code>dnsPolicy</code> 设置为 <code>default</code>，则它将从 Pod 运行所在节点继承名称解析配置。</p>
</li>
<li>
<p>使用 kubelet 的 <code>--resolv-conf</code> 标志设置为宿主机的/etc/resolv.conf文件。</p>
</li>
</ul>
<h2 id="3-2-配置coredns">3.2. 配置CoreDNS</h2>
<p> 配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">coredns</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Corefi</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    .:53 {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        errors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        health {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">           lameduck 5s
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        ready
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        kubernetes cluster.local in-addr.arpa ip6.arpa {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">           pods insecure
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">           fallthrough in-addr.arpa ip6.arpa
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">           ttl 30
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        prometheus :9153
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        forward . /etc/resolv.conf {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">           max_concurrent 1000
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        cache 30
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        loop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        reload
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        loadbalance
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    }</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span></code></pre></div><p>配置说明：</p>
<p>Corefile 配置包括以下 CoreDNS <a href="https://coredns.io/plugins/">插件</a>：</p>
<ul>
<li>
<p><a href="https://coredns.io/plugins/errors/">errors</a>：错误记录到标准输出。</p>
</li>
<li>
<p><a href="https://coredns.io/plugins/health/">health</a>：在 <code>http://localhost:8080/health</code> 处提供 CoreDNS 的健康报告。 在这个扩展语法中，<code>lameduck</code> 会使此进程不健康，等待 5 秒后进程被关闭。</p>
</li>
<li>
<p><a href="https://coredns.io/plugins/ready/">ready</a>：在端口 8181 上提供的一个 HTTP 端点， 当所有能够表达自身就绪的插件都已就绪时，在此端点返回 200 OK。</p>
</li>
<li>
<p><a href="https://coredns.io/plugins/kubernetes/">kubernetes</a>：CoreDNS 将基于服务和 Pod 的 IP 来应答 DNS 查询。 你可以在 CoreDNS 网站找到有关此插件的<a href="https://coredns.io/plugins/kubernetes/">更多细节</a>。</p>
<ul>
<li>
<p>你可以使用 <code>ttl</code> 来定制响应的 TTL。默认值是 5 秒钟。TTL 的最小值可以是 0 秒钟， 最大值为 3600 秒。将 TTL 设置为 0 可以禁止对 DNS 记录进行缓存。</p>
</li>
<li>
<p><code>pods insecure</code> 选项是为了与 kube-dns 向后兼容。</p>
</li>
<li>
<p>你可以使用 <code>pods verified</code> 选项，该选项使得仅在相同名字空间中存在具有匹配 IP 的 Pod 时才返回 A 记录。</p>
</li>
<li>
<p>如果你不使用 Pod 记录，则可以使用 <code>pods disabled</code> 选项。</p>
</li>
</ul>
</li>
<li>
<p><a href="https://coredns.io/plugins/prometheus/">prometheus</a>：CoreDNS 的度量指标值以 <a href="https://prometheus.io/">Prometheus</a> 格式（也称为 OpenMetrics）在 <code>http://localhost:9153/metrics</code> 上提供。</p>
</li>
<li>
<p><a href="https://coredns.io/plugins/forward/">forward</a>: 不在 Kubernetes 集群域内的任何查询都将转发到预定义的解析器 (/etc/resolv.conf)。</p>
</li>
<li>
<p><a href="https://coredns.io/plugins/cache/">cache</a>：启用前端缓存。</p>
</li>
<li>
<p><a href="https://coredns.io/plugins/loop/">loop</a>：检测简单的转发环，如果发现死循环，则中止 CoreDNS 进程。</p>
</li>
<li>
<p><a href="https://coredns.io/plugins/reload">reload</a>：允许自动重新加载已更改的 Corefile。 编辑 ConfigMap 配置后，请等待两分钟，以使更改生效。</p>
</li>
<li>
<p><a href="https://coredns.io/plugins/loadbalance">loadbalance</a>：这是一个轮转式 DNS 负载均衡器， 它在应答中随机分配 A、AAAA 和 MX 记录的顺序。</p>
</li>
</ul>
<h2 id="3-3-配置存根域和上游域名服务器">3.3. 配置存根域和上游域名服务器</h2>
<p>CoreDNS 能够使用 <a href="https://coredns.io/plugins/forward/">forward 插件</a>配置存根域和上游域名服务器。</p>
<p>示例：</p>
<p>在 &quot;10.150.0.1&quot; 处运行了 <a href="https://www.consul.io/">Consul</a> 域服务器， 且所有 Consul 名称都带有后缀 <code>.consul.local</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">consul.local:53 {</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">errors</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">cache 30</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">forward . 10.150.0.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>要显式强制所有非集群 DNS 查找通过特定的域名服务器（位于 172.16.0.1），可将 <code>forward</code> 指向该域名服务器，而不是 <code>/etc/resolv.conf</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">forward .  172.16.0.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>完整示例；</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">coredns</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">Corefile</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    .:53 {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        errors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        health
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        kubernetes cluster.local in-addr.arpa ip6.arpa {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">           pods insecure
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">           fallthrough in-addr.arpa ip6.arpa
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        prometheus :9153
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        forward . 172.16.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        cache 30
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        loop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        reload
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        loadbalance
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    consul.local:53 {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        errors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        cache 30
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        forward . 10.150.0.1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    }    </span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span></code></pre></div><h1 id="4-调试dns问题">4. 调试DNS问题</h1>
<p>创建一个调试的pod</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dnsutils</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dnsutils</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">registry.k8s.io/e2e-test-images/jessie-dnsutils:1.3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">sleep</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;infinity&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">IfNotPresent</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">restartPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Always</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>部署调试pod</p>
<h2 id="4-1-查看coredns服务是否正常">4.1. 查看Coredns服务是否正常</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get svc --namespace<span style="color:#ce5c00;font-weight:bold">=</span>kube-system 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>             AGE
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>kube-dns     ClusterIP   10.0.0.10      &lt;none&gt;        53/UDP,53/TCP        1h
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h2 id="4-2-查看-etc-resolv-conf">4.2. 查看/etc/resolv.conf</h2>
<p>查看容器内dns配置是否符合预期。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl <span style="color:#204a87">exec</span> -ti dnsutils -- cat /etc/resolv.conf
</span></span></code></pre></div><h2 id="4-3-nslookup查看解析报错">4.3. nslookup查看解析报错</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl <span style="color:#204a87">exec</span> -i -t dnsutils -- nslookup kubernetes.default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Server:    10.0.0.10
</span></span><span style="display:flex;"><span>Address 1: 10.0.0.10
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name:      kubernetes.default
</span></span><span style="display:flex;"><span>Address 1: 10.0.0.1
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/dns-pod-service/">Service 与 Pod 的 DNS | Kubernetes</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/dns-custom-nameservers/">自定义 DNS 服务 | Kubernetes</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/dns-debugging-resolution/">调试 DNS 问题 | Kubernetes</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/coredns/">使用 CoreDNS 进行服务发现 | Kubernetes</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/dns-horizontal-autoscaling/">自动扩缩集群 DNS 服务 | Kubernetes</a></p>
</li>
<li>
<p><a href="https://www.man7.org/linux/man-pages/man5/resolv.conf.5.html">resolv.conf(5) - Linux manual page</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/dns/blob/master/docs/specification.md">dns/specification.md at master · kubernetes/dns · GitHub</a></p>
</li>
<li>
<p><a href="https://github.com/coredns/deployment/blob/master/kubernetes/CoreDNS-k8s_version.md">deployment/CoreDNS-k8s_version.md at master · coredns/deployment · GitHub</a></p>
</li>
<li>
<p><a href="https://coredns.io/plugins/forward/">forward</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7939a3d9fca50e5749edc0a71a21c9c5">5.4 - CNI</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-2615520272860bbbdde444e096c7575e">5.4.1 - CNI接口介绍</h1>
    
	<h1 id="1-cni-container-network-interface">1. CNI（Container Network Interface）</h1>
<p>CNI（Container Network Interface）即容器网络接口，通过约定统一的容器网络接口，从而kubelet可以通过这个标准的API来调用不同的网络插件实现不同的网络功能。</p>
<p>kubelet启动参数--network-plugin=cni来指定CNI插件，kubelet从<code>--cni-conf-dir</code> （默认是 <code>/etc/cni/net.d</code>） 读取文件并使用 该文件中的 CNI 配置来设置各个 Pod 的网络。 CNI 配置文件必须与 <a href="https://github.com/containernetworking/cni/blob/master/SPEC.md#network-configuration">CNI 规约</a> 匹配，并且配置所引用的所有所需的 CNI 插件都应存在于 <code>--cni-bin-dir</code>（默认是 <code>/opt/cni/bin</code>）下。如果有多个CNI配置文件，kubelet 将会使用按文件名的字典顺序排列 的第一个作为配置文件。</p>
<p>CNI规范定义：</p>
<ul>
<li>
<p>网络配置文件的格式</p>
</li>
<li>
<p>容器runtime与CNI插件的通信协议</p>
</li>
<li>
<p>基于提供的配置执行网络插件的步骤</p>
</li>
<li>
<p>网络插件调用其他功能插件的步骤</p>
</li>
<li>
<p>插件返回给runtime结果的数据格式</p>
</li>
</ul>
<h1 id="2-cni配置文件格式">2. CNI配置文件格式</h1>
<p>CNI配置文件的格式为JSON格式，配置文件的默认路径：/etc/cni/net.d。插件二进制默认的路径为：/opt/cni/bin。</p>
<h2 id="2-1-主配置的字段">2.1. 主配置的字段</h2>
<ul>
<li>
<p><code>cniVersion</code> (string)：CNI规范使用的版本，例如版本为0.4.0。</p>
</li>
<li>
<p><code>name</code> (string)：目标网络的名称。</p>
</li>
<li>
<p><code>disableCheck</code> (boolean)：关闭CHECK操作。</p>
</li>
<li>
<p><code>plugins</code> (list)：CNI插件列表及插件配置。</p>
</li>
</ul>
<h2 id="2-2-插件配置字段">2.2. 插件配置字段</h2>
<p>根据不同的插件，插件配置所需的字段不同。</p>
<p>必选字段：</p>
<ul>
<li><code>type</code> (string)：节点上插件二进制的名称，比如bridge，sriov，macvlan等。</li>
</ul>
<p>可选字段：</p>
<ul>
<li>
<p><code>capabilities</code> (dictionary)</p>
</li>
<li>
<p><code>ipMasq</code> (boolean)：为目标网络配上Outbound Masquerade(地址伪装)，即：由容器内部通过网关向外发送数据包时，对数据包的源IP地址进行修改。</p>
<p>当我们的容器以宿主机作为网关时，这个参数是必须要设置的。否则，从容器内部发出的数据包就没有办法通过网关路由到其他网段。因为容器内部的IP地址无法被目标网段识别，所以这些数据包最终会被丢弃掉。</p>
</li>
<li>
<p><code>ipam</code> (dictionary)：IPAM(IP Adderss Management)即IP地址管理，提供了一系列方法用于对IP和路由进行管理。它对应的是由CNI提供的一组标准IPAM插件，比如像host-local，dhcp，static等。比如文中用到的bridge插件，会调用我们所指定的IPAM插件，实现对网络设备IP地址的分配和管理。**如果是自己开发的ipam插件，则相关的入参可以自己定义和实现。</p>
<p>以下以host-local为例说明。</p>
<ul>
<li>type：指定所用IPAM插件的名称，在我们的例子里，用的是host-local。</li>
<li>subnet：为目标网络分配网段，包括网络ID和子网掩码，以CIDR形式标记。在我们的例子里为<code>10.15.10.0/24</code>，也就是目标网段为<code>10.15.10.0</code>，子网掩码为<code>255.255.255.0</code>。</li>
<li>routes：用于指定路由规则，插件会为我们在容器的路由表里生成相应的规则。其中，dst表示希望到达的目标网段，以CIDR形式标记。gw对应网关的IP地址，也就是要到达目标网段所要经过的“next hop(下一跳)”。如果省略gw的话，那么插件会自动帮我们选择默认网关。在我们的例子里，gw选择的是默认网关，而dst为<code>0.0.0.0/0</code>则代表“任何网络”，表示数据包将通过默认网关发往任何网络。实际上，这对应的是一条默认路由规则，即：当所有其他路由规则都不匹配时，将选择该路由。</li>
<li>rangeStart：允许分配的IP地址范围的起始值</li>
<li>rangeEnd：允许分配的IP地址范围的结束值</li>
<li>gateway：为网关（也就是我们将要在宿主机上创建的bridge）指定的IP地址。如果省略的话，那么插件会自动从允许分配的IP地址范围内选择起始值作为网关的IP地址。</li>
</ul>
</li>
<li>
<p><code>dns</code> (dictionary, optional)：dns配置</p>
<ul>
<li>
<p><code>nameservers</code> (list of strings, optional)</p>
</li>
<li>
<p><code>domain</code> (string, optional)</p>
</li>
<li>
<p><code>search</code> (list of strings, optional)</p>
</li>
<li>
<p><code>options</code> (list of strings, optional)</p>
</li>
</ul>
</li>
</ul>
<h2 id="2-3-配置文件示例">2.3. 配置文件示例</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a40000">$</span> <span style="color:#a40000">mkdir</span> <span style="color:#a40000">-p</span> <span style="color:#a40000">/etc/cni/net.d</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">$</span> <span style="color:#a40000">cat</span> <span style="color:#a40000">&gt;/etc/cni/net.d/</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#a40000">-mynet.conf</span> <span style="color:#a40000">&lt;&lt;EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;cniVersion&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1.0.0&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;dbnet&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;plugins&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bridge&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// plugin specific parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">&#34;bridge&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cni0&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;keyA&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;some more&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;plugin specific&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;configuration&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;ipam&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;host-local&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// ipam specific
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">&#34;subnet&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;10.1.0.0/16&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;gateway&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;10.1.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;routes&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;dst&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;0.0.0.0/0&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;dns&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;nameservers&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;10.1.0.1&#34;</span> <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tuning&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;capabilities&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;mac&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;sysctl&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;net.core.somaxconn&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;500&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;portmap&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;capabilities&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;portMappings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-cni插件">3. CNI插件</h1>
<h2 id="3-1-安装插件">3.1. 安装插件</h2>
<p>安装CNI二进制插件，插件下载地：https://github.com/containernetworking/plugins/releases</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下载二进制</span>
</span></span><span style="display:flex;"><span>wget https://github.com/containernetworking/plugins/releases/download/v1.1.0/cni-plugins-linux-amd64-v1.1.0.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 解压文件</span>
</span></span><span style="display:flex;"><span>tar -zvxf cni-plugins-linux-amd64-v1.1.0.tgz -C /opt/cni/bin/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看解压文件</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ll -h</span>
</span></span><span style="display:flex;"><span>总用量 63M
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.7M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 bandwidth
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 4.1M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 bridge
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 9.3M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 dhcp
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 4.2M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 firewall
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.7M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 host-device
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.1M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 host-local
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.8M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 ipvlan
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.2M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 loopback
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.8M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 macvlan
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.6M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 portmap
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 4.0M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 ptp
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.4M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 sbr
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 2.7M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 static
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.3M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 tuning
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.8M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 vlan
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.4M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 vrf
</span></span></code></pre></div><h2 id="3-2-插件分类">3.2. 插件分类</h2>
<p>参考：https://www.cni.dev/plugins/current/</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>插件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>main</td>
<td>bridge</td>
<td>Creates a bridge, adds the host and the container to it</td>
</tr>
<tr>
<td></td>
<td>ipvlan</td>
<td>Adds an ipvlan interface in the container</td>
</tr>
<tr>
<td></td>
<td><strong>macvlan</strong></td>
<td>Creates a new MAC address, forwards all traffic to that to the container</td>
</tr>
<tr>
<td></td>
<td>ptp</td>
<td>Creates a veth pair</td>
</tr>
<tr>
<td></td>
<td><a href="https://www.cni.dev/plugins/current/main/host-device/">host-device</a></td>
<td>Moves an already-existing device into a container</td>
</tr>
<tr>
<td></td>
<td>vlan</td>
<td>Creates a vlan interface off a master</td>
</tr>
<tr>
<td>IPAM</td>
<td>dhcp</td>
<td>Runs a daemon on the host to make DHCP requests on behalf of a container</td>
</tr>
<tr>
<td></td>
<td>host-local</td>
<td>Maintains a local database of allocated IPs</td>
</tr>
<tr>
<td></td>
<td>static</td>
<td>Allocates static IPv4/IPv6 addresses to containers</td>
</tr>
<tr>
<td>meta</td>
<td>tuning</td>
<td>Changes sysctl parameters of an existing interface</td>
</tr>
<tr>
<td></td>
<td>portmap</td>
<td>An iptables-based portmapping plugin. Maps ports from the host’s address space to the container</td>
</tr>
<tr>
<td></td>
<td><strong>bandwidth</strong></td>
<td>Allows bandwidth-limiting through use of traffic control tbf (ingress/egress)</td>
</tr>
<tr>
<td></td>
<td>sbr</td>
<td>A plugin that configures source based routing for an interface (from which it is chained)</td>
</tr>
<tr>
<td></td>
<td>firewall</td>
<td>A firewall plugin which uses iptables or firewalld to add rules to allow traffic to/from the container</td>
</tr>
</tbody>
</table>
<h1 id="4-cni插件接口">4. CNI插件接口</h1>
<p>具体可参考：https://github.com/containernetworking/cni/blob/master/SPEC.md#cni-operations</p>
<p>CNI定义的接口操作有：</p>
<ul>
<li><code>ADD</code>：添加容器网络，在容器启动时调用。</li>
<li><code>DEL</code>：删除容器网络，在容器删除时调用。</li>
<li><code>CHECK</code>：检查容器网络是否正常。</li>
<li><code>VERSION</code>：显示插件版本。</li>
</ul>
<p>这些操作通过<code>CNI_COMMAND</code>环境变量来传递给CNI插件二进制。</p>
<p>其中环境变量包括：</p>
<ul>
<li>
<p><code>CNI_COMMAND</code>：命令操作，包括 <code>ADD</code>, <code>DEL</code>, <code>CHECK</code>, or <code>VERSION</code>。</p>
</li>
<li>
<p><code>CNI_CONTAINERID</code>:容器的ID，有runtime分配，不为空。</p>
</li>
<li>
<p><code>CNI_NETNS</code>:容器的网络命名空间，命名空间路径，例如：/run/netns/[nsname]</p>
</li>
<li>
<p><code>CNI_IFNAME</code>:容器内的网卡名称。</p>
</li>
<li>
<p><code>CNI_ARGS</code>:其他参数。</p>
</li>
<li>
<p><code>CNI_PATH</code>:CNI插件二进制的路径。</p>
</li>
</ul>
<h2 id="4-1-add接口-添加容器网络">4.1. ADD接口：添加容器网络</h2>
<p>在容器的网络命名空间<code>CNI_NETNS</code>中创建<code>CNI_IFNAME</code>网卡设备，或者调整网卡配置。</p>
<p>必选参数：</p>
<ul>
<li><code>CNI_COMMAND</code></li>
<li><code>CNI_CONTAINERID</code></li>
<li><code>CNI_NETNS</code></li>
<li><code>CNI_IFNAME</code></li>
</ul>
<p>可选参数：</p>
<ul>
<li><code>CNI_ARGS</code></li>
<li><code>CNI_PATH</code></li>
</ul>
<h2 id="4-2-del接口-删除容器网络">4.2. DEL接口：删除容器网络</h2>
<p>删除容器网络命名空间<code>CNI_NETNS</code>中的容器网卡<code>CNI_IFNAME</code>，或者撤销ADD修改操作。</p>
<p>必选参数：</p>
<ul>
<li><code>CNI_COMMAND</code></li>
<li><code>CNI_CONTAINERID</code></li>
<li><code>CNI_IFNAME</code></li>
</ul>
<p>可选参数：</p>
<ul>
<li><code>CNI_NETNS</code></li>
<li><code>CNI_ARGS</code></li>
<li><code>CNI_PATH</code></li>
</ul>
<h2 id="4-3-check接口-检查容器网络">4.3. CHECK接口：检查容器网络</h2>
<h2 id="4-4-version接口-输出cni的版本">4.4. VERSION接口：输出CNI的版本</h2>
<p>参考：</p>
<ul>
<li><a href="https://www.cni.dev/docs/spec/">https://www.cni.dev/docs/spec/</a></li>
<li><a href="https://github.com/containernetworking/cni">https://github.com/containernetworking/cni</a></li>
<li><a href="https://github.com/containernetworking/cni/blob/spec-v0.4.0/SPEC.md">https://github.com/containernetworking/cni/blob/spec-v0.4.0/SPEC.md</a></li>
<li><a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/">https://kubernetes.io/zh/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/</a></li>
<li><a href="https://github.com/containernetworking/plugins/tree/master/plugins">https://github.com/containernetworking/plugins/tree/master/plugins</a></li>
<li><a href="https://www.cni.dev/plugins/current/">https://www.cni.dev/plugins/current/</a></li>
<li><a href="https://cloud.tencent.com/developer/news/600713">https://cloud.tencent.com/developer/news/600713</a></li>
<li><a href="https://morningspace.github.io/tech/k8s-net-cni/#%E9%85%8D%E7%BD%AEcni%E6%8F%92%E4%BB%B6">配置CNI插件</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-129b1f198fb56635dc5baed9387d2ce4">5.4.2 - CNI插件选型</h1>
    
	<p>本文主要描述常用的CNI插件的选型，主要包括cilium，calico，flannel三种插件的对比。</p>
<h1 id="1-技术特点对比">1. 技术特点对比</h1>
<table>
<thead>
<tr>
<th>特性</th>
<th><strong>Cilium</strong></th>
<th><strong>Calico</strong></th>
<th><strong>Flannel</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>数据面技术</td>
<td>eBPF 加速</td>
<td>基于 iptables（支持 eBPF）</td>
<td>vxlan、host-gw、ipip 等隧道技术</td>
</tr>
<tr>
<td>转发效率</td>
<td>高（内核级加速，直通流量）</td>
<td>高（支持原生路由）</td>
<td>中（隧道技术增加开销）</td>
</tr>
<tr>
<td>可扩展性</td>
<td>优（支持高级 L7 策略）</td>
<td>优（支持原生路由和简单网络策略）</td>
<td>较低（以 L3 网络为主）</td>
</tr>
<tr>
<td>延迟</td>
<td>低（无需额外隧道或规则）</td>
<td>低（无隧道或 eBPF 模式）</td>
<td>较高（隧道封装增加延迟）</td>
</tr>
<tr>
<td>吞吐量</td>
<td>高（eBPF 高效转发）</td>
<td>中（依赖 iptables 或 eBPF）</td>
<td>较低（隧道开销显著）</td>
</tr>
</tbody>
</table>
<h1 id="2-性能指标对比">2. 性能指标对比</h1>
<table>
<thead>
<tr>
<th>性能指标</th>
<th><strong>Cilium</strong></th>
<th><strong>Calico</strong></th>
<th><strong>Flannel</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>吞吐量</strong></td>
<td>高（eBPF 高效转发）</td>
<td>中-高（取决于模式）</td>
<td>较低（隧道封装损耗较大）</td>
</tr>
<tr>
<td><strong>延迟</strong></td>
<td>低（直接路由模式最佳）</td>
<td>较低（非隧道模式表现良好）</td>
<td>较高（隧道增加延迟）</td>
</tr>
<tr>
<td><strong>CPU使用</strong></td>
<td>较高（eBPF 和可观测性功能）</td>
<td>中（iptables/eBPF 开销）</td>
<td>低（简单架构）</td>
</tr>
<tr>
<td><strong>内存使用</strong></td>
<td>较高（功能丰富）</td>
<td>中</td>
<td>低</td>
</tr>
</tbody>
</table>
<h1 id="3-测试数据示例">3. 测试数据示例</h1>
<p>以下是根据典型测试场景总结的指标（单位为吞吐量 Mbps 和延迟 ms）：</p>
<table>
<thead>
<tr>
<th>测试场景</th>
<th><strong>Cilium</strong></th>
<th><strong>Calico</strong></th>
<th><strong>Flannel</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>吞吐量 (单节点)</strong></td>
<td>~9,000 Mbps</td>
<td>~8,500 Mbps</td>
<td>~6,000 Mbps</td>
</tr>
<tr>
<td><strong>吞吐量 (跨节点)</strong></td>
<td>~8,000 Mbps</td>
<td>~7,500 Mbps</td>
<td>~5,000 Mbps</td>
</tr>
<tr>
<td><strong>延迟 (单节点)</strong></td>
<td>~0.2 ms</td>
<td>~0.3 ms</td>
<td>~1.0 ms</td>
</tr>
<tr>
<td><strong>延迟 (跨节点)</strong></td>
<td>~0.4 ms</td>
<td>~0.5 ms</td>
<td>~2.0 ms</td>
</tr>
</tbody>
</table>
<p>2020年测试数据：</p>
<p>数据来源：<a href="https://itnext.io/benchmark-results-of-kubernetes-network-plugins-cni-over-10gbit-s-network-updated-august-2020-6e1b757b9e49">Benchmark results of Kubernetes network plugins (CNI) over 10Gbit/s network (Updated: August 2020)</a></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1731839739/article/kubernetes/network/cni/cni-comparison.webp" alt=""></p>
<p>[2024年]单位带宽消耗的CPU和内存数据：</p>
<p>数据来源：<a href="https://itnext.io/benchmark-results-of-kubernetes-network-plugins-cni-over-40gbit-s-network-2024-156f085a5e4e#89d8-90c23c8caeb4-reply">Benchmark results of Kubernetes network plugins (CNI) over 40Gbit/s network -2024</a></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1731839992/article/kubernetes/network/cni/Resource-efficiency-per-CNI.webp" alt=""></p>
<p>以上可以看出cilium单位消耗的CPU和内存相比于flannel高。</p>
<h1 id="4-网络性能分析">4. 网络性能分析</h1>
<h2 id="4-1-cilium">4.1. Cilium</h2>
<ul>
<li><strong>吞吐量</strong>：基于 eBPF 的数据面技术，可直接在 Linux 内核中高效转发流量，减少上下文切换。使用直连路由模式（<code>--tunnel=disabled</code>）时，进一步减少封装开销。</li>
<li><strong>延迟</strong>：支持 Sidecar-less 的服务网格架构，能够降低服务间通信延迟。</li>
<li><strong>资源消耗</strong>：由于其高级功能（如 Hubble 可观测性和 L7 策略），在 CPU 和内存使用上高于其他插件。</li>
</ul>
<h2 id="4-2-calico">4.2. Calico</h2>
<ul>
<li><strong>吞吐量</strong>：非隧道模式下，基于 BGP 的原生路由性能接近裸机水平；启用 eBPF 模式时，性能进一步提升。</li>
<li><strong>延迟</strong>：表现良好，但在复杂网络策略下可能增加延迟。</li>
<li><strong>资源消耗</strong>：资源使用适中，适合大多数生产环境。</li>
</ul>
<h2 id="4-3-flannel">4.3. Flannel</h2>
<ul>
<li><strong>吞吐量</strong>：由于采用 VXLAN、IPIP 等隧道封装方式，其性能通常不如 Cilium 和 Calico。</li>
<li><strong>延迟</strong>：封装和解封装的额外操作导致延迟增加。</li>
<li><strong>资源消耗</strong>：架构简单，资源使用最低，适合资源有限的小型集群。</li>
</ul>
<h1 id="5-业务场景选型">5. 业务场景选型</h1>
<p><strong>1. Cilium：适合高性能与安全需求的场景</strong></p>
<ul>
<li>适用场景：
<ul>
<li><strong>微服务架构</strong>：Cilium 的 eBPF 技术支持 L7 数据包过滤、服务可观测性和无 Sidecar 服务网格，非常适合复杂微服务环境。</li>
<li><strong>边缘计算</strong>：在边缘节点上，需要低延迟和高吞吐量，Cilium 的直连路由模式（<code>--tunnel=disabled</code>）非常高效。</li>
<li><strong>多云和混合云</strong>：支持多种高级网络功能，如网络策略的灵活配置和透明的加密。</li>
</ul>
</li>
<li>局限性：
<ul>
<li>部署复杂度相对较高，对 Linux 内核版本有要求（推荐 5.3+）。</li>
<li>资源消耗比 Flannel 高。</li>
</ul>
</li>
</ul>
<p><strong>2. Calico：适合大规模、灵活策略的企业集群</strong></p>
<ul>
<li>适用场景：
<ul>
<li><strong>大规模 Kubernetes 集群</strong>：基于 BGP 的网络路由能够高效扩展，适合公有云和企业级大规模集群。</li>
<li><strong>注重安全策略</strong>：支持丰富的网络安全策略，并提供对接 eBPF 的能力，兼顾性能和策略灵活性。</li>
<li><strong>混合部署</strong>：Calico 可以在非 Kubernetes 工作负载中实现一致的网络策略。</li>
</ul>
</li>
<li>局限性：
<ul>
<li>默认基于 iptables 的实现在高负载下性能可能不如 Cilium 的 eBPF 数据面。</li>
<li>网络策略复杂度较高时，可能增加运维工作量。</li>
</ul>
</li>
</ul>
<p><strong>3. Flannel：适合轻量级和资源有限的集群</strong></p>
<ul>
<li>适用场景：
<ul>
<li><strong>小型集群</strong>：Flannel 架构简单，资源使用少，适合轻量化的 Kubernetes 部署。</li>
<li><strong>测试环境</strong>：性能需求较低的开发和测试环境中，可以快速搭建和运行。</li>
<li><strong>边缘计算（非高性能）</strong>：对网络性能要求较低的小型边缘节点可以使用。</li>
</ul>
</li>
<li>局限性：
<ul>
<li>在吞吐量和延迟上不如 Cilium 和 Calico，尤其是需要大量隧道封装时。</li>
<li>缺乏高级网络功能，例如复杂的网络策略和观测能力。</li>
</ul>
</li>
</ul>
<p><strong>4. 推荐选择总结</strong></p>
<table>
<thead>
<tr>
<th>场景类型</th>
<th>推荐插件</th>
<th>原因</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>高性能微服务架构</strong></td>
<td><strong>Cilium</strong></td>
<td>提供 eBPF 技术，支持复杂策略和低延迟网络</td>
</tr>
<tr>
<td><strong>大规模企业集群</strong></td>
<td><strong>Calico</strong></td>
<td>稳定、灵活，适合多样化和大规模 Kubernetes 部署</td>
</tr>
<tr>
<td><strong>资源受限环境</strong></td>
<td><strong>Flannel</strong></td>
<td>简单易用，资源消耗低</td>
</tr>
<tr>
<td><strong>边缘计算</strong></td>
<td><strong>Cilium/Flannel</strong></td>
<td>Cilium 适合高性能需求，Flannel 适合轻量级节点</td>
</tr>
<tr>
<td><strong>混合云/多云</strong></td>
<td><strong>Cilium/Calico</strong></td>
<td>Cilium 支持透明加密和现代架构，Calico 提供灵活网络策略支持</td>
</tr>
</tbody>
</table>
<p>参考：</p>
<ul>
<li><a href="https://docs.cilium.io/en/latest/operations/performance/benchmark/">https://docs.cilium.io/en/latest/operations/performance/benchmark/</a></li>
<li><a href="https://cilium.io/blog/2018/12/03/cni-performance/">https://cilium.io/blog/2018/12/03/cni-performance/</a></li>
<li><a href="https://cilium.io/blog/2021/05/11/cni-benchmark/">https://cilium.io/blog/2021/05/11/cni-benchmark/</a></li>
<li><a href="https://itnext.io/benchmark-results-of-kubernetes-network-plugins-cni-over-40gbit-s-network-2024-156f085a5e4e#89d8-90c23c8caeb4-reply">Benchmark results of Kubernetes network plugins (CNI) over 40Gbit/s network -2024</a></li>
<li><a href="https://itnext.io/benchmark-results-of-kubernetes-network-plugins-cni-over-10gbit-s-network-updated-august-2020-6e1b757b9e49">Benchmark results of Kubernetes network plugins (CNI) over 10Gbit/s network (Updated: August 2020)</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-480ce0e572d2437e06aed1bd69e4be63">5.4.3 - Macvlan介绍</h1>
    
	<h1 id="1-简介">1. 简介</h1>
<p>macvlan可以看做是物理接口eth（父接口）的子接口，每个macvlan都拥有独立的mac地址，可以被绑定IP作为正常的网卡接口使用。通过这个特性，可以实现在一个物理网络设备绑定多个IP，每个IP拥有独立的mac地址。该特性经常被应用在容器虚拟化中（容器可以配置macvlan的网络，将macvlan interface移动到容器的namespace中）。</p>
<p>示意图：</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan.jpg">
<h1 id="2-四种工作模式">2. 四种工作模式</h1>
<h2 id="2-1-vepa-virtual-ethernet-port-aggregator">2.1. VEPA (Virtual Ethernet Port Aggregator)</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan_vepa.jpg">
<p>VEPA为默认的工作模式，该模式下，所有macvlan发出的流量都会经过父接口，不管目的地是否与该macvlan共用一个父接口。</p>
<h2 id="2-2-bridge-mode">2.2. Bridge mode</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan_bridge.jpg">
<p>该bridge模式类似于传统的网桥模式，拥有相同父接口的macvlan可以直接进行通信，不需要将数据发给父接口转发。该模式下不需要交换机支持hairpin模式，性能比VEPA模式好。另外相对于传统的网桥模式，该模式不需要学习mac地址，不需要STP，使得其性能比传统的网桥性能好得多。但是如果父接口down掉，则所有子接口也会down，同时无法通信。</p>
<h2 id="2-3-private-mode">2.3. Private mode</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan_private.jpg">
<p>该模式是VEPA模式的增强版，</p>
<h2 id="2-4-passthru-mode">2.4. Passthru mode</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan_passthru.jpg">
<p>. </p>
<blockquote>
<p>待完善</p>
</blockquote>
<p>参考：</p>
<ul>
<li><a href="https://backreference.org/2014/03/20/some-notes-on-macvlanmacvtap/">https://backreference.org/2014/03/20/some-notes-on-macvlanmacvtap/</a></li>
<li><a href="https://github.com/containernetworking/plugins/tree/master/plugins/main/macvlan">https://github.com/containernetworking/plugins/tree/master/plugins/main/macvlan</a></li>
<li><a href="https://github.com/containernetworking/plugins/blob/master/plugins/main/macvlan/macvlan.go">https://github.com/containernetworking/plugins/blob/master/plugins/main/macvlan/macvlan.go</a></li>
<li><a href="http://wikibon.org/wiki/v/Edge_Virtual_Bridging">http://wikibon.org/wiki/v/Edge_Virtual_Bridging</a></li>
<li><a href="https://juejin.im/post/5ca183ad6fb9a05e5343a7e8">Linux 虚拟网卡技术：Macvlan</a></li>
<li><a href="http://hicu.be/bridge-vs-macvlan">http://hicu.be/bridge-vs-macvlan</a></li>
<li><a href="http://hicu.be/docker-networking-macvlan-bridge-mode-configuration">http://hicu.be/docker-networking-macvlan-bridge-mode-configuration</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-88a4539d1d63c4a8a931f76e2fb0b364">5.5 - Flannel</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-eb3c09512e1faea3fd031b7ff83f4b4c">5.5.1 - Flannel介绍</h1>
    
	<h1 id="1-flannel简介">1. Flannel简介</h1>
<p>Flannel 是一个简单的、易于使用的 Kubernetes 网络插件，用于为容器集群提供网络功能。它主要解决的是 Kubernetes 集群中跨节点容器间通信的问题，通过为每个节点分配一个独立的子网，确保容器之间可以使用虚拟网络进行无障碍通信。</p>
<h2 id="1-1-flannel-的特点与优势">1.1. Flannel 的特点与优势</h2>
<ol>
<li><strong><code>易于配置和使用</code></strong>
<ul>
<li>提供简单的配置文件，易于集成到 Kubernetes 集群中。</li>
<li>支持多种后端（如 VXLAN、host-gw、AWS VPC 等），灵活满足不同环境需求。</li>
</ul>
</li>
<li><strong><code>跨节点网络通信</code></strong>
<ul>
<li>为每个节点分配独立的子网，容器之间使用虚拟网络 IP 直接通信，而无需 NAT。</li>
</ul>
</li>
<li><strong><code>轻量级设计</code></strong>
<ul>
<li>运行时资源占用少，适合资源有限的环境。</li>
</ul>
</li>
<li><strong><code>稳定兼容性强</code></strong>
<ul>
<li>支持多种 Linux 发行版，兼容 Kubernetes 和 Docker，适应广泛的容器化场景。</li>
</ul>
</li>
<li><strong><code>多后端支持</code></strong>
<ul>
<li>提供 VXLAN、host-gw、AWS VPC、UDP 等多种网络后端，以适应不同场景和需求。</li>
</ul>
</li>
</ol>
<h2 id="1-2-使用场景">1.2. 使用场景</h2>
<ol>
<li><strong>中小规模 Kubernetes 集群</strong>
<ul>
<li>Flannel 易于部署和管理，非常适合中小规模集群使用。</li>
</ul>
</li>
<li><strong>跨节点容器通信</strong>
<ul>
<li>在需要容器间无障碍通信的场景中，Flannel 提供可靠的虚拟网络支持。</li>
</ul>
</li>
<li><strong>非高性能敏感的场景</strong>
<ul>
<li>由于 Flannel 使用封包封装技术（如 VXLAN），在性能要求不是特别高的场景中非常适用。</li>
</ul>
</li>
<li><strong>混合云/多云部署</strong>
<ul>
<li>Flannel 的多后端支持和灵活配置，使其在多种基础设施中易于部署。</li>
</ul>
</li>
</ol>
<h2 id="1-3-flannel-的局限性">1.3. Flannel 的局限性</h2>
<p>尽管 Flannel 易用且轻量，但它也存在一些不足之处：</p>
<ol>
<li><strong>性能限制</strong>
<ul>
<li>使用 VXLAN 或 UDP 后端时，由于封包和解封包操作会消耗额外资源，网络性能可能不如直接路由的方案（如 Calico 的 BGP）。</li>
<li>在高流量或低延迟场景下，Flannel 可能不是最佳选择。</li>
</ul>
</li>
<li><strong>缺乏高级网络功能</strong>
<ul>
<li>不支持网络策略（Network Policy）功能，无法实现细粒度的访问控制。</li>
<li>对于需要复杂网络功能（如流量加密、多租户隔离）的场景，Calico 或 Cilium 是更好的选择。</li>
</ul>
</li>
<li><strong>依赖 etcd</strong>
<ul>
<li>Flannel 强依赖于 etcd。如果 etcd 出现故障，可能影响网络管理和子网分配。</li>
<li>需要额外注意 etcd 的高可用性和性能。</li>
</ul>
</li>
<li><strong>运维复杂度随着规模增长</strong>
<ul>
<li><code>随着集群规模扩大（如 1000+ 节点），Flannel 的资源消耗和配置复杂度可能增加，不如更高性能的网络方案</code>。</li>
</ul>
</li>
</ol>
<h1 id="2-flannel-的架构与配置">2. Flannel 的架构与配置</h1>
<p>flannel的架构比较简单，只有每个节点一个的<code>flanneld</code>组件，通过<code>daemonset</code>部署，并没有跟calico或cilium的架构中有中控组件。其他组件则使用k8s的etcd。</p>
<ol>
<li><strong>flanneld 组件</strong>
<ul>
<li>每个节点运行一个 flanneld 服务，负责管理该节点的网络配置和数据封包解封包。</li>
</ul>
</li>
<li><strong>etcd 集成</strong>
<ul>
<li>Flannel 使用 etcd 存储网络配置和子网分配信息。</li>
<li>所有节点通过 etcd 协调分配网络资源。</li>
</ul>
</li>
<li><strong>网络后端</strong>
<ul>
<li>Flannel 支持多种后端技术，如 VXLAN、UDP、host-gw 等，可根据需求选择。</li>
</ul>
</li>
<li><strong>Kubernetes 集成</strong>
<ul>
<li>Flannel 通过 Kubernetes 的 CNI 插件接口无缝集成，确保与 Kubernetes 网络需求的兼容性。</li>
</ul>
</li>
</ol>
<h2 id="2-1-部署flannel">2.1. 部署flannel</h2>
<p>通过以下的yaml文件可以快速的部署flannel组件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</span></span></code></pre></div><p>部署完成后会生成默认配置：<code>kube-flannel-cfg</code>， 其中默认使用<code>vxlan</code>的后端模式。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">cni-conf.json</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      &#34;name&#34;: &#34;cbr0&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      &#34;cniVersion&#34;: &#34;0.3.1&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      &#34;plugins&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">          &#34;type&#34;: &#34;flannel&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">          &#34;delegate&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &#34;hairpinMode&#34;: true,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &#34;isDefaultGateway&#34;: true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">          }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        },
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">          &#34;type&#34;: &#34;portmap&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">          &#34;capabilities&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            &#34;portMappings&#34;: true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">          }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      ]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    }</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">net-conf.json</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      &#34;Network&#34;: &#34;10.244.0.0/16&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      &#34;Backend&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        &#34;Type&#34;: &#34;vxlan&#34;  // 默认为vxlan的模式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    }</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span></code></pre></div><h2 id="2-2-节点配置">2.2. 节点配置</h2>
<p>在<code>/etc/cni/net.d</code>路径下会生成flannel的cni配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>{<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">&#34;name&#34;: </span><span style="color:#4e9a06">&#34;cbr0&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">&#34;cniVersion&#34;: </span><span style="color:#4e9a06">&#34;0.3.1&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">&#34;plugins&#34;: </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>{<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">&#34;type&#34;: </span><span style="color:#4e9a06">&#34;flannel&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">&#34;delegate&#34;: </span>{<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">&#34;hairpinMode&#34;: </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">&#34;isDefaultGateway&#34;: </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>}<span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>{<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">&#34;type&#34;: </span><span style="color:#4e9a06">&#34;portmap&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">&#34;capabilities&#34;: </span>{<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">&#34;portMappings&#34;: </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>同时在节点会生成一个子网配置<code>/var/run/flannel/subnet.env</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">FLANNEL_NETWORK</span><span style="color:#ce5c00;font-weight:bold">=</span>10.244.0.0/16  <span style="color:#8f5902;font-style:italic"># 整个集群的Pod网段</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_SUBNET</span><span style="color:#ce5c00;font-weight:bold">=</span>10.244.3.1/24   <span style="color:#8f5902;font-style:italic"># 该节点的子网Pod网段</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_MTU</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1450</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_IPMASQ</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span></code></pre></div><p>节点会生成<code>cni0</code>和<code>flannel.1</code>的网卡，其中<code>网卡的网段跟该节点的FLANNEL_SUBNET网段一致，如果不一致则需要重建网卡</code>。</p>
<ul>
<li><code>flannel.1</code>：节点网关，10.244.3.0</li>
<li><code>cni0</code>: 10.244.3.1</li>
<li><code>FLANNEL_SUBNET</code>=10.244.3.1/24</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cni0: <span style="color:#000">flags</span><span style="color:#ce5c00;font-weight:bold">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style="color:#0000cf;font-weight:bold">1450</span>
</span></span><span style="display:flex;"><span>        inet 10.244.3.1  netmask 255.255.255.0  broadcast 10.244.3.255
</span></span><span style="display:flex;"><span>        inet6 fe80::828:abff:fe83:34ac  prefixlen <span style="color:#0000cf;font-weight:bold">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span style="display:flex;"><span>        ether 0a:28:ab:83:34:ac  txqueuelen <span style="color:#0000cf;font-weight:bold">1000</span>  <span style="color:#ce5c00;font-weight:bold">(</span>Ethernet<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#0000cf;font-weight:bold">16220840959</span>  bytes <span style="color:#0000cf;font-weight:bold">2329280828193</span> <span style="color:#ce5c00;font-weight:bold">(</span>2.3 TB<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#0000cf;font-weight:bold">0</span>  dropped <span style="color:#0000cf;font-weight:bold">0</span>  overruns <span style="color:#0000cf;font-weight:bold">0</span>  frame <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#0000cf;font-weight:bold">16382181068</span>  bytes <span style="color:#0000cf;font-weight:bold">43297103465563</span> <span style="color:#ce5c00;font-weight:bold">(</span>43.2 TB<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#0000cf;font-weight:bold">0</span>  dropped <span style="color:#0000cf;font-weight:bold">0</span> overruns <span style="color:#0000cf;font-weight:bold">0</span>  carrier <span style="color:#0000cf;font-weight:bold">0</span>  collisions <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>flannel.1: <span style="color:#000">flags</span><span style="color:#ce5c00;font-weight:bold">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span style="color:#0000cf;font-weight:bold">1450</span>
</span></span><span style="display:flex;"><span>        inet 10.244.3.0  netmask 255.255.255.255  broadcast 0.0.0.0
</span></span><span style="display:flex;"><span>        inet6 fe80::d875:a3ff:fe8b:1e64  prefixlen <span style="color:#0000cf;font-weight:bold">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span style="display:flex;"><span>        ether da:75:a3:8b:1e:64  txqueuelen <span style="color:#0000cf;font-weight:bold">0</span>  <span style="color:#ce5c00;font-weight:bold">(</span>Ethernet<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#0000cf;font-weight:bold">225837271</span>  bytes <span style="color:#0000cf;font-weight:bold">33216374045</span> <span style="color:#ce5c00;font-weight:bold">(</span>33.2 GB<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#0000cf;font-weight:bold">0</span>  dropped <span style="color:#0000cf;font-weight:bold">0</span>  overruns <span style="color:#0000cf;font-weight:bold">0</span>  frame <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#0000cf;font-weight:bold">204036495</span>  bytes <span style="color:#0000cf;font-weight:bold">396891087255</span> <span style="color:#ce5c00;font-weight:bold">(</span>396.8 GB<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#0000cf;font-weight:bold">0</span>  dropped <span style="color:#0000cf;font-weight:bold">0</span> overruns <span style="color:#0000cf;font-weight:bold">0</span>  carrier <span style="color:#0000cf;font-weight:bold">0</span>  collisions <span style="color:#0000cf;font-weight:bold">0</span>        
</span></span></code></pre></div><h1 id="3-flannel网络原理">3. Flannel网络原理</h1>
<h2 id="3-1-原理图">3.1. 原理图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578568/article/flannel/flannel.png" alt="flannel"></p>
<blockquote>
<p>图中docker0等价于cni0, flannel0等价于flannel.1网卡</p>
</blockquote>
<p><strong>关键网卡和路由表的角色</strong></p>
<ol>
<li><strong><code>cni0</code> 网桥</strong>
<ul>
<li>是一个 Linux 网桥，连接同一节点上的所有 Pod 网络接口（<code>veth</code> 对）。</li>
<li><code>将数据包从 Pod 转发到本地的其他 Pod</code> 或上交给 <code>flannel.1</code>。</li>
</ul>
</li>
<li><strong><code>flannel.1</code> 网卡</strong>
<ul>
<li>是一个虚拟网卡（VXLAN 接口），<code>用于封装和解封装跨节点的 Pod 数据包</code>。</li>
<li>连接到物理网络，通过封装的方式将数据包发送到目标节点。</li>
</ul>
</li>
<li><strong><code>路由表</code></strong>
<ul>
<li>定义了如何转发数据包，包括 Pod 子网的路由规则和默认路由。</li>
<li>Flannel 会在每个节点配置路由表，使得本地 Pod 的子网可以通过 <code>cni0</code> 访问，远程 Pod 的子网通过 <code>flannel.1</code> 访问。</li>
</ul>
</li>
</ol>
<h2 id="3-2-数据包路径">3.2. 数据包路径</h2>
<h3 id="3-2-1-数据包环境">3.2.1. 数据包环境</h3>
<p>假设有以下环境：</p>
<ul>
<li><strong>Node A</strong>：子网 <code>10.244.1.0/24</code>，Pod1 的 IP 是 <code>10.244.1.2</code>。</li>
<li><strong>Node B</strong>：子网 <code>10.244.2.0/24</code>，Pod2 的 IP 是 <code>10.244.2.3</code>。</li>
<li>两个节点通过物理网络互联。</li>
</ul>
<p>其中节点路由表信息如下：</p>
<p>A 节点（Pod IP：10.244.1.2）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 物理机路由</span>
</span></span><span style="display:flex;"><span>default via &lt;物理机网关&gt; dev bond0 proto static
</span></span><span style="display:flex;"><span>&lt;物理机目标网段&gt; dev bond0 proto kernel scope link src &lt;本机节点IP&gt;
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># flannel路由</span>
</span></span><span style="display:flex;"><span>10.244.0.0/24 via 10.244.0.0 dev flannel.1 onlink
</span></span><span style="display:flex;"><span>10.244.1.0/24 dev cni0 proto kernel scope link src 10.244.1.1  <span style="color:#8f5902;font-style:italic">#本地子网，直接通过 cni0 处理。</span>
</span></span><span style="display:flex;"><span>10.244.2.0/24 via 10.244.2.0 dev flannel.1 onlink <span style="color:#8f5902;font-style:italic"># 远程子网，数据包通过 flannel.1 封装</span>
</span></span></code></pre></div><p>B节点（Pod IP：10.244.2.3）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 物理机路由</span>
</span></span><span style="display:flex;"><span>default via &lt;物理机网关&gt; dev bond0 proto static
</span></span><span style="display:flex;"><span>&lt;物理机目标网段&gt; dev bond0 proto kernel scope link src &lt;本机节点IP&gt;
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># flannel路由</span>
</span></span><span style="display:flex;"><span>10.244.0.0/24 via 10.244.0.0 dev flannel.1 onlink
</span></span><span style="display:flex;"><span>10.244.1.0/24 via 10.244.1.0 dev flannel.1 onlink    <span style="color:#8f5902;font-style:italic"># 远程子网，数据包通过 flannel.1 封装</span>
</span></span><span style="display:flex;"><span>10.244.2.0/24 dev cni0 proto kernel scope link src 10.244.2.1  <span style="color:#8f5902;font-style:italic">#本地子网，直接通过 cni0 处理。</span>
</span></span></code></pre></div><h3 id="3-2-1-数据路径">3.2.1. 数据路径</h3>
<p><strong>1. 从 Pod 发出的数据包</strong></p>
<p><strong>(1) Pod1 发送数据包</strong></p>
<ul>
<li>Pod1 发往 Pod2 的数据包：
<ul>
<li><strong>源 IP</strong>：<code>10.244.1.2</code></li>
<li><strong>目标 IP</strong>：<code>10.244.2.3</code></li>
</ul>
</li>
<li>数据包通过 Pod1 的 <code>veth</code> 设备发送到本地的 <code>cni0</code> 网桥。</li>
</ul>
<p><strong>2. cni0 网桥处理</strong></p>
<ul>
<li><strong>判断目标 IP 属于哪个子网</strong>：
<ul>
<li>本节点子网（<code>10.244.1.0/24</code>）：直接转发到对应的 <code>veth</code>。</li>
<li>其他子网（<code>10.244.2.0/24</code>）：路由表指向 <code>flannel.1</code>。</li>
</ul>
</li>
<li>在本例中，目标 IP 属于 <code>10.244.2.0/24</code>，因此数据包通过路由规则转发到 <code>flannel.1</code>。</li>
</ul>
<p><strong>3. flannel.1 网卡封装</strong></p>
<p><strong>(1) 数据封装</strong></p>
<ul>
<li>Flannel 代理（<code>flanneld</code>）会检测目标子网属于远程节点，触发封装流程。</li>
<li>数据包封装为 VXLAN 包，外层 IP 标头：
<ul>
<li><strong>源 IP</strong>：Node A 的物理 IP（例如 <code>192.168.1.1</code>）。</li>
<li><strong>目标 IP</strong>：Node B 的物理 IP（例如 <code>192.168.1.2</code>）。</li>
<li><strong>VXLAN Header</strong>：标记虚拟网络 ID 和其他信息。</li>
</ul>
</li>
</ul>
<p><strong>(2) 路由转发</strong></p>
<ul>
<li>封装后的数据包通过主机的物理网卡（如 <code>eth0</code>）发送到目标节点。</li>
</ul>
<p><strong>4. 到达目标节点 (Node B)</strong></p>
<p><strong>(1) flannel.1 接收数据包</strong></p>
<ul>
<li>Node B 的物理网卡接收封装的 VXLAN 数据包，交由 <code>flannel.1</code>。</li>
<li>flannel.1 解封数据包，还原出原始的 Pod 数据包：
<ul>
<li><strong>源 IP</strong>：<code>10.244.1.2</code></li>
<li><strong>目标 IP</strong>：<code>10.244.2.3</code></li>
</ul>
</li>
</ul>
<p><strong>(2) 路由到 cni0</strong></p>
<ul>
<li>根据路由表，目标子网 <code>10.244.2.0/24</code> 属于本节点，通过 <code>cni0</code> 转发数据包。</li>
<li><code>cni0</code> 根据目标 IP，找到 Pod2 的 <code>veth</code> 设备。</li>
</ul>
<p><strong>5. 数据包到达目标 Pod</strong></p>
<ul>
<li>数据包最终通过 <code>cni0</code> 网桥送到 Pod2 的 <code>veth</code> 接口，Pod2 接收到来自 Pod1 的通信。</li>
</ul>
<h3 id="3-2-3-数据流总结">3.2.3. 数据流总结</h3>
<ol>
<li>Pod1 数据包先进入本地的 <code>cni0</code> 网桥。</li>
<li><code>cni0</code> 网桥通过路由表，发现目标 IP 属于其他子网，交由 <code>flannel.1</code>。</li>
<li><code>flannel.1</code> 封装数据包，并通过物理网卡发往目标节点。</li>
<li>目标节点的 <code>flannel.1</code> 解封数据包，交给 <code>cni0</code>。</li>
<li><code>cni0</code> 网桥将数据包转发到目标 Pod 的 <code>veth</code>。</li>
</ol>
<p>通过这种方式，不同节点的 Pod 实现了透明的互通。</p>
<h1 id="4-总结">4. 总结</h1>
<p>Flannel是一个非常简单，稳定的CNI插件，其中部署和配置方式都非常简单，网络原理也简单，出现问题排查比较方便。特别适合k8s集群规模不大（1000个节点以内），网络性能要求不是非常严格，且团队中网络相关人员较少且无法支持维护复杂网络插件的团队使用。因为选择方案有一个基本的考虑点是该方案稳定且团队中有人可维护，而Flannel是一个维护成本相对比较低的网络方案。</p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/flannel-io/flannel">https://github.com/flannel-io/flannel</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-caea0fdc09153c5bf2a00683735e5c5c">5.6 - Calico</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b7d5f8098709f945fc638e3c2853de6b">5.6.1 - Calico介绍</h1>
    
	<h1 id="1-calico简介">1. Calico简介</h1>
<p><strong>Calico</strong> 是一个开源的网络和网络安全解决方案，主要用于 Kubernetes 等容器编排系统。它通过提供高效的网络连接和强大的安全控制来满足容器化和微服务架构的需求。Calico 以其灵活性、可扩展性和性能著称，是许多企业和云原生应用的首选网络插件。</p>
<h2 id="1-1-主要功能和特点">1.1. 主要功能和特点</h2>
<ol>
<li>
<p><strong>网络架构</strong>：</p>
<ul>
<li><strong>L3 路由架构</strong>：Calico 基于第三层（L3）网络构建，不依赖传统的覆盖网络（overlay network），使其可以利用 IP 路由来实现跨节点的直接通信。</li>
<li><strong>BGP 支持</strong>：Calico 使用 BGP（边界网关协议）来分发和同步路由信息，使得容器和 Pod 能够跨节点直接通信，减少网络延迟，提升性能。</li>
<li><strong>支持多种后端</strong>：除了默认的 IP 路由模式，Calico 也支持 VXLAN、IPIP、WireGuard 和 eBPF 后端，适应不同的网络环境和需求。</li>
</ul>
</li>
<li>
<p><strong>网络安全</strong>：</p>
<ul>
<li><strong>网络策略</strong>：Calico 支持标准的 Kubernetes NetworkPolicy，用户可以通过策略控制 Pod 之间的通信权限。</li>
<li><strong>GlobalNetworkPolicy</strong>：Calico 提供 GlobalNetworkPolicy，可以实现跨命名空间、跨集群的统一策略管理，用于多租户隔离或更高的安全控制。</li>
<li><strong>支持 eBPF</strong>：Calico 在启用 eBPF 模式时，可以通过 eBPF 提供更高效的网络数据处理，并支持 L4 层的负载均衡和网络策略控制。</li>
</ul>
</li>
<li>
<p><strong>可观测性和可视化</strong>：</p>
<ul>
<li>Calico 集成了多种可观测性工具，支持 Prometheus 等监控系统，并可以生成网络流量和策略的监控指标，帮助运维人员了解网络状况。</li>
<li>支持与 EFK（Elasticsearch, Fluentd, Kibana）集成，便于可视化网络流量和策略。</li>
</ul>
</li>
<li>
<p><strong>高扩展性</strong>：</p>
<ul>
<li>Calico 可以在不同的基础设施中运行，包括本地数据中心和云平台（AWS、GCP、Azure），并支持与 VM 及裸金属服务器互联。</li>
<li>使用 IP 路由和 BGP，使得 Calico 在大规模集群中也能保持良好的性能和扩展性。</li>
</ul>
</li>
</ol>
<h2 id="1-2-适用场景">1.2. 适用场景</h2>
<ul>
<li><strong>容器化应用的网络管理</strong>：适用于 Kubernetes 等容器编排平台，为容器提供高效、安全的网络连接。</li>
<li><strong>混合云和多集群部署</strong>：Calico 支持跨数据中心和云环境的多集群部署，非常适合混合云和多租户环境。</li>
<li><strong>网络安全</strong>：对于需要细粒度的网络安全策略控制和多租户隔离的场景，Calico 提供多层次的安全控制和隔离。</li>
</ul>
<h2 id="1-3-calico的局限性">1.3. Calico的局限性</h2>
<p>calico也存在一些不足和局限性。</p>
<p><strong><code>1. 对网络拓扑的依赖</code></strong></p>
<ul>
<li><strong>BGP 配置复杂性</strong>：
Calico 默认使用 BGP 协议进行路由，如果网络环境中没有现成的 BGP 支持（如非生产环境或网络管理员经验不足），配置可能较复杂。此外，BGP 的管理对部分运维人员有一定门槛。</li>
<li><strong>对底层网络要求较高</strong>：
Calico 的无隧道设计依赖底层网络的正常运行。如果底层网络不支持高效的路由或不能很好地管理多播流量，可能会影响整体网络性能。</li>
</ul>
<hr>
<p><strong><code>2. 大规模集群性能问题</code></strong></p>
<ul>
<li><strong>etcd 负载</strong>：
在大规模 Kubernetes 集群中（如几千个节点），Calico 对 etcd 的访问频率较高，这可能会给 etcd 带来较大压力。尽管 Typha 可以缓解部分问题，但依然可能成为瓶颈。</li>
<li><strong>路由表膨胀</strong>：
在大规模集群中，BGP 模式下每个节点需要维护大量路由信息（与集群中 Pod 的数量相关），可能导致路由表膨胀并对内存和 CPU 资源产生较大压力。</li>
</ul>
<h1 id="2-calico架构图">2. Calico架构图</h1>
<blockquote>
<p>来自官网</p>
</blockquote>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1693626884/article/calico/calico-architecture.png" title="" alt="" width="1046">
<h2 id="2-1-calico-架构概览">2.1. Calico 架构概览</h2>
<p>Calico 通过 BGP（边界网关协议）在 Kubernetes 集群节点之间进行路由广播，无需使用复杂的隧道协议（如 VXLAN 或 GRE），这使得 Calico 的网络性能较高。它主要由以下组件组成：</p>
<ol>
<li><strong>calico-node</strong>：这是 Calico 的核心组件，运行在每个节点上，负责设置路由、管理 IP 地址，并通过 Felix 实现网络策略的执行。</li>
<li><strong>BGP Daemon (Bird)</strong>：负责节点之间的路由传播，以实现不同节点 Pod 之间的流量路由。</li>
<li><strong>Felix</strong>：作为 Calico 的主代理，负责监控 etcd 中存储的网络策略并将其应用于节点的网络接口，同时负责设置 IP 路由、管理 ACLs 以确保流量符合策略。</li>
<li><strong>Typha</strong>：当节点数较多时，可以通过 Typha 组件来减少 etcd 的访问负载。它会将 etcd 中的策略变化缓存起来，并同步给每个节点的 Felix 代理。</li>
<li><strong>etcd</strong>：Calico 使用 etcd 作为存储后端，用于存储网络策略、IP 池等配置。也可以使用 Kubernetes 的 API Server 作为存储后端，便于集成。</li>
</ol>
<h2 id="2-2-calico-的核心组件">2.2. Calico 的核心组件</h2>
<ul>
<li><strong>calicoctl</strong>：这是 Calico 提供的命令行工具，用于配置和管理 Calico 的资源，比如 IP 池、策略、网络设置等。可以通过该工具查看、创建、更新和删除网络策略。</li>
<li><strong>IPAM (IP Address Management)</strong>：Calico 自带的 IP 地址管理模块，可以为集群中的 Pod 自动分配 IP 地址。IPAM 支持灵活的 IP 池设置，可以对不同的节点、命名空间或工作负载分配特定的 IP 范围。</li>
</ul>
<h2 id="2-3-工作流程">2.3. 工作流程</h2>
<ul>
<li>每个节点上运行的 calico-node 组件会和其他节点进行 BGP 路由信息交换，确保不同节点的 Pod 可以互相通信。</li>
<li>Felix 组件负责将网络策略的定义应用到实际的网络接口上，以确保流量符合预设的策略。</li>
<li>Typha 组件在大规模集群中可以有效地减少 etcd 的压力，帮助 Felix 快速同步网络策略。</li>
</ul>
<h2 id="2-4-calico-网络策略-network-policy">2.4. Calico 网络策略 (Network Policy)</h2>
<p>Calico 支持丰富的网络策略，用于定义不同的 Pod 或服务之间的网络访问规则。网络策略的主要功能包括：</p>
<ul>
<li><strong>基于标签的策略</strong>：可以根据 Pod 或命名空间的标签来控制网络流量的允许和拒绝。</li>
<li><strong>支持 Egress 和 Ingress 策略</strong>：不仅可以控制进入 Pod 的流量，还可以控制 Pod 发出的流量。</li>
<li><strong>灵活的规则定义</strong>：支持基于 IP 地址、端口、协议的规则配置，能够精细地控制网络流量。</li>
</ul>
<h1 id="3-calico组件及配置">3. Calico组件及配置</h1>
<p>calico的部署可参考：<a href="https://github.com/huweihuang/kubeadm-scripts/blob/main/cni/install-calico.sh">kubeadm-scripts/cni/install-calico.sh</a></p>
<p>部署完成后可以在k8s集群中看到以下组件：</p>
<ul>
<li>
<p>中控组件：calico-kube-controllers</p>
</li>
<li>
<p>节点组件：calico-node</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>calico-system   calico-kube-controllers-8945657f7-ntbxm             1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>             421d
</span></span><span style="display:flex;"><span>calico-system   calico-node-2df8c                                   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>             421d
</span></span><span style="display:flex;"><span>calico-system   calico-node-5vq6z                                   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>             421d
</span></span><span style="display:flex;"><span>calico-system   calico-node-dpnkd                                   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>             421d
</span></span><span style="display:flex;"><span>calico-system   calico-node-sms2h                                   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>             421d
</span></span><span style="display:flex;"><span>calico-system   calico-node-w95l2                                   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>             414d
</span></span></code></pre></div><h2 id="3-1-calico-node进程树">3.1. calico node进程树</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#4e9a06">\_</span> /usr/local/bin/runsvdir -P /etc/service/enabled
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">\_</span> runsv confd
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">\_</span> calico-node -confd
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">\_</span> runsv allocate-tunnel-addrs
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">\_</span> calico-node -allocate-tunnel-addrs
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">\_</span> runsv monitor-addresses
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">\_</span> calico-node -monitor-addresses
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">\_</span> runsv bird
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">\_</span> bird -R -s /var/run/calico/bird.ctl -d -c /etc/calico/confd/config/bird.cfg
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">\_</span> runsv felix
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">\_</span> calico-node -felix
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">\_</span> runsv cni
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">\_</span> calico-node -monitor-token
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">\_</span> runsv node-status-reporter
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">\_</span> calico-node -status-reporter
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">\_</span> runsv bird6
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">\_</span> bird6 -R -s /var/run/calico/bird6.ctl -d -c /etc/calico/confd/config/bird6.cfg
</span></span></code></pre></div><h2 id="3-2-calico-kube-controllers进程树">3.2. calico-kube-controllers进程树</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/bin/kube-controllers
</span></span></code></pre></div><h2 id="3-3-cni-calico二进制">3.3. CNI calico二进制</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> /opt/cni/bin
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- calico
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- calico-ipam
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- install
</span></span></code></pre></div><h2 id="3-4-cni-calico配置">3.4. CNI calico配置</h2>
<p><strong>10-calico.conflist</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">cd</span> /etc/cni/net.d
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cat 10-calico.conflist</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;name&#34;</span>: <span style="color:#4e9a06">&#34;k8s-pod-network&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;cniVersion&#34;</span>: <span style="color:#4e9a06">&#34;0.3.1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;plugins&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;type&#34;</span>: <span style="color:#4e9a06">&#34;calico&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;log_level&#34;</span>: <span style="color:#4e9a06">&#34;info&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;log_file_path&#34;</span>: <span style="color:#4e9a06">&#34;/var/log/calico/cni/cni.log&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;datastore_type&#34;</span>: <span style="color:#4e9a06">&#34;kubernetes&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;nodename&#34;</span>: <span style="color:#4e9a06">&#34;node1&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;mtu&#34;</span>: 0,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;ipam&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#4e9a06">&#34;type&#34;</span>: <span style="color:#4e9a06">&#34;calico-ipam&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;policy&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#4e9a06">&#34;type&#34;</span>: <span style="color:#4e9a06">&#34;k8s&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;kubernetes&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#4e9a06">&#34;kubeconfig&#34;</span>: <span style="color:#4e9a06">&#34;/etc/cni/net.d/calico-kubeconfig&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;type&#34;</span>: <span style="color:#4e9a06">&#34;portmap&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;snat&#34;</span>: true,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;capabilities&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;portMappings&#34;</span>: true<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;type&#34;</span>: <span style="color:#4e9a06">&#34;bandwidth&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;capabilities&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;bandwidth&#34;</span>: true<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>calico-kubeconfig</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Kubeconfig file for Calico CNI plugin. Installed by calico/node.</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Config
</span></span><span style="display:flex;"><span>clusters:
</span></span><span style="display:flex;"><span>- name: <span style="color:#204a87">local</span>
</span></span><span style="display:flex;"><span>  cluster:
</span></span><span style="display:flex;"><span>    server: https://10.96.0.1:443
</span></span><span style="display:flex;"><span>    certificate-authority-data: <span style="color:#4e9a06">&#34;xxx&#34;</span>
</span></span><span style="display:flex;"><span>users:
</span></span><span style="display:flex;"><span>- name: calico
</span></span><span style="display:flex;"><span>  user:
</span></span><span style="display:flex;"><span>    token:xxx
</span></span><span style="display:flex;"><span>contexts:
</span></span><span style="display:flex;"><span>- name: calico-context
</span></span><span style="display:flex;"><span>  context:
</span></span><span style="display:flex;"><span>    cluster: <span style="color:#204a87">local</span>
</span></span><span style="display:flex;"><span>    user: calico
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://docs.tigera.io/calico/latest/about/">https://docs.tigera.io/calico/latest/about/</a></p>
</li>
<li>
<p><a href="https://docs.tigera.io/calico/latest/reference/architecture/overview">https://docs.tigera.io/calico/latest/reference/architecture/overview</a></p>
</li>
<li>
<p><a href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart">https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart</a></p>
</li>
<li>
<p><a href="https://www.tigera.io/blog/live-migration-from-flannel-to-calico/">Live Migration from Flannel to Calico</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-af84a8f11d81303df4a59c14ff718766">5.7 - Cilium</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b3be6cf6bdb3650e526c70a6622dce49">5.7.1 - Cilium介绍</h1>
    
	<h1 id="1-cilium简介">1. Cilium简介</h1>
<p>Cilium 是一个开源的容器网络插件（CNI），专为 Kubernetes 和云原生环境设计，基于 <strong>eBPF（Extended Berkeley Packet Filter）</strong> 实现高性能、可扩展的网络和安全功能。它支持微服务间的细粒度流量控制，能够在 L3/L4/L7 层提供网络策略，同时具有强大的可观测性工具（如 Hubble）以帮助运维人员监控和优化流量。</p>
<h2 id="1-1-核心特性">1.1. 核心特性</h2>
<ol>
<li>
<p><strong>基于 eBPF 的</strong>高性能<strong>数据平面</strong></p>
<ul>
<li>
<p><strong>eBPF</strong>：Cilium 通过 eBPF 在 Linux 内核中直接运行数据包处理逻辑，避免了内核与用户态的频繁切换，大幅提高了性能。</p>
</li>
<li>
<p><strong>高效流量转发</strong>：支持 BPF 的快速路径优化（Zero-Copy 转发），在高流量环境中表现出色。</p>
</li>
</ul>
</li>
<li>
<p><strong>多层网络策略</strong></p>
<ul>
<li>
<p><strong>L3/L4 策略</strong>：基于 IP 和端口的基本流量控制。</p>
</li>
<li>
<p><strong>L7 策略</strong>：支持应用层协议（如 HTTP、gRPC）的访问控制，可以根据请求路径、方法或内容过滤流量。</p>
</li>
<li>
<p><strong>微服务友好</strong>：特别适合需要细粒度网络策略的微服务架构。</p>
</li>
</ul>
</li>
<li>
<p><strong>可观测性</strong></p>
<ul>
<li>
<p><strong>Hubble</strong>：Cilium 内置的可观测性平台，可以实时监控服务间的网络流量、延迟和错误率，帮助开发和运维团队快速定位问题。</p>
</li>
<li>
<p><strong>流量路径追踪</strong>：支持流量路径的全链路追踪，便于排查网络瓶颈或策略冲突。</p>
</li>
</ul>
</li>
<li>
<p><strong>拓展性</strong></p>
<ul>
<li>
<p>支持自定义 eBPF 程序，用户可以根据业务需求扩展网络功能。</p>
</li>
<li>
<p>与其他云原生工具（如 Prometheus、Grafana、Istio）无缝集成。</p>
</li>
</ul>
</li>
<li>
<p><strong>跨云和混合云支持</strong></p>
<ul>
<li>支持 Kubernetes 集群的多网络环境，例如在跨云和混合云场景中提供统一的网络策略和流量控制。</li>
</ul>
</li>
<li>
<p><strong>服务发现与负载均衡</strong></p>
<ul>
<li>
<p><strong>内置服务负载均衡</strong>：提供内核级的流量负载均衡，比传统的 kube-proxy 性能更高。</p>
</li>
<li>
<p><strong>服务发现支持</strong>：可以与 Kubernetes 的 Service 资源协同工作，自动实现 Pod 间通信。</p>
</li>
</ul>
</li>
</ol>
<h2 id="1-2-适用场景">1.2. 适用场景</h2>
<ol>
<li>云原生微服务架构
<ul>
<li>在需要严格流量控制和丰富可观测性的环境中表现尤为出色。</li>
</ul>
</li>
<li>边缘计算
<ul>
<li>低延迟需求较高的场景，如 CDN 边缘节点和 IoT 环境。</li>
</ul>
</li>
<li>高流量集群
<ul>
<li>适用于对吞吐量和性能要求极高的生产集群，例如电商、流媒体和金融服务。</li>
</ul>
</li>
<li>多租户隔离
<ul>
<li>支持多租户网络环境中的强隔离需求。</li>
</ul>
</li>
</ol>
<h2 id="1-3-cilium的局限性">1.3. Cilium的局限性</h2>
<p>虽然 Cilium 在现代 Kubernetes 网络中表现出色，但它也存在一些缺点或需要注意的限制。</p>
<p><strong><code>1. 高性能消耗</code></strong></p>
<ul>
<li><strong>内存和 CPU 占用</strong>：由于需要在每个节点运行 Cilium Agent 和依赖 eBPF 加载程序，可能对节点资源消耗较高，尤其是在高流量场景下。</li>
<li><strong>资源密集功能</strong>：如 Hubble（Cilium 的可观测性工具）可能进一步增加资源使用。</li>
</ul>
<p><strong><code>2. 依赖 Linux 内核版本</code></strong></p>
<ul>
<li><strong>eBPF 限制</strong>：Cilium 依赖 eBPF 技术，对 Linux 内核版本有要求，最低需要 <strong>4.19+</strong>，部分功能（如高级负载均衡）需要 <strong>5.x</strong> 或更高版本。</li>
<li><strong>内核升级成本</strong>：在某些环境（如老旧系统或企业级环境）中，升级内核可能具有挑战性。</li>
</ul>
<p><strong><code>3. 学习曲线陡峭</code></strong></p>
<ul>
<li><strong>复杂性</strong>：Cilium 引入了 eBPF 技术，与传统 CNI（如 Calico、Flannel）相比技术更复杂，需要深入理解 eBPF、Linux 内核网络栈和 Cilium 的配置方式。</li>
</ul>
<p><strong><code>4. 部署和管理复杂</code></strong></p>
<ul>
<li><strong>高级功能配置繁琐</strong>：如替代 <code>kube-proxy</code> 或配置高性能负载均衡，需要了解底层网络和 Kubernetes 的细节。</li>
<li><strong>监控和故障排查难度</strong>：eBPF 程序运行在内核中，排查问题时无法直接查看传统用户态日志，需使用专用工具如 <code>bpftool</code> 或 Hubble。</li>
</ul>
<h1 id="2-cilium部署">2. Cilium部署</h1>
<h2 id="2-1-部署">2.1. 部署</h2>
<p>部署文档可参考：</p>
<ul>
<li><a href="https://docs.cilium.io/en/stable/installation/k8s-install-helm/">https://docs.cilium.io/en/stable/installation/k8s-install-helm/</a></li>
<li><a href="https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/#k8s-install-quick">https://docs.cilium.io/en/stable/gettingstarted/k8s-install-default/#k8s-install-quick</a></li>
</ul>
<p>可以使用helm来部署</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add cilium https://helm.cilium.io/
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 部署cilium</span>
</span></span><span style="display:flex;"><span>kubectl create ns cilium-system <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>helm install cilium cilium/cilium --namespace cilium-system <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set ipam.mode<span style="color:#ce5c00;font-weight:bold">=</span>cluster-pool <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set ipam.operator.clusterPoolIPv4CIDR<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;10.244.0.0/16&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --set ipam.operator.clusterPoolIPv4MaskSize<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">24</span>
</span></span></code></pre></div><p>或者使用Cilium CLI 部署</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装cilium cli</span>
</span></span><span style="display:flex;"><span>curl -L --remote-name https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar xzvf cilium-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>sudo mv cilium /usr/local/bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 部署cilium套件</span>
</span></span><span style="display:flex;"><span>kubectl create ns cilium-system <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>cilium install --namespace<span style="color:#ce5c00;font-weight:bold">=</span>cilium-system <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>		--ipam<span style="color:#ce5c00;font-weight:bold">=</span>cluster-pool <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --cluster-pool-ipv4-cidr<span style="color:#ce5c00;font-weight:bold">=</span>10.244.0.0/16 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --cluster-pool-ipv4-mask-size<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">24</span>
</span></span></code></pre></div><h2 id="2-2-部署检查">2.2. 部署检查</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cilium status --wait
</span></span><span style="display:flex;"><span>   /¯¯<span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>/¯¯<span style="color:#4e9a06">\_</span>_/¯¯<span style="color:#4e9a06">\ </span>   Cilium:         OK
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">\_</span>_/¯¯<span style="color:#4e9a06">\_</span>_/    Operator:       OK
</span></span><span style="display:flex;"><span>/¯¯<span style="color:#4e9a06">\_</span>_/¯¯<span style="color:#4e9a06">\ </span>   Hubble:         disabled
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">\_</span>_/¯¯<span style="color:#4e9a06">\_</span>_/    ClusterMesh:    disabled
</span></span><span style="display:flex;"><span>   <span style="color:#4e9a06">\_</span>_/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DaemonSet         cilium             Desired: 2, Ready: 2/2, Available: 2/2
</span></span><span style="display:flex;"><span>Deployment        cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
</span></span><span style="display:flex;"><span>Containers:       cilium-operator    Running: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>                  cilium             Running: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>Image versions    cilium             quay.io/cilium/cilium:v1.9.5: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>                  cilium-operator    quay.io/cilium/operator-generic:v1.9.5: <span style="color:#0000cf;font-weight:bold">2</span>
</span></span></code></pre></div><p>网络连通性测试</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cilium connectivity <span style="color:#204a87">test</span>
</span></span><span style="display:flex;"><span>ℹ️  Monitor aggregation detected, will skip some flow validation steps
</span></span><span style="display:flex;"><span>✨ <span style="color:#ce5c00;font-weight:bold">[</span>k8s-cluster<span style="color:#ce5c00;font-weight:bold">]</span> Creating namespace <span style="color:#204a87;font-weight:bold">for</span> connectivity check...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>...<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>---------------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>📋 Test Report
</span></span><span style="display:flex;"><span>---------------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>✅ 69/69 tests successful <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> warnings<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-3-cilium-ipam-模式">2.3. Cilium IPAM 模式</h2>
<p>Cilium 支持以下两种常见的 IPAM 模式：</p>
<h3 id="2-3-1-cluster-pool-模式">2.3.1. Cluster-Pool 模式：</h3>
<ul>
<li>由 Cilium 自己管理 Pod IP 地址范围。</li>
<li>可以在部署时指定 CIDR 范围。</li>
<li><strong>高灵活性</strong>：支持为不同节点或区域定义独立的 IP 地址池。</li>
<li><strong>动态管理</strong>：可以动态调整 IP 地址池大小，适应集群的扩展需求。</li>
<li><strong>无冲突设计</strong>：避免因节点增加或删除引起的 IP 地址冲突。</li>
<li><strong>优化性能</strong>：减少对 Kubernetes 控制器的依赖，提高网络性能和资源利用率。</li>
<li><strong>依赖 Cilium Operator</strong>：需要运行 Cilium Operator 来管理 IP 地址池，增加运维复杂性。</li>
</ul>
<p><strong>推荐场景</strong></p>
<ul>
<li>大型集群（&gt; 500 节点）或超大规模集群。</li>
<li>需要跨区域或多节点池的复杂网络规划。</li>
<li>需要动态扩展 Pod IP 地址范围的集群。</li>
<li>集群运行 Cilium 并需要充分利用其高级功能（如 eBPF 加速、服务网格等）。</li>
</ul>
<h3 id="2-3-2-kubernetes-模式-默认模式">2.3.2. Kubernetes 模式（默认模式）：</h3>
<ul>
<li>使用 Kubernetes 自身的 IP 地址分配方式，例如由 <code>kube-controller-manager</code> 通过 <code>--cluster-cidr</code> 进行管理。</li>
<li>Cilium 从 Kubernetes 中获取分配给 Pod 的 IP 地址。</li>
<li><strong>兼容性强</strong>：适配大多数 CNI 插件（包括 Cilium），无需额外配置。</li>
<li><strong>灵活性有限</strong>：不支持细粒度的 IP 地址池管理，无法为特定节点或区域分配特定的 IP 范围。</li>
</ul>
<p><strong>推荐场景</strong></p>
<ul>
<li>小型或中型集群（&lt; 500 节点）。</li>
<li>网络规划较为简单，无需复杂的 IP 地址管理。</li>
<li>需要快速部署并保持与 Kubernetes 默认行为一致。</li>
</ul>
<h1 id="3-cilium架构及组件介绍">3. Cilium架构及组件介绍</h1>
<h2 id="3-1-架构图">3.1. 架构图</h2>
<p>参考官网： <a href="https://docs.cilium.io/en/stable/overview/component-overview/">https://docs.cilium.io/en/stable/overview/component-overview/</a></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1731811820/article/kubernetes/network/cilium/cilium-arch.webp" alt=""></p>
<h2 id="3-2-核心组件">3.2. 核心组件</h2>
<p><strong>1. Cilium Agent</strong></p>
<ul>
<li>运行在每个 Kubernetes 节点上，是 Cilium 的核心守护进程。</li>
<li>功能：
<ul>
<li>从 Kubernetes API Server 获取资源（如 Pod、Service 和网络策略）并转换为 eBPF 程序。</li>
<li>在每个节点上管理和加载 eBPF 程序到内核。</li>
<li>实现 L3/L4 和 L7 网络策略，并将策略下发到数据平面。</li>
<li>负责服务发现和负载均衡（取代 kube-proxy）。</li>
</ul>
</li>
</ul>
<p><strong>2. Cilium CLI</strong></p>
<ul>
<li>命令行工具，用于安装、配置和调试 Cilium。</li>
<li>功能：
<ul>
<li>配置 Cilium 的网络策略。</li>
<li>查看 Cilium 和 Hubble 的运行状态。</li>
<li>调试 eBPF 程序。</li>
</ul>
</li>
</ul>
<p><strong>3. CNI Plugin</strong></p>
<ul>
<li>当在节点上调度或终止pod时，Kubernetes会调用CNI插件（cilium-cni）。它与节点的Cilium API交互，触发必要的数据路径配置，为pod提供网络、负载平衡和网络策略。</li>
</ul>
<p><strong>4. Cilium Operator</strong></p>
<ul>
<li>在 Kubernetes 中运行的控制平面组件。</li>
<li>功能：
<ul>
<li>处理 IP 地址管理：管理 Pod 的 IP 池。</li>
<li>维护 Cilium Agent 与 Kubernetes 的集成。</li>
<li>处理节点间的拓扑变化（如节点加入或离开）。</li>
</ul>
</li>
</ul>
<h2 id="3-3-其他组件">3.3. 其他组件</h2>
<p><strong>1. eBPF 程序</strong></p>
<ul>
<li>Cilium 的数据平面核心，运行在 Linux 内核中。</li>
<li>功能：
<ul>
<li><strong>路由和转发</strong>：在节点间处理 Pod 的网络流量。</li>
<li><strong>网络策略</strong>：实现 L3/L4 和 L7 的访问控制。</li>
<li><strong>服务负载均衡</strong>：提供类似 kube-proxy 的服务转发功能，但性能更高。</li>
<li><strong>监控和可观测性</strong>：收集网络流量数据，供 Hubble 或其他工具分析。</li>
</ul>
</li>
</ul>
<p><strong>2. Hubble</strong></p>
<ul>
<li>Cilium 的可观测性平台，用于实时监控和分析网络流量。</li>
<li>功能：
<ul>
<li>流量可视化：展示服务间的流量路径和统计。</li>
<li>流量追踪：捕获和调试网络问题。</li>
<li>延迟和错误率监控。</li>
</ul>
</li>
</ul>
<h1 id="4-cilium-的工作流"><strong>4. Cilium 的工作流</strong></h1>
<ol>
<li><strong>初始化</strong>：
<ul>
<li>Cilium Agent 启动后，与 Kubernetes API Server 建立连接，监听资源变化。</li>
</ul>
</li>
<li><strong>策略配置</strong>：
<ul>
<li>用户定义的 <code>NetworkPolicy</code> 或 <code>CiliumNetworkPolicy</code> 通过 Cilium Agent 传递到 eBPF 程序。</li>
<li>eBPF 程序在内核中直接执行流量控制逻辑。</li>
</ul>
</li>
<li><strong>流量处理</strong>：
<ul>
<li>数据平面通过 eBPF 程序对网络流量进行路由、策略匹配和负载均衡。</li>
</ul>
</li>
<li><strong>监控和分析</strong>：
<ul>
<li>eBPF 程序收集流量数据，发送到 Hubble。</li>
<li>Hubble 将数据可视化，供用户监控和调试。</li>
</ul>
</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="https://docs.cilium.io/en/stable/">https://docs.cilium.io/en/stable/</a></li>
<li><a href="https://docs.cilium.io/en/stable/overview/component-overview/">https://docs.cilium.io/en/stable/overview/component-overview/</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e1622b1588cb7127df05e7691bb911bd">5.8 - k8s网关</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-181eada22ecde3bdfce4c31dff04e635">5.8.1 - 安装APISIX</h1>
    
	<blockquote>
<p>本文主要介绍通过k8s来部署apisix及apisix-ingress-controller，使用apisix作为k8s内Pod互相访问的网关。</p>
</blockquote>
<h2 id="1-环境准备">1.  环境准备</h2>
<h3 id="1-1-安装helm">1.1. 安装helm</h3>
<p>参考：<a href="https://helm.sh/zh/docs/intro/install/">Helm | 安装</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 <span style="color:#000;font-weight:bold">|</span> bash
</span></span></code></pre></div><p>helm添加仓库</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add apisix https://charts.apiseven.com
</span></span><span style="display:flex;"><span>helm repo update
</span></span></code></pre></div><h3 id="1-2-安装etcd">1.2. 安装ETCD</h3>
<p>可以提前准备好etcd环境，也可以使用apisix官方的helm命令安装，但是需要存在默认是storageclass来提供pv挂载。</p>
<h2 id="2-一键安装全部">2. 一键安装全部</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install apisix apisix/apisix --set gateway.type<span style="color:#ce5c00;font-weight:bold">=</span>NodePort --set ingress-controller.enabled<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --namespace<span style="color:#ce5c00;font-weight:bold">=</span>apisix --create-namespace
</span></span></code></pre></div><p>或通过以下方式分别安装各组件。</p>
<h2 id="3-安装apisix">3. 安装apisix</h2>
<p>参考：<a href="https://github.com/apache/apisix-helm-chart/blob/master/docs/en/latest/apisix.md">apisix-helm-chart/apisix.md at master · apache/apisix-helm-chart · GitHub</a></p>
<h3 id="3-1-安装">3.1. 安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install apisix apisix/apisix --namespace apisix --create-namespace  
</span></span></code></pre></div><p>卸载</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm uninstall apisix --namespace apisix
</span></span></code></pre></div><h3 id="3-2-修改配置">3.2. 修改配置</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl edit cm apisix-napisix
</span></span></code></pre></div><p>可选：</p>
<ul>
<li>
<p>修改apisix端口。</p>
</li>
<li>
<p>修改etcd地址。</p>
</li>
<li>
<p>修改admin key值。</p>
</li>
<li>
<p>修改日志路径。</p>
</li>
<li>
<p>使用etcd存储stream配置或者静态文件存储stream配置</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apisix:
</span></span><span style="display:flex;"><span>  node_listen: <span style="color:#0000cf;font-weight:bold">8000</span> <span style="color:#8f5902;font-style:italic"># APISIX listening port</span>
</span></span><span style="display:flex;"><span>  config_center: etcd     <span style="color:#8f5902;font-style:italic"># etcd: use etcd to store the config value</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#8f5902;font-style:italic"># yaml: fetch the config value from local yaml file `/your_path/conf/apisix.yaml`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>etcd:
</span></span><span style="display:flex;"><span>  host: <span style="color:#4e9a06">&#34;http://foo:2379&#34;</span> <span style="color:#8f5902;font-style:italic"># etcd address</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>admin_key
</span></span><span style="display:flex;"><span>  -
</span></span><span style="display:flex;"><span>    name: <span style="color:#4e9a06">&#34;admin&#34;</span>
</span></span><span style="display:flex;"><span>    key: newsupersecurekey  <span style="color:#8f5902;font-style:italic"># 请修改 key 的值</span>
</span></span><span style="display:flex;"><span>    role: admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nginx_config:
</span></span><span style="display:flex;"><span>  error_log: /var/log/apisix_error.log
</span></span><span style="display:flex;"><span>  http:
</span></span><span style="display:flex;"><span>    access_log: /var/log/apisix_access.log
</span></span><span style="display:flex;"><span>    access_log_format: <span style="color:#4e9a06">&#34;</span><span style="color:#000">$time_iso8601</span><span style="color:#4e9a06">|</span><span style="color:#000">$remote_addr</span><span style="color:#4e9a06"> - </span><span style="color:#000">$remote_user</span><span style="color:#4e9a06">|</span><span style="color:#000">$http_host</span><span style="color:#4e9a06">|\&#34;</span><span style="color:#000">$request</span><span style="color:#4e9a06">\&#34;|</span><span style="color:#000">$status</span><span style="color:#4e9a06">|</span><span style="color:#000">$body_bytes_sent</span><span style="color:#4e9a06">|</span><span style="color:#000">$request_time</span><span style="color:#4e9a06">|\&#34;</span><span style="color:#000">$http_referer</span><span style="color:#4e9a06">\&#34;|\&#34;</span><span style="color:#000">$http_user_agent</span><span style="color:#4e9a06">\&#34;|</span><span style="color:#000">$upstream_addr</span><span style="color:#4e9a06">|</span><span style="color:#000">$upstream_status</span><span style="color:#4e9a06">|</span><span style="color:#000">$upstream_response_time</span><span style="color:#4e9a06">|\&#34;</span><span style="color:#000">$upstream_scheme</span><span style="color:#4e9a06">://</span><span style="color:#000">$upstream_host$upstream_uri</span><span style="color:#4e9a06">\&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plugin_attr:
</span></span><span style="display:flex;"><span>  log-rotate:
</span></span><span style="display:flex;"><span>    interval: <span style="color:#0000cf;font-weight:bold">3600</span>    <span style="color:#8f5902;font-style:italic"># rotate interval (unit: second)</span>
</span></span><span style="display:flex;"><span>    max_kept: <span style="color:#0000cf;font-weight:bold">48</span>     <span style="color:#8f5902;font-style:italic"># max number of log files will be kept</span>
</span></span><span style="display:flex;"><span>    enable_compression: <span style="color:#204a87">false</span>
</span></span></code></pre></div><h2 id="4-安装apisix-ingress-controller">4. 安装apisix-ingress-controller</h2>
<p>参考：<a href="https://github.com/apache/apisix-helm-chart/blob/master/docs/en/latest/apisix-ingress-controller.md">apisix-helm-chart/apisix-ingress-controller.md at master · apache/apisix-helm-chart · GitHub</a></p>
<h3 id="4-1-安装">4.1. 安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install apisix-ingress-controller apisix/apisix-ingress-controller --namespace apisix --create-namespace
</span></span></code></pre></div><p>卸载</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm uninstall apisix-ingress-controller --namespace apisix
</span></span></code></pre></div><h3 id="4-2-修改配置">4.2. 修改配置</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl edit cm apisix-configmap -napisix
</span></span></code></pre></div><p>配置</p>
<ul>
<li>
<p>apisix地址</p>
</li>
<li>
<p>apisix admin key</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>default_cluster_base_url: http://apisix-admin.apisix.svc.cluster.local:9180/apisix/admin
</span></span><span style="display:flex;"><span>default_cluster_admin_key: <span style="color:#4e9a06">&#34;edd1c9f034335f136f87ad84b625c8f1&#34;</span>
</span></span></code></pre></div><h2 id="5-安装dashboard">5. 安装dashboard</h2>
<h3 id="5-1-安装">5.1. 安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add apisix https://charts.apiseven.com
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>helm install apisix-dashboard apisix/apisix-dashboard --namespace apisix --create-namespace 
</span></span></code></pre></div><p>卸载</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm uninstall apisix-dashboard --namespace apisix
</span></span></code></pre></div><h3 id="5-2-修改配置">5.2. 修改配置</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl edit cm apisix-dashboard -napisix
</span></span></code></pre></div><ul>
<li>
<p>端口</p>
</li>
<li>
<p>etcd地址</p>
</li>
<li>
<p>登录账号密码</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  conf.yaml: <span style="color:#000;font-weight:bold">|</span>-
</span></span><span style="display:flex;"><span>    conf:
</span></span><span style="display:flex;"><span>      listen:
</span></span><span style="display:flex;"><span>        host: 0.0.0.0
</span></span><span style="display:flex;"><span>        port: <span style="color:#0000cf;font-weight:bold">9000</span>
</span></span><span style="display:flex;"><span>      etcd:
</span></span><span style="display:flex;"><span>        prefix: <span style="color:#4e9a06">&#34;/apisix&#34;</span>
</span></span><span style="display:flex;"><span>        endpoints:
</span></span><span style="display:flex;"><span>          - 10.65.240.210:2379
</span></span><span style="display:flex;"><span>      log:
</span></span><span style="display:flex;"><span>        error_log:
</span></span><span style="display:flex;"><span>          level: warn
</span></span><span style="display:flex;"><span>          file_path: /dev/stderr
</span></span><span style="display:flex;"><span>        access_log:
</span></span><span style="display:flex;"><span>          file_path: /dev/stdout
</span></span><span style="display:flex;"><span>    authentication:
</span></span><span style="display:flex;"><span>      secert: secert
</span></span><span style="display:flex;"><span>      expire_time: <span style="color:#0000cf;font-weight:bold">3600</span>
</span></span><span style="display:flex;"><span>      users:
</span></span><span style="display:flex;"><span>        - username: admin
</span></span><span style="display:flex;"><span>          password: admin
</span></span></code></pre></div><h2 id="6-查看helm安装列表">6. 查看helm安装列表</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># helm list -n apisix</span>
</span></span><span style="display:flex;"><span>NAME                NAMESPACE    REVISION    UPDATED                                    STATUS      CHART                     APP VERSION
</span></span><span style="display:flex;"><span>apisix              apisix       <span style="color:#0000cf;font-weight:bold">1</span>           2022-08-23 16:19:47.678174579 +0800 +08    deployed    apisix-0.11.0             2.15.0
</span></span><span style="display:flex;"><span>apisix-dashboard    apisix       <span style="color:#0000cf;font-weight:bold">1</span>           2022-08-23 20:36:37.55042356 +0800 +08     deployed    apisix-dashboard-0.6.0    2.13.0
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/apache/apisix-helm-chart">https://github.com/apache/apisix-helm-chart</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/zh/docs/apisix/installation-guide/">https://apisix.apache.org/zh/docs/apisix/installation-guide/</a></p>
</li>
<li>
<p><a href="https://github.com/apache/apisix-ingress-controller/blob/master/install.md">https://github.com/apache/apisix-ingress-controller/blob/master/install.md</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-152c1f49b08d537c43d684c68bdb1e9b">5.8.2 - 创建路由</h1>
    
	<p>本文主要介绍三种方式来创建apisix的路由规则。需要提前创建好k8s service作为路由的后端标识来关联<code>endpoints</code>。</p>
<h2 id="0-创建k8s-service">0. 创建k8s service</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">APP}-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">NAMESPACE}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">k8s-app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">APP}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TCP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">targetPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9376</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>路由规则主要包括：</p>
<ul>
<li>
<p>hosts：域名</p>
</li>
<li>
<p>paths：访问路径</p>
</li>
<li>
<p>backends:</p>
<ul>
<li>
<p>serviceName</p>
</li>
<li>
<p>servicePort</p>
</li>
</ul>
</li>
</ul>
<h2 id="1-使用apisixroute创建路由规则">1. 使用ApisixRoute创建路由规则</h2>
<p>使用<code>ApisixRoute</code>自定义CRD创建路由规则，具体参考：<a href="https://github.com/apache/apisix-ingress-controller/blob/master/samples/deploy/crd/v1/ApisixRoute.yaml">reference</a>。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># httpbin-route.yaml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apisix.apache.org/v2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ApisixRoute</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">httpserver-route</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">http</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rule1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">match</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">local.httpbin.org</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">paths</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">/*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">backends</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#204a87;font-weight:bold">serviceName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">httpbin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">servicePort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在k8s中创建ApisixRoute。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f httpbin-route.yaml
</span></span></code></pre></div><h2 id="2-使用ingress创建路由规则">2. 使用ingress创建路由规则</h2>
<p>使用k8s ingress来创建路由规则，示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># httpbin-ingress.yaml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Note use apiVersion is networking.k8s.io/v1, so please make sure your</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Kubernetes cluster version is v1.19.0 or higher.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">networking.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Ingress</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">httpserver-ingress</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># apisix-ingress-controller is only interested in Ingress</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># resources with the matched ingressClass name, in our case,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># it&#39;s apisix.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ingressClassName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apisix</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">local.httpbin.org</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">http</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">paths</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">backend</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">service</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">httpbin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pathType</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Prefix</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建k8s ingress。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f httpbin-ingress.yaml
</span></span></code></pre></div><h2 id="3-使用admin-api创建路由规则">3. 使用Admin API创建路由规则</h2>
<p>直接调用Admin API或者使用dashboard创建路由规则。</p>
<h3 id="3-1-一键创建路由和upstream">3.1. 一键创建路由和upstream</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#4e9a06">&#34;http://127.0.0.1:9180/apisix/admin/routes/1&#34;</span> -H <span style="color:#4e9a06">&#34;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#34;</span> -X PUT -d <span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">{
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;methods&#34;: [&#34;GET&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;host&#34;: &#34;example.com&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;uri&#34;: &#34;/anything/*&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;upstream&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;type&#34;: &#34;roundrobin&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;nodes&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      &#34;httpbin.org:80&#34;: 1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    }
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  }
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">}&#39;</span>
</span></span></code></pre></div><h3 id="3-2-分开创建路由和upstream">3.2. 分开创建路由和upstream</h3>
<blockquote>
<p>推荐使用分开创建路由和upstream。</p>
</blockquote>
<p>创建upstream</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#4e9a06">&#34;http://127.0.0.1:9180/apisix/admin/upstreams/1&#34;</span> -H <span style="color:#4e9a06">&#34;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#34;</span> -X PUT -d <span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">{
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;type&#34;: &#34;roundrobin&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;nodes&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;httpbin.org:80&#34;: 1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  }
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">}&#39;</span>
</span></span></code></pre></div><p>创建路由绑定upstream</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#4e9a06">&#34;http://127.0.0.1:9180/apisix/admin/routes/1&#34;</span> -H <span style="color:#4e9a06">&#34;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&#34;</span> -X PUT -d <span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">{
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;uris&#34;: [&#34;/get&#34;,&#34;/list&#34;],
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;host&#34;: &#34;httpbin.org&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;upstream_id&#34;: &#34;1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">}&#39;</span>
</span></span></code></pre></div><p>删除upstream</p>
<p>DELETE /apisix/admin/upstreams/{id}</p>
<p>删除route</p>
<p>DELETE /apisix/admin/routes/{id}</p>
<h2 id="4-验证路由规则">4. 验证路由规则</h2>
<p>基于上述的方式，apisix-ingress-controller会调用apisix admin的接口自动创建<code>routes</code>和<code>upstreams</code>两个信息存入etcd，通过业务域名访问apisix就可以访问到具体的pod。</p>
<p><strong>服务调用</strong></p>
<p>将业务域名解析到apisix的IP上（如果是物理机部署可以是VIP，或者k8s部署的clusterIP）。</p>
<p>访问业务域名：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -v http://local.httpbin.org
</span></span></code></pre></div><h2 id="5-查看etcd中的路由规则">5. 查看etcd中的路由规则</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl get /apisix --prefix
</span></span></code></pre></div><h3 id="5-1-routes">5.1. routes</h3>
<p>/apisix/routes/</p>
<p>通过ingress创建的routes</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;host&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;local.httpbin.org&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;create_time&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1661251916</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ing_default_httpserver-ingress_37a4f3ae&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;uris&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;\/&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;\/*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;upstream_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;5ce57b8e&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;labels&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;managed-by&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;apisix-ingress-controller&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;priority&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;desc&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Created by apisix-ingress-controller, DO NOT modify it manually&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;update_time&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1661397119</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;148730bb&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过ApisixRoute创建的routes</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;priority&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;create_time&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1661397584</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;default_httpserver-route_rule1&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;uris&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;\/*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;upstream_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;5ce57b8e&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hosts&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;local.httpbin.org&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;labels&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;managed-by&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;apisix-ingress-controller&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;desc&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Created by apisix-ingress-controller, DO NOT modify it manually&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;update_time&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1661397584</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;add8e28c&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-2-upstreams">5.2. upstreams</h3>
<p>/apisix/upstreams/5ce57b8e</p>
<p>相同的backend，使用ingress或ApisixRoute创建后生成的<code>upstreams</code>相同。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;scheme&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;pass_host&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;pass&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;default_httpbin_80&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;nodes&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;host&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;10.244.3.167&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;priority&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">80</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;weight&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;roundrobin&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;labels&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;managed-by&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;apisix-ingress-controller&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hash_on&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;vars&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;create_time&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1661251916</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;5ce57b8e&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;update_time&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1661397584</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;desc&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Created by apisix-ingress-controller, DO NOT modify it manually&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://apisix.apache.org/zh/docs/ingress-controller/getting-started/">https://apisix.apache.org/zh/docs/ingress-controller/getting-started/</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/zh/docs/ingress-controller/tutorials/index/">https://apisix.apache.org/zh/docs/ingress-controller/tutorials/index/</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/zh/docs/ingress-controller/tutorials/proxy-the-httpbin-service/">https://apisix.apache.org/zh/docs/ingress-controller/tutorials/proxy-the-httpbin-service/</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/zh/docs/ingress-controller/tutorials/proxy-the-httpbin-service-with-ingress/">https://apisix.apache.org/zh/docs/ingress-controller/tutorials/proxy-the-httpbin-service-with-ingress/</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dcc4be6cc2df9826bdbfe0119d889b8f">5.8.3 - ingress-controller原理</h1>
    
	<h2 id="ingress-controller架构图">ingress-controller架构图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1661409689/article/kubernetes/network/apisix/scene.png" alt=""></p>
<h2 id="ingress-controller流程图">ingress-controller流程图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1661409688/article/kubernetes/network/apisix/flow.png" alt=""></p>
<h2 id="apisixroute同步逻辑">ApisixRoute同步逻辑</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1661409688/article/kubernetes/network/apisix/sync-logic-controller.png" alt=""></p>
<h2 id="数据结构转换">数据结构转换</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1661409896/article/kubernetes/network/apisix/struct-compare.png" alt=""></p>
<p>参考：</p>
<ul>
<li>
<p><a href="https://apisix.apache.org/zh/docs/ingress-controller/getting-started/">https://apisix.apache.org/zh/docs/ingress-controller/getting-started/</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/zh/docs/ingress-controller/design/">https://apisix.apache.org/zh/docs/ingress-controller/design/</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b54bad948da2580c7317a90981df893e">5.8.4 - APISIX配置</h1>
    
	<blockquote>
<p>本文主要记录apisix相关组件默认配置，便于查阅。</p>
</blockquote>
<h2 id="1-apisix配置">1. apisix配置</h2>
<p>参考：<a href="https://github.com/apache/apisix/blob/master/conf/config-default.yaml">apisix/config-default.yaml at master · apache/apisix · GitHub</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Licensed to the Apache Software Foundation (ASF) under one or more</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># contributor license agreements.  See the NOTICE file distributed with</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># this work for additional information regarding copyright ownership.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># The ASF licenses this file to You under the Apache License, Version 2.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># (the &#34;License&#34;); you may not use this file except in compliance with</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># the License.  You may obtain a copy of the License at</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     http://www.apache.org/licenses/LICENSE-2.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Unless required by applicable law or agreed to in writing, software</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># See the License for the specific language governing permissions and</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># limitations under the License.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># PLEASE DO NOT UPDATE THIS FILE!</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># If you want to set the specified configuration value, you can set the new</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># value in the conf/config.yaml file.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apisix</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># node_listen: 9080               # APISIX listening port</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">node_listen</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#8f5902;font-style:italic"># This style support multiple ports</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#0000cf;font-weight:bold">9080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#   - port: 9081</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#     enable_http2: true          # If not set, the default value is `false`.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#   - ip: 127.0.0.2               # Specific IP, If not set, the default value is `0.0.0.0`.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#     port: 9082</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#     enable_http2: true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_admin</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_admin_cors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># Admin API support CORS response headers.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_dev_mode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># Sets nginx worker_processes to 1 if set to true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_reuseport</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># Enable nginx SO_REUSEPORT switch if set to true.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">show_upstream_status_in_response_header</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># when true all upstream status write to `X-APISIX-Upstream-Status` otherwise only 5xx code</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_ipv6</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">config_center: etcd               # etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">use etcd to store the config value</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#8f5902;font-style:italic"># yaml: fetch the config value from local yaml file `/your_path/conf/apisix.yaml`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#proxy_protocol:                  # Proxy Protocol configuration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#listen_http_port: 9181           # The port with proxy protocol for http, it differs from node_listen and admin_listen.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#8f5902;font-style:italic"># This port can only receive http request with proxy protocol, but node_listen &amp; admin_listen</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#8f5902;font-style:italic"># can only receive http request. If you enable proxy protocol, you must use this port to</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#8f5902;font-style:italic"># receive http request with proxy protocol</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#listen_https_port: 9182          # The port with proxy protocol for https</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#enable_tcp_pp: true              # Enable the proxy protocol for tcp proxy, it works for stream_proxy.tcp option</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#enable_tcp_pp_to_upstream: true  # Enables the proxy protocol to the upstream server</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_server_tokens</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># Whether the APISIX version number should be shown in Server header.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#8f5902;font-style:italic"># It&#39;s enabled by default.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># configurations to load third party code and/or override the builtin one.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">extra_lua_path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># extend lua_package_path to load third party code</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">extra_lua_cpath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># extend lua_package_cpath to load third party code</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#lua_module_hook: &#34;my_project.my_hook&#34;  # the hook module which will be used to inject third party code into APISIX</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">proxy_cache</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#8f5902;font-style:italic"># Proxy Caching configuration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cache_ttl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10s                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># The default caching time in disk if the upstream does not specify the cache time</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">zones</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># The parameters of a cache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">disk_cache_one       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># The name of the cache, administrator can specify</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#8f5902;font-style:italic"># which cache to use by name in the admin api (disk|memory)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">50m           </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># The size of shared memory, it&#39;s used to store the cache index for</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#8f5902;font-style:italic"># disk strategy, store cache content for memory strategy (disk|memory)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">disk_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1G              </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># The size of disk, it&#39;s used to store the cache data (disk)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">disk_path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/tmp/disk_cache_one </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># The path to store the cache data (disk)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cache_levels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># The hierarchy levels of a cache (disk)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#- name: disk_cache_two</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#  memory_size: 50m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#  disk_size: 1G</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#  disk_path: &#34;/tmp/disk_cache_two&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#  cache_levels: &#34;1:2&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">memory_cache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">50m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">allow_admin</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># http://nginx.org/en/docs/http/ngx_http_access_module.html#allow</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#0000cf;font-weight:bold">127.0.0.0</span><span style="color:#000">/24             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># If we don&#39;t set any IP list, then any IP access is allowed by default.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#- &#34;::/64&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#admin_listen:                # use a separate port</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#  ip: 127.0.0.1              # Specific IP, if not set, the default value is `0.0.0.0`.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#  port: 9180</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#https_admin: true            # enable HTTPS when use a separate port for Admin API.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                </span><span style="color:#8f5902;font-style:italic"># Admin API will use conf/apisix_admin_api.crt and conf/apisix_admin_api.key as certificate.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">admin_api_mtls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># Depends on `admin_listen` and `https_admin`.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">admin_ssl_cert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># Path of your self-signed server side cert.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">admin_ssl_cert_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># Path of your self-signed server side key.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">admin_ssl_ca_cert</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># Path of your self-signed ca cert.The CA is used to sign all admin api callers&#39; certificates.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">admin_api_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v3       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># The version of admin api, latest version is v3.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Default token when use API to call for Admin API.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># *NOTE*: Highly recommended to modify this value to protect APISIX&#39;s Admin API.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Disabling this configuration item means that the Admin API does not</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># require any authentication.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">admin_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>-<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">edd1c9f034335f136f87ad84b625c8f1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">role: admin                 # admin</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">manage all configuration data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic"># viewer: only can view configuration data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>-<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">viewer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">4054f7cf07e344346cd3f287985e76a2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">viewer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">delete_uri_tail_slash</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># delete the &#39;/&#39; at the end of the URI</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># The URI normalization in servlet is a little different from the RFC&#39;s.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># See https://github.com/jakartaee/servlet/blob/master/spec/src/main/asciidoc/servlet-spec-body.adoc#352-uri-path-canonicalization,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># which is used under Tomcat.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Turn this option on if you want to be compatible with servlet when matching URI path.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">normalize_uri_like_servlet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">router</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">http: radixtree_uri         # radixtree_uri</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">match route by uri(base on radixtree)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic"># radixtree_host_uri: match route by host + uri(base on radixtree)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic"># radixtree_uri_with_parameter: like radixtree_uri but match uri with parameters,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic">#   see https://github.com/api7/lua-resty-radixtree/#parameters-in-path for</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic">#   more details.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ssl: radixtree_sni          # radixtree_sni</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">match route by SNI(base on radixtree)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#stream_proxy:                  # TCP/UDP proxy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#  only: true                   # use stream proxy only, don&#39;t enable HTTP stuff</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#  tcp:                         # TCP proxy port list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#    - addr: 9100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#      tls: true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#    - addr: &#34;127.0.0.1:9101&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#  udp:                         # UDP proxy port list</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#    - 9200</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#    - &#34;127.0.0.1:9201&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#dns_resolver:                  # If not set, read from `/etc/resolv.conf`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#  - 1.1.1.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#  - 8.8.8.8</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#dns_resolver_valid: 30         # if given, override the TTL of the valid records. The unit is second.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resolver_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># resolver timeout</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_resolv_search_opt</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># enable search option in resolv.conf</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ssl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">enable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">listen</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#8f5902;font-style:italic"># APISIX listening port in https.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9443</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">enable_http2</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#   - ip: 127.0.0.3           # Specific IP, If not set, the default value is `0.0.0.0`.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#     port: 9445</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#     enable_http2: true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#ssl_trusted_certificate: /path/to/ca-cert  # Specifies a file path with trusted CA certificates in the PEM format</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                </span><span style="color:#8f5902;font-style:italic"># used to verify the certificate when APISIX needs to do SSL/TLS handshaking</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                </span><span style="color:#8f5902;font-style:italic"># with external services (e.g. etcd)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ssl_protocols</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TLSv1.2 TLSv1.3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ssl_ciphers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ssl_session_tickets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic">#  disable ssl_session_tickets by default for &#39;ssl_session_tickets&#39; would make Perfect Forward Secrecy useless.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                            </span><span style="color:#8f5902;font-style:italic">#  ref: https://github.com/mozilla/server-side-tls/issues/135</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">key_encrypt_salt</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">edd1c9f0985e76a2     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#  If not set, will save origin ssl key into etcd.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                            </span><span style="color:#8f5902;font-style:italic">#  If set this, must be a string of length 16. And it will encrypt ssl key with AES-128-CBC</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                            </span><span style="color:#8f5902;font-style:italic">#  !!! So do not change it after saving your ssl, it can&#39;t decrypt the ssl keys have be saved if you change !!</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#fallback_sni: &#34;my.default.domain&#34;      # If set this, when the client doesn&#39;t send SNI during handshake, the fallback SNI will be used instead</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_control</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#control:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#  ip: 127.0.0.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#  port: 9090</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">disable_sync_configuration_during_start</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># safe exit. Remove this once the feature is stable</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">nginx_config</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># config for render the template to generate nginx.conf</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#user: root                     # specifies the execution user of the worker process.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic"># the &#34;user&#34; directive makes sense only if the master process runs with super-user privileges.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic"># if you&#39;re not root user,the default is current user.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">error_log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">logs/error.log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">error_log_level</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">warn         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># warn,error</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">worker_processes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">auto         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># if you want use multiple cores in container, you can inject the number of cpu as environment variable &#34;APISIX_WORKER_PROCESSES&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_cpu_affinity</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># enable cpu affinity, this is just work well only on physical machine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">worker_rlimit_nofile</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">20480</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># the number of files a worker process can open, should be larger than worker_connections</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">worker_shutdown_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">240s  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># timeout for a graceful shutdown of worker processes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">max_pending_timers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16384</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># increase it if you see &#34;too many pending timers&#34; error</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">max_running_timers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># increase it if you see &#34;lua_max_running_timers are not enough&#34; error</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">event</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">worker_connections</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10620</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#envs:                          # allow to get a list of environment variables</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#  - TEST_ENV</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">meta</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">lua_shared_dict</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">prometheus-metrics</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">15m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">stream</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">enable_access_log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># enable access log or not, default false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">access_log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">logs/access_stream.log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">access_log_format</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$remote_addr [$time_local] $protocol $status $bytes_sent $bytes_received $session_time&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                            </span><span style="color:#8f5902;font-style:italic"># create your custom log format by visiting http://nginx.org/en/docs/varindex.html</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">access_log_format_escape</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># allows setting json or default characters escaping in variables</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">lua_shared_dict</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">etcd-cluster-health-check-stream</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">lrucache-lock-stream</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">plugin-limit-conn-stream</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># As user can add arbitrary configurations in the snippet,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># it is user&#39;s responsibility to check the configurations</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># don&#39;t conflict with APISIX.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">main_configuration_snippet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # Add custom Nginx main configuration to nginx.conf.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # The configuration should be well indented!</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">http_configuration_snippet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # Add custom Nginx http configuration to nginx.conf.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # The configuration should be well indented!</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">http_server_configuration_snippet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # Add custom Nginx http server configuration to nginx.conf.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # The configuration should be well indented!</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">http_server_location_configuration_snippet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # Add custom Nginx http server location configuration to nginx.conf.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # The configuration should be well indented!</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">http_admin_configuration_snippet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # Add custom Nginx admin server configuration to nginx.conf.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # The configuration should be well indented!</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">http_end_configuration_snippet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # Add custom Nginx http end configuration to nginx.conf.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # The configuration should be well indented!</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">stream_configuration_snippet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # Add custom Nginx stream configuration to nginx.conf.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # The configuration should be well indented!</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">http</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">enable_access_log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># enable access log or not, default true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">access_log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">logs/access.log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">access_log_format</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$remote_addr - $remote_user [$time_local] $http_host \&#34;$request\&#34; $status $body_bytes_sent $request_time \&#34;$http_referer\&#34; \&#34;$http_user_agent\&#34; $upstream_addr $upstream_status $upstream_response_time \&#34;$upstream_scheme://$upstream_host$upstream_uri\&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">access_log_format_escape</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default      </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># allows setting json or default characters escaping in variables</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">keepalive_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">60s         </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># timeout during which a keep-alive client connection will stay open on the server side.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">client_header_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">60s     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># timeout for reading client request header, then 408 (Request Time-out) error is returned to the client</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">client_body_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">60s       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># timeout for reading client request body, then 408 (Request Time-out) error is returned to the client</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">client_max_body_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># The maximum allowed size of the client request body.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#8f5902;font-style:italic"># If exceeded, the 413 (Request Entity Too Large) error is returned to the client.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#8f5902;font-style:italic"># Note that unlike Nginx, we don&#39;t limit the body size by default.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">send_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10s             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># timeout for transmitting a response to the client.then the connection is closed</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">underscores_in_headers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;on&#34;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># default enables the use of underscores in client request header fields</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">real_ip_header</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">X-Real-IP     </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># http://nginx.org/en/docs/http/ngx_http_realip_module.html#real_ip_header</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">real_ip_recursive</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;off&#34;</span><span style="color:#f8f8f8;text-decoration:underline">       </span><span style="color:#8f5902;font-style:italic"># http://nginx.org/en/docs/http/ngx_http_realip_module.html#real_ip_recursive</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">real_ip_from</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># http://nginx.org/en/docs/http/ngx_http_realip_module.html#set_real_ip_from</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#0000cf;font-weight:bold">127.0.0.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#4e9a06">&#34;unix:&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#custom_lua_shared_dict:       # add custom shared cache to nginx.conf</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#  ipc_shared_dict: 100m       # custom shared cache, format: `cache-key: cache-size`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># Enables or disables passing of the server name through TLS Server Name Indication extension (SNI, RFC 6066)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># when establishing a connection with the proxied HTTPS server.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">proxy_ssl_server_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">upstream</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">keepalive</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">320</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># Sets the maximum number of idle keepalive connections to upstream servers that are preserved in the cache of each worker process.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#8f5902;font-style:italic"># When this number is exceeded, the least recently used connections are closed.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">keepalive_requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># Sets the maximum number of requests that can be served through one keepalive connection.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#8f5902;font-style:italic"># After the maximum number of requests is made, the connection is closed.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">keepalive_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">60s       </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Sets a timeout during which an idle keepalive connection to an upstream server will stay open.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">charset</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">utf-8                 </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Adds the specified charset to the &#34;Content-Type&#34; response header field, see</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                    </span><span style="color:#8f5902;font-style:italic"># http://nginx.org/en/docs/http/ngx_http_charset_module.html#charset</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">variables_hash_max_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2048</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># Sets the maximum size of the variables hash table.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">lua_shared_dict</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">internal-status</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">plugin-limit-req</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">plugin-limit-count</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">prometheus-metrics</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">plugin-limit-conn</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">upstream-healthcheck</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">worker-events</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">lrucache-lock</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">balancer-ewma</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">balancer-ewma-locks</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">balancer-ewma-last-touched-at</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">plugin-limit-count-redis-cluster-slot-lock</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">tracing_buffer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">plugin-api-breaker</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">etcd-cluster-health-check</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">discovery</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">jwks</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">introspection</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">access-tokens</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">ext-plugin</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">kubernetes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">tars</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                           </span><span style="color:#8f5902;font-style:italic"># it&#39;s possible to define multiple etcd hosts addresses of the same etcd cluster.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#4e9a06">&#34;http://127.0.0.1:2379&#34;</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># multiple etcd address, if your etcd cluster enables TLS, please use https scheme,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic"># e.g. https://127.0.0.1:2379.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">prefix</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/apisix                </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># apisix configurations prefix</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#timeout: 30                    # 30 seconds</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#resync_delay: 5                # when sync failed and a rest is needed, resync after the configured seconds plus 50% random jitter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#health_check_timeout: 10       # etcd retry the unhealthy nodes after the configured seconds</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">startup_retry</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># the number of retry to etcd during the startup, default to 2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#user: root                     # root username for etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#password: 5tHkHhYkjr6cQY       # root password for etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">tls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># To enable etcd client certificate you need to build APISIX-Base, see</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># https://apisix.apache.org/docs/apisix/FAQ#how-do-i-build-the-apisix-base-environment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#cert: /path/to/cert          # path of certificate used by the etcd client</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#key: /path/to/key            # path of key used by the etcd client</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verify</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#8f5902;font-style:italic"># whether to verify the etcd endpoint certificate when setup a TLS connection to etcd,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic"># the default value is true, e.g. the certificate will be verified strictly.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#sni:                         # the SNI for etcd TLS requests. If missed, the host part of the URL will be used.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># HashiCorp Vault storage backend for sensitive data retrieval. The config shows an example of what APISIX expects if you</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># wish to integrate Vault for secret (sensetive string, public private keys etc.) retrieval. APISIX communicates with Vault</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># server HTTP APIs. By default, APISIX doesn&#39;t need this configuration.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># vault:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   host: &#34;http://0.0.0.0:8200&#34;   # The host address where the vault server is running.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   timeout: 10                   # request timeout 30 seconds</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   token: root                   # Authentication token to access Vault HTTP APIs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#   prefix: kv/apisix             # APISIX supports vault kv engine v1, where sensitive data are being stored</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic"># and retrieved through vault HTTP APIs. enabling a prefix allows you to better enforcement of</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic"># policies, generate limited scoped tokens and tightly control the data that can be accessed</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                  </span><span style="color:#8f5902;font-style:italic"># from APISIX.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#discovery:                       # service discovery center</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#  dns:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    servers:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      - &#34;127.0.0.1:8600&#34;         # use the real address of your dns server</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#  eureka:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    host:                        # it&#39;s possible to define multiple eureka hosts addresses of the same eureka cluster.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      - &#34;http://127.0.0.1:8761&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    prefix: /eureka/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    fetch_interval: 30           # default 30s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    weight: 100                  # default weight for node</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    timeout:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      connect: 2000              # default 2000ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      send: 2000                 # default 2000ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      read: 5000                 # default 5000ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#  nacos:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    host:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      - &#34;http://${username}:${password}@${host1}:${port1}&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    prefix: &#34;/nacos/v1/&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    fetch_interval: 30    # default 30 sec</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    weight: 100           # default 100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    timeout:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      connect: 2000       # default 2000 ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      send: 2000          # default 2000 ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      read: 5000          # default 5000 ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#  consul_kv:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    servers:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      - &#34;http://127.0.0.1:8500&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      - &#34;http://127.0.0.1:8600&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    prefix: &#34;upstreams&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    skip_keys:                    # if you need to skip special keys</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      - &#34;upstreams/unused_api/&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    timeout:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      connect: 2000               # default 2000 ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      read: 2000                  # default 2000 ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      wait: 60                    # default 60 sec</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    weight: 1                     # default 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    fetch_interval: 3             # default 3 sec, only take effect for keepalive: false way</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    keepalive: true               # default true, use the long pull way to query consul servers</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    default_server:               # you can define default server when missing hit</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      host: &#34;127.0.0.1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      port: 20999</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      metadata:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#        fail_timeout: 1           # default 1 ms</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#        weight: 1                 # default 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#        max_fails: 1              # default 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    dump:                         # if you need, when registered nodes updated can dump into file</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#       path: &#34;logs/consul_kv.dump&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#       expire: 2592000            # unit sec, here is 30 day</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#  kubernetes:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    service:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      schema: https                     #apiserver schema, options [http, https], default https</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      host: ${KUBERNETES_SERVICE_HOST}  #apiserver host, options [ipv4, ipv6, domain, environment variable], default ${KUBERNETES_SERVICE_HOST}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      port: ${KUBERNETES_SERVICE_PORT}  #apiserver port, options [port number, environment variable], default ${KUBERNETES_SERVICE_PORT}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    client:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      # serviceaccount token or path of serviceaccount token_file</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      token_file: ${KUBERNETES_CLIENT_TOKEN_FILE}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      # token: |-</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#       # eyJhbGciOiJSUzI1NiIsImtpZCI6Ikx5ME1DNWdnbmhQNkZCNlZYMXBsT3pYU3BBS2swYzBPSkN3ZnBESGpkUEEif</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#       # 6Ikx5ME1DNWdnbmhQNkZCNlZYMXBsT3pYU3BBS2swYzBPSkN3ZnBESGpkUEEifeyJhbGciOiJSUzI1NiIsImtpZCI</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    # kubernetes discovery plugin support use namespace_selector</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    # you can use one of [equal, not_equal, match, not_match] filter namespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    namespace_selector:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      # only save endpoints with namespace equal default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      equal: default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      # only save endpoints with namespace not equal default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      #not_equal: default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      # only save endpoints with namespace match one of [default, ^my-[a-z]+$]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      #match:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      #- default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      #- ^my-[a-z]+$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      # only save endpoints with namespace not match one of [default, ^my-[a-z]+$ ]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      #not_match:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      #- default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      #- ^my-[a-z]+$</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    # kubernetes discovery plugin support use label_selector</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    # for the expression of label_selector, please refer to https://kubernetes.io/docs/concepts/overview/working-with-objects/labels</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    label_selector: |-</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#      first=&#34;a&#34;,second=&#34;b&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">graphql</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">max_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1048576</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># the maximum size limitation of graphql in bytes, default 1MiB</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#ext-plugin:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#cmd: [&#34;ls&#34;, &#34;-l&#34;]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">plugins</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># plugin list (sorted by priority)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">real-ip                        # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">23000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">client-control                 # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">22000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">proxy-control                  # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">21990</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">request-id                     # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">12015</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">zipkin                         # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">12011</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#- skywalking                    # priority: 12010</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#- opentelemetry                 # priority: 12009</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">ext-plugin-pre-req             # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">12000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">fault-injection                # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">11000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">mocking                        # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10900</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">serverless-pre-function        # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#- batch-requests                # priority: 4010</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">cors                           # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">ip-restriction                 # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">ua-restriction                 # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2999</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">referer-restriction            # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2990</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">csrf                           # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2980</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">uri-blocker                    # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2900</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">request-validation             # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2800</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">openid-connect                 # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2599</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">authz-casbin                   # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2560</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">authz-casdoor                  # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2559</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">wolf-rbac                      # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2555</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">ldap-auth                      # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2540</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">hmac-auth                      # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2530</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">basic-auth                     # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2520</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">jwt-auth                       # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2510</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">key-auth                       # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2500</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">consumer-restriction           # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2400</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">forward-auth                   # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2002</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">opa                            # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2001</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">authz-keycloak                 # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#- error-log-logger              # priority: 1091</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">proxy-mirror                   # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1010</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">proxy-cache                    # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1009</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">proxy-rewrite                  # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1008</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">workflow                       # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1006</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">api-breaker                    # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1005</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">limit-conn                     # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1003</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">limit-count                    # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1002</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">limit-req                      # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1001</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#- node-status                   # priority: 1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">gzip                           # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">995</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">server-info                    # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">990</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">traffic-split                  # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">966</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">redirect                       # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">900</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">response-rewrite               # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">899</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">kafka-proxy                    # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">508</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#- dubbo-proxy                   # priority: 507</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">grpc-transcode                 # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">506</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">grpc-web                       # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">505</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">public-api                     # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">501</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">prometheus                     # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">500</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">datadog                        # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">495</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">echo                           # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">412</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">loggly                         # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">411</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">http-logger                    # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">410</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">splunk-hec-logging             # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">409</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">skywalking-logger              # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">408</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">google-cloud-logging           # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">407</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">sls-logger                     # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">406</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">tcp-logger                     # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">405</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">kafka-logger                   # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">403</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">rocketmq-logger                # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">402</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">syslog                         # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">401</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">udp-logger                     # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">file-logger                    # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">399</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">clickhouse-logger              # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">398</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">tencent-cloud-cls              # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">397</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#- log-rotate                    # priority: 100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># &lt;- recommend to use priority (0, 100) for your custom plugins</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">example-plugin                 # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">aws-lambda                     # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1899</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">azure-functions                # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1900</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">openwhisk                      # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1901</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">serverless-post-function       # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">ext-plugin-post-req            # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">ext-plugin-post-resp           # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">4000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">stream_plugins</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># sorted by priority</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">ip-restriction                 # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">limit-conn                     # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1003</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">mqtt-proxy                     # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#- prometheus                    # priority: 500</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">syslog                         # priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">401</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># &lt;- recommend to use priority (0, 100) for your custom plugins</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#wasm:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#plugins:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#- name: wasm_log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#priority: 7999</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#file: t/wasm/log/main.go.wasm</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#xrpc:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#protocols:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#- name: pingpong</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">plugin_attr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">log-rotate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">interval: 3600    # rotate interval (unit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">second)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max_kept</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">168</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># max number of log files will be kept</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">max_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>-<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># max size bytes of log files to be rotated, size check would be skipped with a value less than 0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">enable_compression</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># enable log file compression(gzip) or not, default false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">skywalking</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">service_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">APISIX</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">service_instance_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">APISIX Instance Name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">endpoint_addr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http://127.0.0.1:12800</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">opentelemetry</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">trace_id_source</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">x-request-id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resource</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">service.name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">APISIX</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">collector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">address</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">127.0.0.1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">4318</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">request_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">request_headers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">Authorization</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">token</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">batch_span_processor</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">drop_on_queue_full</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">max_queue_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">batch_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">inactive_timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">max_export_batch_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">prometheus</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">export_uri</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/apisix/prometheus/metrics</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metric_prefix</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apisix_</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">enable_export_server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">export_addr</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">127.0.0.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9091</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#metrics:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#  http_status:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#    # extra labels from nginx variables</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#    extra_labels:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#      # the label name doesn&#39;t need to be the same as variable name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#      # below labels are only examples, you could add any valid variables as you need</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#      - upstream_addr: $upstream_addr</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#      - upstream_status: $upstream_status</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#  http_latency:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#    extra_labels:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#      - upstream_addr: $upstream_addr</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#  bandwidth:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#    extra_labels:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic">#      - upstream_addr: $upstream_addr</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">server-info</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">report_ttl: 60   # live time for server info in etcd (unit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">second)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dubbo-proxy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">upstream_multiplex_count</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">request-id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">snowflake</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">enable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">snowflake_epoc</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1609459200000</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># the starting timestamp is expressed in milliseconds</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">data_machine_bits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">12</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># data machine bit, maximum 31, because Lua cannot do bit operations greater than 31</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">sequence_bits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">               </span><span style="color:#8f5902;font-style:italic"># each machine generates a maximum of (1 &lt;&lt; sequence_bits) serial numbers per millisecond</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">data_machine_ttl: 30            # live time for data_machine in etcd (unit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">second)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">data_machine_interval: 10       # lease renewal interval in etcd (unit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">second)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">proxy-mirror</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">timeout</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># proxy timeout in mirrored sub-request</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">connect</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">60s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">read</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">60s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">send</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">60s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#  redirect:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    https_port: 8443   # the default port for use by HTTP redirects to HTTPS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#deployment:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    role: traditional</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    role_traditional:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#        config_provider: etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#    etcd:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#        host:                           # it&#39;s possible to define multiple etcd hosts addresses of the same etcd cluster.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#          - &#34;http://127.0.0.1:2379&#34;     # multiple etcd address, if your etcd cluster enables TLS, please use https scheme,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#                                        # e.g. https://127.0.0.1:2379.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#        prefix: /apisix                 # configuration prefix in etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#        timeout: 30                     # 30 seconds</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-apisix-ingress-controller">2. apisix-ingress-controller</h2>
<p>参考：<a href="https://github.com/apache/apisix-ingress-controller/blob/master/conf/config-default.yaml">apisix-ingress-controller/config-default.yaml at master · apache/apisix-ingress-controller · GitHub</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Licensed to the Apache Software Foundation (ASF) under one or more</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># contributor license agreements.  See the NOTICE file distributed with</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># this work for additional information regarding copyright ownership.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># The ASF licenses this file to You under the Apache License, Version 2.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># (the &#34;License&#34;); you may not use this file except in compliance with</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># the License.  You may obtain a copy of the License at</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     http://www.apache.org/licenses/LICENSE-2.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Unless required by applicable law or agreed to in writing, software</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># See the License for the specific language governing permissions and</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># limitations under the License.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># log options</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">log_level</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;info&#34;</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># the error log level, default is info, optional values are:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># debug</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># info</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># warn</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># error</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># panic</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># fatal</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">log_output</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;stderr&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># the output file path of error log, default is stderr, when</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># the file path is &#34;stderr&#34; or &#34;stdout&#34;, logs are marshalled</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># plainly, which is more readable for human; otherwise logs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># are marshalled in JSON format, which can be parsed by</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#8f5902;font-style:italic"># programs easily.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">log_rotate_output_path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># rotate output path, the logs will be written in this file</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">log_rotation_max_size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># rotate max size, max size in megabytes of log file before it get rotated. It defaults to 100</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">log_rotation_max_age</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># rotate max age, max age of old log files to retain</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">log_rotation_max_backups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># rotate max backups, max numbers of old log files to retain</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">cert_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/etc/webhook/certs/cert.pem&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># the TLS certificate file path.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">key_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/etc/webhook/certs/key.pem&#34;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># the TLS key file path.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">http_listen</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;:8080&#34;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># the HTTP Server listen address, default is &#34;:8080&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">https_listen</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;:8443&#34;</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># the HTTPS Server listen address, default is &#34;:8443&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ingress_publish_service</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># the controller will use the Endpoint of this Service to</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># update the status information of the Ingress resource.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># The format is &#34;namespace/svc-name&#34; to solve the situation that</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># the data plane and the controller are not deployed in the same namespace.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">ingress_status_address</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[]</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># when there is no available information on the Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># used for publishing on the data plane,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># the static address provided here will be</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># used to update the status information of Ingress.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># When ingress-publish-service is specified at the same time, ingress-status-address is preferred.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                             </span><span style="color:#8f5902;font-style:italic"># For example, no available LB exists in the bare metal environment.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">enable_profiling</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># enable profiling via web interfaces</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#8f5902;font-style:italic"># host:port/debug/pprof, default is true.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apisix-resource-sync-interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;300s&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># Default interval for synchronizing Kubernetes resources to APISIX</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Kubernetes related configurations.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kubernetes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kubeconfig</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                       </span><span style="color:#8f5902;font-style:italic"># the Kubernetes configuration file path, default is</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># &#34;&#34;, so the in-cluster configuration will be used.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resync_interval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;6h&#34;</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># how long should apisix-ingress-controller</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># re-synchronizes with Kubernetes, default is 6h,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># and the minimal resync interval is 30s.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">app_namespaces</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># namespace list that controller will watch for resources,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># by default all namespaces (represented by &#34;*&#34;) are watched.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># The `app_namespace` is deprecated, using `namespace_selector` instead since version 1.4.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace_selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># namespace_selector represent basis for selecting managed namespaces.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># the field is support since version 1.4.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># For example, &#34;apisix.ingress=watching&#34;, so ingress will watching the namespaces which labels &#34;apisix.ingress=watching&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">election_id</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ingress-apisix-leader&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># the election id for the controller leader campaign,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># only the leader will watch and delivery resource changes,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># other instances (as candidates) stand by.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ingress_class</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;apisix&#34;</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#8f5902;font-style:italic"># the class of an Ingress object is set using the field</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># IngressClassName in Kubernetes clusters version v1.18.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># or higher or the annotation &#34;kubernetes.io/ingress.class&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># (deprecated).</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ingress_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;networking/v1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># the supported ingress api group version, can be &#34;networking/v1beta1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># , &#34;networking/v1&#34; (for Kubernetes version v1.19.0 or higher), and</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># &#34;extensions/v1beta1&#34;, default is &#34;networking/v1&#34;.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">watch_endpointslices</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># whether to watch EndpointSlices rather than Endpoints.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apisix_route_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;apisix.apache.org/v2&#34;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># the supported apisixroute api group version.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                     </span><span style="color:#8f5902;font-style:italic"># the latest version is &#34;apisix.apache.org/v2&#34;.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enable_gateway_api</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># whether to enable support for Gateway API.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># Note: This feature is currently under development and may not work as expected. </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># It is not recommended to use it in a production environment.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#8f5902;font-style:italic"># Before we announce support for it to reach Beta level or GA.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">api_version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apisix.apache.org/v2   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># the default value of API version is &#34;apisix.apache.org/v2&#34;, support &#34;apisix.apache.org/v2beta3&#34; and &#34;apisix.apache.org/v2&#34;.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># APISIX related configurations.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apisix</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">default_cluster_base_url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;http://127.0.0.1:9080/apisix/admin&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># The base url of admin api / manager api</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                                                 </span><span style="color:#8f5902;font-style:italic"># of the default APISIX cluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">default_cluster_admin_key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># the admin key used for the authentication of admin api / manager api in the</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                                </span><span style="color:#8f5902;font-style:italic"># default APISIX cluster, by default this field is unset.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">default_cluster_name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># name of the default APISIX cluster.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-apisix-dashboard">3. apisix-dashboard</h2>
<p>参考：<a href="https://github.com/apache/apisix-dashboard/blob/master/api/conf/conf.yaml">apisix-dashboard/conf.yaml at master · apache/apisix-dashboard · GitHub</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Licensed to the Apache Software Foundation (ASF) under one or more</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># contributor license agreements.  See the NOTICE file distributed with</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># this work for additional information regarding copyright ownership.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># The ASF licenses this file to You under the Apache License, Version 2.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># (the &#34;License&#34;); you may not use this file except in compliance with</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># the License.  You may obtain a copy of the License at</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     http://www.apache.org/licenses/LICENSE-2.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Unless required by applicable law or agreed to in writing, software</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># See the License for the specific language governing permissions and</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># limitations under the License.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># yamllint disable rule:comments-indentation</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">conf</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">listen</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># host: 127.0.0.1     # the address on which the `Manager API` should listen.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># The default value is 0.0.0.0, if want to specify, please enable it.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># This value accepts IPv4, IPv6, and hostname.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9000</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># The port on which the `Manager API` should listen.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># ssl:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#   host: 127.0.0.1     # the address on which the `Manager API` should listen for HTTPS.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># The default value is 0.0.0.0, if want to specify, please enable it.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#   port: 9001            # The port on which the `Manager API` should listen for HTTPS.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#   cert: &#34;/tmp/cert/example.crt&#34; # Path of your SSL cert.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#   key:  &#34;/tmp/cert/example.key&#34;  # Path of your SSL key.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">allow_list</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#8f5902;font-style:italic"># If we don&#39;t set any IP list, then any IP access is allowed by default.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#0000cf;font-weight:bold">127.0.0.1</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># The rules are checked in sequence until the first match is found.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000;font-weight:bold">::</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#8f5902;font-style:italic"># In this example, access is allowed only for IPv4 network 127.0.0.1, and for IPv6 network ::1.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># It also support CIDR like 192.168.1.0/24 and 2001:0db8::/32</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">etcd</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">endpoints</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#8f5902;font-style:italic"># supports defining multiple etcd host addresses for an etcd cluster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#0000cf;font-weight:bold">127.0.0.1</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">2379</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># yamllint disable rule:comments-indentation</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># etcd basic auth info</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># username: &#34;root&#34;    # ignore etcd username if not enable etcd auth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># password: &#34;123456&#34;  # ignore etcd password if not enable etcd auth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">mtls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">key_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#8f5902;font-style:italic"># Path of your self-signed client side key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">cert_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#8f5902;font-style:italic"># Path of your self-signed client side cert</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">ca_file</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#8f5902;font-style:italic"># Path of your self-signed ca cert, the CA is used to sign callers&#39; certificates</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># prefix: /apisix       # apisix config&#39;s prefix in etcd, /apisix by default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">error_log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">level: warn       # supports levels, lower to higher</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">debug, info, warn, error, panic, fatal</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">file_path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">logs/error.log </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># supports relative path, absolute path, standard output</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#8f5902;font-style:italic"># such as: logs/error.log, /tmp/logs/error.log, /dev/stdout, /dev/stderr</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#8f5902;font-style:italic"># such as absolute path on Windows: winfile:///C:\error.log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">access_log</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">file_path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">logs/access.log </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># supports relative path, absolute path, standard output</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># such as: logs/access.log, /tmp/logs/access.log, /dev/stdout, /dev/stderr</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># such as absolute path on Windows: winfile:///C:\access.log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                         </span><span style="color:#8f5902;font-style:italic"># log example: 2020-12-09T16:38:09.039+0800    INFO    filter/logging.go:46    /apisix/admin/routes/r1    {&#34;status&#34;: 401, &#34;host&#34;: &#34;127.0.0.1:9000&#34;, &#34;query&#34;: &#34;asdfsafd=adf&amp;a=a&#34;, &#34;requestId&#34;: &#34;3d50ecb8-758c-46d1-af5b-cd9d1c820156&#34;, &#34;latency&#34;: 0, &#34;remoteIP&#34;: &#34;127.0.0.1&#34;, &#34;method&#34;: &#34;PUT&#34;, &#34;errs&#34;: []}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">max_cpu: 0             # supports tweaking with the number of OS threads are going to be used for parallelism. Default value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">will use max number of available cpu cores considering hyperthreading (if any)]. If the value is negative, is will not touch the existing parallelism profile.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># security:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#   access_control_allow_origin: &#34;http://httpbin.org&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#   access_control_allow_credentials: true          # support using custom cors configration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#   access_control_allow_headers: &#34;Authorization&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#   access_control-allow_methods: &#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#   x_frame_options: &#34;deny&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">#   content_security_policy: &#34;default-src &#39;self&#39;; script-src &#39;self&#39; &#39;unsafe-eval&#39; &#39;unsafe-inline&#39;; style-src &#39;self&#39; &#39;unsafe-inline&#39;; frame-src xx.xx.xx.xx:3000&#34;  # You can set frame-src to provide content for your grafana panel.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">authentication</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">secret</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">secret             </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># secret for jwt token generation.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#8f5902;font-style:italic"># NOTE: Highly recommended to modify this value to protect `manager api`.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                        </span><span style="color:#8f5902;font-style:italic"># if it&#39;s default value, when `manager api` start, it will generate a random string to replace it.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">expire_time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3600</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#8f5902;font-style:italic"># jwt token expire time, in second</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#8f5902;font-style:italic"># yamllint enable rule:comments-indentation</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># username and password for login `manager api`</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">plugins</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">                          </span><span style="color:#8f5902;font-style:italic"># plugin list (sorted in alphabetical order)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">api-breaker</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">authz-keycloak</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">basic-auth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">batch-requests</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">consumer-restriction</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">cors</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># - dubbo-proxy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">echo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># - error-log-logger</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># - example-plugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">fault-injection</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">grpc-transcode</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">hmac-auth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">http-logger</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">ip-restriction</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">jwt-auth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">kafka-logger</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">key-auth</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">limit-conn</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">limit-count</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">limit-req</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># - log-rotate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># - node-status</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">openid-connect</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">prometheus</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">proxy-cache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">proxy-mirror</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">proxy-rewrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">redirect</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">referer-restriction</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">request-id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">request-validation</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">response-rewrite</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">serverless-post-function</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">serverless-pre-function</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># - skywalking</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">sls-logger</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">syslog</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">tcp-logger</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">udp-logger</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">uri-blocker</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">wolf-rbac</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">zipkin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">server-info</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">traffic-split</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div>
</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-68204f31aa6371f04c5528350bbd9dbc">6 - 容器存储</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-acce2f199395a38fa545d621e87d4fcc">6.1 - 存储卷概念</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-69916651c080b1448214bcc3834b3bed">6.1.1 - Volume介绍</h1>
    
	<h1 id="1-volume概述">1. volume概述</h1>
<ul>
<li>容器上的文件生命周期同容器的生命周期一致，即容器挂掉之后，容器将会以最初镜像中的文件系统内容启动，之前容器运行时产生的文件将会丢失。</li>
<li>Pod的volume的生命周期同Pod的生命周期一致，当Pod被删除的时候，对应的volume才会被删除。即Pod中的容器重启时，之前的文件仍可以保存。</li>
</ul>
<p>容器中的进程看到的是由其 <code>Docker 镜像和卷</code>组成的文件系统视图。</p>
<p><strong>Pod volume的使用方式</strong></p>
<p>Pod 中的每个容器都必须独立指定每个卷的挂载位置，需要给Pod配置volume相关参数。</p>
<p>Pod的volume关键字段如下：</p>
<ul>
<li>spec.volumes：提供怎样的数据卷</li>
<li>spec.containers.volumeMounts：挂载到容器的什么路径</li>
</ul>
<h1 id="2-volume类型">2. volume类型</h1>
<h2 id="2-1-emptydir">2.1. emptyDir</h2>
<p><strong>1、特点</strong></p>
<ul>
<li>会创建<code>emptyDir</code>对应的目录，默认为空（如果该目录原来有文件也会被重置为空）</li>
<li>Pod中的不同容器可以在目录中读写相同文件（即Pod中的不同容器可以通过该方式来共享文件）</li>
<li>当Pod被删除，<code>emptyDir</code> 中的数据将被永久删除，如果只是Pod挂掉该数据还会保留</li>
</ul>
<p><strong>2、使用场景</strong></p>
<ul>
<li>
<p>不同容器之间共享文件（例如日志采集等）</p>
</li>
<li>
<p>暂存空间，例如用于基于磁盘的合并排序</p>
</li>
<li>
<p>用作长时间计算崩溃恢复时的检查点</p>
<p><strong>3、示例</strong></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test-pd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s.gcr.io/test-webserver</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test-container</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/cache</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cache-volume</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cache-volume</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">emptyDir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-2-hostpath">2.2. hostPath</h2>
<p><strong>1、特点</strong></p>
<ul>
<li>会将宿主机的目录或文件挂载到Pod中</li>
</ul>
<p><strong>2、使用场景</strong></p>
<ul>
<li>
<p>运行需要访问 Docker 内部的容器；使用 <code>/var/lib/docker</code> 的 <code>hostPath</code></p>
</li>
<li>
<p>在容器中运行 cAdvisor；使用 <code>/dev/cgroups</code> 的 <code>hostPath</code></p>
</li>
<li>
<p>其他使用到宿主机文件的场景</p>
</li>
</ul>
<p><strong><code>hostPath</code>的<code>type</code>字段</strong></p>
<table>
<thead>
<tr>
<th>值</th>
<th>行为</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>空字符串（默认）用于向后兼容，这意味着在挂载 hostPath 卷之前不会执行任何检查。</td>
</tr>
<tr>
<td><code>DirectoryOrCreate</code></td>
<td>如果在给定的路径上没有任何东西存在，那么将根据需要在那里创建一个空目录，权限设置为 0755，与 Kubelet 具有相同的组和所有权。</td>
</tr>
<tr>
<td><code>Directory</code></td>
<td>给定的路径下必须存在目录</td>
</tr>
<tr>
<td><code>FileOrCreate</code></td>
<td>如果在给定的路径上没有任何东西存在，那么会根据需要创建一个空文件，权限设置为 0644，与 Kubelet 具有相同的组和所有权。</td>
</tr>
<tr>
<td><code>File</code></td>
<td>给定的路径下必须存在文件</td>
</tr>
<tr>
<td><code>Socket</code></td>
<td>给定的路径下必须存在 UNIX 套接字</td>
</tr>
<tr>
<td><code>CharDevice</code></td>
<td>给定的路径下必须存在字符设备</td>
</tr>
<tr>
<td><code>BlockDevice</code></td>
<td>给定的路径下必须存在块设备</td>
</tr>
</tbody>
</table>
<p><strong>注意事项</strong></p>
<ul>
<li>由于每个节点上的文件都不同，具有相同配置的 pod 在不同节点上的行为可能会有所不同</li>
<li>当 Kubernetes 按照计划添加资源感知调度时，将无法考虑 <code>hostPath</code> 使用的资源</li>
<li>在底层主机上创建的文件或目录只能由 root 写入。您需要在<a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/">特权容器</a>中以 root 身份运行进程，或修改主机上的文件权限以便写入 <code>hostPath</code> 卷</li>
</ul>
<p><strong>3、示例</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test-pd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">k8s.gcr.io/test-webserver</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test-container</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/test-pd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test-volume</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test-volume</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># directory location on host</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># this field is optional</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Directory</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="2-2-1-同步文件变化到容器内">2.2.1. 同步文件变化到容器内</h3>
<p><code>hostPath</code>的挂载方式可以挂载目录和文件两种格式，如果使用文件挂载的方式，通过简单的<code>vi</code>等命令修改宿主机的文件，并不会实时同步到容器内的映射文件。而需要对容器进行重启的操作才可以把文件的修改内容同步到文件中，但生产的容器一般不建议执行重启的操作。因此我们可以通过以下的方式来避免这个问题的发生。</p>
<p>以上文件不同步的本质原因是容器在初次挂载的时候使用了宿主机的文件的inode number进行标识，而<strong>vi等操作会导致文件的inode number发生变化</strong>，所以当宿主机文件的inode number发生变化，容器内并不会发生变化，<strong>为了保持文件内容一致，则需要保持修改文件的同时文件的inode number不变</strong>。那么我们<strong>可以使用 cat 或echo 命令覆盖文件的内容则inode number不会发生变化。</strong></p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/hosts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hosts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">readOnly</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/hosts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">FileOrCreate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hosts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>例如，以上的案例是通过挂载宿主机的/etc/hosts文件来映射到容器，如果想修改宿主机的hosts文件来同步容器内的hosts文件，可以通过以下的方式:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看文件的inode</span>
</span></span><span style="display:flex;"><span>ls -i /etc/hosts
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">39324780</span> /etc/hosts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 追加记录</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;1.1.1.1 xxx.com&#34;</span> &gt;&gt; /etc/hosts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 替换内容</span>
</span></span><span style="display:flex;"><span>sed <span style="color:#4e9a06">&#39;s/1.1.1.1/2.2.2.2/g&#39;</span> /etc/hosts &gt; temp.txt
</span></span><span style="display:flex;"><span>cat temp.txt &gt; /etc/hosts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看宿主机和容器内的inode号都没有发生变化</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># crictl exec -it 20891de31a4a6 sh</span>
</span></span><span style="display:flex;"><span>/var/www/html <span style="color:#8f5902;font-style:italic"># ls -i /etc/hosts</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">39324780</span> /etc/hosts
</span></span></code></pre></div><h2 id="2-3-configmap">2.3. configMap</h2>
<p><code>configMap</code>提供了一种给Pod注入配置文件的方式，配置文件内容存储在configMap对象中，如果Pod使用configMap作为volume的类型，需要先创建configMap的对象。</p>
<p><strong>示例</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">configmap-pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">busybox</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">config-vol</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">config-vol</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">configMap</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">log-config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">items</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">log_level</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">log_level</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-4-cephfs">2.4. cephfs</h2>
<p><code>cephfs</code>的方式将Pod的存储挂载到<code>ceph</code>集群中，通过外部存储的方式持久化Pod的数据（即当Pod被删除数据仍可以存储在ceph集群中），前提是先部署和维护好一个ceph集群。</p>
<p><strong>示例</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-rw</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes/pause</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/mnt/cephfs&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cephfs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">monitors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#0000cf;font-weight:bold">10.16.154.78</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">6789</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#0000cf;font-weight:bold">10.16.154.82</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">6789</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#0000cf;font-weight:bold">10.16.154.83</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">6789</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># by default the path is /, but you can override and mount a specific path of the filesystem by using the path attribute</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># path: /some/path/in/side/cephfs </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">secretFile</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/etc/ceph/admin.secret&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">readOnly</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>更多可参考 <a href="https://github.com/kubernetes/examples/tree/master/staging/volumes/cephfs/">CephFS 示例</a>。</p>
<h2 id="2-5-nfs">2.5. nfs</h2>
<p><code>nfs</code>的方式类似cephfs，即将Pod数据存储到NFS集群中，具体可参考<a href="https://github.com/kubernetes/examples/tree/master/staging/volumes/nfs">NFS示例</a>。</p>
<h2 id="2-6-persistentvolumeclaim">2.6. persistentVolumeClaim</h2>
<p><code>persistentVolumeClaim</code> 卷用于将<code>PersistentVolume</code>挂载到容器中。PersistentVolumes 是在用户不知道特定云环境的细节的情况下“声明”持久化存储（例如 GCE PersistentDisk 或 iSCSI 卷）的一种方式。</p>
<p>参考文章：</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/storage/volumes/">https://kubernetes.io/docs/concepts/storage/volumes/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b639cd59796d543959dd36a9a8d277cf">6.1.2 - PersistentVolume 介绍</h1>
    
	<h2 id="1-pv概述">1. PV概述</h2>
<p><code>PersistentVolume</code>（简称PV） 是 Volume 之类的卷插件，也是集群中的资源，但独立于Pod的生命周期（即不会因Pod删除而被删除），不归属于某个Namespace。</p>
<h2 id="2-pv和pvc的生命周期">2. PV和PVC的生命周期</h2>
<h3 id="2-1-配置-provision">2.1. 配置（Provision）</h3>
<p>有两种方式来配置 PV：静态或动态。</p>
<p><strong>1、静态</strong></p>
<p>手动创建PV，可供k8s集群中的对象消费。</p>
<p><strong>2、动态</strong></p>
<p>可以通过<code>StorageClass</code>和具体的<code>Provisioner</code>（例如<code>nfs-client-provisioner</code>）来动态地创建和删除PV。</p>
<h3 id="2-2-绑定">2.2. 绑定</h3>
<p>在动态配置的情况下，用户创建了特定的PVC，k8s会监听新的PVC，并寻找匹配的PV绑定。一旦绑定后，这种绑定是排他性的，PVC和PV的绑定是一对一的映射。</p>
<h3 id="2-3-使用">2.3. 使用</h3>
<p>Pod 使用PVC作为卷。集群检查PVC以查找绑定的卷并为集群挂载该卷。用户通过在 Pod 的 volume 配置中包含 <code>persistentVolumeClaim</code> 来调度 Pod 并访问用户声明的 PV。</p>
<h3 id="2-4-回收">2.4. 回收</h3>
<p>PV的回收策略可以设定PVC在释放后如何处理对应的Volume，目前有 <code>Retained</code>， <code>Recycled </code>和<code> Deleted</code>三种策略。</p>
<p><strong>1、保留</strong>（Retain）</p>
<p>保留策略允许手动回收资源，当删除PVC的时候，PV仍然存在，可以通过以下步骤回收卷：</p>
<ol>
<li>删除PV</li>
<li>手动清理外部存储的数据资源</li>
<li>手动删除或重新使用关联的存储资产</li>
</ol>
<p><strong>2、回收</strong>（Resycle）</p>
<blockquote>
<p>该策略已废弃，推荐使用dynamic provisioning</p>
</blockquote>
<p>回收策略会在 volume上执行基本擦除（<code>rm -rf / thevolume / *</code>），可被再次声明使用。</p>
<p><strong>3、删除</strong>（Delete）</p>
<p>删除策略，当发生删除操作的时候，会从k8s集群中删除PV对象，并执行外部存储资源的删除操作（根据不同的provisioner定义的删除逻辑不同，有的是重命名）。</p>
<p>动态配置的卷继承其<code>StorageClass</code>的回收策略，默认为Delete，即当用户删除PVC的时候，会自动执行PV的删除策略。</p>
<p>如果要修改PV的回收策略，可执行以下命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Get pv </span>
</span></span><span style="display:flex;"><span>kubectl get pv
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Change policy to Retaion</span>
</span></span><span style="display:flex;"><span>kubectl patch pv &lt;pv_name&gt; -p ‘<span style="color:#ce5c00;font-weight:bold">{</span>“spec”:<span style="color:#ce5c00;font-weight:bold">{</span>“persistentVolumeReclaimPolicy”:“Retain”<span style="color:#ce5c00;font-weight:bold">}}</span>’
</span></span></code></pre></div><h2 id="3-pv的类型">3. PV的类型</h2>
<p><code>PersistentVolume</code> 类型以插件形式实现。以下仅列部分常用类型：</p>
<ul>
<li>GCEPersistentDisk</li>
<li>AWSElasticBlockStore</li>
<li>NFS</li>
<li>RBD (Ceph Block Device)</li>
<li>CephFS</li>
<li>Glusterfs</li>
</ul>
<h2 id="4-pv的属性">4. PV的属性</h2>
<p>每个<code> PV</code> 配置中都包含一个 <code>sepc </code>规格字段和一个 <code>status</code> 卷状态字段。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PersistentVolume</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pv.kubernetes.io/provisioned-by</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fuseim.pri/ifs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">creationTimestamp</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">2018-07-12T06:46:48Z</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default-test-web-0-pvc-58cf5ec1-859f-11e8-bb61-005056b83985</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resourceVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;100163256&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selfLink</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/api/v1/persistentvolumes/default-test-web-0-pvc-58cf5ec1-859f-11e8-bb61-005056b83985</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">uid</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">59796ba3-859f-11e8-9c50-c81f66bcff65</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">accessModes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">ReadWriteOnce</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">capacity</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">storage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">2Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumeMode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Filesystem  </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">claimRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PersistentVolumeClaim</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test-web-0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resourceVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;100163248&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">uid</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">58cf5ec1-859f-11e8-bb61-005056b83985</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">nfs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/data/nfs-storage/default-test-web-0-pvc-58cf5ec1-859f-11e8-bb61-005056b83985</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">172.16.201.54</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">persistentVolumeReclaimPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Delete</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">storageClassName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">managed-nfs-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">mountOptions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">hard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">nfsvers=4.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">status</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">phase</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Bound</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="4-1-capacity">4.1. Capacity</h3>
<p>给PV设置特定的<code>存储容量</code>，更多 <code>capacity</code> 可参考Kubernetes <a href="https://git.k8s.io/community/contributors/design-proposals/scheduling/resources.md">资源模型</a> 。</p>
<h3 id="4-2-volume-mode">4.2. Volume Mode</h3>
<p><code> volumeMode</code> 的有效值可以是<code>Filesystem</code>或<code>Block</code>。如果未指定，volumeMode 将默认为<code>Filesystem</code>。</p>
<h3 id="4-3-access-modes">4.3. Access Modes</h3>
<p>访问模式包括：</p>
<ul>
<li><code>ReadWriteOnce</code>——该卷可以被单个节点以读/写模式挂载</li>
<li><code>ReadOnlyMany</code>——该卷可以被多个节点以只读模式挂载</li>
<li><code>ReadWriteMany</code>——该卷可以被多个节点以读/写模式挂载</li>
</ul>
<p>在命令行中，访问模式缩写为：</p>
<ul>
<li>RWO - ReadWriteOnce</li>
<li>ROX - ReadOnlyMany</li>
<li>RWX - ReadWriteMany</li>
</ul>
<blockquote>
<p>一个卷一次只能使用一种访问模式挂载，即使它支持很多访问模式。</p>
</blockquote>
<p>以下只列举部分常用插件：</p>
<table>
<thead>
<tr>
<th>Volume 插件</th>
<th>ReadWriteOnce</th>
<th>ReadOnlyMany</th>
<th>ReadWriteMany</th>
</tr>
</thead>
<tbody>
<tr>
<td>AWSElasticBlockStore</td>
<td>✓</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>CephFS</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>GCEPersistentDisk</td>
<td>✓</td>
<td>✓</td>
<td>-</td>
</tr>
<tr>
<td>Glusterfs</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>HostPath</td>
<td>✓</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>NFS</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>RBD</td>
<td>✓</td>
<td>✓</td>
<td>-</td>
</tr>
<tr>
<td>...</td>
<td></td>
<td></td>
<td>-</td>
</tr>
</tbody>
</table>
<h3 id="4-4-class">4.4. Class</h3>
<p><code>PV</code>可以指定一个<code>StorageClass</code>来动态绑定PV和PVC，其中通过 <code>storageClassName</code> 属性来指定具体的<code>StorageClass</code>，如果没有指定该属性的PV，它只能绑定到不需要特定类的 PVC。</p>
<h3 id="4-5-reclaim-policy">4.5. Reclaim Policy</h3>
<p>回收策略包括：</p>
<ul>
<li><code>Retain</code>（保留）——手动回收</li>
<li><code>Recycle</code>（回收）——基本擦除（<code>rm -rf /thevolume/*</code>）</li>
<li><code>Delete</code>（删除）——关联的存储资产（例如 AWS EBS、GCE PD、Azure Disk 和 OpenStack Cinder 卷）将被删除</li>
</ul>
<p>当前，只有 NFS 和 HostPath 支持回收策略。AWS EBS、GCE PD、Azure Disk 和 Cinder 卷支持删除策略。</p>
<h3 id="4-6-mount-options">4.6. Mount Options</h3>
<p>Kubernetes 管理员可以指定在节点上为挂载持久卷指定挂载选项。</p>
<blockquote>
<p><strong>注意</strong>：不是所有的持久化卷类型都支持挂载选项。</p>
</blockquote>
<p>支持挂载选项常用的类型有：</p>
<ul>
<li>GCEPersistentDisk</li>
<li>AWSElasticBlockStore</li>
<li>AzureFile</li>
<li>AzureDisk</li>
<li>NFS</li>
<li>RBD （Ceph Block Device）</li>
<li>CephFS</li>
<li>Cinder （OpenStack 卷存储）</li>
<li>Glusterfs</li>
</ul>
<h3 id="4-7-phase">4.7. Phase</h3>
<p>PV可以处于以下的某种状态：</p>
<ul>
<li><code>Available</code>（可用）——一块空闲资源还没有被任何声明绑定</li>
<li><code>Bound</code>（已绑定）——卷已经被声明绑定</li>
<li><code>Released</code>（已释放）——声明被删除，但是资源还未被集群重新声明</li>
<li><code>Failed</code>（失败）——该卷的自动回收失败</li>
</ul>
<p>命令行会显示绑定到 PV 的 PVC 的名称。</p>
<p>参考文章：</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">https://kubernetes.io/docs/concepts/storage/persistent-volumes/</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/change-pv-reclaim-policy/">https://kubernetes.io/docs/tasks/administer-cluster/change-pv-reclaim-policy/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2c8f8b6ee717f78cb80b00011c9c2e2f">6.1.3 - PersistentVolumeClaim 介绍</h1>
    
	<h2 id="1-pvc概述">1. PVC概述</h2>
<p><code>PersistentVolumeClaim</code>（简称PVC）是用户存储的请求，PVC消耗PV的资源，可以请求特定的大小和访问模式，需要指定归属于某个Namespace，在同一个Namespace的Pod才可以指定对应的PVC。</p>
<p>当需要不同性质的PV来满足存储需求时，可以使用<code>StorageClass</code>来实现。</p>
<p>每个 PVC 中都包含一个 spec 规格字段和一个 status 声明状态字段。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PersistentVolumeClaim</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">myclaim</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">accessModes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">ReadWriteOnce</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumeMode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Filesystem</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">storage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">8Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">storageClassName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">slow</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">release</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;stable&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchExpressions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- {<span style="color:#204a87;font-weight:bold">key: environment, operator: In, values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">dev]}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-pvc的属性">2. PVC的属性</h2>
<h3 id="2-1-accessmodes">2.1. accessModes</h3>
<p>对应存储的访问模式，例如：<code>ReadWriteOnce</code>。</p>
<h3 id="2-2-volumemode">2.2. volumeMode</h3>
<p>对应存储的数据卷模式，例如：<code>Filesystem</code>。</p>
<h3 id="2-3-resources">2.3. resources</h3>
<p>声明可以请求特定数量的资源。相同的<a href="https://git.k8s.io/community/contributors/design-proposals/scheduling/resources.md">资源模型</a>适用于Volume和PVC。</p>
<h3 id="2-4-selector">2.4. selector</h3>
<p>声明<code>label selector</code>，只有标签与选择器匹配的卷可以绑定到声明。</p>
<ul>
<li>matchLabels：volume 必须有具有该值的标签</li>
<li>matchExpressions：条件列表，通过条件表达式筛选匹配的卷。有效的运算符包括 In、NotIn、Exists 和 DoesNotExist。</li>
</ul>
<h3 id="2-5-storageclassname">2.5. storageClassName</h3>
<p>通过<code>storageClassName</code>参数来指定使用对应名字的<code>StorageClass</code>，只有所请求的类与 PVC 具有相同 <code>storageClassName</code> 的 PV 才能绑定到 PVC。</p>
<p>PVC可以不指定storageClassName，或者将该值设置为空，如果打开了准入控制插件，并且指定一个默认的 <code>StorageClass</code>，则PVC会使用默认的<code>StorageClass</code>，否则就绑定到没有<code>StorageClass</code>的 PV上。</p>
<blockquote>
<p>之前使用注解 <code>volume.beta.kubernetes.io/storage-class</code> 而不是 <code>storageClassName</code> 属性。这个注解仍然有效，但是在未来的 Kubernetes 版本中不会支持。</p>
</blockquote>
<h2 id="3-将pvc作为volume">3. 将PVC作为Volume</h2>
<p>将PVC作为Pod的Volume，PVC与Pod需要在同一个命名空间下，其实Pod的声明如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mypod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">myfrontend</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dockerfile/nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/var/www/html&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mypd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mypd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">persistentVolumeClaim</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 使用PVC</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">claimName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">myclaim</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><code>PersistentVolumes</code> 绑定是唯一的，并且由于 <code>PersistentVolumeClaims</code> 是命名空间对象，因此只能在一个命名空间内挂载具有“多个”模式（<code>ROX</code>、<code>RWX</code>）的PVC。</p>
<p>参考文章：</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">https://kubernetes.io/docs/concepts/storage/persistent-volumes/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d1cc6e58a4338c8077a47f605ca6d5b7">6.1.4 - StorageClass 介绍</h1>
    
	<h2 id="1-storageclass概述">1. StorageClass概述</h2>
<p><code>StorageClass</code>提供了一种描述<code>存储类</code>（class）的方法，不同的class可能会映射到不同的服务质量等级和备份策略或其他策略等。</p>
<p><code>StorageClass</code> 对象中包含 <code>provisioner</code>、<code>parameters</code> 和 <code>reclaimPolicy</code> 字段，当需要动态分配 <code>PersistentVolume</code> 时会使用到。当创建 <code>StorageClass</code> 对象时，设置名称和其他参数，一旦创建了对象就不能再对其更新。也可以为没有申请绑定到特定 class 的 PVC 指定一个默认的 <code>StorageClass</code> 。</p>
<p><strong>StorageClass对象文件</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">StorageClass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">storage.k8s.io/v3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">standard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">provisioner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes.io/aws-ebs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gp2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">reclaimPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Retain</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">mountOptions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">debug</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-storageclass的属性">2. StorageClass的属性</h2>
<h3 id="2-1-provisioner-存储分配器">2.1.  Provisioner（存储分配器）</h3>
<p>Storage class 有一个<code>分配器（provisioner）</code>，用来决定使用哪个卷插件分配 PV，该字段必须指定。可以指定内部分配器，也可以指定外部分配器。外部分配器的代码地址为： <a href="https://github.com/kubernetes-incubator/external-storage">kubernetes-incubator/external-storage</a>，其中包括<code>NFS</code>和<code>Ceph</code>等。</p>
<h3 id="2-2-reclaim-policy-回收策略">2.2. Reclaim Policy（回收策略）</h3>
<p>可以通过<code>reclaimPolicy</code>字段指定创建的<code>Persistent Volume</code>的回收策略，回收策略包括：<code>Delete</code> 或者 <code>Retain</code>，没有指定默认为<code>Delete</code>。</p>
<h3 id="2-3-mount-options-挂载选项">2.3. Mount Options（挂载选项）</h3>
<p>由 storage class 动态创建的 Persistent Volume 将使用 class 中 <code>mountOptions</code> 字段指定的挂载选项。</p>
<h3 id="2-4-参数">2.4. 参数</h3>
<p>Storage class 具有描述属于 storage class 卷的参数。取决于<code>分配器</code>，可以接受不同的参数。 当参数被省略时，会使用默认值。</p>
<p>例如以下使用<code>Ceph RBD</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">StorageClass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">storage.k8s.io/v3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fast</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">provisioner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes.io/rbd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">monitors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">30.36.353.305</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">6789</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">adminId</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kube</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">adminSecretName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceph-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">adminSecretNamespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pool</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kube</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">userId</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kube</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">userSecretName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceph-secret-user</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">fsType</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ext4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">imageFormat</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">imageFeatures</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;layering&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>对应的参数说明</strong></p>
<ul>
<li>
<p><code>monitors</code>：Ceph monitor，逗号分隔。该参数是必需的。</p>
</li>
<li>
<p><code>adminId</code>：Ceph 客户端 ID，用于在池（ceph pool）中创建映像。 默认是 “admin”。</p>
</li>
<li>
<p><code>adminSecretNamespace</code>：adminSecret 的 namespace。默认是 “default”。</p>
</li>
<li>
<p><code>adminSecret</code>：adminId 的 Secret 名称。该参数是必需的。 提供的 secret 必须有值为 “kubernetes.io/rbd” 的 type 参数。</p>
</li>
<li>
<p><code>pool</code>: Ceph RBD 池. 默认是 “rbd”。</p>
</li>
<li>
<p><code>userId</code>：Ceph 客户端 ID，用于映射 RBD 镜像（RBD image）。默认与 adminId 相同。</p>
</li>
<li>
<p><code>userSecretName</code>：用于映射 RBD 镜像的 userId 的 Ceph Secret 的名字。 它必须与 PVC 存在于相同的 namespace 中。该参数是必需的。 提供的 secret 必须具有值为 “kubernetes.io/rbd” 的 type 参数，例如以这样的方式创建：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create secret generic ceph-secret --type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;kubernetes.io/rbd&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --from-literal<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;QVFEQ1pMdFhPUnQrSmhBQUFYaERWNHJsZ3BsMmNjcDR6RFZST0E9PQ==&#39;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  --namespace<span style="color:#ce5c00;font-weight:bold">=</span>kube-system
</span></span></code></pre></div></li>
<li>
<p><code>fsType</code>：Kubernetes 支持的 fsType。默认：&quot;ext4&quot;。</p>
</li>
<li>
<p><code>imageFormat</code>：Ceph RBD 镜像格式，”1” 或者 “2”。默认值是 “1”。</p>
</li>
<li>
<p><code>imageFeatures</code>：这个参数是可选的，只能在你将 imageFormat 设置为 “2” 才使用。 目前支持的功能只是 <code>layering</code>。 默认是 ““，没有功能打开。</p>
</li>
</ul>
<p>参考文章：</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/storage/storage-classes/">https://kubernetes.io/docs/concepts/storage/storage-classes/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-04b9e34f8799e1a90314832d503a015e">6.1.5 - Dynamic Volume Provisioning 介绍</h1>
    
	<h2 id="dynamic-volume-provisioning">Dynamic Volume Provisioning</h2>
<p>Dynamic volume provisioning允许用户按需自动创建存储卷，这种方式可以让用户不需要关心存储的复杂性和差别，又可以选择不同的存储类型。</p>
<h2 id="1-开启dynamic-provisioning">1. 开启Dynamic Provisioning</h2>
<p>需要先提前创建<code>StorageClass</code>对象，<code>StorageClass</code>中定义了使用哪个<code>provisioner</code>，并且在<code>provisioner</code>被调用时传入哪些参数，具体可参考<code>StorageClass</code>介绍。</p>
<p>例如：</p>
<ul>
<li>磁盘类存储</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">storage.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">StorageClass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">slow</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">provisioner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes.io/gce-pd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pd-standard</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>SSD类存储</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">storage.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">StorageClass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fast</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">provisioner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes.io/gce-pd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pd-ssd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-使用dynamic-provisioning">2. 使用Dynamic Provisioning</h2>
<p>创建一个PVC对象，并且在其中<code>storageClassName</code>字段指明需要用到的<code>StorageClass</code>的名称，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PersistentVolumeClaim</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">claim1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">accessModes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">ReadWriteOnce</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">storageClassName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fast</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">storage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">30Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>当使用到PVC的时候会自动创建对应的外部存储，当PVC被删除的时候，会自动销毁（或备份）外部存储。</p>
<h2 id="3-默认的storageclass">3. 默认的StorageClass</h2>
<p>当没有对应的<code>StorageClass</code>配置时，可以设定默认的<code>StorageClass</code>，需要执行以下操作：</p>
<ul>
<li>在API Server开启<a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#defaultstorageclass"><code>DefaultStorageClass</code> admission controller</a> 。</li>
<li>设置默认的<code>StorageClass</code>对象。</li>
</ul>
<p>可以通过添加<code>storageclass.kubernetes.io/is-default-class</code>注解的方式设置某个<code>StorageClass</code>为默认的<code>StorageClass</code>。当用户创建了一个<code>PersistentVolumeClaim</code>，但没有指定<code>storageClassName</code>的时候，会自动将该PVC的<code>storageClassName</code>指向默认的<code>StorageClass</code>。</p>
<p>参考文章：</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/">https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7d4ddc2dc93bb706e954d8380bb26646">6.2 - CSI</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-bbd68015d5f325aa1d6f47d4c27eb87f">6.2.1 - csi-cephfs-plugin</h1>
    
	<h1 id="1-编译csi-cephfs-plugin">1. 编译CSI CephFS plugin</h1>
<p>CSI CephFS plugin用来提供CephFS存储卷和挂载存储卷，源码参考：<a href="https://github.com/ceph/ceph-csi">https://github.com/ceph/ceph-csi</a> 。</p>
<h2 id="1-1-编译二进制">1.1. 编译二进制</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ make cephfsplugin
</span></span></code></pre></div><h2 id="1-2-编译docker镜像">1.2. 编译Docker镜像</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ make image-cephfsplugin
</span></span></code></pre></div><h1 id="2-配置项">2. 配置项</h1>
<h2 id="2-1-命令行参数">2.1. 命令行参数</h2>
<table>
<thead>
<tr>
<th>Option</th>
<th>Default value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--endpoint</code></td>
<td><code>unix://tmp/csi.sock</code></td>
<td>CSI endpoint, must be a UNIX socket</td>
</tr>
<tr>
<td><code>--drivername</code></td>
<td><code>csi-cephfsplugin</code></td>
<td>name of the driver (Kubernetes: <code>provisioner</code> field in StorageClass must correspond to this value)</td>
</tr>
<tr>
<td><code>--nodeid</code></td>
<td><em>empty</em></td>
<td>This node’s ID</td>
</tr>
<tr>
<td><code>--volumemounter</code></td>
<td><em>empty</em></td>
<td>default volume mounter. Available options are <code>kernel</code> and <code>fuse</code>. This is the mount method used if volume parameters don’t specify otherwise. If left unspecified, the driver will first probe for <code>ceph-fuse</code> in system’s path and will choose Ceph kernel client if probing failed.</td>
</tr>
</tbody>
</table>
<h2 id="2-2-volume参数">2.2. volume参数</h2>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>monitors</code></td>
<td>yes</td>
<td>Comma separated list of Ceph monitors (e.g. <code>192.168.100.1:6789,192.168.100.2:6789,192.168.100.3:6789</code>)</td>
</tr>
<tr>
<td><code>mounter</code></td>
<td>no</td>
<td>Mount method to be used for this volume. Available options are <code>kernel</code> for Ceph kernel client and <code>fuse</code> for Ceph FUSE driver. Defaults to “default mounter”, see command line arguments.</td>
</tr>
<tr>
<td><code>provisionVolume</code></td>
<td>yes</td>
<td>Mode of operation. BOOL value. If <code>true</code>, a new CephFS volume will be provisioned. If <code>false</code>, an existing CephFS will be used.</td>
</tr>
<tr>
<td><code>pool</code></td>
<td>for <code>provisionVolume=true</code></td>
<td>Ceph pool into which the volume shall be created</td>
</tr>
<tr>
<td><code>rootPath</code></td>
<td>for <code>provisionVolume=false</code></td>
<td>Root path of an existing CephFS volume</td>
</tr>
<tr>
<td><code>csiProvisionerSecretName</code>, <code>csiNodeStageSecretName</code></td>
<td>for Kubernetes</td>
<td>name of the Kubernetes Secret object containing Ceph client credentials. Both parameters should have the same value</td>
</tr>
<tr>
<td><code>csiProvisionerSecretNamespace</code>, <code>csiNodeStageSecretNamespace</code></td>
<td>for Kubernetes</td>
<td>namespaces of the above Secret objects</td>
</tr>
</tbody>
</table>
<h2 id="2-3-provisionvolume">2.3. provisionVolume</h2>
<h3 id="2-3-1-管理员密钥认证">2.3.1. 管理员密钥认证</h3>
<p>当<strong>provisionVolume=true</strong>时，必要的管理员认证参数如下：</p>
<ul>
<li><code>adminID</code>: ID of an admin client</li>
<li><code>adminKey</code>: key of the admin client</li>
</ul>
<h3 id="2-3-2-普通用户密钥认证">2.3.2. 普通用户密钥认证</h3>
<p>当<strong>provisionVolume=false</strong>时，必要的用户认证参数如下：</p>
<ul>
<li><code>userID</code>: ID of a user client</li>
<li><code>userKey</code>: key of a user client</li>
</ul>
<p>参考文章：</p>
<ul>
<li><a href="https://github.com/ceph/ceph-csi/blob/master/docs/deploy-cephfs.md">https://github.com/ceph/ceph-csi/blob/master/docs/deploy-cephfs.md</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-78953da03ebebfc47dbb2dd88764145e">6.2.2 - 部署csi-cephfs</h1>
    
	<h1 id="0-说明">0. 说明</h1>
<p>要求Kubernetes的版本在<code>1.11</code>及以上，k8s集群必须允许特权Pod（<code>privileged pods</code>），即apiserver和kubelet需要设置<code>--allow-privileged</code>为<code>true</code>。节点的<code>Docker daemon</code>需要允许挂载共享卷。</p>
<h2 id="涉及镜像">涉及镜像</h2>
<ul>
<li>quay.io/k8scsi/csi-provisioner:v0.3.0</li>
<li>quay.io/k8scsi/csi-attacher:v0.3.0</li>
<li>quay.io/k8scsi/driver-registrar:v0.3.0</li>
<li>quay.io/cephcsi/cephfsplugin:v0.3.0</li>
</ul>
<h1 id="1-部署rbac">1. 部署RBAC</h1>
<p>部署<code>service accounts</code>, <code>cluster roles</code> 和 <code>cluster role bindings</code>，这些可供<code>RBD</code>和<code>CephFS CSI plugins</code>共同使用，他们拥有相同的权限。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl create -f csi-attacher-rbac.yaml
</span></span><span style="display:flex;"><span>$ kubectl create -f csi-provisioner-rbac.yaml
</span></span><span style="display:flex;"><span>$ kubectl create -f csi-nodeplugin-rbac.yaml
</span></span></code></pre></div><h2 id="1-1-csi-attacher-rbac-yaml">1.1. csi-attacher-rbac.yaml</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-attacher</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">external-attacher-runner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;events&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;persistentvolumes&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;nodes&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;storage.k8s.io&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;volumeattachments&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-attacher-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-attacher</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">external-attacher-runner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="1-2-csi-provisioner-rbac-yaml">1.2. csi-provisioner-rbac.yaml</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">external-provisioner-runner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;secrets&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;persistentvolumes&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;persistentvolumeclaims&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;storage.k8s.io&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;storageclasses&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;events&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;patch&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-provisioner-role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">external-provisioner-runner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="1-3-csi-nodeplugin-rbac-yaml">1.3. csi-nodeplugin-rbac.yaml</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-nodeplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-nodeplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;nodes&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;namespaces&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;persistentvolumes&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;storage.k8s.io&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;volumeattachments&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-nodeplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-nodeplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-nodeplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io          </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="2-部署csi-sidecar-containers">2. 部署CSI sidecar containers</h1>
<p>通过<code>StatefulSet</code>的方式部署<code>external-attacher</code>和<code>external-provisioner</code>供<code>CSI CephFS</code>使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl create -f csi-cephfsplugin-attacher.yaml
</span></span><span style="display:flex;"><span>$ kubectl create -f csi-cephfsplugin-provisioner.yaml
</span></span></code></pre></div><h2 id="2-1-csi-cephfsplugin-provisioner-yaml">2.1. csi-cephfsplugin-provisioner.yaml</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dummy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">12345</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">StatefulSet</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">serviceName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;csi-cephfsplugin-provisioner&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">serviceAccount</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">quay.io/k8scsi/csi-provisioner:v0.3.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;--provisioner=csi-cephfsplugin&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;--csi-address=$(ADDRESS)&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;--v=5&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ADDRESS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/csi-cephfsplugin/csi.sock</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;IfNotPresent&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">socket-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/csi-cephfsplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">socket-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/csi-cephfsplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DirectoryOrCreate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-2-csi-cephfsplugin-attacher-yaml">2.2. csi-cephfsplugin-attacher.yaml</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin-attacher</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin-attacher</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin-attacher</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dummy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">12345</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">StatefulSet</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin-attacher</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">serviceName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;csi-cephfsplugin-attacher&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin-attacher</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">serviceAccount</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-attacher</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin-attacher</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">quay.io/k8scsi/csi-attacher:v0.3.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;--v=5&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;--csi-address=$(ADDRESS)&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ADDRESS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/csi-cephfsplugin/csi.sock</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;IfNotPresent&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">socket-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/csi-cephfsplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">socket-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/csi-cephfsplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DirectoryOrCreate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="3-部署csi-cephfs-driver-plugin">3. 部署CSI-CephFS-driver(plugin)</h1>
<blockquote>
<p>csi-cephfs-plugin 的作用类似nfs-client，部署在所有node节点上，执行ceph的挂载等相关任务。</p>
</blockquote>
<p>通过<code>DaemonSet</code>的方式部署，其中包括两个容器：<code>CSI driver-registrar</code> 和 <code>CSI CephFS driver</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl create -f csi-cephfsplugin.yaml
</span></span></code></pre></div><h2 id="3-1-csi-cephfsplugin-yaml">3.1. csi-cephfsplugin.yaml</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DaemonSet</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1beta2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">serviceAccount</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-nodeplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hostNetwork</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># to use e.g. Rook orchestrated cluster, and mons&#39; FQDN is</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># resolved through k8s service, set dns policy to cluster first</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">dnsPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterFirstWithHostNet      </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">driver-registrar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">quay.io/k8scsi/driver-registrar:v0.3.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;--v=5&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;--csi-address=$(ADDRESS)&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;--kubelet-registration-path=$(DRIVER_REG_SOCK_PATH)&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ADDRESS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/csi-cephfsplugin/csi.sock</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DRIVER_REG_SOCK_PATH</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/csi-cephfsplugin/csi.sock</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">KUBE_NODE_NAME</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">valueFrom</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">fieldRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">fieldPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">spec.nodeName</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">socket-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/csi-cephfsplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">registration-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/registration</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfsplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">securityContext</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">privileged</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">capabilities</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">add</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;SYS_ADMIN&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">allowPrivilegeEscalation</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">quay.io/cephcsi/cephfsplugin:v0.3.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">args </span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;--nodeid=$(NODE_ID)&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;--endpoint=$(CSI_ENDPOINT)&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;--v=5&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#4e9a06">&#34;--drivername=csi-cephfsplugin&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NODE_ID</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">valueFrom</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">fieldRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">fieldPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">spec.nodeName</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CSI_ENDPOINT</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">unix://var/lib/kubelet/plugins/csi-cephfsplugin/csi.sock</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;IfNotPresent&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plugin-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/csi-cephfsplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pods-mount-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/pods</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPropagation</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Bidirectional&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/sys</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">host-sys</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lib-modules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/lib/modules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">readOnly</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">host-dev</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/dev</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">plugin-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/csi-cephfsplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DirectoryOrCreate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">registration-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Directory</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pods-mount-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/pods</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Directory</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">socket-dir</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/plugins/csi-cephfsplugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DirectoryOrCreate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">host-sys</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/sys</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lib-modules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/lib/modules</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">host-dev</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/dev</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="4-确认部署结果">4. 确认部署结果</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get all
</span></span><span style="display:flex;"><span>NAME                                 READY     STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/csi-cephfsplugin-attacher-0      1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          26s
</span></span><span style="display:flex;"><span>pod/csi-cephfsplugin-provisioner-0   1/1       Running   <span style="color:#0000cf;font-weight:bold">0</span>          25s
</span></span><span style="display:flex;"><span>pod/csi-cephfsplugin-rljcv           2/2       Running   <span style="color:#0000cf;font-weight:bold">0</span>          24s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>     AGE
</span></span><span style="display:flex;"><span>service/csi-cephfsplugin-attacher      ClusterIP   10.104.116.218   &lt;none&gt;        12345/TCP   27s
</span></span><span style="display:flex;"><span>service/csi-cephfsplugin-provisioner   ClusterIP   10.101.78.75     &lt;none&gt;        12345/TCP   26s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>参考文档：</p>
<ul>
<li><a href="https://github.com/ceph/ceph-csi">https://github.com/ceph/ceph-csi</a></li>
<li><a href="https://github.com/ceph/ceph-csi/blob/master/docs/deploy-cephfs.md">https://github.com/ceph/ceph-csi/blob/master/docs/deploy-cephfs.md</a></li>
<li><a href="https://github.com/ceph/ceph-csi/tree/master/deploy/cephfs/kubernetes">https://github.com/ceph/ceph-csi/tree/master/deploy/cephfs/kubernetes</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a76dfd266c67a36d479c10fe7a33d631">6.2.3 - 部署cephfs-provisioner</h1>
    
	<h1 id="1-安装cephfs客户端">1. 安装cephfs客户端</h1>
<p>所有node节点安装cephfs客户端，主要用来和ceph集群挂载使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y ceph-common
</span></span></code></pre></div><h1 id="2-部署rbac">2. 部署RBAC</h1>
<h2 id="2-1-clusterrole">2.1. ClusterRole</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;persistentvolumes&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;persistentvolumeclaims&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;storage.k8s.io&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;storageclasses&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;events&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;patch&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;services&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resourceNames</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;kube-dns&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;coredns&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-2-clusterrolebinding">2.2. ClusterRoleBinding</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-3-role">2.3. Role</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;secrets&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;endpoints&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;patch&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-4-rolebinding">2.4. RoleBinding</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-5-serviceaccount">2.5. ServiceAccount</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="3-部署-cephfs-provisioner">3. 部署 cephfs-provisioner</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">extensions/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">strategy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Recreate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;quay.io/external_storage/cephfs-provisioner:latest&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">500m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">512Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">64Mi        </span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PROVISIONER_NAME               </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 与storageclass的provisioner参数相同</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceph.com/cephfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PROVISIONER_SECRET_NAMESPACE   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 与rbac的namespace相同</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;/usr/local/bin/cephfs-provisioner&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#4e9a06">&#34;-id=cephfs-provisioner-1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">serviceAccount</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="4-部署storageclass">4. 部署storageclass</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">storage.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">StorageClass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner-sc</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">provisioner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ceph.com/cephfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">volumeBindingMode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">WaitForFirstConsumer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">monitors</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">192.168.27.43</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">6789</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">192.168.27.44</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">6789</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">192.168.27.45</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">6789</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">adminId</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">adminSecretName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">csi-cephfs-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">adminSecretNamespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;kube-csi&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">claimRoot</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/pvc-volumes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="5-部署statefulset">5. 部署statefulset</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">StatefulSet</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner-nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">serviceName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;nginx&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx:latest  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#nginx的镜像</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">IfNotPresent</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;/mnt&#34;</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic">#容器里面的挂载目录，该目录挂载到NFS的共享目录上</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumeClaimTemplates</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">accessModes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ReadWriteOnce&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">storage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">2Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">storageClassName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cephfs-provisioner-sc</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="6-日志">6. 日志</h1>
<h2 id="6-1-cephfs-provisoner-执行日志">6.1. cephfs-provisoner 执行日志</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>I0327 07:18:19.742239       <span style="color:#0000cf;font-weight:bold">1</span> controller.go:987<span style="color:#ce5c00;font-weight:bold">]</span> provision <span style="color:#4e9a06">&#34;default/test-cephfs-ngx-wait-22-0&#34;</span> class <span style="color:#4e9a06">&#34;cephfs-provisioner-sc&#34;</span>: started
</span></span><span style="display:flex;"><span>I0327 07:18:19.745239       <span style="color:#0000cf;font-weight:bold">1</span> event.go:221<span style="color:#ce5c00;font-weight:bold">]</span> Event<span style="color:#ce5c00;font-weight:bold">(</span>v1.ObjectReference<span style="color:#ce5c00;font-weight:bold">{</span>Kind:<span style="color:#4e9a06">&#34;PersistentVolumeClaim&#34;</span>, Namespace:<span style="color:#4e9a06">&#34;default&#34;</span>, Name:<span style="color:#4e9a06">&#34;test-cephfs-ngx-wait-22-0&#34;</span>, UID:<span style="color:#4e9a06">&#34;7f6b60d5-5060-11e9-9a9c-c81f66bcff65&#34;</span>, APIVersion:<span style="color:#4e9a06">&#34;v1&#34;</span>, ResourceVersion:<span style="color:#4e9a06">&#34;347214256&#34;</span>, FieldPath:<span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">})</span>: type: <span style="color:#4e9a06">&#39;Normal&#39;</span> reason: <span style="color:#4e9a06">&#39;Provisioning&#39;</span> External provisioner is provisioning volume <span style="color:#204a87;font-weight:bold">for</span> claim <span style="color:#4e9a06">&#34;default/test-cephfs-ngx-wait-22-0&#34;</span>
</span></span><span style="display:flex;"><span>I0327 07:18:23.281277       <span style="color:#0000cf;font-weight:bold">1</span> cephfs-provisioner.go:222<span style="color:#ce5c00;font-weight:bold">]</span> successfully created CephFS share <span style="color:#000;font-weight:bold">&amp;</span>CephFSPersistentVolumeSource<span style="color:#ce5c00;font-weight:bold">{</span>Monitors:<span style="color:#ce5c00;font-weight:bold">[</span>192.168.27.43:6789 192.168.27.44:6789 192.168.27.45:6789<span style="color:#ce5c00;font-weight:bold">]</span>,Path:/pvc-volumes/kubernetes/kubernetes-dynamic-pvc-7f7cb62f-5060-11e9-85c0-0adb8ef08100,User:kubernetes-dynamic-user-7f7cb69f-5060-11e9-85c0-0adb8ef08100,SecretFile:,SecretRef:<span style="color:#000;font-weight:bold">&amp;</span>SecretReference<span style="color:#ce5c00;font-weight:bold">{</span>Name:ceph-kubernetes-dynamic-user-7f7cb69f-5060-11e9-85c0-0adb8ef08100-secret,Namespace:default,<span style="color:#ce5c00;font-weight:bold">}</span>,ReadOnly:false,<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>I0327 07:18:23.281371       <span style="color:#0000cf;font-weight:bold">1</span> controller.go:1087<span style="color:#ce5c00;font-weight:bold">]</span> provision <span style="color:#4e9a06">&#34;default/test-cephfs-ngx-wait-22-0&#34;</span> class <span style="color:#4e9a06">&#34;cephfs-provisioner-sc&#34;</span>: volume <span style="color:#4e9a06">&#34;pvc-7f6b60d5-5060-11e9-9a9c-c81f66bcff65&#34;</span> provisioned
</span></span><span style="display:flex;"><span>I0327 07:18:23.281415       <span style="color:#0000cf;font-weight:bold">1</span> controller.go:1101<span style="color:#ce5c00;font-weight:bold">]</span> provision <span style="color:#4e9a06">&#34;default/test-cephfs-ngx-wait-22-0&#34;</span> class <span style="color:#4e9a06">&#34;cephfs-provisioner-sc&#34;</span>: trying to save persistentvvolume <span style="color:#4e9a06">&#34;pvc-7f6b60d5-5060-11e9-9a9c-c81f66bcff65&#34;</span>
</span></span><span style="display:flex;"><span>I0327 07:18:23.284621       <span style="color:#0000cf;font-weight:bold">1</span> controller.go:1108<span style="color:#ce5c00;font-weight:bold">]</span> provision <span style="color:#4e9a06">&#34;default/test-cephfs-ngx-wait-22-0&#34;</span> class <span style="color:#4e9a06">&#34;cephfs-provisioner-sc&#34;</span>: persistentvolume <span style="color:#4e9a06">&#34;pvc-7f6b60d5-5060-11e9-9a9c-c81f66bcff65&#34;</span> saved
</span></span><span style="display:flex;"><span>I0327 07:18:23.284723       <span style="color:#0000cf;font-weight:bold">1</span> controller.go:1149<span style="color:#ce5c00;font-weight:bold">]</span> provision <span style="color:#4e9a06">&#34;default/test-cephfs-ngx-wait-22-0&#34;</span> class <span style="color:#4e9a06">&#34;cephfs-provisioner-sc&#34;</span>: succeeded
</span></span><span style="display:flex;"><span>I0327 07:18:23.284810       <span style="color:#0000cf;font-weight:bold">1</span> event.go:221<span style="color:#ce5c00;font-weight:bold">]</span> Event<span style="color:#ce5c00;font-weight:bold">(</span>v1.ObjectReference<span style="color:#ce5c00;font-weight:bold">{</span>Kind:<span style="color:#4e9a06">&#34;PersistentVolumeClaim&#34;</span>, Namespace:<span style="color:#4e9a06">&#34;default&#34;</span>, Name:<span style="color:#4e9a06">&#34;test-cephfs-ngx-wait-22-0&#34;</span>, UID:<span style="color:#4e9a06">&#34;7f6b60d5-5060-11e9-9a9c-c81f66bcff65&#34;</span>, APIVersion:<span style="color:#4e9a06">&#34;v1&#34;</span>, ResourceVersion:<span style="color:#4e9a06">&#34;347214256&#34;</span>, FieldPath:<span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">})</span>: type: <span style="color:#4e9a06">&#39;Normal&#39;</span> reason: <span style="color:#4e9a06">&#39;ProvisioningSucceeded&#39;</span> Successfully provisioned volume pvc-7f6b60d5-5060-11e9-9a9c-c81f66bcff65
</span></span></code></pre></div><h2 id="6-2-debug-日志">6.2. debug 日志</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>I0327 08:08:11.789608       <span style="color:#0000cf;font-weight:bold">1</span> controller.go:987<span style="color:#ce5c00;font-weight:bold">]</span> provision <span style="color:#4e9a06">&#34;default/test-cephfs-ngx-wait-44-0&#34;</span> class <span style="color:#4e9a06">&#34;cephfs-sc-wait&#34;</span>: started
</span></span><span style="display:flex;"><span>I0327 08:08:11.793258       <span style="color:#0000cf;font-weight:bold">1</span> event.go:221<span style="color:#ce5c00;font-weight:bold">]</span> Event<span style="color:#ce5c00;font-weight:bold">(</span>v1.ObjectReference<span style="color:#ce5c00;font-weight:bold">{</span>Kind:<span style="color:#4e9a06">&#34;PersistentVolumeClaim&#34;</span>, Namespace:<span style="color:#4e9a06">&#34;default&#34;</span>, Name:<span style="color:#4e9a06">&#34;test-cephfs-ngx-wait-44-0&#34;</span>, UID:<span style="color:#4e9a06">&#34;81846859-5067-11e9-9a9c-c81f66bcff65&#34;</span>, APIVersion:<span style="color:#4e9a06">&#34;v1&#34;</span>, ResourceVersion:<span style="color:#4e9a06">&#34;347237916&#34;</span>, FieldPath:<span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">})</span>: type: <span style="color:#4e9a06">&#39;Normal&#39;</span> reason: <span style="color:#4e9a06">&#39;Provisioning&#39;</span> External provisioner is provisioning volume <span style="color:#204a87;font-weight:bold">for</span> claim <span style="color:#4e9a06">&#34;default/test-cephfs-ngx-wait-44-0&#34;</span>
</span></span><span style="display:flex;"><span>E0327 08:08:12.164705       <span style="color:#0000cf;font-weight:bold">1</span> cephfs-provisioner.go:158<span style="color:#ce5c00;font-weight:bold">]</span> failed to provision share <span style="color:#4e9a06">&#34;kubernetes-dynamic-pvc-76ecdc5a-5067-11e9-9421-2a1b1be1aeef&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#4e9a06">&#34;kubernetes-dynamic-user-76ecdcee-5067-11e9-9421-2a1b1be1aeef&#34;</span>, err: <span style="color:#204a87">exit</span> status 1, output: Traceback <span style="color:#ce5c00;font-weight:bold">(</span>most recent call last<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>  File <span style="color:#4e9a06">&#34;/usr/local/bin/cephfs_provisioner&#34;</span>, line 364, in &lt;module&gt;
</span></span><span style="display:flex;"><span>    main<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#4e9a06">&#34;/usr/local/bin/cephfs_provisioner&#34;</span>, line 358, in main
</span></span><span style="display:flex;"><span>    print cephfs.create_share<span style="color:#ce5c00;font-weight:bold">(</span>share, user, <span style="color:#000">size</span><span style="color:#ce5c00;font-weight:bold">=</span>size<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#4e9a06">&#34;/usr/local/bin/cephfs_provisioner&#34;</span>, line 228, in create_share
</span></span><span style="display:flex;"><span>    <span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">=</span> self.volume_client.create_volume<span style="color:#ce5c00;font-weight:bold">(</span>volume_path, <span style="color:#000">size</span><span style="color:#ce5c00;font-weight:bold">=</span>size, <span style="color:#000">namespace_isolated</span><span style="color:#ce5c00;font-weight:bold">=</span>not self.ceph_namespace_isolation_disabled<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#4e9a06">&#34;/usr/local/bin/cephfs_provisioner&#34;</span>, line 112, in volume_client
</span></span><span style="display:flex;"><span>    self._volume_client.connect<span style="color:#ce5c00;font-weight:bold">(</span>None<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#4e9a06">&#34;/lib/python2.7/site-packages/ceph_volume_client.py&#34;</span>, line 458, in connect
</span></span><span style="display:flex;"><span>    self.rados.connect<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#4e9a06">&#34;rados.pyx&#34;</span>, line 895, in rados.Rados.connect <span style="color:#ce5c00;font-weight:bold">(</span>/home/jenkins-build/build/workspace/ceph-build/ARCH/x86_64/AVAILABLE_ARCH/x86_64/AVAILABLE_DIST/centos7/DIST/centos7/MACHINE_SIZE/huge/release/13.2.1/rpm/el7/BUILD/ceph-13.2.1/build/src/pybind/rados/pyrex/rados.c:9815<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>rados.IOError: <span style="color:#ce5c00;font-weight:bold">[</span>errno 5<span style="color:#ce5c00;font-weight:bold">]</span> error connecting to the cluster
</span></span><span style="display:flex;"><span>W0327 08:08:12.164908       <span style="color:#0000cf;font-weight:bold">1</span> controller.go:746<span style="color:#ce5c00;font-weight:bold">]</span> Retrying syncing claim <span style="color:#4e9a06">&#34;default/test-cephfs-ngx-wait-44-0&#34;</span> because failures <span style="color:#0000cf;font-weight:bold">2</span> &lt; threshold <span style="color:#0000cf;font-weight:bold">15</span>
</span></span><span style="display:flex;"><span>E0327 08:08:12.164977       <span style="color:#0000cf;font-weight:bold">1</span> controller.go:761<span style="color:#ce5c00;font-weight:bold">]</span> error syncing claim <span style="color:#4e9a06">&#34;default/test-cephfs-ngx-wait-44-0&#34;</span>: failed to provision volume with StorageClass <span style="color:#4e9a06">&#34;cephfs-sc-wait&#34;</span>: <span style="color:#204a87">exit</span> status <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>I0327 08:08:12.165974       <span style="color:#0000cf;font-weight:bold">1</span> event.go:221<span style="color:#ce5c00;font-weight:bold">]</span> Event<span style="color:#ce5c00;font-weight:bold">(</span>v1.ObjectReference<span style="color:#ce5c00;font-weight:bold">{</span>Kind:<span style="color:#4e9a06">&#34;PersistentVolumeClaim&#34;</span>, Namespace:<span style="color:#4e9a06">&#34;default&#34;</span>, Name:<span style="color:#4e9a06">&#34;test-cephfs-ngx-wait-44-0&#34;</span>, UID:<span style="color:#4e9a06">&#34;81846859-5067-11e9-9a9c-c81f66bcff65&#34;</span>, APIVersion:<span style="color:#4e9a06">&#34;v1&#34;</span>, ResourceVersion:<span style="color:#4e9a06">&#34;347237916&#34;</span>, FieldPath:<span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">})</span>: type: <span style="color:#4e9a06">&#39;Warning&#39;</span> reason: <span style="color:#4e9a06">&#39;ProvisioningFailed&#39;</span> failed to provision volume with StorageClass <span style="color:#4e9a06">&#34;cephfs-sc-wait&#34;</span>: <span style="color:#204a87">exit</span> status <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><p>参考</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/ceph/cephfs/deploy">https://github.com/kubernetes-incubator/external-storage/tree/master/ceph/cephfs/deploy</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fe767b97f892ebc9ba161de84c2bea4b">6.2.4 - FlexVolume介绍</h1>
    
	<h1 id="1-flexvolume介绍">1. FlexVolume介绍</h1>
<p>Flexvolume提供了一种扩展k8s存储插件的方式，用户可以自定义自己的存储插件。类似的功能的实现还有CSI的方式。Flexvolume在k8s 1.8+以上版本提供GA功能版本。</p>
<h1 id="2-使用方式">2. 使用方式</h1>
<p>在每个node节点安装存储插件二进制，该二进制实现flexvolume的相关接口，默认存储插件的存放路径为<code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec/&lt;vendor~driver&gt;/&lt;driver&gt;</code>。</p>
<p>其中<code>vendor~driver</code>的名字需要和pod中flexVolume.driver的字段名字匹配，该字段名字通过<code>/</code>替换<code>~</code>。</p>
<p>例如：</p>
<ul>
<li>
<p>path:/usr/libexec/kubernetes/kubelet-plugins/volume/exec/foo~cifs/cifs</p>
</li>
<li>
<p>pod中flexVolume.driver:foo/cifs</p>
</li>
</ul>
<h1 id="3-flexvolume接口">3. FlexVolume接口</h1>
<p>节点上的存储插件需要实现以下的接口。</p>
<h2 id="3-1-init">3.1. init</h2>
<pre tabindex="0"><code>&lt;driver executable&gt; init
</code></pre><h2 id="3-2-attach">3.2. attach</h2>
<pre tabindex="0"><code>&lt;driver executable&gt; attach &lt;json options&gt; &lt;node name&gt;
</code></pre><h2 id="3-3-detach">3.3. detach</h2>
<pre tabindex="0"><code>&lt;driver executable&gt; detach &lt;mount device&gt; &lt;node name&gt;
</code></pre><h2 id="3-4-waitforattach">3.4. waitforattach</h2>
<pre tabindex="0"><code>&lt;driver executable&gt; waitforattach &lt;mount device&gt; &lt;json options&gt;
</code></pre><h2 id="3-5-isattached">3.5. isattached</h2>
<pre tabindex="0"><code>&lt;driver executable&gt; isattached &lt;json options&gt; &lt;node name&gt;
</code></pre><h2 id="3-6-mountdevice">3.6. mountdevice</h2>
<pre tabindex="0"><code>&lt;driver executable&gt; mountdevice &lt;mount dir&gt; &lt;mount device&gt; &lt;json options&gt;
</code></pre><h2 id="3-7-unmountdevice">3.7. unmountdevice</h2>
<pre tabindex="0"><code>&lt;driver executable&gt; unmountdevice &lt;mount device&gt;
</code></pre><h2 id="3-8-mount">3.8. mount</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;driver executable&gt; mount &lt;mount dir&gt; &lt;json options&gt;
</span></span></code></pre></div><h2 id="3-9-unmount">3.9. unmount</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&lt;driver executable&gt; unmount &lt;mount dir&gt;
</span></span></code></pre></div><h2 id="3-10-插件输出">3.10. 插件输出</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;Success/Failure/Not supported&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&#34;message&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;Reason for success/failure&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">&#34;device&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;Path to the device attached. This field is valid only for attach &amp; waitforattach call-outs&gt;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;volumeName&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&lt;Cluster wide unique name of the volume. Valid only for getvolumename call-out&gt;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;attached&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#a40000">&lt;True/False</span> <span style="color:#a40000">(Return</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#a40000">if</span> <span style="color:#a40000">volume</span> <span style="color:#a40000">is</span> <span style="color:#a40000">attached</span> <span style="color:#a40000">on</span> <span style="color:#a40000">the</span> <span style="color:#a40000">node.</span> <span style="color:#a40000">Valid</span> <span style="color:#a40000">only</span> <span style="color:#a40000">for</span> <span style="color:#a40000">isattached</span> <span style="color:#a40000">call-out)&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;capabilities&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#a40000">&lt;Only</span> <span style="color:#a40000">included</span> <span style="color:#a40000">as</span> <span style="color:#a40000">part</span> <span style="color:#a40000">of</span> <span style="color:#a40000">the</span> <span style="color:#a40000">Init</span> <span style="color:#a40000">response&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;attach&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#a40000">&lt;True/False</span> <span style="color:#a40000">(Return</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#a40000">if</span> <span style="color:#a40000">the</span> <span style="color:#a40000">driver</span> <span style="color:#a40000">implements</span> <span style="color:#a40000">attach</span> <span style="color:#a40000">and</span> <span style="color:#a40000">detach)&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-示例">4. 示例</h1>
<h2 id="4-1-pod的yaml文件内容">4.1. pod的yaml文件内容</h2>
<p><strong>nginx-nfs.yaml</strong></p>
<p>相关参数为flexVolume.driver等。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx-nfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx-nfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">flexVolume</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">driver</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;k8s/nfs&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">fsType</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;nfs&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;172.16.0.25&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">share</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;dws_nas_scratch&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="4-2-插件脚本">4.2. 插件脚本</h2>
<p>nfs脚本实现了flexvolume的接口。</p>
<p>/usr/libexec/kubernetes/kubelet-plugins/volume/exec/k8s~nfs/nfs。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Copyright 2015 The Kubernetes Authors.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># you may not use this file except in compliance with the License.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># You may obtain a copy of the License at</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     http://www.apache.org/licenses/LICENSE-2.0</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Unless required by applicable law or agreed to in writing, software</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># See the License for the specific language governing permissions and</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># limitations under the License.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Notes:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  - Please install &#34;jq&#34; package before using this driver.</span>
</span></span><span style="display:flex;"><span>usage<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#4e9a06">&#34;Invalid usage. Usage: &#34;</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#4e9a06">&#34;\t</span><span style="color:#000">$0</span><span style="color:#4e9a06"> init&#34;</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#4e9a06">&#34;\t</span><span style="color:#000">$0</span><span style="color:#4e9a06"> mount &lt;mount dir&gt; &lt;json params&gt;&#34;</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#4e9a06">&#34;\t</span><span style="color:#000">$0</span><span style="color:#4e9a06"> unmount &lt;mount dir&gt;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>err<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span> -ne <span style="color:#000">$*</span> 1&gt;<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>log<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">echo</span> -ne <span style="color:#000">$*</span> &gt;<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ismounted<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MOUNT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">`</span>findmnt -n <span style="color:#4e9a06">${</span><span style="color:#000">MNTPATH</span><span style="color:#4e9a06">}</span> 2&gt;/dev/null <span style="color:#000;font-weight:bold">|</span> cut -d<span style="color:#4e9a06">&#39; &#39;</span> -f1<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">MOUNT</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">MNTPATH</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;0&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>domount<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MNTPATH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NFS_SERVER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">echo</span> <span style="color:#000">$2</span> <span style="color:#000;font-weight:bold">|</span> jq -r <span style="color:#4e9a06">&#39;.server&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">SHARE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span><span style="color:#204a87">echo</span> <span style="color:#000">$2</span> <span style="color:#000;font-weight:bold">|</span> jq -r <span style="color:#4e9a06">&#39;.share&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#204a87;font-weight:bold">$(</span>ismounted<span style="color:#204a87;font-weight:bold">)</span> -eq <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>		log <span style="color:#4e9a06">&#39;{&#34;status&#34;: &#34;Success&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	mkdir -p <span style="color:#4e9a06">${</span><span style="color:#000">MNTPATH</span><span style="color:#4e9a06">}</span> <span style="color:#000;font-weight:bold">&amp;</span>&gt; /dev/null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	mount -t nfs <span style="color:#4e9a06">${</span><span style="color:#000">NFS_SERVER</span><span style="color:#4e9a06">}</span>:/<span style="color:#4e9a06">${</span><span style="color:#000">SHARE</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">${</span><span style="color:#000">MNTPATH</span><span style="color:#4e9a06">}</span> <span style="color:#000;font-weight:bold">&amp;</span>&gt; /dev/null
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#000">$?</span> -ne <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>		err <span style="color:#4e9a06">&#34;{ \&#34;status\&#34;: \&#34;Failure\&#34;, \&#34;message\&#34;: \&#34;Failed to mount </span><span style="color:#4e9a06">${</span><span style="color:#000">NFS_SERVER</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">:</span><span style="color:#4e9a06">${</span><span style="color:#000">SHARE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> at </span><span style="color:#4e9a06">${</span><span style="color:#000">MNTPATH</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">\&#34;}&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>	log <span style="color:#4e9a06">&#39;{&#34;status&#34;: &#34;Success&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>unmount<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MNTPATH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#204a87;font-weight:bold">$(</span>ismounted<span style="color:#204a87;font-weight:bold">)</span> -eq <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>		log <span style="color:#4e9a06">&#39;{&#34;status&#34;: &#34;Success&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	umount <span style="color:#4e9a06">${</span><span style="color:#000">MNTPATH</span><span style="color:#4e9a06">}</span> <span style="color:#000;font-weight:bold">&amp;</span>&gt; /dev/null
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#000">$?</span> -ne <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>		err <span style="color:#4e9a06">&#34;{ \&#34;status\&#34;: \&#34;Failed\&#34;, \&#34;message\&#34;: \&#34;Failed to unmount volume at </span><span style="color:#4e9a06">${</span><span style="color:#000">MNTPATH</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">\&#34;}&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	log <span style="color:#4e9a06">&#39;{&#34;status&#34;: &#34;Success&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">op</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> ! <span style="color:#204a87">command</span> -v jq &gt;/dev/null 2&gt;<span style="color:#000;font-weight:bold">&amp;</span>1<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>	err <span style="color:#4e9a06">&#34;{ \&#34;status\&#34;: \&#34;Failure\&#34;, \&#34;message\&#34;: \&#34;&#39;jq&#39; binary not found. Please install jq package before using this driver\&#34;}&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$op</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;init&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>	log <span style="color:#4e9a06">&#39;{&#34;status&#34;: &#34;Success&#34;, &#34;capabilities&#34;: {&#34;attach&#34;: false}}&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#000">$#</span> -lt <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>	usage
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">shift</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$op</span><span style="color:#4e9a06">&#34;</span> in
</span></span><span style="display:flex;"><span>	mount<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		domount <span style="color:#000">$*</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>	unmount<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		unmount <span style="color:#000">$*</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>	*<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		log <span style="color:#4e9a06">&#39;{&#34;status&#34;: &#34;Not supported&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">esac</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-storage/flexvolume.md">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-storage/flexvolume.md</a></li>
<li><a href="https://github.com/kubernetes/examples/tree/master/staging/volumes/flexvolume">https://github.com/kubernetes/examples/tree/master/staging/volumes/flexvolume</a></li>
<li><a href="https://github.com/kubernetes/examples/blob/master/staging/volumes/flexvolume/nginx-nfs.yaml">https://github.com/kubernetes/examples/blob/master/staging/volumes/flexvolume/nginx-nfs.yaml</a></li>
<li><a href="https://github.com/kubernetes/examples/blob/master/staging/volumes/flexvolume/nfs">https://github.com/kubernetes/examples/blob/master/staging/volumes/flexvolume/nfs</a></li>
</ul>

</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ee74de49b2ff835b2179a03c732c20ef">7 - 资源隔离</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-90a635123dea70113f6dcf68fb2e7363">7.1 - 资源配额</h1>
    
	<h1 id="资源配额-resourcequota">资源配额（ResourceQuota）</h1>
<p><code>ResourceQuota</code>对象用来定义某个命名空间下所有资源的使用限额，其实包括：</p>
<ul>
<li>计算资源的配额</li>
<li>存储资源的配额</li>
<li>对象数量的配额</li>
</ul>
<p>如果集群的总容量小于命名空间的配额总额，可能会产生资源竞争。这时会按照先到先得来处理。
资源竞争和配额的更新都不会影响已经创建好的资源。</p>
<h2 id="1-启动资源配额">1. 启动资源配额</h2>
<p>Kubernetes 的众多发行版本默认开启了资源配额的支持。当在apiserver的<code>--admission-control</code>配置中添加<code>ResourceQuota</code>参数后，便启用了。 当一个命名空间中含有<code>ResourceQuota</code>对象时，资源配额将强制执行。</p>
<h2 id="2-计算资源配额">2. 计算资源配额</h2>
<p>可以在给定的命名空间中限制可以请求的计算资源（<a href="https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/">compute resources</a>）的总量。</p>
<table>
<thead>
<tr>
<th>资源名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpu</td>
<td>非终止态的所有pod, cpu请求总量不能超出此值。</td>
</tr>
<tr>
<td>limits.cpu</td>
<td>非终止态的所有pod， cpu限制总量不能超出此值。</td>
</tr>
<tr>
<td>limits.memory</td>
<td>非终止态的所有pod, 内存限制总量不能超出此值。</td>
</tr>
<tr>
<td>memory</td>
<td>非终止态的所有pod, 内存请求总量不能超出此值。</td>
</tr>
<tr>
<td>requests.cpu</td>
<td>非终止态的所有pod, cpu请求总量不能超出此值。</td>
</tr>
<tr>
<td>requests.memory</td>
<td>非终止态的所有pod, 内存请求总量不能超出此值。</td>
</tr>
</tbody>
</table>
<h2 id="3-存储资源配额">3. 存储资源配额</h2>
<p>可以在给定的命名空间中限制可以请求的存储资源（<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">storage resources</a>）的总量。</p>
<table>
<thead>
<tr>
<th>资源名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>requests.storage</td>
<td>所有PVC, 存储请求总量不能超出此值。</td>
</tr>
<tr>
<td>persistentvolumeclaims</td>
<td>命名空间中可以存在的PVC（<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">persistent volume claims</a>）总数。</td>
</tr>
<tr>
<td>.storageclass.storage.k8s.io/requests.storage</td>
<td>和该存储类关联的所有PVC, 存储请求总和不能超出此值。</td>
</tr>
<tr>
<td>.storageclass.storage.k8s.io/persistentvolumeclaims</td>
<td>和该存储类关联的所有PVC，命名空间中可以存在的PVC（<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">persistent volume claims</a>）总数。</td>
</tr>
</tbody>
</table>
<h2 id="4-对象数量的配额">4. 对象数量的配额</h2>
<table>
<thead>
<tr>
<th>资源名称</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>congfigmaps</td>
<td>命名空间中可以存在的配置映射的总数。</td>
</tr>
<tr>
<td>persistentvolumeclaims</td>
<td>命名空间中可以存在的PVC总数。</td>
</tr>
<tr>
<td>pods</td>
<td>命名空间中可以存在的非终止态的pod总数。如果一个pod的<code>status.phase</code> 是 <code>Failed, Succeeded</code>, 则该pod处于终止态。</td>
</tr>
<tr>
<td>replicationcontrollers</td>
<td>命名空间中可以存在的<code>rc</code>总数。</td>
</tr>
<tr>
<td>resourcequotas</td>
<td>命名空间中可以存在的资源配额（<a href="https://kubernetes.io/docs/admin/admission-controllers/#resourcequota">resource quotas</a>）总数。</td>
</tr>
<tr>
<td>services</td>
<td>命名空间中可以存在的服务总数量。</td>
</tr>
<tr>
<td>services.loadbalancers</td>
<td>命名空间中可以存在的服务的负载均衡的总数量。</td>
</tr>
<tr>
<td>services.nodeports</td>
<td>命名空间中可以存在的服务的主机接口的总数量。</td>
</tr>
<tr>
<td>secrets</td>
<td>命名空间中可以存在的<code>secrets</code>的总数量。</td>
</tr>
</tbody>
</table>
<p>例如：可以定义pod的限额来避免某用户消耗过多的Pod IPs。</p>
<h2 id="5-限额的作用域">5. 限额的作用域</h2>
<table>
<thead>
<tr>
<th>作用域</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Terminating</td>
<td>匹配 <code>spec.activeDeadlineSeconds &gt;= 0</code> 的pod</td>
</tr>
<tr>
<td>NotTerminating</td>
<td>匹配 <code>spec.activeDeadlineSeconds is nil</code> 的pod</td>
</tr>
<tr>
<td>BestEffort</td>
<td>匹配具有最佳服务质量的pod</td>
</tr>
<tr>
<td>NotBestEffort</td>
<td>匹配具有非最佳服务质量的pod</td>
</tr>
</tbody>
</table>
<h2 id="6-request和limit">6. request和limit</h2>
<p>当分配计算资源时，每个容器可以为cpu或者内存指定一个请求值和一个限度值。可以配置限额值来限制它们中的任何一个值。
如果指定了<code>requests.cpu</code> 或者 <code>requests.memory</code>的限额值，那么就要求传入的每一个容器显式的指定这些资源的请求。如果指定了<code>limits.cpu</code>或者<code>limits.memory</code>，那么就要求传入的每一个容器显式的指定这些资源的限度。</p>
<h2 id="7-查看和设置配额">7. 查看和设置配额</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建namespace</span>
</span></span><span style="display:flex;"><span>$ kubectl create namespace myspace
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建resourcequota</span>
</span></span><span style="display:flex;"><span>$ cat <span style="color:#4e9a06">&lt;&lt;EOF &gt; compute-resources.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">kind: ResourceQuota
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  name: compute-resources
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  hard:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    pods: &#34;4&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    requests.cpu: &#34;1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    requests.memory: 1Gi
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    limits.cpu: &#34;2&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    limits.memory: 2Gi
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>$ kubectl create -f ./compute-resources.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>myspace
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查询resourcequota</span>
</span></span><span style="display:flex;"><span>$ kubectl get quota --namespace<span style="color:#ce5c00;font-weight:bold">=</span>myspace
</span></span><span style="display:flex;"><span>NAME                    AGE
</span></span><span style="display:flex;"><span>compute-resources       30s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查询resourcequota的详细信息</span>
</span></span><span style="display:flex;"><span>$ kubectl describe quota compute-resources --namespace<span style="color:#ce5c00;font-weight:bold">=</span>myspace
</span></span><span style="display:flex;"><span>Name:                  compute-resources
</span></span><span style="display:flex;"><span>Namespace:             myspace
</span></span><span style="display:flex;"><span>Resource               Used Hard
</span></span><span style="display:flex;"><span>--------               ---- ----
</span></span><span style="display:flex;"><span>limits.cpu             <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>limits.memory          <span style="color:#0000cf;font-weight:bold">0</span>    2Gi
</span></span><span style="display:flex;"><span>pods                   <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>requests.cpu           <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>requests.memory        <span style="color:#0000cf;font-weight:bold">0</span>    1Gi
</span></span></code></pre></div><h2 id="8-配额和集群容量">8. 配额和集群容量</h2>
<p>资源配额对象与集群容量无关，它们以绝对单位表示。即增加节点的资源并不会增加已经配置的namespace的资源。</p>
<p>参考文章：</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/">https://kubernetes.io/docs/concepts/policy/resource-quotas/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-796d3b5bc860b32a099f00baf9e008f2">7.2 - 资源配额</h1>
    
	<h1 id="pod限额-limitrange">Pod限额（LimitRange）</h1>
<blockquote>
<p><code>ResourceQuota</code>对象是限制某个namespace下<code>所有Pod(容器)</code>的资源限额</p>
<p><code>LimitRange</code>对象是限制某个namespace<code>单个Pod(容器</code>)的资源限额</p>
</blockquote>
<p><code>LimitRange</code>对象用来定义某个<code>命名空间</code>下某种<code>资源对象</code>的使用限额，其中资源对象包括：<code>Pod</code>、<code>Container</code>、<code>PersistentVolumeClaim</code>。</p>
<h2 id="1-为namespace配置cpu和内存的默认值">1. 为namespace配置CPU和内存的默认值</h2>
<p>如果在一个拥有默认内存或CPU限额的命名空间中创建一个容器，并且这个容器未指定它自己的内存或CPU的<code>limit</code>， 它会被分配这个默认的内存或CPU的<code>limit</code>。既没有设置pod的<code>limit</code>和<code>request</code>才会分配默认的内存或CPU的<code>request</code>。</p>
<h3 id="1-1-namespace的内存默认值">1.1. namespace的内存默认值</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建namespace</span>
</span></span><span style="display:flex;"><span>$ kubectl create namespace default-mem-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建LimitRange</span>
</span></span><span style="display:flex;"><span>$ cat memory-defaults.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: LimitRange
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: mem-limit-range
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  limits:
</span></span><span style="display:flex;"><span>  - default:
</span></span><span style="display:flex;"><span>      memory: 512Mi
</span></span><span style="display:flex;"><span>    defaultRequest:
</span></span><span style="display:flex;"><span>      memory: 256Mi
</span></span><span style="display:flex;"><span>    type: Container
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/memory-defaults.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>default-mem-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建Pod,未指定内存的limit和request</span>
</span></span><span style="display:flex;"><span>$ cat memory-defaults-pod.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: default-mem-demo
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: default-mem-demo-ctr
</span></span><span style="display:flex;"><span>    image: nginx
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/memory-defaults-pod.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>default-mem-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看Pod</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod default-mem-demo --output<span style="color:#ce5c00;font-weight:bold">=</span>yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>default-mem-example
</span></span><span style="display:flex;"><span>containers:
</span></span><span style="display:flex;"><span>- image: nginx
</span></span><span style="display:flex;"><span>  imagePullPolicy: Always
</span></span><span style="display:flex;"><span>  name: default-mem-demo-ctr
</span></span><span style="display:flex;"><span>  resources:
</span></span><span style="display:flex;"><span>    limits:
</span></span><span style="display:flex;"><span>      memory: 512Mi
</span></span><span style="display:flex;"><span>    requests:
</span></span><span style="display:flex;"><span>      memory: 256Mi
</span></span></code></pre></div><h3 id="1-2-namespace的cpu默认值">1.2. namespace的CPU默认值</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建namespace</span>
</span></span><span style="display:flex;"><span>$ kubectl create namespace default-cpu-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建LimitRange</span>
</span></span><span style="display:flex;"><span>$ cat cpu-defaults.yaml 
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: LimitRange
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: cpu-limit-range
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  limits:
</span></span><span style="display:flex;"><span>  - default:
</span></span><span style="display:flex;"><span>      cpu: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    defaultRequest:
</span></span><span style="display:flex;"><span>      cpu: 0.5
</span></span><span style="display:flex;"><span>    type: Container
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/cpu-defaults.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>default-cpu-example    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建Pod，未指定CPU的limit和request</span>
</span></span><span style="display:flex;"><span>$ cat cpu-defaults-pod.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: default-cpu-demo
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: default-cpu-demo-ctr
</span></span><span style="display:flex;"><span>    image: nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/cpu-defaults-pod.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>default-cpu-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看Pod</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod default-cpu-demo --output<span style="color:#ce5c00;font-weight:bold">=</span>yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>default-cpu-example
</span></span><span style="display:flex;"><span>containers:
</span></span><span style="display:flex;"><span>- image: nginx
</span></span><span style="display:flex;"><span>  imagePullPolicy: Always
</span></span><span style="display:flex;"><span>  name: default-cpu-demo-ctr
</span></span><span style="display:flex;"><span>  resources:
</span></span><span style="display:flex;"><span>    limits:
</span></span><span style="display:flex;"><span>      cpu: <span style="color:#4e9a06">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>    requests:
</span></span><span style="display:flex;"><span>      cpu: 500m
</span></span></code></pre></div><h3 id="1-3-说明">1.3 说明</h3>
<ol>
<li>如果没有指定pod的<code>request</code>和<code>limit</code>，则创建的pod会使用<code>LimitRange</code>对象定义的默认值（request和limit）</li>
<li>如果指定pod的<code>limit</code>但未指定<code>request</code>，则创建的pod的<code>request</code>值会取<code>limit</code>的值，而不会取LimitRange对象定义的request默认值。</li>
<li>如果指定pod的<code>request</code>但未指定<code>limit</code>，则创建的pod的<code>limit</code>值会取<code>LimitRange</code>对象定义的<code>limit</code>默认值。</li>
</ol>
<p><strong>默认Limit和request的动机</strong></p>
<p>如果命名空间具有<code>资源配额（ResourceQuota）</code>, 它为内存限额（CPU限额）设置默认值是有意义的。 以下是资源配额对命名空间施加的两个限制：</p>
<ul>
<li>在命名空间运行的每一个容器必须有它自己的内存限额（CPU限额）。</li>
<li>在命名空间中所有的容器使用的内存总量（CPU总量）不能超出指定的限额。</li>
</ul>
<p>如果一个容器没有指定它自己的内存限额（CPU限额），它将被赋予默认的限额值，然后它才可以在被配额限制的命名空间中运行。</p>
<h2 id="2-为namespace配置cpu和内存的最大最小值">2. 为namespace配置CPU和内存的最大最小值</h2>
<h3 id="2-1-内存的最大最小值">2.1. 内存的最大最小值</h3>
<p><strong>创建LimitRange</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建namespace</span>
</span></span><span style="display:flex;"><span>$ kubectl create namespace constraints-mem-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建LimitRange</span>
</span></span><span style="display:flex;"><span>$ cat memory-constraints.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: LimitRange
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: mem-min-max-demo-lr
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  limits:
</span></span><span style="display:flex;"><span>  - max:
</span></span><span style="display:flex;"><span>      memory: 1Gi
</span></span><span style="display:flex;"><span>    min:
</span></span><span style="display:flex;"><span>      memory: 500Mi
</span></span><span style="display:flex;"><span>    type: Container
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/memory-constraints.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-mem-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看LimitRange</span>
</span></span><span style="display:flex;"><span>$ kubectl get limitrange cpu-min-max-demo --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-mem-example --output<span style="color:#ce5c00;font-weight:bold">=</span>yaml
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>  limits:
</span></span><span style="display:flex;"><span>  - default:
</span></span><span style="display:flex;"><span>      memory: 1Gi
</span></span><span style="display:flex;"><span>    defaultRequest:
</span></span><span style="display:flex;"><span>      memory: 1Gi
</span></span><span style="display:flex;"><span>    max:
</span></span><span style="display:flex;"><span>      memory: 1Gi
</span></span><span style="display:flex;"><span>    min:
</span></span><span style="display:flex;"><span>      memory: 500Mi
</span></span><span style="display:flex;"><span>    type: Container
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># LimitRange设置了最大最小值，但没有设置默认值，也会被自动设置默认值。</span>
</span></span></code></pre></div><p><strong>创建符合要求的Pod</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建符合要求的Pod</span>
</span></span><span style="display:flex;"><span>$ cat memory-constraints-pod.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: constraints-mem-demo
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: constraints-mem-demo-ctr
</span></span><span style="display:flex;"><span>    image: nginx
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>      limits:
</span></span><span style="display:flex;"><span>        memory: <span style="color:#4e9a06">&#34;800Mi&#34;</span>
</span></span><span style="display:flex;"><span>      requests:
</span></span><span style="display:flex;"><span>        memory: <span style="color:#4e9a06">&#34;600Mi&#34;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/memory-constraints-pod.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-mem-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看Pod</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod constraints-mem-demo --output<span style="color:#ce5c00;font-weight:bold">=</span>yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-mem-example
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>resources:
</span></span><span style="display:flex;"><span>  limits:
</span></span><span style="display:flex;"><span>     memory: 800Mi
</span></span><span style="display:flex;"><span>  requests:
</span></span><span style="display:flex;"><span>    memory: 600Mi
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><strong>创建超过最大内存limit的pod</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat memory-constraints-pod-2.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: constraints-mem-demo-2
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: constraints-mem-demo-2-ctr
</span></span><span style="display:flex;"><span>    image: nginx
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>      limits:
</span></span><span style="display:flex;"><span>        memory: <span style="color:#4e9a06">&#34;1.5Gi&#34;</span>  <span style="color:#8f5902;font-style:italic"># 超过最大值 1Gi</span>
</span></span><span style="display:flex;"><span>      requests:
</span></span><span style="display:flex;"><span>        memory: <span style="color:#4e9a06">&#34;800Mi&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/memory-constraints-pod-2.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-mem-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Pod创建失败，因为容器指定的limit过大</span>
</span></span><span style="display:flex;"><span>Error from server <span style="color:#ce5c00;font-weight:bold">(</span>Forbidden<span style="color:#ce5c00;font-weight:bold">)</span>: error when creating <span style="color:#4e9a06">&#34;docs/tasks/administer-cluster/memory-constraints-pod-2.yaml&#34;</span>:
</span></span><span style="display:flex;"><span>pods <span style="color:#4e9a06">&#34;constraints-mem-demo-2&#34;</span> is forbidden: maximum memory usage per Container is 1Gi, but limit is 1536Mi.
</span></span></code></pre></div><p><strong>创建小于最小内存request的Pod</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat memory-constraints-pod-3.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: constraints-mem-demo-3
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: constraints-mem-demo-3-ctr
</span></span><span style="display:flex;"><span>    image: nginx
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>      limits:
</span></span><span style="display:flex;"><span>        memory: <span style="color:#4e9a06">&#34;800Mi&#34;</span>
</span></span><span style="display:flex;"><span>      requests:
</span></span><span style="display:flex;"><span>        memory: <span style="color:#4e9a06">&#34;100Mi&#34;</span>   <span style="color:#8f5902;font-style:italic"># 小于最小值500Mi</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/memory-constraints-pod-3.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-mem-example         
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Pod创建失败，因为容器指定的内存request过小</span>
</span></span><span style="display:flex;"><span>Error from server <span style="color:#ce5c00;font-weight:bold">(</span>Forbidden<span style="color:#ce5c00;font-weight:bold">)</span>: error when creating <span style="color:#4e9a06">&#34;docs/tasks/administer-cluster/memory-constraints-pod-3.yaml&#34;</span>:
</span></span><span style="display:flex;"><span>pods <span style="color:#4e9a06">&#34;constraints-mem-demo-3&#34;</span> is forbidden: minimum memory usage per Container is 500Mi, but request is 100Mi.
</span></span></code></pre></div><p><strong>创建没有指定任何内存limit和request的pod</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat memory-constraints-pod-4.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: constraints-mem-demo-4
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: constraints-mem-demo-4-ctr
</span></span><span style="display:flex;"><span>    image: nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/memory-constraints-pod-4.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-mem-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看Pod</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod constraints-mem-demo-4 --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-mem-example --output<span style="color:#ce5c00;font-weight:bold">=</span>yaml
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>resources:
</span></span><span style="display:flex;"><span>  limits:
</span></span><span style="display:flex;"><span>    memory: 1Gi
</span></span><span style="display:flex;"><span>  requests:
</span></span><span style="display:flex;"><span>    memory: 1Gi
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>容器没有指定自己的 CPU 请求和限制，所以它将从 LimitRange 获取默认的 CPU 请求和限制值。</p>
<h3 id="2-2-cpu的最大最小值">2.2. CPU的最大最小值</h3>
<p><strong>创建LimitRange</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建namespace</span>
</span></span><span style="display:flex;"><span>$ kubectl create namespace constraints-cpu-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建LimitRange</span>
</span></span><span style="display:flex;"><span>$ cat cpu-constraints.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: LimitRange
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: cpu-min-max-demo-lr
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  limits:
</span></span><span style="display:flex;"><span>  - max:
</span></span><span style="display:flex;"><span>      cpu: <span style="color:#4e9a06">&#34;800m&#34;</span>
</span></span><span style="display:flex;"><span>    min:
</span></span><span style="display:flex;"><span>      cpu: <span style="color:#4e9a06">&#34;200m&#34;</span>
</span></span><span style="display:flex;"><span>    type: Container
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/cpu-constraints.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-cpu-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看LimitRange</span>
</span></span><span style="display:flex;"><span>$ kubectl get limitrange cpu-min-max-demo-lr --output<span style="color:#ce5c00;font-weight:bold">=</span>yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-cpu-example
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>limits:
</span></span><span style="display:flex;"><span>- default:
</span></span><span style="display:flex;"><span>    cpu: 800m
</span></span><span style="display:flex;"><span>  defaultRequest:
</span></span><span style="display:flex;"><span>    cpu: 800m
</span></span><span style="display:flex;"><span>  max:
</span></span><span style="display:flex;"><span>    cpu: 800m
</span></span><span style="display:flex;"><span>  min:
</span></span><span style="display:flex;"><span>    cpu: 200m
</span></span><span style="display:flex;"><span>  type: Container
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><strong>创建符合要求的Pod</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat cpu-constraints-pod.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: constraints-cpu-demo
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: constraints-cpu-demo-ctr
</span></span><span style="display:flex;"><span>    image: nginx
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>      limits:
</span></span><span style="display:flex;"><span>        cpu: <span style="color:#4e9a06">&#34;800m&#34;</span>
</span></span><span style="display:flex;"><span>      requests:
</span></span><span style="display:flex;"><span>        cpu: <span style="color:#4e9a06">&#34;500m&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/cpu-constraints-pod.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-cpu-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看Pod</span>
</span></span><span style="display:flex;"><span>$ kubectl get pod constraints-cpu-demo --output<span style="color:#ce5c00;font-weight:bold">=</span>yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-cpu-example
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>resources:
</span></span><span style="display:flex;"><span>  limits:
</span></span><span style="display:flex;"><span>    cpu: 800m
</span></span><span style="display:flex;"><span>  requests:
</span></span><span style="display:flex;"><span>    cpu: 500m
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p><strong>创建超过最大CPU limit的Pod</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat cpu-constraints-pod-2.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: constraints-cpu-demo-2
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: constraints-cpu-demo-2-ctr
</span></span><span style="display:flex;"><span>    image: nginx
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>      limits:
</span></span><span style="display:flex;"><span>        cpu: <span style="color:#4e9a06">&#34;1.5&#34;</span>
</span></span><span style="display:flex;"><span>      requests:
</span></span><span style="display:flex;"><span>        cpu: <span style="color:#4e9a06">&#34;500m&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/cpu-constraints-pod-2.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-cpu-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Pod创建失败，因为容器指定的CPU limit过大</span>
</span></span><span style="display:flex;"><span>Error from server <span style="color:#ce5c00;font-weight:bold">(</span>Forbidden<span style="color:#ce5c00;font-weight:bold">)</span>: error when creating <span style="color:#4e9a06">&#34;docs/tasks/administer-cluster/cpu-constraints-pod-2.yaml&#34;</span>:
</span></span><span style="display:flex;"><span>pods <span style="color:#4e9a06">&#34;constraints-cpu-demo-2&#34;</span> is forbidden: maximum cpu usage per Container is 800m, but limit is 1500m.
</span></span></code></pre></div><p><strong>创建小于最小CPU request的Pod</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat cpu-constraints-pod-3.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: constraints-cpu-demo-4
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: constraints-cpu-demo-4-ctr
</span></span><span style="display:flex;"><span>    image: nginx
</span></span><span style="display:flex;"><span>    resources:
</span></span><span style="display:flex;"><span>      limits:
</span></span><span style="display:flex;"><span>        cpu: <span style="color:#4e9a06">&#34;800m&#34;</span>
</span></span><span style="display:flex;"><span>      requests:
</span></span><span style="display:flex;"><span>        cpu: <span style="color:#4e9a06">&#34;100m&#34;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/cpu-constraints-pod-3.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-cpu-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Pod创建失败，因为容器指定的CPU request过小</span>
</span></span><span style="display:flex;"><span>Error from server <span style="color:#ce5c00;font-weight:bold">(</span>Forbidden<span style="color:#ce5c00;font-weight:bold">)</span>: error when creating <span style="color:#4e9a06">&#34;docs/tasks/administer-cluster/cpu-constraints-pod-3.yaml&#34;</span>:
</span></span><span style="display:flex;"><span>pods <span style="color:#4e9a06">&#34;constraints-cpu-demo-4&#34;</span> is forbidden: minimum cpu usage per Container is 200m, but request is 100m.
</span></span></code></pre></div><p><strong>创建没有指定任何CPU limit和request的pod</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat cpu-constraints-pod-4.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Pod
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: constraints-cpu-demo-4
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  containers:
</span></span><span style="display:flex;"><span>  - name: constraints-cpu-demo-4-ctr
</span></span><span style="display:flex;"><span>    image: vish/stress
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>$ kubectl create -f https://k8s.io/docs/tasks/administer-cluster/cpu-constraints-pod-4.yaml --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-cpu-example    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看Pod</span>
</span></span><span style="display:flex;"><span>kubectl get pod constraints-cpu-demo-4 --namespace<span style="color:#ce5c00;font-weight:bold">=</span>constraints-cpu-example --output<span style="color:#ce5c00;font-weight:bold">=</span>yaml
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>resources:
</span></span><span style="display:flex;"><span>  limits:
</span></span><span style="display:flex;"><span>    cpu: 800m
</span></span><span style="display:flex;"><span>  requests:
</span></span><span style="display:flex;"><span>    cpu: 800m
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>容器没有指定自己的 CPU 请求和限制，所以它将从 LimitRange 获取默认的 CPU 请求和限制值。</p>
<h3 id="2-3-说明">2.3. 说明</h3>
<p>LimitRange 在 namespace 中施加的最小和最大内存（CPU）限制只有在创建和更新 Pod 时才会被应用。改变 LimitRange 不会对之前创建的 Pod 造成影响。</p>
<p>Kubernetes 都会执行下列步骤：</p>
<ul>
<li>如果容器没有指定自己的内存（CPU）请求（request）和限制（limit），系统将会为其分配默认值。</li>
<li>验证容器的内存（CPU）请求大于等于最小值。</li>
<li>验证容器的内存（CPU）限制小于等于最大值。</li>
</ul>
<p>参考文章：</p>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/">https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/">https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/cpu-default-namespace/</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/">https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-constraint-namespace/</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/">https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/cpu-constraint-namespace/</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/quota-memory-cpu-namespace/">https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/quota-memory-cpu-namespace/</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2c52aafd2af1a9cb401a3aa6ee690663">7.3 - 资源服务质量</h1>
    
	<h1 id="resource-quality-of-service">Resource Quality of Service</h1>
<h2 id="1-资源qos简介">1. 资源QoS简介</h2>
<p><code>request</code>值表示容器保证可被分配到资源。<code>limit</code>表示容器可允许使用的最大资源。Pod级别的<code>request</code>和<code>limit</code>是其所有容器的request和limit之和。</p>
<h2 id="2-requests-and-limits">2. Requests and Limits</h2>
<p>Pod可以指定<code>request</code>和<code>limit</code>资源。其中<code>0 &lt;= request &lt;=</code><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/node-allocatable.md"><code>Node Allocatable</code></a> &amp; <code>request &lt;= limit &lt;= Infinity</code>。调度是基于<code>request</code>而不是<code>limit</code>，即如果Pod被成功调度，那么可以保证Pod分配到指定的 <code>request</code>的资源。Pod使用的资源能否超过指定的<code>limit</code>值取决于该资源是否可被压缩。</p>
<h3 id="2-1-可压缩的资源">2.1. 可压缩的资源</h3>
<ul>
<li>目前只支持CPU</li>
<li>pod可以保证获得它们请求的CPU数量，它们可能会也可能不会获得额外的CPU时间(取决于正在运行的其他作业)。因为目前CPU隔离是在容器级别而不是pod级别。</li>
</ul>
<h3 id="2-2-不可压缩的资源">2.2. 不可压缩的资源</h3>
<ul>
<li>目前只支持内存</li>
<li>pod将获得它们请求的内存数量，如果超过了它们的内存请求，它们可能会被杀死(如果其他一些pod需要内存)，但如果pod消耗的内存小于请求的内存，那么它们将不会被杀死(除非在系统任务或守护进程需要更多内存的情况下)。</li>
</ul>
<h2 id="3-qos-级别">3. QoS 级别</h2>
<p>在机器资源超卖的情况下（limit的总量大于机器的资源容量），即CPU或内存耗尽，将不得不杀死部分不重要的容器。因此对容器分成了3个<code>QoS</code>的级别：<code>Guaranteed</code>,<code> Burstable</code>,  <code>Best-Effort</code>，三个级别的优先级依次递减。</p>
<p>当CPU资源无法满足，pod不会被杀死可能被短暂控制。</p>
<p>内存是不可压缩的资源，当内存耗尽的情况下，会依次杀死优先级低的容器。Guaranteed的级别最高，不会被杀死，除非容器使用量超过limit限值或者资源耗尽，已经没有更低级别的容器可驱逐。</p>
<h3 id="3-1-guaranteed">3.1. Guaranteed</h3>
<p>所有的容器的<code>limit</code>值和<code>request</code>值被配置且两者相等（如果只配置limit没有request，则request取值于limit）。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 示例1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">100Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 示例2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">100Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">100Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="3-2-burstable">3.2. Burstable</h3>
<p>如果一个或多个容器的limit和request值被配置且两者不相等。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 示例1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 示例2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 示例3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="3-3-best-effort">3.3. Best-Effort</h3>
<p>所有的容器的<code>limit</code>和<code>request</code>值都没有配置。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>参考文章：</p>
<ul>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md">https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/resource-qos.md</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fd3c3a410347b1bb7067ca48715d2dbe">7.4 - Lxcfs资源视图隔离</h1>
    
	<h1 id="1-资源视图隔离">1. 资源视图隔离</h1>
<p>容器中的执行<code>top</code>、<code>free</code>等命令展示出来的CPU，内存等信息是从<code>/proc</code>目录中的相关文件里读取出来的。而容器并没有对<code>/proc</code>，<code>/sys</code>等文件系统做隔离，因此容器中读取出来的CPU和内存的信息是宿主机的信息，与容器实际分配和限制的资源量不同。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/proc/cpuinfo
</span></span><span style="display:flex;"><span>/proc/diskstats
</span></span><span style="display:flex;"><span>/proc/meminfo
</span></span><span style="display:flex;"><span>/proc/stat
</span></span><span style="display:flex;"><span>/proc/swaps
</span></span><span style="display:flex;"><span>/proc/uptime
</span></span></code></pre></div><p>为了实现让容器内部的资源视图更像虚拟机，使得应用程序可以拿到真实的CPU和内存信息，就需要通过文件挂载的方式将cgroup的真实的容器资源信息挂载到容器内<code>/proc</code>下的文件，使得容器内执行top、free等命令时可以拿到真实的CPU和内存信息。</p>
<h1 id="2-lxcfs简介">2. Lxcfs简介</h1>
<p>lxcfs是一个FUSE文件系统，使得Linux容器的文件系统更像虚拟机。lxcfs是一个常驻进程运行在宿主机上，从而来自动维护宿主机cgroup中容器的真实资源信息与容器内<code>/proc</code>下文件的映射关系。</p>
<p>lxcfs的命令信息如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#/usr/local/bin/lxcfs -h</span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lxcfs <span style="color:#ce5c00;font-weight:bold">[</span>-f<span style="color:#000;font-weight:bold">|</span>-d<span style="color:#ce5c00;font-weight:bold">]</span> -u -l -n <span style="color:#ce5c00;font-weight:bold">[</span>-p pidfile<span style="color:#ce5c00;font-weight:bold">]</span> mountpoint
</span></span><span style="display:flex;"><span>  -f running foreground by default<span style="color:#000;font-weight:bold">;</span> -d <span style="color:#204a87">enable</span> debug output
</span></span><span style="display:flex;"><span>  -l use loadavg
</span></span><span style="display:flex;"><span>  -u no swap
</span></span><span style="display:flex;"><span>  Default pidfile is /run/lxcfs.pid
</span></span><span style="display:flex;"><span>lxcfs -h
</span></span></code></pre></div><p>lxcfs的源码：https://github.com/lxc/lxcfs</p>
<h1 id="3-lxcfs原理">3. Lxcfs原理</h1>
<p>lxcfs实现的基本原理是通过文件挂载的方式，把cgroup中容器相关的信息读取出来，存储到lxcfs相关的目录下，并将相关目录映射到容器内的/proc目录下，从而使得容器内执行top,free等命令时拿到的/proc下的数据是真实的cgroup分配给容器的CPU和内存数据。</p>
<p><strong>原理图</strong></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1626002975/article/kubernetes/resource/lxcfs/lxcfs.webp" alt="lxcfs"></p>
<p><strong>映射目录</strong></p>
<table>
<thead>
<tr>
<th>类别</th>
<th>容器内目录</th>
<th>宿主机lxcfs目录</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpu</td>
<td>/proc/cpuinfo</td>
<td>/var/lib/lxcfs/{container_id}/proc/cpuinfo</td>
</tr>
<tr>
<td>内存</td>
<td>/proc/meminfo</td>
<td>/var/lib/lxcfs/{container_id}/proc/meminfo</td>
</tr>
<tr>
<td></td>
<td>/proc/diskstats</td>
<td>/var/lib/lxcfs/{container_id}/proc/diskstats</td>
</tr>
<tr>
<td></td>
<td>/proc/stat</td>
<td>/var/lib/lxcfs/{container_id}/proc/stat</td>
</tr>
<tr>
<td></td>
<td>/proc/swaps</td>
<td>/var/lib/lxcfs/{container_id}/proc/swaps</td>
</tr>
<tr>
<td></td>
<td>/proc/uptime</td>
<td>/var/lib/lxcfs/{container_id}/proc/uptime</td>
</tr>
<tr>
<td></td>
<td>/proc/loadavg</td>
<td>/var/lib/lxcfs/{container_id}/proc/loadavg</td>
</tr>
<tr>
<td></td>
<td>/sys/devices/system/cpu/online</td>
<td>/var/lib/lxcfs/{container_id}/sys/devices/system/cpu/online</td>
</tr>
</tbody>
</table>
<h1 id="4-使用方式">4. 使用方式</h1>
<h2 id="4-1-安装lxcfs">4.1. 安装lxcfs</h2>
<p>环境准备</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install -y fuse fuse-lib fuse-devel
</span></span></code></pre></div><p>源码编译安装</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone git://github.com/lxc/lxcfs
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> lxcfs
</span></span><span style="display:flex;"><span>./bootstrap.sh
</span></span><span style="display:flex;"><span>./configure
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>make install
</span></span></code></pre></div><p>或者通过rpm包安装</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://copr-be.cloud.fedoraproject.org/results/ganto/lxc3/epel-7-x86_64/01041891-lxcfs/lxcfs-3.1.2-0.2.el7.x86_64.rpm<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>rpm -ivh lxcfs-3.1.2-0.2.el7.x86_64.rpm --force --nodeps
</span></span></code></pre></div><p>查看是否安装成功</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>lxcfs -h
</span></span></code></pre></div><h2 id="4-2-运行lxcfs">4.2. 运行lxcfs</h2>
<p>运行lxcfs主要执行两条命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir -p /var/lib/lxcfs
</span></span><span style="display:flex;"><span>sudo lxcfs /var/lib/lxcfs
</span></span></code></pre></div><p>可以通过systemd运行。</p>
<p>lxcfs.service文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt; /usr/lib/systemd/system/lxcfs.service <span style="color:#4e9a06">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Description=lxcfs
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=/usr/bin/lxcfs -f /var/lib/lxcfs
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Restart=on-failure
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">#ExecReload=/bin/kill -s SIGHUP $MAINPID
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><p>运行命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> systemctl <span style="color:#204a87">enable</span> lxcfs <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> systemctl start lxcfs <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> systemctl status lxcfs 
</span></span></code></pre></div><h2 id="4-3-挂载容器内-proc-下的文件目录">4.3. 挂载容器内<code>/proc</code>下的文件目录</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -it --rm -m 256m  --cpus <span style="color:#0000cf;font-weight:bold">2</span>  <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>      -v /var/lib/lxcfs/proc/cpuinfo:/proc/cpuinfo:rw <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>      -v /var/lib/lxcfs/proc/diskstats:/proc/diskstats:rw <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>      -v /var/lib/lxcfs/proc/meminfo:/proc/meminfo:rw <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>      -v /var/lib/lxcfs/proc/stat:/proc/stat:rw <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>      -v /var/lib/lxcfs/proc/swaps:/proc/swaps:rw <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>      -v /var/lib/lxcfs/proc/uptime:/proc/uptime:rw <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>      nginx:latest /bin/sh
</span></span></code></pre></div><h2 id="4-4-验证容器内cpu和内存">4.4. 验证容器内CPU和内存</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cpu</span>
</span></span><span style="display:flex;"><span>grep -c processor /proc/cpuinfo
</span></span><span style="display:flex;"><span>cat /proc/cpuinfo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># memory</span>
</span></span><span style="display:flex;"><span>free -g
</span></span><span style="display:flex;"><span>cat /proc/meminfo
</span></span></code></pre></div><h1 id="5-使用k8s集群部署">5. 使用k8s集群部署</h1>
<p>使用k8s集群部署与systemd部署方式同理，需要解决2个问题：</p>
<ol>
<li>在每个node节点上部署lxcfs常驻进程，lxcfs需要通过镜像来运行，可以通过daemonset来部署。</li>
<li>实现将lxcfs维护的目录自动挂载到pod内的<code>/proc</code>目录。</li>
</ol>
<p>具体可参考：https://github.com/denverdino/lxcfs-admission-webhook</p>
<h2 id="5-1-lxcfs-image">5.1. lxcfs-image</h2>
<p><a href="https://github.com/denverdino/lxcfs-admission-webhook/blob/master/lxcfs-image/Dockerfile">Dockerfile</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>FROM centos:7 as build
</span></span><span style="display:flex;"><span>RUN yum -y update
</span></span><span style="display:flex;"><span>RUN yum -y install fuse-devel pam-devel wget install gcc automake autoconf libtool make
</span></span><span style="display:flex;"><span>ENV LXCFS_VERSION 3.1.2
</span></span><span style="display:flex;"><span>RUN wget https://linuxcontainers.org/downloads/lxcfs/lxcfs-<span style="color:#000">$LXCFS_VERSION</span>.tar.gz <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	mkdir /lxcfs <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> tar xzvf lxcfs-<span style="color:#000">$LXCFS_VERSION</span>.tar.gz -C /lxcfs  --strip-components<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	<span style="color:#204a87">cd</span> /lxcfs <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./configure <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> make
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FROM centos:7
</span></span><span style="display:flex;"><span>STOPSIGNAL SIGINT
</span></span><span style="display:flex;"><span>COPY --from<span style="color:#ce5c00;font-weight:bold">=</span>build /lxcfs/lxcfs /usr/local/bin/lxcfs
</span></span><span style="display:flex;"><span>COPY --from<span style="color:#ce5c00;font-weight:bold">=</span>build /lxcfs/.libs/liblxcfs.so /usr/local/lib/lxcfs/liblxcfs.so
</span></span><span style="display:flex;"><span>COPY --from<span style="color:#ce5c00;font-weight:bold">=</span>build /lxcfs/lxcfs /lxcfs/lxcfs
</span></span><span style="display:flex;"><span>COPY --from<span style="color:#ce5c00;font-weight:bold">=</span>build /lxcfs/.libs/liblxcfs.so /lxcfs/liblxcfs.so
</span></span><span style="display:flex;"><span>COPY --from<span style="color:#ce5c00;font-weight:bold">=</span>build /usr/lib64/libfuse.so.2.9.2 /usr/lib64/libfuse.so.2.9.2
</span></span><span style="display:flex;"><span>COPY --from<span style="color:#ce5c00;font-weight:bold">=</span>build /usr/lib64/libulockmgr.so.1.0.1 /usr/lib64/libulockmgr.so.1.0.1
</span></span><span style="display:flex;"><span>RUN ln -s /usr/lib64/libfuse.so.2.9.2 /usr/lib64/libfuse.so.2 <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    ln -s /usr/lib64/libulockmgr.so.1.0.1 /usr/lib64/libulockmgr.so.1
</span></span><span style="display:flex;"><span>COPY start.sh /
</span></span><span style="display:flex;"><span>CMD <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#4e9a06">&#34;/start.sh&#34;</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>star.sh</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Cleanup</span>
</span></span><span style="display:flex;"><span>nsenter -m/proc/1/ns/mnt fusermount -u /var/lib/lxcfs 2&gt; /dev/null <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>nsenter -m/proc/1/ns/mnt <span style="color:#ce5c00;font-weight:bold">[</span> -L /etc/mtab <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>        sed -i <span style="color:#4e9a06">&#34;/^lxcfs \/var\/lib\/lxcfs fuse.lxcfs/d&#34;</span> /etc/mtab
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Prepare</span>
</span></span><span style="display:flex;"><span>mkdir -p /usr/local/lib/lxcfs /var/lib/lxcfs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Update lxcfs</span>
</span></span><span style="display:flex;"><span>cp -f /lxcfs/lxcfs /usr/local/bin/lxcfs
</span></span><span style="display:flex;"><span>cp -f /lxcfs/liblxcfs.so /usr/local/lib/lxcfs/liblxcfs.so
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Mount</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">exec</span> nsenter -m/proc/1/ns/mnt /usr/local/bin/lxcfs /var/lib/lxcfs/
</span></span></code></pre></div><h2 id="5-2-daemonset">5.2. daemonset</h2>
<p><a href="https://github.com/denverdino/lxcfs-admission-webhook/blob/master/deployment/lxcfs-daemonset.yaml">lxcfs-daemonset.yaml</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DaemonSet</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hostPID</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">tolerations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node-role.kubernetes.io/master</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">effect</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NoSchedule</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">registry.cn-hangzhou.aliyuncs.com/denverdino/lxcfs:3.1.2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Always</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">securityContext</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">privileged</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cgroup</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/sys/fs/cgroup</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/lxcfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">mountPropagation</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Bidirectional</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">usr-local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/usr/local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cgroup</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/sys/fs/cgroup</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">usr-local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/usr/local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/lxcfs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DirectoryOrCreate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="5-3-lxcfs-admission-webhook-https-github-com-denverdino-lxcfs-admission-webhook">5.3. <a href="https://github.com/denverdino/lxcfs-admission-webhook">lxcfs-admission-webhook</a></h2>
<p><code>lxcfs-admission-webhook</code>实现了一个动态的准入webhook，更准确的讲是实现了一个<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#mutatingadmissionwebhook">修改性质的webhook</a>，即监听pod的创建，然后对pod执行patch的操作，从而将lxcfs与容器内的目录映射关系植入到pod创建的yaml中从而实现自动挂载。</p>
<p><a href="https://github.com/denverdino/lxcfs-admission-webhook/blob/master/deployment/deployment.yaml">deployment</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs-admission-webhook-deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs-admission-webhook</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs-admission-webhook</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs-admission-webhook</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs-admission-webhook</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">registry.cn-hangzhou.aliyuncs.com/denverdino/lxcfs-admission-webhook:v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">IfNotPresent</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- -<span style="color:#000">tlsCertFile=/etc/webhook/certs/cert.pem</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- -<span style="color:#000">tlsKeyFile=/etc/webhook/certs/key.pem</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- -<span style="color:#000">alsologtostderr</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- -<span style="color:#000">v=4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000">&gt;&amp;1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webhook-certs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/webhook/certs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">readOnly</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webhook-certs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">secret</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">secretName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lxcfs-admission-webhook-certs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>具体部署参考:<a href="https://github.com/denverdino/lxcfs-admission-webhook/blob/master/deployment/install.sh">install.sh</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>./deployment/webhook-create-signed-cert.sh
</span></span><span style="display:flex;"><span>kubectl get secret lxcfs-admission-webhook-certs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl create -f deployment/deployment.yaml
</span></span><span style="display:flex;"><span>kubectl create -f deployment/service.yaml
</span></span><span style="display:flex;"><span>cat ./deployment/mutatingwebhook.yaml <span style="color:#000;font-weight:bold">|</span> ./deployment/webhook-patch-ca-bundle.sh &gt; ./deployment/mutatingwebhook-ca-bundle.yaml
</span></span><span style="display:flex;"><span>kubectl create -f deployment/mutatingwebhook-ca-bundle.yaml
</span></span></code></pre></div><p>执行命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/deployment/install.sh
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/lxc/lxcfs">https://github.com/lxc/lxcfs</a></li>
<li><a href="https://linuxcontainers.org/lxcfs/">https://linuxcontainers.org/lxcfs/</a></li>
<li><a href="https://github.com/denverdino/lxcfs-admission-webhook">https://github.com/denverdino/lxcfs-admission-webhook</a></li>
<li><a href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/">https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0a93c2b2a683132635d874129a40fc3f">8 - 运维指南</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0a7fd438eac53912c7bdc3b6f6fcbc2a">8.1 - Kubernetes集群问题排查</h1>
    
	<h1 id="1-查看系统event事件">1. 查看系统Event事件</h1>
<pre tabindex="0"><code>kubectl describe pod &lt;PodName&gt; --namespace=&lt;NAMESPACE&gt; 
</code></pre><p>该命令可以显示Pod创建时的配置定义、状态等信息和最近的Event事件，事件信息可用于排错。例如当Pod状态为Pending，可通过查看Event事件确认原因，一般原因有几种：</p>
<ul>
<li>没有可用的Node可调度</li>
<li>开启了资源配额管理并且当前Pod的目标节点上恰好没有可用的资源</li>
<li>正在下载镜像（镜像拉取耗时太久）或镜像下载失败。</li>
</ul>
<p>kubectl describe还可以查看其它k8s对象：NODE,RC,Service,Namespace,Secrets。</p>
<h2 id="1-1-pod">1.1. Pod</h2>
<pre tabindex="0"><code>kubectl describe pod &lt;PodName&gt; --namespace=&lt;NAMESPACE&gt;
</code></pre><p>以下是容器的启动命令非阻塞式导致容器挂掉，被k8s频繁重启所产生的事件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl describe pod &lt;PodName&gt; --namespace<span style="color:#ce5c00;font-weight:bold">=</span>&lt;NAMESPACE&gt;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  FirstSeen LastSeen    Count   From            SubobjectPath       Reason      Message
</span></span><span style="display:flex;"><span>  ───────── ────────    ─────   ────            ─────────────       ──────      ───────
</span></span><span style="display:flex;"><span>  7m        7m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>scheduler <span style="color:#ce5c00;font-weight:bold">}</span>                    Scheduled   Successfully assigned yangsc-1-0-0-index0 to 10.8.216.19
</span></span><span style="display:flex;"><span>  7m        7m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>infra<span style="color:#ce5c00;font-weight:bold">}</span>   Pulled      Container image <span style="color:#4e9a06">&#34;gcr.io/kube-system/pause:0.8.0&#34;</span> already present on machine
</span></span><span style="display:flex;"><span>  7m        7m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>infra<span style="color:#ce5c00;font-weight:bold">}</span>   Created     Created with docker id 84f133c324d0
</span></span><span style="display:flex;"><span>  7m        7m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>infra<span style="color:#ce5c00;font-weight:bold">}</span>   Started     Started with docker id 84f133c324d0
</span></span><span style="display:flex;"><span>  7m        7m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Started     Started with docker id 3f9f82abb145
</span></span><span style="display:flex;"><span>  7m        7m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Created     Created with docker id 3f9f82abb145
</span></span><span style="display:flex;"><span>  7m        7m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Created     Created with docker id fb112e4002f4
</span></span><span style="display:flex;"><span>  7m        7m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Started     Started with docker id fb112e4002f4
</span></span><span style="display:flex;"><span>  6m        6m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Created     Created with docker id 613b119d4474
</span></span><span style="display:flex;"><span>  6m        6m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Started     Started with docker id 613b119d4474
</span></span><span style="display:flex;"><span>  6m        6m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Created     Created with docker id 25cb68d1fd3d
</span></span><span style="display:flex;"><span>  6m        6m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Started     Started with docker id 25cb68d1fd3d
</span></span><span style="display:flex;"><span>  5m        5m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Started     Started with docker id 7d9ee8610b28
</span></span><span style="display:flex;"><span>  5m        5m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Created     Created with docker id 7d9ee8610b28
</span></span><span style="display:flex;"><span>  3m        3m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Started     Started with docker id 88b9e8d582dd
</span></span><span style="display:flex;"><span>  3m        3m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Created     Created with docker id 88b9e8d582dd
</span></span><span style="display:flex;"><span>  7m        1m      <span style="color:#0000cf;font-weight:bold">7</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Pulling     Pulling image <span style="color:#4e9a06">&#34;gcr.io/test/tcp-hello:1.0.0&#34;</span>
</span></span><span style="display:flex;"><span>  1m        1m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Started     Started with docker id 089abff050e7
</span></span><span style="display:flex;"><span>  1m        1m      <span style="color:#0000cf;font-weight:bold">1</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Created     Created with docker id 089abff050e7
</span></span><span style="display:flex;"><span>  7m        1m      <span style="color:#0000cf;font-weight:bold">7</span>   <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Pulled      Successfully pulled image <span style="color:#4e9a06">&#34;gcr.io/test/tcp-hello:1.0.0&#34;</span>
</span></span><span style="display:flex;"><span>  6m        7s      <span style="color:#0000cf;font-weight:bold">34</span>  <span style="color:#ce5c00;font-weight:bold">{</span>kubelet 10.8.216.19<span style="color:#ce5c00;font-weight:bold">}</span>   containers<span style="color:#ce5c00;font-weight:bold">{</span>yangsc0<span style="color:#ce5c00;font-weight:bold">}</span> Backoff     Back-off restarting failed docker container
</span></span></code></pre></div><h2 id="1-2-node">1.2. NODE</h2>
<pre tabindex="0"><code>kubectl describe node 10.8.216.20
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@FC-43745A-10 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># kubectl describe node 10.8.216.20  </span>
</span></span><span style="display:flex;"><span>Name:           10.8.216.20  
</span></span><span style="display:flex;"><span>Labels:         kubernetes.io/hostname<span style="color:#ce5c00;font-weight:bold">=</span>10.8.216.20,namespace/bcs-cc<span style="color:#ce5c00;font-weight:bold">=</span>true,namespace/myview<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>  
</span></span><span style="display:flex;"><span>CreationTimestamp:  Mon, <span style="color:#0000cf;font-weight:bold">17</span> Apr <span style="color:#0000cf;font-weight:bold">2017</span> 11:32:52 +0800  
</span></span><span style="display:flex;"><span>Phase:            
</span></span><span style="display:flex;"><span>Conditions:  
</span></span><span style="display:flex;"><span>  Type      Status  LastHeartbeatTime           LastTransitionTime          Reason              Message  
</span></span><span style="display:flex;"><span>  ────      ──────  ─────────────────           ──────────────────          ──────              ───────  
</span></span><span style="display:flex;"><span>  Ready     True    Fri, <span style="color:#0000cf;font-weight:bold">18</span> Aug <span style="color:#0000cf;font-weight:bold">2017</span> 09:38:33 +0800     Tue, <span style="color:#0000cf;font-weight:bold">02</span> May <span style="color:#0000cf;font-weight:bold">2017</span> 17:40:58 +0800     KubeletReady            kubelet is posting ready status  
</span></span><span style="display:flex;"><span>  OutOfDisk     False   Fri, <span style="color:#0000cf;font-weight:bold">18</span> Aug <span style="color:#0000cf;font-weight:bold">2017</span> 09:38:33 +0800     Mon, <span style="color:#0000cf;font-weight:bold">17</span> Apr <span style="color:#0000cf;font-weight:bold">2017</span> 11:31:27 +0800     KubeletHasSufficientDisk    kubelet has sufficient disk space available  
</span></span><span style="display:flex;"><span>Addresses:  10.8.216.20,10.8.216.20  
</span></span><span style="display:flex;"><span>Capacity:  
</span></span><span style="display:flex;"><span> cpu:       <span style="color:#0000cf;font-weight:bold">32</span>  
</span></span><span style="display:flex;"><span> memory:    <span style="color:#0000cf;font-weight:bold">67323039744</span>  
</span></span><span style="display:flex;"><span> pods:      <span style="color:#0000cf;font-weight:bold">40</span>  
</span></span><span style="display:flex;"><span>System Info:  
</span></span><span style="display:flex;"><span> Machine ID:            723bafc7f6764022972b3eae1ce6b198  
</span></span><span style="display:flex;"><span> System UUID:           4C4C4544-0042-4210-8044-C3C04F595631  
</span></span><span style="display:flex;"><span> Boot ID:           da01f2e3-987a-425a-9ca7-1caaec35d1e5  
</span></span><span style="display:flex;"><span> Kernel Version:        3.10.0-327.28.3.el7.x86_64  
</span></span><span style="display:flex;"><span> OS Image:          CentOS Linux <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#ce5c00;font-weight:bold">(</span>Core<span style="color:#ce5c00;font-weight:bold">)</span>  
</span></span><span style="display:flex;"><span> Container Runtime Version: docker://1.13.1  
</span></span><span style="display:flex;"><span> Kubelet Version:       v1.1.1-xxx2-13.1+79c90c68bfb72f-dirty  
</span></span><span style="display:flex;"><span> Kube-Proxy Version:        v1.1.1-xxx2-13.1+79c90c68bfb72f-dirty  
</span></span><span style="display:flex;"><span>ExternalID:         10.8.216.20  
</span></span><span style="display:flex;"><span>Non-terminated Pods:        <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span> in total<span style="color:#ce5c00;font-weight:bold">)</span>  
</span></span><span style="display:flex;"><span>  Namespace         Name                    CPU Requests    CPU Limits  Memory Requests Memory Limits  
</span></span><span style="display:flex;"><span>  ─────────         ────                    ────────────    ──────────  ─────────────── ─────────────  
</span></span><span style="display:flex;"><span>  bcs-cc            bcs-cc-api-0-0-1364-index0      <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>3%<span style="color:#ce5c00;font-weight:bold">)</span>      <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>3%<span style="color:#ce5c00;font-weight:bold">)</span>      <span style="color:#0000cf;font-weight:bold">4294967296</span> <span style="color:#ce5c00;font-weight:bold">(</span>6%<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4294967296</span> <span style="color:#ce5c00;font-weight:bold">(</span>6%<span style="color:#ce5c00;font-weight:bold">)</span>  
</span></span><span style="display:flex;"><span>  bcs-cc            bcs-cc-api-0-0-1444-index0      <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>3%<span style="color:#ce5c00;font-weight:bold">)</span>      <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>3%<span style="color:#ce5c00;font-weight:bold">)</span>      <span style="color:#0000cf;font-weight:bold">4294967296</span> <span style="color:#ce5c00;font-weight:bold">(</span>6%<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4294967296</span> <span style="color:#ce5c00;font-weight:bold">(</span>6%<span style="color:#ce5c00;font-weight:bold">)</span>  
</span></span><span style="display:flex;"><span>  fw                fw-demo2-0-0-1519-index0        <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>3%<span style="color:#ce5c00;font-weight:bold">)</span>      <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>3%<span style="color:#ce5c00;font-weight:bold">)</span>      <span style="color:#0000cf;font-weight:bold">4294967296</span> <span style="color:#ce5c00;font-weight:bold">(</span>6%<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4294967296</span> <span style="color:#ce5c00;font-weight:bold">(</span>6%<span style="color:#ce5c00;font-weight:bold">)</span>  
</span></span><span style="display:flex;"><span>  myview            myview-api-0-0-1362-index0      <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>3%<span style="color:#ce5c00;font-weight:bold">)</span>      <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>3%<span style="color:#ce5c00;font-weight:bold">)</span>      <span style="color:#0000cf;font-weight:bold">4294967296</span> <span style="color:#ce5c00;font-weight:bold">(</span>6%<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4294967296</span> <span style="color:#ce5c00;font-weight:bold">(</span>6%<span style="color:#ce5c00;font-weight:bold">)</span>  
</span></span><span style="display:flex;"><span>  myview            myview-api-0-0-1442-index0      <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>3%<span style="color:#ce5c00;font-weight:bold">)</span>      <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>3%<span style="color:#ce5c00;font-weight:bold">)</span>      <span style="color:#0000cf;font-weight:bold">4294967296</span> <span style="color:#ce5c00;font-weight:bold">(</span>6%<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4294967296</span> <span style="color:#ce5c00;font-weight:bold">(</span>6%<span style="color:#ce5c00;font-weight:bold">)</span>  
</span></span><span style="display:flex;"><span>  qa-ts-dna         ts-dna-console3-0-0-1434-index0     <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>3%<span style="color:#ce5c00;font-weight:bold">)</span>      <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>3%<span style="color:#ce5c00;font-weight:bold">)</span>      <span style="color:#0000cf;font-weight:bold">4294967296</span> <span style="color:#ce5c00;font-weight:bold">(</span>6%<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4294967296</span> <span style="color:#ce5c00;font-weight:bold">(</span>6%<span style="color:#ce5c00;font-weight:bold">)</span>  
</span></span><span style="display:flex;"><span>Allocated resources:  
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">(</span>Total limits may be over 100%, i.e., overcommitted. More info: http://releases.k8s.io/HEAD/docs/user-guide/compute-resources.md<span style="color:#ce5c00;font-weight:bold">)</span>  
</span></span><span style="display:flex;"><span>  CPU Requests  CPU Limits  Memory Requests     Memory Limits  
</span></span><span style="display:flex;"><span>  ────────────  ──────────  ───────────────     ─────────────  
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#ce5c00;font-weight:bold">(</span>18%<span style="color:#ce5c00;font-weight:bold">)</span>   <span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#ce5c00;font-weight:bold">(</span>18%<span style="color:#ce5c00;font-weight:bold">)</span>     <span style="color:#0000cf;font-weight:bold">25769803776</span> <span style="color:#ce5c00;font-weight:bold">(</span>38%<span style="color:#ce5c00;font-weight:bold">)</span>   <span style="color:#0000cf;font-weight:bold">25769803776</span> <span style="color:#ce5c00;font-weight:bold">(</span>38%<span style="color:#ce5c00;font-weight:bold">)</span>  
</span></span><span style="display:flex;"><span>No events.  
</span></span></code></pre></div><h2 id="1-3-rc">1.3. RC</h2>
<pre tabindex="0"><code>kubectl describe rc mytest-1-0-0 --namespace=test
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@FC-43745A-10 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># kubectl describe rc mytest-1-0-0 --namespace=test  </span>
</span></span><span style="display:flex;"><span>Name:       mytest-1-0-0  
</span></span><span style="display:flex;"><span>Namespace:  <span style="color:#204a87">test</span>  
</span></span><span style="display:flex;"><span>Image<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span>:   gcr.io/test/mywebcalculator:1.0.1  
</span></span><span style="display:flex;"><span>Selector:   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>mytest,appVersion<span style="color:#ce5c00;font-weight:bold">=</span>1.0.0  
</span></span><span style="display:flex;"><span>Labels:     <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>mytest,appVersion<span style="color:#ce5c00;font-weight:bold">=</span>1.0.0,env<span style="color:#ce5c00;font-weight:bold">=</span>ts,zone<span style="color:#ce5c00;font-weight:bold">=</span>inner  
</span></span><span style="display:flex;"><span>Replicas:   <span style="color:#0000cf;font-weight:bold">1</span> current / <span style="color:#0000cf;font-weight:bold">1</span> desired  
</span></span><span style="display:flex;"><span>Pods Status:    <span style="color:#0000cf;font-weight:bold">1</span> Running / <span style="color:#0000cf;font-weight:bold">0</span> Waiting / <span style="color:#0000cf;font-weight:bold">0</span> Succeeded / <span style="color:#0000cf;font-weight:bold">0</span> Failed  
</span></span><span style="display:flex;"><span>No volumes.  
</span></span><span style="display:flex;"><span>Events:  
</span></span><span style="display:flex;"><span>  FirstSeen LastSeen    Count   From                SubobjectPath   Reason          Message  
</span></span><span style="display:flex;"><span>  ───────── ────────    ─────   ────                ─────────────   ──────          ───────  
</span></span><span style="display:flex;"><span>  20h       19h     <span style="color:#0000cf;font-weight:bold">9</span>   <span style="color:#ce5c00;font-weight:bold">{</span>replication-controller <span style="color:#ce5c00;font-weight:bold">}</span>           FailedCreate        Error creating: Pod <span style="color:#4e9a06">&#34;mytest-1-0-0-index0&#34;</span> is forbidden: limited to <span style="color:#0000cf;font-weight:bold">10</span> pods  
</span></span><span style="display:flex;"><span>  20h       17h     <span style="color:#0000cf;font-weight:bold">7</span>   <span style="color:#ce5c00;font-weight:bold">{</span>replication-controller <span style="color:#ce5c00;font-weight:bold">}</span>           FailedCreate        Error creating: pods <span style="color:#4e9a06">&#34;mytest-1-0-0-index0&#34;</span> already exists  
</span></span><span style="display:flex;"><span>  20h       17h     <span style="color:#0000cf;font-weight:bold">4</span>   <span style="color:#ce5c00;font-weight:bold">{</span>replication-controller <span style="color:#ce5c00;font-weight:bold">}</span>           SuccessfulCreate    Created pod: mytest-1-0-0-index0  
</span></span></code></pre></div><h2 id="1-4-namespace">1.4. NAMESPACE</h2>
<pre tabindex="0"><code>kubectl describe namespace test
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@FC-43745A-10 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># kubectl describe namespace test  </span>
</span></span><span style="display:flex;"><span>Name:   <span style="color:#204a87">test</span>  
</span></span><span style="display:flex;"><span>Labels: &lt;none&gt;  
</span></span><span style="display:flex;"><span>Status: Active  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>Resource Quotas  
</span></span><span style="display:flex;"><span> Resource       Used        Hard  
</span></span><span style="display:flex;"><span> ---            ---     ---  
</span></span><span style="display:flex;"><span> cpu            <span style="color:#0000cf;font-weight:bold">5</span>       <span style="color:#0000cf;font-weight:bold">20</span>  
</span></span><span style="display:flex;"><span> memory         <span style="color:#0000cf;font-weight:bold">1342177280</span>  <span style="color:#0000cf;font-weight:bold">53687091200</span>  
</span></span><span style="display:flex;"><span> persistentvolumeclaims <span style="color:#0000cf;font-weight:bold">0</span>       <span style="color:#0000cf;font-weight:bold">10</span>  
</span></span><span style="display:flex;"><span> pods           <span style="color:#0000cf;font-weight:bold">4</span>       <span style="color:#0000cf;font-weight:bold">10</span>  
</span></span><span style="display:flex;"><span> replicationcontrollers <span style="color:#0000cf;font-weight:bold">8</span>       <span style="color:#0000cf;font-weight:bold">20</span>  
</span></span><span style="display:flex;"><span> resourcequotas     <span style="color:#0000cf;font-weight:bold">1</span>       <span style="color:#0000cf;font-weight:bold">1</span>  
</span></span><span style="display:flex;"><span> secrets        <span style="color:#0000cf;font-weight:bold">3</span>       <span style="color:#0000cf;font-weight:bold">10</span>  
</span></span><span style="display:flex;"><span> services       <span style="color:#0000cf;font-weight:bold">8</span>       <span style="color:#0000cf;font-weight:bold">20</span>  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>No resource limits.  
</span></span></code></pre></div><h2 id="1-5-service">1.5. Service</h2>
<pre tabindex="0"><code>kubectl describe service xxx-containers-1-1-0 --namespace=test
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@FC-43745A-10 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># kubectl describe service xxx-containers-1-1-0 --namespace=test  </span>
</span></span><span style="display:flex;"><span>Name:           xxx-containers-1-1-0  
</span></span><span style="display:flex;"><span>Namespace:      <span style="color:#204a87">test</span>  
</span></span><span style="display:flex;"><span>Labels:         <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>xxx-containers,appVersion<span style="color:#ce5c00;font-weight:bold">=</span>1.1.0,env<span style="color:#ce5c00;font-weight:bold">=</span>ts,zone<span style="color:#ce5c00;font-weight:bold">=</span>inner  
</span></span><span style="display:flex;"><span>Selector:       <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>xxx-containers,appVersion<span style="color:#ce5c00;font-weight:bold">=</span>1.1.0  
</span></span><span style="display:flex;"><span>Type:           ClusterIP  
</span></span><span style="display:flex;"><span>IP:         10.254.46.42  
</span></span><span style="display:flex;"><span>Port:           port-dna-tcp-35913  35913/TCP  
</span></span><span style="display:flex;"><span>Endpoints:      10.0.92.17:35913  
</span></span><span style="display:flex;"><span>Port:           port-l7-tcp-8080    8080/TCP  
</span></span><span style="display:flex;"><span>Endpoints:      10.0.92.17:8080  
</span></span><span style="display:flex;"><span>Session Affinity:   None  
</span></span><span style="display:flex;"><span>No events.  
</span></span></code></pre></div><h1 id="2-查看容器日志">2. 查看容器日志</h1>
<p>1、查看指定pod的日志</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl logs &lt;pod_name&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl logs -f &lt;pod_name&gt; <span style="color:#8f5902;font-style:italic">#类似tail -f的方式查看</span>
</span></span></code></pre></div><p>2、查看上一个pod的日志</p>
<pre tabindex="0"><code>kubectl logs -p &lt;pod_name&gt;
</code></pre><p>3、查看指定pod中指定容器的日志</p>
<pre tabindex="0"><code>kubectl logs &lt;pod_name&gt; -c &lt;container_name&gt;
</code></pre><p>4、kubectl logs --help</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@node5 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># kubectl logs --help  </span>
</span></span><span style="display:flex;"><span>Print the logs <span style="color:#204a87;font-weight:bold">for</span> a container in a pod. If the pod has only one container, the container name is optional.  
</span></span><span style="display:flex;"><span>Usage:  
</span></span><span style="display:flex;"><span>  kubectl logs <span style="color:#ce5c00;font-weight:bold">[</span>-f<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>-p<span style="color:#ce5c00;font-weight:bold">]</span> POD <span style="color:#ce5c00;font-weight:bold">[</span>-c CONTAINER<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>flags<span style="color:#ce5c00;font-weight:bold">]</span>  
</span></span><span style="display:flex;"><span>Aliases:  
</span></span><span style="display:flex;"><span>  logs, log  
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>Examples:  
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Return snapshot logs from pod nginx with only one container  </span>
</span></span><span style="display:flex;"><span>$ kubectl logs nginx  
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Return snapshot of previous terminated ruby container logs from pod web-1  </span>
</span></span><span style="display:flex;"><span>$ kubectl logs -p -c ruby web-1  
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Begin streaming the logs of the ruby container in pod web-1  </span>
</span></span><span style="display:flex;"><span>$ kubectl logs -f -c ruby web-1  
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Display only the most recent 20 lines of output in pod nginx  </span>
</span></span><span style="display:flex;"><span>$ kubectl logs --tail<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">20</span> nginx  
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Show all logs from pod nginx written in the last hour  </span>
</span></span><span style="display:flex;"><span>$ kubectl logs --since<span style="color:#ce5c00;font-weight:bold">=</span>1h nginx  
</span></span></code></pre></div><h1 id="3-查看k8s服务日志">3. 查看k8s服务日志</h1>
<h2 id="3-1-journalctl">3.1. journalctl</h2>
<p>在Linux系统上systemd系统来管理kubernetes服务，并且journal系统会接管服务程序的输出日志，可以通过<strong>systemctl status <xxx>或journalctl -u <xxx> -f</strong>来查看kubernetes服务的日志。</p>
<p>其中kubernetes组件包括：</p>
<table>
<thead>
<tr>
<th>k8s组件</th>
<th>涉及日志内容</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>kube-apiserver</td>
<td></td>
<td></td>
</tr>
<tr>
<td>kube-controller-manager</td>
<td>Pod扩容相关或RC相关</td>
<td></td>
</tr>
<tr>
<td>kube-scheduler</td>
<td>Pod扩容相关或RC相关</td>
<td></td>
</tr>
<tr>
<td>kubelet</td>
<td>Pod生命周期相关：创建、停止等</td>
<td></td>
</tr>
<tr>
<td>etcd</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="3-2-日志文件">3.2. 日志文件</h2>
<p>也可以通过指定日志存放目录来保存和查看日志</p>
<ul>
<li>--logtostderr=false：不输出到stderr</li>
<li>--log-dir=/var/log/kubernetes:日志的存放目录</li>
<li>--alsologtostderr=false:设置为true表示日志输出到文件也输出到stderr</li>
<li>--v=0:glog的日志级别</li>
<li>--vmodule=gfs*=2,test*=4：glog基于模块的详细日志级别</li>
</ul>
<h1 id="4-常见问题">4. 常见问题</h1>
<h2 id="4-1-pod状态一直为pending">4.1. Pod状态一直为Pending</h2>
<pre tabindex="0"><code>kubectl describe &lt;pod_name&gt; --namespace=&lt;NAMESPACE&gt;
</code></pre><p>查看该POD的事件。</p>
<ul>
<li>正在下载镜像但拉取不下来（镜像拉取耗时太久）[一般都是该原因]</li>
<li>没有可用的Node可调度</li>
<li>开启了资源配额管理并且当前Pod的目标节点上恰好没有可用的资源</li>
</ul>
<p>解决方法：</p>
<ol>
<li>查看该POD所在宿主机与镜像仓库之间的网络是否有问题，可以手动拉取镜像</li>
<li>删除POD实例，让POD调度到别的宿主机上</li>
</ol>
<h2 id="4-2-pod创建后不断重启">4.2. Pod创建后不断重启</h2>
<p>kubectl get pods中Pod状态一会running，一会不是，且RESTARTS次数不断增加。</p>
<p>一般原因为容器启动命令不是阻塞式命令，导致容器运行后马上退出。</p>
<p>非阻塞式命令：</p>
<ul>
<li>本身CMD指定的命令就是非阻塞式命令</li>
<li>将服务启动方式设置为后台运行</li>
</ul>
<p>解决方法：</p>
<p>1、将命令改为阻塞式命令（前台运行），例如：<strong>zkServer.sh start-foreground</strong></p>
<p>2、java运行程序的启动脚本将 nohup xxx &amp;的nobup和&amp;去掉，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nohup JAVA_HOME/bin/java JAVA_OPTS -cp <span style="color:#000">$CLASSPATH</span> com.cnc.open.processor.Main <span style="color:#000;font-weight:bold">&amp;</span>
</span></span></code></pre></div><p>改为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>JAVA_HOME/bin/java JAVA_OPTS -cp <span style="color:#000">$CLASSPATH</span> com.cnc.open.processor.Main
</span></span></code></pre></div><p>文章参考《Kubernetes权威指南》</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4636def6f640761d9a6d52a310eec2ce">8.2 - kubectl工具</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-22f0195f73c944ee47a2e9c5921b05e9">8.2.1 - kubectl安装与配置</h1>
    
	<h1 id="1-kubectl的安装">1. kubectl的安装</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -LO https://storage.googleapis.com/kubernetes-release/release/<span style="color:#204a87;font-weight:bold">$(</span>curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt<span style="color:#204a87;font-weight:bold">)</span>/bin/linux/amd64/kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chmod +x kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo mv kubectl /usr/local/bin/
</span></span></code></pre></div><p>安装指定版本的kubectl，例如：<code>v1.9.0</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.9.0/bin/linux/amd64/kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> chmod +x kubectl <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> sudo mv kubectl /usr/local/bin/
</span></span></code></pre></div><h1 id="2-配置k8s集群环境">2. 配置k8s集群环境</h1>
<h2 id="2-1-命令行方式">2.1. 命令行方式</h2>
<h3 id="2-1-1-非安全方式">2.1.1 非安全方式</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl config set-cluster k8s --server<span style="color:#ce5c00;font-weight:bold">=</span>http://&lt;url&gt; 
</span></span><span style="display:flex;"><span>kubectl config set-context &lt;NAMESPACE&gt; --cluster<span style="color:#ce5c00;font-weight:bold">=</span>k8s --namespace<span style="color:#ce5c00;font-weight:bold">=</span>&lt;NAMESPACE&gt; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config use-context &lt;NAMESPACE&gt; 
</span></span></code></pre></div><h3 id="2-1-2-安全方式">2.1.2 安全方式</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl config set-cluster k8s --server<span style="color:#ce5c00;font-weight:bold">=</span>https://&lt;url&gt; --insecure-skip-tls-verify<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>kubectl config set-credentials k8s-user --username<span style="color:#ce5c00;font-weight:bold">=</span>&lt;username&gt; --password<span style="color:#ce5c00;font-weight:bold">=</span>&lt;password&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl config set-context &lt;NAMESPACE&gt; --cluster<span style="color:#ce5c00;font-weight:bold">=</span>k8s --user<span style="color:#ce5c00;font-weight:bold">=</span>k8s-user --namespace<span style="color:#ce5c00;font-weight:bold">=</span>&lt;NAMESPACE&gt; 
</span></span><span style="display:flex;"><span>kubectl config use-context &lt;NAMESPACE&gt;
</span></span></code></pre></div><h3 id="2-1-3-查询当前配置环境">2.1.3 查询当前配置环境</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@test <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># kubectl cluster-info</span>
</span></span><span style="display:flex;"><span>Kubernetes master is running at http://192.168.10.3:8081
</span></span></code></pre></div><h2 id="2-2-添加配置文件的方式">2.2. 添加配置文件的方式</h2>
<p>当没有指定<code> --kubeconfig</code>参数和<code>$KUBECONFIG</code>的环境变量的时候，会默认读取<code>${HOME}/.kube/config</code>。</p>
<p>因此创建<code>${HOME}/.kube/config</code>文件，并在``${HOME}/.kube/ssl`目录下创建ca.pem、cert.pem、key.pem文件。</p>
<p>内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">clusters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">certificate-authority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">./ssl/ca.pem</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://192.168.10.3:6443</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubelet</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">client-certificate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">./ssl/cert.pem</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">client-key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">./ssl/key.pem</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">contexts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">context</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubelet</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubelet-cluster.local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">current-context</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubelet-cluster.local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="3-kubectl-config">3. kubectl config</h1>
<p>kubectl config命令说明</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl config --help
</span></span><span style="display:flex;"><span>Modify kubeconfig files using subcommands like <span style="color:#4e9a06">&#34;kubectl config set current-context my-context&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The loading order follows these rules:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  1. If the --kubeconfig flag is set, <span style="color:#204a87;font-weight:bold">then</span> only that file is loaded.  The flag may only be <span style="color:#204a87">set</span> once and no merging takes
</span></span><span style="display:flex;"><span>place.
</span></span><span style="display:flex;"><span>  2. If <span style="color:#000">$KUBECONFIG</span> environment variable is set, <span style="color:#204a87;font-weight:bold">then</span> it is used a list of paths <span style="color:#ce5c00;font-weight:bold">(</span>normal path delimitting rules <span style="color:#204a87;font-weight:bold">for</span> your
</span></span><span style="display:flex;"><span>system<span style="color:#ce5c00;font-weight:bold">)</span>.  These paths are merged.  When a value is modified, it is modified in the file that defines the stanza.  When a
</span></span><span style="display:flex;"><span>value is created, it is created in the first file that exists.  If no files in the chain exist, <span style="color:#204a87;font-weight:bold">then</span> it creates the last
</span></span><span style="display:flex;"><span>file in the list.
</span></span><span style="display:flex;"><span>  3. Otherwise, <span style="color:#4e9a06">${</span><span style="color:#000">HOME</span><span style="color:#4e9a06">}</span>/.kube/config is used and no merging takes place.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available Commands:
</span></span><span style="display:flex;"><span>  current-context Displays the current-context
</span></span><span style="display:flex;"><span>  delete-cluster  Delete the specified cluster from the kubeconfig
</span></span><span style="display:flex;"><span>  delete-context  Delete the specified context from the kubeconfig
</span></span><span style="display:flex;"><span>  get-clusters    Display clusters defined in the kubeconfig
</span></span><span style="display:flex;"><span>  get-contexts    Describe one or many contexts
</span></span><span style="display:flex;"><span>  rename-context  Renames a context from the kubeconfig file.
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">set</span>             Sets an individual value in a kubeconfig file
</span></span><span style="display:flex;"><span>  set-cluster     Sets a cluster entry in kubeconfig
</span></span><span style="display:flex;"><span>  set-context     Sets a context entry in kubeconfig
</span></span><span style="display:flex;"><span>  set-credentials Sets a user entry in kubeconfig
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">unset</span>           Unsets an individual value in a kubeconfig file
</span></span><span style="display:flex;"><span>  use-context     Sets the current-context in a kubeconfig file
</span></span><span style="display:flex;"><span>  view            Display merged kubeconfig settings or a specified kubeconfig file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  kubectl config SUBCOMMAND <span style="color:#ce5c00;font-weight:bold">[</span>options<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;kubectl &lt;command&gt; --help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information about a given command.
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;kubectl options&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> a list of global command-line options <span style="color:#ce5c00;font-weight:bold">(</span>applies to all commands<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span></code></pre></div><h1 id="4-shell自动补齐">4. shell自动补齐</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">source</span> &lt;<span style="color:#ce5c00;font-weight:bold">(</span>kubectl completion bash<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;source &lt;(kubectl completion bash)&#34;</span> &gt;&gt; ~/.bashrc
</span></span></code></pre></div><p>如果出现以下报错</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl自动补齐失败</span>
</span></span><span style="display:flex;"><span>kubectl _get_comp_words_by_ref : <span style="color:#204a87">command</span> not found
</span></span></code></pre></div><p>解决方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yum install bash-completion -y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">source</span> /etc/profile.d/bash_completion.sh 
</span></span></code></pre></div><p>参考文章：</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">https://kubernetes.io/docs/tasks/tools/install-kubectl/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-580791bea464f97f9c44ba2cd0c9e6ec">8.2.2 - kubectl命令使用</h1>
    
	<h1 id="1-kubectl命令介绍">1. kubectl命令介绍</h1>
<p>kubectl的命令语法</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl <span style="color:#ce5c00;font-weight:bold">[</span>command<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>TYPE<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>NAME<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>flags<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><p>其中command，TYPE，NAME，和flags分别是：</p>
<ul>
<li>
<p><code>command</code>: 指定要在一个或多个资源进行操作，例如<code>create</code>，<code>get</code>，<code>describe</code>，<code>delete</code>。</p>
</li>
<li>
<p><code>TYPE</code>：指定<a href="https://kubernetes.io/cn/docs/user-guide/kubectl-overview/#%E8%B5%84%E6%BA%90%E7%B1%BB%E5%9E%8B">资源类型</a>。资源类型区分大小写，您可以指定单数，复数或缩写形式。例如，以下命令产生相同的输出：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pod pod1  
</span></span><span style="display:flex;"><span>kubectl get pods pod1 
</span></span><span style="display:flex;"><span>kubectl get po pod1
</span></span></code></pre></div></li>
<li>
<p><code>NAME</code>：指定资源的名称。名称区分大小写。如果省略名称，则会显示所有资源的详细信息,比如<code>$ kubectl get pods</code>。</p>
<p>按类型和名称指定多种资源：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>* 要分组资源，如果它们都是相同的类型：<span style="color:#4e9a06">`</span>TYPE1 name1 name2 name&lt;<span style="color:#8f5902;font-style:italic">#&gt;`.&lt;br/&gt;</span>
</span></span><span style="display:flex;"><span>例: <span style="color:#4e9a06">`</span>$ kubectl get pod example-pod1 example-pod2<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>* 要分别指定多种资源类型:  <span style="color:#4e9a06">`</span>TYPE1/name1 TYPE1/name2 TYPE2/name3 TYPE&lt;<span style="color:#8f5902;font-style:italic">#&gt;/name&lt;#&gt;`.&lt;br/&gt;</span>
</span></span><span style="display:flex;"><span>例: <span style="color:#4e9a06">`</span>$ kubectl get pod/example-pod1 replicationcontroller/example-rc1<span style="color:#4e9a06">`</span>
</span></span></code></pre></div></li>
<li>
<p><code>flags</code>：指定可选标志。例如，您可以使用<code>-s</code>或<code>--serverflags</code>来指定Kubernetes API服务器的地址和端口。</p>
</li>
</ul>
<p><strong>更多命令介绍：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@node5 ~<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># kubectl</span>
</span></span><span style="display:flex;"><span>kubectl controls the Kubernetes cluster manager.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Find more information at https://github.com/kubernetes/kubernetes.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Basic Commands <span style="color:#ce5c00;font-weight:bold">(</span>Beginner<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>  create         Create a resource from a file or from stdin.
</span></span><span style="display:flex;"><span>  expose         Take a replication controller, service, deployment or pod and expose it as a new Kubernetes Service
</span></span><span style="display:flex;"><span>  run            Run a particular image on the cluster
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">set</span>            Set specific features on objects
</span></span><span style="display:flex;"><span>  run-container  Run a particular image on the cluster. This <span style="color:#204a87">command</span> is deprecated, use <span style="color:#4e9a06">&#34;run&#34;</span> instead
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Basic Commands <span style="color:#ce5c00;font-weight:bold">(</span>Intermediate<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>  get            Display one or many resources
</span></span><span style="display:flex;"><span>  explain        Documentation of resources
</span></span><span style="display:flex;"><span>  edit           Edit a resource on the server
</span></span><span style="display:flex;"><span>  delete         Delete resources by filenames, stdin, resources and names, or by resources and label selector
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Deploy Commands:
</span></span><span style="display:flex;"><span>  rollout        Manage the rollout of a resource
</span></span><span style="display:flex;"><span>  rolling-update Perform a rolling update of the given ReplicationController
</span></span><span style="display:flex;"><span>  scale          Set a new size <span style="color:#204a87;font-weight:bold">for</span> a Deployment, ReplicaSet, Replication Controller, or Job
</span></span><span style="display:flex;"><span>  autoscale      Auto-scale a Deployment, ReplicaSet, or ReplicationController
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Cluster Management Commands:
</span></span><span style="display:flex;"><span>  certificate    Modify certificate resources.
</span></span><span style="display:flex;"><span>  cluster-info   Display cluster info
</span></span><span style="display:flex;"><span>  top            Display Resource <span style="color:#ce5c00;font-weight:bold">(</span>CPU/Memory/Storage<span style="color:#ce5c00;font-weight:bold">)</span> usage.
</span></span><span style="display:flex;"><span>  cordon         Mark node as unschedulable
</span></span><span style="display:flex;"><span>  uncordon       Mark node as schedulable
</span></span><span style="display:flex;"><span>  drain          Drain node in preparation <span style="color:#204a87;font-weight:bold">for</span> maintenance
</span></span><span style="display:flex;"><span>  taint          Update the taints on one or more nodes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Troubleshooting and Debugging Commands:
</span></span><span style="display:flex;"><span>  describe       Show details of a specific resource or group of resources
</span></span><span style="display:flex;"><span>  logs           Print the logs <span style="color:#204a87;font-weight:bold">for</span> a container in a pod
</span></span><span style="display:flex;"><span>  attach         Attach to a running container
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">exec</span>           Execute a <span style="color:#204a87">command</span> in a container
</span></span><span style="display:flex;"><span>  port-forward   Forward one or more <span style="color:#204a87">local</span> ports to a pod
</span></span><span style="display:flex;"><span>  proxy          Run a proxy to the Kubernetes API server
</span></span><span style="display:flex;"><span>  cp             Copy files and directories to and from containers.
</span></span><span style="display:flex;"><span>  auth           Inspect authorization
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Advanced Commands:
</span></span><span style="display:flex;"><span>  apply          Apply a configuration to a resource by filename or stdin
</span></span><span style="display:flex;"><span>  patch          Update field<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> of a resource using strategic merge patch
</span></span><span style="display:flex;"><span>  replace        Replace a resource by filename or stdin
</span></span><span style="display:flex;"><span>  convert        Convert config files between different API versions
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Settings Commands:
</span></span><span style="display:flex;"><span>  label          Update the labels on a resource
</span></span><span style="display:flex;"><span>  annotate       Update the annotations on a resource
</span></span><span style="display:flex;"><span>  completion     Output shell completion code <span style="color:#204a87;font-weight:bold">for</span> the specified shell <span style="color:#ce5c00;font-weight:bold">(</span>bash or zsh<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Other Commands:
</span></span><span style="display:flex;"><span>  api-versions   Print the supported API versions on the server, in the form of <span style="color:#4e9a06">&#34;group/version&#34;</span>
</span></span><span style="display:flex;"><span>  config         Modify kubeconfig files
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">help</span>           Help about any <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>  plugin         Runs a command-line plugin
</span></span><span style="display:flex;"><span>  version        Print the client and server version information
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;kubectl &lt;command&gt; --help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information about a given command.
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;kubectl options&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> a list of global command-line options <span style="color:#ce5c00;font-weight:bold">(</span>applies to all commands<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span></code></pre></div><h1 id="2-操作的常用资源对象">2. 操作的常用资源对象</h1>
<ol>
<li>Node</li>
<li>Podes</li>
<li>Replication Controllers</li>
<li>Services</li>
<li>Namespace</li>
<li>Deployment</li>
<li>StatefulSet</li>
</ol>
<p><strong>具体对象类型及缩写：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  * all
</span></span><span style="display:flex;"><span>  * certificatesigningrequests <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;csr&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * clusterrolebindings
</span></span><span style="display:flex;"><span>  * clusterroles
</span></span><span style="display:flex;"><span>  * componentstatuses <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;cs&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * configmaps <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;cm&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * controllerrevisions
</span></span><span style="display:flex;"><span>  * cronjobs
</span></span><span style="display:flex;"><span>  * customresourcedefinition <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;crd&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * daemonsets <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;ds&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * deployments <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;deploy&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * endpoints <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;ep&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * events <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;ev&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * horizontalpodautoscalers <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;hpa&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * ingresses <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;ing&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * <span style="color:#204a87">jobs</span>
</span></span><span style="display:flex;"><span>  * limitranges <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;limits&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * namespaces <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;ns&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * networkpolicies <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;netpol&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * nodes <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;no&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * persistentvolumeclaims <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;pvc&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * persistentvolumes <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;pv&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * poddisruptionbudgets <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;pdb&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * podpreset
</span></span><span style="display:flex;"><span>  * pods <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;po&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * podsecuritypolicies <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;psp&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * podtemplates
</span></span><span style="display:flex;"><span>  * replicasets <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;rs&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * replicationcontrollers <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;rc&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * resourcequotas <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;quota&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * rolebindings
</span></span><span style="display:flex;"><span>  * roles
</span></span><span style="display:flex;"><span>  * secrets
</span></span><span style="display:flex;"><span>  * serviceaccounts <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;sa&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * services <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;svc&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * statefulsets <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;sts&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  * storageclasses <span style="color:#ce5c00;font-weight:bold">(</span>aka <span style="color:#4e9a06">&#39;sc&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="3-kubectl命令分类-command">3. kubectl命令分类[command]</h1>
<h2 id="3-1-增">3.1 增</h2>
<p>1）create:[Create a resource by filename or stdin]</p>
<p>2）run:[ Run a particular image on the cluster]</p>
<p>3）apply:[Apply a configuration to a resource by filename or stdin]</p>
<p>4）proxy:[Run a proxy to the Kubernetes API server ]</p>
<h2 id="3-2-删">3.2 删</h2>
<p>1）delete:[Delete resources ]</p>
<h2 id="3-3-改">3.3 改</h2>
<p>1）scale:[Set a new size for a Replication Controller]</p>
<p>2）exec:[Execute a command in a container]</p>
<p>3）attach:[Attach to a running container]</p>
<p>4）patch:[Update field(s) of a resource by stdin]</p>
<p>5）edit:[Edit a resource on the server]</p>
<p>6） label:[Update the labels on a resource]</p>
<p>7）annotate:[Auto-scale a replication controller]</p>
<p>8）replace:[Replace a resource by filename or stdin]</p>
<p>9）config:[config modifies kubeconfig files]</p>
<h2 id="3-4-查">3.4 查</h2>
<p>1）get:[Display one or many resources]</p>
<p>2）describe:[Show details of a specific resource or group of resources]</p>
<p>3）log:[Print the logs for a container in a pod]</p>
<p>4）cluster-info:[Display cluster info]</p>
<p>5） version:[Print the client and server version information]</p>
<p>6）api-versions:[Print the supported API versions]</p>
<h1 id="4-pod相关命令">4. Pod相关命令</h1>
<h2 id="4-1-查询pod">4.1 查询Pod</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pod -o wide --namespace<span style="color:#ce5c00;font-weight:bold">=</span>&lt;NAMESPACE&gt;
</span></span></code></pre></div><h2 id="4-2-进入pod">4.2 进入Pod</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl <span style="color:#204a87">exec</span> -it &lt;PodName&gt; /bin/bash --namespace<span style="color:#ce5c00;font-weight:bold">=</span>&lt;NAMESPACE&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 进入Pod中指定容器</span>
</span></span><span style="display:flex;"><span>kubectl <span style="color:#204a87">exec</span> -it &lt;PodName&gt; -c &lt;ContainerName&gt; /bin/bash --namespace<span style="color:#ce5c00;font-weight:bold">=</span>&lt;NAMESPACE&gt;
</span></span></code></pre></div><h2 id="4-3-删除pod">4.3 删除Pod</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl delete pod &lt;PodName&gt; --namespace<span style="color:#ce5c00;font-weight:bold">=</span>&lt;NAMESPACE&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 强制删除Pod，当Pod一直处于Terminating状态</span>
</span></span><span style="display:flex;"><span>kubectl delete pod &lt;PodName&gt; --namespace<span style="color:#ce5c00;font-weight:bold">=</span>&lt;NAMESPACE&gt; --force --grace-period<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除某个namespace下某个类型的所有对象</span>
</span></span><span style="display:flex;"><span>kubectl delete deploy --all --namespace<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">test</span>
</span></span></code></pre></div><h2 id="4-4-日志查看">4.4 日志查看</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ 查看运行容器日志 
</span></span><span style="display:flex;"><span>kubectl logs &lt;PodName&gt; --namespace<span style="color:#ce5c00;font-weight:bold">=</span>&lt;NAMESPACE&gt;
</span></span><span style="display:flex;"><span>$ 查看上一个挂掉的容器日志 
</span></span><span style="display:flex;"><span>kubectl logs &lt;PodName&gt; -p --namespace<span style="color:#ce5c00;font-weight:bold">=</span>&lt;NAMESPACE&gt; 
</span></span></code></pre></div><h1 id="5-常用命令">5. 常用命令</h1>
<h2 id="5-1-node隔离与恢复">5.1. Node隔离与恢复</h2>
<p>说明：Node设置隔离之后，原先运行在该Node上的Pod不受影响，后续的Pod不会调度到被隔离的Node上。</p>
<p><strong>1. Node隔离</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cordon命令</span>
</span></span><span style="display:flex;"><span>kubectl cordon &lt;NodeName&gt;
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或者</span>
</span></span><span style="display:flex;"><span>kubectl patch node &lt;NodeName&gt; -p <span style="color:#4e9a06">&#39;{&#34;spec&#34;:{&#34;unschedulable&#34;:true}}&#39;</span>
</span></span></code></pre></div><p><strong>2. Node恢复</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># uncordon</span>
</span></span><span style="display:flex;"><span>kubectl uncordon &lt;NodeName&gt;
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或者</span>
</span></span><span style="display:flex;"><span>kubectl patch node &lt;NodeName&gt; -p <span style="color:#4e9a06">&#39;{&#34;spec&#34;:{&#34;unschedulable&#34;:false}}&#39;</span>
</span></span></code></pre></div><h2 id="5-2-kubectl-label">5.2. kubectl label</h2>
<p><strong>1. 固定Pod到指定机器</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl label node &lt;NodeName&gt; namespace/&lt;NAMESPACE&gt;<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span></code></pre></div><p><strong>2. 取消Pod固定机器</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl label node &lt;NodeName&gt; namespace/&lt;NAMESPACE&gt;-
</span></span></code></pre></div><h2 id="5-3-升级镜像">5.3. 升级镜像</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 升级镜像</span>
</span></span><span style="display:flex;"><span>kubectl <span style="color:#204a87">set</span> image deployment/nginx <span style="color:#000">nginx</span><span style="color:#ce5c00;font-weight:bold">=</span>nginx:1.15.12 -n nginx
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看滚动升级情况</span>
</span></span><span style="display:flex;"><span>kubectl rollout status deployment/nginx  -n nginx
</span></span></code></pre></div><h2 id="5-4-调整资源值">5.4. 调整资源值</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 调整指定容器的资源值</span>
</span></span><span style="display:flex;"><span>kubectl <span style="color:#204a87">set</span> resources sts nginx-0 -c<span style="color:#ce5c00;font-weight:bold">=</span>agent --limits<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">memory</span><span style="color:#ce5c00;font-weight:bold">=</span>512Mi -n nginx
</span></span></code></pre></div><h2 id="5-5-调整readiness-probe">5.5. 调整readiness probe</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 批量查看readiness probe timeoutSeconds</span>
</span></span><span style="display:flex;"><span>kubectl get statefulset -o<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;{range .items[*]}{.metadata.name}{&#34;\t&#34;}{.spec.template.spec.containers[0].readinessProbe.timeoutSeconds}{&#34;\n&#34;}{end}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 调整readiness probe timeoutSeconds参数</span>
</span></span><span style="display:flex;"><span>kubectl patch statefulset nginx-sts --type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;json&#39;</span> -p<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/spec/template/spec/containers/0/readinessProbe/timeoutSeconds&#34;, &#34;value&#34;:5}]&#39;</span> -n nginx
</span></span></code></pre></div><h2 id="5-6-调整tolerations属性">5.6. 调整tolerations属性</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl patch statefulset nginx-sts --patch <span style="color:#4e9a06">&#39;{&#34;spec&#34;: {&#34;template&#34;: {&#34;spec&#34;: {&#34;tolerations&#34;: [{&#34;effect&#34;: &#34;NoSchedule&#34;,&#34;key&#34;: &#34;dedicated&#34;,&#34;operator&#34;: &#34;Equal&#34;,&#34;value&#34;: &#34;nginx&#34;}]}}}}&#39;</span> -n nginx
</span></span></code></pre></div><h2 id="5-7-查看所有节点的ip">5.7. 查看所有节点的IP</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get nodes -o<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;{range .items[*]}{.metadata.name}{&#34;\t&#34;}{.status.addresses[0].address}{&#34;\n&#34;}{end}&#39;</span>
</span></span></code></pre></div><h2 id="5-8-查看当前k8s组件leader节点">5.8. 查看当前k8s组件leader节点</h2>
<p>当k8s集群高可用部署的时候，<code>kube-controller-manager</code>和<code>kube-scheduler</code>只能一个服务处于实际逻辑运行状态，通过参数<code>--leader-elect=true</code>来开启选举操作。以下提供查询leader节点的命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get endpoints kube-controller-manager --namespace<span style="color:#ce5c00;font-weight:bold">=</span>kube-system  -o yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Endpoints
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  annotations:
</span></span><span style="display:flex;"><span>    control-plane.alpha.kubernetes.io/leader: <span style="color:#4e9a06">&#39;{&#34;holderIdentity&#34;:&#34;xxx.xxx.xxx.xxx_6537b938-7f5a-11e9-8487-00220d338975&#34;,&#34;leaseDurationSeconds&#34;:15,&#34;acquireTime&#34;:&#34;2019-05-26T02:03:18Z&#34;,&#34;renewTime&#34;:&#34;2019-05-26T02:06:08Z&#34;,&#34;leaderTransitions&#34;:1}&#39;</span>
</span></span><span style="display:flex;"><span>  creationTimestamp: <span style="color:#4e9a06">&#34;2019-05-26T01:52:39Z&#34;</span>
</span></span><span style="display:flex;"><span>  name: kube-controller-manager
</span></span><span style="display:flex;"><span>  namespace: kube-system
</span></span><span style="display:flex;"><span>  resourceVersion: <span style="color:#4e9a06">&#34;1965&#34;</span>
</span></span><span style="display:flex;"><span>  selfLink: /api/v1/namespaces/kube-system/endpoints/kube-controller-manager
</span></span><span style="display:flex;"><span>  uid: f1755fc5-7f58-11e9-b4c4-00220d338975
</span></span></code></pre></div><p>以上表示<code>&quot;holderIdentity&quot;:&quot;xxx.xxx.xxx.xxx</code>为kube-controller-manager的leader节点。</p>
<p>同理，可以通过以下命令查看<code>kube-scheduler</code>的leader节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get endpoints kube-scheduler --namespace<span style="color:#ce5c00;font-weight:bold">=</span>kube-system  -o yaml
</span></span></code></pre></div><h2 id="5-9-修改副本数">5.9. 修改副本数</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl scale deployment.v1.apps/nginx-deployment --replicas<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">10</span>
</span></span></code></pre></div><h2 id="5-10-批量删除pod">5.10. 批量删除pod</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get po -n default <span style="color:#000;font-weight:bold">|</span>grep Evicted <span style="color:#000;font-weight:bold">|</span>awk <span style="color:#4e9a06">&#39;{print $1}&#39;</span> <span style="color:#000;font-weight:bold">|</span>xargs -I <span style="color:#ce5c00;font-weight:bold">{}</span> kubectl delete po  <span style="color:#ce5c00;font-weight:bold">{}</span> -n default
</span></span></code></pre></div><h2 id="5-11-各种查看命令">5.11. 各种查看命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 不使用外部工具来输出解码后的 Secret</span>
</span></span><span style="display:flex;"><span>kubectl get secret my-secret -o go-template<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;{{range $k,$v := .data}}{{&#34;### &#34;}}{{$k}}{{&#34;\n&#34;}}{{$v|base64decode}}{{&#34;\n\n&#34;}}{{end}}&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 列出事件（Events），按时间戳排序</span>
</span></span><span style="display:flex;"><span>kubectl get events --sort-by<span style="color:#ce5c00;font-weight:bold">=</span>.metadata.creationTimestamp
</span></span></code></pre></div><h2 id="5-12-拷贝文件">5.12. 拷贝文件</h2>
<p><strong>从pod拷贝到本地</strong></p>
<p>注意事项：</p>
<ul>
<li>
<p>pod的目录是workdir的相对路径，可以将文件拷贝到workdir下再拷贝出来</p>
</li>
<li>
<p>文件绝对路径前面不能加 /</p>
</li>
<li>
<p>文件目标位置不能为文件夹，必须为文件路径</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl cp -n &lt;ns&gt; -c &lt;container&gt; &lt;pod_name&gt;:&lt;与workdir的相对路径&gt; &lt;本地路径文件名&gt;
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 示例：</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将pod workdir下的prometheus.env.yaml文件拷贝到本地</span>
</span></span><span style="display:flex;"><span>kubectl cp -n prometheus -c prometheus prometheus-0:prometheus.env.yaml ./prometheus.env.yaml
</span></span></code></pre></div><p><strong>从本地拷贝到pod</strong></p>
<p>注意事项：</p>
<ul>
<li>如果没有加路径，默认拷贝到pod内workdir路径。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl cp &lt;本地路径文件名&gt; -n &lt;ns&gt; -c &lt;container&gt; &lt;pod_name&gt;:&lt;与workdir的相对路径&gt; 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 示例：</span>
</span></span><span style="display:flex;"><span>kubectl cp ./prometheus.env.yaml -n prometheus -c prometheus prometheus-0:prometheus.env.yaml 
</span></span></code></pre></div><h2 id="5-13-强制删除namespace">5.13. 强制删除namespace</h2>
<p>如果强制删除ns失败，可以使用以下命令删除，将以下的<code>calico-system</code>改为需要删除的namespace。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get namespaces calico-system -o json <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    <span style="color:#000;font-weight:bold">|</span> tr -d <span style="color:#4e9a06">&#34;\n&#34;</span> <span style="color:#000;font-weight:bold">|</span> sed <span style="color:#4e9a06">&#34;s/\&#34;finalizers\&#34;: \[[^]]\+\]/\&#34;finalizers\&#34;: []/&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    <span style="color:#000;font-weight:bold">|</span> kubectl replace --raw /api/v1/namespaces/calico-system/finalize -f -
</span></span></code></pre></div><h1 id="6-kubectl日志级别">6. kubectl日志级别</h1>
<p>Kubectl 日志输出详细程度是通过 <code>-v</code> 或者 <code>--v</code> 来控制的，参数后跟一个数字表示日志的级别。 Kubernetes 通用的日志习惯和相关的日志级别在 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-instrumentation/logging.md">这里</a> 有相应的描述。</p>
<table>
<thead>
<tr>
<th>详细程度</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--v=0</code></td>
<td>用于那些应该 <em>始终</em> 对运维人员可见的信息，因为这些信息一般很有用。</td>
</tr>
<tr>
<td><code>--v=1</code></td>
<td>如果您不想要看到冗余信息，此值是一个合理的默认日志级别。</td>
</tr>
<tr>
<td><code>--v=2</code></td>
<td>输出有关服务的稳定状态的信息以及重要的日志消息，这些信息可能与系统中的重大变化有关。这是建议大多数系统设置的默认日志级别。</td>
</tr>
<tr>
<td><code>--v=3</code></td>
<td>包含有关系统状态变化的扩展信息。</td>
</tr>
<tr>
<td><code>--v=4</code></td>
<td>包含调试级别的冗余信息。</td>
</tr>
<tr>
<td><code>--v=5</code></td>
<td>跟踪级别的详细程度。</td>
</tr>
<tr>
<td><code>--v=6</code></td>
<td>显示所请求的资源。</td>
</tr>
<tr>
<td><code>--v=7</code></td>
<td>显示 HTTP 请求头。</td>
</tr>
<tr>
<td><code>--v=8</code></td>
<td>显示 HTTP 请求内容。</td>
</tr>
<tr>
<td><code>--v=9</code></td>
<td>显示 HTTP 请求内容而且不截断内容。</td>
</tr>
</tbody>
</table>
<p>参考文章：</p>
<ul>
<li><a href="https://kubernetes.io/docs/reference/kubectl/overview/">https://kubernetes.io/docs/reference/kubectl/overview/</a></li>
<li><a href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/</a></li>
<li><a href="https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/">https://kubernetes.io/zh/docs/reference/kubectl/cheatsheet/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b6a39ccb3e2087cb00af1a7e430cac22">8.2.3 - kubectl命令别名</h1>
    
	<h1 id="1-kubectl-aliases">1. kubectl-aliases</h1>
<p><a href="https://github.com/ahmetb/kubectl-aliases">kubectl-aliases</a>开源工具是由<a href="https://github.com/ahmetb/kubectl-aliases/blob/master/generate_aliases.py">脚本</a>通过拼接各种kubectl相关元素组成的<a href="https://github.com/ahmetb/kubectl-aliases/blob/master/.kubectl_aliases">alias命令别名列表</a>，其中命令别名拼接元素如下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">base</th>
<th style="text-align:left">[system?]</th>
<th style="text-align:left">[operation]</th>
<th style="text-align:left">[resource]</th>
<th style="text-align:left">[flags]</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>k</code>ubectl</td>
<td style="text-align:left">-n=kube-<code>sys</code>tem</td>
<td style="text-align:left"><code>g</code>et<br /> <code>d</code>escribe <br /><code>rm</code>:delete<br /> <code>lo</code>gs<br /> <code>ex</code>ec<br /> <code>a</code>pply</td>
<td style="text-align:left"><code>po</code>ds<br /> <code>dep</code>loyment<br /> <code>sec</code>ret<br /> <code>ing</code>ress<br /> <code>no</code>de <br /><code>svc</code><br /> <code>ns</code> <br /><code>cm</code></td>
<td style="text-align:left"><code>oyaml</code> <br /><code>ojson</code><br /> <code>owide</code> <br /><code>all</code><br /> <code>w</code>atch<br /> <code>f</code>ile<br /> <code>l</code></td>
</tr>
</tbody>
</table>
<ul>
<li><code>k</code>=kubectl
<ul>
<li><strong>sys</strong>=<code>--namespace kube-system</code></li>
</ul>
</li>
<li>commands:
<ul>
<li><strong>g</strong>=<code>get</code></li>
<li><strong>d</strong>=<code>describe</code></li>
<li><strong>rm</strong>=<code>delete</code></li>
<li><strong>a</strong>:<code>apply -f</code></li>
<li><strong>ex</strong>: <code>exec -i -t</code></li>
<li><strong>lo</strong>: <code>logs -f</code></li>
</ul>
</li>
<li>resources:
<ul>
<li><strong>po</strong>=<code>pod</code></li>
<li><strong>dep</strong>=<code>deployment</code></li>
<li><strong>ing</strong>=<code>ingress</code></li>
<li><strong>svc</strong>=<code>service</code></li>
<li><strong>cm</strong>=<code>configmap</code></li>
<li><strong>sec</strong>=<code>secret</code></li>
<li><strong>ns</strong>=<code>namespace</code></li>
<li><strong>no</strong>=<code>node</code></li>
</ul>
</li>
<li>flags:
<ul>
<li>output format: <strong>oyaml</strong>, <strong>ojson</strong>, <strong>owide</strong></li>
<li><strong>all</strong>: <code>--all</code> or <code>--all-namespaces</code> depending on the command</li>
<li><strong>sl</strong>: <code>--show-labels</code></li>
<li><strong>w</strong>=<code>-w/--watch</code></li>
</ul>
</li>
<li>value flags (should be at the end):
<ul>
<li><strong>f</strong>=<code>-f/--filename</code></li>
<li><strong>l</strong>=<code>-l/--selector</code></li>
</ul>
</li>
</ul>
<h1 id="2-示例">2. 示例</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 示例1</span>
</span></span><span style="display:flex;"><span>kd → kubectl describe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 示例2</span>
</span></span><span style="display:flex;"><span>kgdepallw → kubectl get deployment —all-namespaces —watch
</span></span></code></pre></div><p><strong>alias get示例：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">k</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;kubectl&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">kg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;kubectl get&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">kgpo</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;kubectl get pods&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">kgpoojson</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;kubectl get pods -o=json&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">kgpon</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;kubectl get pods --namespace&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">ksysgpooyamll</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;kubectl --namespace=kube-system get pods -o=yaml -l&#39;</span>
</span></span></code></pre></div><h1 id="3-安装">3. 安装</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将 .kubectl_aliases下载到 home 目录</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~ <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> wget https://raw.githubusercontent.com/ahmetb/kubectl-aliases/master/.kubectl_aliases
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将以下内容添加到 .bashrc中，并执行 source .bashrc</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> -f ~/.kubectl_aliases <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">source</span> ~/.kubectl_aliases
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> kubectl<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#204a87">command</span> kubectl <span style="color:#000">$@</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果需要提示别名的完整命令，则将以下内容添加到 .bashrc中，并执行 source .bashrc</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span> -f ~/.kubectl_aliases <span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">source</span> ~/.kubectl_aliases
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">function</span> kubectl<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;+ kubectl </span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">command</span> kubectl <span style="color:#000">$@</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://ahmet.im/blog/kubectl-aliases/">https://ahmet.im/blog/kubectl-aliases/</a></li>
<li><a href="https://github.com/ahmetb/kubectl-aliases">https://github.com/ahmetb/kubectl-aliases</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-32ca647b0526bb2667f33718069312c1">8.2.4 - kubectl进入node shell</h1>
    
	<p>本文介绍如何通过kubectl进入节点的shell环境。</p>
<h2 id="1-安装krew-node-shell">1. 安装krew node-shell</h2>
<h3 id="1-1-安装krew">1.1. 安装krew</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">set</span> -x<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">cd</span> <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>mktemp -d<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">OS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>uname <span style="color:#000;font-weight:bold">|</span> tr <span style="color:#4e9a06">&#39;[:upper:]&#39;</span> <span style="color:#4e9a06">&#39;[:lower:]&#39;</span><span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>uname -m <span style="color:#000;font-weight:bold">|</span> sed -e <span style="color:#4e9a06">&#39;s/x86_64/amd64/&#39;</span> -e <span style="color:#4e9a06">&#39;s/\(arm\)\(64\)\?.*/\1\2/&#39;</span> -e <span style="color:#4e9a06">&#39;s/aarch64$/arm64/&#39;</span><span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">KREW</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;krew-</span><span style="color:#4e9a06">${</span><span style="color:#000">OS</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">_</span><span style="color:#4e9a06">${</span><span style="color:#000">ARCH</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>  curl -fsSLO <span style="color:#4e9a06">&#34;https://github.com/kubernetes-sigs/krew/releases/latest/download/</span><span style="color:#4e9a06">${</span><span style="color:#000">KREW</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">.tar.gz&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>  tar zxvf <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">KREW</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">.tar.gz&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>  ./<span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">KREW</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> install krew
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>在<code>~/.bashrc</code>或<code>~/.zshrc</code>添加以下命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">PATH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">KREW_ROOT</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">$HOME</span><span style="color:#000;font-weight:bold">/.krew</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/bin:</span><span style="color:#000">$PATH</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><h3 id="1-2-安装node-shell">1.2. 安装node-shell</h3>
<p>node-shell的代码参考：<a href="https://github.com/kvaps/kubectl-node-shell/blob/master/kubectl-node_shell">kubectl-node-shell/kubectl-node_shell at master · kvaps/kubectl-node-shell · GitHub</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl krew install node-shell
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl krew install node-shell</span>
</span></span><span style="display:flex;"><span>Updated the <span style="color:#204a87">local</span> copy of plugin index.
</span></span><span style="display:flex;"><span>Installing plugin: node-shell
</span></span><span style="display:flex;"><span>Installed plugin: node-shell
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span> <span style="color:#000;font-weight:bold">|</span> Use this plugin:
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">|</span>     kubectl node-shell
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">|</span> Documentation:
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">|</span>     https://github.com/kvaps/kubectl-node-shell
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">|</span> Caveats:
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">|</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span> <span style="color:#000;font-weight:bold">|</span>  <span style="color:#000;font-weight:bold">|</span> You need to be allowed to start privileged pods in the cluster
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">|</span> /
</span></span><span style="display:flex;"><span>/
</span></span><span style="display:flex;"><span>WARNING: You installed plugin <span style="color:#4e9a06">&#34;node-shell&#34;</span> from the krew-index plugin repository.
</span></span><span style="display:flex;"><span>   These plugins are not audited <span style="color:#204a87;font-weight:bold">for</span> security by the Krew maintainers.
</span></span><span style="display:flex;"><span>   Run them at your own risk.
</span></span></code></pre></div><h2 id="2-进入节点的shell">2. 进入节点的shell</h2>
<h3 id="2-1-登录node">2.1. 登录node</h3>
<p>创建一个临时的特权容器，登录容器即登录node shell。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl node-shell &lt;node-name&gt;
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl node-shell node1</span>
</span></span><span style="display:flex;"><span>spawning <span style="color:#4e9a06">&#34;nsenter-9yqytp&#34;</span> on <span style="color:#4e9a06">&#34;node1&#34;</span>
</span></span><span style="display:flex;"><span>If you don<span style="color:#a40000">&#39;</span>t see a <span style="color:#204a87">command</span> prompt, try pressing enter.
</span></span><span style="display:flex;"><span>groups: cannot find name <span style="color:#204a87;font-weight:bold">for</span> group ID <span style="color:#0000cf;font-weight:bold">11</span>
</span></span><span style="display:flex;"><span>To run a <span style="color:#204a87">command</span> as administrator <span style="color:#ce5c00;font-weight:bold">(</span>user <span style="color:#4e9a06">&#34;root&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>, use <span style="color:#4e9a06">&#34;sudo &lt;command&gt;&#34;</span>.
</span></span><span style="display:flex;"><span>See <span style="color:#4e9a06">&#34;man sudo_root&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> details.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@node1:/#
</span></span></code></pre></div><h3 id="2-2-退出node">2.2. 退出node</h3>
<p>退出容器，容器会被自动删除。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># exit</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">logout</span>
</span></span><span style="display:flex;"><span>pod default/nsenter-9yqytp terminated <span style="color:#ce5c00;font-weight:bold">(</span>Error<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;nsenter-9yqytp&#34;</span> deleted
</span></span></code></pre></div><h2 id="3-原理">3. 原理</h2>
<p>容器是弱隔离，共享节点的内核，通过cgroup和namespace来实现进程级别的隔离。那么通过在特权容器里执行<code>nsenter</code>的命令，则可以通过登录特权容器来实现登录node的shell环境。</p>
<p>创建一个特权容器，进入node shell的命令为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nsenter --target <span style="color:#0000cf;font-weight:bold">1</span> --mount --uts --ipc --net --pid -- bash -l
</span></span></code></pre></div><p>进入 node shell 的权限：</p>
<ul>
<li>
<p><code>hostPID: true</code> 共享 host 的 pid</p>
</li>
<li>
<p><code>hostNetwork: true</code> 共享 host 的网络</p>
</li>
<li>
<p><code>privileged: true</code>: PSP 权限策略是 <code>privileged</code>, 即完全无限制。</p>
</li>
</ul>
<h3 id="3-1-pod-yaml">3.1. Pod.yaml</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">run</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nsenter-9yqytp</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nsenter-9yqytp</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">nsenter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- --<span style="color:#000">target</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- --<span style="color:#000">mount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- --<span style="color:#000">uts</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- --<span style="color:#000">ipc</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- --<span style="color:#000">net</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- --<span style="color:#000">pid</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- --<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">bash</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- -<span style="color:#000">l</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">docker.io/library/alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Always</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nsenter</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">256Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">256Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">securityContext</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">privileged</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">stdin</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">stdinOnce</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">tty</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/run/secrets/kubernetes.io/serviceaccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kube-api-access-4ktlf</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">readOnly</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">enableServiceLinks</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hostNetwork</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">hostPID</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">nodeName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">preemptionPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PreemptLowerPriority</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">priority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">restartPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Never</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">schedulerName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default-scheduler</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">securityContext</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">serviceAccount</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">serviceAccountName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">tolerations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CriticalAddonsOnly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Exists</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">effect</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NoExecute</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Exists</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kube-api-access-4ktlf</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">projected</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">defaultMode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">420</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">sources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">serviceAccountToken</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">expirationSeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3607</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">token</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">configMap</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">items</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ca.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ca.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kube-root-ca.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">downwardAPI</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">items</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:bold">fieldRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">fieldPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metadata.namespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">namespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建完容器后，直接登录容器即可登录节点的shell</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl <span style="color:#204a87">exec</span> -it nsenter-9yqytp bash
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://ewhisper.cn/posts/20749/">如何通过 kubectl 进入 node shell - 东风微鸣技术博客</a></p>
</li>
<li>
<p><a href="https://github.com/kvaps/kubectl-node-shell">GitHub - kvaps/kubectl-node-shell: Exec into node via kubectl</a></p>
</li>
<li>
<p><a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/">https://krew.sigs.k8s.io/docs/user-guide/setup/install/</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ada877dc6e2d7b482edcb6caffb98648">8.2.5 - kubeconfig的使用</h1>
    
	<h1 id="1-kubeconfig说明">1. kubeconfig说明</h1>
<p>默认情况下，<code>kubectl</code> 在 <code>$HOME/.kube</code> 目录下查找名为 <code>config</code> 的文件。 你可以通过设置 <code>KUBECONFIG</code> 环境变量或者设置 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl/"><code>--kubeconfig</code></a>参数来指定其他 kubeconfig 文件。</p>
<p>kubeconfig内容示例：</p>
<p>以下证书以文件的形式读取。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">clusters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">certificate-authority</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">*/ca.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://******</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">contexts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">context</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">current-context</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">preferences</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">client-certificate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">*/client.crt</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">client-key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">*/client.key</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="2-将-kubeconfig-中的证书文件转为证书数据">2. 将 Kubeconfig 中的证书文件转为证书数据</h1>
<h2 id="2-1-证书文件转为证书数据">2.1. 证书文件转为证书数据</h2>
<p>如果需要将证书文件替换为证书数据格式，可以通过base64的命令解码成data数据，同时修改相应的参数。</p>
<p>获取证书文件的 base64 编码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat <span style="color:#4e9a06">&#34;证书文件&#34;</span> <span style="color:#000;font-weight:bold">|</span> base64
</span></span></code></pre></div><p>将输出结果的换行符去掉，填到对应证书的data中。</p>
<ol>
<li>
<p>将 <code>certificate-authority</code> 改为 <code>certificate-authority-data</code>，并且将 <code>*/ca.crt</code> 证书文件经 base64 编码后的字符串填入该位置。</p>
</li>
<li>
<p>将 <code>client-certificate</code> 改为 <code>client-certificate-data</code>，并且将 <code>*/client.crt</code> 证书文件经 base64 编码后的字符串填入该位置。</p>
</li>
<li>
<p>将 <code>client-key</code> 改为 <code>client-key-data</code>，并且将 <code>*/client.key</code> 证书文件 base64 编码后的字符串填入该位置。</p>
</li>
</ol>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Config</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">clusters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">certificate-authority-data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LS0tLS1CRUdJTiBDRVJUSUZADQFURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwdGFXNXAKYTNWaVpVTkJNQjRYRFRJd01ESXhNREEwTURJMU1Wb1hEVE13TURJd09EQTBNREkxTVZvd0ZURVRNQkVHQTFVRQpBeE1LYldsdWFXdDFZbVZEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTUc1CjYwU0txcHVXeE1mWlVabmVFakM5bjFseHFQSzdUTlVQbzROejFWcWxaQkt6NzJDVVErZjBtVGNQLy9oS3BQUVAKaG9pNndyaXJRUmVERTErRFIrOTZHVDIrSGZ3L2VHQTI5ZmErNS80UG5PWlpTUEVpS3MxVVdhc0VqSDJVZG4xTwpEejVRZk1ESkFjZlBoTzV0eUZFaGZNa2hid0Y2QkJONnh5RmJJdXl4OThmZGx5SWJJUnpLSml6VWZQcUx2WUZoCmFQbjF4WFZyT2QyMnFtblgzL2VxZXM4aG51SmpJdlVPbWRDRlhjQVRYdE00Wmw2bERvWUs2VS9vaEFzM0x4VzAKWUV4ZkcxMzFXdjIrR0t4WWV2Q0FuMitSQ3NBdFpTZk9zcVljMmorYS9FODVqdzcySlFkNGd6eGlHMCszaU14WApWaGhpcWFrY1owZlRCc0FtZHY4Q0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXCk1CUUdDQ3NHQVFVRkJ3TUNCZ2dyQmdFRkJRY0RBVEFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFDKzFuU2w0dnJDTEV6eWg0VWdXR3ZWSldtV2ltM2dBWFFJU1R2WG56NXZqOXE3Z0JYSwpCRVUyakVHTFF2UEJQWUZwUjhmZllCZCtqT2xtYS9IdU9ISmw0RUxhaHJKbnIwaU9YcytoeVlpV0ZUKzZ2R05RCmY4QnAvNTlkYzY1ejVVMnlUQjd4VkhMcGYzRTRZdUN2NmZhdy9PZTNUUzZUbThZdFBXREgxNDBOR2ZKMHlWRlYKSzZsQnl5THMwMzZzT1V5ZUJpcEduOUxyKytvb09mTVZIU2dpaEJlcEl3ZVVvYk05YU1ram1Hb2VjNk5HTUN3NwpkaFNWTmdMNGxMSnRvRktoVDdTZHFjMmk2SWlwbkJrdUlHUWRJUFliQnF6MkN5eVMyRkZmeEJsV2lmNmcxMTFTClphSUlpQ0lLbXNqeDJvTFBhOUdNSjR6bERNR1hLY1ZyNnhhVQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">https://******</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">contexts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">context</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">cluster</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">current-context</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">preferences</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">users</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">client-certificate-data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURBRENDQWVpZ0F3SUJBZ0lCQWpBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwdGFXNXAKYTNWaVpVTkJNQjRYRFRJd01ESXhNekV5TXpreU5sb1hEVEl4TURJeE16RXlNemt5Tmxvd01URVhNQlVHQTFVRQpDaE1PYzNsemRHVnRPbTFoYzNSbGNuTXhGakFVQmdOVkJBTVREVzFwYm1scmRXSmxMWFZ6WlhJd2dnRWlNQTBHCkNTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDdEp5MThYOGVBaVlJc1g3Z0xQazBOZEFuRlNJU0kKeXNGMGIzS21CTk9VclRIcGtnaUFwRldmZDJaVXNZR3Iwd0VBL0FIWm9PMUxPUHdqYzEyb2o1bGIwWlNNWTlMaQpVeW9UQ3huREZIVDJIQnlPNCtGRk5pVCtXTU5FTURURWxERXhlano1WVIwb1pZVjN2V2Z5T3l2SlBna1dFU29IClVVcnVvQmRRbU5LUzhCeXhIUmFvcnFJUFRVRGkzUFJIbTlGZERKV1lNTWpnbDZmbmdHWkRQMnpjTlNFZjRGNzYKc2FUK0VhMU1kbjV5akRCNXczaHJvZXBBclc0QVUyR3NTRFZyTHY2UDFiSWV0RDdONjZrT1BBNklIUlRKbUNLLwp2aEJrbGVPMGFwcERzTERDT3hpMkc2Q1BRNDZVYVZUOEhZMk9sQU5nSmtRRDNwYjFXTnlhQlVpRkFnTUJBQUdqClB6QTlNQTRHQTFVZER3RUIvd1FFQXdJRm9EQWRCZ05WSFNVRUZqQVVCZ2dyQmdFRkJRY0RBUVlJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBTHVrZ1dxWnRtbkZITlcxYgpqL012ekcxTmJyUEtWYXVobml5RzRWWnRZYzR1Uk5iSGhicEhEdThyamc2dVB1Y0xMdHAzblU2UGw4S2J2WFpiCmplNmJQR2xvV3VBcFIrVW9KRFQ2VEpDK2o2Qm5CSXpWQkNOL21lSWVPQ0hEK1k5L2dtbzRnd2Q4c2F3U0Z1bjMKZTFVekF2cHBwdTVZY05wcU92aUkxT2NjNGdxNTd2V1h1MFRIdUJkM0VtQ2JZRXUzYXhOL25ldnhOYnYxbDFRSQovSzRaOWw3MXFqaEp3SVlBaHUzek5pTWpCU1VTRjJkZnd2NmFnclhSUnN6b1Z4ejE5Mm9qM2pWU215cXZxeVFrCmZXckpsc3VhY1NDdTlKUE44OUQrVXkwVnZXZmhPdmp4cXVRSktwUW9hMzlQci81Q3YweXFKUkFIMkk5Wk1IZEYKNkJQRVBRPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">client-key-data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVQSLS0tLQpNSUlFcEFJQkFBS0NBUUVBclNjdGZGL0hnSW1DTEYrNEN6NU5EWFFKeFVpRWlNckJkRzl5cGdUVGxLMHg2WklJCmdLUlZuM2RtVkxHQnE5TUJBUHdCMmFEdFN6ajhJM05kcUkrWlc5R1VqR1BTNGxNcUV3c1p3eFIwOWh3Y2p1UGgKUlRZay9sakRSREEweEpReE1YbzgrV0VkS0dXRmQ3MW44anNyeVQ0SkZoRXFCMUZLN3FBWFVKalNrdkFjc1IwVwpxSzZpRDAxQTR0ejBSNXZSWFF5Vm1EREk0SmVuNTRCbVF6OXMzRFVoSCtCZStyR2svaEd0VEhaK2Nvd3dlY040CmE2SHFRSzF1QUZOaHJFZzFheTcrajlXeUhyUSt6ZXVwRGp3T2lCMFV5Wmdpdjc0UVpKWGp0R3FhUTdDd3dqc1kKdGh1Z2owT09sR2xVL0IwdGpwUURZQ1pFQTk2VzlWamNtZ1ZJaFFJREFRQUJBb0lCQUdDazVGTnVGaWtkRndYegphd01EZy9oRlV3ckZIZ3hIdHRCcFFBRi80aVF5d3hBT0RTYllFbDVPUTFSME90OFBoNWpvRDVSTHFRWjZTT2owCmhFc0gwMTRYVFNWS3RqTFNua0pBeU9GRWNyL0hFdjJDSFlNRzVJRCtSQWEwTFUrbk13bmRvMWpCcG9lY21uRXAKeTNHOUt3Ukkxc04xVXhNQWdhVk12NWFocGE2UzRTdENpalh3VGVVWUxpc1pSZGp5UGljUWlQN0xaSnhBcjRLTgpTUHlDNE1IZTJtV3F3cjM5cnBrMWZ3WkViMTRPMjR2Z3dMYmROTFJYdVhZSTdicEpOUGRJbEQvRExOQkJSL0FVCjhJYjNDaTZwZ2M4dFA4VzJCeW9TQUJVZUNpWDRFM21wQUttVytKbzFuU3FwQ1FnM2JGV0RpRjFrKzdEZjJZM3IKc09UT0srVUNnWUVBMTBEb3BtRVcrNnowanZadVFZdFlPWlVQQzZwV0dBaDFLWlVHZndYVWVLQ3dnNlNuQW9qRwpuMjR4bWJVdTlzRzBjd2syK0VVcXh3S2IrR2NJVTdyNVdOaUNXNVZYQzV5ZUp3OFZiMWtQekRzMSs4YzA4VjNhCkkzNHluOHpjZm1WTkZOUm1ZS1FMK1FGbnZ3ZXM4NFRleGVBb1hGY2FQcVZTNDNVV2JHRW02ZThDZ1lFQXplNFkKeUxYQ2pWNVppajFsUTdkQ2FweEQvL0dCT2JsemRocXRuSjl1OWxyVkQ4Y3RvUEVKYVkwVFFWc3FaNVhCdTNtVApLb0w4bmZjWHg4cWR3Z3gvZFRHa2c3d00rZFkrUTFuVDNOWnRFSVdVUkR3T0hLT1N1Tm5kdnU1a1Q4aXRrdHhhCktrYVlSMlNOT25iMlFzb1ZHa3F5OS9QK0xWL0FyeWdScmtaYXVNc0NnWUVBaGpUTkdUYzltaXNxeTV2d0FHTzkKM1NFSG9YRlJmbWgvakM2RFAxMUdMUE9iT21qRlREbzFCS0F5d3JBSm1RWUsyUkpzdUh4L2dGY3JJY1F6bCtqaQpvRGRWaDM1a0tEUTlFd00valE0TllIdW1XOVhITjVvWmNMbTFISmNnL3Bsd1pzVkxFNFFVaHVzT1lUZUs2TVgyCkU0OS8rcHJBSFVEOG5oNlpuWGN4U1BjQ2dZRUFub0lQcDZab1MwSjliMi9VbTJ2YS9vNnJ0TDBpOTlpc2JCTWEKNFR6RFAzTXBIc3owYlRZN1JYaW1ncDcybytiY3lUNUtMZVhISnB3RVBPL1R3SUs0Tk8veUxzZzN3TExOR0RCegphRC9Ra1hBUWNQazg3NFJrc2s1WVpkZS9kTDRHQk00QnhScXpxZmhXME5LeXVUUXRUQ0NGWTEvMm5OeGdSekp6CmNZNkwxRU1DZ1lCdXpHRkJVeXM4TFpHekFNTWdmN1VRQ0dVZERrT2dJRHdzd0dxVVlxQ2ZLcnlGYVdCOUJvSi8KMnJMVmVYNDVXTnFpa0tCMlgvckdRbGFIK25YalRBaDlpN0NrWGRySUQzeXA1cGJBa0VnYjg3dGo2Y3hONlBOcQo5cnhzOU1lR0NleFhsdjBkUUpMUkowNXU2OEVxYm44Q0RIOXFRSWZaTml0NXA0S0JFVkp3L1E9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-2-证书数据转成证书文件">2.2. 证书数据转成证书文件</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grep <span style="color:#4e9a06">&#39;certificate-authority-data&#39;</span> /etc/kubernetes/admin.conf <span style="color:#000;font-weight:bold">|</span> head -n <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $2}&#39;</span> <span style="color:#000;font-weight:bold">|</span> base64 -d &gt; ca.crt
</span></span><span style="display:flex;"><span>grep <span style="color:#4e9a06">&#39;client-key-data&#39;</span> /etc/kubernetes/admin.conf <span style="color:#000;font-weight:bold">|</span> head -n <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $2}&#39;</span> <span style="color:#000;font-weight:bold">|</span> base64 -d &gt; client.key
</span></span><span style="display:flex;"><span>grep <span style="color:#4e9a06">&#39;client-certificate-data&#39;</span> /etc/kubernetes/admin.conf <span style="color:#000;font-weight:bold">|</span> head -n <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $2}&#39;</span> <span style="color:#000;font-weight:bold">|</span> base64 -d &gt; client.crt
</span></span></code></pre></div><h1 id="3-生成admin的kubeconfig">3. 生成admin的kubeconfig</h1>
<h1 id="4-生成namespace的kubeconfig">4. 生成namespace的kubeconfig</h1>
<h1 id="5-创建token来访问apiserver">5. 创建token来访问apiserver</h1>
<p>参考：</p>
<ul>
<li><a href="https://coding.net/help/docs/cd/question/convert-certfile-to-certdata.html">如何将 Kubeconfig 中的证书文件转为证书数据 - CODING 帮助中心</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6e74d886e5b15f816335ffec854ee6d3">8.3 - 节点迁移</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-ebf0ed02e505f9821b61779a584ab361">8.3.1 - 指定节点调度与隔离</h1>
    
	<h1 id="1-nodeselector">1. NodeSelector</h1>
<h2 id="1-1-概念">1.1. 概念</h2>
<p>如果需要<code>限制Pod到指定的Node</code>上运行，则可以给Node打标签并给Pod配置NodeSelector。</p>
<h2 id="1-2-使用方式">1.2. 使用方式</h2>
<h3 id="1-2-1-给node打标签">1.2.1. 给Node打标签</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># get node的name</span>
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置Label</span>
</span></span><span style="display:flex;"><span>kubectl label nodes &lt;node-name&gt; &lt;label-key&gt;<span style="color:#ce5c00;font-weight:bold">=</span>&lt;label-value&gt;
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如</span>
</span></span><span style="display:flex;"><span>kubectl label nodes node-1 <span style="color:#000">disktype</span><span style="color:#ce5c00;font-weight:bold">=</span>ssd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看Node的Label</span>
</span></span><span style="display:flex;"><span>kubectl get nodes --show-labels
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除Node的label</span>
</span></span><span style="display:flex;"><span>kubectl label node &lt;node-name&gt; &lt;label-key&gt;-
</span></span></code></pre></div><h3 id="1-2-2-给pod设置nodeselector">1.2.2. 给Pod设置NodeSelector</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">IfNotPresent</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">nodeSelector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">disktype</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ssd   </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 对应Node的Label</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="1-3-亲和性-affinity-和反亲和性-anti-affinity">1.3. 亲和性（Affinity）和反亲和性（Anti-affinity）</h2>
<blockquote>
<p>待补充</p>
</blockquote>
<h1 id="2-taint-和-toleration">2. Taint 和 Toleration</h1>
<h2 id="2-1-概念">2.1. 概念</h2>
<p><code>nodeSelector</code>可以通过<code>打标签</code>的形式让Pod被调度到指定的Node上，<code>Taint </code>则相反，它使节点能够排斥一类特定的Pod，除非Pod被指定了<code>toleration</code>的标签。（<code>taint</code>即污点，Node被打上污点；只有容忍[toleration]这些污点的Pod才可能被调度到该Node）。</p>
<h2 id="2-2-使用方式">2.2. 使用方式</h2>
<h3 id="2-2-1-kubectl-taint">2.2.1. kubectl taint</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 给节点增加一个taint，它的key是&lt;key&gt;，value是&lt;value&gt;，effect是NoSchedule。</span>
</span></span><span style="display:flex;"><span>kubectl taint nodes &lt;node_name&gt; &lt;key&gt;<span style="color:#ce5c00;font-weight:bold">=</span>&lt;value&gt;:NoSchedule
</span></span></code></pre></div><p>只有拥有和这个<code>taint</code>相匹配的<code>toleration</code>的pod才能够被分配到 <code>node_name</code> 这个节点。</p>
<p>例如，在 <code>PodSpec</code> 中定义 pod 的 toleration：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">tolerations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Equal&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">effect</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;NoSchedule&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">tolerations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Exists&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">effect</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;NoSchedule&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="2-2-2-匹配规则">2.2.2. 匹配规则：</h3>
<p>一个 toleration 和一个 taint 相“匹配”是指它们有一样的 key 和 effect ，并且：</p>
<ul>
<li>如果 <code>operator</code> 是 <code>Exists</code> （此时 toleration 不能指定 <code>value</code>）</li>
<li>如果 <code>operator</code> 是 <code>Equal</code> ，则它们的 <code>value</code> 应该相等</li>
</ul>
<p><strong>特殊情况：</strong></p>
<ul>
<li>
<p>如果一个 toleration 的 <code>key</code> 为空且 operator 为 <code>Exists</code> ，表示这个 toleration 与任意的 key 、 value 和 effect 都匹配，即这个 toleration 能容忍任意 taint。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">tolerations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Exists&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
<li>
<p>如果一个 toleration 的 <code>effect</code> 为空，则 <code>key</code> 值与之相同的相匹配 taint 的 <code>effect</code> 可以是任意值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">tolerations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Exists&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<p>一个节点可以设置多个taint，一个pod也可以设置多个toleration。Kubernetes 处理多个 taint 和 toleration 的过程就像一个过滤器：从一个节点的所有 taint 开始遍历，过滤掉那些 pod 中存在与之相匹配的 toleration 的 taint。余下未被过滤的 taint 的 effect 值决定了 pod 是否会被分配到该节点，特别是以下情况：</p>
<ul>
<li>如果未被过滤的 taint 中存在一个以上 effect 值为 <code>NoSchedule</code> 的 taint，则 Kubernetes 不会将 pod 分配到该节点。</li>
<li>如果未被过滤的 taint 中不存在 effect 值为 <code>NoSchedule</code> 的 taint，但是存在 effect 值为 <code>PreferNoSchedule</code> 的 taint，则 Kubernetes 会<em>尝试</em>将 pod 分配到该节点。</li>
<li>如果未被过滤的 taint 中存在一个以上 effect 值为 <code>NoExecute</code> 的 taint，则 Kubernetes 不会将 pod 分配到该节点（如果 pod 还未在节点上运行），或者将 pod 从该节点驱逐（如果 pod 已经在节点上运行）。</li>
</ul>
<h2 id="2-2-3-effect的类型">2.2.3. effect的类型</h2>
<ul>
<li>
<p><code>NoSchedule</code>：只有拥有和这个 taint 相匹配的 toleration 的 pod 才能够被分配到这个节点。</p>
</li>
<li>
<p><code>PreferNoSchedule</code>：系统会<em>尽量</em>避免将 pod 调度到存在其不能容忍 taint 的节点上，但这不是强制的。</p>
</li>
<li>
<p><code>NoExecute</code> ：任何不能忍受这个 taint 的 pod 都会马上被驱逐，任何可以忍受这个 taint 的 pod 都不会被驱逐。Pod可指定属性 <code>tolerationSeconds</code> 的值，表示pod 还能继续在节点上运行的时间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">tolerations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;key1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Equal&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;value1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">effect</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;NoExecute&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">tolerationSeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3600</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div></li>
</ul>
<h2 id="2-3-使用场景">2.3. 使用场景</h2>
<h3 id="2-3-1-专用节点">2.3.1. 专用节点</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl taint nodes &lt;nodename&gt; <span style="color:#000">dedicated</span><span style="color:#ce5c00;font-weight:bold">=</span>&lt;groupName&gt;:NoSchedule
</span></span></code></pre></div><p>先给Node添加taint，然后给Pod添加相对应的 toleration，则该Pod可调度到taint的Node，也可调度到其他节点。</p>
<p>如果想<strong>让Pod只调度某些节点且某些节点只接受对应的Pod</strong>，则需要在Node上添加<code>Label</code>（例如：<code>dedicated=groupName</code>），同时给Pod的<code>nodeSelector</code>添加对应的<code>Label</code>。</p>
<h3 id="2-3-2-特殊硬件节点">2.3.2. 特殊硬件节点</h3>
<p>如果某些节点配置了特殊硬件（例如CPU），希望不使用这些特殊硬件的Pod不被调度该Node，以便保留必要资源。即可给Node设置<code>taint</code>和<code>label</code>，同时给Pod设置<code>toleration</code>和<code>label</code>来使得这些Node专门被指定Pod使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl taint</span>
</span></span><span style="display:flex;"><span>kubectl taint nodes nodename <span style="color:#000">special</span><span style="color:#ce5c00;font-weight:bold">=</span>true:NoSchedule 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或者</span>
</span></span><span style="display:flex;"><span>kubectl taint nodes nodename <span style="color:#000">special</span><span style="color:#ce5c00;font-weight:bold">=</span>true:PreferNoSchedule
</span></span></code></pre></div><h3 id="2-3-3-基于taint驱逐">2.3.3. 基于taint驱逐</h3>
<p>effect 值 <code>NoExecute</code> ，它会影响已经在节点上运行的 pod，即根据策略对Pod进行驱逐。</p>
<ul>
<li>如果 pod 不能忍受effect 值为 <code>NoExecute</code> 的 taint，那么 pod 将马上被驱逐</li>
<li>如果 pod 能够忍受effect 值为 <code>NoExecute</code> 的 taint，但是在 toleration 定义中没有指定 <code>tolerationSeconds</code>，则 pod 还会一直在这个节点上运行。</li>
<li>如果 pod 能够忍受effect 值为 <code>NoExecute</code> 的 taint，而且指定了 <code>tolerationSeconds</code>，则 pod 还能在这个节点上继续运行这个指定的时间长度。</li>
</ul>
<p>参考：</p>
<ul>
<li>
<p><a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/">https://kubernetes.io/docs/concepts/configuration/assign-pod-node/</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/">https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-35b75b0abb0e69e39b5c84c9866abbdb">8.3.2 - 安全迁移节点</h1>
    
	<h1 id="1-迁移pod">1. 迁移Pod</h1>
<h2 id="1-1-设置节点是否可调度">1.1. 设置节点是否可调度</h2>
<p>确定需要迁移和被迁移的节点，将不允许被迁移的节点设置为不可调度。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看节点</span>
</span></span><span style="display:flex;"><span>kubectl get nodes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置节点为不可调度</span>
</span></span><span style="display:flex;"><span>kubectl cordon &lt;NodeName&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置节点为可调度</span>
</span></span><span style="display:flex;"><span>kubectl uncordon &lt;NodeName&gt;
</span></span></code></pre></div><h2 id="1-2-执行kubectl-drain命令">1.2. 执行kubectl drain命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 驱逐节点的所有pod</span>
</span></span><span style="display:flex;"><span>kubectl drain &lt;NodeName&gt; --force --ignore-daemonsets
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 驱逐指定节点的pod</span>
</span></span><span style="display:flex;"><span>kubectl drain  &lt;NodeName&gt; --ignore-daemonsets	--pod-selector<span style="color:#ce5c00;font-weight:bold">=</span>pod-template-hash<span style="color:#ce5c00;font-weight:bold">=</span>88964949c
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl drain bjzw-prek8sredis-99-40 --force --ignore-daemonsets
</span></span><span style="display:flex;"><span>node <span style="color:#4e9a06">&#34;bjzw-prek8sredis-99-40&#34;</span> already cordoned
</span></span><span style="display:flex;"><span>WARNING: Deleting pods not managed by ReplicationController, ReplicaSet, Job, DaemonSet or StatefulSet: kube-proxy-bjzw-prek8sredis-99-40<span style="color:#000;font-weight:bold">;</span> Ignoring DaemonSet-managed pods: calicoopsmonitor-mfpqs, arachnia-agent-j56n8
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;pre-test-pro2-r-0-redis-2-8-19-1&#34;</span> evicted
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;pre-test-hwh1-r-8-redis-2-8-19-2&#34;</span> evicted
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;pre-eos-hdfs-vector-eos-hdfs-redis-2-8-19-0&#34;</span> evicted
</span></span></code></pre></div><h2 id="1-3-特别说明">1.3. 特别说明</h2>
<p>对于statefulset创建的Pod，kubectl drain的说明如下：</p>
<p>kubectl drain操作会将相应节点上的旧Pod删除，并在可调度节点上面起一个对应的Pod。当旧Pod没有被正常删除的情况下，新Pod不会起来。例如：旧Pod一直处于<code>Terminating</code>状态。</p>
<p>对应的解决方式是通过重启相应节点的kubelet，或者强制删除该Pod。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重启发生`Terminating`节点的kubelet</span>
</span></span><span style="display:flex;"><span>systemctl restart kubelet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 强制删除`Terminating`状态的Pod</span>
</span></span><span style="display:flex;"><span>kubectl delete pod &lt;PodName&gt; --namespace<span style="color:#ce5c00;font-weight:bold">=</span>&lt;Namespace&gt; --force --grace-period<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><h1 id="2-kubectl-drain-流程图">2. kubectl drain 流程图</h1>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1537259779/article/kubernetes/operation/kubectl-drain.svg" width="100%">
<h1 id="3-troubleshooting">3. TroubleShooting</h1>
<p>1、存在不是通过<code>ReplicationController</code>, <code>ReplicaSet</code>, <code>Job</code>, <code>DaemonSet</code> 或者<code> StatefulSet</code>创建的Pod（即静态pod，通过文件方式创建的），所以需要设置强制执行的参数<code>--force</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl drain bjzw-prek8sredis-99-40
</span></span><span style="display:flex;"><span>node <span style="color:#4e9a06">&#34;bjzw-prek8sredis-99-40&#34;</span> already cordoned
</span></span><span style="display:flex;"><span>error: unable to drain node <span style="color:#4e9a06">&#34;bjzw-prek8sredis-99-40&#34;</span>, aborting command...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>There are pending nodes to be drained:
</span></span><span style="display:flex;"><span> bjzw-prek8sredis-99-40
</span></span><span style="display:flex;"><span>error: DaemonSet-managed pods <span style="color:#ce5c00;font-weight:bold">(</span>use --ignore-daemonsets to ignore<span style="color:#ce5c00;font-weight:bold">)</span>: calicoopsmonitor-mfpqs, arachnia-agent-j56n8<span style="color:#000;font-weight:bold">;</span> pods not managed by ReplicationController, ReplicaSet, Job, DaemonSet or StatefulSet <span style="color:#ce5c00;font-weight:bold">(</span>use --force to override<span style="color:#ce5c00;font-weight:bold">)</span>: kube-proxy-bjzw-prek8sredis-99-40
</span></span></code></pre></div><p>2、存在DaemonSet方式管理的Pod，需要设置<code>--ignore-daemonsets</code>参数忽略报错。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl drain bjzw-prek8sredis-99-40 --force
</span></span><span style="display:flex;"><span>node <span style="color:#4e9a06">&#34;bjzw-prek8sredis-99-40&#34;</span> already cordoned
</span></span><span style="display:flex;"><span>error: unable to drain node <span style="color:#4e9a06">&#34;bjzw-prek8sredis-99-40&#34;</span>, aborting command...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>There are pending nodes to be drained:
</span></span><span style="display:flex;"><span> bjzw-prek8sredis-99-40
</span></span><span style="display:flex;"><span>error: DaemonSet-managed pods <span style="color:#ce5c00;font-weight:bold">(</span>use --ignore-daemonsets to ignore<span style="color:#ce5c00;font-weight:bold">)</span>: calicoopsmonitor-mfpqs, arachnia-agent-j56n8
</span></span></code></pre></div><h1 id="4-kubectl-drain">4. kubectl drain</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl drain --help
</span></span><span style="display:flex;"><span>Drain node in preparation <span style="color:#204a87;font-weight:bold">for</span> maintenance.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> The given node will be marked unschedulable to prevent new pods from arriving. <span style="color:#4e9a06">&#39;drain&#39;</span> evicts the pods <span style="color:#204a87;font-weight:bold">if</span> the API
</span></span><span style="display:flex;"><span>server supports https://kubernetes.io/docs/concepts/workloads/pods/disruptions/ . Otherwise, it will use normal DELETE
</span></span><span style="display:flex;"><span>to delete the pods. The <span style="color:#4e9a06">&#39;drain&#39;</span> evicts or deletes all pods except mirror pods <span style="color:#ce5c00;font-weight:bold">(</span>which cannot be deleted through the API
</span></span><span style="display:flex;"><span>server<span style="color:#ce5c00;font-weight:bold">)</span>.  If there are daemon set-managed pods, drain will not proceed without --ignore-daemonsets, and regardless it
</span></span><span style="display:flex;"><span>will not delete any daemon set-managed pods, because those pods would be immediately replaced by the daemon <span style="color:#204a87">set</span>
</span></span><span style="display:flex;"><span>controller, which ignores unschedulable markings.  If there are any pods that are neither mirror pods nor managed by a
</span></span><span style="display:flex;"><span>replication controller, replica set, daemon set, stateful set, or job, <span style="color:#204a87;font-weight:bold">then</span> drain will not delete any pods unless you
</span></span><span style="display:flex;"><span>use --force.  --force will also allow deletion to proceed <span style="color:#204a87;font-weight:bold">if</span> the managing resource of one or more pods is missing.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#39;drain&#39;</span> waits <span style="color:#204a87;font-weight:bold">for</span> graceful termination. You should not operate on the machine <span style="color:#204a87;font-weight:bold">until</span> the <span style="color:#204a87">command</span> completes.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> When you are ready to put the node back into service, use kubectl uncordon, which will make the node schedulable again.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> https://kubernetes.io/images/docs/kubectl_drain.svg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Examples:
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># Drain node &#34;foo&#34;, even if there are pods not managed by a replication controller, replica set, job, daemon set or</span>
</span></span><span style="display:flex;"><span>stateful <span style="color:#204a87">set</span> on it
</span></span><span style="display:flex;"><span>  kubectl drain foo --force
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># As above, but abort if there are pods not managed by a replication controller, replica set, job, daemon set or</span>
</span></span><span style="display:flex;"><span>stateful set, and use a grace period of <span style="color:#0000cf;font-weight:bold">15</span> minutes
</span></span><span style="display:flex;"><span>  kubectl drain foo --grace-period<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">900</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Options:
</span></span><span style="display:flex;"><span>      --chunk-size<span style="color:#ce5c00;font-weight:bold">=</span>500: Return large lists in chunks rather than all at once. Pass <span style="color:#0000cf;font-weight:bold">0</span> to disable. This flag is beta and
</span></span><span style="display:flex;"><span>may change in the future.
</span></span><span style="display:flex;"><span>      --delete-emptydir-data<span style="color:#ce5c00;font-weight:bold">=</span>false: Continue even <span style="color:#204a87;font-weight:bold">if</span> there are pods using emptyDir <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">local</span> data that will be deleted when
</span></span><span style="display:flex;"><span>the node is drained<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>      --disable-eviction<span style="color:#ce5c00;font-weight:bold">=</span>false: Force drain to use delete, even <span style="color:#204a87;font-weight:bold">if</span> eviction is supported. This will bypass checking
</span></span><span style="display:flex;"><span>PodDisruptionBudgets, use with caution.
</span></span><span style="display:flex;"><span>      --dry-run<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;none&#39;</span>: Must be <span style="color:#4e9a06">&#34;none&#34;</span>, <span style="color:#4e9a06">&#34;server&#34;</span>, or <span style="color:#4e9a06">&#34;client&#34;</span>. If client strategy, only print the object that would be
</span></span><span style="display:flex;"><span>sent, without sending it. If server strategy, submit server-side request without persisting the resource.
</span></span><span style="display:flex;"><span>      --force<span style="color:#ce5c00;font-weight:bold">=</span>false: Continue even <span style="color:#204a87;font-weight:bold">if</span> there are pods not managed by a ReplicationController, ReplicaSet, Job, DaemonSet
</span></span><span style="display:flex;"><span>or StatefulSet.
</span></span><span style="display:flex;"><span>      --grace-period<span style="color:#ce5c00;font-weight:bold">=</span>-1: Period of <span style="color:#204a87">time</span> in seconds given to each pod to terminate gracefully. If negative, the default
</span></span><span style="display:flex;"><span>value specified in the pod will be used.
</span></span><span style="display:flex;"><span>      --ignore-daemonsets<span style="color:#ce5c00;font-weight:bold">=</span>false: Ignore DaemonSet-managed pods.
</span></span><span style="display:flex;"><span>      --ignore-errors<span style="color:#ce5c00;font-weight:bold">=</span>false: Ignore errors occurred between drain nodes in group.
</span></span><span style="display:flex;"><span>      --pod-selector<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&#39;</span>: Label selector to filter pods on the node
</span></span><span style="display:flex;"><span>  -l, --selector<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;&#39;</span>: Selector <span style="color:#ce5c00;font-weight:bold">(</span>label query<span style="color:#ce5c00;font-weight:bold">)</span> to filter on
</span></span><span style="display:flex;"><span>      --skip-wait-for-delete-timeout<span style="color:#ce5c00;font-weight:bold">=</span>0: If pod DeletionTimestamp older than N seconds, skip waiting <span style="color:#204a87;font-weight:bold">for</span> the pod.
</span></span><span style="display:flex;"><span>Seconds must be greater than <span style="color:#0000cf;font-weight:bold">0</span> to skip.
</span></span><span style="display:flex;"><span>      --timeout<span style="color:#ce5c00;font-weight:bold">=</span>0s: The length of <span style="color:#204a87">time</span> to <span style="color:#204a87">wait</span> before giving up, zero means infinite
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  kubectl drain NODE <span style="color:#ce5c00;font-weight:bold">[</span>options<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;kubectl options&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> a list of global command-line options <span style="color:#ce5c00;font-weight:bold">(</span>applies to all commands<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span></code></pre></div><p>参考文档：</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/">https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/</a></li>
<li><a href="https://kubernetes.io/docs/tasks/run-application/configure-pdb/">https://kubernetes.io/docs/tasks/run-application/configure-pdb/</a></li>
<li><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#drain">https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands#drain</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8a02de6992a0ee51b948d425469c1b12">8.4 - 镜像仓库</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-d91c32303bf218d01b7b2bf7e997cbf2">8.4.1 - 配置私有镜像仓库</h1>
    
	<h2 id="1-镜像仓库的基本操作">1. 镜像仓库的基本操作</h2>
<h3 id="1-1-登录镜像仓库">1.1. 登录镜像仓库</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker login -u &lt;username&gt; -p &lt;password&gt; &lt;registry-addr&gt;
</span></span></code></pre></div><h3 id="1-2-拉取镜像">1.2. 拉取镜像</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker pull https://registry.xxx.com/dev/nginx:latest
</span></span></code></pre></div><h3 id="1-3-推送镜像">1.3. 推送镜像</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker push https://registry.xxx.com/dev/nginx:latest
</span></span></code></pre></div><h3 id="1-4-重命名镜像">1.4. 重命名镜像</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker tag &lt;old-image&gt; &lt;new-image&gt;
</span></span></code></pre></div><h2 id="2-docker-xxx-com镜像仓库">2. docker.xxx.com镜像仓库</h2>
<p>使用docker.xxx.com镜像仓库。</p>
<h3 id="2-1-所有节点配置insecure-registries">2.1. 所有节点配置insecure-registries</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#cat /etc/docker/daemon.json</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;data-root&#34;</span>: <span style="color:#4e9a06">&#34;/data/docker&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;debug&#34;</span>: false,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;insecure-registries&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;docker.xxx.com:8080&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-2-所有节点配置-var-lib-kubelet-config-json">2.2. 所有节点配置/var/lib/kubelet/config.json</h3>
<p>具体参考：<a href="https://kubernetes.io/docs/concepts/containers/images/#configuring-nodes-to-authenticate-to-a-private-registry">configuring-nodes-to-authenticate-to-a-private-registry</a></p>
<ol>
<li>在某个节点登录docker.xxx.com:8080镜像仓库，会更新 $HOME/.docker/config.json</li>
<li>检查$HOME/.docker/config.json是否有该镜像仓库的auth信息。</li>
</ol>
<pre tabindex="0"><code>#cat ~/.docker/config.json
{
	&#34;auths&#34;: {
		&#34;docker.xxx.com:8080&#34;: {
			&#34;auth&#34;: &#34;&lt;此处为凭证信息&gt;&#34;
		}
	},
	&#34;HttpHeaders&#34;: {
		&#34;User-Agent&#34;: &#34;Docker-Client/18.09.9 (linux)&#34;
	}
}
</code></pre><ol start="3">
<li>将<code>$HOME/.docker/config.json</code>拷贝到所有的Node节点上的<code>/var/lib/kubelet/config.json</code>。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取所有节点的IP</span>
</span></span><span style="display:flex;"><span><span style="color:#000">nodes</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>kubectl get nodes -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;{range .items[*].status.addresses[?(@.type==&#34;ExternalIP&#34;)]}{.address} {end}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 拷贝到所有节点</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> n in <span style="color:#000">$nodes</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">do</span> scp ~/.docker/config.json root@<span style="color:#000">$n</span>:/var/lib/kubelet/config.json<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">done</span>
</span></span></code></pre></div><h3 id="2-3-创建docker-xxx-com镜像的pod">2.3. 创建docker.xxx.com镜像的pod</h3>
<p>指定镜像为：docker.xxx.com:8080/public/2048:latest</p>
<p>完整pod.yaml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1beta2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">deployment.kubernetes.io/revision</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">generation</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">k8s-app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dockeroa-hub</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">qcloud-app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dockeroa-hub</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dockeroa-hub</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">progressDeadlineSeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">600</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">revisionHistoryLimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">k8s-app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dockeroa-hub</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">qcloud-app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dockeroa-hub</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">strategy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rollingUpdate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">maxSurge</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000">%</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">maxUnavailable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000">%</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RollingUpdate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">k8s-app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dockeroa-hub</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">qcloud-app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dockeroa-hub</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">docker.xxx.com:8080/public/2048:latest</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Always</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">game</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">500m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">cpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">250m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">256Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">terminationMessagePath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/dev/termination-log</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">terminationMessagePolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">File</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">dnsPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterFirst</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">restartPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Always</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">nodeName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">192.168.1.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">schedulerName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default-scheduler</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">securityContext</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">terminationGracePeriodSeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>查看pod状态</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#kgpoowide -n game</span>
</span></span><span style="display:flex;"><span>NAME                                     READY   STATUS    RESTARTS   AGE     IP             NODE            NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>docker-oa-757bbbddb5-h6j7m               1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          14m     192.168.2.51   192.168.1.1    &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>docker-oa-757bbbddb5-jp5dw               1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          14m     192.168.1.32   192.168.1.2    &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>docker-oa-757bbbddb5-nlw9f               1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          14m     192.168.0.43   192.168.1.3   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/containers/images/#configuring-nodes-to-authenticate-to-a-private-registry">https://kubernetes.io/docs/concepts/containers/images/#configuring-nodes-to-authenticate-to-a-private-registry</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-55fc99faaf344a60b08326a55b017398">8.4.2 - 拉取私有镜像</h1>
    
	<blockquote>
<p>本文介绍通过pod指定 ImagePullSecrets来拉取私有镜像仓库的镜像</p>
</blockquote>
<h2 id="1-创建secret">1. 创建secret</h2>
<p>secret是namespace级别的，创建时候需要指定namespace。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create secret docker-registry &lt;name&gt; --docker-server<span style="color:#ce5c00;font-weight:bold">=</span>DOCKER_REGISTRY_SERVER --docker-username<span style="color:#ce5c00;font-weight:bold">=</span>DOCKER_USER --docker-password<span style="color:#ce5c00;font-weight:bold">=</span>DOCKER_PASSWORD -n &lt;NAMESPACE&gt;
</span></span></code></pre></div><h2 id="2-添加imagepullsecrets到serviceaccount">2. 添加ImagePullSecrets到serviceAccount</h2>
<p>可以通过将ImagePullSecrets到serviceAccount的方式来自动给pod添加imagePullSecrets参数值。</p>
<p>serviceAccount同样是namespace级别，只对该namespace生效。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#kubectl get secrets -n dev</span>
</span></span><span style="display:flex;"><span>NAME                  TYPE                                  DATA   AGE
</span></span><span style="display:flex;"><span>docker.xxxx.com         kubernetes.io/dockerconfigjson        <span style="color:#0000cf;font-weight:bold">1</span>      6h23m
</span></span></code></pre></div><p>将ImagePullSecrets添加到serviceAccount对象中。</p>
<p>默认serviceAccount对象如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#kubectl get serviceaccount default -n dev -o yaml</span>
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: ServiceAccount
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  creationTimestamp: <span style="color:#4e9a06">&#34;2020-02-27T03:30:38Z&#34;</span>
</span></span><span style="display:flex;"><span>  name: default
</span></span><span style="display:flex;"><span>  namespace: dev
</span></span><span style="display:flex;"><span>  resourceVersion: <span style="color:#4e9a06">&#34;11651567&#34;</span>
</span></span><span style="display:flex;"><span>  selfLink: /api/v1/namespaces/dev/serviceaccounts/default
</span></span><span style="display:flex;"><span>  uid: 85bcdd31-5911-11ea-9429-6c92bf3b7c33
</span></span><span style="display:flex;"><span>secrets:
</span></span><span style="display:flex;"><span>- name: default-token-s7wfn
</span></span></code></pre></div><p>编辑或修改serviceAccount内容，增加imagePullSecrets字段。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>imagePullSecrets:
</span></span><span style="display:flex;"><span>- name: docker.xxxx.com
</span></span></code></pre></div><p><code>kubectl edit serviceaccount default -n dev</code></p>
<p>修改后内容为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">creationTimestamp</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;2020-02-27T03:30:38Z&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">dev</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resourceVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;11651567&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selfLink</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/api/v1/namespaces/dev/serviceaccounts/default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">uid</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">85bcdd31-5911-11ea-9429-6c92bf3b7c33</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">secrets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default-token-s7wfn</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">imagePullSecrets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">docker.xxxx.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>其中<code>imagePullSecrets</code>字段是一个数组，可以配置多个镜像仓库的账号密码。</p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">imagePullSecrets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">docker.xxxx.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">docker.test.xxxx.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-创建带有imagepullsecrets的pod">3. 创建带有imagePullSecrets的pod</h2>
<p>如果已经执行了第二步操作，添加ImagePullSecrets到serviceAccount，则无需在pod中指定imagePullSecrets参数，默认会自动添加。</p>
<p>如果没有添加ImagePullSecrets到serviceAccount，则在pod中指定imagePullSecrets参数引用创建的镜像仓库的secret。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">imagePullSecrets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">docker.xxxx.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="4-说明">4. 说明</h2>
<p>由于secret和serviceaccount对象是对namespace级别生效，因此不同的namespace需要再次创建和更新这两个对象。该场景适合不同用户具有独立的镜像仓库的密码，可以通过该方式创建不同的镜像密码使用的secret来拉取不同的镜像部署。</p>
<p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod">https://kubernetes.io/docs/concepts/containers/images/#specifying-imagepullsecrets-on-a-pod</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#add-imagepullsecrets-to-a-service-account">https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#add-imagepullsecrets-to-a-service-account</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-938bc65964a09b965ab8e21d08b4607f">8.5 - 版本发布</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-95b06c53cc40973b00b544beeff601fb">8.5.1 - 金丝雀发布</h1>
    
	<h1 id="deployment配置金丝雀发布">Deployment配置金丝雀发布</h1>
<p>金丝雀发布是指控制更新过程中的滚动节奏，通过“暂停”（pause）或“继续”（resume）更新发布操作。通过一小部分的版本发布实例来观察新版本是否有异常，如果没有异常则依次发布剩余的实例。</p>
<h1 id="1-设置发版节奏">1. 设置发版节奏</h1>
<p>主要是两个字段的设置：</p>
<ul>
<li>maxSurge：最大发版实例数，可以创建的超出期望 Pod 个数的 Pod 数量。可以是百分比或者是数字。</li>
<li>maxUnavailable：最大不可用实例数。可以是百分比或数字。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 例如将maxSurge设置为1，maxUnavailable设置为0</span>
</span></span><span style="display:flex;"><span>$ kubectl patch deployment myapp-deploy -p <span style="color:#4e9a06">&#39;{&#34;spec&#34;: {&#34;strategy&#34;: {&#34;rollingUpdate&#34;: {&#34;maxSurge&#34;: 1, &#34;maxUnavailable&#34;: 0}}}}&#39;</span>
</span></span></code></pre></div><h1 id="2-升级版本并暂停">2. 升级版本并暂停</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl <span style="color:#204a87">set</span> image deployment myapp-deploy <span style="color:#000">myapp</span><span style="color:#ce5c00;font-weight:bold">=</span>kubernetes/myapp:v3 <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>kubectl rollout pause deployments myapp-deploy
</span></span></code></pre></div><h1 id="3-查看升级状态">3. 查看升级状态</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl rollout status deployment myapp-deploy
</span></span><span style="display:flex;"><span>Waiting <span style="color:#204a87;font-weight:bold">for</span> deployment <span style="color:#4e9a06">&#34;myapp-deploy&#34;</span> rollout to finish: <span style="color:#0000cf;font-weight:bold">1</span> out of <span style="color:#0000cf;font-weight:bold">3</span> new replicas have been updated...
</span></span></code></pre></div><h1 id="4-恢复继续发版">4. 恢复继续发版</h1>
<p>观察灰度的实例的流量是否正常，如果正常则继续发版，如果不正常则回滚之前的升级。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl rollout resume deployments myapp-deploy
</span></span></code></pre></div><h1 id="5-回滚发布">5. 回滚发布</h1>
<h2 id="5-1-回滚上一个版本">5.1. 回滚上一个版本</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl rollout undo deployments myapp-deploy
</span></span></code></pre></div><h2 id="5-2-查看历史版本">5.2. 查看历史版本</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl rollout <span style="color:#204a87">history</span> deployment myapp-deploy
</span></span><span style="display:flex;"><span>deployment.apps/myapp-deploy
</span></span><span style="display:flex;"><span>REVISION  CHANGE-CAUSE
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3</span>         &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">5</span>         &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6</span>         &lt;none&gt;
</span></span></code></pre></div><h2 id="5-3-回滚指定版本">5.3. 回滚指定版本</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl rollout undo deployment myapp-deploy --to-revision <span style="color:#0000cf;font-weight:bold">3</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/">https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/manage-deployment/#canary-deployments">https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/manage-deployment/#canary-deployments</a></li>
<li><a href="https://kubernetes.renkeju.com/chapter_5/5.3.4.Canary_release.html">https://kubernetes.renkeju.com/chapter_5/5.3.4.Canary_release.html</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ddbe76ac51f4a462cea597dd4e0c1726">8.5.2 - Kruise Rollout发布</h1>
    
	<h1 id="1-kruise-rollout简介">1. kruise-rollout简介</h1>
<p>Kruise Rollouts 是一个 <strong>Bypass(旁路)</strong> 组件，提供 <strong>高级渐进式交付功能</strong> 。</p>
<table>
<thead>
<tr>
<th>组件</th>
<th><strong>Kruise Rollouts</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>核心概念</td>
<td>增强现有的工作负载</td>
</tr>
<tr>
<td>架构</td>
<td>Bypass</td>
</tr>
<tr>
<td>插拔和热切换</td>
<td>是</td>
</tr>
<tr>
<td>发布类型</td>
<td>多批次、金丝雀、A/B测试、全链路灰度</td>
</tr>
<tr>
<td>工作负载类型</td>
<td>Deployment、StatefulSet、CloneSet、Advanced StatefulSet、Advanced DaemonSet</td>
</tr>
<tr>
<td>流量类型</td>
<td>Ingress、GatewayAPI、CRD（需要 Lua 脚本）</td>
</tr>
<tr>
<td>迁移成本</td>
<td>无需迁移工作负载和Pods</td>
</tr>
<tr>
<td>HPA 兼容性</td>
<td>是</td>
</tr>
</tbody>
</table>
<h1 id="2-安装kruise-rollout">2. 安装kruise-rollout</h1>
<h2 id="2-1-helm安装kruise-rollout">2.1. helm安装kruise-rollout</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add openkruise https://openkruise.github.io/charts/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl create ns openkruise
</span></span><span style="display:flex;"><span>helm install kruise-rollout openkruise/kruise-rollout -n openkruise
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 升级到指定版本</span>
</span></span><span style="display:flex;"><span>helm upgrade kruise-rollout openkruise/kruise-rollout --version 0.5.0
</span></span></code></pre></div><p>查看部署结果</p>
<p>通过<code>helm</code>和<code>kubectl</code>的命令可以看到创建了几个<code>crd</code>和<code>kruise-rollout-controller-manager</code>的pod来提供rollout的功能。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># helm list -A</span>
</span></span><span style="display:flex;"><span>NAME          	NAMESPACE 	REVISION	UPDATED                                	STATUS  	CHART               	APP VERSION
</span></span><span style="display:flex;"><span>kruise-rollout	openkruise	<span style="color:#0000cf;font-weight:bold">1</span>       	2024-11-24 16:52:36.067327844 +0800 +08	deployed	kruise-rollout-0.5.0	0.5.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get po -n kruise-rollout</span>
</span></span><span style="display:flex;"><span>NAME                                                READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kruise-rollout-controller-manager-875654888-rpxds   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          87s
</span></span><span style="display:flex;"><span>kruise-rollout-controller-manager-875654888-w75xj   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          87s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get crd |grep kruise</span>
</span></span><span style="display:flex;"><span>batchreleases.rollouts.kruise.io                      2024-11-24T08:52:36Z
</span></span><span style="display:flex;"><span>rollouthistories.rollouts.kruise.io                   2024-11-24T08:52:36Z
</span></span><span style="display:flex;"><span>rollouts.rollouts.kruise.io                           2024-11-24T08:52:36Z
</span></span><span style="display:flex;"><span>trafficroutings.rollouts.kruise.io                    2024-11-24T08:52:36Z
</span></span></code></pre></div><h2 id="2-2-安装kubectl-kruise">2.2. 安装kubectl-kruise</h2>
<p>kubectl-kruise用于执行rollout发版和回退等操作的二进制命令。</p>
<ul>
<li><code>kubectl-kruise rollout approve</code>：执行下一批版本发布</li>
<li><code>kubectl-kruise rollout undo</code>：回退全部发版批次</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/openkruise/kruise-tools/releases/download/v1.1.7/kubectl-kruise-linux-amd64-v1.1.7.tar.gz
</span></span><span style="display:flex;"><span>tar -zvxf kubectl-kruise-linux-amd64-v1.1.7.tar.gz
</span></span><span style="display:flex;"><span>mv linux-amd64/kubectl-kruise /usr/local/bin/
</span></span></code></pre></div><h1 id="3-使用指南">3. 使用指南</h1>
<p>先部署一个k8s deployment对象，例如部署10个nginx:1.26的容器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">strategy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rollingUpdate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">maxSurge</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000">%</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">maxUnavailable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000">%</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RollingUpdate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx:1.26</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">imagePullPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">IfNotPresent</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TCP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-1-创建发布策略-rollout对象">3.1. 创建发布策略(rollout对象)</h2>
<p>我们以使用<code>多批次灰度发布</code>为例。</p>
<ol>
<li><code>workloadRef</code>定义作用于哪个deployment对象。</li>
<li><code>strategy</code>定义发布策略。</li>
</ol>
<p>以下是发布策略示例描述：</p>
<ul>
<li>在第一批次：只升级 <strong>1个Pod</strong>；</li>
<li>在第二批次：升级 <strong>50%</strong> 的 Pods，即 <strong>5个已更新的Pod</strong>；</li>
<li>在第三批次：升级 <strong>100%</strong> 的 Pods，即 <strong>10个已更新的Pod</strong>。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl apply -f - <span style="color:#4e9a06">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">apiVersion: rollouts.kruise.io/v1beta1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">kind: Rollout
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">metadata:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  name: rollouts-nginx
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">spec:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  workloadRef:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    apiVersion: apps/v1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    kind: Deployment
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    name: nginx
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  strategy:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    canary:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      enableExtraWorkloadForCanary: false
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      steps:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      - replicas: 1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      - replicas: 50%
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      - replicas: 100%
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><h2 id="3-2-升级发布版本-发布第一批次">3.2. 升级发布版本(发布第一批次)</h2>
<p>升级nginx:1.26到nginx:1.27</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl <span style="color:#204a87">set</span> image deployment nginx <span style="color:#000">nginx</span><span style="color:#ce5c00;font-weight:bold">=</span>nginx:1.27
</span></span></code></pre></div><p>查看灰度结果：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get rs -L pod-template-hash -w</span>
</span></span><span style="display:flex;"><span>NAME               DESIRED   CURRENT   READY   AGE   POD-TEMPLATE-HASH
</span></span><span style="display:flex;"><span>nginx-68556bc579   <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>         <span style="color:#0000cf;font-weight:bold">1</span>       8s    68556bc579   <span style="color:#8f5902;font-style:italic"># nginx:1.27</span>
</span></span><span style="display:flex;"><span>nginx-d7f5d89c9    <span style="color:#0000cf;font-weight:bold">9</span>         <span style="color:#0000cf;font-weight:bold">9</span>         <span style="color:#0000cf;font-weight:bold">9</span>       24m   d7f5d89c9    <span style="color:#8f5902;font-style:italic"># nginx:1.26</span>
</span></span></code></pre></div><p>查看rollout状态：</p>
<p>rollout对象的状态主要描述了当前处于哪个rollout阶段及总状态和子阶段状态的信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get rollout rollouts-nginx -oyaml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rollouts.kruise.io/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Rollout</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rollouts-nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">disabled</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">strategy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">canary</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">steps</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">pause</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">pause</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000">%</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">pause</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000">%</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">workloadRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">status</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">canaryStatus</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">canaryReadyReplicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">canaryReplicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">canaryRevision</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">5c9556986d</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">currentStepIndex</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">currentStepState</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">StepPaused </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 当前步骤状态</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">lastUpdateTime</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;2024-11-24T11:52:56Z&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">message</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">BatchRelease is at state Ready, rollout-id , step 1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">observedWorkloadGeneration</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">36</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">podTemplateHash</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">d7f5d89c9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rolloutHash</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">77cxd69w47b7bwddwv2w7vxvb4xxdbwcx9x289vw69w788w4w6z4x8dd4vbz2zbw</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">stableRevision</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">68556bc579</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">conditions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">lastTransitionTime</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;2024-11-24T11:52:47Z&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">lastUpdateTime</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;2024-11-24T11:52:47Z&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">message</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Rollout is in Progressing</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">reason</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">InRolling</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">status</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;True&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Progressing</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">message</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Rollout is in step(1/3), and you need manually confirm to enter the next</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">step </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># rollout信息</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">observedGeneration</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">phase</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Progressing  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 整体状态</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-3-发布第二批次">3.3. 发布第二批次</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl-kruise rollout approve rollout/rollouts-nginx -n default
</span></span></code></pre></div><p>查看灰度结果：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get rs -L pod-template-hash -w</span>
</span></span><span style="display:flex;"><span>NAME               DESIRED   CURRENT   READY   AGE     POD-TEMPLATE-HASH
</span></span><span style="display:flex;"><span>nginx-68556bc579   <span style="color:#0000cf;font-weight:bold">5</span>         <span style="color:#0000cf;font-weight:bold">5</span>         <span style="color:#0000cf;font-weight:bold">5</span>       7m24s   68556bc579  <span style="color:#8f5902;font-style:italic"># nginx:1.27</span>
</span></span><span style="display:flex;"><span>nginx-d7f5d89c9    <span style="color:#0000cf;font-weight:bold">5</span>         <span style="color:#0000cf;font-weight:bold">5</span>         <span style="color:#0000cf;font-weight:bold">5</span>       32m     d7f5d89c9   <span style="color:#8f5902;font-style:italic"># nginx:1.26</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get po</span>
</span></span><span style="display:flex;"><span>NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx-68556bc579-24lpl   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7m34s  <span style="color:#8f5902;font-style:italic"># nginx:1.27 第一批次</span>
</span></span><span style="display:flex;"><span>nginx-68556bc579-2dph8   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          14s    <span style="color:#8f5902;font-style:italic"># nginx:1.27 第二批次</span>
</span></span><span style="display:flex;"><span>nginx-68556bc579-57pqt   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          14s    <span style="color:#8f5902;font-style:italic"># nginx:1.27 第二批次</span>
</span></span><span style="display:flex;"><span>nginx-68556bc579-879s9   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          14s    <span style="color:#8f5902;font-style:italic"># nginx:1.27 第二批次</span>
</span></span><span style="display:flex;"><span>nginx-68556bc579-fwt52   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          14s    <span style="color:#8f5902;font-style:italic"># nginx:1.27 第二批次</span>
</span></span><span style="display:flex;"><span>nginx-d7f5d89c9-5fbfp    1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          30m    <span style="color:#8f5902;font-style:italic"># 其余为第三批次</span>
</span></span><span style="display:flex;"><span>nginx-d7f5d89c9-gkz9p    1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          30m
</span></span><span style="display:flex;"><span>nginx-d7f5d89c9-jhxwl    1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          30m
</span></span><span style="display:flex;"><span>nginx-d7f5d89c9-vrqfz    1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          30m
</span></span><span style="display:flex;"><span>nginx-d7f5d89c9-zk2sj    1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          30m
</span></span></code></pre></div><h2 id="3-4-发布第三批次">3.4. 发布第三批次</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl-kruise rollout approve rollout/rollouts-nginx -n default
</span></span></code></pre></div><p>查看结果：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get rs -L pod-template-hash -w</span>
</span></span><span style="display:flex;"><span>NAME               DESIRED   CURRENT   READY   AGE   POD-TEMPLATE-HASH
</span></span><span style="display:flex;"><span>nginx-68556bc579   <span style="color:#0000cf;font-weight:bold">10</span>        <span style="color:#0000cf;font-weight:bold">10</span>        <span style="color:#0000cf;font-weight:bold">10</span>      12m   68556bc579   <span style="color:#8f5902;font-style:italic">#  nginx:1.27</span>
</span></span><span style="display:flex;"><span>nginx-d7f5d89c9    <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">0</span>       37m   d7f5d89c9
</span></span></code></pre></div><h2 id="3-5-发布回滚">3.5. 发布回滚</h2>
<p>该回滚会把全部批次的pod都回滚到第一批发版前的版本。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl-kruise rollout undo rollout/rollouts-nginx -n default
</span></span></code></pre></div><h1 id="4-k8s对象变更">4. k8s对象变更</h1>
<p>kruise-rollout的原理主要还是劫持<code>Deployment</code>和<code>ReplicaSet</code>的操作，例如在升级deployment的时候会把deployment原先的<code>strategy</code>策略放在annotations中暂存，再增加<code>paused=true</code>的参数暂停deployment的发布。在rollout全部结束后再恢复原先的deployment参数，主要包括<code>paused</code>和<code>strategy</code>。</p>
<p>以下是rollout中间阶段的deployment信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">batchrelease.rollouts.kruise.io/control-info</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{&#34;apiVersion&#34;:&#34;rollouts.kruise.io/v1beta1&#34;,&#34;kind&#34;:&#34;BatchRelease&#34;,&#34;name&#34;:&#34;rollouts-nginx&#34;,&#34;uid&#34;:&#34;8f29624b-ab77-49d1-abbe-aa92bb3998e2&#34;,&#34;controller&#34;:true,&#34;blockOwnerDeletion&#34;:true}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">deployment.kubernetes.io/revision</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;5&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rollouts.kruise.io/deployment-extra-status</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{&#34;updatedReadyReplicas&#34;:1,&#34;expectedUpdatedReplicas&#34;:1}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rollouts.kruise.io/deployment-strategy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{&#34;rollingStyle&#34;:&#34;Partition&#34;,&#34;rollingUpdate&#34;:{&#34;maxUnavailable&#34;:&#34;25%&#34;,&#34;maxSurge&#34;:&#34;25%&#34;},&#34;partition&#34;:1}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># deployment原本的strategy策略</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rollouts.kruise.io/in-progressing</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;{&#34;rolloutName&#34;:&#34;rollouts-nginx&#34;}&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">generation</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">36</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rollouts.kruise.io/controlled-by-advanced-deployment-controller</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rollouts.kruise.io/stable-revision</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">68556bc579</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rollouts.kruise.io/workload-type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">paused</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#8f5902;font-style:italic"># 增加了paused参数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">progressDeadlineSeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">600</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">revisionHistoryLimit</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://openkruise.io/zh/rollouts/introduction">https://openkruise.io/zh/rollouts/introduction</a></li>
<li><a href="https://openkruise.io/zh/rollouts/installation">https://openkruise.io/zh/rollouts/installation</a></li>
<li><a href="https://openkruise.io/zh/rollouts/user-manuals/basic-usage">https://openkruise.io/zh/rollouts/user-manuals/basic-usage</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-41c516f97d3e1fa8b834aa015c334c1e">8.5.3 - HPA[自动扩缩容]配置</h1>
    
	<h1 id="1-hpa简介">1. HPA简介</h1>
<p>HPA全称<strong>HorizontalPodAutoscaler</strong>，即pod水平扩容，增加或减少pod的数量。相对于VPA而言，VPA是增加或减少单个pod的CPU或内存。HPA主要作用于Deployment或Statefulset的工作负载，无法作用于Daemonset的工作负载。</p>
<p>示例图：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1685108029/article/kubernetes/pod/hpa.png" alt=""></p>
<p>Kubernetes 将水平 Pod 自动扩缩实现为一个间歇运行的控制回路（它不是一个连续的过程）。间隔由 <a href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-controller-manager/"><code>kube-controller-manager</code></a> 的 <code>--horizontal-pod-autoscaler-sync-period</code> 参数设置（默认间隔为 15 秒）。</p>
<p>在每个时间段内，控制器管理器都会根据每个 HorizontalPodAutoscaler 定义中指定的指标查询资源利用率。 控制器管理器找到由 <code>scaleTargetRef</code> 定义的目标资源，然后根据目标资源的 <code>.spec.selector</code> 标签选择 Pod， 并从资源指标 API（针对每个 Pod 的资源指标）或自定义指标获取指标 API（适用于所有其他指标）。</p>
<p>HPA依赖metrics-server来获取CPU和内存数据，以下说明metrics-server的部署流程。</p>
<h1 id="2-部署metrics-server">2. 部署metrics-server</h1>
<p>下载metrics-server文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</span></span></code></pre></div><p>修改启动参数，增加<code>--kubelet-insecure-tls</code>，否则会报获取接口证书失败。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    spec:
</span></span><span style="display:flex;"><span>      containers:
</span></span><span style="display:flex;"><span>      - args:
</span></span><span style="display:flex;"><span>        - --cert-dir<span style="color:#ce5c00;font-weight:bold">=</span>/tmp
</span></span><span style="display:flex;"><span>        - --secure-port<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">4443</span>
</span></span><span style="display:flex;"><span>        - --kubelet-preferred-address-types<span style="color:#ce5c00;font-weight:bold">=</span>InternalIP,ExternalIP,Hostname
</span></span><span style="display:flex;"><span>        - --kubelet-use-node-status-port
</span></span><span style="display:flex;"><span>        - --metric-resolution<span style="color:#ce5c00;font-weight:bold">=</span>15s
</span></span><span style="display:flex;"><span>        - --kubelet-insecure-tls  <span style="color:#8f5902;font-style:italic"># 增加该参数</span>
</span></span></code></pre></div><p>创建yaml服务</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f components.yaml
</span></span></code></pre></div><p>通过kubectl top查看资源信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl top node</span>
</span></span><span style="display:flex;"><span>NAME          CPU<span style="color:#ce5c00;font-weight:bold">(</span>cores<span style="color:#ce5c00;font-weight:bold">)</span>   CPU%   MEMORY<span style="color:#ce5c00;font-weight:bold">(</span>bytes<span style="color:#ce5c00;font-weight:bold">)</span>   MEMORY%
</span></span><span style="display:flex;"><span>node1         144m         0%     5762Mi          2%
</span></span><span style="display:flex;"><span>node2         337m         0%     5475Mi          2%
</span></span><span style="display:flex;"><span>node3         100m         0%     5326Mi          2%
</span></span><span style="display:flex;"><span>node4         302m         0%     5649Mi          2%
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl top pod -n prometheus</span>
</span></span><span style="display:flex;"><span>NAME                                                        CPU<span style="color:#ce5c00;font-weight:bold">(</span>cores<span style="color:#ce5c00;font-weight:bold">)</span>   MEMORY<span style="color:#ce5c00;font-weight:bold">(</span>bytes<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>alertmanager-kube-prometheus-stack-alertmanager-0           1m           30Mi
</span></span><span style="display:flex;"><span>kube-prometheus-stack-grafana-7688b45b4c-mvwd6              1m           225Mi
</span></span><span style="display:flex;"><span>kube-prometheus-stack-kube-state-metrics-5d6578867c-25xbq   1m           21Mi
</span></span><span style="display:flex;"><span>kube-prometheus-stack-operator-9c5fbdc68-nrn7h              1m           33Mi
</span></span><span style="display:flex;"><span>kube-prometheus-stack-prometheus-node-exporter-8ghd8        1m           4Mi
</span></span><span style="display:flex;"><span>kube-prometheus-stack-prometheus-node-exporter-brtp9        1m           4Mi
</span></span><span style="display:flex;"><span>kube-prometheus-stack-prometheus-node-exporter-n4kdp        1m           4Mi
</span></span><span style="display:flex;"><span>kube-prometheus-stack-prometheus-node-exporter-ttksv        1m           4Mi
</span></span><span style="display:flex;"><span>prometheus-kube-prometheus-stack-prometheus-0               8m           622Mi
</span></span></code></pre></div><p>同时在k8s dashboard上也可以查看到实时的CPU和内存信息。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1685346450/article/kubernetes/monitor/pod-metrics.png" alt=""></p>
<h1 id="3-hpa配置">3. HPA配置</h1>
<blockquote>
<p>todo</p>
</blockquote>
<p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale/">https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale/</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/">https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/#metrics-server">https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/#metrics-server</a></li>
<li><a href="https://github.com/kubernetes-sigs/metrics-server">https://github.com/kubernetes-sigs/metrics-server</a></li>
<li><a href="https://www.qikqiak.com/post/k8s-hpa-usage/">https://www.qikqiak.com/post/k8s-hpa-usage/</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-55df644ab8d0bc55eb3a49b48ef9de4b">8.6 - helm工具</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-5f1a6eca050380d9ae4ce6be33a6e1a5">8.6.1 - helm的使用</h1>
    
	<h1 id="1-安装helm">1. 安装helm</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 <span style="color:#000;font-weight:bold">|</span> bash
</span></span></code></pre></div><h1 id="2-基本概念">2. 基本概念</h1>
<p>Helm是用来管理k8s集群上的软件包。</p>
<ul>
<li>
<p><code>Chart</code>:代表helm软件包</p>
</li>
<li>
<p><code>Repository</code>：软件包的存放仓库</p>
</li>
<li>
<p><code>Release</code>:运行在k8s上的一个发布实例。</p>
</li>
</ul>
<h1 id="3-helm命令">3. helm命令</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  helm <span style="color:#ce5c00;font-weight:bold">[</span>command<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available Commands:
</span></span><span style="display:flex;"><span>  completion  generate autocompletion scripts <span style="color:#204a87;font-weight:bold">for</span> the specified shell
</span></span><span style="display:flex;"><span>  create      create a new chart with the given name
</span></span><span style="display:flex;"><span>  dependency  manage a chart<span style="color:#a40000">&#39;</span>s dependencies
</span></span><span style="display:flex;"><span>  env         helm client environment information
</span></span><span style="display:flex;"><span>  get         download extended information of a named release
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">help</span>        Help about any <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">history</span>     fetch release <span style="color:#204a87">history</span>
</span></span><span style="display:flex;"><span>  install     install a chart
</span></span><span style="display:flex;"><span>  lint        examine a chart <span style="color:#204a87;font-weight:bold">for</span> possible issues
</span></span><span style="display:flex;"><span>  list        list releases
</span></span><span style="display:flex;"><span>  package     package a chart directory into a chart archive
</span></span><span style="display:flex;"><span>  plugin      install, list, or uninstall Helm plugins
</span></span><span style="display:flex;"><span>  pull        download a chart from a repository and <span style="color:#ce5c00;font-weight:bold">(</span>optionally<span style="color:#ce5c00;font-weight:bold">)</span> unpack it in <span style="color:#204a87">local</span> directory
</span></span><span style="display:flex;"><span>  push        push a chart to remote
</span></span><span style="display:flex;"><span>  registry    login to or <span style="color:#204a87">logout</span> from a registry
</span></span><span style="display:flex;"><span>  repo        add, list, remove, update, and index chart repositories
</span></span><span style="display:flex;"><span>  rollback    roll back a release to a previous revision
</span></span><span style="display:flex;"><span>  search      search <span style="color:#204a87;font-weight:bold">for</span> a keyword in charts
</span></span><span style="display:flex;"><span>  show        show information of a chart
</span></span><span style="display:flex;"><span>  status      display the status of the named release
</span></span><span style="display:flex;"><span>  template    locally render templates
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">test</span>        run tests <span style="color:#204a87;font-weight:bold">for</span> a release
</span></span><span style="display:flex;"><span>  uninstall   uninstall a release
</span></span><span style="display:flex;"><span>  upgrade     upgrade a release
</span></span><span style="display:flex;"><span>  verify      verify that a chart at the given path has been signed and is valid
</span></span><span style="display:flex;"><span>  version     print the client version information
</span></span></code></pre></div><h1 id="4-常用命令">4. 常用命令</h1>
<h2 id="4-1-helm-search">4.1. helm search</h2>
<ul>
<li>helm search hub：从 <a href="https://artifacthub.io/">Artifact Hub</a> 中查找并列出 helm charts。支持模糊匹配。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm search hub wordpress
</span></span></code></pre></div><ul>
<li>helm search repo：基于指定仓库进行搜索。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add brigade https://brigadecore.github.io/charts
</span></span><span style="display:flex;"><span>helm search repo brigade
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 列出所有版本</span>
</span></span><span style="display:flex;"><span>helm search repo apisix -l
</span></span></code></pre></div><h2 id="4-2-helm-install-uninstall">4.2. helm install/uninstall</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install &lt;release_name&gt; &lt;chart_name&gt;
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 示例</span>
</span></span><span style="display:flex;"><span>helm install happy-panda bitnami/wordpress -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># uninstall</span>
</span></span><span style="display:flex;"><span>helm uninstall RELEASE_NAME
</span></span></code></pre></div><p>安装自定义chart</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install -f values.yaml bitnami/wordpress --generate-name
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 本地 chart 压缩包</span>
</span></span><span style="display:flex;"><span>helm install foo foo-0.1.1.tgz
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 解压后的 chart 目录</span>
</span></span><span style="display:flex;"><span>helm install foo path/to/foo
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 完整的 URL</span>
</span></span><span style="display:flex;"><span>helm install foo https://example.com/charts/foo-1.2.3.tgz
</span></span></code></pre></div><h2 id="4-3-helm-upgrade">4.3. helm upgrade</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm upgrade happy-panda bitnami/wordpress
</span></span></code></pre></div><h2 id="4-4-helm-rollback">4.4. helm rollback</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm rollback &lt;RELEASE&gt; <span style="color:#ce5c00;font-weight:bold">[</span>REVISION<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>flags<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span></code></pre></div><h2 id="4-5-helm-repo">4.5. helm repo</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add dev https://example.com/dev-charts
</span></span><span style="display:flex;"><span>helm repo list
</span></span><span style="display:flex;"><span>helm repo remove
</span></span></code></pre></div><h2 id="4-6-helm-pull">4.6. helm pull</h2>
<p>从仓库下载并（可选）在本地目录解压。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm pull <span style="color:#ce5c00;font-weight:bold">[</span>chart URL <span style="color:#000;font-weight:bold">|</span> repo/chartname<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helm pull <span style="color:#ce5c00;font-weight:bold">[</span>chart URL <span style="color:#000;font-weight:bold">|</span> repo/chartname<span style="color:#ce5c00;font-weight:bold">]</span> --version 
</span></span></code></pre></div><h1 id="5-创建chart">5. 创建chart</h1>
<h2 id="5-1-初始化chart">5.1. 初始化chart</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> helm create mychart
</span></span></code></pre></div><p>查看生成的文件目录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mychart
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- charts  <span style="color:#8f5902;font-style:italic"># 目录用于存放所依赖的子chart</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- Chart.yaml  <span style="color:#8f5902;font-style:italic"># 描述这个 Chart 的相关信息、包括名字、描述信息、版本等</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- templates
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- deployment.yaml
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- _helpers.tpl  <span style="color:#8f5902;font-style:italic"># 模板助手文件，定义的值可在模板中使用</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- hpa.yaml
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- ingress.yaml
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- NOTES.txt  <span style="color:#8f5902;font-style:italic"># Chart 部署到集群后的一些信息，例如：如何使用、列出缺省值</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- serviceaccount.yaml
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- service.yaml
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- tests
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>       <span style="color:#4e9a06">`</span>-- test-connection.yaml
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">`</span>-- values.yaml   <span style="color:#8f5902;font-style:italic"># 模板的值文件，这些值会在安装时应用到 GO 模板生成部署文件</span>
</span></span></code></pre></div><p>移除默认模板文件，并添加自己的模板文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> rm -rf mysubchart/templates/*
</span></span></code></pre></div><h2 id="5-2-调试模板">5.2. 调试模板</h2>
<ul>
<li><code>helm lint</code> 是验证chart是否遵循最佳实践的首选工具。</li>
<li><code>helm template --debug</code> 在本地测试渲染chart模板。</li>
<li><code>helm install --dry-run --debug</code>：我们已经看到过这个技巧了，这是让服务器渲染模板的好方法，然后返回生成的清单文件。</li>
<li><code>helm get manifest</code>: 这是查看安装在服务器上的模板的好方法。</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://helm.sh/zh/docs/intro/install/">Helm | 安装Helm</a></li>
<li><a href="https://helm.sh/zh/docs/intro/using_helm/">Helm | 使用Helm</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3047f06db94255d847014b8b4927fc13">8.7 - 访问控制</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-9f77a82cda922f86b06a443f2d02911d">8.7.1 - 使用 RBAC 鉴权</h1>
    
	<blockquote>
<p>本文基于https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/ 整理。</p>
</blockquote>
<h1 id="1-rbac介绍">1. RBAC介绍</h1>
<p>基于角色的访问控制【Role-based access control (RBAC)】是一种基于组织中用户的角色来调节控制对 计算机或网络资源的访问的方法。</p>
<p>RBAC 鉴权机制使用 <code>rbac.authorization.k8s.io</code> <a href="https://kubernetes.io/zh-cn/docs/concepts/overview/kubernetes-api/#api-groups-and-versioning">API 组</a>来驱动鉴权决定， 允许你通过 Kubernetes API 动态配置策略。</p>
<p>要启用 RBAC，在启动 <a href="https://kubernetes.io/zh-cn/docs/concepts/overview/components/#kube-apiserver">API 服务器</a>时将 <code>--authorization-mode</code> 参数设置为一个逗号分隔的列表并确保其中包含 <code>RBAC</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kube-apiserver --authorization-mode<span style="color:#ce5c00;font-weight:bold">=</span>Example,RBAC --&lt;其他选项&gt; --&lt;其他选项&gt;
</span></span></code></pre></div><p>编写自定义CRD控制器或部署其他开源组件时，经常需要给组件配置RBAC权限。</p>
<p><strong>理解RBAC权限体系，只需要理解以下三个概念对象即可：</strong></p>
<ul>
<li>
<p><strong>【权限】Role：角色，它其实是一组规则，定义了一组对 Kubernetes API 对象的操作权限。</strong></p>
</li>
<li>
<p><strong>【用户】Subject：被作用者，既可以是“人”，也可以是“机器”，也可以是你在 Kubernetes 里定义的“用户”。</strong></p>
</li>
<li>
<p><strong>【授权】RoleBinding：定义了“被作用者”和“角色”的绑定关系</strong>。</p>
</li>
</ul>
<p><strong>一句话理解RBAC，就是将定义的权限与定义的用户之间的关系进行绑定，即授权某个用户某些权限。</strong></p>
<p>快速授权脚本可以参考：<a href="https://github.com/huweihuang/kubeadm-scripts/tree/main/kubeconfig/token">https://github.com/huweihuang/kubeadm-scripts/tree/main/kubeconfig/token</a></p>
<h1 id="2-api对象">2. API对象</h1>
<p><strong>角色（权限）---角色（权限）绑定---用户（subject）</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>集群级别范围</th>
<th>命名空间范围</th>
</tr>
</thead>
<tbody>
<tr>
<td>权限</td>
<td>ClusterRole</td>
<td>Role</td>
</tr>
<tr>
<td>授权</td>
<td>ClusterRoleBinding</td>
<td>RoleBinding</td>
</tr>
<tr>
<td>用户</td>
<td></td>
<td>ServiceAccout</td>
</tr>
</tbody>
</table>
<p>以下从<code>权限</code>、<code>用户</code>、<code>授权</code>三个概念进行说明。完成一套授权逻辑，主要分为三个步骤</p>
<ol>
<li>
<p><strong>创建权限，即创建Role或ClusterRole对象。</strong></p>
</li>
<li>
<p><strong>创建用户，即创建ServiceAccount对象。</strong></p>
</li>
<li>
<p><strong>分配权限，即创建RoleBinding或ClusterRoleBinding对象。</strong></p>
</li>
</ol>
<h1 id="3-权限">3. 权限</h1>
<p>RBAC 的 <strong>Role</strong> 或 <strong>ClusterRole</strong> 中包含一组代表相关权限的规则。 这些权限是纯粹累加的（不存在拒绝某操作的规则）。</p>
<h2 id="3-1-命名空间权限-role">3.1. 命名空间权限[Role]</h2>
<p>Role是针对指定namespace的权限，即创建的时候需要指定namespace。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Role</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pod-reader</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># &#34;&#34; 标明 core API 组</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;pods&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-2-集群级别权限-clusterrole">3.2. 集群级别权限[ClusterRole]</h2>
<p>ClusterRole用于指定集群内的资源：</p>
<ul>
<li>
<p>集群范围资源（比如<a href="https://kubernetes.io/zh-cn/docs/concepts/architecture/nodes/">节点（Node）</a>）</p>
</li>
<li>
<p>非资源端点（比如 <code>/healthz</code>）</p>
</li>
<li>
<p>跨名字空间访问的名字空间作用域的资源（如 访问所有namespace下的Pod）</p>
</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># &#34;namespace&#34; 被忽略，因为 ClusterRoles 不受名字空间限制</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">secret-reader</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 在 HTTP 层面，用来访问 Secret 资源的名称为 &#34;secrets&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;secrets&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-3-默认权限角色">3.3. 默认权限角色</h2>
<p>在 Kubernetes 中已经内置了很多个为系统保留的 ClusterRole，它们的名字都以<code>system:</code>开头。可以通过 <code>kubectl get clusterroles</code> 查看到它们。</p>
<p>超级用户（Super-User）角色（<code>cluster-admin</code>）、 使用 ClusterRoleBinding 在集群范围内完成授权的角色（<code>cluster-status</code>）、 以及使用 RoleBinding 在特定名字空间中授予的角色（<code>admin</code>、<code>edit</code>、<code>view</code>）。</p>
<table>
<thead>
<tr>
<th>默认 ClusterRole</th>
<th>默认 ClusterRoleBinding</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>cluster-admin</strong></td>
<td><strong>system:masters</strong> 组</td>
<td>允许超级用户在平台上的任何资源上执行所有操作。 当在 <strong>ClusterRoleBinding</strong> 中使用时，可以授权对集群中以及所有名字空间中的全部资源进行完全控制。 当在 <strong>RoleBinding</strong> 中使用时，可以授权控制角色绑定所在名字空间中的所有资源，包括名字空间本身。</td>
</tr>
<tr>
<td><strong>admin</strong></td>
<td>无</td>
<td>允许管理员访问权限，旨在使用 <strong>RoleBinding</strong> 在名字空间内执行授权。如果在 <strong>RoleBinding</strong> 中使用，则可授予对名字空间中的大多数资源的读/写权限， 包括创建角色和角色绑定的能力。 此角色不允许对资源配额或者名字空间本身进行写操作。 此角色也不允许对 Kubernetes v1.22+ 创建的 Endpoints 进行写操作。 更多信息参阅 <a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/#write-access-for-endpoints">“Endpoints 写权限”小节</a>。</td>
</tr>
<tr>
<td><strong>edit</strong></td>
<td>无</td>
<td>允许对名字空间的大多数对象进行读/写操作。此角色不允许查看或者修改角色或者角色绑定。 不过，此角色可以访问 Secret，以名字空间中任何 ServiceAccount 的身份运行 Pod， 所以可以用来了解名字空间内所有服务账户的 API 访问级别。 此角色也不允许对 Kubernetes v1.22+ 创建的 Endpoints 进行写操作。 更多信息参阅 <a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/#write-access-for-endpoints">“Endpoints 写操作”小节</a>。</td>
</tr>
<tr>
<td><strong>view</strong></td>
<td>无</td>
<td>允许对名字空间的大多数对象有只读权限。 它不允许查看角色或角色绑定。此角色不允许查看 Secrets，因为读取 Secret 的内容意味着可以访问名字空间中 ServiceAccount 的凭据信息，进而允许利用名字空间中任何 ServiceAccount 的身份访问 API（这是一种特权提升）。</td>
</tr>
</tbody>
</table>
<h1 id="4-用户">4. 用户</h1>
<h2 id="4-1-serviceaccount">4.1. ServiceAccount</h2>
<p>创建指定namespace的ServiceAccount对象。ServiceAccount可以在pod中被使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;Namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;ServiceAccountName&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="4-2-secret">4.2. Secret</h2>
<p> 创建secret，绑定serviceaccount，会自动生成token。</p>
<blockquote>
<p>k8s 1.24后的版本不再自动生成secret，绑定后当删除ServiceAccount时会自动删除secret</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;SecretName&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;Namespace&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">kubernetes.io/service-account.name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;ServiceAccountName&#34;</span><span style="color:#f8f8f8;text-decoration:underline">   
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubernetes.io/service-account-token</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="5-授权">5. 授权</h1>
<h2 id="5-1-授权命名空间权限-rolebinding">5.1. 授权命名空间权限[RoleBinding]</h2>
<p>RoleBinding角色绑定（Role Binding）是将角色中定义的权限赋予一个或者一组用户。 它包含若干 <strong>主体</strong>（用户、组或服务账户）的列表和对这些主体所获得的角色的引用。 RoleBinding 在指定的名字空间中执行授权，而 ClusterRoleBinding 在集群范围执行授权。</p>
<p>字段说明：</p>
<ul>
<li>
<p><code>subjects</code>：表示权限所授予的用户，包括<code>ServiceAccount</code>，<code>Group</code>，<code>User</code>。</p>
</li>
<li>
<p><code>roleRef</code>：表示权限对应的角色，包括<code>Role</code>，<code>ClusterRole</code>。</p>
</li>
</ul>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${USER}-rolebinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${NAMESPACE}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${ServiceAccountName}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${ServiceAccountNS}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${ROLE}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>可以给指定命名空间下的serviceaccount授权其他命名空间的权限。只需要新增RoleBinding在预授权的命名空间下即可。<strong>可以理解为可以给一个用户分配多个命名空间的权限。</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">set -e</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 给已存在的用户USER 添加其他NAMESPACE的权限</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">USER=$1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">NAMESPACE=$2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ROLE=$3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ROLE=${ROLE:-edit}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ServiceAccountName=&#34;${USER}-user&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">ServiceAccountNS=&#34;kubernetes-dashboard&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">cat&lt;&lt;EOF | kubectl apply -f -</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${USER}-rolebinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${NAMESPACE}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${ServiceAccountName}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${ServiceAccountNS}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${ROLE}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">EOF</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="5-2-授权集群级别权限-clusterrolebinding">5.2. 授权集群级别权限[ClusterRoleBinding]</h2>
<p>要跨整个集群完成访问权限的授予，可以使用一个 ClusterRoleBinding。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${USER}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${USER}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${NAMESPACE}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">${ROLE}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/rbac/">使用 RBAC 鉴权 | Kubernetes</a></li>
<li><a href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/authentication/">用户认证 | Kubernetes</a></li>
<li><a href="https://www.soulchild.cn/post/2945/">k8s serviceaccount创建后没有生成对应的secret </a></li>
</ul>

</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-37ac2d29c744460e3073c9d6dabb1f4d">9 - 开发指南</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-73557ed651edbfdf7203caf9eea45f16">9.1 - client-go的使用及源码分析</h1>
    
	<h1 id="1-client-go简介">1. client-go简介</h1>
<h2 id="1-1-client-go说明">1.1 client-go说明</h2>
<p>​	client-go是一个调用kubernetes集群资源对象API的客户端，即通过client-go实现对kubernetes集群中资源对象（包括deployment、service、ingress、replicaSet、pod、namespace、node等）的增删改查等操作。大部分对kubernetes进行前置API封装的二次开发都通过client-go这个第三方包来实现。</p>
<p>​	client-go官方文档：https://github.com/kubernetes/client-go</p>
<h2 id="1-2-示例代码">1.2 示例代码</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git clone https://github.com/huweihuang/client-go.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> client-go
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#保证本地HOME目录有配置kubernetes集群的配置文件</span>
</span></span><span style="display:flex;"><span>go run client-go.go
</span></span></code></pre></div><p><strong><a href="https://github.com/huweihuang/client-go/blob/master/client-go.go">client-go.go</a></strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;path/filepath&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metav1</span> <span style="color:#4e9a06">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">kubeconfig</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">home</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">homeDir</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">home</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeconfig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kubeconfig&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">home</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.kube&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;(optional) absolute path to the kubeconfig file&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeconfig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kubeconfig&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;absolute path to the kubeconfig file&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// uses the current context in kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientcmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuildConfigFromFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeconfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// creates the clientset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;There are %d pods in the cluster\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Items</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">homeDir</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HOME&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">h</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;USERPROFILE&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// windows
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-3-运行结果">1.3 运行结果</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜ go run client-go.go
</span></span><span style="display:flex;"><span>There are <span style="color:#0000cf;font-weight:bold">9</span> pods in the cluster
</span></span><span style="display:flex;"><span>There are <span style="color:#0000cf;font-weight:bold">7</span> pods in the cluster
</span></span><span style="display:flex;"><span>There are <span style="color:#0000cf;font-weight:bold">7</span> pods in the cluster
</span></span><span style="display:flex;"><span>There are <span style="color:#0000cf;font-weight:bold">7</span> pods in the cluster
</span></span><span style="display:flex;"><span>There are <span style="color:#0000cf;font-weight:bold">7</span> pods in the cluster
</span></span></code></pre></div><h1 id="2-client-go源码分析">2. client-go源码分析</h1>
<p><strong>client-go源码</strong>：https://github.com/kubernetes/client-go</p>
<p><strong>client-go源码目录结构</strong></p>
<ul>
<li>The <code>kubernetes</code> package contains the clientset to access Kubernetes API.</li>
<li>The <code>discovery</code> package is used to discover APIs supported by a Kubernetes API server.</li>
<li>The <code>dynamic</code> package contains a dynamic client that can perform generic operations on arbitrary Kubernetes API objects.</li>
<li>The <code>transport</code> package is used to set up auth and start a connection.</li>
<li>The <code>tools/cache</code> package is useful for writing controllers.</li>
</ul>
<h2 id="2-1-kubeconfig">2.1 kubeconfig</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#000">kubeconfig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kubeconfig&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">home</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.kube&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;(optional) absolute path to the kubeconfig file&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>获取kubernetes配置文件kubeconfig的绝对路径。一般路径为<code>$HOME/.kube/config</code>。该文件主要用来配置本地连接的kubernetes集群。</p>
<p>config内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>clusters:
</span></span><span style="display:flex;"><span>- cluster:
</span></span><span style="display:flex;"><span>    server: http://&lt;kube-master-ip&gt;:8080
</span></span><span style="display:flex;"><span>  name: k8s
</span></span><span style="display:flex;"><span>contexts:
</span></span><span style="display:flex;"><span>- context:
</span></span><span style="display:flex;"><span>    cluster: k8s
</span></span><span style="display:flex;"><span>    namespace: default
</span></span><span style="display:flex;"><span>    user: <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  name: default
</span></span><span style="display:flex;"><span>current-context: default
</span></span><span style="display:flex;"><span>kind: Config
</span></span><span style="display:flex;"><span>preferences: <span style="color:#ce5c00;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>users: <span style="color:#ce5c00;font-weight:bold">[]</span>
</span></span></code></pre></div><h2 id="2-2-rest-config">2.2 rest.config</h2>
<p>通过参数（master的url或者kubeconfig路径）和<code>BuildConfigFromFlags</code>方法来获取<code>rest.Config</code>对象，一般是通过参数kubeconfig的路径。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientcmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuildConfigFromFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeconfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>BuildConfigFromFlags函数源码</strong></p>
<p><a href="https://github.com/kubernetes/client-go/blob/master/tools/clientcmd/client_config.go#L522">k8s.io/client-go/tools/clientcmd/client_config.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// BuildConfigFromFlags is a helper function that builds configs from a master
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// url or a kubeconfig filepath. These are passed in as command line flags for cluster
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// components. Warnings should reflect this usage. If neither masterUrl or kubeconfigPath
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// are passed in we fallback to inClusterConfig. If inClusterConfig fails, we fallback
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to the default config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">BuildConfigFromFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">masterUrl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeconfigPath</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">restclient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeconfigPath</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">masterUrl</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeconfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">restclient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InClusterConfig</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">kubeconfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error creating inClusterConfig, falling back to default config: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewNonInteractiveDeferredLoadingClientConfig</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ClientConfigLoadingRules</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">ExplicitPath</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">kubeconfigPath</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ConfigOverrides</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">ClusterInfo</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">clientcmdapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">masterUrl</span><span style="color:#000;font-weight:bold">}}).</span><span style="color:#000">ClientConfig</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-clientset">2.3 clientset</h2>
<p>通过<code>*rest.Config</code>参数和<code>NewForConfig</code>方法来获取<code>clientset</code>对象，<code>clientset</code>是多个<code>client</code>的集合，每个<code>client</code>可能包含不同版本的方法调用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="2-3-1-newforconfig">2.3.1 NewForConfig</h3>
<p><code>NewForConfig</code>函数就是初始化clientset中的每个client。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/clientset.go#L396">k8s.io/client-go/kubernetes/clientset.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewForConfig creates a new Clientset for the given config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">configShallowCopy</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">cs</span> <span style="color:#000">Clientset</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">appsV1beta1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">appsv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">configShallowCopy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">coreV1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">configShallowCopy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-3-2-clientset的结构体">2.3.2 clientset的结构体</h3>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/clientset.go#L118">k8s.io/client-go/kubernetes/clientset.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Clientset contains the clients for groups. Each group has exactly one
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// version included in a Clientset.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Clientset</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">discovery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DiscoveryClient</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">admissionregistrationV1alpha1</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">admissionregistrationv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdmissionregistrationV1alpha1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">appsV1beta1</span>                   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">appsv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">appsV1beta2</span>                   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">appsv1beta2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta2Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">authenticationV1</span>              <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">authenticationv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthenticationV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">authenticationV1beta1</span>         <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">authenticationv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthenticationV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">authorizationV1</span>               <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">authorizationv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthorizationV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">authorizationV1beta1</span>          <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">authorizationv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthorizationV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">autoscalingV1</span>                 <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">autoscalingv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AutoscalingV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">autoscalingV2beta1</span>            <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">autoscalingv2beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AutoscalingV2beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">batchV1</span>                       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">batchv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">batchV1beta1</span>                  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">batchv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">batchV2alpha1</span>                 <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">batchv2alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV2alpha1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">certificatesV1beta1</span>           <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">certificatesv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertificatesV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">coreV1</span>                        <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">extensionsV1beta1</span>             <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">extensionsv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">networkingV1</span>                  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">networkingv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NetworkingV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">policyV1beta1</span>                 <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">policyv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PolicyV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rbacV1</span>                        <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rbacv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rbacV1beta1</span>                   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rbacv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rbacV1alpha1</span>                  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rbacv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1alpha1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">schedulingV1alpha1</span>            <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulingv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingV1alpha1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">settingsV1alpha1</span>              <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">settingsv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SettingsV1alpha1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">storageV1beta1</span>                <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">storagev1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">storageV1</span>                     <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">storagev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1Client</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-3-3-clientset-interface">2.3.3 clientset.Interface</h3>
<p>clientset实现了以下的Interface，因此可以通过调用以下方法获得具体的client。例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><p><strong>clientset的方法集接口</strong></p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/clientset.go#L54">k8s.io/client-go/kubernetes/clientset.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Interface</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Discovery</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">discovery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DiscoveryInterface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AdmissionregistrationV1alpha1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">admissionregistrationv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdmissionregistrationV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Admissionregistration</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">admissionregistrationv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdmissionregistrationV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">appsv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AppsV1beta2</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">appsv1beta2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta2Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Apps</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">appsv1beta2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta2Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AuthenticationV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">authenticationv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthenticationV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">authenticationv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthenticationV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AuthenticationV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">authenticationv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthenticationV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AuthorizationV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">authorizationv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthorizationV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Authorization</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">authorizationv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthorizationV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AuthorizationV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">authorizationv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthorizationV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AutoscalingV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">autoscalingv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AutoscalingV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Autoscaling</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">autoscalingv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AutoscalingV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AutoscalingV2beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">autoscalingv2beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AutoscalingV2beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BatchV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">batchv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Batch</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">batchv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BatchV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">batchv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BatchV2alpha1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">batchv2alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV2alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">CertificatesV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">certificatesv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertificatesV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Certificates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">certificatesv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertificatesV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Core</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">extensionsv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Extensions</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">extensionsv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NetworkingV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">networkingv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NetworkingV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Networking</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">networkingv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NetworkingV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PolicyV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">policyv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PolicyV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Policy</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">policyv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PolicyV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RbacV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">rbacv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Rbac</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">rbacv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RbacV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">rbacv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RbacV1alpha1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">rbacv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">SchedulingV1alpha1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">schedulingv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Scheduling</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">schedulingv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">SettingsV1alpha1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">settingsv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SettingsV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Settings</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">settingsv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SettingsV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">StorageV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">storagev1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">StorageV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">storagev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Storage</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">storagev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1Interface</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-4-corev1client">2.4 CoreV1Client</h2>
<p>我们以clientset中的<code>CoreV1Client</code>为例做分析。</p>
<p>通过传入的配置信息<code>rest.Config</code>初始化<code>CoreV1Client</code>对象。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/clientset.go#L464">k8s.io/client-go/kubernetes/clientset.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">coreV1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">configShallowCopy</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="2-4-1-corev1-newforconfig">2.4.1 corev1.NewForConfig</h3>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/core_client.go#L116:6">k8s.io/client-go/kubernetes/typed/core/v1/core_client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewForConfig creates a new CoreV1Client for the given config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">setConfigDefaults</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RESTClientFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>corev1.NewForConfig</code>方法本质是调用了<code>rest.RESTClientFor(&amp;config)</code>方法创建<code>RESTClient</code>对象，即<code>CoreV1Client</code>的本质就是一个<code>RESTClient</code>对象。</p>
<h3 id="2-4-2-corev1client结构体">2.4.2 CoreV1Client结构体</h3>
<p>以下是<code>CoreV1Client</code>结构体的定义：</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/core_client.go#L47:6">k8s.io/client-go/kubernetes/typed/core/v1/core_client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// CoreV1Client is used to interact with features provided by the  group.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">CoreV1Client</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">restClient</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>CoreV1Client</code>实现了<code>CoreV1Interface</code>的接口，即以下方法，从而对kubernetes的资源对象进行增删改查的操作。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/core_client.go#L51">k8s.io/client-go/kubernetes/typed/core/v1/core_client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//CoreV1Client的方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ComponentStatuses</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">ComponentStatusInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//ConfigMaps
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ConfigMaps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ConfigMapInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Endpoints
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Endpoints</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">EndpointsInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Events</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">EventInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">LimitRanges</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">LimitRangeInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Namespaces
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Namespaces</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">NamespaceInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Nodes</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">NodeInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">PersistentVolumeInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PersistentVolumeClaims</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PersistentVolumeClaimInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PodInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PodTemplates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PodTemplateInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//ReplicationControllers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ReplicationControllers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ReplicationControllerInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ResourceQuotas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ResourceQuotaInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Secrets</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">SecretInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Services
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServiceInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServiceAccounts</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServiceAccountInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-4-3-corev1interface">2.4.3 CoreV1Interface</h3>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/core_client.go#L26">k8s.io/client-go/kubernetes/typed/core/v1/core_client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">CoreV1Interface</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ComponentStatusesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ConfigMapsGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">EndpointsGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">EventsGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">LimitRangesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NamespacesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NodesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PersistentVolumesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PersistentVolumeClaimsGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PodsGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PodTemplatesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReplicationControllersGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ResourceQuotasGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">SecretsGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ServicesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ServiceAccountsGetter</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>CoreV1Interface</code>中包含了各种<code>kubernetes</code>对象的调用接口，例如<code>PodsGetter</code>是对kubernetes中<code>pod</code>对象增删改查操作的接口。<code>ServicesGetter</code>是对<code>service</code>对象的操作的接口。</p>
<h3 id="2-4-4-podsgetter">2.4.4 PodsGetter</h3>
<p>以下我们以<code>PodsGetter</code>接口为例分析<code>CoreV1Client</code>对<code>pod</code>对象的增删改查接口调用。</p>
<p>示例中的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><p><strong>CoreV1().Pods()</strong></p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/core_client.go#L87">k8s.io/client-go/kubernetes/typed/core/v1/core_client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PodInterface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">newPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>newPods()</strong></p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/pod.go#L54">k8s.io/client-go/kubernetes/typed/core/v1/pod.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// newPods returns a Pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">newPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ns</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>CoreV1().Pods()</code>的方法实际上是调用了<code>newPods()</code>的方法，创建了一个<code>pods</code>对象，<code>pods</code>对象继承了<code>rest.Interface</code>接口，即最终的实现本质是<code>RESTClient</code>的HTTP调用。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/pod.go#L48">k8s.io/client-go/kubernetes/typed/core/v1/pod.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pods implements PodInterface
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">pods</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ns</span>     <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>pods</code>对象实现了<code>PodInterface</code>接口。<code>PodInterface</code>定义了<code>pods</code>对象的增删改查等方法。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/pod.go#L34">k8s.io/client-go/kubernetes/typed/core/v1/pod.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodInterface has methods to work with Pod resources.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PodInterface</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeleteCollection</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listOptions</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Patch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pt</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PatchType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subresources</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PodExpansion</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>PodsGetter</strong></p>
<p>PodsGetter继承了PodInterface的接口。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/pod.go#L28">k8s.io/client-go/kubernetes/typed/core/v1/pod.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodsGetter has a method to return a PodInterface.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// A group&#39;s client should implement this interface.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PodsGetter</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PodInterface</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>Pods().List()</strong></p>
<p>pods.List()方法通过<code>RESTClient</code>的HTTP调用来实现对kubernetes的pod资源的获取。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/pod.go#L75">k8s.io/client-go/kubernetes/typed/core/v1/pod.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// List takes label and field selectors, and returns the list of Pods that match those selectors.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodList</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ns</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Resource</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pods&#34;</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">VersionedParams</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">scheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParameterCodec</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Do</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Into</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以上分析了<code>clientset.CoreV1().Pods(&quot;&quot;).List(metav1.ListOptions{})</code>对pod资源获取的过程，最终是调用<code>RESTClient</code>的方法实现。</p>
<h2 id="2-5-restclient">2.5 RESTClient</h2>
<p>以下分析<code>RESTClient</code>的创建过程及作用。</p>
<p><code>RESTClient</code>对象的创建同样是依赖传入的config信息。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/core_client.go#L121">k8s.io/client-go/kubernetes/typed/core/v1/core_client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RESTClientFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="2-5-1-rest-restclientfor">2.5.1 rest.RESTClientFor</h3>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/rest/config.go#L182">k8s.io/client-go/rest/config.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// RESTClientFor returns a RESTClient that satisfies the requested attributes on a client Config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// object. Note that a RESTClient may require fields that are optional when initializing a Client.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// A RESTClient created by this method is generic - it expects to operate on an API that follows
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the Kubernetes conventions, but may not be the Kubernetes API.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">RESTClientFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">qps</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QPS</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">burst</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Burst</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">baseURL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">versionedAPIPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">defaultServerUrlFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">transport</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">TransportFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">httpClient</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">transport</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultTransport</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">httpClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Transport</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">transport</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">httpClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewRESTClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">baseURL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">versionedAPIPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContentConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">qps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">burst</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimiter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">httpClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>RESTClientFor</code>函数调用了<code>NewRESTClient</code>的初始化函数。</p>
<h3 id="2-5-2-newrestclient">2.5.2 NewRESTClient</h3>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/rest/client.go#L91">k8s.io/client-go/rest/client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewRESTClient creates a new RESTClient. This client performs generic REST functions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// such as Get, Put, Post, and Delete on specified paths.  Codec controls encoding and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// decoding of responses from the server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewRESTClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">baseURL</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">versionedAPIPath</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span> <span style="color:#000">ContentConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">maxQPS</span> <span style="color:#204a87;font-weight:bold">float32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">maxBurst</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rateLimiter</span> <span style="color:#000">flowcontrol</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimiter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">client</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">base</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">baseURL</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">serializers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createSerializers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">base</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">base</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">versionedAPIPath</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">versionedAPIPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">contentConfig</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">serializers</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">serializers</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">createBackoffMgr</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">readExpBackoffConfig</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Throttle</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">throttle</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Client</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-5-3-restclient结构体">2.5.3 RESTClient结构体</h3>
<p>以下介绍RESTClient的结构体定义，RESTClient结构体中包含了<code>http.Client</code>，即本质上RESTClient就是一个<code>http.Client</code>的封装实现。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/rest/client.go#L54">k8s.io/client-go/rest/client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// RESTClient imposes common Kubernetes API conventions on a set of resource paths.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The baseURL is expected to point to an HTTP or HTTPS path that is the parent
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// of one or more resources.  The server should return a decodable API resource
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// object, or an api.Status object which contains information about the reason for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// any failure.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Most consumers should use client.New() to get a Kubernetes API client.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">RESTClient</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// base is the root URL for all invocations of the client
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">base</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// versionedAPIPath is a path segment connecting the base URL to the resource root
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">versionedAPIPath</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// contentConfig is the information used to communicate with the server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">contentConfig</span> <span style="color:#000">ContentConfig</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// serializers contain all serializers for underlying content type.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">serializers</span> <span style="color:#000">Serializers</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// creates BackoffManager that is passed to requests.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">createBackoffMgr</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">BackoffManager</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO extract this into a wrapper interface via the RESTClient interface in kubectl.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Throttle</span> <span style="color:#000">flowcontrol</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimiter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Set specific behavior of the client.  If not set http.DefaultClient will be used.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Client</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-5-4-restclient-interface">2.5.4 RESTClient.Interface</h3>
<p>RESTClient实现了以下的接口方法：</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/rest/client.go#L42">k8s.io/client-go/rest/client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Interface captures the set of operations for generically interacting with Kubernetes REST apis.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Interface</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">GetRateLimiter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">flowcontrol</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimiter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Verb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">verb</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Post</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Put</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Patch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pt</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PatchType</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Get</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">APIVersion</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersion</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在调用HTTP方法（Post()，Put()，Get()，Delete() ）时，实际上调用了Verb(verb string)函数。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/rest/client.go#L208">k8s.io/client-go/rest/client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Verb begins a request with a verb (GET, POST, PUT, DELETE).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Example usage of RESTClient&#39;s request building interface:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// c, err := NewRESTClient(...)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// if err != nil { ... }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// resp, err := c.Verb(&#34;GET&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  Path(&#34;pods&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  SelectorParam(&#34;labels&#34;, &#34;area=staging&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  Timeout(10*time.Second).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  Do()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// if err != nil { ... }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// list, ok := resp.(*api.PodList)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Verb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">verb</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">backoff</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createBackoffMgr</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">verb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">base</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">versionedAPIPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">contentConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serializers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backoff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Throttle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">verb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">base</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">versionedAPIPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">contentConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serializers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backoff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Throttle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>Verb</code>函数调用了<code>NewRequest</code>方法，最后调用<code>Do()</code>方法实现一个HTTP请求获取Result。</p>
<h2 id="2-6-总结">2.6 总结</h2>
<p><code>client-go</code>对kubernetes资源对象的调用，需要先获取kubernetes的配置信息，即<code>$HOME/.kube/config</code>。</p>
<p>整个调用的过程如下：</p>
<p>kubeconfig→rest.config→clientset→具体的client(CoreV1Client)→具体的资源对象(pod)→RESTClient→http.Client→HTTP请求的发送及响应</p>
<p>通过clientset中不同的client和client中不同资源对象的方法实现对kubernetes中资源对象的增删改查等操作，常用的client有<code>CoreV1Client</code>、<code>AppsV1beta1Client</code>、<code>ExtensionsV1beta1Client</code>等。</p>
<h1 id="3-client-go对k8s资源的调用">3. client-go对k8s资源的调用</h1>
<p><strong>创建clientset</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//获取kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kubeconfig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kubeconfig&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">home</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.kube&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;(optional) absolute path to the kubeconfig file&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建config	
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientcmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuildConfigFromFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeconfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建clientset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//具体的资源调用见以下例子
</span></span></span></code></pre></div><h2 id="3-1-deployment">3.1 deployment</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明deployment对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">deployment</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//构造deployment对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//更新deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//删除deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//查询deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//列出deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">deploymentList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//watch deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">watchInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><h2 id="3-2-service">3.2 service</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明service对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">service</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//构造service对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建service
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//更新service
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//删除service
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//查询service
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//列出service
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">serviceList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//watch service
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">watchInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><h2 id="3-3-ingress">3.3 ingress</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明ingress对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ingress</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//构造ingress对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建ingress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Ingresses</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//更新ingress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Ingresses</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//删除ingress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Ingresses</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//查询ingress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Ingresses</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//列出ingress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ingressList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Ingresses</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//watch ingress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">watchInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Ingresses</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><h2 id="3-4-replicaset">3.4 replicaSet</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明replicaSet对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">replicaSet</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSet</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//构造replicaSet对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建replicaSet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//更新replicaSet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//删除replicaSet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//查询replicaSet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//列出replicaSet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">replicaSetList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//watch replicaSet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">watchInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><p>新版的kubernetes中一般通过deployment来创建replicaSet，再通过replicaSet来控制pod。</p>
<h2 id="3-5-pod">3.5 pod</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明pod对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//更新pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//删除pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//查询pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//列出pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">podList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//watch pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">watchInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><h2 id="3-6-statefulset">3.6 statefulset</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明statefulset对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">statefulset</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//更新statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//删除statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//查询statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//列出statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">statefulsetList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//watch statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">watchInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><p>​	通过以上对kubernetes的资源对象的操作函数可以看出，每个资源对象都有增删改查等方法，基本调用逻辑类似。一般二次开发只需要创建deployment、service、ingress三个资源对象即可，pod对象由deployment包含的replicaSet来控制创建和删除。函数调用的入参一般只有<code>NAMESPACE</code>和<code>kubernetesObject</code>两个参数，部分操作有<code>Options</code>的参数。在创建前，需要对资源对象构造数据，可以理解为编辑一个资源对象的yaml文件，然后通过<code>kubectl create -f xxx.yaml</code>来创建对象。</p>
<p>参考文档:</p>
<ul>
<li><a href="https://github.com/kubernetes/client-go">https://github.com/kubernetes/client-go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-75c48100cb89c80d973b7c57a96377f6">9.2 - operator开发</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-15fa0d56cfe1e152b7d82dfc0c656c29">9.2.1 - kubebuilder的使用</h1>
    
	<h1 id="1-kubebuilder">1. kubebuilder</h1>
<h2 id="1-1-安装kubebuilder">1.1. 安装kubebuilder</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># download kubebuilder and install locally.</span>
</span></span><span style="display:flex;"><span>curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/<span style="color:#204a87;font-weight:bold">$(</span>go env GOOS<span style="color:#204a87;font-weight:bold">)</span>/<span style="color:#204a87;font-weight:bold">$(</span>go env GOARCH<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>chmod +x kubebuilder <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> mv kubebuilder /usr/local/bin/
</span></span></code></pre></div><h2 id="1-2-kubebuilder命令">1.2. kubebuilder命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Development kit <span style="color:#204a87;font-weight:bold">for</span> building Kubernetes extensions and tools.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Provides libraries and tools to create new projects, APIs and controllers.
</span></span><span style="display:flex;"><span>Includes tools <span style="color:#204a87;font-weight:bold">for</span> packaging artifacts into an installer container.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Typical project lifecycle:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- initialize a project:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  kubebuilder init --domain example.com --license apache2 --owner <span style="color:#4e9a06">&#34;The Kubernetes authors&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- create one or more a new resource APIs and add your code to them:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  kubebuilder create api --group &lt;group&gt; --version &lt;version&gt; --kind &lt;Kind&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Create resource will prompt the user <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87;font-weight:bold">if</span> it should scaffold the Resource and / or Controller. To only
</span></span><span style="display:flex;"><span>scaffold a Controller <span style="color:#204a87;font-weight:bold">for</span> an existing Resource, <span style="color:#204a87;font-weight:bold">select</span> <span style="color:#4e9a06">&#34;n&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> Resource. To only define
</span></span><span style="display:flex;"><span>the schema <span style="color:#204a87;font-weight:bold">for</span> a Resource without writing a Controller, <span style="color:#204a87;font-weight:bold">select</span> <span style="color:#4e9a06">&#34;n&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> Controller.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>After the scaffold is written, api will run make on the project.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  kubebuilder <span style="color:#ce5c00;font-weight:bold">[</span>command<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available Commands:
</span></span><span style="display:flex;"><span>  create      Scaffold a Kubernetes API or webhook.
</span></span><span style="display:flex;"><span>  edit        This <span style="color:#204a87">command</span> will edit the project configuration
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">help</span>        Help about any <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>  init        Initialize a new project
</span></span><span style="display:flex;"><span>  version     Print the kubebuilder version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>  -h, --help   <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> kubebuilder
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;kubebuilder [command] --help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information about a command.
</span></span></code></pre></div><h1 id="2-操作步骤">2. 操作步骤</h1>
<h2 id="2-1-初始化">2.1. 初始化</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir <span style="color:#000">$GOPATH</span>/src/github.com/huweihuang/operator-example
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> <span style="color:#000">$GOPATH</span>/src/github.com/huweihuang/operator-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go mod init github.com/huweihuang/operator-example
</span></span></code></pre></div><h2 id="2-2-创建项目">2.2. 创建项目</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubebuilder init --domain github.com --license apache2 --owner &#34;Hu Weihuang&#34;</span>
</span></span><span style="display:flex;"><span>Writing scaffold <span style="color:#204a87;font-weight:bold">for</span> you to edit...
</span></span><span style="display:flex;"><span>Get controller runtime:
</span></span><span style="display:flex;"><span>$ go get sigs.k8s.io/controller-runtime@v0.5.0
</span></span><span style="display:flex;"><span>Update go.mod:
</span></span><span style="display:flex;"><span>$ go mod tidy
</span></span><span style="display:flex;"><span>Running make:
</span></span><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span>go: creating new go.mod: module tmp
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io v0.2.5
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io/controller-tools/cmd v0.2.5
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io/controller-tools/cmd/controller-gen v0.2.5
</span></span><span style="display:flex;"><span>/Users/weihuanghu/go/bin/controller-gen object:headerFile<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;hack/boilerplate.go.txt&#34;</span> <span style="color:#000">paths</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;./...&#34;</span>
</span></span><span style="display:flex;"><span>go fmt ./...
</span></span><span style="display:flex;"><span>go vet ./...
</span></span><span style="display:flex;"><span>go build -o bin/manager main.go
</span></span><span style="display:flex;"><span>Next: define a resource with:
</span></span><span style="display:flex;"><span>$ kubebuilder create api
</span></span></code></pre></div><p>查看生成文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./
</span></span><span style="display:flex;"><span>├── Dockerfile
</span></span><span style="display:flex;"><span>├── Makefile
</span></span><span style="display:flex;"><span>├── PROJECT
</span></span><span style="display:flex;"><span>├── bin
</span></span><span style="display:flex;"><span>│   └── manager
</span></span><span style="display:flex;"><span>├── config
</span></span><span style="display:flex;"><span>│   ├── certmanager
</span></span><span style="display:flex;"><span>│   │   ├── certificate.yaml
</span></span><span style="display:flex;"><span>│   │   ├── kustomization.yaml
</span></span><span style="display:flex;"><span>│   │   └── kustomizeconfig.yaml
</span></span><span style="display:flex;"><span>│   ├── default
</span></span><span style="display:flex;"><span>│   │   ├── kustomization.yaml
</span></span><span style="display:flex;"><span>│   │   ├── manager_auth_proxy_patch.yaml
</span></span><span style="display:flex;"><span>│   │   ├── manager_webhook_patch.yaml
</span></span><span style="display:flex;"><span>│   │   └── webhookcainjection_patch.yaml
</span></span><span style="display:flex;"><span>│   ├── manager
</span></span><span style="display:flex;"><span>│   │   ├── kustomization.yaml
</span></span><span style="display:flex;"><span>│   │   └── manager.yaml
</span></span><span style="display:flex;"><span>│   ├── prometheus
</span></span><span style="display:flex;"><span>│   │   ├── kustomization.yaml
</span></span><span style="display:flex;"><span>│   │   └── monitor.yaml
</span></span><span style="display:flex;"><span>│   ├── rbac
</span></span><span style="display:flex;"><span>│   │   ├── auth_proxy_client_clusterrole.yaml
</span></span><span style="display:flex;"><span>│   │   ├── auth_proxy_role.yaml
</span></span><span style="display:flex;"><span>│   │   ├── auth_proxy_role_binding.yaml
</span></span><span style="display:flex;"><span>│   │   ├── auth_proxy_service.yaml
</span></span><span style="display:flex;"><span>│   │   ├── kustomization.yaml
</span></span><span style="display:flex;"><span>│   │   ├── leader_election_role.yaml
</span></span><span style="display:flex;"><span>│   │   ├── leader_election_role_binding.yaml
</span></span><span style="display:flex;"><span>│   │   └── role_binding.yaml
</span></span><span style="display:flex;"><span>│   └── webhook
</span></span><span style="display:flex;"><span>│       ├── kustomization.yaml
</span></span><span style="display:flex;"><span>│       ├── kustomizeconfig.yaml
</span></span><span style="display:flex;"><span>│       └── service.yaml
</span></span><span style="display:flex;"><span>├── go.mod
</span></span><span style="display:flex;"><span>├── go.sum
</span></span><span style="display:flex;"><span>├── hack
</span></span><span style="display:flex;"><span>│   └── boilerplate.go.txt
</span></span><span style="display:flex;"><span>└── main.go
</span></span></code></pre></div><h2 id="2-3-创建api">2.3. 创建API</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubebuilder create api --group webapp --version v1 --kind Guestbook</span>
</span></span><span style="display:flex;"><span>Create Resource <span style="color:#ce5c00;font-weight:bold">[</span>y/n<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>y
</span></span><span style="display:flex;"><span>Create Controller <span style="color:#ce5c00;font-weight:bold">[</span>y/n<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>y
</span></span><span style="display:flex;"><span>Writing scaffold <span style="color:#204a87;font-weight:bold">for</span> you to edit...
</span></span><span style="display:flex;"><span>api/v1/guestbook_types.go
</span></span><span style="display:flex;"><span>controllers/guestbook_controller.go
</span></span><span style="display:flex;"><span>Running make:
</span></span><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span>go: creating new go.mod: module tmp
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io/controller-tools/cmd v0.2.5
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io/controller-tools/cmd/controller-gen v0.2.5
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io v0.2.5
</span></span><span style="display:flex;"><span>/Users/weihuanghu/go/bin/controller-gen object:headerFile<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;hack/boilerplate.go.txt&#34;</span> <span style="color:#000">paths</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;./...&#34;</span>
</span></span><span style="display:flex;"><span>go fmt ./...
</span></span><span style="display:flex;"><span>go vet ./...
</span></span><span style="display:flex;"><span>go build -o bin/manager main.go
</span></span></code></pre></div><p>查看创建文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>api
</span></span><span style="display:flex;"><span>└── v1
</span></span><span style="display:flex;"><span>    ├── groupversion_info.go
</span></span><span style="display:flex;"><span>    ├── guestbook_types.go
</span></span><span style="display:flex;"><span>    └── zz_generated.deepcopy.go
</span></span><span style="display:flex;"><span>controllers
</span></span><span style="display:flex;"><span>├── guestbook_controller.go
</span></span><span style="display:flex;"><span>└── suite_test.go
</span></span></code></pre></div><p>查看api/v1/guestbook_types.go</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// GuestbookSpec defines the desired state of Guestbook
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">GuestbookSpec</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Quantity of instances
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +kubebuilder:validation:Minimum=1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +kubebuilder:validation:Maximum=10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Size</span> <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#4e9a06">`json:&#34;size&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Name of the ConfigMap for GuestbookSpec&#39;s configuration
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +kubebuilder:validation:MaxLength=15
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +kubebuilder:validation:MinLength=1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">ConfigMapName</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;configMapName&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// +kubebuilder:validation:Enum=Phone;Address;Name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Type</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;alias,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// GuestbookStatus defines the observed state of Guestbook
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">GuestbookStatus</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// PodName of the active Guestbook node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Active</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;active&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// PodNames of the standby Guestbook nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Standby</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;standby&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// +kubebuilder:object:root=true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// +kubebuilder:subresource:status
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// +kubebuilder:resource:scope=Cluster
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Guestbook is the Schema for the guestbooks API
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Guestbook</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeMeta</span>   <span style="color:#4e9a06">`json:&#34;,inline&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span> <span style="color:#4e9a06">`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Spec</span>   <span style="color:#000">GuestbookSpec</span>   <span style="color:#4e9a06">`json:&#34;spec,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Status</span> <span style="color:#000">GuestbookStatus</span> <span style="color:#4e9a06">`json:&#34;status,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-troubleshooting">3. troubleshooting</h1>
<h2 id="3-1-controller-gen-no-such-file-or-directory">3.1. controller-gen: No such file or directory</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>➜  operator-example kubebuilder init --domain github.com --license apache2 --owner <span style="color:#4e9a06">&#34;Hu Weihuang&#34;</span>
</span></span><span style="display:flex;"><span>Writing scaffold <span style="color:#204a87;font-weight:bold">for</span> you to edit...
</span></span><span style="display:flex;"><span>Get controller runtime:
</span></span><span style="display:flex;"><span>$ go get sigs.k8s.io/controller-runtime@v0.5.0
</span></span><span style="display:flex;"><span>Update go.mod:
</span></span><span style="display:flex;"><span>$ go mod tidy
</span></span><span style="display:flex;"><span>Running make:
</span></span><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span>go: creating new go.mod: module tmp
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io v0.2.5
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io/controller-tools/cmd v0.2.5
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io/controller-tools/cmd/controller-gen v0.2.5
</span></span><span style="display:flex;"><span>/Users/weihuanghu/go:/Users/weihuanghu/k8spath/bin/controller-gen object:headerFile<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;hack/boilerplate.go.txt&#34;</span> <span style="color:#000">paths</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;./...&#34;</span>
</span></span><span style="display:flex;"><span>/bin/sh: /Users/weihuanghu/go:/Users/weihuanghu/k8spath/bin/controller-gen: No such file or directory
</span></span><span style="display:flex;"><span>make: *** <span style="color:#ce5c00;font-weight:bold">[</span>generate<span style="color:#ce5c00;font-weight:bold">]</span> Error <span style="color:#0000cf;font-weight:bold">127</span>
</span></span><span style="display:flex;"><span>2020/04/13 14:34:47 failed to initialize project: <span style="color:#204a87">exit</span> status <span style="color:#0000cf;font-weight:bold">2</span>
</span></span></code></pre></div><p>由于本地存在多个GOPATH的目录，而获取了非当前项目下的GOPATH目录，因此将当前项目所在的GOPATH目录export到GOPATH环境变量中，就可以解决。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">GOPATH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/path/to/gopath&#34;</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/">https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/</a></li>
<li><a href="https://github.com/kubernetes-sigs/kubebuilder">https://github.com/kubernetes-sigs/kubebuilder</a></li>
<li><a href="https://book.kubebuilder.io/quick-start.html">https://book.kubebuilder.io/quick-start.html</a></li>
<li><a href="https://operatorhub.io/">https://operatorhub.io/</a></li>
<li><a href="https://devops.college/developing-kubernetes-operator-is-now-easy-with-operator-framework-d3194a7428ff">https://devops.college/developing-kubernetes-operator-is-now-easy-with-operator-framework-d3194a7428ff</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e0f9d77a375a891566ac10e26e32ae95">9.2.2 - 如何开发一个Operator</h1>
    
	<p>开发一个k8s operator组件主要会用到以下几个仓库或工具：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder">kubebuilder</a>/<a href="https://github.com/operator-framework/operator-sdk">operator-sdk</a>：主要用于创建CRD对象。</p>
</li>
<li>
<p><a href="https://github.com/kubernetes-sigs/controller-runtime">controller-manager</a>：主要用于实现operator的controller逻辑。</p>
</li>
</ul>
<p>本文以kubebuilder的工具和<a href="https://github.com/kubernetes-sigs/controller-runtime/blob/main/examples/crd/main.go">controller-manager example</a>为例。</p>
<h1 id="1-准备工具环境及创建项目">1. 准备工具环境及创建项目</h1>
<p>安装kubebuilder工具</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/<span style="color:#204a87;font-weight:bold">$(</span>go env GOOS<span style="color:#204a87;font-weight:bold">)</span>/<span style="color:#204a87;font-weight:bold">$(</span>go env GOARCH<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>chmod +x kubebuilder <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> mv kubebuilder /usr/local/bin/
</span></span></code></pre></div><p>创建operator项目目录</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubebuilder init --domain example.com --license apache2 --owner <span style="color:#4e9a06">&#34;Your Name&#34;</span> --repo github.com/example/my-operator
</span></span></code></pre></div><p>将 <code>example.com</code> 替换为你的域名，<code>Your Name</code> 替换为你的名字，<code>github.com/example/my-operator</code> 替换为你的 GitHub 仓库。</p>
<h1 id="2-创建crd对象">2. 创建CRD对象</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubebuilder create api --group mygroup --version v1alpha1 --kind MyResource
</span></span></code></pre></div><p>这将在 <code>api/v1alpha1</code> 文件夹中创建一个名为 <code>myresource_types.go</code> 的文件，其中定义了 <code>MyResource</code> 资源的规范和状态。</p>
<p>编辑 <code>api/v1alpha1/myresource_types.go</code> 文件，添加自定义资源的规范和状态字段。</p>
<h1 id="3-实现控制器逻辑">3. 实现控制器逻辑</h1>
<p>在 <code>controllers/myresource_controller.go</code> 文件中实现控制器逻辑。该部分是不同的CRD实现自定义逻辑的核心部分。</p>
<p>主要包含以下几个部分：</p>
<ol>
<li>
<p><strong>定义ReconcileMyResource结构体。</strong></p>
</li>
<li>
<p><strong>实现<code>func (r *ReconcileMyResource) Reconcile(ctx context.Context, request reconcile.Request) (reconcile.Result, error)</code>函数接口。</strong></p>
</li>
<li>
<p><strong>定义finalizer逻辑。</strong></p>
</li>
<li>
<p><strong>定义reconcile逻辑。</strong></p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">controllers</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;github.com/go-logr/logr&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/controller/controllerutil&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/controller/inject&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/reconcile&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">myv1alpha1</span> <span style="color:#4e9a06">&#34;github.com/example/my-operator/api/v1alpha1&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">corev1</span> <span style="color:#4e9a06">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;k8s.io/apimachinery/pkg/api/errors&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/controller&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logf</span> <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/log&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/log/zap&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/manager&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/reconcile&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/source&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">log</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">logf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;controller_myresource&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Add creates a new MyResource Controller and adds it to the Manager. The Manager will set fields on the Controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and Start it when the Manager is Started.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newReconciler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// newReconciler returns a new reconcile.Reconciler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">newReconciler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reconciler</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ReconcileMyResource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetClient</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">scheme</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetScheme</span><span style="color:#000;font-weight:bold">()}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// blank assignment to verify that ReconcileMyResource implements reconcile.Reconciler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">_</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reconciler</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ReconcileMyResource</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ReconcileMyResource reconciles a MyResource object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ReconcileMyResource</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">client</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">scheme</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Reconcile reads that state of the cluster for a MyResource object and makes changes based on the state read
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and what is in the MyResource.Spec
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ReconcileMyResource</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Reconcile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">reqLogger</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Namespace&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">reqLogger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Reconciling MyResource&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Fetch the MyResource instance
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">myresource</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">myv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MyResource</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespacedName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">myresource</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotFound</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// Request object not found, could have been deleted after reconcile request.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// Owned objects are automatically garbage collected. For additional cleanup logic use finalizers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// Return and don&#39;t requeue
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Result</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Error reading the object - requeue the request.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Result</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Add finalizer logic here
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Add reconcile logic here
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Result</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-注册控制器">4. 注册控制器</h1>
<p>在 <code>main.go</code> 文件中注册控制器，主要包含以下几个步骤</p>
<ol>
<li>
<p><strong>ctrl.SetLogger(zap.New())：注册日志工具</strong></p>
</li>
<li>
<p><strong>ctrl.NewManager：创建一个manager，必要时可设置选主逻辑。</strong></p>
</li>
<li>
<p><strong>ctrl.NewControllerManagedBy(mgr)：预计mgr创建manager controller并注册Reconciler。</strong></p>
</li>
<li>
<p><strong>mgr.Start(ctrl.SetupSignalHandler()): 运行mgr。</strong></p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// set logger
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">zap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Set up a Manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetConfigOrDie</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Options</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">myv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchemeBuilder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">MetricsBindAddress</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">metricsHost</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">Port</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#0000cf;font-weight:bold">9443</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">enableLeaderElection</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">LeaderElectionID</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;my-operator-lock&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unable to start manager&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// in a real controller, we&#39;d create a new scheme for this
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddToScheme</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetScheme</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unable to add scheme&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Create a new Reconciler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ReconcileMyResource</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetClient</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">scheme</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetScheme</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Create a new Controller and register the Reconciler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerManagedBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">For</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">myv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MyResource</span><span style="color:#000;font-weight:bold">{}).</span>     <span style="color:#8f5902;font-style:italic">// 自定义crd
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>                        <span style="color:#8f5902;font-style:italic">// 注册Reconciler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unable to create controller&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewWebhookManagedBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">For</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ChaosPod</span><span style="color:#000;font-weight:bold">{}).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unable to create webhook&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;starting manager&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetupSignalHandler</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;problem running manager&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://book.kubebuilder.io/cronjob-tutorial/controller-implementation.html">Implementing a controller - The Kubebuilder Book</a></p>
</li>
<li>
<p><a href="https://qiankunli.github.io/2020/08/10/controller_runtime.html">controller-runtime源码分析 | 李乾坤的博客</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder">Kubebuilder - SDK for building Kubernetes APIs using CRDs</a></p>
</li>
<li>
<p><a href="https://github.com/operator-framework/operator-sdk">operator-framework/operator-sdk: SDK for building Kubernetes applications.</a></p>
</li>
<li>
<p><a href="https://blog.hdls.me/16500403497126.html">https://blog.hdls.me/16500403497126.html</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder/blob/master/docs/book/src/multiversion-tutorial/testdata/project/controllers/cronjob_controller.go">kubebuilder-cronjob_controller</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c891529cb3c8cef200ec4a9ae6cf4cb7">9.3 - CSI插件开发</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-3b99a3043c0685804c1f4dcda6d8a2d1">9.3.1 - csi-provisioner源码分析</h1>
    
	<blockquote>
<p>本文主要分析<code>csi-provisioner</code>的源码，关于开发一个<code>Dynamic Provisioner</code>，具体可参考<a href="https://www.huweihuang.com/kubernetes-notes/develop/nfs-client-provisioner.html">nfs-client-provisioner的源码分析</a></p>
</blockquote>
<h1 id="1-dynamic-provisioner">1. Dynamic Provisioner</h1>
<h2 id="1-1-provisioner-interface">1.1. Provisioner Interface</h2>
<p>开发<code>Dynamic Provisioner</code>需要实现<a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/volume.go#L29">Provisioner</a>接口，该接口有两个方法，分别是：</p>
<ul>
<li>Provision：创建存储资源，并且返回一个PV对象。</li>
<li>Delete：移除对应的存储资源，但并没有删除PV对象。</li>
</ul>
<h2 id="1-2-开发provisioner的步骤">1.2. 开发provisioner的步骤</h2>
<ol>
<li>写一个<code>provisioner</code>实现<code>Provisioner</code>接口（包含<code>Provision</code>和<code>Delete</code>的方法）。</li>
<li>通过该<code>provisioner</code>构建<code>ProvisionController</code>。</li>
<li>执行<code>ProvisionController</code>的<code>Run</code>方法。</li>
</ol>
<h1 id="2-csi-provisioner">2. CSI Provisioner</h1>
<p>CSI Provisioner的源码可参考：https://github.com/kubernetes-csi/external-provisioner。</p>
<h2 id="2-1-main-函数-https-github-com-kubernetes-csi-external-provisioner-blob-master-cmd-csi-provisioner-csi-provisioner-go">2.1. <a href="https://github.com/kubernetes-csi/external-provisioner/blob/master/cmd/csi-provisioner/csi-provisioner.go">Main 函数</a></h2>
<h3 id="2-1-1-读取环境变量">2.1.1. 读取环境变量</h3>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisioner</span>          <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;provisioner&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Name of the provisioner. The provisioner will only provision volumes for claims that request a StorageClass with a provisioner field set equal to this name.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">master</span>               <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;master&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Master URL to build a client config from. Either this or kubeconfig needs to be set if the provisioner is being run out of cluster.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeconfig</span>           <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kubeconfig&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Absolute path to the kubeconfig file. Either this or master needs to be set if the provisioner is being run out of cluster.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">csiEndpoint</span>          <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;csi-address&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/run/csi/socket&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;The gRPC endpoint for Target CSI Volume&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">connectionTimeout</span>    <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;connection-timeout&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Timeout for waiting for CSI driver socket.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeNamePrefix</span>     <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;volume-name-prefix&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;pvc&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Prefix to apply to the name of a created volume&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeNameUUIDLength</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;volume-name-uuid-length&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Truncates generated UUID of a created volume to this length. Defaults behavior is to NOT truncate.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">showVersion</span>          <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;version&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Show version.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisionController</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProvisionController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">version</span>             <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;unknown&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;logtostderr&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">showVersion</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Version: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>	
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>	
</span></span></code></pre></div><p>通过<code>init函数</code>解析相关参数，其实<code>provisioner</code>指明为PVC提供PV的provisioner的名字，需要和<code>StorageClass</code>对象中的<code>provisioner</code>字段一致。</p>
<h3 id="2-1-2-获取clientset对象">2.1.2. 获取clientset对象</h3>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// get the KUBECONFIG from env if specified (useful for local/debug cluster)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kubeconfigEnv</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KUBECONFIG&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeconfigEnv</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Found KUBECONFIG environment variable set, using that..&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeconfig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeconfigEnv</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">master</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeconfig</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Either master or kubeconfig specified. building kube config from that..&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">clientcmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuildConfigFromFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">master</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeconfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Building kube configs for running in cluster...&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InClusterConfig</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create config: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create client: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// snapclientset.NewForConfig creates a new Clientset for VolumesnapshotV1alpha1Client
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">snapClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">snapclientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create snapshot client: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">csiAPIClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csiclientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create CSI API client: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过读取对应的k8s的配置，创建<code>clientset</code>对象，用来执行k8s对应的API，其中主要包括对PV和PVC等对象的创建删除等操作。</p>
<h3 id="2-1-3-k8s版本校验">2.1.3. k8s版本校验</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The controller needs to know what the server version is because out-of-tree
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// provisioners aren&#39;t officially supported until 1.5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">serverVersion</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Discovery</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ServerVersion</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error getting server version: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>获取了k8s的版本信息，因为provisioners的功能在k8s 1.5及以上版本才支持。</p>
<h3 id="2-1-4-连接-csi-socket">2.1.4. 连接 csi socket</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Generate a unique ID for this provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">timeStamp</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UnixNano</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">identity</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormatInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">timeStamp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;-&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Itoa</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Intn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;-&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">provisioner</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Provisioner will stay in Init until driver opens csi socket, once it&#39;s done
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// controller will exit this loop and proceed normally.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">socketDown</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000">grpcClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConn</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">socketDown</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">csiEndpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connectionTimeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">socketDown</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在<code>Provisioner</code>会停留在初始化状态，直到<code>csi socket</code>连接成功才正常运行。如果连接失败，会暂停<code>10秒</code>后重试，其中涉及以下2个参数：</p>
<ul>
<li>csiEndpoint：CSI Volume的gRPC地址，默认通过为<code>/run/csi/socket</code>。</li>
<li>connectionTimeout：连接CSI driver socket的超时时间，默认为10秒。</li>
</ul>
<h3 id="2-1-5-构造csi-provisioner对象">2.1.5. 构造csi-Provisioner对象</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create the provisioner: it implements the Provisioner interface expected by
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">csiProvisioner</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCSIProvisioner</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">csiAPIClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">csiEndpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connectionTimeout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">identity</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">volumeNamePrefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">volumeNameUUIDLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">snapClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">provisionController</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewProvisionController</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">csiProvisioner</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">serverVersion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GitVersion</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>通过参数<code>clientset</code>,<code> csiAPIClient</code>, <code>csiEndpoint</code>, <code>connectionTimeout</code>, <code>identity</code>, <code>volumeNamePrefix</code>, <code>volumeNameUUIDLength</code>,<code> grpcClient</code>, <code>snapClient</code>构造csi-Provisioner对象。</p>
<p>通过<code>csiProvisioner</code>构造<code>ProvisionController</code>对象。</p>
<h3 id="2-1-6-运行provisioncontroller">2.1.6. 运行ProvisionController</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisionController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>ProvisionController</code>实现了具体的PV和PVC的相关逻辑，<code>Run</code>方法以常驻进程的方式运行。</p>
<h2 id="2-2-provision-https-github-com-kubernetes-csi-external-provisioner-blob-master-pkg-controller-controller-go-l336-和-delete-https-github-com-kubernetes-csi-external-provisioner-blob-master-pkg-controller-controller-go-l606-方法">2.2. <a href="https://github.com/kubernetes-csi/external-provisioner/blob/master/pkg/controller/controller.go#L336">Provision</a>和<a href="https://github.com/kubernetes-csi/external-provisioner/blob/master/pkg/controller/controller.go#L606">Delete</a>方法</h2>
<h3 id="2-2-1-provision方法">2.2.1. Provision方法</h3>
<blockquote>
<p><code>csiProvisioner</code>的<code>Provision</code>方法具体源码参考：https://github.com/kubernetes-csi/external-provisioner/blob/master/pkg/controller/controller.go#L336</p>
</blockquote>
<p><code>Provision</code>方法用来创建存储资源，并且返回一个<code>PV</code>对象。其中入参是<code>VolumeOptions</code>，用来指定<code>PV</code>对象的相关属性。</p>
<p><strong>1、构造PV相关属性</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">makeVolumeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeNamePrefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeNameUUIDLength</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>2、构造CSIPersistentVolumeSource相关属性</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">driverState</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">checkDriverState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">needSnapshotSupport</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Resolve controller publish, node stage, node publish secret references
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">controllerPublishSecretRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getSecretReference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerPublishSecretNameKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerPublishSecretNamespaceKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">nodeStageSecretRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getSecretReference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeStageSecretNameKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeStageSecretNamespaceKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">nodePublishSecretRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getSecretReference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodePublishSecretNameKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodePublishSecretNamespaceKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">volumeAttributes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">provisionerIDKey</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">identity</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Attributes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeAttributes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">fsType</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ToLower</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;fstype&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fsType</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fsType</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fsType</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">defaultFSType</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>3、创建CSI CreateVolumeRequest</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create a CSI CreateVolumeRequest and Response
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateVolumeRequest</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">VolumeCapabilities</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">volumeCaps</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">CapacityRange</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CapacityRange</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">RequiredBytes</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volSizeBytes</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CreateVolumeRequest %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">rep</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateVolumeResponse</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backoff</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backoffDuration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Factor</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backoffFactor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Steps</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backoffSteps</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExponentialBackoff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rep</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// CreateVolume has finished successfully
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FromError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">codes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeadlineExceeded</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// CreateVolume timed out, give it another chance to complete
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CreateVolume timeout: %s has expired, operation will be retried&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// CreateVolume failed , no reason to retry, bailing from ExponentialBackoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volume</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create volume rep: %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volume</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">respCap</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetVolume</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">GetCapacityBytes</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">respCap</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">volSizeBytes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">capErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;created volume capacity %v less than requested capacity %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">respCap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volSizeBytes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">delReq</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolumeRequest</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">VolumeId</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetVolume</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">GetId</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">delReq</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerDeleteSecrets</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">provisionerCredentials</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">delReq</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">capErr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%v. Cleanup of volume %s failed, volume is orphaned: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">capErr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">capErr</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>Provison</code>方法核心功能是调用<code>p.csiClient.CreateVolume(ctx, &amp;req)</code>。</p>
<p><strong>4、构造PV对象</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pv</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeSpec</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">PersistentVolumeReclaimPolicy</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeReclaimPolicy</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AccessModes</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AccessModes</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Capacity</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceList</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceStorage</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#000">bytesToGiQuantity</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">respCap</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// TODO wait for CSI VolumeSource API
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">PersistentVolumeSource</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeSource</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">CSI</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CSIPersistentVolumeSource</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Driver</span><span style="color:#000;font-weight:bold">:</span>                     <span style="color:#000">driverState</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">driverName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">VolumeHandle</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeIdToHandle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Id</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">FSType</span><span style="color:#000;font-weight:bold">:</span>                     <span style="color:#000">fsType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">VolumeAttributes</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">volumeAttributes</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">ControllerPublishSecretRef</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">controllerPublishSecretRef</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">NodeStageSecretRef</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">nodeStageSecretRef</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">NodePublishSecretRef</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">nodePublishSecretRef</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">driverState</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">capabilities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Has</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PluginCapability_ACCESSIBILITY_CONSTRAINTS</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeAffinity</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">GenerateVolumeNodeAffinity</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AccessibleTopology</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;successfully created PV %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeSource</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pv</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span></code></pre></div><p><code>Provision</code>方法只是通过<code>VolumeOptions</code>参数来构建<code>PV</code>对象，并没有执行具体<code>PV</code>的创建或删除的操作。</p>
<p>不同类型的<code>Provisioner</code>的，一般是<code>PersistentVolumeSource</code>类型和参数不同，例如<code>csi-provisioner</code>对应的<code>PersistentVolumeSource</code>为<code>CSI</code>，并且需要传入<code>CSI</code>相关的参数：</p>
<ul>
<li><code>Driver</code></li>
<li><code>VolumeHandle</code></li>
<li><code>FSType</code></li>
<li><code>VolumeAttributes</code></li>
<li><code>ControllerPublishSecretRef</code></li>
<li><code>NodeStageSecretRef</code></li>
<li><code>NodePublishSecretRef</code></li>
</ul>
<h3 id="2-2-2-delete方法">2.2.2. Delete方法</h3>
<blockquote>
<p><code>csiProvisioner</code>的<code>delete</code>方法具体源码参考：https://github.com/kubernetes-csi/external-provisioner/blob/master/pkg/controller/controller.go#L606</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">csiProvisioner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CSI</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;invalid CSI PV&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeId</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeHandleToId</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CSI</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumeHandle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">checkDriverState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolumeRequest</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">VolumeId</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">volumeId</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// get secrets if StorageClass specifies it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">storageClassName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageClassName</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">storageClassName</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">storageClass</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StorageClasses</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">storageClassName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{});</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Resolve provision secret credentials.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// No PVC is provided when resolving provision/delete secret names, since the PVC may or may not exist at delete time.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">provisionerSecretRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getSecretReference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">provisionerSecretNameKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">provisionerSecretNamespaceKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">storageClass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">credentials</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getCredentials</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">provisionerSecretRef</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerDeleteSecrets</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">credentials</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>Delete</code>方法主要是调用了<code>p.csiClient.DeleteVolume(ctx, &amp;req)</code>方法。</p>
<h2 id="2-3-总结">2.3. 总结</h2>
<p><code>csi provisioner</code>实现了<code>Provisioner</code>接口，其中包含<code>Provison</code>和<code>Delete</code>两个方法:</p>
<ul>
<li><code>Provision</code>：调用<code>csiClient.CreateVolume</code>方法，同时构造并返回PV对象。</li>
<li><code>Delete</code>：调用<code>csiClient.DeleteVolume</code>方法。</li>
</ul>
<p><code>csi provisioner</code>的核心方法都调用了<code>csi-client</code>相关方法。</p>
<h1 id="3-csi-client">3. csi-client</h1>
<blockquote>
<p><code>csi client</code>的相关代码参考：https://github.com/container-storage-interface/spec/blob/master/lib/go/csi/v0/csi.pb.go</p>
</blockquote>
<h2 id="3-1-构造csi-client">3.1. 构造csi-client</h2>
<h3 id="3-1-1-构造grpcclient">3.1.1. 构造grpcClient</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Provisioner will stay in Init until driver opens csi socket, once it&#39;s done
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// controller will exit this loop and proceed normally.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">socketDown</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000">grpcClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConn</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">socketDown</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">csiEndpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connectionTimeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">socketDown</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过连接<code>csi socket</code>，连接成功才构造可用的<code>grpcClient</code>。</p>
<h3 id="3-1-2-构造csi-client">3.1.2. 构造csi-client</h3>
<p>通过<code>grpcClient</code>构造<code>csi-client</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create the provisioner: it implements the Provisioner interface expected by
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">csiProvisioner</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCSIProvisioner</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">csiAPIClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">csiEndpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connectionTimeout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">identity</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">volumeNamePrefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">volumeNameUUIDLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">snapClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>NewCSIProvisioner</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewCSIProvisioner creates new CSI provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewCSIProvisioner</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">csiAPIClient</span> <span style="color:#000">csiclientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">csiEndpoint</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">connectionTimeout</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">identity</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeNamePrefix</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeNameUUIDLength</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">grpcClient</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConn</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">snapshotClient</span> <span style="color:#000">snapclientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Provisioner</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">csiClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisioner</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">csiProvisioner</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">csiAPIClient</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">csiAPIClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">snapshotClient</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">snapshotClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">connectionTimeout</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">identity</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">identity</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">volumeNamePrefix</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">volumeNamePrefix</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">volumeNameUUIDLength</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">volumeNameUUIDLength</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong><a href="https://github.com/container-storage-interface/spec/blob/master/lib/go/csi/v0/csi.pb.go#L4353">NewControllerClient</a></strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">csiClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">controllerClient</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConn</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewControllerClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ControllerClient</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">controllerClient</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">cc</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-csiclient-createvolume">3.2. csiClient.CreateVolume</h2>
<p><code>csi provisoner</code>中调用<code>csiClient.CreateVolume</code>代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backoff</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backoffDuration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Factor</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backoffFactor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Steps</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backoffSteps</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExponentialBackoff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rep</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// CreateVolume has finished successfully
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FromError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">codes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeadlineExceeded</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// CreateVolume timed out, give it another chance to complete
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CreateVolume timeout: %s has expired, operation will be retried&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// CreateVolume failed , no reason to retry, bailing from ExponentialBackoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><p><strong>CreateVolumeRequest的构造：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create a CSI CreateVolumeRequest and Response
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateVolumeRequest</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">VolumeCapabilities</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">volumeCaps</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">CapacityRange</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CapacityRange</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">RequiredBytes</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volSizeBytes</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumeContentSource</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">volumeContentSource</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AccessibilityRequirements</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">requirements</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerCreateSecrets</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">provisionerCredentials</span>
</span></span></code></pre></div><p><strong>具体的<code>Create</code>实现方法如下：</strong></p>
<blockquote>
<p>其中<code>csiClient</code>是个接口类型</p>
</blockquote>
<p>具体代码参考<a href="https://github.com/container-storage-interface/spec/blob/master/lib/go/csi/v0/csi.pb.go#L4357">controllerClient.CreateVolume</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controllerClient</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">CreateVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">in</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CreateVolumeRequest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CallOption</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CreateVolumeResponse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">CreateVolumeResponse</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Invoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/csi.v0.Controller/CreateVolume&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">in</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-csiclient-deletevolume">3.3. csiClient.DeleteVolume</h2>
<p><code>csi provisoner</code>中调用<code>csiClient.DeleteVolume</code>代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">csiProvisioner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolumeRequest</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">VolumeId</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">volumeId</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// get secrets if StorageClass specifies it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>DeleteVolumeRequest的构造：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolumeRequest</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">VolumeId</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">volumeId</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerDeleteSecrets</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">credentials</span>
</span></span></code></pre></div><p>将构造的<code>DeleteVolumeRequest</code>传给<code>DeleteVolume</code>方法。</p>
<p><strong>具体的<code>Delete</code>实现方法如下：</strong></p>
<p>具体代码参考：<a href="https://github.com/container-storage-interface/spec/blob/master/lib/go/csi/v0/csi.pb.go#L4366">controllerClient.DeleteVolume</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controllerClient</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">DeleteVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">in</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeleteVolumeRequest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CallOption</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeleteVolumeResponse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DeleteVolumeResponse</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Invoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/csi.v0.Controller/DeleteVolume&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">in</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-provisioncontroller-run-https-github-com-kubernetes-incubator-external-storage-blob-master-lib-controller-controller-go-l565">4. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L565">ProvisionController.Run</a></h1>
<p>自定义的<code>provisioner</code>实现了<code>Provisoner接口</code>的<code>Provision</code>和<code>Delete</code>方法，这两个方法主要对后端存储做创建和删除操作，并没有对PV对象进行创建和删除操作。</p>
<p>PV对象的相关操作具体由<code>ProvisionController</code>中的<code>provisionClaimOperation</code>和<code>deleteVolumeOperation</code>具体执行，同时调用了具体<code>provisioner</code>的<code>Provision</code>和<code>Delete</code>两个方法来对存储数据做处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisionController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>这块代码逻辑可参考：<a href="https://www.huweihuang.com/kubernetes-notes/develop/nfs-client-provisioner.html#3-provisioncontroller">nfs-client-provisioner 源码分析</a></p>
<p>参考文章：</p>
<ul>
<li><a href="https://github.com/kubernetes-csi/external-provisioner">https://github.com/kubernetes-csi/external-provisioner</a></li>
<li><a href="https://github.com/container-storage-interface/spec">https://github.com/container-storage-interface/spec</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/storage/container-storage-interface.md">https://github.com/kubernetes/community/blob/master/contributors/design-proposals/storage/container-storage-interface.md</a></li>
<li><a href="https://github.com/container-storage-interface/spec/blob/master/spec.md">https://github.com/container-storage-interface/spec/blob/master/spec.md</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8e67c5a44cf8290f780929adc85773bf">9.3.2 - nfs-client-provisioner源码分析</h1>
    
	<blockquote>
<p>如果要开发一个<code>Dynamic Provisioner</code>，需要使用到<a href="https://github.com/kubernetes-incubator/external-storage/tree/master/lib">the helper library</a>。</p>
</blockquote>
<h1 id="1-dynamic-provisioner">1. Dynamic Provisioner</h1>
<h2 id="1-1-provisioner-interface">1.1. Provisioner Interface</h2>
<p>开发<code>Dynamic Provisioner</code>需要实现<a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/volume.go#L29">Provisioner</a>接口，该接口有两个方法，分别是：</p>
<ul>
<li>Provision：创建存储资源，并且返回一个PV对象。</li>
<li>Delete：移除对应的存储资源，但并没有删除PV对象。</li>
</ul>
<p><a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/volume.go#L29">Provisioner</a> 接口源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Provisioner is an interface that creates templates for PersistentVolumes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and can create the volume as a new resource in the infrastructure provider.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It can also remove the volume it created from the underlying storage
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// provider.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Provisioner</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Provision creates a volume i.e. the storage asset and returns a PV object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// for the volume
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Provision</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">VolumeOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Delete removes the storage asset that was created by Provision backing the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// given PV. Does not delete the PV object itself.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// May return IgnoredError to indicate that the call has been ignored and no
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// action taken.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-2-volumeoptions">1.2. VolumeOptions</h2>
<p><code>Provisioner</code>接口的<code>Provision</code>方法的入参是一个<code>VolumeOptions</code>对象。<code>VolumeOptions</code>对象包含了创建PV对象所需要的信息，例如：PV的回收策略，PV的名字，PV所对应的PVC对象以及PVC的<code>StorageClass</code>对象使用的参数等。</p>
<p><a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/volume.go#L73">VolumeOptions</a> 源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// VolumeOptions contains option information about a volume
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// https://github.com/kubernetes/kubernetes/blob/release-1.4/pkg/volume/plugins.go
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">VolumeOptions</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Reclamation policy for a persistent volume
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">PersistentVolumeReclaimPolicy</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeReclaimPolicy</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// PV.Name of the appropriate PersistentVolume. Used to generate cloud
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// volume name.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">PVName</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// PV mount options. Not validated - mount of the PVs will simply fail if one is invalid.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">MountOptions</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// PVC is reference to the claim that lead to provisioning of a new PV.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Provisioners *must* create a PV that would be matched by this PVC,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// i.e. with required capacity, accessMode, labels matching PVC.Selector and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// so on.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">PVC</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Volume provisioning parameters from StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Parameters</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Node selected by the scheduler for the volume.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">SelectedNode</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Topology constraint parameter from StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">AllowedTopologies</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TopologySelectorTerm</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-3-provisioncontroller">1.3. ProvisionController</h2>
<p><code>ProvisionController</code>是一个给PVC提供PV的控制器，具体执行<code>Provisioner</code>接口的<code>Provision</code>和<code>Delete</code>的方法的所有逻辑。</p>
<h2 id="1-4-开发provisioner的步骤">1.4. 开发provisioner的步骤</h2>
<ol>
<li>写一个<code>provisioner</code>实现<code>Provisioner</code>接口（包含<code>Provision</code>和<code>Delete</code>的方法）。</li>
<li>通过该<code>provisioner</code>构建<code>ProvisionController</code>。</li>
<li>执行<code>ProvisionController</code>的<code>Run</code>方法。</li>
</ol>
<h1 id="2-nfs-client-provisioner">2. NFS Client Provisioner</h1>
<p><code>nfs-client-provisioner</code>是一个<code>automatic provisioner</code>，使用NFS作为存储，自动创建PV和对应的PVC，本身不提供NFS存储，需要外部先有一套NFS存储服务。</p>
<ul>
<li>PV以 <code>${namespace}-${pvcName}-${pvName}</code>的命名格式提供（在NFS服务器上）</li>
<li>PV回收的时候以 <code>archieved-${namespace}-${pvcName}-${pvName}</code> 的命名格式（在NFS服务器上）</li>
</ul>
<p>以下通过<code>nfs-client-provisioner</code>的源码分析来说明开发自定义<code>provisioner</code>整个过程。<code>nfs-client-provisioner</code>的主要代码都在<a href="https://github.com/kubernetes-incubator/external-storage/blob/master/nfs-client/cmd/nfs-client-provisioner/provisioner.go">provisioner.go</a>的文件中。</p>
<blockquote>
<p><code>nfs-client-provisioner</code>源码地址：https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client</p>
</blockquote>
<h2 id="2-1-main函数-https-github-com-kubernetes-incubator-external-storage-blob-master-nfs-client-cmd-nfs-client-provisioner-provisioner-go-l148">2.1. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/nfs-client/cmd/nfs-client-provisioner/provisioner.go#L148">Main函数</a></h2>
<h3 id="2-1-1-读取环境变量">2.1.1. 读取环境变量</h3>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;logtostderr&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NFS_SERVER&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NFS_SERVER not set&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NFS_PATH&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NFS_PATH not set&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisionerName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">provisionerNameKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">provisionerName</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;environment variable %s is not set! Please set it.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">provisionerNameKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>   
</span></span></code></pre></div><p>main函数先获取<code>NFS_SERVER</code>、<code>NFS_PATH</code>、<code>PROVISIONER_NAME</code>三个环境变量的值，因此在部署nfs-client-provisioner的时候，需要将这三个环境变量的值传入。</p>
<ul>
<li><code>NFS_SERVER</code>：NFS服务端的IP地址。</li>
<li><code>NFS_PATH</code>：NFS服务端设置的共享目录</li>
<li><code>PROVISIONER_NAME</code>：provisioner的名字，需要和<code>StorageClass</code>对象中的<code>provisioner</code>字段一致。</li>
</ul>
<p>例如<code>StorageClass</code>对象的yaml文件如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">storage.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">StorageClass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">managed-nfs-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">provisioner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fuseim.pri/ifs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># or choose another name, must match deployment&#39;s env PROVISIONER_NAME&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">archiveOnDelete</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;false&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># When set to &#34;false&#34; your PVs will not be archived by the provisioner upon deletion of the PVC.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="2-1-2-获取clientset对象">2.1.2. 获取clientset对象</h3>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create an InClusterConfig and use it to create a client for the controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to use to communicate with Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InClusterConfig</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create config: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create client: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过读取对应的k8s的配置，创建<code>clientset</code>对象，用来执行k8s对应的API，其中主要包括对PV和PVC等对象的创建删除等操作。</p>
<h3 id="2-1-3-构造nfsprovisioner对象">2.1.3. 构造nfsProvisioner对象</h3>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The controller needs to know what the server version is because out-of-tree
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// provisioners aren&#39;t officially supported until 1.5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">serverVersion</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Discovery</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ServerVersion</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error getting server version: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">clientNFSProvisioner</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">nfsProvisioner</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">server</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">path</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过<code>clientset</code>、<code>server</code>、<code>path</code>等值构造<code>nfsProvisioner</code>对象，同时还获取了k8s的版本信息，因为provisioners的功能在k8s 1.5及以上版本才支持。</p>
<p><code>nfsProvisioner</code>类型定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">nfsProvisioner</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">server</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">path</span>   <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">_</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Provisioner</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">nfsProvisioner</span><span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></div><p><code>nfsProvisioner</code>是一个自定义的<code>provisioner</code>，用来实现<code>Provisioner</code>的接口，其中的属性除了<code>server</code>、<code>path</code>这两个关于NFS相关的参数，还包含了<code>client</code>，主要用来调用k8s的API。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">_</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Provisioner</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">nfsProvisioner</span><span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></div><p>以上用法用来检测<code>nfsProvisioner</code>是否实现了<code>Provisioner</code>的接口。</p>
<h3 id="2-1-4-构建并运行provisioncontroller">2.1.4. 构建并运行ProvisionController</h3>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start the provision controller which will dynamically provision efs NFS
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PVs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewProvisionController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">provisionerName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clientNFSProvisioner</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">serverVersion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GitVersion</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">pc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>通过<code>nfsProvisioner</code>构造<code>ProvisionController</code>对象并执行<code>Run</code>方法，<code>ProvisionController</code>实现了具体的PV和PVC的相关逻辑，<code>Run</code>方法以常驻进程的方式运行。</p>
<h2 id="2-2-provision-https-github-com-kubernetes-incubator-external-storage-blob-master-nfs-client-cmd-nfs-client-provisioner-provisioner-go-l56-和-delete-https-github-com-kubernetes-incubator-external-storage-blob-master-nfs-client-cmd-nfs-client-provisioner-provisioner-go-l99-方法">2.2. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/nfs-client/cmd/nfs-client-provisioner/provisioner.go#L56">Provision</a>和<a href="https://github.com/kubernetes-incubator/external-storage/blob/master/nfs-client/cmd/nfs-client-provisioner/provisioner.go#L99">Delete</a>方法</h2>
<h3 id="2-2-1-provision方法">2.2.1. Provision方法</h3>
<blockquote>
<p><code>nfsProvisioner</code>的<code>Provision</code>方法具体源码参考：https://github.com/kubernetes-incubator/external-storage/blob/master/nfs-client/cmd/nfs-client-provisioner/provisioner.go#L56</p>
</blockquote>
<p><code>Provision</code>方法用来创建存储资源，并且返回一个<code>PV</code>对象。其中入参是<code>VolumeOptions</code>，用来指定<code>PV</code>对象的相关属性。</p>
<p><strong>1、构建PV和PVC的名称</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nfsProvisioner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Provision</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumeOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Selector</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;claim Selector is not supported&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;nfs provisioner: VolumeOptions %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pvcNamespace</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pvcName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pvName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">pvcNamespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvcName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVName</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#4e9a06">&#34;-&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fullPath</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mountPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;creating path %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fullPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fullPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0777</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unable to create directory to provision new pv: &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Chmod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fullPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0777</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>通过<code>VolumeOptions</code>的入参，构建PV和PVC的名称，以及创建路径path。</p>
<p><strong>2、构造PV对象</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pv</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeSpec</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">PersistentVolumeReclaimPolicy</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeReclaimPolicy</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AccessModes</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AccessModes</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MountOptions</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MountOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Capacity</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceList</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceStorage</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Resources</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Requests</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceStorage</span><span style="color:#000;font-weight:bold">)],</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">PersistentVolumeSource</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeSource</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">NFS</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NFSVolumeSource</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Server</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Path</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">ReadOnly</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pv</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span></code></pre></div><p>综上可以看出，<code>Provision</code>方法只是通过<code>VolumeOptions</code>参数来构建<code>PV</code>对象，并没有执行具体<code>PV</code>的创建或删除的操作。</p>
<p>不同类型的<code>Provisioner</code>的，一般是<code>PersistentVolumeSource</code>类型和参数不同，例如<code>nfs-provisioner</code>对应的<code>PersistentVolumeSource</code>为<code>NFS</code>，并且需要传入<code>NFS</code>相关的参数：<code>Server</code>，<code>Path</code>等。</p>
<h3 id="2-2-2-delete方法">2.2.2. Delete方法</h3>
<blockquote>
<p><code>nfsProvisioner</code>的<code>delete</code>方法具体源码参考：https://github.com/kubernetes-incubator/external-storage/blob/master/nfs-client/cmd/nfs-client-provisioner/provisioner.go#L99</p>
</blockquote>
<p><strong>1、获取pvName和path等相关参数</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nfsProvisioner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeSource</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NFS</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Path</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pvName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Base</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">oldPath</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mountPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldPath</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;path %s does not exist, deletion skipped&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>通过<code>path</code>和<code>pvName</code>生成<code>oldPath</code>，其中<code>oldPath</code>是原先NFS服务器上<code>pod</code>对应的数据持久化存储路径。</p>
<p><strong>2、获取archiveOnDelete参数并删除数据</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Get the storage class for this volume.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">storageClass</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getClassForVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Determine if the &#34;archiveOnDelete&#34; parameter exists.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If it exists and has a falsey value, delete the directory.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Otherwise, archive it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">archiveOnDelete</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">storageClass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;archiveOnDelete&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">archiveBool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseBool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">archiveOnDelete</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">archiveBool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果<code>storageClass</code>对象中指定<code>archiveOnDelete</code>参数并且值为<code>false</code>，则会自动删除<code>oldPath</code>下的所有数据，即<code>pod</code>对应的数据持久化存储数据。</p>
<blockquote>
<p><code>archiveOnDelete</code>字面意思为删除时是否存档，false表示不存档，即删除数据，true表示存档，即重命名路径。</p>
</blockquote>
<p><strong>3、重命名旧数据路径</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">archivePath</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mountPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;archived-&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;archiving path %s to %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">archivePath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Rename</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">archivePath</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>如果<code>storageClass</code>对象中没有指定<code>archiveOnDelete</code>参数或者值为<code>true</code>，表明需要删除时存档，即将<code>oldPath</code>重命名，命名格式为<code>oldPath</code>前面增加<code>archived-</code>的前缀。</p>
<h1 id="3-provisioncontroller-https-github-com-kubernetes-incubator-external-storage-blob-master-lib-controller-controller-go-l82">3. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L82">ProvisionController</a></h1>
<h2 id="3-1-provisioncontroller结构体">3.1. ProvisionController结构体</h2>
<blockquote>
<p>源码具体参考：https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L82</p>
</blockquote>
<p><code>ProvisionController</code>是一个给PVC提供PV的控制器，具体执行<code>Provisioner</code>接口的<code>Provision</code>和<code>Delete</code>的方法的所有逻辑。</p>
<h3 id="3-1-1-入参">3.1.1. 入参</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ProvisionController is a controller that provisions PersistentVolumes for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PersistentVolumeClaims.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ProvisionController</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// The name of the provisioner for which this controller dynamically
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// provisions volumes. The value of annDynamicallyProvisioned and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// annStorageProvisioner to set &amp; watch for, respectively
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">provisionerName</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// The provisioner the controller will use to provision and delete volumes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Presumably this implementer of Provisioner carries its own
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// volume-specific options and such that it needs in order to provision
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// volumes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">provisioner</span> <span style="color:#000">Provisioner</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Kubernetes cluster server version:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// * 1.4: storage classes introduced as beta. Technically out-of-tree dynamic
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// provisioning is not officially supported, though it works
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// * 1.5: storage classes stay in beta. Out-of-tree dynamic provisioning is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// officially supported
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// * 1.6: storage classes enter GA
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kubeVersion</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">utilversion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Version</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>   
</span></span></code></pre></div><p><code>client</code>、<code>provisionerName</code>、<code>provisioner</code>、<code>kubeVersion</code>等属性作为<code>NewProvisionController</code>的入参。</p>
<ul>
<li><code>client</code>：clientset客户端，用来调用k8s的API。</li>
<li><code>provisionerName</code>：provisioner的名字，需要和<code>StorageClass</code>对象中的<code>provisioner</code>字段一致。</li>
<li><code>provisioner</code>：具体的provisioner的实现者，本文为<code>nfsProvisioner</code>。</li>
<li><code>kubeVersion</code>：k8s的版本信息。</li>
</ul>
<h3 id="3-1-2-controller和informer">3.1.2. Controller和Informer</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ProvisionController</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">claimInformer</span>    <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedInformer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">claims</span>           <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">claimController</span>  <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeInformer</span>   <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedInformer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumes</span>          <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeController</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">classInformer</span>    <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedInformer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">classes</span>          <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">classController</span>  <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p><code>ProvisionController</code>结构体中包含了<code>PV</code>、<code>PVC</code>、<code>StorageClass</code>三个对象的<code>Controller</code>、<code>Informer</code>和<code>Store</code>，主要用来执行这三个对象的相关操作。</p>
<ul>
<li>Controller：通用的控制框架</li>
<li>Informer：消息通知器</li>
<li>Store：通用的对象存储接口</li>
</ul>
<h3 id="3-1-3-workqueue">3.1.3. workqueue</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ProvisionController</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">claimQueue</span>  <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimitingInterface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeQueue</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimitingInterface</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p><code>claimQueue</code>和<code>volumeQueue</code>分别是<code>PV</code>和<code>PVC</code>的任务队列。</p>
<h3 id="3-1-4-其他">3.1.4. 其他</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Identity of this controller, generated at creation time and not persisted
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// across restarts. Useful only for debugging, for seeing the source of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// events. controller.provisioner may have its own, different notion of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// identity which may/may not persist across restarts
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">id</span>            <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000">component</span>     <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000">eventRecorder</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventRecorder</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">resyncPeriod</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">exponentialBackOffOnError</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000">threadiness</span>               <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">createProvisionedPVRetryCount</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000">createProvisionedPVInterval</span>   <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">failedProvisionThreshold</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedDeleteThreshold</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The port for metrics server to serve on.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">metricsPort</span> <span style="color:#204a87;font-weight:bold">int32</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The IP address for metrics server to serve on.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">metricsAddress</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The path of metrics endpoint path.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">metricsPath</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Parameters of leaderelection.LeaderElectionConfig.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">leaseDuration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">renewDeadline</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">retryPeriod</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">hasRun</span>     <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000">hasRunLock</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span></code></pre></div><h2 id="3-2-newprovisioncontroller-https-github-com-kubernetes-incubator-external-storage-blob-master-lib-controller-controller-go-l418-方法">3.2. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L418">NewProvisionController</a>方法</h2>
<blockquote>
<p>源码地址：https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L418</p>
</blockquote>
<p><code>NewProvisionController</code>方法主要用来构造<code>ProvisionController</code>。</p>
<h3 id="3-2-1-初始化默认值">3.2.1. 初始化默认值</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewProvisionController creates a new provision controller using
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the given configuration parameters and with private (non-shared) informers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewProvisionController</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisionerName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisioner</span> <span style="color:#000">Provisioner</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeVersion</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProvisionController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProvisionController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ProvisionController</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span>                        <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">provisionerName</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">provisionerName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeVersion</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">utilversion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MustParseSemantic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeVersion</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">id</span><span style="color:#000;font-weight:bold">:</span>                            <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">component</span><span style="color:#000;font-weight:bold">:</span>                     <span style="color:#000">component</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#000">DefaultResyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">exponentialBackOffOnError</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">DefaultExponentialBackOffOnError</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">threadiness</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">DefaultThreadiness</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">createProvisionedPVRetryCount</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">DefaultCreateProvisionedPVRetryCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">createProvisionedPVInterval</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">DefaultCreateProvisionedPVInterval</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">failedProvisionThreshold</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">DefaultFailedProvisionThreshold</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">failedDeleteThreshold</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">DefaultFailedDeleteThreshold</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">leaseDuration</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">DefaultLeaseDuration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">renewDeadline</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">DefaultRenewDeadline</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">retryPeriod</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">DefaultRetryPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metricsPort</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">DefaultMetricsPort</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metricsAddress</span><span style="color:#000;font-weight:bold">:</span>                <span style="color:#000">DefaultMetricsAddress</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metricsPath</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">DefaultMetricsPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">hasRun</span><span style="color:#000;font-weight:bold">:</span>                        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">hasRunLock</span><span style="color:#000;font-weight:bold">:</span>                    <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><h3 id="3-2-2-初始化任务队列">3.2.2. 初始化任务队列</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">ratelimiter</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMaxOfRateLimiter</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewItemExponentialFailureRateLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BucketRateLimiter</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Limiter</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exponentialBackOffOnError</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ratelimiter</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMaxOfRateLimiter</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewItemExponentialFailureRateLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">15</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BucketRateLimiter</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Limiter</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimQueue</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNamedRateLimitingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ratelimiter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;claims&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeQueue</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNamedRateLimitingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ratelimiter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;volumes&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="3-2-3-listwatch">3.2.3. ListWatch</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PVC
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">claimSource</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListWatch</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumeClaims</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceAll</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WatchFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumeClaims</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceAll</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PV
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">volumeSource</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListWatch</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WatchFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">classSource</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListWatch</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StorageClasses</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WatchFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StorageClasses</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>list-watch</code>机制是k8s中用来监听对象变化的核心机制，<code>ListWatch</code>包含<code>ListFunc</code>和<code>WatchFunc</code>两个函数，且不能为空，以上代码分别构造了PV、PVC、StorageClass三个对象的<code>ListWatch</code>结构体。该机制的实现在<code>client-go</code>的<code>cache</code>包中，具体参考：https://godoc.org/k8s.io/client-go/tools/cache。</p>
<p>更多<code>ListWatch</code>代码如下:</p>
<blockquote>
<p>具体参考：https://github.com/kubernetes-incubator/external-storage/blob/89b0aaf6413b249b37834b124fc314ef7b8ee949/vendor/k8s.io/client-go/tools/cache/listwatch.go#L34</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListerWatcher is any object that knows how to perform an initial list and start a watch on a resource.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ListerWatcher</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// List should return a list type object; the Items field will be extracted, and the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// ResourceVersion field will be used to start the watch in the right place.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Watch should begin a watch at the specified version.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListFunc knows how to list resources
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ListFunc</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// WatchFunc knows how to watch resources
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">WatchFunc</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListWatch knows how to list and watch a set of apiserver resources.  It satisfies the ListerWatcher interface.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It is a convenience function for users of NewReflector, etc.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListFunc and WatchFunc must not be nil
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ListWatch</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListFunc</span>  <span style="color:#000">ListFunc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WatchFunc</span> <span style="color:#000">WatchFunc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// DisableChunking requests no chunking for this list watcher.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">DisableChunking</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-2-4-resourceeventhandlerfuncs">3.2.4. ResourceEventHandlerFuncs</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PVC
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">claimHandler</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forgetWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PV
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">volumeHandler</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forgetWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">classHandler</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We don&#39;t need an actual event handler for StorageClasses,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// but we must pass a non-nil one to cache.NewInformer()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>ResourceEventHandlerFuncs</code>是资源事件处理函数，主要用来对k8s资源对象<code>增删改</code>变化的事件进行消息通知，该函数实现了<code>ResourceEventHandler</code>的接口。具体代码逻辑在<code>client-go</code>的cache包中。</p>
<p>更多<code>ResourceEventHandlerFuncs</code>代码可参考：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ResourceEventHandler can handle notifications for events that happen to a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// resource. The events are informational only, so you can&#39;t return an
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * OnAdd is called when an object is added.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * OnUpdate is called when an object is modified. Note that oldObj is the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      last known state of the object-- it is possible that several changes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      were combined together, so you can&#39;t use this to see every single
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      change. OnUpdate is also called when a re-list happens, and it will
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      get called even if nothing changed. This is useful for periodically
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      evaluating or syncing something.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * OnDelete will get the final state of the item if it is known, otherwise
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      it will get an object of type DeletedFinalStateUnknown. This can
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      happen if the watch is closed and misses the delete event and we don&#39;t
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      notice the deletion until the subsequent re-list.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ResourceEventHandler</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OnAdd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OnUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OnDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ResourceEventHandlerFuncs is an adaptor to let you easily specify as many or
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// as few of the notification functions as you want while still implementing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ResourceEventHandler.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ResourceEventHandlerFuncs</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AddFunc</span>    <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateFunc</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeleteFunc</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-2-5-构造store和controller">3.2.5. 构造Store和Controller</h3>
<p><strong>1、PVC</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimInformer</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddEventHandlerWithResyncPeriod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claimHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimController</span> <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetStore</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetController</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimController</span> <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInformer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">claimSource</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaim</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">claimHandler</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>2、PV</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeInformer</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddEventHandlerWithResyncPeriod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volumeHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeController</span> <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetStore</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetController</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeController</span> <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInformer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">volumeSource</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">volumeHandler</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>3、StorageClass</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classInformer</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// no resource event handler needed for StorageClasses
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classController</span> <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetStore</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetController</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classController</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInformer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">classSource</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">versionedClassType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">classHandler</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过<code>cache.NewInformer</code>的方法构造，入参是<code>ListWatch</code>结构体和<code>ResourceEventHandlerFuncs</code>函数等，返回值是<code>Store</code>和<code>Controller</code>。</p>
<p>通过以上各个部分的构造，最后返回一个具体的<code>ProvisionController</code>对象。</p>
<h2 id="3-3-provisioncontroller-run-https-github-com-kubernetes-incubator-external-storage-blob-master-lib-controller-controller-go-l565-方法">3.3. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L565">ProvisionController.Run</a>方法</h2>
<p><code>ProvisionController</code>的<code>Run</code>方法是以常驻进程的方式运行，函数内部再运行其他的controller。</p>
<h3 id="3-3-1-prometheus数据收集">3.3.1. prometheus数据收集</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run starts all of this controller&#39;s control loops
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProvisionController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">run</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metricsPort</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MustRegister</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Collector</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaimProvisionTotal</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaimProvisionFailedTotal</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaimProvisionDurationSeconds</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeDeleteTotal</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeDeleteFailedTotal</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeDeleteDurationSeconds</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metricsPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">promhttp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">address</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">JoinHostPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metricsAddress</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormatInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metricsPort</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting metrics server at %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">address</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Forever</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to listen on %s: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>        
</span></span></code></pre></div><h3 id="3-3-2-controller-run">3.3.2. Controller.Run</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If a SharedInformer has been passed in, this controller should not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// call Run again
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimInformer</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeInformer</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classInformer</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>运行消息通知器Informer。</p>
<h3 id="3-3-3-worker">3.3.3. Worker</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">threadiness</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runClaimWorker</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runVolumeWorker</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>runClaimWorker</code>和<code>runVolumeWorker</code>分别为PVC和PV的worker，这两个的具体执行体分别是<code>processNextClaimWorkItem</code>和<code>processNextVolumeWorkItem</code>。</p>
<p>执行流程如下：</p>
<p><strong>PVC的函数调用流程</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>runClaimWorker→processNextClaimWorkItem→syncClaimHandler→syncClaim→provisionClaimOperation
</span></span></code></pre></div><p><strong>PV的函数调用流程</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>runVolumeWorker→processNextVolumeWorkItem→syncVolumeHandler→syncVolume→deleteVolumeOperation
</span></span></code></pre></div><p>可见最后执行的函数分别是<code>provisionClaimOperation</code>和<code>deleteVolumeOperation</code>。</p>
<h2 id="3-4-operation">3.4. Operation</h2>
<h3 id="3-4-1-provisionclaimoperation-https-github-com-kubernetes-incubator-external-storage-blob-master-lib-controller-controller-go-l923">3.4.1. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L923">provisionClaimOperation</a></h3>
<p>1、<code>provisionClaimOperation</code>入参是PVC，通过PVC获得PV对象，并判断PV对象是否存在，如果存在则退出后续操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// provisionClaimOperation attempts to provision a volume for the given claim.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Returns error, which indicates whether provisioning should be retried
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// (requeue the claim) or not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProvisionController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">provisionClaimOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaim</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Most code here is identical to that found in controller.go of kube&#39;s PV controller...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">claimClass</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">helper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPersistentVolumeClaimClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">operation</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;provision %q class %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">claimToClaimKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">claimClass</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;started&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">//  A previous doProvisionClaim may just have finished while we were waiting for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  the locks. Check that PV (with deterministic name) hasn&#39;t been provisioned
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  yet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">pvName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getProvisionedVolumeNameForClaim</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Volume has been already provisioned, nothing to do.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;persistentvolume %q already exists, skipping&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>2、获取StorageClass对象中的<code>Provisioner</code>和<code>ReclaimPolicy</code>参数，如果<code>provisionerName</code>和<code>StorageClass</code>对象中的<code>provisioner</code>字段不一致则报错并退出执行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">parameters</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getStorageClassFields</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claimClass</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error getting claim&#39;s StorageClass&#39;s fields: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">provisioner</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">provisionerName</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// class.Provisioner has either changed since shouldProvision() or
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// annDynamicallyProvisioned contains different provisioner than
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// class.Provisioner.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unknown provisioner %q requested in claim&#39;s StorageClass&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Check if this provisioner can provision this claim.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">canProvision</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ProvisioningFailed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;failed to provision volume: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">reclaimPolicy</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeReclaimDelete</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeVersion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AtLeast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">utilversion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MustParseSemantic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;v1.8.0&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">reclaimPolicy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fetchReclaimPolicy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claimClass</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>3、执行具体的<code>provisioner.Provision</code>方法，构建PV对象，例如本文中的<code>provisioner</code>是<code>nfs-provisioner</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">VolumeOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PersistentVolumeReclaimPolicy</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">reclaimPolicy</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PVName</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">claim</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MountOptions</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">mountOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">parameters</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">SelectedNode</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">selectedNode</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AllowedTopologies</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">allowedTopologies</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Provisioning&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;External provisioner is provisioning volume for claim %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">claimToClaimKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Provision</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ierr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">IgnoredError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Provision ignored, do nothing and hope another provisioner will provision it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;volume provision ignored: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ierr</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to provision volume with StorageClass %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">claimClass</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ProvisioningFailed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>4、创建k8s的PV对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Try to create the PV object several times
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createProvisionedPVRetryCount</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;trying to save persistentvvolume %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">apierrs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsAlreadyExists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Save succeeded.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;persistentvolume %q already exists, reusing&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;persistentvolume %q saved&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Save failed, try again after a while.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;failed to save persistentvolume %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createProvisionedPVInterval</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>5、创建PV失败，清理存储资源。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Save failed. Now we have a storage asset outside of Kubernetes,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// but we don&#39;t have appropriate PV object for it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Emit some event here and try to delete the storage asset several
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// times.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createProvisionedPVRetryCount</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Delete succeeded
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cleaning volume %q succeeded&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Delete failed, try again after a while.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;failed to clean volume %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createProvisionedPVInterval</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Delete failed several times. There is an orphaned volume and there
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// is nothing we can do about it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">strerr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error cleaning provisioned volume for claim %s: %v. Please delete manually.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">claimToClaimKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerr</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ProvisioningCleanupFailed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果创建成功，则打印成功的日志，并返回<code>nil</code>。</p>
<h3 id="3-4-2-deletevolumeoperation-https-github-com-kubernetes-incubator-external-storage-blob-master-lib-controller-controller-go-l1096">3.4.2. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L1096">deleteVolumeOperation</a></h3>
<p>1、<code>deleteVolumeOperation</code>入参是PV，先获得PV对象，并判断是否需要删除。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// deleteVolumeOperation attempts to delete the volume backing the given
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// volume. Returns error, which indicates whether deletion should be retried
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// (requeue the volume) or not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProvisionController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">deleteVolumeOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// This method may have been waiting for a volume lock for some time.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Our check does not have to be as sophisticated as PV controller&#39;s, we can
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// trust that the PV controller has set the PV to Released/Failed and it&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// ours to delete
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">newVolume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shouldDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newVolume</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;persistentvolume no longer needs deletion, skipping&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>2、调用具体的<code>provisioner</code>的<code>Delete</code>方法，例如，如果是nfs-provisioner，则是调用nfs-provisioner的Delete方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ierr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">IgnoredError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Delete ignored, do nothing and hope another provisioner will delete it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;volume deletion ignored: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ierr</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Delete failed, emit an event.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;volume deletion failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;VolumeFailedDelete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>3、删除k8s中的PV对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Delete the volume
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Oops, could not delete the volume and therefore the controller will
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// try to delete the volume again on next update.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;failed to delete persistentvolume: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-总结">4. 总结</h1>
<ol>
<li><code>Provisioner</code>接口包含<code>Provision</code>和<code>Delete</code>两个方法，自定义的<code>provisioner</code>需要实现这两个方法，这两个方法只是处理了跟存储类型相关的事项，并没有针对<code>PV</code>、<code>PVC</code>对象的增删等操作。</li>
<li><code>Provision</code>方法主要用来构造PV对象，不同类型的<code>Provisioner</code>的，一般是<code>PersistentVolumeSource</code>类型和参数不同，例如<code>nfs-provisioner</code>对应的<code>PersistentVolumeSource</code>为<code>NFS</code>，并且需要传入<code>NFS</code>相关的参数：<code>Server</code>，<code>Path</code>等。</li>
<li><code>Delete</code>方法主要针对对应的存储类型，做数据存档（备份）或删除的处理。</li>
<li><code>StorageClass</code>对象需要单独创建，用来指定具体的<code>provisioner</code>来执行相关逻辑。</li>
<li><code>provisionClaimOperation</code>和<code>deleteVolumeOperation</code>具体执行了k8s中<code>PV</code>对象的创建和删除操作，同时调用了具体<code>provisioner</code>的<code>Provision</code>和<code>Delete</code>两个方法来对存储数据做处理。</li>
</ol>
<p>参考文章</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/docs/demo/hostpath-provisioner">https://github.com/kubernetes-incubator/external-storage/tree/master/docs/demo/hostpath-provisioner</a></li>
<li><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client">https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client</a></li>
<li><a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go">https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go</a></li>
<li><a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/volume.go">https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/volume.go</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7b4726c5697dc81fca76b5397c272027">9.4 - k8s社区开发指南</h1>
    
	<h1 id="1-社区说明">1. 社区说明</h1>
<h2 id="1-1-community-membership">1.1. Community membership</h2>
<table>
<thead>
<tr>
<th>Role</th>
<th>Responsibilities</th>
<th>Requirements</th>
<th>Defined by</th>
</tr>
</thead>
<tbody>
<tr>
<td>Member</td>
<td>Active contributor in the community</td>
<td>Sponsored by 2 reviewers and multiple contributions to the project</td>
<td>Kubernetes GitHub org member</td>
</tr>
<tr>
<td>Reviewer</td>
<td>Review contributions from other members</td>
<td>History of review and authorship in a subproject</td>
<td><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/owners.md">OWNERS</a> file reviewer entry</td>
</tr>
<tr>
<td>Approver</td>
<td>Contributions acceptance approval</td>
<td>Highly experienced active reviewer and contributor to a subproject</td>
<td><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/owners.md">OWNERS</a> file approver entry</td>
</tr>
<tr>
<td>Subproject owner</td>
<td>Set direction and priorities for a subproject</td>
<td>Demonstrated responsibility and excellent technical judgement for the subproject</td>
<td><a href="https://github.com/kubernetes/community/blob/master/sigs.yaml">sigs.yaml</a> subproject <a href="https://github.com/kubernetes/community/blob/master/contributors/guide/owners.md">OWNERS</a> file <em>owners</em> entry</td>
</tr>
</tbody>
</table>
<h2 id="1-2-社区活动日历">1.2. 社区活动日历</h2>
<p><a href="https://www.kubernetes.dev/resources/calendar/">Community Calendar | Kubernetes Contributors</a></p>
<h2 id="1-3-加入k8s-slack">1.3. 加入k8s slack</h2>
<p>点击 <a href="https://communityinviter.com/apps/kubernetes/community">https://communityinviter.com/apps/kubernetes/community</a></p>
<h2 id="1-4-特别兴趣小组-sig">1.4. 特别兴趣小组（SIG）</h2>
<p>列表： <a href="https://github.com/kubernetes/community/blob/master/sig-list.md">https://github.com/kubernetes/community/blob/master/sig-list.md</a></p>
<h1 id="2-编译k8s仓库">2. 编译k8s仓库</h1>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/2c6c4566eff972d6c1320b5f8ad795f88c822d09/build/README.md">Building Kubernetes</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/development.md#building-kubernetes">https://github.com/kubernetes/community/blob/master/contributors/devel/development.md#building-kubernetes</a></li>
</ul>
<h2 id="2-1-编译二进制">2.1. 编译二进制</h2>
<h3 id="2-1-1-基于docker构建容器编译">2.1.1. 基于docker构建容器编译。</h3>
<blockquote>
<p>该方式为官方镜像及二进制文件的构建方式。</p>
</blockquote>
<p>构建镜像(大小：5.97GB)为： kube-build:build-8faa8d3cb7-5-v1.27.0-go1.20.6-bullseye.0</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/kubernetes/kubernetes.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> kubernetes
</span></span><span style="display:flex;"><span>build/run.sh make <span style="color:#8f5902;font-style:italic"># 构建全部</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#指定模块构建</span>
</span></span><span style="display:flex;"><span>build/run.sh make kubeadm
</span></span></code></pre></div><p>输出如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># build/run.sh make</span>
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:39:11<span style="color:#ce5c00;font-weight:bold">]</span> Verifying Prerequisites....
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:39:16<span style="color:#ce5c00;font-weight:bold">]</span> Building Docker image kube-build:build-8faa8d3cb7-5-v1.27.0-go1.20.6-bullseye.0
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:40:49<span style="color:#ce5c00;font-weight:bold">]</span> Creating data container kube-build-data-8faa8d3cb7-5-v1.27.0-go1.20.6-bullseye.0
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:40:50<span style="color:#ce5c00;font-weight:bold">]</span> Syncing sources to container
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:40:58<span style="color:#ce5c00;font-weight:bold">]</span> Output from this container will be rsynced out upon completion. Set <span style="color:#000">KUBE_RUN_COPY_OUTPUT</span><span style="color:#ce5c00;font-weight:bold">=</span>n to disable.
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:40:58<span style="color:#ce5c00;font-weight:bold">]</span> Running build command...
</span></span><span style="display:flex;"><span>go: downloading go.uber.org/automaxprocs v1.5.2
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:41:04<span style="color:#ce5c00;font-weight:bold">]</span> Setting GOMAXPROCS: <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>Go version: go version go1.20.6 linux/amd64
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:41:04<span style="color:#ce5c00;font-weight:bold">]</span> Building go targets <span style="color:#204a87;font-weight:bold">for</span> linux/amd64
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kube-proxy <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kube-apiserver <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kube-controller-manager <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kubelet <span style="color:#ce5c00;font-weight:bold">(</span>non-static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kubeadm <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kube-scheduler <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/component-base/logs/kube-log-runner <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kube-aggregator <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/apiextensions-apiserver <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cluster/gce/gci/mounter <span style="color:#ce5c00;font-weight:bold">(</span>non-static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kubectl <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kubectl-convert <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    github.com/onsi/ginkgo/v2/ginkgo <span style="color:#ce5c00;font-weight:bold">(</span>non-static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/test/e2e/e2e.test <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">test</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/test/conformance/image/go-runner <span style="color:#ce5c00;font-weight:bold">(</span>non-static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kubemark <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    github.com/onsi/ginkgo/v2/ginkgo <span style="color:#ce5c00;font-weight:bold">(</span>non-static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/test/e2e_node/e2e_node.test <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">test</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Env <span style="color:#204a87;font-weight:bold">for</span> linux/amd64: <span style="color:#000">GOOS</span><span style="color:#ce5c00;font-weight:bold">=</span>linux <span style="color:#000">GOARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>amd64 <span style="color:#000">GOROOT</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/go <span style="color:#000">CGO_ENABLED</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">CC</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>Coverage is disabled.
</span></span><span style="display:flex;"><span>Coverage is disabled.
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:48:17<span style="color:#ce5c00;font-weight:bold">]</span> Placing binaries
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:48:25<span style="color:#ce5c00;font-weight:bold">]</span> Syncing out of container
</span></span></code></pre></div><p>产物文件在<code>_output</code>目录上。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubernetes/_output# tree
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- dockerized
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- bin
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- linux
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>       <span style="color:#4e9a06">`</span>-- amd64
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- apiextensions-apiserver
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- e2e_node.test
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- e2e.test
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- ginkgo
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- go-runner
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kubeadm
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kube-aggregator
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kube-apiserver
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kube-controller-manager
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kubectl
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kubectl-convert
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kubelet
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kube-log-runner
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kubemark
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kube-proxy
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kube-scheduler
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- mounter
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#4e9a06">`</span>-- ncpu
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- go
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">`</span>-- images
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">`</span>-- kube-build:build-8faa8d3cb7-5-v1.27.0-go1.20.6-bullseye.0
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">|</span>-- Dockerfile
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">|</span>-- localtime
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">|</span>-- rsyncd.password
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">`</span>-- rsyncd.sh
</span></span></code></pre></div><h3 id="2-1-2-基于构建机环境编译">2.1.2. 基于构建机环境编译</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/kubernetes/kubernetes.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> kubernetes
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 构建全部二进制</span>
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 构建指定二进制</span>
</span></span><span style="display:flex;"><span>make <span style="color:#000">WHAT</span><span style="color:#ce5c00;font-weight:bold">=</span>cmd/kubeadm
</span></span></code></pre></div><p>输出如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># make WHAT=cmd/kubeadm</span>
</span></span><span style="display:flex;"><span>go version go1.20.6 linux/amd64
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 19:30:55<span style="color:#ce5c00;font-weight:bold">]</span> Setting GOMAXPROCS: <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 19:30:56<span style="color:#ce5c00;font-weight:bold">]</span> Building go targets <span style="color:#204a87;font-weight:bold">for</span> linux/amd64
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kubeadm <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-2-编译镜像">2.2. 编译镜像</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> kubernetes
</span></span><span style="display:flex;"><span>make quick-release
</span></span></code></pre></div><h1 id="3-如何给k8s提交pr">3. 如何给k8s提交PR</h1>
<p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/pull-requests.md">https://github.com/kubernetes/community/blob/master/contributors/guide/pull-requests.md</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/first-contribution.md">https://github.com/kubernetes/community/blob/master/contributors/guide/first-contribution.md</a></p>
</li>
<li>
<p><a href="https://go.k8s.io/bot-commands">Here is the bot commands documentation</a>.</p>
</li>
<li>
<p> <a href="https://git.k8s.io/community/contributors/devel/sig-testing/testing.md">testing guide</a></p>
</li>
</ul>
<p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes/community/">https://github.com/kubernetes/community/</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/community/tree/master/contributors/guide">https://github.com/kubernetes/community/tree/master/contributors/guide</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/first-contribution.md">https://github.com/kubernetes/community/blob/master/contributors/guide/first-contribution.md</a></p>
</li>
<li>
<p> <a href="https://go.k8s.io/good-first-issue">issues labeled as a good first issue</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e5b0b10d7e44efa0120c5bdefe84fea4">10 - 问题排查</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-5e242ea47c9c787791d59cd163945da5">10.1 - 节点问题</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-9266a42ddd092ba43bf3d72f0dce8cad">10.1.1 - keycreate permission denied</h1>
    
	<h1 id="问题描述">问题描述</h1>
<pre tabindex="0"><code>write /proc/self/attr/keycreate: permission denied
</code></pre><p>具体报错：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kuberuntime_manager.go:758<span style="color:#ce5c00;font-weight:bold">]</span> createPodSandbox <span style="color:#204a87;font-weight:bold">for</span> pod <span style="color:#4e9a06">&#34;ecc-hostpath-provisioner-8jbhf_kube-system(b8050fd3-4ffe-11eb-a82e-c6090b53405b)&#34;</span> failed: rpc error: <span style="color:#000">code</span> <span style="color:#ce5c00;font-weight:bold">=</span> Unknown <span style="color:#000">desc</span> <span style="color:#ce5c00;font-weight:bold">=</span> failed to start sandbox container <span style="color:#204a87;font-weight:bold">for</span> pod <span style="color:#4e9a06">&#34;ecc-hostpath-provisioner-8jbhf&#34;</span>: Error response from daemon: OCI runtime create failed: container_linux.go:349: starting container process caused <span style="color:#4e9a06">&#34;process_linux.go:449: container init caused \&#34;write /proc/self/attr/keycreate: permission denied\&#34;&#34;</span>: unknown
</span></span></code></pre></div><h1 id="解决办法">解决办法</h1>
<p>SELINUX未设置成disabled</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将SELINUX设置成disabled</span>
</span></span><span style="display:flex;"><span>setenforce <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#8f5902;font-style:italic"># 临时生效</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 永久生效，但需重启，配合上述命令可以不用立即重启</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#4e9a06">&#34;s/SELINUX=enforcing/SELINUX=disabled/g&#34;</span> /etc/selinux/config
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看SELinux状态</span>
</span></span><span style="display:flex;"><span>$ /usr/sbin/sestatus -v 
</span></span><span style="display:flex;"><span>SELinux status:                 disabled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ getenforce
</span></span><span style="display:flex;"><span>Disabled
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-97ba76b50b571d95b673a250d703d2c2">10.1.2 - Cgroup不支持pid资源</h1>
    
	<h1 id="问题描述">问题描述</h1>
<p>机器内核版本较低，kubelet启动异常，报错如下：</p>
<pre tabindex="0"><code>Failed to start ContainerManager failed to initialize top level QOS containers: failed to update top level Burstable QOS cgroup : failed to set supported cgroup subsystems for cgroup [kubepods burstable]: Failed to find subsystem mount for required subsystem: pids
</code></pre><h1 id="原因分析">原因分析</h1>
<p>低版本内核的cgroup不支持pids资源的功能，</p>
<pre tabindex="0"><code>cat /proc/cgroups
#subsys_name	hierarchy	num_cgroups	enabled
cpuset	5	6	1
cpu	2	76	1
cpuacct	2	76	1
memory	4	76	1
devices	10	76	1
freezer	7	6	1
net_cls	3	6	1
blkio	8	76	1
perf_event	9	6	1
hugetlb	6	6	1
</code></pre><p>正常机器的cgroup</p>
<pre tabindex="0"><code>root@host:~# cat /proc/cgroups
#subsys_name	hierarchy	num_cgroups	enabled
cpuset	5	17	1
cpu	7	80	1
cpuacct	7	80	1
memory	12	80	1
devices	10	80	1
freezer	2	17	1
net_cls	4	17	1
blkio	8	80	1
perf_event	6	17	1
hugetlb	11	17	1
pids	3	80	1    # 此处支持pids资源
oom	9	1	1
</code></pre><h1 id="解决方案">解决方案</h1>
<p>1、升级内核版本，使得cgroup支持pids资源。</p>
<p>或者</p>
<p>2、将kubelet的启动参数添加 SupportPodPidsLimit=false,SupportNodePidsLimit=false</p>
<pre tabindex="0"><code>vi /etc/systemd/system/kubelet.service

# 添加 kubelet 启动参数 
--feature-gates=... ,SupportPodPidsLimit=false,SupportNodePidsLimit=false \

systemctl daemon-reload &amp;&amp; systemctl restart kubelet.service
</code></pre><p>文档参考：</p>
<ul>
<li>
<p><a href="https://kubernetes.io/zh/blog/2019/04/15/kubernetes-1.14-%E7%A8%B3%E5%AE%9A%E6%80%A7%E6%94%B9%E8%BF%9B%E4%B8%AD%E7%9A%84%E8%BF%9B%E7%A8%8Bid%E9%99%90%E5%88%B6/">Kubernetes 1.14 稳定性改进中的进程ID限制</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/qq_38900565/article/details/100707025">https://blog.csdn.net/qq_38900565/article/details/100707025</a></p>
</li>
<li>
<p><a href="https://adoyle.me/Today-I-Learned/k8s/k8s-deployment.html">https://adoyle.me/Today-I-Learned/k8s/k8s-deployment.html</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-53caa084b28bad6e76e4c0659db83524">10.1.3 - Cgroup子系统无法挂载</h1>
    
	<h1 id="问题描述">问题描述</h1>
<p>内核版本： 5.4.56-200.el7.x86_64</p>
<p>docker报错</p>
<pre tabindex="0"><code>May 13 16:54:26 8b26d7a8 dockerd[44352]: time=&#34;2021-05-13T16:54:26.565235530+08:00&#34; level=warning msg=&#34;failed to load plugin io.containerd.snapshotter.v1.devmapper&#34; error=&#34;devmapper not configured&#34;
May 13 16:54:26 8b26d7a8 dockerd[44352]: time=&#34;2021-05-13T16:54:26.565525512+08:00&#34; level=warning msg=&#34;could not use snapshotter devmapper in metadata plugin&#34; error=&#34;devmapper not configured&#34;
May 13 16:54:26 8b26d7a8 dockerd[44352]: time=&#34;2021-05-13T16:54:26.574734345+08:00&#34; level=warning msg=&#34;Your kernel does not support CPU realtime scheduler&#34;
May 13 16:54:26 8b26d7a8 dockerd[44352]: time=&#34;2021-05-13T16:54:26.574792864+08:00&#34; level=warning msg=&#34;Your kernel does not support cgroup blkio weight&#34;
May 13 16:54:26 8b26d7a8 dockerd[44352]: time=&#34;2021-05-13T16:54:26.574800326+08:00&#34; level=warning msg=&#34;Your kernel does not support cgroup blkio weight_device&#34;
</code></pre><p>kubelet报错</p>
<p><img src="../../images/troubleshooting/cgroup-not-mount.png" alt="kubelet"></p>
<h1 id="解决">解决</h1>
<p>cgroup问题解决：</p>
<p>1、curl <a href="https://pi-ops.oss-cn-hangzhou.aliyuncs.com/scripts/cgroupfs-mount.sh">https://pi-ops.oss-cn-hangzhou.aliyuncs.com/scripts/cgroupfs-mount.sh</a> | bash</p>
<p>2、重启设备即可解决</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-be6ea3f2a598a7462ad23ef96ba1c6c7">10.1.4 - runc-v1.1.3-exec-failed</h1>
    
	<h2 id="问题描述">问题描述</h2>
<p>当使用<code>runc 1.1.3</code>的版本时，如果执行<code>systemctl daemon-reload</code>后，通过exec进入容器则会触发以下错误，无法进入容器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>FATA<span style="color:#ce5c00;font-weight:bold">[</span>0000<span style="color:#ce5c00;font-weight:bold">]</span> execing <span style="color:#204a87">command</span> in container: Internal error occurred: error executing <span style="color:#204a87">command</span> in container: failed to <span style="color:#204a87">exec</span> in container: failed to start <span style="color:#204a87">exec</span> <span style="color:#4e9a06">&#34;33d05b4f71a2da69c8c77cc3f7e61451814eb150edd15d0a3153b57a862126d4&#34;</span>: OCI runtime <span style="color:#204a87">exec</span> failed: <span style="color:#204a87">exec</span> failed: unable to start container process: open /dev/pts/0: operation not permitted: unknown
</span></span></code></pre></div><h2 id="原因">原因</h2>
<p>这个是runc 1.1.3版本起存在的一个bug，runc1.1.2的版本不存在，社区在runc 1.1.4的版本中修复了这个bug。由于 runc v1.1.3 中不再添加 <code>DeviceAllow=char-pts rwm</code> 规则了，当执行 <code>systemctl daemon-reload</code> 后， 会导致重新应用 systemd 的规则，进而导致这条规则的缺失。</p>
<h2 id="解决方案">解决方案</h2>
<p>升级runc到1.1.4的版本，并且所有通过runc1.1.3创建的pod都需要重建才能生效。</p>
<p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/containerd/containerd/issues/7219#issuecomment-1225358826">https://github.com/containerd/containerd/issues/7219#issuecomment-1225358826</a></p>
</li>
<li>
<p><a href="https://github.com/opencontainers/runc/issues/3551">https://github.com/opencontainers/runc/issues/3551</a></p>
</li>
<li>
<p><a href="https://github.com/opencontainers/runc/releases/tag/v1.1.4">Release runc 1.1.4 -- &quot;If you look for perfection, you'll never be content.&quot; · opencontainers/runc · GitHub</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a78e18cade1826f4b4c0178fa69df716">10.1.5 - increase the mlock limit</h1>
    
	<h2 id="问题描述">问题描述</h2>
<p>容器启动报错：increase the mlock limit，原因是ulimit mlock值比较小，需要将ulimit值调大。</p>
<p>报错如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>runtime: mlock of signal stack failed: <span style="color:#0000cf;font-weight:bold">12</span>
</span></span><span style="display:flex;"><span>runtime: increase the mlock limit <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">ulimit</span> -l<span style="color:#ce5c00;font-weight:bold">)</span> or
</span></span><span style="display:flex;"><span>runtime: update your kernel to 5.3.15+, 5.4.2+, or 5.5+
</span></span><span style="display:flex;"><span>fatal error: mlock failed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>runtime stack:
</span></span><span style="display:flex;"><span>runtime.throw<span style="color:#ce5c00;font-weight:bold">(</span>0x1a7729f, 0xc<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    /usr/local/go/src/runtime/panic.go:1112 +0x72
</span></span><span style="display:flex;"><span>runtime.mlockGsignal<span style="color:#ce5c00;font-weight:bold">(</span>0xc000702300<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    /usr/local/go/src/runtime/os_linux_x86.go:72 +0x107
</span></span><span style="display:flex;"><span>runtime.mpreinit<span style="color:#ce5c00;font-weight:bold">(</span>0xc000588380<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    /usr/local/go/src/runtime/os_linux.go:341 +0x78
</span></span><span style="display:flex;"><span>runtime.mcommoninit<span style="color:#ce5c00;font-weight:bold">(</span>0xc000588380<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    /usr/local/go/src/runtime/proc.go:630 +0x108
</span></span><span style="display:flex;"><span>runtime.allocm<span style="color:#ce5c00;font-weight:bold">(</span>0xc000072000, 0x1adcb70, 0x0<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    /usr/local/go/src/runtime/proc.go:1390 +0x14e
</span></span><span style="display:flex;"><span>runtime.newm<span style="color:#ce5c00;font-weight:bold">(</span>0x1adcb70, 0xc000072000<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    /usr/local/go/src/runtime/proc.go:1704 +0x39
</span></span><span style="display:flex;"><span>runtime.startm<span style="color:#ce5c00;font-weight:bold">(</span>0x0, 0xc000267e01<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    /usr/local/go/src/runtime/proc.go:1869 +0x12a
</span></span><span style="display:flex;"><span>runtime.wakep<span style="color:#ce5c00;font-weight:bold">(</span>...<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    /usr/local/go/src/runtime/proc.go:1953
</span></span><span style="display:flex;"><span>runtime.resetspinning<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    /usr/local/go/src/runtime/proc.go:2415 +0x93
</span></span><span style="display:flex;"><span>runtime.schedule<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    /usr/local/go/src/runtime/proc.go:2527 +0x2de
</span></span><span style="display:flex;"><span>runtime.mstart1<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    /usr/local/go/src/runtime/proc.go:1104 +0x8e
</span></span><span style="display:flex;"><span>runtime.mstart<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    /usr/local/go/src/runtime/proc.go:1062 +0x6e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>goroutine <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">[</span>runnable, locked to thread<span style="color:#ce5c00;font-weight:bold">]</span>:
</span></span><span style="display:flex;"><span>github.com/xdg/stringprep.init<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    /root/go/pkg/mod/github.com/xdg/stringprep@v1.0.3/tables.go:443 +0x19087
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>goroutine <span style="color:#0000cf;font-weight:bold">43</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#ce5c00;font-weight:bold">]</span>:
</span></span><span style="display:flex;"><span>go.opencensus.io/stats/view.<span style="color:#ce5c00;font-weight:bold">(</span>*worker<span style="color:#ce5c00;font-weight:bold">)</span>.start<span style="color:#ce5c00;font-weight:bold">(</span>0xc00067e800<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    /root/go/pkg/mod/go.opencensus.io@v0.23.0/stats/view/worker.go:276 +0x100
</span></span><span style="display:flex;"><span>created by go.opencensus.io/stats/view.init.0
</span></span><span style="display:flex;"><span>    /root/go/pkg/mod/go.opencensus.io@v0.23.0/stats/view/worker.go:34 +0x68
</span></span></code></pre></div><h2 id="原因">原因</h2>
<p>宿主机的ulimit值比较小，需要将内存的ulimit值调大。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#204a87">ulimit</span> -l
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">64</span>
</span></span></code></pre></div><h2 id="解决方案">解决方案</h2>
<p>vi /lib/systemd/system/containerd.service。在containerd.service文件中增加<code>LimitMEMLOCK=infinity</code> 参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Unit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Description</span><span style="color:#ce5c00;font-weight:bold">=</span>containerd container runtime
</span></span><span style="display:flex;"><span><span style="color:#000">Documentation</span><span style="color:#ce5c00;font-weight:bold">=</span>https://containerd.io
</span></span><span style="display:flex;"><span><span style="color:#000">After</span><span style="color:#ce5c00;font-weight:bold">=</span>network.target local-fs.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Service<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ExecStartPre</span><span style="color:#ce5c00;font-weight:bold">=</span>-/sbin/modprobe overlay
</span></span><span style="display:flex;"><span><span style="color:#000">ExecStart</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/bin/containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">=</span>notify
</span></span><span style="display:flex;"><span><span style="color:#000">Delegate</span><span style="color:#ce5c00;font-weight:bold">=</span>yes
</span></span><span style="display:flex;"><span><span style="color:#000">KillMode</span><span style="color:#ce5c00;font-weight:bold">=</span>process
</span></span><span style="display:flex;"><span><span style="color:#000">Restart</span><span style="color:#ce5c00;font-weight:bold">=</span>always
</span></span><span style="display:flex;"><span><span style="color:#000">RestartSec</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Having non-zero Limit*s causes performance problems due to accounting overhead</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in the kernel. We recommend using cgroups to do container-local accounting.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LimitMEMLOCK</span><span style="color:#ce5c00;font-weight:bold">=</span>infinity
</span></span><span style="display:flex;"><span><span style="color:#000">LimitNPROC</span><span style="color:#ce5c00;font-weight:bold">=</span>infinity
</span></span><span style="display:flex;"><span><span style="color:#000">LimitCORE</span><span style="color:#ce5c00;font-weight:bold">=</span>infinity
</span></span><span style="display:flex;"><span><span style="color:#000">LimitNOFILE</span><span style="color:#ce5c00;font-weight:bold">=</span>infinity
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Comment TasksMax if your systemd version does not supports it.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Only systemd 226 and above support this version.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TasksMax</span><span style="color:#ce5c00;font-weight:bold">=</span>infinity
</span></span><span style="display:flex;"><span><span style="color:#000">OOMScoreAdjust</span><span style="color:#ce5c00;font-weight:bold">=</span>-999
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Install<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">WantedBy</span><span style="color:#ce5c00;font-weight:bold">=</span>multi-user.target
</span></span></code></pre></div><p>重启containerd</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl restart containerd
</span></span><span style="display:flex;"><span>systemctl status containerd
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6e5d6353511fecf4ee5dd3d2d1c2d36a">10.2 - Pod驱逐</h1>
    
	<h1 id="问题描述">问题描述</h1>
<p>节点Pod被驱逐</p>
<h1 id="原因">原因</h1>
<h2 id="1-查看节点和该节点pod状态">1. 查看节点和该节点pod状态</h2>
<p>查看节点状态为Ready，查看该节点的所有pod，发现存在被驱逐的pod和nvidia-device-plugin为pending</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@host:~$ kgpoallowide <span style="color:#000;font-weight:bold">|</span>grep 192.168.1.1
</span></span><span style="display:flex;"><span>department-56   173e397c-ea35-4aac-85d8-07106e55d7b7   0/1       Evicted             <span style="color:#0000cf;font-weight:bold">0</span>          52d       &lt;none&gt;            192.168.1.1   &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system     nvidia-device-plugin-daemonset-d58d2   0/1       Pending             <span style="color:#0000cf;font-weight:bold">0</span>          1s        &lt;none&gt;            192.168.1.1   &lt;none&gt;
</span></span></code></pre></div><h2 id="2-查看对应节点kubelet的日志">2. 查看对应节点kubelet的日志</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0905</span> 15:42:13.182280   <span style="color:#0000cf;font-weight:bold">23506</span> eviction_manager.go:142<span style="color:#ce5c00;font-weight:bold">]</span> Failed to admit pod rdma-device-plugin-daemonset-8nwb8_kube-system<span style="color:#ce5c00;font-weight:bold">(</span>acc28a85-cfb0-11e9-9729-6c92bf5e2432<span style="color:#ce5c00;font-weight:bold">)</span> - node has conditions: <span style="color:#ce5c00;font-weight:bold">[</span>DiskPressure<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>I0905 15:42:14.827343   <span style="color:#0000cf;font-weight:bold">23506</span> kubelet.go:1836<span style="color:#ce5c00;font-weight:bold">]</span> SyncLoop <span style="color:#ce5c00;font-weight:bold">(</span>ADD, <span style="color:#4e9a06">&#34;api&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#4e9a06">&#34;nvidia-device-plugin-daemonset-88sm6_kube-system(adbd9227-cfb0-11e9-9729-6c92bf5e2432)&#34;</span>
</span></span><span style="display:flex;"><span>W0905 15:42:14.827372   <span style="color:#0000cf;font-weight:bold">23506</span> eviction_manager.go:142<span style="color:#ce5c00;font-weight:bold">]</span> Failed to admit pod nvidia-device-plugin-daemonset-88sm6_kube-system<span style="color:#ce5c00;font-weight:bold">(</span>adbd9227-cfb0-11e9-9729-6c92bf5e2432<span style="color:#ce5c00;font-weight:bold">)</span> - node has conditions: <span style="color:#ce5c00;font-weight:bold">[</span>DiskPressure<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>I0905 15:42:15.722378   <span style="color:#0000cf;font-weight:bold">23506</span> kubelet_node_status.go:607<span style="color:#ce5c00;font-weight:bold">]</span> Update capacity <span style="color:#204a87;font-weight:bold">for</span> nvidia.com/gpu-share to <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>I0905 15:42:16.692488   <span style="color:#0000cf;font-weight:bold">23506</span> kubelet.go:1852<span style="color:#ce5c00;font-weight:bold">]</span> SyncLoop <span style="color:#ce5c00;font-weight:bold">(</span>DELETE, <span style="color:#4e9a06">&#34;api&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#4e9a06">&#34;rdma-device-plugin-daemonset-8nwb8_kube-system(acc28a85-cfb0-11e9-9729-6c92bf5e2432)&#34;</span>
</span></span><span style="display:flex;"><span>W0905 15:42:16.698445   <span style="color:#0000cf;font-weight:bold">23506</span> status_manager.go:489<span style="color:#ce5c00;font-weight:bold">]</span> Failed to delete status <span style="color:#204a87;font-weight:bold">for</span> pod <span style="color:#4e9a06">&#34;rdma-device-plugin-daemonset-8nwb8_kube-system(acc28a85-cfb0-11e9-9729-6c92bf5e2432)&#34;</span>: pod <span style="color:#4e9a06">&#34;rdma-device-plugin-daemonset-8nwb8&#34;</span> not found
</span></span><span style="display:flex;"><span>I0905 15:42:16.698490   <span style="color:#0000cf;font-weight:bold">23506</span> kubelet.go:1846<span style="color:#ce5c00;font-weight:bold">]</span> SyncLoop <span style="color:#ce5c00;font-weight:bold">(</span>REMOVE, <span style="color:#4e9a06">&#34;api&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#4e9a06">&#34;rdma-device-plugin-daemonset-8nwb8_kube-system(acc28a85-cfb0-11e9-9729-6c92bf5e2432)&#34;</span>
</span></span><span style="display:flex;"><span>I0905 15:42:16.699267   <span style="color:#0000cf;font-weight:bold">23506</span> kubelet.go:2040<span style="color:#ce5c00;font-weight:bold">]</span> Failed to delete pod <span style="color:#4e9a06">&#34;rdma-device-plugin-daemonset-8nwb8_kube-system(acc28a85-cfb0-11e9-9729-6c92bf5e2432)&#34;</span>, err: pod not found
</span></span><span style="display:flex;"><span>W0905 15:42:16.777355   <span style="color:#0000cf;font-weight:bold">23506</span> eviction_manager.go:332<span style="color:#ce5c00;font-weight:bold">]</span> eviction manager: attempting to reclaim nodefs
</span></span><span style="display:flex;"><span>I0905 15:42:16.777384   <span style="color:#0000cf;font-weight:bold">23506</span> eviction_manager.go:346<span style="color:#ce5c00;font-weight:bold">]</span> eviction manager: must evict pod<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span> to reclaim nodefs
</span></span><span style="display:flex;"><span>E0905 15:42:16.777390   <span style="color:#0000cf;font-weight:bold">23506</span> eviction_manager.go:357<span style="color:#ce5c00;font-weight:bold">]</span> eviction manager: eviction thresholds have been met, but no pods are active to evict
</span></span></code></pre></div><p>存在关于pod驱逐相关的日志，驱逐的原因为<code>node has conditions: [DiskPressure]</code>。</p>
<h2 id="3-查看磁盘相关信息">3. 查看磁盘相关信息</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@host /<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># df -h</span>
</span></span><span style="display:flex;"><span>Filesystem      Size  Used Avail Use% Mounted on
</span></span><span style="display:flex;"><span>devtmpfs        126G     <span style="color:#0000cf;font-weight:bold">0</span>  126G   0% /dev
</span></span><span style="display:flex;"><span>tmpfs           126G     <span style="color:#0000cf;font-weight:bold">0</span>  126G   0% /dev/shm
</span></span><span style="display:flex;"><span>tmpfs           126G   27M  126G   1% /run
</span></span><span style="display:flex;"><span>tmpfs           126G     <span style="color:#0000cf;font-weight:bold">0</span>  126G   0% /sys/fs/cgroup
</span></span><span style="display:flex;"><span>/dev/sda1        20G   19G     <span style="color:#0000cf;font-weight:bold">0</span> 100% /   <span style="color:#8f5902;font-style:italic"># 根目录磁盘满</span>
</span></span><span style="display:flex;"><span>/dev/nvme1n1    3.0T  191G  2.8T   7% /data2
</span></span><span style="display:flex;"><span>/dev/nvme0n1    3.0T  1.3T  1.7T  44% /data1
</span></span><span style="display:flex;"><span>/dev/sda4       182G   95G   87G  53% /data
</span></span><span style="display:flex;"><span>/dev/sda3        20G  3.8G   15G  20% /usr/local
</span></span><span style="display:flex;"><span>tmpfs            26G     <span style="color:#0000cf;font-weight:bold">0</span>   26G   0% /run/user/0
</span></span></code></pre></div><p>发现根目录的磁盘盘，接着查看哪些文件占用磁盘。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@host ~/kata<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># du -sh ./*</span>
</span></span><span style="display:flex;"><span>1.0M	./log
</span></span><span style="display:flex;"><span>944K	./netlink
</span></span><span style="display:flex;"><span>6.6G	./kernel3
</span></span></code></pre></div><p>/var/log/下存在7G 的日志。清理相关日志和无用文件后，根目录恢复空间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@host /data<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># df -h</span>
</span></span><span style="display:flex;"><span>Filesystem      Size  Used Avail Use% Mounted on
</span></span><span style="display:flex;"><span>devtmpfs        126G     <span style="color:#0000cf;font-weight:bold">0</span>  126G   0% /dev
</span></span><span style="display:flex;"><span>tmpfs           126G     <span style="color:#0000cf;font-weight:bold">0</span>  126G   0% /dev/shm
</span></span><span style="display:flex;"><span>tmpfs           126G   27M  126G   1% /run
</span></span><span style="display:flex;"><span>tmpfs           126G     <span style="color:#0000cf;font-weight:bold">0</span>  126G   0% /sys/fs/cgroup
</span></span><span style="display:flex;"><span>/dev/sda1        20G  5.8G   13G  32% /   <span style="color:#8f5902;font-style:italic"># 根目录正常</span>
</span></span><span style="display:flex;"><span>/dev/nvme1n1    3.0T  191G  2.8T   7% /data2
</span></span></code></pre></div><p>查看节点pod状态，相关plugin的pod恢复正常。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@host:~$ kgpoallowide <span style="color:#000;font-weight:bold">|</span>grep 192.168.1.1
</span></span><span style="display:flex;"><span>kube-system     nvidia-device-plugin-daemonset-h4pjc   1/1       Running             <span style="color:#0000cf;font-weight:bold">0</span>          16m       192.168.1.1   192.168.1.1   &lt;none&gt;
</span></span><span style="display:flex;"><span>kube-system     rdma-device-plugin-daemonset-xlkbv     1/1       Running             <span style="color:#0000cf;font-weight:bold">0</span>          16m       192.168.1.1   192.168.1.1   &lt;none&gt;
</span></span></code></pre></div><h2 id="4-查看kubelet配置">4. 查看kubelet配置</h2>
<p>查看kubelet关于pod驱逐相关的参数配置，可见节点kubelet开启了驱逐机制，正常情况下该配置应该是关闭的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">ExecStart</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/bin/kubelet <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>	...
</span></span><span style="display:flex;"><span>  --eviction-hard<span style="color:#ce5c00;font-weight:bold">=</span>nodefs.available&lt;1% <span style="color:#4e9a06">\
</span></span></span></code></pre></div><h1 id="解决方案">解决方案</h1>
<p>总结以上原因为，kubelet开启了pod驱逐的机制，根目录的磁盘达到100%，pod被驱逐，且无法再正常创建在该节点。</p>
<p>解决方案如下：</p>
<p>1、关闭kubelet的驱逐机制。</p>
<p>2、清除根目录的文件，恢复根目录空间，并后续增加根目录的磁盘监控。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4a6e864a3e311d3029ea0182a946f368">10.3 - 镜像拉取失败问题</h1>
    
	<p>常见镜像拉取问题排查</p>
<h2 id="1-pod状态为errimagepull或imagepullbackoff">1. Pod状态为ErrImagePull或ImagePullBackOff</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker-hub-75d4dfb984-5hggg           0/1     ImagePullBackOff   <span style="color:#0000cf;font-weight:bold">0</span>          14m     192.168.1.30   &lt;node ip&gt;   
</span></span><span style="display:flex;"><span>docker-hub-75d4dfb984-9r57b           0/1     ErrImagePull       <span style="color:#0000cf;font-weight:bold">0</span>          53s     192.168.0.42   &lt;node ip&gt;   
</span></span></code></pre></div><ul>
<li>ErrImagePull：表示pod已经调度到node节点，kubelet调用docker去拉取镜像失败。</li>
<li>ImagePullBackOff：表示kubelet拉取镜像失败后，不断重试去拉取仍然失败。</li>
</ul>
<h2 id="2-查看pod的事件">2. 查看pod的事件</h2>
<p>通过kubectl describe pod 命令查看pod事件，该事件的报错信息在kubelet或docker的日志中也会查看到。</p>
<h3 id="2-1-http-server-gave-http-response-to-https-client">2.1. http: server gave HTTP response to HTTPS client</h3>
<p>如果遇到以下报错，尝试将该镜像仓库添加到docker可信任的镜像仓库配置中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Error getting v2 registry: Get https://docker.com:8080/v2/: http: server gave HTTP response to HTTPS client<span style="color:#4e9a06">&#34;
</span></span></span></code></pre></div><p>具体操作是修改/etc/docker/daemon.json的insecure-registries参数</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#cat /etc/docker/daemon.json</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;insecure-registries&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;docker.com:8080&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-2-no-basic-auth-credentials">2.2. no basic auth credentials</h3>
<p>如果遇到<code>no basic auth credentials</code>报错，说明kubelet调用docker接口去拉取镜像时，镜像仓库的认证信息失败。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  Normal   BackOff    18s               kubelet, 192.168.1.1  Back-off pulling image <span style="color:#4e9a06">&#34;docker.com:8080/public/2048:latest&#34;</span>
</span></span><span style="display:flex;"><span>  Warning  Failed     18s               kubelet, 192.168.1.1  Error: ImagePullBackOff
</span></span><span style="display:flex;"><span>  Normal   Pulling    5s <span style="color:#ce5c00;font-weight:bold">(</span>x2 over 18s<span style="color:#ce5c00;font-weight:bold">)</span>  kubelet, 192.168.1.1  Pulling image <span style="color:#4e9a06">&#34;docker.com:8080/public/2048:latest&#34;</span>
</span></span><span style="display:flex;"><span>  Warning  Failed     5s <span style="color:#ce5c00;font-weight:bold">(</span>x2 over 18s<span style="color:#ce5c00;font-weight:bold">)</span>  kubelet, 192.168.1.1  Failed to pull image <span style="color:#4e9a06">&#34;docker.com:8080/public/2048:latest&#34;</span>: rpc error: <span style="color:#000">code</span> <span style="color:#ce5c00;font-weight:bold">=</span> Unknown <span style="color:#000">desc</span> <span style="color:#ce5c00;font-weight:bold">=</span> Error response from daemon: Get http://docker.com:8080/v2/public/2048/manifests/latest: no basic auth credentials
</span></span><span style="display:flex;"><span>  Warning  Failed     5s <span style="color:#ce5c00;font-weight:bold">(</span>x2 over 18s<span style="color:#ce5c00;font-weight:bold">)</span>  kubelet, 192.168.1.1  Error: ErrImagePull
</span></span></code></pre></div><p>具体操作，在拉取镜像失败的节点上登录该镜像仓库，认证信息会更新到<code> $HOME/.docker/config.json</code>文件中。将该文件拷贝到<code>/var/lib/kubelet/config.json</code>中。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f2cc121604cda28beccb98599cfa50cc">10.4 - PVC Terminating</h1>
    
	<h1 id="问题描述">问题描述</h1>
<pre tabindex="0"><code>pvc terminating
</code></pre><p>pvc在删除时，卡在terminating中。</p>
<h1 id="解决方法">解决方法</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl patch pvc <span style="color:#ce5c00;font-weight:bold">{</span>PVC_NAME<span style="color:#ce5c00;font-weight:bold">}</span> -p <span style="color:#4e9a06">&#39;{&#34;metadata&#34;:{&#34;finalizers&#34;:null}}&#39;</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1fc63b5dc9513028d22327de8b197dcf">10.5 - ConfigMap多行格式</h1>
    
	<h2 id="问题">问题</h2>
<p>configmap出现多行文本无法正常显示换行格式，而是以<code>\n</code>连接文本，查看和编辑时可读性很差。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">config.yaml</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;# log options\nlog_level: \&#34;info\&#34;\nlog_output: \&#34;stderr\&#34;\ncert_file:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    \&#34;/etc/webhook/certs/cert.pem\&#34;\nkey_file: \&#34;/etc/webhook/certs/key.pem\&#34;\nhttp_listen:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    \&#34;:8080\&#34;\nhttps_listen: \&#34;:8443\&#34;\ningress_publish_service: \nenable_profiling:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    true\nkubernetes:\n  kubeconfig: \&#34;\&#34;\n  resync_interval: \&#34;6h\&#34;\n  app_namespaces:\n
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    \ - \&#34;*\&#34;\n  namespace_selector:\n  - \&#34;\&#34;\n  election_id: \&#34;ingress-apisix-leader\&#34;\n
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    \ ingress_class: \&#34;ph-apisix\&#34;\n  ingress_version: \&#34;networking/v1\&#34;\n  watch_endpointslices:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    false\n  apisix_route_version: \&#34;apisix.apache.org/v2beta3\&#34;\n  enable_gateway_api:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    false\napisix:\n  default_cluster_base_url: http://apisix-admin.apisix.svc.cluster.local:9180/apisix/admin\n
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    \ default_cluster_admin_key: \&#34;edd1c9f034335f136f87ad84b625c8f1\&#34;\n  default_cluster_name:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    \&#34;default\&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ConfigMap</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="解决方案">解决方案</h2>
<p>如果要保持多行输入和输出的格式，则需要符合以下情况：</p>
<ul>
<li>文本不要以空格结尾</li>
<li>不要换行前再带个空格</li>
<li>不要在文本中添加不可见特殊字符</li>
</ul>
<p>将文本拷贝并格式化yaml文本。可使用在线格式化工具：<a href="https://verytoolz.com/yaml-formatter.html">YAML在线格式化</a>。</p>
<p>将格式化的文本拷贝到configmap文件，并检查上述三个问题。一般是因以<code>空格结尾</code>导致，搜索空格并去除行末的空格。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">config.yaml</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|-</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    # log options
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    log_level: &#34;info&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    log_output: &#34;stderr&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    cert_file: &#34;/etc/webhook/certs/cert.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    key_file: &#34;/etc/webhook/certs/key.pem&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    http_listen: &#34;:8080&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    https_listen: &#34;:8443&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    ingress_publish_service:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    enable_profiling: true</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://kennylong.io/fix-yaml-multi-line-format/">https://kennylong.io/fix-yaml-multi-line-format/</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cc290a6b08c06fd53ff80f9edd1faff8">11 - Runtime</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-4542a7279531f26869f9880a7bd736f1">11.1 - Runc和Containerd概述</h1>
    
	<blockquote>
<p>本文主要分析OCI，CRI，runc，containerd，cri-containerd，dockershim等组件说明及调用关系。</p>
</blockquote>
<h1 id="1-概述">1. 概述</h1>
<p>各个组件调用关系图如下：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1631845163/article/kubernetes/containerd/runtime.webp" alt="关系图"></p>
<blockquote>
<p>图片来源：https://www.jianshu.com/p/62e71584d1cb</p>
</blockquote>
<h1 id="2-oci-open-container-initiative-https-opencontainers-org-about-overview">2. <a href="https://opencontainers.org/about/overview/">OCI（Open Container Initiative）</a></h1>
<p>OCI（Open Container Initiative）即开放的容器运行时<code>规范</code>，目的在于定义一个容器运行时及镜像的相关标准和规范，其中包括</p>
<ul>
<li>runtime-spec：容器的生命周期管理，具体参考<a href="https://github.com/opencontainers/runtime-spec/blob/master/runtime.md">runtime-spec</a>。</li>
<li>image-spec：镜像的生命周期管理，具体参考<a href="https://github.com/opencontainers/image-spec/blob/main/spec.md">image-spec</a>。</li>
</ul>
<p>实现OCI标准的容器运行时有<code>runc</code>，<code>kata</code>等。</p>
<h1 id="3-runc-https-github-com-opencontainers-runc">3. <a href="https://github.com/opencontainers/runc">RunC</a></h1>
<p><code>runc(run container)</code>是一个基于OCI标准实现的一个轻量级容器运行工具，用来创建和运行容器。而Containerd是用来维持通过runc创建的容器的运行状态。即runc用来创建和运行容器，containerd作为常驻进程用来管理容器。</p>
<p>runc包含libcontainer，包括对namespace和cgroup的调用操作。</p>
<p>命令参数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>To start a new instance of a container:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># runc run [ -b bundle ] &lt;container-id&gt;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   runc <span style="color:#ce5c00;font-weight:bold">[</span>global options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   checkpoint  checkpoint a running container
</span></span><span style="display:flex;"><span>   create      create a container
</span></span><span style="display:flex;"><span>   delete      delete any resources held by the container often used with detached container
</span></span><span style="display:flex;"><span>   events      display container events such as OOM notifications, cpu, memory, and IO usage statistics
</span></span><span style="display:flex;"><span>   <span style="color:#204a87">exec</span>        execute new process inside the container
</span></span><span style="display:flex;"><span>   init        initialize the namespaces and launch the process <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">do</span> not call it outside of runc<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87">kill</span>        <span style="color:#204a87">kill</span> sends the specified signal <span style="color:#ce5c00;font-weight:bold">(</span>default: SIGTERM<span style="color:#ce5c00;font-weight:bold">)</span> to the container<span style="color:#a40000">&#39;</span>s init process
</span></span><span style="display:flex;"><span>   list        lists containers started by runc with the given root
</span></span><span style="display:flex;"><span>   pause       pause suspends all processes inside the container
</span></span><span style="display:flex;"><span>   ps          ps displays the processes running inside a container
</span></span><span style="display:flex;"><span>   restore     restore a container from a previous checkpoint
</span></span><span style="display:flex;"><span>   resume      resumes all processes that have been previously paused
</span></span><span style="display:flex;"><span>   run         create and run a container
</span></span><span style="display:flex;"><span>   spec        create a new specification file
</span></span><span style="display:flex;"><span>   start       executes the user defined process in a created container
</span></span><span style="display:flex;"><span>   state       output the state of a container
</span></span><span style="display:flex;"><span>   update      update container resource constraints
</span></span><span style="display:flex;"><span>   help, h     Shows a list of commands or <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> one <span style="color:#204a87">command</span>    
</span></span></code></pre></div><h1 id="4-containerd-https-github-com-containerd-containerd">4. <a href="https://github.com/containerd/containerd">Containerd</a></h1>
<p><code>containerd（container daemon）</code>是一个daemon进程用来管理和运行容器，可以用来拉取/推送镜像和管理容器的存储和网络。其中可以调用runc来创建和运行容器。</p>
<h2 id="4-1-containerd的架构图">4.1. containerd的架构图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1630634542/article/kubernetes/containerd/containerd-arch.png" alt=""></p>
<h2 id="4-2-docker与containerd-runc的关系图">4.2. docker与containerd、runc的关系图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1631847625/article/kubernetes/containerd/container-ecosystem-docker.drawio.png" alt=""></p>
<p>更具体的调用逻辑：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1631854201/article/kubernetes/containerd/containerd-shim.png" alt=""></p>
<h1 id="5-cri-container-runtime-interface-https-github-com-kubernetes-kubernetes-blob-242a97307b34076d5d8f5bbeb154fa4d97c9ef1d-docs-devel-container-runtime-interface-md">5. CRI（<a href="https://github.com/kubernetes/kubernetes/blob/242a97307b34076d5d8f5bbeb154fa4d97c9ef1d/docs/devel/container-runtime-interface.md">Container Runtime Interface</a> ）</h1>
<p><strong>CRI即容器运行时接口，主要用来定义k8s与容器运行时的API调用</strong>，kubelet通过CRI来调用容器运行时，只要实现了CRI接口的容器运行时就可以对接到k8s的kubelet组件。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1631849764/article/kubernetes/containerd/kubelet-cri.png" alt=""></p>
<h2 id="5-1-docker与k8s调用containerd的关系图">5.1. docker与k8s调用containerd的关系图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1631847625/article/kubernetes/containerd/container-ecosystem.drawio.png" alt=""></p>
<h2 id="5-2-cri-api-https-github-com-kubernetes-cri-api-blob-master-pkg-apis-runtime-v1-api-proto">5.2. <a href="https://github.com/kubernetes/cri-api/blob/master/pkg/apis/runtime/v1/api.proto">cri-api</a></h2>
<h3 id="5-2-1-runtime-service">5.2.1. runtime service</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Runtime service defines the public APIs for remote container runtimes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">service</span> <span style="color:#000">RuntimeService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Version returns the runtime name, runtime version, and runtime API version.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">Version</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">VersionRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">VersionResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// RunPodSandbox creates and starts a pod-level sandbox. Runtimes must ensure
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// the sandbox is in the ready state on success.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">RunPodSandbox</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">RunPodSandboxRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">RunPodSandboxResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// StopPodSandbox stops any running process that is part of the sandbox and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// reclaims network resources (e.g., IP addresses) allocated to the sandbox.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// If there are any running containers in the sandbox, they must be forcibly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// terminated.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// This call is idempotent, and must not return an error if all relevant
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// resources have already been reclaimed. kubelet will call StopPodSandbox
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// at least once before calling RemovePodSandbox. It will also attempt to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// reclaim resources eagerly, as soon as a sandbox is not needed. Hence,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// multiple StopPodSandbox calls are expected.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">StopPodSandbox</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">StopPodSandboxRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">StopPodSandboxResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// RemovePodSandbox removes the sandbox. If there are any running containers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// in the sandbox, they must be forcibly terminated and removed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// This call is idempotent, and must not return an error if the sandbox has
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// already been removed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">RemovePodSandbox</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">RemovePodSandboxRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">RemovePodSandboxResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// PodSandboxStatus returns the status of the PodSandbox. If the PodSandbox is not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// present, returns an error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">PodSandboxStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PodSandboxStatusRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">PodSandboxStatusResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ListPodSandbox returns a list of PodSandboxes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">ListPodSandbox</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ListPodSandboxRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ListPodSandboxResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// CreateContainer creates a new container in specified PodSandbox
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">CreateContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">CreateContainerRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">CreateContainerResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// StartContainer starts the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">StartContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">StartContainerRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">StartContainerResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// StopContainer stops a running container with a grace period (i.e., timeout).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// This call is idempotent, and must not return an error if the container has
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// already been stopped.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// The runtime must forcibly kill the container after the grace period is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// reached.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">StopContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">StopContainerRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">StopContainerResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// RemoveContainer removes the container. If the container is running, the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// container must be forcibly removed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// This call is idempotent, and must not return an error if the container has
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// already been removed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">RemoveContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">RemoveContainerRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">RemoveContainerResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ListContainers lists all containers by filters.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">ListContainers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ListContainersRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ListContainersResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ContainerStatus returns status of the container. If the container is not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// present, returns an error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">ContainerStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ContainerStatusRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ContainerStatusResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// UpdateContainerResources updates ContainerConfig of the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">UpdateContainerResources</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UpdateContainerResourcesRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">UpdateContainerResourcesResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ReopenContainerLog asks runtime to reopen the stdout/stderr log file
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// for the container. This is often called after the log file has been
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// rotated. If the container is not running, container runtime can choose
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// to either create a new log file and return nil, or return an error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Once it returns error, new container log file MUST NOT be created.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">ReopenContainerLog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ReopenContainerLogRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ReopenContainerLogResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ExecSync runs a command in a container synchronously.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">ExecSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ExecSyncRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ExecSyncResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Exec prepares a streaming endpoint to execute a command in the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">Exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ExecRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ExecResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Attach prepares a streaming endpoint to attach to a running container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">Attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AttachRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">AttachResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// PortForward prepares a streaming endpoint to forward ports from a PodSandbox.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">PortForward</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PortForwardRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">PortForwardResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ContainerStats returns stats of the container. If the container does not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// exist, the call returns an error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">ContainerStats</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ContainerStatsRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ContainerStatsResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ListContainerStats returns stats of all running containers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">ListContainerStats</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ListContainerStatsRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ListContainerStatsResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// UpdateRuntimeConfig updates the runtime configuration based on the given request.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">UpdateRuntimeConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UpdateRuntimeConfigRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">UpdateRuntimeConfigResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Status returns the status of the runtime.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">Status</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">StatusRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">StatusResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-2-2-image-service">5.2.2. image service</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ImageService defines the public APIs for managing images.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">service</span> <span style="color:#000">ImageService</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ListImages lists existing images.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">ListImages</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ListImagesRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ListImagesResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ImageStatus returns the status of the image. If the image is not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// present, returns a response with ImageStatusResponse.Image set to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// nil.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">ImageStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ImageStatusRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ImageStatusResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// PullImage pulls an image with authentication config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">PullImage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PullImageRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">PullImageResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// RemoveImage removes the image.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// This call is idempotent, and must not return an error if the image has
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// already been removed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">RemoveImage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">RemoveImageRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">RemoveImageResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ImageFSInfo returns information of the filesystem that is used to store images.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rpc</span> <span style="color:#000">ImageFsInfo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ImageFsInfoRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">returns</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ImageFsInfoResponse</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-3-cri-containerd">5.3. cri-containerd</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1631849203/article/kubernetes/containerd/cri-plugin-architecture.png" alt=""></p>
<h3 id="5-3-1-cri-plugin调用流程">5.3.1. CRI Plugin调用流程</h3>
<ol>
<li>kubelet调用CRI插件，通过CRI Runtime Service接口创建pod</li>
<li>cri通过CNI接口创建和配置pod的network namespace</li>
<li>cri调用containerd创建sandbox container（<a href="https://www.ianlewis.org/en/almighty-pause-container">pause container</a> ）并将容器放入pod的cgroup和namespace中</li>
<li>kubelet调用CRI插件，通过image service接口拉取镜像，接着通过containerd来拉取镜像</li>
<li>kubelet调用CRI插件，通过runtime service接口运行拉取下来的镜像服务，最后通过containerd来运行业务容器，并将容器放入pod的cgroup和namespace中。</li>
</ol>
<blockquote>
<p>具体参考：https://github.com/containerd/cri/blob/release/1.4/docs/architecture.md</p>
</blockquote>
<h3 id="5-3-2-k8s对runtime调用的演进">5.3.2. k8s对runtime调用的演进</h3>
<p>由原来通过dockershim调用docker再调用containerd，直接变成通过cri-containerd调用containerd，从而减少了一层docker调用逻辑。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1631854007/article/kubernetes/containerd/cri-performance.png" alt=""></p>
<blockquote>
<p>具体参考：https://github.com/containerd/cri/blob/release/1.4/docs/proposal.md</p>
</blockquote>
<h2 id="5-4-dockershim-https-github-com-kubernetes-kubernetes-tree-master-pkg-kubelet-dockershim">5.4. <a href="https://github.com/kubernetes/kubernetes/tree/master/pkg/kubelet/dockershim">Dockershim</a></h2>
<p>在旧版本的k8s中，由于docker没有实现CRI接口，因此增加一个Dockershim来实现k8s对docker的调用。（shim：垫片，一般用来表示对第三方组件API调用的适配插件，例如k8s使用Dockershim来实现对docker接口的适配调用）</p>
<h2 id="5-5-cri-o">5.5. CRI-O</h2>
<p>cri-o与containerd类似，用来实现容器的管理，可替换containerd的使用。</p>
<p>参考：</p>
<ul>
<li><a href="https://opencontainers.org/about/overview/">https://opencontainers.org/about/overview/</a></li>
<li><a href="https://github.com/opencontainers/runtime-spec">https://github.com/opencontainers/runtime-spec</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/242a97307b34076d5d8f5bbeb154fa4d97c9ef1d/docs/devel/container-runtime-interface.md">https://github.com/kubernetes/kubernetes/blob/242a97307b34076d5d8f5bbeb154fa4d97c9ef1d/docs/devel/container-runtime-interface.md</a></li>
<li><a href="https://github.com/containerd/containerd/blob/main/docs/cri/architecture.md">https://github.com/containerd/containerd/blob/main/docs/cri/architecture.md</a></li>
<li><a href="https://www.tutorialworks.com/difference-docker-containerd-runc-crio-oci/">https://www.tutorialworks.com/difference-docker-containerd-runc-crio-oci/</a></li>
<li><a href="https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/">https://kubernetes.io/zh/docs/setup/production-environment/container-runtimes/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-939a4f85ffb9827c83d36ce3b932727c">11.2 - Containerd</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-327a4852c169f4c39279a96c5f8eb746">11.2.1 - 安装Containerd</h1>
    
	<h1 id="1-ubuntu安装containerd">1. Ubuntu安装containerd</h1>
<p>以下以Ubuntu为例</p>
<blockquote>
<p>说明：安装containerd与安装docker流程基本一致，差别在于不需要安装docker-ce</p>
<ul>
<li><code>containerd</code>: apt-get install -y containerd.io</li>
<li><code>docker</code>: apt-get install docker-ce docker-ce-cli containerd.io</li>
</ul>
</blockquote>
<h2 id="1-卸载旧版本">1. 卸载旧版本</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> sudo apt-get remove docker docker-engine docker.io containerd runc
</span></span></code></pre></div><p>如果需要删除镜像及容器数据则执行以下命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> sudo rm -rf /var/lib/docker
</span></span><span style="display:flex;"><span> sudo rm -rf /var/lib/containerd
</span></span></code></pre></div><h2 id="2-准备包环境">2. 准备包环境</h2>
<p>1、更新apt，允许使用https。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> sudo apt-get update
</span></span><span style="display:flex;"><span> sudo apt-get install <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    ca-certificates <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    curl <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    gnupg <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    lsb-release
</span></span></code></pre></div><p>2、添加docker官方GPG key。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo mkdir -p /etc/apt/keyrings
</span></span><span style="display:flex;"><span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span style="color:#000;font-weight:bold">|</span> sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
</span></span></code></pre></div><p>3、设置软件仓库源</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">&#34;deb [arch=</span><span style="color:#204a87;font-weight:bold">$(</span>dpkg --print-architecture<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06"> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  </span><span style="color:#204a87;font-weight:bold">$(</span>lsb_release -cs<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06"> stable&#34;</span> <span style="color:#000;font-weight:bold">|</span> sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null
</span></span></code></pre></div><h2 id="3-安装containerd">3. 安装containerd</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装containerd</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>sudo apt-get install -y containerd.io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果是安装docker则执行：</span>
</span></span><span style="display:flex;"><span>sudo apt-get install docker-ce docker-ce-cli containerd.io
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看运行状态</span>
</span></span><span style="display:flex;"><span>systemctl <span style="color:#204a87">enable</span> containerd
</span></span><span style="display:flex;"><span>systemctl status containerd
</span></span></code></pre></div><p>安装指定版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看版本</span>
</span></span><span style="display:flex;"><span>apt-cache madison containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># sudo apt-get install containerd=&lt;VERSION&gt;</span>
</span></span></code></pre></div><h2 id="4-修改配置">4. 修改配置</h2>
<p>在 Linux 上，containerd 的默认 CRI 套接字是 <code>/run/containerd/containerd.sock</code>。</p>
<p>1、生成默认配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>containerd config default &gt; /etc/containerd/config.toml
</span></span></code></pre></div><p>2、修改CgroupDriver为systemd</p>
<p>k8s官方推荐使用systemd类型的CgroupDriver。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>plugins.<span style="color:#4e9a06">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">[</span>plugins.<span style="color:#4e9a06">&#34;io.containerd.grpc.v1.cri&#34;</span>.containerd.runtimes.runc.options<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">SystemdCgroup</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>
</span></span></code></pre></div><p>3、重启containerd</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl restart containerd
</span></span></code></pre></div><h1 id="2-离线二进制安装containerd">2. 离线二进制安装containerd</h1>
<p>把<code>containerd</code>、<code>runc</code>、<code>cni-plugins</code>、<code>nerdctl</code>二进制下载到本地，再上传到对应服务器，解压文件到对应目录，修改containerd配置文件，启动containerd。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ContainerdVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ContainerdVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">ContainerdVersion</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">.6.6</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">RuncVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$2</span>
</span></span><span style="display:flex;"><span><span style="color:#000">RuncVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">RuncVersion</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">.1.3</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">CniVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$3</span>
</span></span><span style="display:flex;"><span><span style="color:#000">CniVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">CniVersion</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">.1.1</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">NerdctlVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$4</span>
</span></span><span style="display:flex;"><span><span style="color:#000">NerdctlVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">NerdctlVersion</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">0</span><span style="color:#000;font-weight:bold">.21.0</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">CrictlVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$5</span>
</span></span><span style="display:flex;"><span><span style="color:#000">CrictlVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">CrictlVersion</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">.24.2</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;--------------install containerd--------------&#34;</span>
</span></span><span style="display:flex;"><span>wget https://github.com/containerd/containerd/releases/download/v<span style="color:#4e9a06">${</span><span style="color:#000">ContainerdVersion</span><span style="color:#4e9a06">}</span>/containerd-<span style="color:#4e9a06">${</span><span style="color:#000">ContainerdVersion</span><span style="color:#4e9a06">}</span>-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar Cxzvf /usr/local containerd-<span style="color:#4e9a06">${</span><span style="color:#000">ContainerdVersion</span><span style="color:#4e9a06">}</span>-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;--------------install containerd service--------------&#34;</span>
</span></span><span style="display:flex;"><span>wget https://raw.githubusercontent.com/containerd/containerd/681aaf68b7dcbe08a51c3372cbb8f813fb4466e0/containerd.service
</span></span><span style="display:flex;"><span>mv containerd.service /lib/systemd/system/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/containerd/
</span></span><span style="display:flex;"><span>containerd config default &gt; /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>sed -i <span style="color:#4e9a06">&#39;s/SystemdCgroup = false/SystemdCgroup = true/&#39;</span> /etc/containerd/config.toml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;--------------install runc--------------&#34;</span>
</span></span><span style="display:flex;"><span>wget https://github.com/opencontainers/runc/releases/download/v<span style="color:#4e9a06">${</span><span style="color:#000">RuncVersion</span><span style="color:#4e9a06">}</span>/runc.amd64
</span></span><span style="display:flex;"><span>chmod +x runc.amd64
</span></span><span style="display:flex;"><span>mv runc.amd64 /usr/local/bin/runc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;--------------install cni plugins--------------&#34;</span>
</span></span><span style="display:flex;"><span>wget https://github.com/containernetworking/plugins/releases/download/v<span style="color:#4e9a06">${</span><span style="color:#000">CniVersion</span><span style="color:#4e9a06">}</span>/cni-plugins-linux-amd64-v<span style="color:#4e9a06">${</span><span style="color:#000">CniVersion</span><span style="color:#4e9a06">}</span>.tgz
</span></span><span style="display:flex;"><span>rm -fr /opt/cni/bin
</span></span><span style="display:flex;"><span>mkdir -p /opt/cni/bin
</span></span><span style="display:flex;"><span>tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v<span style="color:#4e9a06">${</span><span style="color:#000">CniVersion</span><span style="color:#4e9a06">}</span>.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;--------------install nerdctl--------------&#34;</span>
</span></span><span style="display:flex;"><span>wget https://github.com/containerd/nerdctl/releases/download/v<span style="color:#4e9a06">${</span><span style="color:#000">NerdctlVersion</span><span style="color:#4e9a06">}</span>/nerdctl-<span style="color:#4e9a06">${</span><span style="color:#000">NerdctlVersion</span><span style="color:#4e9a06">}</span>-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar Cxzvf /usr/local/bin nerdctl-<span style="color:#4e9a06">${</span><span style="color:#000">NerdctlVersion</span><span style="color:#4e9a06">}</span>-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;--------------install crictl--------------&#34;</span>
</span></span><span style="display:flex;"><span>wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v<span style="color:#4e9a06">${</span><span style="color:#000">CrictlVersion</span><span style="color:#4e9a06">}</span>/crictl-v<span style="color:#4e9a06">${</span><span style="color:#000">CrictlVersion</span><span style="color:#4e9a06">}</span>-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar Cxzvf /usr/local/bin crictl-v<span style="color:#4e9a06">${</span><span style="color:#000">CrictlVersion</span><span style="color:#4e9a06">}</span>-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/crictl.yaml <span style="color:#4e9a06">&lt;&lt; \EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">runtime-endpoint: unix:///run/containerd/containerd.sock
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">image-endpoint: unix:///run/containerd/containerd.sock
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">timeout: 2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">debug: false
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">pull-image-on-create: false
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动containerd服务</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl <span style="color:#204a87">enable</span> contaienrd
</span></span><span style="display:flex;"><span>systemctl restart contaienrd
</span></span></code></pre></div><h1 id="3-containerd配置代理">3. Containerd配置代理</h1>
<p>由于节点到k8s官方仓库网络不通，或者设备处于内网，可以通过配置http_proxy代理的方式来拉取镜像。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vi /lib/systemd/system/containerd.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加代理环境变量</span>
</span></span><span style="display:flex;"><span> <span style="color:#ce5c00;font-weight:bold">[</span>Unit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Description</span><span style="color:#ce5c00;font-weight:bold">=</span>containerd container runtime
</span></span><span style="display:flex;"><span><span style="color:#000">Documentation</span><span style="color:#ce5c00;font-weight:bold">=</span>https://containerd.io
</span></span><span style="display:flex;"><span><span style="color:#000">After</span><span style="color:#ce5c00;font-weight:bold">=</span>network.target local-fs.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Service<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;HTTP_PROXY=http://squid:3128/&#34;</span>   <span style="color:#8f5902;font-style:italic"># 添加环境变量代理</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Environment</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;HTTPS_PROXY=http://squid:3128/&#34;</span>  <span style="color:#8f5902;font-style:italic"># 添加环境变量代理</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ExecStartPre</span><span style="color:#ce5c00;font-weight:bold">=</span>-/sbin/modprobe overlay
</span></span><span style="display:flex;"><span><span style="color:#000">ExecStart</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/bin/containerd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">=</span>notify
</span></span><span style="display:flex;"><span><span style="color:#000">Delegate</span><span style="color:#ce5c00;font-weight:bold">=</span>yes
</span></span><span style="display:flex;"><span><span style="color:#000">KillMode</span><span style="color:#ce5c00;font-weight:bold">=</span>process
</span></span><span style="display:flex;"><span><span style="color:#000">Restart</span><span style="color:#ce5c00;font-weight:bold">=</span>always
</span></span><span style="display:flex;"><span><span style="color:#000">RestartSec</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Having non-zero Limit*s causes performance problems due to accounting overhead</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># in the kernel. We recommend using cgroups to do container-local accounting.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">LimitNPROC</span><span style="color:#ce5c00;font-weight:bold">=</span>infinity
</span></span><span style="display:flex;"><span><span style="color:#000">LimitCORE</span><span style="color:#ce5c00;font-weight:bold">=</span>infinity
</span></span><span style="display:flex;"><span><span style="color:#000">LimitNOFILE</span><span style="color:#ce5c00;font-weight:bold">=</span>infinity
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Comment TasksMax if your systemd version does not supports it.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Only systemd 226 and above support this version.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">TasksMax</span><span style="color:#ce5c00;font-weight:bold">=</span>infinity
</span></span><span style="display:flex;"><span><span style="color:#000">OOMScoreAdjust</span><span style="color:#ce5c00;font-weight:bold">=</span>-999
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Install<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">WantedBy</span><span style="color:#ce5c00;font-weight:bold">=</span>multi-user.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重启服务</span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl restart containerd
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/containerd/containerd">https://github.com/containerd/containerd</a></p>
</li>
<li>
<p><a href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md">https://github.com/containerd/containerd/blob/main/docs/getting-started.md</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd">https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd</a></p>
</li>
<li>
<p><a href="https://github.com/containerd/containerd/blob/main/containerd.service">containerd/containerd.service at main · containerd/containerd · GitHub</a></p>
</li>
<li>
<p><a href="https://github.com/containerd/nerdctl">GitHub - containerd/nerdctl: containerd ctl </a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes-sigs/cri-tools">GitHub - kubernetes-sigs/cri-tools: CLI and validation tools for Kubelet Container Runtime Interface (CRI) .</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ddb2c99e7e7e60a18822203aab640d61">11.2.2 - Containerd命令工具</h1>
    
	<h1 id="crictl">crictl</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">CrictlVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">CrictlVersion</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">CrictlVersion</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">1</span><span style="color:#000;font-weight:bold">.24.2</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;--------------install crictl--------------&#34;</span>
</span></span><span style="display:flex;"><span>wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v<span style="color:#4e9a06">${</span><span style="color:#000">CrictlVersion</span><span style="color:#4e9a06">}</span>/crictl-v<span style="color:#4e9a06">${</span><span style="color:#000">CrictlVersion</span><span style="color:#4e9a06">}</span>-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar Cxzvf /usr/local/bin nerdctl-<span style="color:#4e9a06">${</span><span style="color:#000">NerdctlVersion</span><span style="color:#4e9a06">}</span>-linux-amd64.tar.gz
</span></span></code></pre></div><p>设置配置文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat &gt; /etc/crictl.yaml <span style="color:#4e9a06">&lt;&lt; \EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">runtime-endpoint: unix:///run/containerd/containerd.sock
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">image-endpoint: unix:///run/containerd/containerd.sock
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">timeout: 2
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">debug: false
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">pull-image-on-create: false
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/crictl/">使用 crictl 对 Kubernetes 节点进行调试 | Kubernetes</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.mdCrictlVersion=$%7BCrictlVersion:-1.24.2%7D">https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.mdCrictlVersion=${CrictlVersion:-1.24.2}</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c8cd64aecf7162ea570173434ed6088e">11.2.3 - 移除Dockershim</h1>
    
	<blockquote>
<p>TODO</p>
</blockquote>
<p>参考：</p>
<ul>
<li>
<p><a href="https://kubernetes.io/zh-cn/blog/2022/02/17/dockershim-faq/">更新：移除 Dockershim 的常见问题 | Kubernetes</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/zh-cn/blog/2020/12/02/dont-panic-kubernetes-and-docker/">别慌: Kubernetes 和 Docker | Kubernetes</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/zh-cn/docs/reference/node/topics-on-dockershim-and-cri-compatible-runtimes/">关于 dockershim 移除和使用兼容 CRI 运行时的文章 | Kubernetes</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2221-remove-dockershim">KEP-2221: Removing dockershim from kubelete-dockershim</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/issues/106917">Dockershim removal feedback &amp; issues </a></p>
</li>
<li>
<p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/migrating-from-dockershim/migrate-dockershim-dockerd/">将 Docker Engine 节点从 dockershim 迁移到 cri-dockerd | Kubernetes</a></p>
</li>
<li>
<p><a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/migrating-from-dockershim/find-out-runtime-you-use/">查明节点上所使用的容器运行时 | Kubernetes</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7a1cc3e84a51fcefd1499d526a0d38c1">11.3 - Docker</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-34bb4ac2d1c394f76c16574dd5d3a1ba">11.3.1 - Docker学习笔记</h1>
    
	<h1 id="docker学习笔记">Docker学习笔记</h1>
<p>详见：<a href="https://www.huweihuang.com/docker-notes/">Docker学习笔记</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dd85cfdb2acadbca2d8720874a926b22">11.3.2 - 安装Docker</h1>
    
	<h1 id="1-centos-安装docker">1. CentOS 安装Docker</h1>
<blockquote>
<p>建议使用centos7</p>
</blockquote>
<h2 id="1-1-安装docker">1.1. 安装Docker</h2>
<h3 id="1-1-1-卸载旧版本">1.1.1. 卸载旧版本</h3>
<p>旧版本的Docker命名为<code>docker</code>或<code>docker-engine</code>，如果有安装旧版本，先卸载旧版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo yum remove -y docker <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-client <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-client-latest <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-common <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-latest <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-latest-logrotate <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-logrotate <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-selinux <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-engine-selinux <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>                  docker-engine
</span></span></code></pre></div><h3 id="1-1-2-使用仓库安装">1.1.2. 使用仓库安装</h3>
<p>1、安装yum-utils、device-mapper-persistent-data、lvm2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo yum install -y yum-utils <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  device-mapper-persistent-data <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  lvm2
</span></span></code></pre></div><p>2、添加软件源</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo yum-config-manager <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    --add-repo <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    https://download.docker.com/linux/centos/docker-ce.repo
</span></span></code></pre></div><h3 id="1-1-3-安装docker">1.1.3. 安装Docker</h3>
<p>安装最新版本的Docker CE。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo yum install -y docker-ce 
</span></span></code></pre></div><h3 id="1-1-4-启动docker">1.1.4. 启动Docker</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动Docker</span>
</span></span><span style="display:flex;"><span>$ sudo systemctl start docker
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 运行容器</span>
</span></span><span style="display:flex;"><span>$ sudo docker run hello-world
</span></span></code></pre></div><h2 id="1-2-安装指定版本docker">1.2. 安装指定版本Docker</h2>
<p>1、列出可安装版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ yum list docker-ce --showduplicates <span style="color:#000;font-weight:bold">|</span> sort -r
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>docker-ce.x86_64            18.03.0.ce-1.el7.centos             docker-ce-stable
</span></span></code></pre></div><p>2、安装指定版本</p>
<p>例如：docker-ce-18.03.0.ce</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo yum install docker-ce-&lt;VERSION STRING&gt;
</span></span></code></pre></div><h2 id="1-3-升级docker">1.3. 升级Docker</h2>
<p>依据1.2的方法选择指定版本安装。</p>
<h2 id="1-4-卸载docker">1.4. 卸载Docker</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 卸载Docker</span>
</span></span><span style="display:flex;"><span>$ sudo yum remove docker-ce
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 清理镜像、容器、存储卷等</span>
</span></span><span style="display:flex;"><span>$ sudo rm -rf /var/lib/docker
</span></span></code></pre></div><h1 id="2-ubuntu-安装docker">2. Ubuntu 安装Docker</h1>
<h2 id="2-1-安装docker">2.1. 安装Docker</h2>
<h3 id="2-1-1-卸载旧版本">2.1.1. 卸载旧版本</h3>
<p>旧版本的Docker命名为<code>docker</code>或<code>docker-engine</code>，如果有安装旧版本，先卸载旧版本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt-get remove docker docker-engine docker.io
</span></span></code></pre></div><h3 id="2-1-2-使用仓库安装">2.1.2. 使用仓库安装</h3>
<p>1、升级apt</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt-get update
</span></span></code></pre></div><p>2、允许apt使用https</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt-get install <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    apt-transport-https <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    ca-certificates <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    curl <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    software-properties-common
</span></span></code></pre></div><p>3、添加Docker 官方的GPG密钥</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -fsSL https://download.docker.com/linux/ubuntu/gpg <span style="color:#000;font-weight:bold">|</span> sudo apt-key add -
</span></span></code></pre></div><p>4、添加Docker软件源</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo add-apt-repository <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>   <span style="color:#4e9a06">&#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">   </span><span style="color:#204a87;font-weight:bold">$(</span>lsb_release -cs<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06"> \
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">   stable&#34;</span>
</span></span></code></pre></div><h3 id="2-1-3-安装docker">2.1.3. 安装Docker</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># update</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># install docker</span>
</span></span><span style="display:flex;"><span>sudo apt-get install docker-ce
</span></span></code></pre></div><h3 id="2-1-4-启动docker">2.1.4. 启动Docker</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置为开机启动</span>
</span></span><span style="display:flex;"><span>sudo systemctl <span style="color:#204a87">enable</span> docker
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动docker</span>
</span></span><span style="display:flex;"><span>sudo systemctl start docker
</span></span></code></pre></div><h2 id="2-2-安装指定版本docker">2.2. 安装指定版本Docker</h2>
<p>1、列出仓库的可安装版本，<code>apt-cache madison docker-ce</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># apt-cache madison docker-ce</span>
</span></span><span style="display:flex;"><span> docker-ce <span style="color:#000;font-weight:bold">|</span> 18.06.0~ce~3-0~ubuntu <span style="color:#000;font-weight:bold">|</span> https://download.docker.com/linux/ubuntu bionic/stable amd64 Packages
</span></span><span style="display:flex;"><span> docker-ce <span style="color:#000;font-weight:bold">|</span> 18.03.1~ce~3-0~ubuntu <span style="color:#000;font-weight:bold">|</span> https://download.docker.com/linux/ubuntu bionic/stable amd64 Packages
</span></span></code></pre></div><p>2、指定版本安装</p>
<p>例如：docker-ce=18.03.0~ce-0~ubuntu</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt-get install docker-ce<span style="color:#ce5c00;font-weight:bold">=</span>&lt;VERSION&gt;
</span></span></code></pre></div><h2 id="2-3-升级docker">2.3.  升级Docker</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 更新源</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 依据上述方法，指定版本安装</span>
</span></span></code></pre></div><h2 id="2-4-卸载docker">2.4. 卸载Docker</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 卸载 docker ce</span>
</span></span><span style="display:flex;"><span>sudo apt-get purge docker-ce
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 清理镜像、容器、存储卷等</span>
</span></span><span style="display:flex;"><span>sudo rm -rf /var/lib/docker
</span></span></code></pre></div><h1 id="3-离线rpm包安装docker">3. 离线rpm包安装Docker</h1>
<h2 id="3-1-下载docker-rpm包">3.1. 下载docker rpm包</h2>
<p>rpm包地址：https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/Packages/</p>
<p>下载指定版本的containerd.io、docker-ce、docker-ce-cli</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm
</span></span><span style="display:flex;"><span>wget https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/Packages/docker-ce-18.09.9-3.el7.x86_64.rpm
</span></span><span style="display:flex;"><span>wget https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/Packages/docker-ce-cli-18.09.9-3.el7.x86_64.rpm
</span></span></code></pre></div><p>下载container-selinux</p>
<p>地址：http://mirror.centos.org/centos/7/extras/x86_64/Packages/</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget http://mirror.centos.org/centos/7/extras/x86_64/Packages/container-selinux-2.107-3.el7.noarch.rpm
</span></span></code></pre></div><h2 id="3-2-安装rpm包">3.2. 安装rpm包</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># container-selinux</span>
</span></span><span style="display:flex;"><span>rpm -ivh container-selinux*.rpm
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># containerd.io</span>
</span></span><span style="display:flex;"><span>rpm -ivh containerd.io*.rpm
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># docker-ce</span>
</span></span><span style="display:flex;"><span>rpm -ivh docker-ce*.rpm
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># docker-ce-cli</span>
</span></span><span style="display:flex;"><span>rpm -ivh docker-ce-cli*.rpm
</span></span></code></pre></div><h2 id="3-3-启动docker服务">3.3. 启动docker服务</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动</span>
</span></span><span style="display:flex;"><span>systemctl start docker
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看状态</span>
</span></span><span style="display:flex;"><span>systemctl status docker
</span></span></code></pre></div><p>文章参考：</p>
<ul>
<li>
<p><a href="https://docs.docker.com/install/linux/docker-ce/centos/">https://docs.docker.com/install/linux/docker-ce/centos/</a></p>
</li>
<li>
<p><a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9a9f44020c9279f0a6805428f476a86d">11.3.3 - Docker整体架构图</h1>
    
	<h1 id="1-docker的总架构图">1. Docker的总架构图</h1>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577966/article/docker/dockerArch/docker-architecture.jpg" width="60%"/>
<p>docker是一个C/S模式的架构，后端是一个松耦合架构，模块各司其职。</p>
<ol>
<li>用户是使用Docker Client与Docker Daemon建立通信，并发送请求给后者。</li>
<li>Docker Daemon作为Docker架构中的主体部分，首先提供Server的功能使其可以接受Docker Client的请求；</li>
<li>Engine执行Docker内部的一系列工作，每一项工作都是以一个Job的形式的存在。</li>
<li>Job的运行过程中，当需要容器镜像时，则从Docker Registry中下载镜像，并通过镜像管理驱动graphdriver将下载镜像以Graph的形式存储；</li>
<li>当需要为Docker创建网络环境时，通过网络管理驱动networkdriver创建并配置Docker容器网络环境；</li>
<li>当需要限制Docker容器运行资源或执行用户指令等操作时，则通过execdriver来完成。</li>
<li>libcontainer是一项独立的容器管理包，networkdriver以及execdriver都是通过libcontainer来实现具体对容器进行的操作。</li>
</ol>
<h1 id="2-docker各模块组件分析">2. Docker各模块组件分析</h1>
<h2 id="2-1-docker-client-发起请求">2.1. Docker Client[发起请求]</h2>
<ol>
<li>Docker Client是和Docker Daemon建立通信的客户端。用户使用的可执行文件为docker（类似可执行脚本的命令），docker命令后接参数的形式来实现一个完整的请求命令（例如docker images，docker为命令不可变，images为参数可变）。</li>
<li>Docker Client可以通过以下三种方式和Docker Daemon建立通信：tcp://host:port，unix://path_to_socket和fd://socketfd。</li>
<li>Docker Client发送容器管理请求后，由Docker Daemon接受并处理请求，当Docker Client接收到返回的请求相应并简单处理后，Docker Client一次完整的生命周期就结束了。[一次完整的请求：发送请求→处理请求→返回结果]，与传统的C/S架构请求流程并无不同。</li>
</ol>
<h2 id="2-2-docker-daemon-后台守护进程">2.2. Docker Daemon[后台守护进程]</h2>
<p><strong>Docker Daemon的架构图</strong></p>
  <img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577967/article/docker/dockerArch/docker-daemon.jpg" width="60%"/>
<h3 id="2-2-1-docker-server-调度分发请求">2.2.1. Docker Server[调度分发请求]</h3>
<p><strong>Docker Server的架构图</strong></p>
   <img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577967/article/docker/dockerArch/docker-server.jpg" width="60%"/>
<ol>
<li>Docker Server相当于C/S架构的服务端。功能为接受并调度分发Docker Client发送的请求。接受请求后，Server通过路由与分发调度，找到相应的Handler来执行请求。</li>
<li>在Docker的启动过程中，通过包gorilla/mux，创建了一个mux.Router，提供请求的路由功能。在Golang中，gorilla/mux是一个强大的URL路由器以及调度分发器。该mux.Router中添加了众多的路由项，每一个路由项由HTTP请求方法（PUT、POST、GET或DELETE）、URL、Handler三部分组成。</li>
<li>创建完mux.Router之后，Docker将Server的监听地址以及mux.Router作为参数，创建一个httpSrv=http.Server{}，最终执行httpSrv.Serve()为请求服务。</li>
<li>在Server的服务过程中，Server在listener上接受Docker Client的访问请求，并创建一个全新的goroutine来服务该请求。在goroutine中，首先读取请求内容，然后做解析工作，接着找到相应的路由项，随后调用相应的Handler来处理该请求，最后Handler处理完请求之后回复该请求。</li>
</ol>
<h3 id="2-2-2-engine">2.2.2. Engine</h3>
<ol>
<li>Engine是Docker架构中的运行引擎，同时也Docker运行的核心模块。它扮演Docker container存储仓库的角色，并且通过执行job的方式来操纵管理这些容器。</li>
<li>在Engine数据结构的设计与实现过程中，有一个handler对象。该handler对象存储的都是关于众多特定job的handler处理访问。举例说明，Engine的handler对象中有一项为：{&quot;create&quot;: daemon.ContainerCreate,}，则说明当名为&quot;create&quot;的job在运行时，执行的是daemon.ContainerCreate的handler。</li>
</ol>
<h3 id="2-2-3-job">2.2.3. Job</h3>
<ol>
<li>一个Job可以认为是Docker架构中Engine内部最基本的工作执行单元。Docker可以做的每一项工作，都可以抽象为一个job。例如：在容器内部运行一个进程，这是一个job；创建一个新的容器，这是一个job。Docker Server的运行过程也是一个job，名为serveapi。</li>
<li>Job的设计者，把Job设计得与Unix进程相仿。比如说：Job有一个名称，有参数，有环境变量，有标准的输入输出，有错误处理，有返回状态等。</li>
</ol>
<h2 id="2-3-docker-registry-镜像注册中心">2.3. Docker Registry[镜像注册中心]</h2>
<ol>
<li>Docker Registry是一个存储容器镜像的仓库（注册中心），可理解为云端镜像仓库，按repository来分类，docker pull 按照[repository]:[tag]来精确定义一个image。</li>
<li>在Docker的运行过程中，Docker Daemon会与Docker Registry通信，并实现搜索镜像、下载镜像、上传镜像三个功能，这三个功能对应的job名称分别为&quot;search&quot;，&quot;pull&quot; 与 &quot;push&quot;。</li>
<li>可分为公有仓库（docker hub）和私有仓库。</li>
</ol>
<h2 id="2-4-graph-docker内部数据库">2.4. Graph[docker内部数据库]</h2>
<p><strong>Graph的架构图</strong></p>
  <img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577968/article/docker/dockerArch/graph-architecture.jpg" width="60%"/>
<h3 id="2-4-1-repository">2.4.1. Repository</h3>
<ol>
<li>已下载镜像的保管者（包括下载镜像和dockerfile构建的镜像）。</li>
<li>一个repository表示某类镜像的仓库（例如Ubuntu），同一个repository内的镜像用tag来区分（表示同一类镜像的不同标签或版本）。一个registry包含多个repository，一个repository包含同类型的多个image。</li>
<li>镜像的存储类型有aufs，devicemapper,Btrfs，Vfs等。其中centos系统使用devicemapper的存储类型。</li>
<li>同时在Graph的本地目录中，关于每一个的容器镜像，具体存储的信息有：该容器镜像的元数据，容器镜像的大小信息，以及该容器镜像所代表的具体rootfs。</li>
</ol>
<h3 id="2-4-2-graphdb">2.4.2. GraphDB</h3>
<ol>
<li>已下载容器镜像之间关系的记录者。</li>
<li>GraphDB是一个构建在SQLite之上的小型图数据库，实现了节点的命名以及节点之间关联关系的记录</li>
</ol>
<h2 id="2-5-driver-执行部分">2.5. Driver[执行部分]</h2>
<p>Driver是Docker架构中的驱动模块。通过Driver驱动，Docker可以实现对Docker容器执行环境的定制。即Graph负责镜像的存储，Driver负责容器的执行。</p>
<h3 id="2-5-1-graphdriver">2.5.1. graphdriver</h3>
<p><strong>graphdriver架构图</strong></p>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577968/article/docker/dockerArch/graphdriver.jpg" width="60%"/>
<ol>
<li>graphdriver主要用于完成容器镜像的管理，包括存储与获取。</li>
<li>存储：docker pull下载的镜像由graphdriver存储到本地的指定目录（Graph中）。</li>
<li>获取：docker run（create）用镜像来创建容器的时候由graphdriver到本地Graph中获取镜像。</li>
</ol>
<h3 id="2-5-2-networkdriver">2.5.2. networkdriver</h3>
<p><strong>networkdriver的架构图</strong></p>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577968/article/docker/dockerArch/networkdriver.jpg" width="60%"/>
<ol>
<li>networkdriver的用途是完成Docker容器网络环境的配置，其中包括
<ul>
<li>Docker启动时为Docker环境创建网桥；</li>
<li>Docker容器创建时为其创建专属虚拟网卡设备；</li>
<li>Docker容器分配IP、端口并与宿主机做端口映射，设置容器防火墙策略等。</li>
</ul>
</li>
</ol>
<h3 id="2-5-3-execdriver">2.5.3. execdriver</h3>
<p><strong>execdriver的架构图</strong></p>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577967/article/docker/dockerArch/execdriver.jpg" width="55%"/>
<ol>
<li>execdriver作为Docker容器的执行驱动，负责创建容器运行命名空间，负责容器资源使用的统计与限制，负责容器内部进程的真正运行等。</li>
<li>现在execdriver默认使用native驱动，不依赖于LXC。</li>
</ol>
<h2 id="2-6-libcontainer-函数库">2.6. libcontainer[函数库]</h2>
<p><strong>libcontainer的架构图</strong></p>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577967/article/docker/dockerArch/libcontainer.jpg" width="60%"/>
<ol>
<li>libcontainer是Docker架构中一个使用Go语言设计实现的库，设计初衷是希望该库可以不依靠任何依赖，直接访问内核中与容器相关的API。</li>
<li>Docker可以直接调用libcontainer，而最终操纵容器的namespace、cgroups、apparmor、网络设备以及防火墙规则等。</li>
<li>libcontainer提供了一整套标准的接口来满足上层对容器管理的需求。或者说，libcontainer屏蔽了Docker上层对容器的直接管理。</li>
</ol>
<h2 id="2-7-docker-container-服务交付的最终形式">2.7. docker container[服务交付的最终形式]</h2>
<p><strong>container架构</strong></p>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510577966/article/docker/dockerArch/container.jpg" width="60%"/>
<ol>
<li>
<p>Docker container（Docker容器）是Docker架构中服务交付的最终体现形式。</p>
</li>
<li>
<p>Docker按照用户的需求与指令，订制相应的Docker容器：</p>
</li>
<li>
<ul>
<li>用户通过指定容器镜像，使得Docker容器可以自定义rootfs等文件系统；</li>
<li>用户通过指定计算资源的配额，使得Docker容器使用指定的计算资源；</li>
<li>用户通过配置网络及其安全策略，使得Docker容器拥有独立且安全的网络环境；</li>
<li>用户通过指定运行的命令，使得Docker容器执行指定的工作。</li>
</ul>
</li>
</ol>
<p>参考文章：</p>
<ul>
<li>《Docker源码分析》</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-91b754723c0e10706ccf129e1b4dde7f">11.3.4 - Docker常用命令原理图</h1>
    
	<h1 id="1-基本概念">1. 基本概念</h1>
<h2 id="1-1-image-layer-镜像层">1.1. image layer（镜像层）</h2>
<p>镜像可以看成是由多个镜像层叠加起来的一个文件系统，镜像层也可以简单理解为一个基本的镜像，而每个镜像层之间通过指针的形式进行叠加。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578327/article/docker/commands/1.png" alt="1"></p>
<p>根据上图，镜像层的主要组成部分包括镜像层id，镜像层指针【指向父层】，元数据【layer metadata】包含了docker构建和运行的信息还有父层的层次信息。</p>
<p>只读层和读写层【top layer】的组成部分基本一致。同时读写层可以转换成只读层【docker commit操作实现】</p>
<h2 id="1-2-image-镜像-只读层的集合">1.2. image（镜像）---【只读层的集合】</h2>
<p>1、镜像是一堆只读层的统一视角，除了最底层没有指向外，每一层都指向它的父层，统一文件系统（union file system）技术能够将不同的层整合成一个文件系统，为这些层提供了一个统一的视角，这样就隐藏了多层的存在，在用户的角度看来，只存在一个文件系统。而每一层都是不可写的，就是只读层。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578328/article/docker/commands/2.1.png" alt="2.1"></p>
<h2 id="1-3-container-容器-一层读写层-多层只读层">1.3. container（容器）---【一层读写层+多层只读层】</h2>
<p>1、容器和镜像的区别在于容器的最上面一层是读写层【top layer】，而这边并没有区分容器是否在运行。运行状态的容器【running container】即一个可读写的文件系统【静态容器】+隔离的进程空间和其中的进程。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578329/article/docker/commands/3.1.png" alt="3.1"></p>
<p>隔离的进程空间中的进程可以对该读写层进行增删改，其运行状态容器的进程操作都作用在该读写层上。每个容器只能有一个进程隔离空间。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578328/article/docker/commands/3.2.png" alt="3.2"></p>
<h1 id="2-docker常用命令原理图概览">2. Docker常用命令原理图概览：</h1>
<img src="http://res.cloudinary.com/dqxtn0ick/image/upload/v1510578333/article/docker/commands/dockerCommands.jpg" width="70%">
<h1 id="3-docker常用命令说明">3.  Docker常用命令说明</h1>
<h2 id="3-1-标识说明">3.1. 标识说明</h2>
<h3 id="3-1-1-image-统一只读文件系统">3.1.1. image---（统一只读文件系统）</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578329/article/docker/commands/4.1.1.png" alt="4.1.1"></p>
<h3 id="3-1-2-静态容器-未运行的容器-统一可读写文件系统">3.1.2. 静态容器【未运行的容器】---（统一可读写文件系统）</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578329/article/docker/commands/4.1.2.png" alt="4.1.2"></p>
<h3 id="3-1-3-动态容器-running-container-进程空间-包括进程-统一可读写文件系统">3.1.3. 动态容器【running container】---（进程空间（包括进程）+统一可读写文件系统）</h3>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578330/article/docker/commands/4.1.3.png" alt="4.1.3"></p>
<h2 id="3-2-命令说明">3.2. 命令说明</h2>
<h3 id="3-2-1-docker生命周期相关命令">3.2.1. docker生命周期相关命令:</h3>
<h4 id="3-2-1-1-docker-create-image-id">3.2.1.1. docker create {image-id}</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578330/article/docker/commands/4.2.1.1.png" alt="4.2.1.1"></p>
<p>即为只读文件系统添加一层可读写层【top layer】，生成可读写文件系统，该命令状态下容器为静态容器，并没有运行。</p>
<h4 id="3-2-1-2-docker-start-restart-container-id">3.2.1.2. docker start（restart） {container-id}</h4>
<p>docker stop即为docker start的逆过程</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578330/article/docker/commands/4.2.1.2.png" alt="4.2.1.2"></p>
<p>即为可读写文件系统添加一个进程空间【包括进程】，生成动态容器【running container】</p>
<h4 id="3-2-1-3-docker-run-image-id">3.2.1.3. docker run {image-id}</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578330/article/docker/commands/4.2.1.3.png" alt="4.2.1.3"></p>
<p>docker run=docker create+docker start</p>
<p>类似流程如下 ：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578329/article/docker/commands/4.2.1.3.1.png" alt="4.2.1.3.1"></p>
<h4 id="3-2-1-4-docker-stop-container-id">3.2.1.4. docker stop {container-id}</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578330/article/docker/commands/4.2.1.4.png" alt="4.2.1.4"></p>
<p>向运行的容器中发一个SIGTERM的信号，然后停止所有的进程。即为docker start的逆过程。</p>
<h4 id="3-2-1-5-docker-kill-container-id">3.2.1.5. docker kill {container-id}</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.1.5.png" alt="4.2.1.5"></p>
<p>docker kill向容器发送不友好的SIGKILL的信号，相当于快速强制关闭容器，与docker stop的区别在于docker stop是正常关闭，先发SIGTERM信号，清理进程，再发SIGKILL信号退出。</p>
<h4 id="3-2-1-6-docker-pause-container-id">3.2.1.6. docker pause {container-id}</h4>
<p>docker unpause为逆过程---比较少使用</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578330/article/docker/commands/4.2.1.6.png" alt="4.2.1.6"></p>
<p>暂停容器中的所有进程，使用cgroup的freezer顺序暂停容器里的所有进程，docker unpause为逆过程即恢复所有进程。比较少使用。</p>
<h4 id="3-2-1-7-docker-commit-container-id">3.2.1.7. docker commit {container-id}</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.1.7.png" alt="4.2.1.7"></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.1.7.2.png" alt="4.2.1.7.2"></p>
<p>把容器的可读写层转化成只读层，即从容器状态【可读写文件系统】变为镜像状态【只读文件系统】，可理解为【固化】。</p>
<h4 id="3-2-1-8-docker-build">3.2.1.8. docker build</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.1.8.1.png" alt="4.2.1.8.1"></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.1.8.2.png" alt="4.2.1.8.2"></p>
<p><strong>docker build=docker run【运行容器】+【进程修改数据】+docker commit【固化数据】，不断循环直至生成所需镜像。</strong></p>
<p>循环一次便会形成新的层（镜像）【原镜像层+已固化的可读写层】</p>
<p>docker build 一般作用在dockerfile文件上。</p>
<h3 id="3-2-2-docker查询类命令">3.2.2. docker查询类命令</h3>
<p>查询对象：①image，②container，③image/container中的数据，④系统信息[容器数，镜像数及其他]</p>
<h4 id="3-2-2-1-image">3.2.2.1. Image</h4>
<h4 id="1-docker-images">1、docker images</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.2.1.1.png" alt="4.2.2.1.1"></p>
<p>docker images 列出当前镜像【以顶层镜像id来表示整个完整镜像】，每个顶层镜像下面隐藏多个镜像层。</p>
<h4 id="2-docker-images-a">2、docker images -a</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578332/article/docker/commands/4.2.2.1.2.png" alt="4.2.2.1.2"></p>
<p>docker images -a列出所有镜像层【排序以每个顶层镜像id为首后接该镜像下的所有镜像层】，依次列出每个镜像的所有镜像层。</p>
<h4 id="3-docker-history-image-id">3、docker history {image-id}</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.2.1.3.png" alt="4.2.2.1.3"></p>
<p>docker history 列出该镜像id下的所有历史镜像。</p>
<h4 id="3-2-2-2-container">3.2.2.2. Container</h4>
<h4 id="1-docker-ps">1、docker ps</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578331/article/docker/commands/4.2.2.2.1.png" alt="4.2.2.2.1"></p>
<p>列出所有运行的容器【running container】</p>
<h4 id="2-docker-ps-a">2、docker ps -a</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578332/article/docker/commands/4.2.2.2.2.png" alt="4.2.2.2.2"></p>
<p>列出所有容器，包括静态容器【未运行的容器】和动态容器【running container】</p>
<h4 id="3-2-2-3-info">3.2.2.3. Info</h4>
<h4 id="1-docker-inspect-container-id-or-image-id">1、docker inspect {container-id} or {image-id}</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578332/article/docker/commands/4.2.2.3.1.png" alt="4.2.2.3.1"></p>
<p>提取出容器或镜像最顶层的元数据。</p>
<h4 id="2-docker-info">2、docker info</h4>
<p>显示 Docker 系统信息，包括镜像和容器数。</p>
<h3 id="3-2-3-docker操作类命令">3.2.3. docker操作类命令：</h3>
<h4 id="3-2-3-1-docker-rm-container-id">3.2.3.1. docker rm {container-id}</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578332/article/docker/commands/4.2.3.1.png" alt="4.2.3.1"></p>
<p>docker rm会移除镜像，该命令只能对静态容器【非运行状态】进行操作。</p>
<p>通过docker rm -f {container-id}的-f （force）参数可以强制删除运行状态的容器【running container】。</p>
<h4 id="3-2-3-2-docker-rmi-image-id">3.2.3.2. docker rmi {image-id}</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578332/article/docker/commands/4.2.3.2.png" alt="4.2.3.2"></p>
<h4 id="3-2-3-3-docker-exec-running-container-id">3.2.3.3. docker exec {running-container-id}</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578332/article/docker/commands/4.2.3.3.png" alt="4.2.3.3"></p>
<p>docker exec会在运行状态的容器中执行一个新的进程。</p>
<h4 id="3-2-3-4-docker-export-container-id">3.2.3.4. docker export {container-id}</h4>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578333/article/docker/commands/4.2.3.4.png" alt="4.2.3.4"></p>
<p>docker export命令创建一个tar文件，并且移除了元数据和不必要的层，将多个层整合成了一个层，只保存了当前统一视角看到的内容。</p>
<p>参考文章：</p>
<ul>
<li><a href="http://merrigrove.blogspot.com/2015/10/visualizing-docker-containers-and-images.html">http://merrigrove.blogspot.com/2015/10/visualizing-docker-containers-and-images.html</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-890423223e32d1c3cfd58de38eb8a618">11.3.5 - Dockerfile使用说明</h1>
    
	<h1 id="1-dockerfile的说明">1. Dockerfile的说明</h1>
<p>dockerfile指令忽略大小写，建议大写，#作为注释，每行只支持一条指令，指令可以带多个参数。</p>
<p>dockerfile指令分为构建指令和设置指令。</p>
<ol>
<li>构建指令：用于构建image，其指定的操作不会在运行image的容器中执行。</li>
<li>设置指令：用于设置image的属性，其指定的操作会在运行image的容器中执行。</li>
</ol>
<h1 id="2-dockerfile指令说明">2. Dockerfile指令说明</h1>
<h2 id="2-1-from-指定基础镜像-构建指令">2.1. FROM（指定基础镜像）[构建指令]</h2>
<p>该命令用来指定基础镜像，在基础镜像的基础上修改数据从而构建新的镜像。基础镜像可以是本地仓库也可以是远程仓库。</p>
<p>指令有两种格式：</p>
<ol>
<li>FROM <code>image</code>   【默认为latest版本】</li>
<li>FROM <code>image</code>:<code>tag</code>     【指定版本】</li>
</ol>
<h2 id="2-2-maintainer-镜像创建者信息-构建指令">2.2. MAINTAINER（镜像创建者信息）[构建指令]</h2>
<p>将镜像制作者（维护者）的信息写入image中，执行docker inspect时会输出该信息。</p>
<p>格式：MAINTAINER <code>name</code></p>
<p>MAINTAINER命令已废弃，可使用maintainer label的方式。</p>
<pre tabindex="0"><code>LABEL maintainer=&#34;SvenDowideit@home.org.au&#34;
</code></pre><h2 id="2-3-run-安装软件用-构建指令">2.3. RUN（安装软件用）[构建指令]</h2>
<p>RUN可以运行任何被基础镜像支持的命令（即在基础镜像上执行一个进程），可以使用多条RUN指令，指令较长可以使用\来换行。</p>
<p>指令有两种格式：</p>
<ol>
<li>RUN <code>command</code> (the command is run in a shell - <code>/bin/sh -c</code>)</li>
<li>RUN [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot; ... ] (exec form)
<ul>
<li>指定使用其他终端实现，使用exec执行。</li>
<li>例子：RUN[&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;echo hello&quot;]</li>
</ul>
</li>
</ol>
<h2 id="2-4-cmd-设置container启动时执行的操作-设置指令">2.4. CMD（设置container启动时执行的操作）[设置指令]</h2>
<p>用于容器启动时的指定操作，可以是自定义脚本或命令，只执行一次，多个默认执行最后一个。</p>
<p>指令有三种格式：</p>
<ol>
<li>CMD [&quot;executable&quot;,&quot;param1&quot;,&quot;param2&quot;] (like an exec, this is the preferred form)
<ul>
<li>运行一个可执行文件并提供参数。</li>
</ul>
</li>
<li>CMD command param1 param2 (as a shell)
<ul>
<li>直接执行shell命令，默认以/bin/sh -c执行。</li>
</ul>
</li>
<li>CMD [&quot;param1&quot;,&quot;param2&quot;] (as default parameters to ENTRYPOINT)
<ul>
<li>和ENTRYPOINT配合使用，只作为完整命令的参数部分。</li>
</ul>
</li>
</ol>
<h2 id="2-5-entrypoint-设置container启动时执行的操作-设置指令">2.5. ENTRYPOINT（设置container启动时执行的操作）[设置指令]</h2>
<p>指定容器启动时执行的命令，若多次设置只执行最后一次。</p>
<p>ENTRYPOINT翻译为“进入点”，它的功能可以让容器表现得像一个可执行程序一样。</p>
<p>例子：ENTRYPOINT [&quot;/bin/echo&quot;] ，那么docker build出来的镜像以后的容器功能就像一个/bin/echo程序，docker run -it imageecho “this is a test”，就会输出对应的字符串。这个imageecho镜像对应的容器表现出来的功能就像一个echo程序一样。</p>
<p>指令有两种格式：</p>
<ol>
<li>
<p>ENTRYPOINT [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;] (like an exec, the preferred form)</p>
<ul>
<li>
<p>和CMD配合使用，CMD则作为完整命令的参数部分，ENTRYPOINT以JSON格式指定执行的命令部分。CMD可以为ENTRYPOINT提供可变参数，不需要变动的参数可以写在ENTRYPOINT里面。</p>
</li>
<li>
<p>例子：</p>
<p>ENTRYPOINT [&quot;/usr/bin/ls&quot;,&quot;-a&quot;]</p>
<p>CMD [&quot;-l&quot;]</p>
</li>
</ul>
</li>
<li>
<p>ENTRYPOINT command param1 param2 (as a shell)</p>
<ul>
<li>独自使用，即和CMD类似，如果CMD也是个完整命令[CMD command param1 param2 (as a shell) ]，那么会相互覆盖，只执行最后一个CMD或ENTRYPOINT。</li>
<li>例子：ENTRYPOINT ls -l</li>
</ul>
</li>
</ol>
<h2 id="2-6-user-设置container容器启动的登录用户-设置指令">2.6. USER（设置container容器启动的登录用户）[设置指令]</h2>
<p>设置启动容器的用户，默认为root用户。</p>
<p>格式：USER daemon</p>
<h2 id="2-7-expose-指定容器需要映射到宿主机的端口-设置指令">2.7. EXPOSE（指定容器需要映射到宿主机的端口）[设置指令]</h2>
<p>该指令会将容器中的端口映射为宿主机中的端口[确保宿主机的端口号没有被使用]。通过宿主机IP和映射后的端口即可访问容器[避免每次运行容器时IP随机生成不固定的问题]。前提是EXPOSE设置映射端口，运行容器时加上-p参数指定EXPOSE设置的端口。EXPOSE可以设置多个端口号，相应地运行容器配套多次使用-p参数。可以通过docker port +容器需要映射的端口号和容器ID来参考宿主机的映射端口。</p>
<p>格式：EXPOSE <code>port</code> [<code>port</code>...]</p>
<h2 id="2-8-env-用于设置环境变量-构建指令">2.8. ENV（用于设置环境变量）[构建指令]</h2>
<p>在image中设置环境变量[以键值对的形式]，设置之后RUN命令可以使用该环境变量，在容器启动后也可以通过docker inspect查看环境变量或者通过 docker run --env key=value设置或修改环境变量。</p>
<p>格式：ENV <code>key</code> <code>value</code></p>
<p>例子：ENV JAVA_HOME /path/to/java/dirent</p>
<h2 id="2-9-arg-用于设置变量-构建指令">2.9. ARG（用于设置变量）[构建指令]</h2>
<p>ARG定义一个默认参数，可以在dockerfile中引用。构建阶段可以通过docker build --build-arg <varname>=<value>参数向dockerfile文件中传入参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ARG &lt;arg_name&gt;<span style="color:#ce5c00;font-weight:bold">[=</span>&lt;default value&gt;<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以搭配ENV使用</span>
</span></span><span style="display:flex;"><span>ENV env_name <span style="color:#4e9a06">${</span><span style="color:#000">arg_name</span><span style="color:#4e9a06">}</span>
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker build --build-arg <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">=</span>what_user .
</span></span></code></pre></div><h2 id="2-10-add-从src复制文件到container的dest路径-构建指令">2.10. ADD（从src复制文件到container的dest路径）[构建指令]</h2>
<p>复制指定的src到容器中的dest，其中src是相对被构建的源目录的相对路径，可以是文件或目录的路径，也可以是一个远程的文件url。<code>dest</code> 是container中的绝对路径。所有拷贝到container中的文件和文件夹权限为0755，uid和gid为0。</p>
<ul>
<li>如果src是一个目录，那么会将该目录下的所有文件添加到container中，不包括目录；</li>
<li>如果src文件是可识别的压缩格式，则docker会帮忙解压缩（注意压缩格式）；</li>
<li>如果<code>src</code>是文件且<code>dest</code>中不使用斜杠结束，则会将<code>dest</code>视为文件，<code>src</code>的内容会写入<code>dest</code>；</li>
<li>如果<code>src</code>是文件且<code>dest</code>中使用斜杠结束，则会<code>src</code>文件拷贝到<code>dest</code>目录下。</li>
</ul>
<p>格式：ADD <code>src</code> <code>dest</code></p>
<blockquote>
<p>为避免 ADD命令带来的未知风险和复杂性，可以使用COPY命令替代ADD命令</p>
</blockquote>
<h2 id="2-11-copy-复制文件">2.11. COPY（复制文件）</h2>
<p>复制本地主机的src为容器中的dest，目标路径不存在时会自动创建。</p>
<p>格式：COPY <code>src</code> <code>dest</code></p>
<h2 id="2-12-volume-指定挂载点-设置指令">2.12. VOLUME（指定挂载点）[设置指令]</h2>
<p>创建一个可以从本地主机或其他容器挂载的挂载点，使容器中的一个目录具有持久化存储数据的功能，该目录可以被容器本身使用也可以被其他容器使用。</p>
<p>格式：VOLUME [&quot;<code>mountpoint</code>&quot;]</p>
<p>其他容器使用共享数据卷：docker run -t -i -rm -volumes-from container1 image2 bash [container1为第一个容器的ID，image2为第二个容器运行image的名字。]</p>
<h2 id="2-13-workdir-切换目录-设置指令">2.13. WORKDIR（切换目录）[设置指令]</h2>
<p>相当于cd命令，可以多次切换目录，为RUN,CMD,ENTRYPOINT配置工作目录。可以使用多个WORKDIR的命令，后续命令如果是相对路径则是在上一级路径的基础上执行[类似cd的功能]。</p>
<p>格式：WORKDIR /path/to/workdir</p>
<h2 id="2-14-onbuild-在子镜像中执行">2.14. ONBUILD（在子镜像中执行）</h2>
<p>当所创建的镜像作为其他新创建镜像的基础镜像时执行的操作命令，即在创建本镜像时不运行，当作为别人的基础镜像时再在构建时运行（可认为基础镜像为父镜像，而该命令即在它的子镜像构建时运行，相当于在子镜像构建时多加了一些命令）。</p>
<p>格式：ONBUILD <code>Dockerfile关键字</code></p>
<h1 id="3-dockerfile示例">3. dockerfile示例</h1>
<p><strong>最佳实践</strong></p>
<ul>
<li>镜像可以分为三层：系统基础镜像、业务基础镜像、业务镜像。</li>
<li>尽量将不变的镜像操作放dockerfile前面。</li>
<li>一类RUN命令操作可以通过<code>\</code>和<code>&amp;&amp;</code>方式组合成一条RUN命令。</li>
<li>dockerfile尽量清晰简洁。</li>
</ul>
<p><strong>文件目录</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- Dockerfile
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- docker-entrypoint.sh
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- dumb-init
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- conf    <span style="color:#8f5902;font-style:italic"># 配置文件路径</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- app_conf.py  
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- pkg   <span style="color:#8f5902;font-style:italic"># 安装包路径</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- install.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- run.sh  <span style="color:#8f5902;font-style:italic"># 启动脚本</span>
</span></span></code></pre></div><p><strong>dockerfile示例</strong></p>
<pre tabindex="0"><code>FROM centos:latest
LABEL maintainer=&#34;xxx@xxx.com&#34;

ARG APP=appname
ENV APP ${APP}

# copy and install app 
COPY conf/app_conf.py /usr/local/app/app_conf/app_conf.py
COPY pkg/${APP}-*-install.tar.gz /data/${APP}-install.tar.gz
RUN mkdir -p /data/${APP} \
    &amp;&amp; tar -zxvf /data/${APP}-install.tar.gz -C /data/${APP} \
    &amp;&amp; cd /data/${APP}/${APP}* \
    &amp;&amp; ./install.sh

WORKDIR /usr/local/app/

# init
COPY dumb-init /usr/bin/dumb-init
COPY docker-entrypoint.sh /docker-entrypoint.sh
ENTRYPOINT [&#34;/usr/bin/dumb-init&#34;, &#34;--&#34;,&#34;/docker-entrypoint.sh&#34;]

COPY run.sh /run.sh
RUN chmod +x /run.sh
CMD [&#34;/run.sh&#34;]
</code></pre><h1 id="4-docker-build">4. docker build</h1>
<p>指定dockerfile文件构建</p>
<blockquote>
<p>默认不指定dockerfile文件名，则读取指定路径的Dockerfile</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker build -t &lt;image_name&gt; -f &lt;dockerfile_name&gt; &lt;dockerfile_path&gt;
</span></span></code></pre></div><p><strong>docker build --help</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker build --help
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:	docker build <span style="color:#ce5c00;font-weight:bold">[</span>OPTIONS<span style="color:#ce5c00;font-weight:bold">]</span> PATH <span style="color:#000;font-weight:bold">|</span> URL <span style="color:#000;font-weight:bold">|</span> -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Build an image from a Dockerfile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Options:
</span></span><span style="display:flex;"><span>      --add-host list           Add a custom host-to-IP mapping <span style="color:#ce5c00;font-weight:bold">(</span>host:ip<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --build-arg list          Set build-time variables
</span></span><span style="display:flex;"><span>      --cache-from strings      Images to consider as cache sources
</span></span><span style="display:flex;"><span>      --cgroup-parent string    Optional parent cgroup <span style="color:#204a87;font-weight:bold">for</span> the container
</span></span><span style="display:flex;"><span>      --compress                Compress the build context using gzip
</span></span><span style="display:flex;"><span>      --cpu-period int          Limit the CPU CFS <span style="color:#ce5c00;font-weight:bold">(</span>Completely Fair Scheduler<span style="color:#ce5c00;font-weight:bold">)</span> period
</span></span><span style="display:flex;"><span>      --cpu-quota int           Limit the CPU CFS <span style="color:#ce5c00;font-weight:bold">(</span>Completely Fair Scheduler<span style="color:#ce5c00;font-weight:bold">)</span> quota
</span></span><span style="display:flex;"><span>  -c, --cpu-shares int          CPU shares <span style="color:#ce5c00;font-weight:bold">(</span>relative weight<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --cpuset-cpus string      CPUs in which to allow execution <span style="color:#ce5c00;font-weight:bold">(</span>0-3, 0,1<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --cpuset-mems string      MEMs in which to allow execution <span style="color:#ce5c00;font-weight:bold">(</span>0-3, 0,1<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --disable-content-trust   Skip image verification <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#204a87">true</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -f, --file string             Name of the Dockerfile <span style="color:#ce5c00;font-weight:bold">(</span>Default is <span style="color:#4e9a06">&#39;PATH/Dockerfile&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --force-rm                Always remove intermediate containers
</span></span><span style="display:flex;"><span>      --iidfile string          Write the image ID to the file
</span></span><span style="display:flex;"><span>      --isolation string        Container isolation technology
</span></span><span style="display:flex;"><span>      --label list              Set metadata <span style="color:#204a87;font-weight:bold">for</span> an image
</span></span><span style="display:flex;"><span>  -m, --memory bytes            Memory limit
</span></span><span style="display:flex;"><span>      --memory-swap bytes       Swap limit equal to memory plus swap: <span style="color:#4e9a06">&#39;-1&#39;</span> to <span style="color:#204a87">enable</span> unlimited swap
</span></span><span style="display:flex;"><span>      --network string          Set the networking mode <span style="color:#204a87;font-weight:bold">for</span> the RUN instructions during build <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --no-cache                Do not use cache when building the image
</span></span><span style="display:flex;"><span>      --pull                    Always attempt to pull a newer version of the image
</span></span><span style="display:flex;"><span>  -q, --quiet                   Suppress the build output and print image ID on success
</span></span><span style="display:flex;"><span>      --rm                      Remove intermediate containers after a successful build <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#204a87">true</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --security-opt strings    Security options
</span></span><span style="display:flex;"><span>      --shm-size bytes          Size of /dev/shm
</span></span><span style="display:flex;"><span>  -t, --tag list                Name and optionally a tag in the <span style="color:#4e9a06">&#39;name:tag&#39;</span> format
</span></span><span style="display:flex;"><span>      --target string           Set the target build stage to build.
</span></span><span style="display:flex;"><span>      --ulimit <span style="color:#204a87">ulimit</span>           Ulimit options <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#ce5c00;font-weight:bold">[])</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1f7c30a0df89f622b955131c82bdde89">11.4 - Kata Container</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-f6d0e42132cf59c4455d3bc527f08915">11.4.1 - Kata容器简介</h1>
    
	<h1 id="kata-container简介">Kata-container简介</h1>
<p>kata-container通过轻量型虚拟机技术构建一个安全的容器运行时，表现像容器一样，但通硬件虚拟化技术提供强隔离，作为第二层的安全防护。</p>
<p><strong>特点：</strong></p>
<ul>
<li>安全：独立的内核，提供网络、I/O、内存的隔离。</li>
<li>兼容性：支持OCI容器标准，k8s的CRI接口。</li>
<li>性能：兼容虚拟机的安全和容器的轻量特点。</li>
<li>简单：使用标准的接口。</li>
</ul>
<h1 id="1-kata-container架构">1. kata-container架构</h1>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1563362030/article/kata-container/arch_diagram.jpg">
<p><strong>kata-container与传统container的比较</strong></p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1563362032/article/kata-container/traditionalvskata.jpg">
<h1 id="2-kata-runtime-https-github-com-kata-containers-runtime">2. <a href="https://github.com/kata-containers/runtime">kata-runtime</a></h1>
<p><a href="https://github.com/kata-containers/runtime">Kata Containers runtime (<code>kata-runtime</code>)</a>通过<code>QEMU*/KVM</code>技术创建了一种轻量型的虚拟机，兼容 <a href="https://github.com/opencontainers">OCI</a> <a href="https://github.com/opencontainers/runtime-spec">runtime specification</a> 标准，支持<a href="https://github.com/kubernetes/community/blob/master/contributors/devel/container-runtime-interface.md">Kubernetes* Container Runtime Interface (CRI)</a>接口，可替换<a href="https://github.com/opencontainers/runc">CRI shim runtime (runc)</a> 通过k8s来创建pod或容器。</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1563362029/article/kata-container/docker-kata.png">
<h1 id="3-shim">3. shim</h1>
<p><code>shim</code>类似Docker的 <code>containerd-shim</code> 或CRI-O的 <code>conmon</code>，主要用来监控和回收容器的进程，<code>kata-shim</code>需要处理所有的容器的IO流(<code>stdout</code>, <code>stdin</code> and <code>stderr</code>)和转发相关信号。</p>
<p><a href="https://github.com/kata-containers/runtime/tree/master/containerd-shim-v2">containerd-shim-kata-v2</a>实现了<a href="https://github.com/containerd/containerd/tree/master/runtime/v2">Containerd Runtime V2 (Shim API)</a>，k8s可以通过<code>containerd-shim-kata-v2</code>（替代<code>2N+1</code>个<code>shims</code>[由一个<code>containerd-shim</code>和<code>kata-shim</code>组成]）来创建pod。</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1563362030/article/kata-container/shimv2.svg">
<h1 id="4-kata-agent-https-github-com-kata-containers-agent">4. <a href="https://github.com/kata-containers/agent">kata-agent</a></h1>
<p>在虚拟机内<code>kata-agent</code>作为一个daemon进程运行，并拉起容器的进程。kata-agent使用VIRTIO或VSOCK接口（QEMU在主机上暴露的socket文件）在guest虚拟机中运行gRPC服务器。kata-runtime通过grpc协议与kata-agent通信，向kata-agent发送管理容器的命令。该协议还用于容器和管理引擎（例如Docker Engine）之间传送I / O流（stdout，stderr，stdin）。</p>
<p>容器内所有的执行命令和相关的IO流都需要通过QEMU在宿主机暴露的<code>virtio-serial</code>或<code>vsock</code>接口，当使用VIRTIO的情况下，每个虚拟机会创建一个<a href="https://github.com/kata-containers/proxy">Kata Containers proxy (<code>kata-proxy</code>)</a> 来处理命令和IO流。</p>
<p><code>kata-agent</code>使用<a href="https://github.com/opencontainers/runc/tree/master/libcontainer"><code>libcontainer</code></a> 来管理容器的生命周期，复用了<a href="https://github.com/opencontainers/runc"><code>runc</code></a>的部分代码。</p>
<h1 id="5-kata-proxy">5. kata-proxy</h1>
<p><code>kata-proxy</code>提供了 <code>kata-shim</code> 和 <code>kata-runtime</code> 与VM中的<code>kata-agent</code>通信的方式，其中通信方式是使用<code>virtio-serial</code>或<code>vsock</code>，默认是使用<code>virtio-serial</code>。</p>
<h1 id="6-hypervisor">6. Hypervisor</h1>
<p>kata-container通过<a href="http://www.qemu-project.org/">QEMU</a>/<a href="http://www.linux-kvm.org/page/Main_Page">KVM</a>来创建虚拟机给容器运行，可以支持多种hypervisors。</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1563362028/article/kata-container/qemu.png">
<h1 id="7-qemu-kvm">7. QEMU/KVM</h1>
<blockquote>
<p>待补充</p>
</blockquote>
<p>参考文档：</p>
<ul>
<li>
<p><a href="https://katacontainers.io/">https://katacontainers.io/</a></p>
</li>
<li>
<p><a href="https://github.com/kata-containers/documentation/blob/master/design/architecture.md">https://github.com/kata-containers/documentation/blob/master/design/architecture.md</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d53643562cec15a3be0d3899bd08c3cf">11.4.2 - kata配置</h1>
    
	<h1 id="1-配置文件路径">1. 配置文件路径</h1>
<p>默认的配置文件位于<code>/usr/share/defaults/kata-containers/configuration.toml</code>，如果<code>/etc/kata-containers/configuration.toml</code>的配置文件存在，则会替代默认的配置文件。</p>
<p>查看配置文件的路径命令如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kata-runtime --kata-show-default-config-paths</span>
</span></span><span style="display:flex;"><span>/etc/kata-containers/configuration.toml
</span></span><span style="display:flex;"><span>/usr/share/defaults/kata-containers/configuration.toml
</span></span></code></pre></div><p>指定自定义配置文件运行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kata-runtime --kata-config<span style="color:#ce5c00;font-weight:bold">=</span>/some/where/configuration.toml ...
</span></span></code></pre></div><h1 id="2-kata-env">2. kata-env</h1>
<p>查看runtime使用到的环境参数，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kata-runtime kata-env
</span></span></code></pre></div><p>输出内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Meta<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.0.23&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Runtime<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Debug</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Trace</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">DisableGuestSeccomp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">DisableNewNetNs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/bin/kata-runtime&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">[</span>Runtime.Version<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Semver</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.7.2&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Commit</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;9b9282693cfbcf70d442916bea56771cc6fc3afe&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">OCI</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1.0.1-dev&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">[</span>Runtime.Config<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/share/defaults/kata-containers/configuration.toml&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Hypervisor<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">MachineType</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;pc&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;QEMU emulator version 2.11.0\nCopyright (c) 2003-2017 Fabrice Bellard and the QEMU Project developers&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/bin/qemu-lite-system-x86_64&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">BlockDeviceDriver</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;virtio-scsi&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">EntropySource</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/dev/urandom&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Msize9p</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8192</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">MemorySlots</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Debug</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">UseVSock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">SharedFS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;virtio-9p&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Image<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/share/kata-containers/kata-containers-image_centos_1.7.2_agent_20190702.img&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Kernel<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/share/kata-containers/vmlinuz-4.19.28.42-6.1.container&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Parameters</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;init=/usr/lib/systemd/systemd systemd.unit=kata-containers.target systemd.mask=systemd-networkd.service systemd.mask=systemd-networkd.socket systemd.mask=systemd-journald.service systemd.mask=systemd-journald.socket systemd.mask=systemd-journal-flush.service systemd.mask=systemd-journald-dev-log.socket systemd.mask=systemd-udevd.service systemd.mask=systemd-udevd.socket systemd.mask=systemd-udev-trigger.service systemd.mask=systemd-udevd-kernel.socket systemd.mask=systemd-udevd-control.socket systemd.mask=systemd-timesyncd.service systemd.mask=systemd-update-utmp.service systemd.mask=systemd-tmpfiles-setup.service systemd.mask=systemd-tmpfiles-cleanup.service systemd.mask=systemd-tmpfiles-cleanup.timer systemd.mask=tmp.mount systemd.mask=systemd-random-seed.service systemd.mask=systemd-coredump@.service&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Initrd<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Proxy<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;kataProxy&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;kata-proxy version 1.7.2-a56df7c&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/libexec/kata-containers/kata-proxy&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Debug</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Shim<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;kataShim&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;kata-shim version 1.7.2-2ea178c&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/libexec/kata-containers/kata-shim&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Debug</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Agent<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;kata&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Debug</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Trace</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TraceMode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TraceType</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Host<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Kernel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;4.14.105-1-tlinux3-0008&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Architecture</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;amd64&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">VMContainerCapable</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">SupportVSocks</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">[</span>Host.Distro<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Tencent tlinux&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;2.2&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">[</span>Host.CPU<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Vendor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;GenuineIntel&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Model</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Intel(R) Xeon(R) CPU           X3440  @ 2.53GHz&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Netmon<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;kata-netmon version 1.7.2&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/libexec/kata-containers/kata-netmon&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Debug</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Enable</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span></code></pre></div><h1 id="3-configuration-toml">3. configuration.toml</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Copyright (c) 2017-2019 Intel Corporation</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># SPDX-License-Identifier: Apache-2.0</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># XXX: WARNING: this file is auto-generated.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># XXX:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># XXX: Source file: &#34;cli/config/configuration-qemu.toml.in&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># XXX: Project:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># XXX:   Name: Kata Containers</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># XXX:   Type: kata</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>hypervisor.qemu<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/bin/qemu-lite-system-x86_64&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kernel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/share/kata-containers/vmlinuz.container&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">image</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/share/kata-containers/kata-containers.img&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">machine_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;pc&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Optional space-separated list of options to pass to the guest kernel.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For example, use `kernel_params = &#34;vsyscall=emulate&#34;` if you are having</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># trouble running pre-2.15 glibc.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># WARNING: - any parameter specified here will take priority over the default</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># parameter value of the same name used to start the virtual machine.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Do not set values here unless you understand the impact of doing so as you</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># may stop the virtual machine from booting.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># To see the list of default parameters, enable hypervisor debug, create a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># container and look for &#39;default-kernel-parameters&#39; log entries.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kernel_params</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Path to the firmware.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If you want that qemu uses the default firmware leave this option empty</span>
</span></span><span style="display:flex;"><span><span style="color:#000">firmware</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Machine accelerators</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># comma-separated list of machine accelerators to pass to the hypervisor.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For example, `machine_accelerators = &#34;nosmm,nosmbus,nosata,nopit,static-prt,nofw&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000">machine_accelerators</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default number of vCPUs per SB/VM:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># unspecified or 0                --&gt; will be set to 1</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &lt; 0                             --&gt; will be set to the actual number of physical cores</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &gt; 0 &lt;= number of physical cores --&gt; will be set to the specified number</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &gt; number of physical cores      --&gt; will be set to the actual number of physical cores</span>
</span></span><span style="display:flex;"><span><span style="color:#000">default_vcpus</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default maximum number of vCPUs per SB/VM:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># unspecified or == 0             --&gt; will be set to the actual number of physical cores or to the maximum number</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#                                     of vCPUs supported by KVM if that number is exceeded</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &gt; 0 &lt;= number of physical cores --&gt; will be set to the specified number</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &gt; number of physical cores      --&gt; will be set to the actual number of physical cores or to the maximum number</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#                                     of vCPUs supported by KVM if that number is exceeded</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># WARNING: Depending of the architecture, the maximum number of vCPUs supported by KVM is used when</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the actual number of physical cores is greater than it.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># WARNING: Be aware that this value impacts the virtual machine&#39;s memory footprint and CPU</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the hotplug functionality. For example, `default_maxvcpus = 240` specifies that until 240 vCPUs</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># can be added to a SB/VM, but the memory footprint will be big. Another example, with</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># `default_maxvcpus = 8` the memory footprint will be small, but 8 will be the maximum number of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># vCPUs supported by the SB/VM. In general, we recommend that you do not edit this variable,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># unless you know what are you doing.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">default_maxvcpus</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Bridges can be used to hot plug devices.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Limitations:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * Currently only pci bridges are supported</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * Until 30 devices per bridge can be hot plugged.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># * Until 5 PCI bridges can be cold plugged per VM.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   This limitation could be a bug in qemu or in the kernel</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default number of bridges per SB/VM:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># unspecified or 0   --&gt; will be set to 1</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &gt; 1 &lt;= 5           --&gt; will be set to the specified number</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &gt; 5                --&gt; will be set to 5</span>
</span></span><span style="display:flex;"><span><span style="color:#000">default_bridges</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default memory size in MiB for SB/VM.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If unspecified then it will be set 2048 MiB.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">default_memory</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2048</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default memory slots per SB/VM.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If unspecified then it will be set 10.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This is will determine the times that memory will be hotadded to sandbox/VM.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#memory_slots = 10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The size in MiB will be plused to max memory of hypervisor.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It is the memory address space for the NVDIMM devie.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If set block storage driver (block_device_driver) to &#34;nvdimm&#34;,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># should set memory_offset to the size of block device.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default 0</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#memory_offset = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Disable block device from being used for a container&#39;s rootfs.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># In case of a storage driver like devicemapper where a container&#39;s</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># root file system is backed by a block device, the block device is passed</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># directly to the hypervisor for performance reasons.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This flag prevents the block device from being passed to the hypervisor,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 9pfs is used instead to pass the rootfs.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">disable_block_device_use</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Shared file system type:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   - virtio-9p (default)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   - virtio-fs</span>
</span></span><span style="display:flex;"><span><span style="color:#000">shared_fs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;virtio-9p&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Path to vhost-user-fs daemon.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">virtio_fs_daemon</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/bin/virtiofsd-x86_64&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default size of DAX cache in MiB</span>
</span></span><span style="display:flex;"><span><span style="color:#000">virtio_fs_cache_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1024</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Cache mode:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  - none</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    Metadata, data, and pathname lookup are not cached in guest. They are</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    always fetched from host and any changes are immediately pushed to host.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  - auto</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    Metadata and pathname lookup cache expires after a configured amount of</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    time (default is 1 second). Data is cached while the file is open (close</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    to open consistency).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#  - always</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#    Metadata, data, and pathname lookup are cached in guest and never expire.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">virtio_fs_cache</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;always&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Block storage driver to be used for the hypervisor in case the container</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># rootfs is backed by a block device. This is virtio-scsi, virtio-blk</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># or nvdimm.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">block_device_driver</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;virtio-scsi&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specifies cache-related options will be set to block devices or not.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#block_device_cache_set = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specifies cache-related options for block devices.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Denotes whether use of O_DIRECT (bypass the host page cache) is enabled.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#block_device_cache_direct = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specifies cache-related options for block devices.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Denotes whether flush requests for the device are ignored.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#block_device_cache_noflush = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Enable iothreads (data-plane) to be used. This causes IO to be</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># handled in a separate IO thread. This is currently only implemented</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># for SCSI.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#000">enable_iothreads</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Enable pre allocation of VM RAM, default false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Enabling this will result in lower container density</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># as all of the memory will be allocated and locked</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This is useful when you want to reserve all the memory</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># upfront or in the cases where you want memory latencies</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to be very predictable</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_mem_prealloc = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Enable huge pages for VM RAM, default false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Enabling this will result in the VM memory</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># being allocated using huge pages.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This is useful when you want to use vhost-user network</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># stacks within the container. This will automatically</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># result in memory pre allocation</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_hugepages = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Enable swap of vm memory. Default false.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The behaviour is undefined if mem_prealloc is also set to true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_swap = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This option changes the default hypervisor and kernel parameters</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to enable debug output where available. This extra output is added</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to the proxy logs, but only when proxy debug is also enabled.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_debug = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Disable the customizations done in the runtime when it detects</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># that it is running on top a VMM. This will result in the runtime</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># behaving as it would when running on bare metal.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#disable_nesting_checks = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This is the msize used for 9p shares. It is the number of bytes</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># used for 9p packet payload.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#msize_9p = 8192</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If true and vsocks are supported, use vsocks to communicate directly</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># with the agent and no proxy is started, otherwise use unix</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># sockets and start a proxy to communicate with the agent.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#use_vsock = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># VFIO devices are hotplugged on a bridge by default.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Enable hotplugging on root bus. This may be required for devices with</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># a large PCI bar, as this is a current limitation with hotplugging on</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># a bridge. This value is valid for &#34;pc&#34; machine type.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#hotplug_vfio_on_root_bus = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If host doesn&#39;t support vhost_net, set to true. Thus we won&#39;t create vhost fds for nics.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#disable_vhost_net = true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default entropy source.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The path to a host source of entropy (including a real hardware RNG)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># /dev/urandom and /dev/random are two main options.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Be aware that /dev/random is a blocking source of entropy.  If the host</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># runs out of entropy, the VMs boot time will increase leading to get startup</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># timeouts.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The source of entropy /dev/urandom is non-blocking and provides a</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># generally acceptable source of entropy. It should work well for pretty much</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># all practical purposes.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#entropy_source= &#34;/dev/urandom&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Path to OCI hook binaries in the *guest rootfs*.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This does not affect host-side hooks which must instead be added to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the OCI spec passed to the runtime.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># You can create a rootfs with hooks by customizing the osbuilder scripts:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># https://github.com/kata-containers/osbuilder</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Hooks must be stored in a subdirectory of guest_hook_path according to their</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># hook type, i.e. &#34;guest_hook_path/{prestart,postart,poststop}&#34;.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The agent will scan these directories for executable files and add them, in</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># lexicographical order, to the lifecycle of the guest container.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Hooks are executed in the runtime namespace of the guest. See the official documentation:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># https://github.com/opencontainers/runtime-spec/blob/v1.0.1/config.md#posix-platform-hooks</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Warnings will be logged if any error is encountered will scanning for hooks,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># but it will not abort container execution.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#guest_hook_path = &#34;/usr/share/oci/hooks&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>factory<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># VM templating support. Once enabled, new VMs are created from template</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># using vm cloning. They will share the same initial kernel, initramfs and</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># agent memory by mapping it readonly. It helps speeding up new container</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># creation and saves a lot of memory if there are many kata containers running</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># on the same host.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># When disabled, new VMs are created from scratch.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note: Requires &#34;initrd=&#34; to be set (&#34;image=&#34; is not supported).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default false</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_template = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specifies the path of template.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default &#34;/run/vc/vm/template&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#template_path = &#34;/run/vc/vm/template&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The number of caches of VMCache:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># unspecified or == 0   --&gt; VMCache is disabled</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># &gt; 0                   --&gt; will be set to the specified number</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># VMCache is a function that creates VMs as caches before using it.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It helps speed up new container creation.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The function consists of a server and some clients communicating</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># through Unix socket.  The protocol is gRPC in protocols/cache/cache.proto.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># The VMCache server will create some VMs and cache them by factory cache.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># It will convert the VM to gRPC format and transport it when gets</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># requestion from clients.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Factory grpccache is the VMCache client.  It will request gRPC format</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># VM and convert it back to a VM.  If VMCache function is enabled,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kata-runtime will request VM from factory grpccache when it creates</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># a new sandbox.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default 0</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#vm_cache_number = 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specify the address of the Unix socket that is used by VMCache.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Default /var/run/kata-containers/cache.sock</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#vm_cache_endpoint = &#34;/var/run/kata-containers/cache.sock&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>proxy.kata<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/libexec/kata-containers/kata-proxy&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If enabled, proxy messages will be sent to the system log</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (default: disabled)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_debug = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>shim.kata<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/libexec/kata-containers/kata-shim&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If enabled, shim messages will be sent to the system log</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (default: disabled)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_debug = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If enabled, the shim will create opentracing.io traces and spans.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (See https://www.jaegertracing.io/docs/getting-started).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Note: By default, the shim runs in a separate network namespace. Therefore,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># to allow it to send trace details to the Jaeger agent running on the host,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># it is necessary to set &#39;disable_new_netns=true&#39; so that it runs in the host</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># network namespace.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (default: disabled)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_tracing = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>agent.kata<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If enabled, make the agent display debug-level messages.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (default: disabled)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_debug = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Enable agent tracing.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If enabled, the default trace mode is &#34;dynamic&#34; and the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># default trace type is &#34;isolated&#34;. The trace mode and type are set</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># explicity with the `trace_type=` and `trace_mode=` options.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Notes:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># - Tracing is ONLY enabled when `enable_tracing` is set: explicitly</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   setting `trace_mode=` and/or `trace_type=` without setting `enable_tracing`</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   will NOT activate agent tracing.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># - See https://github.com/kata-containers/agent/blob/master/TRACING.md for</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   full details.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (default: disabled)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_tracing = true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#trace_mode = &#34;dynamic&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#trace_type = &#34;isolated&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>netmon<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If enabled, the network monitoring process gets started when the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># sandbox is created. This allows for the detection of some additional</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># network being added to the existing network namespace, after the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># sandbox has been created.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (default: disabled)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_netmon = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Specify the path to the netmon binary.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/usr/libexec/kata-containers/kata-netmon&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If enabled, netmon messages will be sent to the system log</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (default: disabled)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_debug = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>runtime<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If enabled, the runtime will log additional debug messages to the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># system log</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (default: disabled)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_debug = true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Internetworking model</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Determines how the VM should be connected to the</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># the container network interface</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Options:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   - bridged</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     Uses a linux bridge to interconnect the container interface to</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     the VM. Works for most cases except macvlan and ipvlan.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   - macvtap</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     Used when the Container network interface can be bridged using</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     macvtap.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   - none</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     Used when customize network. Only creates a tap device. No veth pair.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#   - tcfilter</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     Uses tc filter rules to redirect traffic from the network interface</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#     provided by plugin to a tap interface connected to the VM.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#</span>
</span></span><span style="display:flex;"><span><span style="color:#000">internetworking_model</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;tcfilter&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># disable guest seccomp</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Determines whether container seccomp profiles are passed to the virtual</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># machine and applied by the kata agent. If set to true, seccomp is not applied</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># within the guest</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (default: true)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">disable_guest_seccomp</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If enabled, the runtime will create opentracing.io traces and spans.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (See https://www.jaegertracing.io/docs/getting-started).</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (default: disabled)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#enable_tracing = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If enabled, the runtime will not create a network namespace for shim and hypervisor processes.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># This option may have some potential impacts to your host. It should only be used when you know what you&#39;re doing.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># `disable_new_netns` conflicts with `enable_netmon`</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># `disable_new_netns` conflicts with `internetworking_model=bridged` and `internetworking_model=macvtap`. It works only</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># with `internetworking_model=none`. The tap device will be in the host network namespace and can connect to a bridge</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (like OVS) directly.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># If you are using docker, `disable_new_netns` only works with `docker run --net=none`</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (default: false)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#disable_new_netns = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Enabled experimental feature list, format: [&#34;a&#34;, &#34;b&#34;].</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Experimental features are features not stable enough for production,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># They may break compatibility, and are prepared for a big version bump.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Supported experimental features:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 1. &#34;newstore&#34;: new persist storage driver which breaks backward compatibility,</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#				expected to move out of experimental in 2.0.0.</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (default: [])</span>
</span></span><span style="display:flex;"><span><span style="color:#000">experimental</span><span style="color:#ce5c00;font-weight:bold">=[]</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/kata-containers/runtime#configuration">https://github.com/kata-containers/runtime#configuration</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cba4865f0c62d8a96a9e6684f7ae0c1b">11.5 - GPU</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-12ead326c82e6173f626603c3a12ae76">11.5.1 - nvidia-device-plugin介绍</h1>
    
	<h1 id="1-简介">1. 简介</h1>
<p>NVIDIA device plugin 通过k8s daemonset的方式部署到每个k8s的node节点上，实现了<a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/resource-management/device-plugin.md">Kubernetes device plugin</a>的接口。</p>
<p>提供以下功能：</p>
<ul>
<li>暴露每个节点的GPU数量给集群</li>
<li>跟踪GPU的健康情况</li>
<li>使在k8s的节点可以运行GPU容器</li>
</ul>
<h1 id="2-要求">2. 要求</h1>
<ul>
<li>NVIDIA drivers ~= 384.81</li>
<li>nvidia-docker version &gt; 2.0 (see how to <a href="https://github.com/NVIDIA/nvidia-docker">install</a> and it's <a href="https://github.com/nvidia/nvidia-docker/wiki/Installation-(version-2.0)#prerequisites">prerequisites</a>)</li>
<li>docker configured with nvidia as the <a href="https://github.com/NVIDIA/nvidia-docker/wiki/Advanced-topics#default-runtime">default runtime</a>.</li>
<li>Kubernetes version &gt;= 1.10</li>
</ul>
<h1 id="3-使用">3. 使用</h1>
<h2 id="3-1-安装nvidia-drivers和nvidia-docker">3.1. 安装NVIDIA drivers和nvidia-docker</h2>
<p>提供GPU节点的机器，准备工作如下</p>
<ol>
<li>安装NVIDIA drivers ~= 384.81</li>
<li>安装nvidia-docker version &gt; 2.0</li>
</ol>
<h2 id="3-2-配置docker-runtime">3.2. 配置docker runtime</h2>
<p>配置nvidia runtime作为GPU节点的默认runtime。</p>
<p>修改文件/etc/docker/daemon.json，增加以下runtime内容。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;default-runtime&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;nvidia&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;runtimes&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;nvidia&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;path&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/usr/bin/nvidia-container-runtime&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;runtimeArgs&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-部署nvidia-device-plugin">3.3. 部署nvidia-device-plugin</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl create -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/1.0.0-beta4/nvidia-device-plugin.yml
</span></span></code></pre></div><p>nvidia-device-plugin的daemonset yaml文件如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Copyright (c) 2019, NVIDIA CORPORATION.  All rights reserved.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># you may not use this file except in compliance with the License.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># You may obtain a copy of the License at</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#     http://www.apache.org/licenses/LICENSE-2.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Unless required by applicable law or agreed to in writing, software</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># distributed under the License is distributed on an &#34;AS IS&#34; BASIS,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># See the License for the specific language governing permissions and</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># limitations under the License.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DaemonSet</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nvidia-device-plugin-daemonset</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nvidia-device-plugin-ds</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">updateStrategy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RollingUpdate</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># This annotation is deprecated. Kept here for backward compatibility</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># See https://kubernetes.io/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">scheduler.alpha.kubernetes.io/critical-pod</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nvidia-device-plugin-ds</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">tolerations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># This toleration is deprecated. Kept here for backward compatibility</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># See https://kubernetes.io/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CriticalAddonsOnly</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Exists</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nvidia.com/gpu</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Exists</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">effect</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NoSchedule</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># Mark this pod as a critical add-on; when enabled, the critical add-on</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># scheduler reserves resources for critical add-on pods so that they can</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># be rescheduled after a failure.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># See https://kubernetes.io/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">priorityClassName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;system-node-critical&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nvidia/k8s-device-plugin:1.0.0-beta4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nvidia-device-plugin-ctr</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">securityContext</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">allowPrivilegeEscalation</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">capabilities</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">drop</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;ALL&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">device-plugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/device-plugins</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">device-plugin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">hostPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/lib/kubelet/device-plugins</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="3-4-运行gpu任务">3.4. 运行GPU任务</h2>
<p>创建一个GPU的pod，pod的资源类型指定为<code>nvidia.com/gpu</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">gpu-pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cuda-container</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nvidia/cuda:9.0-devel</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">nvidia.com/gpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># requesting 2 GPUs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">digits-container</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nvidia/digits:6.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">nvidia.com/gpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># requesting 2 GPUs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="4-构建和运行nvidia-device-plugin">4. 构建和运行nvidia-device-plugin</h1>
<h2 id="4-1-docker方式">4.1. docker方式</h2>
<h3 id="4-1-1-编译">4.1.1. 编译</h3>
<ul>
<li>直接拉取dockerhub的镜像</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker pull nvidia/k8s-device-plugin:1.0.0-beta4
</span></span></code></pre></div><ul>
<li>拉取代码构建镜像</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker build -t nvidia/k8s-device-plugin:1.0.0-beta4 https://github.com/NVIDIA/k8s-device-plugin.git#1.0.0-beta4
</span></span></code></pre></div><ul>
<li>修改nvidia-device-plugin后构建镜像</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ git clone https://github.com/NVIDIA/k8s-device-plugin.git <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">cd</span> k8s-device-plugin
</span></span><span style="display:flex;"><span>$ git checkout 1.0.0-beta4
</span></span><span style="display:flex;"><span>$ docker build -t nvidia/k8s-device-plugin:1.0.0-beta4 .
</span></span></code></pre></div><h3 id="4-1-2-运行">4.1.2. 运行</h3>
<ul>
<li>docker本地运行</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ docker run --security-opt<span style="color:#ce5c00;font-weight:bold">=</span>no-new-privileges --cap-drop<span style="color:#ce5c00;font-weight:bold">=</span>ALL --network<span style="color:#ce5c00;font-weight:bold">=</span>none -it -v /var/lib/kubelet/device-plugins:/var/lib/kubelet/device-plugins nvidia/k8s-device-plugin:1.0.0-beta4
</span></span></code></pre></div><ul>
<li>daemonset运行</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl create -f nvidia-device-plugin.yml
</span></span></code></pre></div><h2 id="4-2-非docker方式">4.2. 非docker方式</h2>
<h3 id="4-2-1-编译">4.2.1. 编译</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#000">C_INCLUDE_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/cuda/include <span style="color:#000">LIBRARY_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/cuda/lib64 go build
</span></span></code></pre></div><h3 id="4-2-2-本地运行">4.2.2. 本地运行</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./k8s-device-plugin
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/NVIDIA/k8s-device-plugin">https://github.com/NVIDIA/k8s-device-plugin</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/resource-management/device-plugin.md">k8s-device-plugin</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/resource-management/gpu-support.md">gpu-support</a></li>
</ul>

</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0b0df9b2a3c93389c481d84c8562db2e">12 - Etcd集群</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-790c9f020791536f12a8f4f2e60bb914">12.1 - Etcd介绍</h1>
    
	<h1 id="1-etcd是什么-what">1. Etcd是什么（what）</h1>
<p>etcd is a distributed, consistent key-value store for shared configuration and service discovery, with a focus on being:</p>
<ul>
<li>Secure: automatic TLS with optional client cert authentication[可选的SSL客户端证书认证：支持https访问 ]</li>
<li>Fast: benchmarked 10,000 writes/sec[单实例每秒 1000 次写操作]</li>
<li>Reliable: properly distributed using Raft[使用Raft保证一致性]</li>
</ul>
<p>etcd是一个分布式、一致性的键值存储系统，主要用于配置共享和服务发现。[以上内容来自etcd官网]</p>
<h1 id="2-为什么使用etcd-why">2. 为什么使用Etcd（why）</h1>
<h2 id="2-1-etcd的优势">2.1. Etcd的优势</h2>
<ol>
<li>简单。使用Go语言编写部署简单；使用HTTP作为接口使用简单；使用Raft算法保证强一致性让用户易于理解。</li>
<li>数据持久化。etcd默认数据一更新就进行持久化。</li>
<li>安全。etcd支持SSL客户端安全认证。</li>
</ol>
<h1 id="3-如何实现etcd架构-how">3. 如何实现Etcd架构（how）</h1>
<h2 id="3-1-etcd的相关名词解释">3.1. Etcd的相关名词解释</h2>
<ul>
<li>Raft：etcd所采用的保证分布式系统强一致性的算法。</li>
<li>Node：一个Raft状态机实例。</li>
<li>Member： 一个etcd实例。它管理着一个Node，并且可以为客户端请求提供服务。</li>
<li>Cluster：由多个Member构成可以协同工作的etcd集群。</li>
<li>Peer：对同一个etcd集群中另外一个Member的称呼。</li>
<li>Client： 向etcd集群发送HTTP请求的客户端。</li>
<li>WAL：预写式日志，etcd用于持久化存储的日志格式。</li>
<li>snapshot：etcd防止WAL文件过多而设置的快照，存储etcd数据状态。</li>
<li>Proxy：etcd的一种模式，为etcd集群提供反向代理服务。</li>
<li>Leader：Raft算法中通过竞选而产生的处理所有数据提交的节点。</li>
<li>Follower：竞选失败的节点作为Raft中的从属节点，为算法提供强一致性保证。</li>
<li>Candidate：当Follower超过一定时间接收不到Leader的心跳时转变为Candidate开始竞选。【候选人】</li>
<li>Term：某个节点成为Leader到下一次竞选时间，称为一个Term。【任期】</li>
<li>Index：数据项编号。Raft中通过Term和Index来定位数据。</li>
</ul>
<h2 id="3-2-etcd的架构图">3.2. Etcd的架构图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578532/article/etcd/etcd-architecture.jpg" alt="etcd的架构图"></p>
<p>一个用户的请求发送过来，会经由HTTP Server转发给Store进行具体的事务处理，如果涉及到节点的修改，则交给Raft模块进行状态的变更、日志的记录，然后再同步给别的etcd节点以确认数据提交，最后进行数据的提交，再次同步。</p>
<h2 id="1-http-server">1、HTTP Server:</h2>
<p>用于处理用户发送的API请求以及其它etcd节点的同步与心跳信息请求。</p>
<h2 id="2-raft">2、Raft:</h2>
<p>Raft强一致性算法的具体实现，是etcd的核心。</p>
<h2 id="3-wal">3、WAL:</h2>
<p>Write Ahead Log（预写式日志），是etcd的数据存储方式，用于系统提供原子性和持久性的一系列技术。除了在内存中存有所有数据的状态以及节点的索引以外，etcd就通过WAL进行持久化存储。WAL中，所有的数据提交前都会事先记录日志。</p>
<ol>
<li>
<p>Entry[日志内容]:</p>
<p>负责存储具体日志的内容。</p>
</li>
<li>
<p>Snapshot[快照内容]:</p>
<p>Snapshot是为了防止数据过多而进行的状态快照，日志内容发生变化时保存Raft的状态。</p>
</li>
</ol>
<h2 id="4-store">4、Store:</h2>
<p>用于处理etcd支持的各类功能的事务，包括数据索引、节点状态变更、监控与反馈、事件处理与执行等等，是etcd对用户提供的大多数API功能的具体实现。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2153ad1a70a2192ad6ff5dcb8c29bd49">12.2 - 部署Etcd集群</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-31e195c42dfd9340fbf23dfba270e363">12.2.1 - 使用etcdadm部署Etcd集群</h1>
    
	<h2 id="1-安装etcdadm">1. 安装etcdadm</h2>
<p>在<a href="https://github.com/kubernetes-sigs/etcdadm/releases">Releases · kubernetes-sigs/etcdadm · GitHub</a>中选择需要部署的版本，示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/kubernetes-sigs/etcdadm/releases/download/v0.1.5/etcdadm-linux-amd64
</span></span><span style="display:flex;"><span>mv etcdadm-linux-amd64 /usr/bin/etcdadm
</span></span><span style="display:flex;"><span>chmod +x /usr/bin/etcdadm
</span></span></code></pre></div><h2 id="2-部署etcd集群">2. 部署etcd集群</h2>
<h3 id="2-1-init">2.1. init</h3>
<p>etcd的版本可以在 <a href="https://github.com/etcd-io/etcd/releases">Releases · etcd-io/etcd · GitHub</a> 中查询。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdadm init --name &lt;node1&gt; --version<span style="color:#ce5c00;font-weight:bold">=</span>3.5.4
</span></span></code></pre></div><h3 id="2-2-上传证书到其他机器">2.2. 上传证书到其他机器</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 登录node2 node3</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/etcd/pki
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将node1的/etc/etcd/pki/ca.* 拷贝到node2 node3 /etc/etcd/pki/</span>
</span></span><span style="display:flex;"><span>scp /etc/etcd/pki/ca.* node2:/etc/etcd/pki/
</span></span></code></pre></div><h3 id="2-3-join">2.3. join</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdadm join https://&lt;node1&gt;:2379 --name<span style="color:#ce5c00;font-weight:bold">=</span>&lt;node2&gt; --version<span style="color:#ce5c00;font-weight:bold">=</span>3.5.4
</span></span><span style="display:flex;"><span>etcdadm join https://&lt;node1&gt;:2379 --name<span style="color:#ce5c00;font-weight:bold">=</span>&lt;node3&gt; --version<span style="color:#ce5c00;font-weight:bold">=</span>3.5.4
</span></span></code></pre></div><h2 id="3-查看集群状态">3. 查看集群状态</h2>
<p>设置etcdctl环境变量</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加endpoint</span>
</span></span><span style="display:flex;"><span>cat &gt;&gt; /etc/etcd/etcdctl.env <span style="color:#4e9a06">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">export ETCDCTL_ENDPOINTS=node1:2379,node2:2379,node2:2379
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 拷贝命令脚本到/usr/bin/</span>
</span></span><span style="display:flex;"><span>cp /opt/bin/etcdctl /opt/bin/etcdctl.sh /usr/bin/
</span></span></code></pre></div><p>查看集群状态</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ etcdctl.sh endpoint status -w table
</span></span><span style="display:flex;"><span>+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>      ENDPOINT      <span style="color:#000;font-weight:bold">|</span>        ID        <span style="color:#000;font-weight:bold">|</span> VERSION <span style="color:#000;font-weight:bold">|</span> DB SIZE <span style="color:#000;font-weight:bold">|</span> IS LEADER <span style="color:#000;font-weight:bold">|</span> IS LEARNER <span style="color:#000;font-weight:bold">|</span> RAFT TERM <span style="color:#000;font-weight:bold">|</span> RAFT INDEX <span style="color:#000;font-weight:bold">|</span> RAFT APPLIED INDEX <span style="color:#000;font-weight:bold">|</span> ERRORS <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> node1:2379 <span style="color:#000;font-weight:bold">|</span> 5fe84cb4a0ef4e69 <span style="color:#000;font-weight:bold">|</span>   3.5.4 <span style="color:#000;font-weight:bold">|</span>   <span style="color:#0000cf;font-weight:bold">20</span> kB <span style="color:#000;font-weight:bold">|</span>      <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#204a87">false</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000;font-weight:bold">|</span>                 <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000;font-weight:bold">|</span>        <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> node2:2379 <span style="color:#000;font-weight:bold">|</span> cb8d48da0ea9b8c0 <span style="color:#000;font-weight:bold">|</span>   3.5.4 <span style="color:#000;font-weight:bold">|</span>   <span style="color:#0000cf;font-weight:bold">20</span> kB <span style="color:#000;font-weight:bold">|</span>     <span style="color:#204a87">false</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#204a87">false</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000;font-weight:bold">|</span>                 <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000;font-weight:bold">|</span>        <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> node3:2379 <span style="color:#000;font-weight:bold">|</span> fafa80c55eebeffa <span style="color:#000;font-weight:bold">|</span>   3.5.4 <span style="color:#000;font-weight:bold">|</span>   <span style="color:#0000cf;font-weight:bold">20</span> kB <span style="color:#000;font-weight:bold">|</span>     <span style="color:#204a87">false</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#204a87">false</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000;font-weight:bold">|</span>                 <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000;font-weight:bold">|</span>        <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span></code></pre></div><h2 id="4-etcd启动配置文件">4. Etcd启动配置文件</h2>
<p>systemd service</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cat /etc/systemd/system/etcd.service</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Unit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Description</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd
</span></span><span style="display:flex;"><span><span style="color:#000">Documentation</span><span style="color:#ce5c00;font-weight:bold">=</span>https://github.com/coreos/etcd
</span></span><span style="display:flex;"><span><span style="color:#000">Conflicts</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-member.service
</span></span><span style="display:flex;"><span><span style="color:#000">Conflicts</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd2.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Service<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">EnvironmentFile</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/etcd.env
</span></span><span style="display:flex;"><span><span style="color:#000">ExecStart</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/bin/etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">=</span>notify
</span></span><span style="display:flex;"><span><span style="color:#000">TimeoutStartSec</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Restart</span><span style="color:#ce5c00;font-weight:bold">=</span>on-failure
</span></span><span style="display:flex;"><span><span style="color:#000">RestartSec</span><span style="color:#ce5c00;font-weight:bold">=</span>5s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">LimitNOFILE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">65536</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Nice</span><span style="color:#ce5c00;font-weight:bold">=</span>-10
</span></span><span style="display:flex;"><span><span style="color:#000">IOSchedulingClass</span><span style="color:#ce5c00;font-weight:bold">=</span>best-effort
</span></span><span style="display:flex;"><span><span style="color:#000">IOSchedulingPriority</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#000">MemoryLow</span><span style="color:#ce5c00;font-weight:bold">=</span>200M
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Install<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">WantedBy</span><span style="color:#ce5c00;font-weight:bold">=</span>multi-user.target
</span></span></code></pre></div><p>/etc/etcd/etcd.env</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">ETCD_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd01
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Initial cluster configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_CLUSTER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">etcd01</span><span style="color:#ce5c00;font-weight:bold">=</span>https://node1:2380
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_CLUSTER_TOKEN</span><span style="color:#ce5c00;font-weight:bold">=</span>88ad6def
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_CLUSTER_STATE</span><span style="color:#ce5c00;font-weight:bold">=</span>new
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Peer configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span style="color:#ce5c00;font-weight:bold">=</span>https://node1:2380
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_LISTEN_PEER_URLS</span><span style="color:#ce5c00;font-weight:bold">=</span>https://node1:2380
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_CLIENT_CERT_AUTH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_PEER_CERT_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/pki/peer.crt
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_PEER_KEY_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/pki/peer.key
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_PEER_TRUSTED_CA_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/pki/ca.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Client/server configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_ADVERTISE_CLIENT_URLS</span><span style="color:#ce5c00;font-weight:bold">=</span>https://node1:2379
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_LISTEN_CLIENT_URLS</span><span style="color:#ce5c00;font-weight:bold">=</span>https://node1:2379,https://127.0.0.1:2379
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_PEER_CLIENT_CERT_AUTH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_CERT_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/pki/server.crt
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_KEY_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/pki/server.key
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_TRUSTED_CA_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/pki/ca.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Other</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_DATA_DIR</span><span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/etcd
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_STRICT_RECONFIG_CHECK</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000">GOMAXPROCS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">48</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes-sigs/etcdadm">GitHub - kubernetes-sigs/etcdadm</a></p>
</li>
<li>
<p><a href="https://etcd.io/docs/v3.5/op-guide/clustering/">Clustering Guide | etcd</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8bd6848988eb003ae620bdb956eab247">12.3 - Raft算法</h1>
    
	<h1 id="1-raft协议-分布式一致性算法">1. Raft协议[分布式一致性算法]</h1>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578532/article/etcd/raft.png" alt="raft"></p>
<p>raft算法中涉及三种角色，分别是：</p>
<ul>
<li><code>follower</code>: 跟随者</li>
<li><code>candidate</code>: 候选者，选举过程中的中间状态角色</li>
<li><code>leader</code>: 领导者</li>
</ul>
<h1 id="2-过程">2. 过程</h1>
<h2 id="2-1-选举">2.1. 选举</h2>
<p>有两个timeout来控制选举，第一个是<code>election timeout</code>，该时间是节点从follower到成为candidate的时间，该时间是150到300毫秒之间的随机值。另一个是<code>heartbeat timeout</code>。</p>
<ul>
<li>当某个节点经历完<code>election timeout</code>成为candidate后，开启新的一个选举周期，他向其他节点发起投票请求（Request Vote），如果接收到消息的节点在该周期内还没投过票则给这个candidate投票，然后节点重置他的election timeout。</li>
<li>当该candidate获得大部分的选票，则可以当选为leader。</li>
<li>leader就开始发送<code>append entries</code>给其他follower节点，这个消息会在内部指定的<code>heartbeat timeout</code>时间内发出，follower收到该信息则响应给leader。</li>
<li>这个选举周期会继续，直到某个follower没有收到心跳，并成为candidate。</li>
<li>如果某个选举周期内，有两个candidate同时获得相同多的选票，则会等待一个新的周期重新选举。</li>
</ul>
<h2 id="2-2-同步">2.2. 同步</h2>
<p>当选举过程结束，选出了leader，则leader需要把所有的变更同步的系统中的其他节点，该同步也是通过发送<code>Append Entries</code>的消息的方式。</p>
<ul>
<li>首先一个客户端发送一个更新给leader，这个更新会添加到leader的日志中。</li>
<li>然后leader会在给follower的下次心跳探测中发送该更新。</li>
<li>一旦大多数follower收到这个更新并返回给leader，leader提交这个更新，然后返回给客户端。</li>
</ul>
<h2 id="2-3-网络分区">2.3. 网络分区</h2>
<ul>
<li>当发生网络分区的时候，在不同分区的节点接收不到leader的心跳，则会开启一轮选举，形成不同leader的多个分区集群。</li>
<li>当客户端给不同leader的发送更新消息时，不同分区集群中的节点个数小于原先集群的一半时，更新不会被提交，而节点个数大于集群数一半时，更新会被提交。</li>
<li>当网络分区恢复后，被提交的更新会同步到其他的节点上，其他节点未提交的日志会被回滚并匹配新leader的日志，保证全局的数据是一致的。</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/</a></li>
<li><a href="https://raft.github.io/raft.pdf">https://raft.github.io/raft.pdf</a></li>
<li><a href="https://raft.github.io/">https://raft.github.io/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f59fc1654fa973038724952697876837">12.4 - etcdctl命令工具</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1b0fb3194b02b6bcfc867e444706d68a">12.4.1 - etcdctl-V3</h1>
    
	<blockquote>
<p><code>etcdctl</code>的<code>v3</code>版本与<code>v2</code>版本使用命令有所不同，本文介绍<code>etcdctl v3</code>版本的命令工具的使用方式。</p>
</blockquote>
<h1 id="1-etcdctl的安装">1. etcdctl的安装</h1>
<p><code>etcdctl</code>的二进制文件可以在 <a href="https://github.com/coreos/etcd/releases">github.com/coreos/etcd/releases</a> 选择对应的版本下载，例如可以执行以下<code>install_etcdctl.sh</code>的脚本，修改其中的版本信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ETCD_VER</span><span style="color:#ce5c00;font-weight:bold">=</span>v3.3.4
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_DIR</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-download
</span></span><span style="display:flex;"><span><span style="color:#000">DOWNLOAD_URL</span><span style="color:#ce5c00;font-weight:bold">=</span>https://github.com/coreos/etcd/releases/download
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Download</span>
</span></span><span style="display:flex;"><span>mkdir <span style="color:#4e9a06">${</span><span style="color:#000">ETCD_DIR</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> <span style="color:#4e9a06">${</span><span style="color:#000">ETCD_DIR</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>wget <span style="color:#4e9a06">${</span><span style="color:#000">DOWNLOAD_URL</span><span style="color:#4e9a06">}</span>/<span style="color:#4e9a06">${</span><span style="color:#000">ETCD_VER</span><span style="color:#4e9a06">}</span>/etcd-<span style="color:#4e9a06">${</span><span style="color:#000">ETCD_VER</span><span style="color:#4e9a06">}</span>-linux-amd64.tar.gz 
</span></span><span style="display:flex;"><span>tar -xzvf etcd-<span style="color:#4e9a06">${</span><span style="color:#000">ETCD_VER</span><span style="color:#4e9a06">}</span>-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># install</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> etcd-<span style="color:#4e9a06">${</span><span style="color:#000">ETCD_VER</span><span style="color:#4e9a06">}</span>-linux-amd64
</span></span><span style="display:flex;"><span>cp etcdctl /usr/local/bin/
</span></span></code></pre></div><h1 id="2-etcdctl-v3">2. etcdctl V3</h1>
<p>使用<code>etcdctl</code>v3的版本时，需设置环境变量<code>ETCDCTL_API=3</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或者在`/etc/profile`文件中添加环境变量</span>
</span></span><span style="display:flex;"><span>vi /etc/profile
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#204a87">source</span> /etc/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或者在命令执行前加 ETCDCTL_API=3</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> member list
</span></span></code></pre></div><p>查看当前etcdctl的版本信息<code>etcdctl version</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@k8s-dbg-master-1 etcd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># etcdctl version</span>
</span></span><span style="display:flex;"><span>etcdctl version: 3.3.4
</span></span><span style="display:flex;"><span>API version: 3.3
</span></span></code></pre></div><p>更多命令帮助可以查询<code>etcdctl —help</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@k8s-dbg-master-1 etcd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># etcdctl --help</span>
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>	etcdctl - A simple <span style="color:#204a87">command</span> line client <span style="color:#204a87;font-weight:bold">for</span> etcd3.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>	etcdctl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERSION:
</span></span><span style="display:flex;"><span>	3.3.4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>API VERSION:
</span></span><span style="display:flex;"><span>	3.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>	get			Gets the key or a range of keys
</span></span><span style="display:flex;"><span>	put			Puts the given key into the store
</span></span><span style="display:flex;"><span>	del			Removes the specified key or range of keys <span style="color:#ce5c00;font-weight:bold">[</span>key, range_end<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	txn			Txn processes all the requests in one transaction
</span></span><span style="display:flex;"><span>	compaction		Compacts the event <span style="color:#204a87">history</span> in etcd
</span></span><span style="display:flex;"><span>	alarm disarm		Disarms all alarms
</span></span><span style="display:flex;"><span>	alarm list		Lists all alarms
</span></span><span style="display:flex;"><span>	defrag			Defragments the storage of the etcd members with given endpoints
</span></span><span style="display:flex;"><span>	endpoint health		Checks the healthiness of endpoints specified in <span style="color:#4e9a06">`</span>--endpoints<span style="color:#4e9a06">`</span> flag
</span></span><span style="display:flex;"><span>	endpoint status		Prints out the status of endpoints specified in <span style="color:#4e9a06">`</span>--endpoints<span style="color:#4e9a06">`</span> flag
</span></span><span style="display:flex;"><span>	endpoint hashkv		Prints the KV <span style="color:#204a87">history</span> <span style="color:#204a87">hash</span> <span style="color:#204a87;font-weight:bold">for</span> each endpoint in --endpoints
</span></span><span style="display:flex;"><span>	move-leader		Transfers leadership to another etcd cluster member.
</span></span><span style="display:flex;"><span>	watch			Watches events stream on keys or prefixes
</span></span><span style="display:flex;"><span>	version			Prints the version of etcdctl
</span></span><span style="display:flex;"><span>	lease grant		Creates leases
</span></span><span style="display:flex;"><span>	lease revoke		Revokes leases
</span></span><span style="display:flex;"><span>	lease timetolive	Get lease information
</span></span><span style="display:flex;"><span>	lease list		List all active leases
</span></span><span style="display:flex;"><span>	lease keep-alive	Keeps leases alive <span style="color:#ce5c00;font-weight:bold">(</span>renew<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	member add		Adds a member into the cluster
</span></span><span style="display:flex;"><span>	member remove		Removes a member from the cluster
</span></span><span style="display:flex;"><span>	member update		Updates a member in the cluster
</span></span><span style="display:flex;"><span>	member list		Lists all members in the cluster
</span></span><span style="display:flex;"><span>	snapshot save		Stores an etcd node backend snapshot to a given file
</span></span><span style="display:flex;"><span>	snapshot restore	Restores an etcd member snapshot to an etcd directory
</span></span><span style="display:flex;"><span>	snapshot status		Gets backend snapshot status of a given file
</span></span><span style="display:flex;"><span>	make-mirror		Makes a mirror at the destination etcd cluster
</span></span><span style="display:flex;"><span>	migrate			Migrates keys in a v2 store to a mvcc store
</span></span><span style="display:flex;"><span>	lock			Acquires a named lock
</span></span><span style="display:flex;"><span>	elect			Observes and participates in leader election
</span></span><span style="display:flex;"><span>	auth <span style="color:#204a87">enable</span>		Enables authentication
</span></span><span style="display:flex;"><span>	auth disable		Disables authentication
</span></span><span style="display:flex;"><span>	user add		Adds a new user
</span></span><span style="display:flex;"><span>	user delete		Deletes a user
</span></span><span style="display:flex;"><span>	user get		Gets detailed information of a user
</span></span><span style="display:flex;"><span>	user list		Lists all users
</span></span><span style="display:flex;"><span>	user passwd		Changes password of user
</span></span><span style="display:flex;"><span>	user grant-role		Grants a role to a user
</span></span><span style="display:flex;"><span>	user revoke-role	Revokes a role from a user
</span></span><span style="display:flex;"><span>	role add		Adds a new role
</span></span><span style="display:flex;"><span>	role delete		Deletes a role
</span></span><span style="display:flex;"><span>	role get		Gets detailed information of a role
</span></span><span style="display:flex;"><span>	role list		Lists all roles
</span></span><span style="display:flex;"><span>	role grant-permission	Grants a key to a role
</span></span><span style="display:flex;"><span>	role revoke-permission	Revokes a key from a role
</span></span><span style="display:flex;"><span>	check perf		Check the performance of the etcd cluster
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">help</span>			Help about any <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>      --cacert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>				verify certificates of TLS-enabled secure servers using this CA bundle
</span></span><span style="display:flex;"><span>      --cert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS certificate file
</span></span><span style="display:flex;"><span>      --command-timeout<span style="color:#ce5c00;font-weight:bold">=</span>5s			timeout <span style="color:#204a87;font-weight:bold">for</span> short running <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">(</span>excluding dial timeout<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --debug<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>				<span style="color:#204a87">enable</span> client-side debug logging
</span></span><span style="display:flex;"><span>      --dial-timeout<span style="color:#ce5c00;font-weight:bold">=</span>2s				dial timeout <span style="color:#204a87;font-weight:bold">for</span> client connections
</span></span><span style="display:flex;"><span>  -d, --discovery-srv<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>			domain name to query <span style="color:#204a87;font-weight:bold">for</span> SRV records describing cluster endpoints
</span></span><span style="display:flex;"><span>      --endpoints<span style="color:#ce5c00;font-weight:bold">=[</span>127.0.0.1:2379<span style="color:#ce5c00;font-weight:bold">]</span>		gRPC endpoints
</span></span><span style="display:flex;"><span>      --hex<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>				print byte strings as hex encoded strings
</span></span><span style="display:flex;"><span>      --insecure-discovery<span style="color:#ce5c00;font-weight:bold">[=</span>true<span style="color:#ce5c00;font-weight:bold">]</span>		accept insecure SRV records describing cluster endpoints
</span></span><span style="display:flex;"><span>      --insecure-skip-tls-verify<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>	skip server certificate verification
</span></span><span style="display:flex;"><span>      --insecure-transport<span style="color:#ce5c00;font-weight:bold">[=</span>true<span style="color:#ce5c00;font-weight:bold">]</span>		disable transport security <span style="color:#204a87;font-weight:bold">for</span> client connections
</span></span><span style="display:flex;"><span>      --keepalive-time<span style="color:#ce5c00;font-weight:bold">=</span>2s			keepalive <span style="color:#204a87">time</span> <span style="color:#204a87;font-weight:bold">for</span> client connections
</span></span><span style="display:flex;"><span>      --keepalive-timeout<span style="color:#ce5c00;font-weight:bold">=</span>6s			keepalive timeout <span style="color:#204a87;font-weight:bold">for</span> client connections
</span></span><span style="display:flex;"><span>      --key<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS key file
</span></span><span style="display:flex;"><span>      --user<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					username<span style="color:#ce5c00;font-weight:bold">[</span>:password<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">for</span> authentication <span style="color:#ce5c00;font-weight:bold">(</span>prompt <span style="color:#204a87;font-weight:bold">if</span> password is not supplied<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -w, --write-out<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;simple&#34;</span>			<span style="color:#204a87">set</span> the output format <span style="color:#ce5c00;font-weight:bold">(</span>fields, json, protobuf, simple, table<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="3-etcdctl-常用命令">3. etcdctl 常用命令</h1>
<h2 id="3-1-指定etcd集群">3.1. 指定etcd集群</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">HOST_1</span><span style="color:#ce5c00;font-weight:bold">=</span>10.240.0.17
</span></span><span style="display:flex;"><span><span style="color:#000">HOST_2</span><span style="color:#ce5c00;font-weight:bold">=</span>10.240.0.18
</span></span><span style="display:flex;"><span><span style="color:#000">HOST_3</span><span style="color:#ce5c00;font-weight:bold">=</span>10.240.0.19
</span></span><span style="display:flex;"><span><span style="color:#000">ENDPOINTS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$HOST_1</span>:2379,<span style="color:#000">$HOST_2</span>:2379,<span style="color:#000">$HOST_3</span>:2379
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> member list
</span></span></code></pre></div><p>如果etcd设置了证书访问，则需要添加证书相关参数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> --cacert<span style="color:#ce5c00;font-weight:bold">=</span>&lt;ca-file&gt; --cert<span style="color:#ce5c00;font-weight:bold">=</span>&lt;cert-file&gt; --key<span style="color:#ce5c00;font-weight:bold">=</span>&lt;key-file&gt;  &lt;command&gt;
</span></span></code></pre></div><p>参数说明如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  --cacert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>				verify certificates of TLS-enabled secure servers using this CA bundle
</span></span><span style="display:flex;"><span>  --cert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS certificate file
</span></span><span style="display:flex;"><span>  --key<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS key file
</span></span><span style="display:flex;"><span>  --endpoints<span style="color:#ce5c00;font-weight:bold">=[</span>127.0.0.1:2379<span style="color:#ce5c00;font-weight:bold">]</span>		gRPC endpoints
</span></span></code></pre></div><p>可以自定义alias命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># alias 命令，避免每次需要输入证书参数</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">ectl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;ETCDCTL_API=3 etcdctl --endpoints=$ENDPOINTS --cacert=&lt;ca-file&gt; --cert=&lt;cert-file&gt; --key=&lt;key-file&gt;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 直接使用别名执行命令</span>
</span></span><span style="display:flex;"><span>ectl &lt;command&gt;
</span></span></code></pre></div><h2 id="3-2-增删改查">3.2. 增删改查</h2>
<p><strong>1、增</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put foo <span style="color:#4e9a06">&#34;Hello World!&#34;</span>
</span></span></code></pre></div><p><strong>2、查</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> get foo
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> --write-out<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;json&#34;</span> get foo
</span></span></code></pre></div><p>基于相同前缀查找</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put web1 value1
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put web2 value2
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put web3 value3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> get web --prefix
</span></span></code></pre></div><p>列出所有的key</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> get / --prefix --keys-only
</span></span></code></pre></div><p>3、<strong>删</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put key myvalue
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> del key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put k1 value1
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put k2 value2
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> del k --prefix
</span></span></code></pre></div><h2 id="3-3-集群状态">3.3. 集群状态</h2>
<p>集群状态主要是<code>etcdctl endpoint status</code> 和<code>etcdctl endpoint health</code>两条命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --write-out<span style="color:#ce5c00;font-weight:bold">=</span>table --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> endpoint status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>+------------------+------------------+---------+---------+-----------+-----------+------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>     ENDPOINT     <span style="color:#000;font-weight:bold">|</span>        ID        <span style="color:#000;font-weight:bold">|</span> VERSION <span style="color:#000;font-weight:bold">|</span> DB SIZE <span style="color:#000;font-weight:bold">|</span> IS LEADER <span style="color:#000;font-weight:bold">|</span> RAFT TERM <span style="color:#000;font-weight:bold">|</span> RAFT INDEX <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+------------------+------------------+---------+---------+-----------+-----------+------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> 10.240.0.17:2379 <span style="color:#000;font-weight:bold">|</span> 4917a7ab173fabe7 <span style="color:#000;font-weight:bold">|</span> 3.0.0   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">45</span> kB   <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">true</span>      <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#0000cf;font-weight:bold">16726</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> 10.240.0.18:2379 <span style="color:#000;font-weight:bold">|</span> 59796ba9cd1bcd72 <span style="color:#000;font-weight:bold">|</span> 3.0.0   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">45</span> kB   <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">false</span>     <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#0000cf;font-weight:bold">16726</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> 10.240.0.19:2379 <span style="color:#000;font-weight:bold">|</span> 94df724b66343e6c <span style="color:#000;font-weight:bold">|</span> 3.0.0   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">45</span> kB   <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">false</span>     <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#0000cf;font-weight:bold">16726</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+------------------+------------------+---------+---------+-----------+-----------+------------+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> endpoint health
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>10.240.0.17:2379 is healthy: successfully committed proposal: <span style="color:#000">took</span> <span style="color:#ce5c00;font-weight:bold">=</span> 3.345431ms
</span></span><span style="display:flex;"><span>10.240.0.19:2379 is healthy: successfully committed proposal: <span style="color:#000">took</span> <span style="color:#ce5c00;font-weight:bold">=</span> 3.767967ms
</span></span><span style="display:flex;"><span>10.240.0.18:2379 is healthy: successfully committed proposal: <span style="color:#000">took</span> <span style="color:#ce5c00;font-weight:bold">=</span> 4.025451ms
</span></span></code></pre></div><h2 id="3-4-集群成员">3.4. 集群成员</h2>
<p>跟集群成员相关的命令如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>	member add		    Adds a member into the cluster
</span></span><span style="display:flex;"><span>	member remove		Removes a member from the cluster
</span></span><span style="display:flex;"><span>	member update		Updates a member in the cluster
</span></span><span style="display:flex;"><span>	member list		    Lists all members in the cluster
</span></span></code></pre></div><p>例如 <code>etcdctl member list</code>列出集群成员的命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span>http://172.16.5.4:12379 member list -w table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>+-----------------+---------+-------+------------------------+-----------------------------------------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>       ID        <span style="color:#000;font-weight:bold">|</span> STATUS  <span style="color:#000;font-weight:bold">|</span> NAME  <span style="color:#000;font-weight:bold">|</span>       PEER ADDRS       <span style="color:#000;font-weight:bold">|</span>                 CLIENT ADDRS                  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------------+---------+-------+------------------------+-----------------------------------------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> c856d92a82ba66a <span style="color:#000;font-weight:bold">|</span> started <span style="color:#000;font-weight:bold">|</span> etcd0 <span style="color:#000;font-weight:bold">|</span> http://172.16.5.4:2380 <span style="color:#000;font-weight:bold">|</span> http://172.16.5.4:2379,http://172.16.5.4:4001 <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------------+---------+-------+------------------------+-----------------------------------------------+
</span></span></code></pre></div><h1 id="4-etcdctl-get">4. etcdctl get</h1>
<p>使用<code>etcdctl {command} --help</code>可以查看具体命令的帮助信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># etcdctl get --help</span>
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>	get - Gets the key or a range of keys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>	etcdctl get <span style="color:#ce5c00;font-weight:bold">[</span>options<span style="color:#ce5c00;font-weight:bold">]</span> &lt;key&gt; <span style="color:#ce5c00;font-weight:bold">[</span>range_end<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>      --consistency<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;l&#34;</span>			Linearizable<span style="color:#ce5c00;font-weight:bold">(</span>l<span style="color:#ce5c00;font-weight:bold">)</span> or Serializable<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --from-key<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>		Get keys that are greater than or equal to the given key using byte compare
</span></span><span style="display:flex;"><span>      --keys-only<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>		Get only the keys
</span></span><span style="display:flex;"><span>      --limit<span style="color:#ce5c00;font-weight:bold">=</span>0				Maximum number of results
</span></span><span style="display:flex;"><span>      --order<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>			Order of results<span style="color:#000;font-weight:bold">;</span> ASCEND or DESCEND <span style="color:#ce5c00;font-weight:bold">(</span>ASCEND by default<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --prefix<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>			Get keys with matching prefix
</span></span><span style="display:flex;"><span>      --print-value-only<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>	Only write values when using the <span style="color:#4e9a06">&#34;simple&#34;</span> output format
</span></span><span style="display:flex;"><span>      --rev<span style="color:#ce5c00;font-weight:bold">=</span>0				Specify the kv revision
</span></span><span style="display:flex;"><span>      --sort-by<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>			Sort target<span style="color:#000;font-weight:bold">;</span> CREATE, KEY, MODIFY, VALUE, or VERSION
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GLOBAL OPTIONS:
</span></span><span style="display:flex;"><span>      --cacert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>				verify certificates of TLS-enabled secure servers using this CA bundle
</span></span><span style="display:flex;"><span>      --cert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS certificate file
</span></span><span style="display:flex;"><span>      --command-timeout<span style="color:#ce5c00;font-weight:bold">=</span>5s			timeout <span style="color:#204a87;font-weight:bold">for</span> short running <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">(</span>excluding dial timeout<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --debug<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>				<span style="color:#204a87">enable</span> client-side debug logging
</span></span><span style="display:flex;"><span>      --dial-timeout<span style="color:#ce5c00;font-weight:bold">=</span>2s				dial timeout <span style="color:#204a87;font-weight:bold">for</span> client connections
</span></span><span style="display:flex;"><span>      --endpoints<span style="color:#ce5c00;font-weight:bold">=[</span>127.0.0.1:2379<span style="color:#ce5c00;font-weight:bold">]</span>		gRPC endpoints
</span></span><span style="display:flex;"><span>      --hex<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>				print byte strings as hex encoded strings
</span></span><span style="display:flex;"><span>      --insecure-skip-tls-verify<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>	skip server certificate verification
</span></span><span style="display:flex;"><span>      --insecure-transport<span style="color:#ce5c00;font-weight:bold">[=</span>true<span style="color:#ce5c00;font-weight:bold">]</span>		disable transport security <span style="color:#204a87;font-weight:bold">for</span> client connections
</span></span><span style="display:flex;"><span>      --key<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS key file
</span></span><span style="display:flex;"><span>      --user<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					username<span style="color:#ce5c00;font-weight:bold">[</span>:password<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">for</span> authentication <span style="color:#ce5c00;font-weight:bold">(</span>prompt <span style="color:#204a87;font-weight:bold">if</span> password is not supplied<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -w, --write-out<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;simple&#34;</span>			<span style="color:#204a87">set</span> the output format <span style="color:#ce5c00;font-weight:bold">(</span>fields, json, protobuf, simple, table<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>文章参考：</p>
<p><a href="https://coreos.com/etcd/docs/latest/demo.html">https://coreos.com/etcd/docs/latest/demo.html</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5ffa00ab05d9d30dfcd302587e50d29c">12.4.2 - etcdctl-V2</h1>
    
	<h1 id="1-etcdctl介绍">1. etcdctl介绍</h1>
<p>etcdctl是一个命令行的客户端，它提供了一下简洁的命令，可理解为命令工具集，可以方便我们在对服务进行测试或者手动修改数据库内容。etcdctl与其他xxxctl的命令原理及操作类似（例如kubectl，systemctl）。</p>
<p>用法：etcdctl [global options] command [command options][args...]</p>
<h1 id="2-etcd常用命令">2. Etcd常用命令</h1>
<h2 id="2-1-数据库操作命令">2.1. 数据库操作命令</h2>
<p>etcd 在键的组织上采用了层次化的空间结构（类似于文件系统中目录的概念），数据库操作围绕对键值和目录的 CRUD [增删改查]（符合 REST 风格的一套操作：Create, Read, Update, Delete）完整生命周期的管理。</p>
<p>具体的命令选项参数可以通过 etcdctl command --help来获取相关帮助。</p>
<h2 id="2-1-1-对象为键值">2.1.1. 对象为键值</h2>
<ol>
<li>
<h3 id="set-增-无论是否存在-etcdctl-set-key-value">set[增:无论是否存在]:etcdctl set key value</h3>
</li>
<li>
<h3 id="mk-增-必须不存在-etcdctl-mk-key-value">mk[增:必须不存在]:etcdctl mk key value</h3>
</li>
<li>
<h3 id="rm-删-etcdctl-rm-key">rm[删]:etcdctl rm key</h3>
</li>
<li>
<h3 id="update-改-etcdctl-update-key-value">update[改]:etcdctl update key value</h3>
</li>
<li>
<h3 id="get-查-etcdctl-get-key">get[查]:etcdctl get key</h3>
</li>
</ol>
<h2 id="2-1-2-对象为目录">2.1.2. 对象为目录</h2>
<ol>
<li>
<h3 id="setdir-增-无论是否存在-etcdctl-setdir-dir">setdir[增:无论是否存在]:etcdctl setdir dir</h3>
</li>
<li>
<h3 id="mkdir-增-必须不存在-etcdctl-mkdir-dir">mkdir[增:必须不存在]: etcdctl mkdir dir</h3>
</li>
<li>
<h3 id="rmdir-删-etcdctl-rmdir-dir">rmdir[删]:etcdctl rmdir dir</h3>
</li>
<li>
<h3 id="updatedir-改-etcdctl-updatedir-dir">updatedir[改]:etcdctl updatedir dir</h3>
</li>
<li>
<h3 id="ls-查-etcdclt-ls">ls[查]:etcdclt ls</h3>
</li>
</ol>
<h2 id="2-2-非数据库操作命令">2.2. 非数据库操作命令</h2>
<ol>
<li>
<h3 id="backup-备份-etcd-的数据">backup[备份 etcd 的数据]</h3>
<p>etcdctl backup</p>
</li>
<li>
<h3 id="watch-监测一个键值的变化-一旦键值发生更新-就会输出最新的值并退出">watch[监测一个键值的变化，一旦键值发生更新，就会输出最新的值并退出]</h3>
<p>etcdctl watch key</p>
</li>
<li>
<h3 id="exec-watch-监测一个键值的变化-一旦键值发生更新-就执行给定命令">exec-watch[监测一个键值的变化，一旦键值发生更新，就执行给定命令]</h3>
<p>etcdctl exec-watch key --sh -c &quot;ls&quot;</p>
</li>
<li>
<h3 id="member-通过-list-add-remove-update-命令列出-添加-删除-更新etcd-实例到-etcd-集群中">member[通过 list、add、remove、update 命令列出、添加、删除 、更新etcd 实例到 etcd 集群中]</h3>
<p>etcdctl member list；etcdctl member add 实例；etcdctl member remove 实例；etcdctl member update 实例。</p>
</li>
<li>
<h3 id="etcdctl-cluster-health-检查集群健康状态">etcdctl cluster-health[检查集群健康状态]</h3>
</li>
</ol>
<h2 id="2-3-常用配置参数">2.3. 常用配置参数</h2>
<p>设置配置文件，默认为/etc/etcd/etcd.conf。</p>
<table>
<thead>
<tr>
<th>配置参数</th>
<th>参数说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>配置参数</td>
<td>参数说明</td>
</tr>
<tr>
<td>-name</td>
<td>节点名称</td>
</tr>
<tr>
<td>-data-dir</td>
<td>保存日志和快照的目录，默认为当前工作目录，指定节点的数据存储目录</td>
</tr>
<tr>
<td>-addr</td>
<td>公布的ip地址和端口。 默认为127.0.0.1:2379</td>
</tr>
<tr>
<td>-bind-addr</td>
<td>用于客户端连接的监听地址，默认为-addr配置</td>
</tr>
<tr>
<td>-peers</td>
<td>集群成员逗号分隔的列表，例如 127.0.0.1:2380,127.0.0.1:2381</td>
</tr>
<tr>
<td>-peer-addr</td>
<td>集群服务通讯的公布的IP地址，默认为 127.0.0.1:2380.</td>
</tr>
<tr>
<td>-peer-bind-addr</td>
<td>集群服务通讯的监听地址，默认为-peer-addr配置</td>
</tr>
<tr>
<td>-wal-dir</td>
<td>指定节点的was文件的存储目录，若指定了该参数，wal文件会和其他数据文件分开存储</td>
</tr>
<tr>
<td>-listen-client-urls</td>
<td></td>
</tr>
<tr>
<td>-listen-peer-urls</td>
<td>监听URL，用于与其他节点通讯</td>
</tr>
<tr>
<td>-initial-advertise-peer-urls</td>
<td>告知集群其他节点url.</td>
</tr>
<tr>
<td>-advertise-client-urls</td>
<td>告知客户端url, 也就是服务的url</td>
</tr>
<tr>
<td>-initial-cluster-token</td>
<td>集群的ID</td>
</tr>
<tr>
<td>-initial-cluster</td>
<td>集群中所有节点</td>
</tr>
<tr>
<td>-initial-cluster-state</td>
<td>-initial-cluster-state=new 表示从无到有搭建etcd集群</td>
</tr>
<tr>
<td>-discovery-srv</td>
<td>用于DNS动态服务发现，指定DNS SRV域名</td>
</tr>
<tr>
<td>-discovery</td>
<td>用于etcd动态发现，指定etcd发现服务的URL [https://discovery.etcd.io/],用环境变量表示</td>
</tr>
</tbody>
</table>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d37dcd0642e22e58b477424b99aae67a">12.5 - Etcd访问控制</h1>
    
	<h1 id="1-etcd资源类型">1. ETCD资源类型</h1>
<p>There are three types of resources in etcd</p>
<ul>
<li><code>permission resources</code>: users and roles in the user store</li>
<li><code>key-value resources</code>: key-value pairs in the key-value store</li>
<li><code>settings resources</code>: security settings, auth settings, and dynamic etcd cluster settings (election/heartbeat)</li>
</ul>
<h1 id="2-权限资源">2. 权限资源</h1>
<p><strong>Users</strong>：user用来设置身份认证（user：passwd），一个用户可以拥有多个角色，每个角色被分配一定的权限（只读、只写、可读写），用户分为root用户和非root用户。</p>
<p><strong>Roles</strong>：角色用来关联权限，角色主要三类：root角色。默认创建root用户时即创建了root角色，该角色拥有所有权限；guest角色，默认自动创建，主要用于非认证使用。普通角色，由root用户创建角色，并分配指定权限。</p>
<p>注意：如果没有指定任何验证方式，即没显示指定以什么用户进行访问，那么默认会设定为 guest 角色。默认情况下 guest 也是具有全局访问权限的。如果不希望未授权就获取或修改etcd的数据，则可收回guest角色的权限或删除该角色，etcdctl role revoke 。</p>
<p><strong>Permissions</strong>:权限分为只读、只写、可读写三种权限，权限即对指定目录或key的读写权限。</p>
<h1 id="3-etcd访问控制">3. ETCD访问控制</h1>
<h2 id="3-1-访问控制相关命令">3.1. 访问控制相关命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   etcdctl - A simple <span style="color:#204a87">command</span> line client <span style="color:#204a87;font-weight:bold">for</span> etcd.
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   etcdctl <span style="color:#ce5c00;font-weight:bold">[</span>global options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>VERSION:
</span></span><span style="display:flex;"><span>   2.2.0
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   user         user add, grant and revoke subcommands
</span></span><span style="display:flex;"><span>   role         role add, grant and revoke subcommands
</span></span><span style="display:flex;"><span>   auth         overall auth controls  
</span></span><span style="display:flex;"><span>GLOBAL OPTIONS:
</span></span><span style="display:flex;"><span>   --peers, -C          a comma-delimited list of machine addresses in the cluster <span style="color:#ce5c00;font-weight:bold">(</span>default: <span style="color:#4e9a06">&#34;http://127.0.0.1:4001,http://127.0.0.1:2379&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   --endpoint           a comma-delimited list of machine addresses in the cluster <span style="color:#ce5c00;font-weight:bold">(</span>default: <span style="color:#4e9a06">&#34;http://127.0.0.1:4001,http://127.0.0.1:2379&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   --cert-file          identify HTTPS client using this SSL certificate file
</span></span><span style="display:flex;"><span>   --key-file           identify HTTPS client using this SSL key file
</span></span><span style="display:flex;"><span>   --ca-file            verify certificates of HTTPS-enabled servers using this CA bundle
</span></span><span style="display:flex;"><span>   --username, -u       provide username<span style="color:#ce5c00;font-weight:bold">[</span>:password<span style="color:#ce5c00;font-weight:bold">]</span> and prompt <span style="color:#204a87;font-weight:bold">if</span> password is not supplied.
</span></span><span style="display:flex;"><span>   --timeout <span style="color:#4e9a06">&#39;1s&#39;</span>       connection timeout per request
</span></span></code></pre></div><h2 id="3-2-user相关命令">3.2. user相关命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@localhost etcd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># etcdctl user --help</span>
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   etcdctl user - user add, grant and revoke subcommands
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   etcdctl user <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   add      add a new user <span style="color:#204a87;font-weight:bold">for</span> the etcd cluster
</span></span><span style="display:flex;"><span>   get      get details <span style="color:#204a87;font-weight:bold">for</span> a user
</span></span><span style="display:flex;"><span>   list     list all current users
</span></span><span style="display:flex;"><span>   remove   remove a user <span style="color:#204a87;font-weight:bold">for</span> the etcd cluster
</span></span><span style="display:flex;"><span>   grant    grant roles to an etcd user
</span></span><span style="display:flex;"><span>   revoke   revoke roles <span style="color:#204a87;font-weight:bold">for</span> an etcd user
</span></span><span style="display:flex;"><span>   passwd   change password <span style="color:#204a87;font-weight:bold">for</span> a user
</span></span><span style="display:flex;"><span>   help, h  Shows a list of commands or <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> one <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --help, -h   show <span style="color:#204a87">help</span>
</span></span></code></pre></div><h2 id="3-2-1-添加root用户并设置密码">3.2.1. 添加root用户并设置密码</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> user add root</p>
<h2 id="3-2-2-添加非root用户并设置密码">3.2.2. 添加非root用户并设置密码</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 user add huwh</p>
<h2 id="3-2-3-查看当前所有用户">3.2.3. 查看当前所有用户</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 user list</p>
<h2 id="3-2-4-将用户添加到对应角色">3.2.4. 将用户添加到对应角色</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 user grant --roles test1 phpor</p>
<h2 id="3-2-5-查看用户拥有哪些角色">3.2.5. 查看用户拥有哪些角色</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 user get phpor</p>
<h2 id="3-3-role相关命令">3.3. role相关命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@localhost etcd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># etcdctl role --help</span>
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   etcdctl role - role add, grant and revoke subcommands
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   etcdctl role <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   add      add a new role <span style="color:#204a87;font-weight:bold">for</span> the etcd cluster
</span></span><span style="display:flex;"><span>   get      get details <span style="color:#204a87;font-weight:bold">for</span> a role
</span></span><span style="display:flex;"><span>   list     list all roles
</span></span><span style="display:flex;"><span>   remove   remove a role from the etcd cluster
</span></span><span style="display:flex;"><span>   grant    grant path matches to an etcd role
</span></span><span style="display:flex;"><span>   revoke   revoke path matches <span style="color:#204a87;font-weight:bold">for</span> an etcd role
</span></span><span style="display:flex;"><span>   help, h  Shows a list of commands or <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> one <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --help, -h   show <span style="color:#204a87">help</span>
</span></span></code></pre></div><h2 id="3-3-1-添加角色">3.3.1. 添加角色</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:2379 role add test1</p>
<h2 id="3-3-2-查看所有角色">3.3.2. 查看所有角色</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 role list</p>
<h2 id="3-3-3-给角色分配权限">3.3.3. 给角色分配权限</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@localhost etcd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># etcdctl role grant --help</span>
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   grant - grant path matches to an etcd role
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   <span style="color:#204a87">command</span> grant <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --path   Path granted <span style="color:#204a87;font-weight:bold">for</span> the role to access
</span></span><span style="display:flex;"><span>   --read   Grant read-only access
</span></span><span style="display:flex;"><span>   --write  Grant write-only access
</span></span><span style="display:flex;"><span>   --readwrite  Grant read-write access
</span></span></code></pre></div><p>1、只包含目录
etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 role grant --readwrite --path /test1 test1</p>
<p>2、包括目录和子目录或文件
etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 role grant --readwrite --path /test1/* test1</p>
<h2 id="3-3-4-查看角色所拥有的权限">3.3.4. 查看角色所拥有的权限</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:2379 role get test1</p>
<h2 id="3-4-auth相关操作">3.4. auth相关操作</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@localhost etcd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># etcdctl auth --help</span>
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   etcdctl auth - overall auth controls
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   etcdctl auth <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   <span style="color:#204a87">enable</span>   <span style="color:#204a87">enable</span> auth access controls
</span></span><span style="display:flex;"><span>   disable  disable auth access controls
</span></span><span style="display:flex;"><span>   help, h  Shows a list of commands or <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> one <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --help, -h   show <span style="color:#204a87">help</span>
</span></span></code></pre></div><h2 id="3-4-1-开启认证">3.4.1. 开启认证</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> auth enable</p>
<h1 id="4-访问控制设置步骤">4. 访问控制设置步骤</h1>
<table>
<thead>
<tr>
<th>顺序</th>
<th>步骤</th>
<th>命令</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>添加root用户</td>
<td>etcdctl --endpoints http://<ip>:<port> user add root</td>
</tr>
<tr>
<td>2</td>
<td>开启认证</td>
<td>etcdctl --endpoints http://<ip>:<port> auth enable</td>
</tr>
<tr>
<td>3</td>
<td>添加非root用户</td>
<td>etcdctl --endpoints http://<ip>:<port> –username root:<passwd> user add <user></td>
</tr>
<tr>
<td>4</td>
<td>添加角色</td>
<td>etcdctl --endpoints http://<ip>:<port> –username root:<passwd> role add <role></td>
</tr>
<tr>
<td>5</td>
<td>给角色授权（只读、只写、可读写）</td>
<td>etcdctl --endpoints http://<ip>:<port> –username root:<passwd> role grant --readwrite --path <path> <role></td>
</tr>
<tr>
<td>6</td>
<td>给用户分配角色（即分配了角色对应的权限）</td>
<td>etcdctl --endpoints http://<ip>:<port> –username root:<passwd> user grant --roles <role> <user></td>
</tr>
</tbody>
</table>
<h1 id="5-访问认证的api调用">5. 访问认证的API调用</h1>
<p>更多参考</p>
<ul>
<li>
<p><a href="https://coreos.com/etcd/docs/latest/v2/auth_api.html">https://coreos.com/etcd/docs/latest/v2/auth_api.html</a></p>
</li>
<li>
<p><a href="https://coreos.com/etcd/docs/latest/v2/authentication.html">https://coreos.com/etcd/docs/latest/v2/authentication.html</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b579ae1cd3d66837e46a7cfa1d995677">12.6 - Etcd启动配置参数</h1>
    
	<h1 id="1-etcd配置参数">1. Etcd配置参数</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/ <span style="color:#8f5902;font-style:italic"># etcd --help</span>
</span></span><span style="display:flex;"><span>usage: etcd <span style="color:#ce5c00;font-weight:bold">[</span>flags<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>       start an etcd server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       etcd --version
</span></span><span style="display:flex;"><span>       show the version of etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       etcd -h <span style="color:#000;font-weight:bold">|</span> --help
</span></span><span style="display:flex;"><span>       show the <span style="color:#204a87">help</span> information about etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       etcd --config-file
</span></span><span style="display:flex;"><span>       path to the server configuration file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       etcd gateway
</span></span><span style="display:flex;"><span>       run the stateless pass-through etcd TCP connection forwarding proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       etcd grpc-proxy
</span></span><span style="display:flex;"><span>       run the stateless etcd v3 gRPC L7 reverse proxy
</span></span></code></pre></div><h2 id="1-1-member-flags">1.1. member flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>member flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	--name <span style="color:#4e9a06">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>		human-readable name <span style="color:#204a87;font-weight:bold">for</span> this member.
</span></span><span style="display:flex;"><span>	--data-dir <span style="color:#4e9a06">&#39;${name}.etcd&#39;</span>
</span></span><span style="display:flex;"><span>		path to the data directory.
</span></span><span style="display:flex;"><span>	--wal-dir <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the dedicated wal directory.
</span></span><span style="display:flex;"><span>	--snapshot-count <span style="color:#4e9a06">&#39;100000&#39;</span>
</span></span><span style="display:flex;"><span>		number of committed transactions to trigger a snapshot to disk.
</span></span><span style="display:flex;"><span>	--heartbeat-interval <span style="color:#4e9a06">&#39;100&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> of a heartbeat interval.
</span></span><span style="display:flex;"><span>	--election-timeout <span style="color:#4e9a06">&#39;1000&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> an election to timeout. See tuning documentation <span style="color:#204a87;font-weight:bold">for</span> details.
</span></span><span style="display:flex;"><span>	--initial-election-tick-advance <span style="color:#4e9a06">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>		whether to fast-forward initial election ticks on boot <span style="color:#204a87;font-weight:bold">for</span> faster election.
</span></span><span style="display:flex;"><span>	--listen-peer-urls <span style="color:#4e9a06">&#39;http://localhost:2380&#39;</span>
</span></span><span style="display:flex;"><span>		list of URLs to listen on <span style="color:#204a87;font-weight:bold">for</span> peer traffic.
</span></span><span style="display:flex;"><span>	--listen-client-urls <span style="color:#4e9a06">&#39;http://localhost:2379&#39;</span>
</span></span><span style="display:flex;"><span>		list of URLs to listen on <span style="color:#204a87;font-weight:bold">for</span> client traffic.
</span></span><span style="display:flex;"><span>	--max-snapshots <span style="color:#4e9a06">&#39;5&#39;</span>
</span></span><span style="display:flex;"><span>		maximum number of snapshot files to retain <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> is unlimited<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--max-wals <span style="color:#4e9a06">&#39;5&#39;</span>
</span></span><span style="display:flex;"><span>		maximum number of wal files to retain <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> is unlimited<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--cors <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		comma-separated whitelist of origins <span style="color:#204a87;font-weight:bold">for</span> CORS <span style="color:#ce5c00;font-weight:bold">(</span>cross-origin resource sharing<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--quota-backend-bytes <span style="color:#4e9a06">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span>		raise alarms when backend size exceeds the given quota <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> defaults to low space quota<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--max-txn-ops <span style="color:#4e9a06">&#39;128&#39;</span>
</span></span><span style="display:flex;"><span>		maximum number of operations permitted in a transaction.
</span></span><span style="display:flex;"><span>	--max-request-bytes <span style="color:#4e9a06">&#39;1572864&#39;</span>
</span></span><span style="display:flex;"><span>		maximum client request size in bytes the server will accept.
</span></span><span style="display:flex;"><span>	--grpc-keepalive-min-time <span style="color:#4e9a06">&#39;5s&#39;</span>
</span></span><span style="display:flex;"><span>		minimum duration interval that a client should <span style="color:#204a87">wait</span> before pinging server.
</span></span><span style="display:flex;"><span>	--grpc-keepalive-interval <span style="color:#4e9a06">&#39;2h&#39;</span>
</span></span><span style="display:flex;"><span>		frequency duration of server-to-client ping to check <span style="color:#204a87;font-weight:bold">if</span> a connection is alive <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> to disable<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--grpc-keepalive-timeout <span style="color:#4e9a06">&#39;20s&#39;</span>
</span></span><span style="display:flex;"><span>		additional duration of <span style="color:#204a87">wait</span> before closing a non-responsive connection <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> to disable<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span></code></pre></div><h2 id="1-2-clustering-flags">1.2. clustering flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>clustering flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	--initial-advertise-peer-urls <span style="color:#4e9a06">&#39;http://localhost:2380&#39;</span>
</span></span><span style="display:flex;"><span>		list of this member<span style="color:#4e9a06">&#39;s peer URLs to advertise to the rest of the cluster.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">	--initial-cluster &#39;</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>http://localhost:2380<span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">		initial cluster configuration for bootstrapping.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">	--initial-cluster-state &#39;</span>new<span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">		initial cluster state (&#39;</span>new<span style="color:#4e9a06">&#39; or &#39;</span>existing<span style="color:#4e9a06">&#39;).
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">	--initial-cluster-token &#39;</span>etcd-cluster<span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">		initial cluster token for the etcd cluster during bootstrap.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">		Specifying this can protect you from unintended cross-cluster interaction when running multiple clusters.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">	--advertise-client-urls &#39;</span>http://localhost:2379<span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">		list of this member&#39;</span>s client URLs to advertise to the public.
</span></span><span style="display:flex;"><span>		The client URLs advertised should be accessible to machines that talk to etcd cluster. etcd client libraries parse these URLs to connect to the cluster.
</span></span><span style="display:flex;"><span>	--discovery <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		discovery URL used to bootstrap the cluster.
</span></span><span style="display:flex;"><span>	--discovery-fallback <span style="color:#4e9a06">&#39;proxy&#39;</span>
</span></span><span style="display:flex;"><span>		expected behavior <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;exit&#39;</span> or <span style="color:#4e9a06">&#39;proxy&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span> when discovery services fails.
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;proxy&#34;</span> supports v2 API only.
</span></span><span style="display:flex;"><span>	--discovery-proxy <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		HTTP proxy to use <span style="color:#204a87;font-weight:bold">for</span> traffic to discovery service.
</span></span><span style="display:flex;"><span>	--discovery-srv <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		dns srv domain used to bootstrap the cluster.
</span></span><span style="display:flex;"><span>	--strict-reconfig-check <span style="color:#4e9a06">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>		reject reconfiguration requests that would cause quorum loss.
</span></span><span style="display:flex;"><span>	--auto-compaction-retention <span style="color:#4e9a06">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span>		auto compaction retention length. <span style="color:#0000cf;font-weight:bold">0</span> means disable auto compaction.
</span></span><span style="display:flex;"><span>	--auto-compaction-mode <span style="color:#4e9a06">&#39;periodic&#39;</span>
</span></span><span style="display:flex;"><span>		interpret <span style="color:#4e9a06">&#39;auto-compaction-retention&#39;</span> one of: periodic<span style="color:#000;font-weight:bold">|</span>revision. <span style="color:#4e9a06">&#39;periodic&#39;</span> <span style="color:#204a87;font-weight:bold">for</span> duration based retention, defaulting to hours <span style="color:#204a87;font-weight:bold">if</span> no <span style="color:#204a87">time</span> unit is provided <span style="color:#ce5c00;font-weight:bold">(</span>e.g. <span style="color:#4e9a06">&#39;5m&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>. <span style="color:#4e9a06">&#39;revision&#39;</span> <span style="color:#204a87;font-weight:bold">for</span> revision number based retention.
</span></span><span style="display:flex;"><span>	--enable-v2 <span style="color:#4e9a06">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>		Accept etcd V2 client requests.
</span></span></code></pre></div><h2 id="1-3-proxy-flags">1.3. proxy flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>proxy flags:
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;proxy&#34;</span> supports v2 API only.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	--proxy <span style="color:#4e9a06">&#39;off&#39;</span>
</span></span><span style="display:flex;"><span>		proxy mode setting <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;off&#39;</span>, <span style="color:#4e9a06">&#39;readonly&#39;</span> or <span style="color:#4e9a06">&#39;on&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--proxy-failure-wait <span style="color:#0000cf;font-weight:bold">5000</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> an endpoint will be held in a failed state.
</span></span><span style="display:flex;"><span>	--proxy-refresh-interval <span style="color:#0000cf;font-weight:bold">30000</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> of the endpoints refresh interval.
</span></span><span style="display:flex;"><span>	--proxy-dial-timeout <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> a dial to timeout.
</span></span><span style="display:flex;"><span>	--proxy-write-timeout <span style="color:#0000cf;font-weight:bold">5000</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> a write to timeout.
</span></span><span style="display:flex;"><span>	--proxy-read-timeout <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> a <span style="color:#204a87">read</span> to timeout.
</span></span></code></pre></div><h2 id="1-4-security-flags">1.4. security flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>security flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	--ca-file <span style="color:#4e9a06">&#39;&#39;</span> <span style="color:#ce5c00;font-weight:bold">[</span>DEPRECATED<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		path to the client server TLS CA file. <span style="color:#4e9a06">&#39;-ca-file ca.crt&#39;</span> could be replaced by <span style="color:#4e9a06">&#39;-trusted-ca-file ca.crt -client-cert-auth&#39;</span> and etcd will perform the same.
</span></span><span style="display:flex;"><span>	--cert-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the client server TLS cert file.
</span></span><span style="display:flex;"><span>	--key-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the client server TLS key file.
</span></span><span style="display:flex;"><span>	--client-cert-auth <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">enable</span> client cert authentication.
</span></span><span style="display:flex;"><span>	--client-crl-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the client certificate revocation list file.
</span></span><span style="display:flex;"><span>	--trusted-ca-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the client server TLS trusted CA cert file.
</span></span><span style="display:flex;"><span>	--auto-tls <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		client TLS using generated certificates.
</span></span><span style="display:flex;"><span>	--peer-ca-file <span style="color:#4e9a06">&#39;&#39;</span> <span style="color:#ce5c00;font-weight:bold">[</span>DEPRECATED<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		path to the peer server TLS CA file. <span style="color:#4e9a06">&#39;-peer-ca-file ca.crt&#39;</span> could be replaced by <span style="color:#4e9a06">&#39;-peer-trusted-ca-file ca.crt -peer-client-cert-auth&#39;</span> and etcd will perform the same.
</span></span><span style="display:flex;"><span>	--peer-cert-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the peer server TLS cert file.
</span></span><span style="display:flex;"><span>	--peer-key-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the peer server TLS key file.
</span></span><span style="display:flex;"><span>	--peer-client-cert-auth <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">enable</span> peer client cert authentication.
</span></span><span style="display:flex;"><span>	--peer-trusted-ca-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the peer server TLS trusted CA file.
</span></span><span style="display:flex;"><span>	--peer-auto-tls <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		peer TLS using self-generated certificates <span style="color:#204a87;font-weight:bold">if</span> --peer-key-file and --peer-cert-file are not provided.
</span></span><span style="display:flex;"><span>	--peer-crl-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the peer certificate revocation list file.
</span></span></code></pre></div><h2 id="1-5-logging-flags">1.5. logging flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>logging flags
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	--debug <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">enable</span> debug-level logging <span style="color:#204a87;font-weight:bold">for</span> etcd.
</span></span><span style="display:flex;"><span>	--log-package-levels <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		specify a particular log level <span style="color:#204a87;font-weight:bold">for</span> each etcd package <span style="color:#ce5c00;font-weight:bold">(</span>eg: <span style="color:#4e9a06">&#39;etcdmain=CRITICAL,etcdserver=DEBUG&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--log-output <span style="color:#4e9a06">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>		specify <span style="color:#4e9a06">&#39;stdout&#39;</span> or <span style="color:#4e9a06">&#39;stderr&#39;</span> to skip journald logging even when running under systemd.
</span></span></code></pre></div><h2 id="1-6-unsafe-flags">1.6. unsafe flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>unsafe flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please be CAUTIOUS when using unsafe flags because it will <span style="color:#204a87">break</span> the guarantees
</span></span><span style="display:flex;"><span>given by the consensus protocol.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	--force-new-cluster <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		force to create a new one-member cluster.
</span></span></code></pre></div><h2 id="1-7-profiling-flags">1.7. profiling flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>profiling flags:
</span></span><span style="display:flex;"><span>	--enable-pprof <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		Enable runtime profiling data via HTTP server. Address is at client URL + <span style="color:#4e9a06">&#34;/debug/pprof/&#34;</span>
</span></span><span style="display:flex;"><span>	--metrics <span style="color:#4e9a06">&#39;basic&#39;</span>
</span></span><span style="display:flex;"><span>		Set level of detail <span style="color:#204a87;font-weight:bold">for</span> exported metrics, specify <span style="color:#4e9a06">&#39;extensive&#39;</span> to include histogram metrics.
</span></span><span style="display:flex;"><span>	--listen-metrics-urls <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		List of URLs to listen on <span style="color:#204a87;font-weight:bold">for</span> metrics.
</span></span></code></pre></div><h2 id="1-8-auth-flags">1.8. auth flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>auth flags:
</span></span><span style="display:flex;"><span>	--auth-token <span style="color:#4e9a06">&#39;simple&#39;</span>
</span></span><span style="display:flex;"><span>		Specify a v3 authentication token <span style="color:#204a87">type</span> and its options <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;simple&#39;</span> or <span style="color:#4e9a06">&#39;jwt&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span></code></pre></div><h2 id="1-9-experimental-flags">1.9. experimental flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>experimental flags:
</span></span><span style="display:flex;"><span>	--experimental-initial-corrupt-check <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">enable</span> to check data corruption before serving any client/peer traffic.
</span></span><span style="display:flex;"><span>	--experimental-corrupt-check-time <span style="color:#4e9a06">&#39;0s&#39;</span>
</span></span><span style="display:flex;"><span>		duration of <span style="color:#204a87">time</span> between cluster corruption check passes.
</span></span><span style="display:flex;"><span>	--experimental-enable-v2v3 <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		serve v2 requests through the v3 backend under a given prefix.
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f0607d0d7eaa382cf2171ad2fb4c6485">12.7 - Etcd中的k8s数据</h1>
    
	<h1 id="1-读取数据key">1. 读取数据key</h1>
<p>使用以下命令列出所有的key。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span>&lt;etcd-ip-1&gt;:2379,&lt;etcd-ip-2&gt;:2379,&lt;etcd-ip-3&gt;:2379 --cacert<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/pki/etcd/ca.crt  --key<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/pki/apiserver-etcd-client.key  --cert<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/pki/apiserver-etcd-client.crt get / --prefix --keys-only
</span></span></code></pre></div><p>参数说明：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  --cacert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>				verify certificates of TLS-enabled secure servers using this CA bundle
</span></span><span style="display:flex;"><span>  --cert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS certificate file
</span></span><span style="display:flex;"><span>  --key<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS key file
</span></span><span style="display:flex;"><span>  --endpoints<span style="color:#ce5c00;font-weight:bold">=[</span>127.0.0.1:2379<span style="color:#ce5c00;font-weight:bold">]</span>		gRPC endpoints
</span></span></code></pre></div><p>可以使用alias来重命名etcdctl一串的命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">ectl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;ETCDCTL_API=3 etcdctl --endpoints=&lt;etcd-ip-1&gt;:2379,&lt;etcd-ip-2&gt;:2379,&lt;etcd-ip-3&gt;:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt  --key=/etc/kubernetes/pki/apiserver-etcd-client.key  --cert=/etc/kubernetes/pki/apiserver-etcd-client.crt&#39;</span>
</span></span></code></pre></div><h1 id="2-集群数据">2. 集群数据</h1>
<h2 id="2-1-node">2.1. node</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/minions/&lt;node-ip-1&gt;
</span></span><span style="display:flex;"><span>/registry/minions/&lt;node-ip-2&gt;
</span></span><span style="display:flex;"><span>/registry/minions/&lt;node-ip-3&gt;
</span></span></code></pre></div><p>其他信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/leases/kube-node-lease/&lt;node-ip-1&gt;
</span></span><span style="display:flex;"><span>/registry/leases/kube-node-lease/&lt;node-ip-2&gt;
</span></span><span style="display:flex;"><span>/registry/leases/kube-node-lease/&lt;node-ip-3&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/registry/masterleases/&lt;node-ip-2&gt;
</span></span><span style="display:flex;"><span>/registry/masterleases/&lt;node-ip-3&gt;
</span></span></code></pre></div><h1 id="3-k8s对象数据">3. k8s对象数据</h1>
<p>k8s对象数据的格式</p>
<h2 id="3-1-namespace">3.1. namespace</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/namespaces/default
</span></span><span style="display:flex;"><span>/registry/namespaces/game
</span></span><span style="display:flex;"><span>/registry/namespaces/kube-node-lease
</span></span><span style="display:flex;"><span>/registry/namespaces/kube-public
</span></span><span style="display:flex;"><span>/registry/namespaces/kube-system
</span></span></code></pre></div><h2 id="3-2-namespace级别对象">3.2. namespace级别对象</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/<span style="color:#ce5c00;font-weight:bold">{</span>resource<span style="color:#ce5c00;font-weight:bold">}</span>/<span style="color:#ce5c00;font-weight:bold">{</span>namespace<span style="color:#ce5c00;font-weight:bold">}</span>/<span style="color:#ce5c00;font-weight:bold">{</span>resource_name<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下以常见k8s对象为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># deployment</span>
</span></span><span style="display:flex;"><span>/registry/deployments/default/game-2048
</span></span><span style="display:flex;"><span>/registry/deployments/kube-system/prometheus-operator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># replicasets</span>
</span></span><span style="display:flex;"><span>/registry/replicasets/default/game-2048-c7d589ccf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pod</span>
</span></span><span style="display:flex;"><span>/registry/pods/default/game-2048-c7d589ccf-8lsbw
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># statefulsets</span>
</span></span><span style="display:flex;"><span>/registry/statefulsets/kube-system/prometheus-k8s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># daemonsets</span>
</span></span><span style="display:flex;"><span>/registry/daemonsets/kube-system/kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># secrets</span>
</span></span><span style="display:flex;"><span>/registry/secrets/default/default-token-tbfmb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># serviceaccounts</span>
</span></span><span style="display:flex;"><span>/registry/serviceaccounts/default/default
</span></span></code></pre></div><p><strong>service</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># service</span>
</span></span><span style="display:flex;"><span>/registry/services/specs/default/game-2048
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># endpoints</span>
</span></span><span style="display:flex;"><span>/registry/services/endpoints/default/game-2048
</span></span></code></pre></div><h1 id="4-读取数据value">4. 读取数据value</h1>
<p>由于k8s默认etcd中的数据是通过protobuf格式存储，因此看到的key和value的值是一串字符串。</p>
<blockquote>
<p>alias ectl='ETCDCTL_API=3 etcdctl --endpoints=<etcd-ip-1>:2379,<etcd-ip-2>:2379,<etcd-ip-3>:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt  --key=/etc/kubernetes/pki/apiserver-etcd-client.key  --cert=/etc/kubernetes/pki/apiserver-etcd-client.crt'</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ectl get /registry/namespaces/test -w json |jq</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;header&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;cluster_id&#34;</span>: 12113422651334595000,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;member_id&#34;</span>: 8381627376898157000,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;revision&#34;</span>: 12321629,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;raft_term&#34;</span>: <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;kvs&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;L3JlZ2lzdHJ5L25hbWVzcGFjZXMvdGVzdA==&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;create_revision&#34;</span>: 11670741,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;mod_revision&#34;</span>: 11670741,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;version&#34;</span>: 1,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;value&#34;</span>: <span style="color:#4e9a06">&#34;azhzAAoPCgJ2MRIJTmFtZXNwYWNlElwKQgoEdGVzdBIAGgAiACokYWM1YmJjOTQtNTkxZi0xMWVhLWJiOTQtNmM5MmJmM2I3NmI1MgA4AEIICJuf3fIFEAB6ABIMCgprdWJlcm5ldGVzGggKBkFjdGl2ZRoAIgA=&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;count&#34;</span>: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中key可以通过base64解码出来</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;L3JlZ2lzdHJ5L25hbWVzcGFjZXMvdGVzdA==&#34;</span> <span style="color:#000;font-weight:bold">|</span> base64 --decode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># output</span>
</span></span><span style="display:flex;"><span>/registry/namespaces/test
</span></span></code></pre></div><p>value是值可以通过安装<a href="https://github.com/openshift/origin/tree/master/tools/etcdhelper">etcdhelper</a>工具解析出来。</p>
<blockquote>
<p>alias ehelper='etcdhelper -key /etc/kubernetes/pki/apiserver-etcd-client.key -cert /etc/kubernetes/pki/apiserver-etcd-client.crt -cacert /etc/kubernetes/pki/etcd/ca.crt'</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ehelper get /registry/namespaces/test</span>
</span></span><span style="display:flex;"><span>/v1, <span style="color:#000">Kind</span><span style="color:#ce5c00;font-weight:bold">=</span>Namespace
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;kind&#34;</span>: <span style="color:#4e9a06">&#34;Namespace&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;apiVersion&#34;</span>: <span style="color:#4e9a06">&#34;v1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;metadata&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;name&#34;</span>: <span style="color:#4e9a06">&#34;test&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;uid&#34;</span>: <span style="color:#4e9a06">&#34;ac5bbc94-591f-11ea-bb94-6c92bf3b76b5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;creationTimestamp&#34;</span>: <span style="color:#4e9a06">&#34;2020-02-27T05:11:55Z&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;spec&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;finalizers&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;status&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;phase&#34;</span>: <span style="color:#4e9a06">&#34;Active&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-注意事项">5. 注意事项</h1>
<ul>
<li>由于k8s的etcd数据为了性能考虑，默认通过<code>protobuf</code>格式存储，不要通过手动的方式去修改或添加k8s数据。</li>
<li>不推荐使用json格式存储etcd数据，如果需要json格式，可以使用<code>--storage-media-type=application/json</code>参数存储，参考：https://github.com/kubernetes/kubernetes/issues/44670</li>
</ul>
<h1 id="6-快捷命令">6. 快捷命令</h1>
<p>由于etcdctl的命令需要添加很多认证参数和endpoints的参数，因此可以使用别名的方式来简化命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># etcdctl </span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">ectl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;ETCDCTL_API=3 etcdctl --endpoints=&lt;etcd-ip-1&gt;:2379,&lt;etcd-ip-2&gt;:2379,&lt;etcd-ip-3&gt;:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt  --key=/etc/kubernetes/pki/apiserver-etcd-client.key  --cert=/etc/kubernetes/pki/apiserver-etcd-client.crt&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># etcdhelper</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">ehelper</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;etcdhelper -key /etc/kubernetes/pki/apiserver-etcd-client.key -cert /etc/kubernetes/pki/apiserver-etcd-client.crt -cacert /etc/kubernetes/pki/etcd/ca.crt&#39;</span>
</span></span></code></pre></div><h2 id="6-1-etcdhelper的使用">6.1. etcdhelper的使用</h2>
<p><code>etcdhelper</code>文档参考：https://github.com/openshift/origin/tree/master/tools/etcdhelper</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 必要的认证参数</span>
</span></span><span style="display:flex;"><span>-key - points to master.etcd-client.key
</span></span><span style="display:flex;"><span>-cert - points to master.etcd-client.crt
</span></span><span style="display:flex;"><span>-cacert - points to ca.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 命令操作参数</span>
</span></span><span style="display:flex;"><span>ls - list all keys starting with prefix
</span></span><span style="display:flex;"><span>get - get the specific value of a key
</span></span><span style="display:flex;"><span>dump - dump the entire contents of the etcd
</span></span></code></pre></div><p>示例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ehelper ls /registry/leases/
</span></span><span style="display:flex;"><span>/registry/leases/kube-node-lease/&lt;ip-1&gt;
</span></span><span style="display:flex;"><span>/registry/leases/kube-node-lease/&lt;ip-2&gt;
</span></span><span style="display:flex;"><span>/registry/leases/kube-node-lease/&lt;ip-3&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ehelper get &lt;key&gt;
</span></span></code></pre></div><h1 id="7-rbac">7. RBAC</h1>
<p>附RBAC相关的key。</p>
<p><strong>clusterrolebindings</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/clusterrolebindings/cluster-admin
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/flannel
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/galaxy
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/helm
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/kube-state-metrics
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/kubeadm:kubelet-bootstrap
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/kubeadm:node-autoapprove-bootstrap
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/kubeadm:node-autoapprove-certificate-rotation
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/kubeadm:node-proxier
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/lbcf-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/prometheus-k8s
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/prometheus-operator
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:aws-cloud-provider
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:basic-user
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:attachdetach-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:certificate-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:clusterrole-aggregation-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:cronjob-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:daemon-set-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:deployment-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:disruption-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:endpoint-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:expand-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:generic-garbage-collector
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:horizontal-pod-autoscaler
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:job-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:namespace-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:node-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:persistent-volume-binder
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:pod-garbage-collector
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:pv-protection-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:pvc-protection-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:replicaset-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:replication-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:resourcequota-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:route-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:service-account-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:service-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:statefulset-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:ttl-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:coredns
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:discovery
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:kube-controller-manager
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:kube-dns
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:kube-scheduler
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:node
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:node-proxier
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:public-info-viewer
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:volume-scheduler
</span></span></code></pre></div><p><strong>clusterroles</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/clusterroles/admin
</span></span><span style="display:flex;"><span>/registry/clusterroles/cluster-admin
</span></span><span style="display:flex;"><span>/registry/clusterroles/edit
</span></span><span style="display:flex;"><span>/registry/clusterroles/flannel
</span></span><span style="display:flex;"><span>/registry/clusterroles/kube-state-metrics
</span></span><span style="display:flex;"><span>/registry/clusterroles/lbcf-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/prometheus-k8s
</span></span><span style="display:flex;"><span>/registry/clusterroles/prometheus-operator
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:aggregate-to-admin
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:aggregate-to-edit
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:aggregate-to-view
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:auth-delegator
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:aws-cloud-provider
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:basic-user
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:certificates.k8s.io:certificatesigningrequests:nodeclient
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:attachdetach-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:certificate-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:clusterrole-aggregation-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:cronjob-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:daemon-set-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:deployment-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:disruption-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:endpoint-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:expand-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:generic-garbage-collector
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:horizontal-pod-autoscaler
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:job-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:namespace-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:node-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:persistent-volume-binder
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:pod-garbage-collector
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:pv-protection-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:pvc-protection-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:replicaset-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:replication-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:resourcequota-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:route-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:service-account-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:service-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:statefulset-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:ttl-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:coredns
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:csi-external-attacher
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:csi-external-provisioner
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:discovery
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:heapster
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:kube-aggregator
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:kube-controller-manager
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:kube-dns
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:kube-scheduler
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:kubelet-api-admin
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:node
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:node-bootstrapper
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:node-problem-detector
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:node-proxier
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:persistent-volume-provisioner
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:public-info-viewer
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:volume-scheduler
</span></span><span style="display:flex;"><span>/registry/clusterroles/view
</span></span></code></pre></div><p><strong>rolebindings</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/rolebindings/kube-public/kubeadm:bootstrap-signer-clusterinfo
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-public/system:controller:bootstrap-signer
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/kube-proxy
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/kube-state-metrics
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/kubeadm:kubeadm-certs
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/kubeadm:kubelet-config-1.14
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/kubeadm:nodes-kubeadm-config
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/system::extension-apiserver-authentication-reader
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/system::leader-locking-kube-controller-manager
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/system::leader-locking-kube-scheduler
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/system:controller:bootstrap-signer
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/system:controller:cloud-provider
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/system:controller:token-cleaner
</span></span></code></pre></div><p><strong>roles</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/roles/kube-public/kubeadm:bootstrap-signer-clusterinfo
</span></span><span style="display:flex;"><span>/registry/roles/kube-public/system:controller:bootstrap-signer
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/extension-apiserver-authentication-reader
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/kube-proxy
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/kube-state-metrics-resizer
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/kubeadm:kubeadm-certs
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/kubeadm:kubelet-config-1.14
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/kubeadm:nodes-kubeadm-config
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/system::leader-locking-kube-controller-manager
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/system::leader-locking-kube-scheduler
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/system:controller:bootstrap-signer
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/system:controller:cloud-provider
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/system:controller:token-cleaner
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/etcd-io/etcd/tree/master/etcdctl">https://github.com/etcd-io/etcd/tree/master/etcdctl</a></li>
<li><a href="https://github.com/openshift/origin/tree/master/tools/etcdhelper">https://github.com/openshift/origin/tree/master/tools/etcdhelper</a></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/guide/using-etcdctl-to-access-kubernetes-data.html">using-etcdctl-to-access-kubernetes-data</a></li>
<li><a href="https://int32bit.me/2019/12/01/%E5%A6%82%E4%BD%95%E8%AF%BB%E5%8F%96Kubernetes%E5%AD%98%E5%82%A8%E5%9C%A8etcd%E4%B8%8A%E7%9A%84%E6%95%B0%E6%8D%AE/">如何读取Kubernetes存储在etcd上的数据</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/issues/44670">https://github.com/kubernetes/kubernetes/issues/44670</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-71893bf7906a4195ee237a3f2ab53af1">12.8 - etcd-operator的使用</h1>
    
	<blockquote>
<p>本文主要介绍etcd-operator的部署及使用</p>
</blockquote>
<h1 id="1-部署rbac">1. 部署RBAC</h1>
<p>下载<a href="https://github.com/coreos/etcd-operator/blob/master/example/rbac/create_role.sh">create_role.sh</a>、<a href="https://github.com/coreos/etcd-operator/blob/master/example/rbac/cluster-role-binding-template.yaml">cluster-role-binding-template.yaml</a>、<a href="https://github.com/coreos/etcd-operator/blob/master/example/rbac/cluster-role-template.yaml">cluster-role-template.yaml</a></p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- cluster-role-binding-template.yaml
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- cluster-role-template.yaml
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- create_role.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 部署rbac</span>
</span></span><span style="display:flex;"><span>kubectl create ns operator
</span></span><span style="display:flex;"><span>bash create_role.sh --namespace<span style="color:#ce5c00;font-weight:bold">=</span>operator  <span style="color:#8f5902;font-style:italic"># namespace与etcd-operator的ns一致</span>
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bash create_role.sh --namespace<span style="color:#ce5c00;font-weight:bold">=</span>operator
</span></span><span style="display:flex;"><span>+ <span style="color:#000">ROLE_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-operator
</span></span><span style="display:flex;"><span>+ <span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-operator
</span></span><span style="display:flex;"><span>+ <span style="color:#000">NAMESPACE</span><span style="color:#ce5c00;font-weight:bold">=</span>default
</span></span><span style="display:flex;"><span>+ <span style="color:#204a87;font-weight:bold">for</span> i in <span style="color:#4e9a06">&#39;&#34;$@&#34;&#39;</span>
</span></span><span style="display:flex;"><span>+ <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">$i</span> in
</span></span><span style="display:flex;"><span>+ <span style="color:#000">NAMESPACE</span><span style="color:#ce5c00;font-weight:bold">=</span>operator
</span></span><span style="display:flex;"><span>+ <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;Creating role with ROLE_NAME=etcd-operator, NAMESPACE=operator&#39;</span>
</span></span><span style="display:flex;"><span>Creating role with <span style="color:#000">ROLE_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-operator, <span style="color:#000">NAMESPACE</span><span style="color:#ce5c00;font-weight:bold">=</span>operator
</span></span><span style="display:flex;"><span>+ sed -e <span style="color:#4e9a06">&#39;s/&lt;ROLE_NAME&gt;/etcd-operator/g&#39;</span> -e <span style="color:#4e9a06">&#39;s/&lt;NAMESPACE&gt;/operator/g&#39;</span> cluster-role-template.yaml
</span></span><span style="display:flex;"><span>+ kubectl create -f -
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/etcd-operator created
</span></span><span style="display:flex;"><span>+ <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;Creating role binding with ROLE_NAME=etcd-operator, ROLE_BINDING_NAME=etcd-operator, NAMESPACE=operator&#39;</span>
</span></span><span style="display:flex;"><span>Creating role binding with <span style="color:#000">ROLE_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-operator, <span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-operator, <span style="color:#000">NAMESPACE</span><span style="color:#ce5c00;font-weight:bold">=</span>operator
</span></span><span style="display:flex;"><span>+ sed -e <span style="color:#4e9a06">&#39;s/&lt;ROLE_NAME&gt;/etcd-operator/g&#39;</span> -e <span style="color:#4e9a06">&#39;s/&lt;ROLE_BINDING_NAME&gt;/etcd-operator/g&#39;</span> -e <span style="color:#4e9a06">&#39;s/&lt;NAMESPACE&gt;/operator/g&#39;</span> cluster-role-binding-template.yaml
</span></span><span style="display:flex;"><span>+ kubectl create -f -
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/etcd-operator created
</span></span></code></pre></div><h2 id="1-1-create-role-sh-脚本">1.1. create_role.sh 脚本</h2>
<p>create_role.sh有三个入参，可以指定--namespace参数，该参数与etcd-operator部署的namespace应一致。默认为default。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -o errexit
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> -o nounset
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> -o pipefail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_OPERATOR_ROOT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>dirname <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">BASH_SOURCE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">)</span>/../..
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print_usage<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>basename <span style="color:#4e9a06">&#34;</span><span style="color:#000">$0</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06"> - Create Kubernetes RBAC role and role bindings for etcd-operator
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Usage: </span><span style="color:#204a87;font-weight:bold">$(</span>basename <span style="color:#4e9a06">&#34;</span><span style="color:#000">$0</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06"> [options...]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Options:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --role-name=STRING         Name of ClusterRole to create
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                               (default=\&#34;etcd-operator\&#34;, environment variable: ROLE_NAME)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --role-binding-name=STRING Name of ClusterRoleBinding to create
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                               (default=\&#34;etcd-operator\&#34;, environment variable: ROLE_BINDING_NAME)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --namespace=STRING         namespace to create role and role binding in. Must already exist.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                               (default=\&#34;default\&#34;, environment variable: NAMESPACE)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> &gt;<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ROLE_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_NAME</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">etcd</span><span style="color:#000;font-weight:bold">-operator</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">etcd</span><span style="color:#000;font-weight:bold">-operator</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">NAMESPACE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">NAMESPACE</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">default</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> i in <span style="color:#4e9a06">&#34;</span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">$i</span> in
</span></span><span style="display:flex;"><span>    --role-name<span style="color:#ce5c00;font-weight:bold">=</span>*<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ROLE_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">#*=</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>    --role-binding-name<span style="color:#ce5c00;font-weight:bold">=</span>*<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">#*=</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>    --namespace<span style="color:#ce5c00;font-weight:bold">=</span>*<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">NAMESPACE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">#*=</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>    -h<span style="color:#000;font-weight:bold">|</span>--help<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      print_usage
</span></span><span style="display:flex;"><span>      <span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>    *<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      print_usage
</span></span><span style="display:flex;"><span>      <span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">esac</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Creating role with ROLE_NAME=</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, NAMESPACE=</span><span style="color:#4e9a06">${</span><span style="color:#000">NAMESPACE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>sed -e <span style="color:#4e9a06">&#34;s/&lt;ROLE_NAME&gt;/</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/g&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -e <span style="color:#4e9a06">&#34;s/&lt;NAMESPACE&gt;/</span><span style="color:#4e9a06">${</span><span style="color:#000">NAMESPACE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/g&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">&#34;cluster-role-template.yaml&#34;</span> <span style="color:#000;font-weight:bold">|</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  kubectl create -f -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Creating role binding with ROLE_NAME=</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, ROLE_BINDING_NAME=</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, NAMESPACE=</span><span style="color:#4e9a06">${</span><span style="color:#000">NAMESPACE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>sed -e <span style="color:#4e9a06">&#34;s/&lt;ROLE_NAME&gt;/</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/g&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -e <span style="color:#4e9a06">&#34;s/&lt;ROLE_BINDING_NAME&gt;/</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/g&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -e <span style="color:#4e9a06">&#34;s/&lt;NAMESPACE&gt;/</span><span style="color:#4e9a06">${</span><span style="color:#000">NAMESPACE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/g&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">&#34;cluster-role-binding-template.yaml&#34;</span> <span style="color:#000;font-weight:bold">|</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  kubectl create -f -
</span></span></code></pre></div><h2 id="1-2-cluster-role-binding-template-yaml">1.2. cluster-role-binding-template.yaml</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;ROLE_BINDING_NAME&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;ROLE_NAME&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;NAMESPACE&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="1-3-cluster-role-template-yaml">1.3. cluster-role-template.yaml</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;ROLE_NAME&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">etcd.database.coreos.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">etcdclusters</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">etcdbackups</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">etcdrestores</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">apiextensions.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">customresourcedefinitions</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">pods</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">services</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">endpoints</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">persistentvolumeclaims</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">events</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">apps</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">deployments</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># The following permissions can be removed if not using S3 backup and TLS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="2-部署etcd-operator">2. 部署etcd-operator</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create -f etcd-operator.yaml
</span></span></code></pre></div><p>etcd-operator.yaml如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">operator  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 与rbac指定的ns一致</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">registry.cn-shenzhen.aliyuncs.com/huweihuang/etcd-operator:v0.9.4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">etcd-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># Uncomment to act for resources in all namespaces. More information in doc/user/clusterwide.md</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- -<span style="color:#000">cluster-wide</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MY_POD_NAMESPACE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">valueFrom</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">fieldRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">fieldPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metadata.namespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MY_POD_NAME</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">valueFrom</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">fieldRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">fieldPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metadata.name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>查看CRD</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#kubectl get customresourcedefinitions</span>
</span></span><span style="display:flex;"><span>NAME                                       CREATED AT
</span></span><span style="display:flex;"><span>etcdclusters.etcd.database.coreos.com      2020-08-01T13:02:18Z
</span></span></code></pre></div><p>查看etcd-operator的日志是否OK。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>k logs -f etcd-operator-545df8d445-qpf6n -n operator
</span></span><span style="display:flex;"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2020-08-01T13:02:18Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;etcd-operator Version: 0.9.4&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2020-08-01T13:02:18Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Git SHA: c8a1c64&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2020-08-01T13:02:18Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Go Version: go1.11.5&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2020-08-01T13:02:18Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Go OS/Arch: linux/amd64&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2020-08-01T13:02:18Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Event(v1.ObjectReference{Kind:\&#34;Endpoints\&#34;, Namespace:\&#34;operator\&#34;, Name:\&#34;etcd-operator\&#34;, UID:\&#34;7de38cff-1b7b-4bf2-9837-473fa66c9366\&#34;, APIVersion:\&#34;v1\&#34;, ResourceVersion:\&#34;41195930\&#34;, FieldPath:\&#34;\&#34;}): type: &#39;Normal&#39; reason: &#39;LeaderElection&#39; etcd-operator-545df8d445-qpf6n became leader&#34;</span>
</span></span></code></pre></div><p>以上内容表示etcd-operator运行正常。</p>
<h1 id="3-部署etcd集群">3. 部署etcd集群</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create -f etcd-cluster.yaml
</span></span></code></pre></div><blockquote>
<p>当开启clusterwide则etcd集群与etcd-operator的ns可不同。</p>
</blockquote>
<p>etcd-cluster.yaml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;etcd.database.coreos.com/v1beta2&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;EtcdCluster&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;default-etcd-cluster&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">## Adding this annotation make this cluster managed by clusterwide operators</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">## namespaced operators ignore it</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd.database.coreos.com/scope</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clusterwide</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 此处的ns表示etcd集群部署在哪个ns下</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;v3.3.18&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repository</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">registry.cn-shenzhen.aliyuncs.com/huweihuang/etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pod</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">busyboxImage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">registry.cn-shenzhen.aliyuncs.com/huweihuang/busybox:1.28.0-glibc</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>查看集群部署结果</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kgpo -n etcd
</span></span><span style="display:flex;"><span>NAME                              READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>default-etcd-cluster-b6phnpf8z8   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          3m3s
</span></span><span style="display:flex;"><span>default-etcd-cluster-hhgq4sbtgr   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          109s
</span></span><span style="display:flex;"><span>default-etcd-cluster-ttfh5fj92b   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          2m29s
</span></span></code></pre></div><h1 id="4-访问etcd集群">4. 访问etcd集群</h1>
<p>查看service</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kgsvc -n etcd
</span></span><span style="display:flex;"><span>NAME                          TYPE        CLUSTER-IP        EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>             AGE
</span></span><span style="display:flex;"><span>default-etcd-cluster          ClusterIP   None              &lt;none&gt;        2379/TCP,2380/TCP   5m37s
</span></span><span style="display:flex;"><span>default-etcd-cluster-client   ClusterIP   192.168.255.244   &lt;none&gt;        2379/TCP            5m37s
</span></span></code></pre></div><p>使用service地址访问</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看集群健康状态</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> etcdctl --endpoints 192.168.255.244:2379 endpoint health
</span></span><span style="display:flex;"><span>192.168.255.244:2379 is healthy: successfully committed proposal: <span style="color:#000">took</span> <span style="color:#ce5c00;font-weight:bold">=</span> 1.96126ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 写数据</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> etcdctl --endpoints 192.168.255.244:2379 put foo bar
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 读数据</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> etcdctl --endpoints 192.168.255.244:2379 get foo
</span></span><span style="display:flex;"><span>foo
</span></span><span style="display:flex;"><span>bar
</span></span></code></pre></div><h1 id="5-销毁etcd-operator">5. 销毁etcd-operator</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl delete -f example/deployment.yaml
</span></span><span style="display:flex;"><span>kubectl delete endpoints etcd-operator
</span></span><span style="display:flex;"><span>kubectl delete crd etcdclusters.etcd.database.coreos.com
</span></span><span style="display:flex;"><span>kubectl delete clusterrole etcd-operator
</span></span><span style="display:flex;"><span>kubectl delete clusterrolebinding etcd-operator
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/coreos/etcd-operator">https://github.com/coreos/etcd-operator</a></li>
<li><a href="https://github.com/coreos/etcd-operator/blob/master/doc/user/install_guide.md">https://github.com/coreos/etcd-operator/blob/master/doc/user/install_guide.md</a></li>
<li><a href="https://github.com/coreos/etcd-operator/blob/master/doc/user/client_service.md">https://github.com/coreos/etcd-operator/blob/master/doc/user/client_service.md</a></li>
<li><a href="https://github.com/coreos/etcd-operator/blob/master/doc/user/spec_examples.md">https://github.com/coreos/etcd-operator/blob/master/doc/user/spec_examples.md</a></li>
<li><a href="https://github.com/coreos/etcd-operator/blob/master/doc/user/cluster_tls.md">https://github.com/coreos/etcd-operator/blob/master/doc/user/cluster_tls.md</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1d30deba06eddecda47c5dae6b467635">13 - 多集群管理</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0fae2b50f9bdb013eab3a200dc8b2e9a">13.1 - k8s多集群管理的思考</h1>
    
	<h1 id="k8s多集群的思考">k8s多集群的思考</h1>
<h1 id="1-为什么需要多集群">1. 为什么需要多集群</h1>
<p><strong>1、k8s单集群的承载能力有限。</strong></p>
<p>Kubernetes v1.21 支持的最大节点数为 5000。 更具体地说，Kubernetes旨在适应满足以下<em>所有</em>标准的配置：</p>
<ul>
<li>每个节点的 Pod 数量不超过 100</li>
<li>节点数不超过 5000</li>
<li>Pod 总数不超过 150000</li>
<li>容器总数不超过 300000</li>
</ul>
<blockquote>
<p>参考：https://kubernetes.io/zh/docs/setup/best-practices/cluster-large/</p>
</blockquote>
<p>且当节点数量较大时，会出现调度延迟，etcd读写延迟，apiserver负载高等问题，影响服务的正常创建。</p>
<p><strong>2、分散集群服务风险。</strong></p>
<p>全部服务都放在一个k8s集群中，当该集群出现异常，短期无法恢复的情况下，则影响全部服务和影响部署。为了避免机房等故障导致单集群异常，建议将k8s的master在分散在延迟较低的不同可用区部署，且在不同region部署多个k8s集群来进行集群级别的容灾。</p>
<p><strong>3、当前混合云的使用方式和架构</strong></p>
<p>当前部分公司会存在自建机房+不同云厂商的公有云从而来实现混部云的运营模式，那么自然会引入多集群管理的问题。</p>
<h1 id="2-多集群部署需要解决哪些问题">2. 多集群部署需要解决哪些问题</h1>
<p>目标：<strong>让用户像使用单集群一样来使用多集群</strong>。</p>
<p>扩展集群的边界，服务的边界从单台物理机多个进程，发展到通过k8s集群来管理多台的物理机，再发展到管理多个的k8s集群。<strong>服务的边界从物理机发展到集群</strong>。</p>
<p>而多集群管理需要解决以下问题：</p>
<ul>
<li><strong>多集群服务的分发部署（deployment、daemonset等）</strong></li>
<li><strong>跨集群自动迁移与调度（当某个集群异常，服务可以在其他集群自动部署）</strong></li>
<li><strong>多集群服务发现，网络通信及负载均衡（service，ingress等）</strong></li>
</ul>
<p>而多集群服务的网络通信可以由Service mesh等来解决，本文不做重点讨论。</p>
<p>以上几个问题，可以先从k8s管理节点的思维进行分析</p>
<table>
<thead>
<tr>
<th></th>
<th>物理机视角</th>
<th>单集群视角</th>
<th>多集群视角</th>
</tr>
</thead>
<tbody>
<tr>
<td>进程的边界</td>
<td>物理机</td>
<td>k8s集群</td>
<td>多集群</td>
</tr>
<tr>
<td>调度单元</td>
<td>进程或线程</td>
<td>容器或pod</td>
<td>工作负载（deployment）</td>
</tr>
<tr>
<td>服务的集合</td>
<td></td>
<td>工作负载（deployment）</td>
<td>不同集群工作负载的集合体（workloadGroup）</td>
</tr>
<tr>
<td>服务发现</td>
<td></td>
<td>service</td>
<td>不同集群service的集合体</td>
</tr>
<tr>
<td>服务迁移</td>
<td></td>
<td>工作负载（deployment）控制器</td>
<td>不同集群工作负载的集合体控制器</td>
</tr>
<tr>
<td>服务调度</td>
<td></td>
<td>nodename或者node selector</td>
<td>clustername或cluster selector</td>
</tr>
<tr>
<td></td>
<td></td>
<td>pod的反亲和（相同deployment下的pod不调度在相同节点）</td>
<td>workload反亲和（相同workloadGroup分散在不同集群）</td>
</tr>
</tbody>
</table>
<h2 id="2-1-多集群工作负载的分发">2.1. 多集群工作负载的分发</h2>
<p>单集群中k8s的调度单元是pod，即一个pod只能跑在一个节点上，一个节点可以运行多个pod，而不同节点上的一组pod是通过一个workload来控制和分发。类似这个逻辑，那么在多集群的视角下，多集群的调度单元是一个集群的workload，一个workload只能跑在一个集群中，一个集群可以运行多个workload。</p>
<p>那么就需要有一个控制器来管理不同k8s集群的相同workload。例如 workloadGroup。而该workloadGroup在不侵入k8s原生API的情况下，主要包含两个部分。</p>
<p><strong>workloadGroup:</strong></p>
<ul>
<li><strong>资源模板（Resource Template</strong>）：服务的描述（workload）</li>
<li><strong>分发策略（Propagaion Policy）</strong>：服务分发的集群（即多个workload应该被分发到哪些集群运行）</li>
</ul>
<p>workload描述的是什么服务运行在什么节点，workloadGroup描述的是什么服务运行在什么集群。</p>
<p><strong>实现workloadGroup有两种方式</strong>：</p>
<ol>
<li>一种是自定义API将workloadGroup中的Resource Template和Propagaion Policy合成在一个自定义的对象中，由用户直接指定该workloadGroup信息，从而将不同的workload分发到不同的集群中。</li>
<li>另一种方式是通过一个k8s载体来记录一个具体的workload对象，再由用户指定Propagaion Policy关联该workload对象，从而让控制器自动根据用户指定的Propagaion Policy将workload分发到不同的集群中。</li>
</ol>
<h2 id="2-2-跨集群自动迁移与调度">2.2. 跨集群自动迁移与调度</h2>
<p>单集群中k8s中通过workload中的nodeselector或者nodename以及亲和性来控制pod运行在哪个节点上。而多集群的视角下，则需要有一个控制器来实现集群级别的调度逻辑，例如clustername，cluster selector，cluster AntiAffinity，从而来自动控制workloadGroup下的workload分散在什么集群上。</p>
<h1 id="3-目前的多集群方案">3. 目前的多集群方案</h1>
<h2 id="3-1-kubefed-federation-v2">3.1. Kubefed[Federation v2]</h2>
<p>简介</p>
<p>基本思想</p>
<h2 id="3-2-virtual-kubelet">3.2. virtual kubelet</h2>
<p>简介</p>
<p>基本思想</p>
<h2 id="3-3-karmada">3.3.  Karmada</h2>
<p>简介</p>
<p>基本思想</p>
<p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/zh/docs/setup/best-practices/cluster-large/">https://kubernetes.io/zh/docs/setup/best-practices/cluster-large/</a></li>
<li><a href="https://caicloud.io/blog/57392eca8241681100000003">CoreOS 是如何将 Kubernetes 的性能提高 10 倍的?</a></li>
<li><a href="https://juejin.cn/post/6844903950836056077">当 K8s 集群达到万级规模，阿里巴巴如何解决系统各组件性能问题？</a></li>
<li><a href="https://github.com/kubernetes-sigs/kubefed">https://github.com/kubernetes-sigs/kubefed</a></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/practice/federation.html">https://jimmysong.io/kubernetes-handbook/practice/federation.html</a></li>
<li><a href="https://kubernetes.io/blog/2018/12/12/kubernetes-federation-evolution/">https://kubernetes.io/blog/2018/12/12/kubernetes-federation-evolution/</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/355193315">https://zhuanlan.zhihu.com/p/355193315</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0bfa29d1cbb95cee9ae2c6409c50d04d">13.2 - Virtual Kubelet</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-ce149f4dfb2997092b6b388ae5dda17e">13.2.1 - Virtual Kubelet介绍</h1>
    
	<h1 id="1-简介">1. 简介</h1>
<p><code>Virtual Kubelet</code>是 <a href="https://kubernetes.io/docs/reference/generated/kubelet/">Kubernetes kubelet</a> 的一种实现，作为一种虚拟的kubelet用来连接k8s集群和其他平台的API。这允许k8s的节点由其他<code>提供者（provider）</code>提供支持，这些提供者例如serverless平台（ACI, AWS Fargate）、<a href="https://github.com/Azure/iot-edge-virtual-kubelet-provider">IoT Edge</a>等。</p>
<p>一句话概括：Kubernetes API on top, programmable back。</p>
<h1 id="2-架构图">2. 架构图</h1>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1566560767/article/kubernetes/virtual-kubelet/vk-diagram.svg">
<h1 id="3-功能">3. 功能</h1>
<p>virtual kubelet提供一个可以自定义k8s node的依赖库。</p>
<p>目前支持的功能如下：</p>
<ul>
<li>创建、删除、更新 pod</li>
<li>容器的日志、exec命令、metrics</li>
<li>获取pod、pod列表、pod status</li>
<li>node的地址、容量、daemon</li>
<li>操作系统</li>
<li>自定义virtual network</li>
</ul>
<h1 id="4-providers">4. Providers</h1>
<p>virtual kubelet提供一个插件式的<strong>provider</strong>接口，让开发者可以自定义实现传统kubelet的功能。自定义的provider可以用自己的配置文件和环境参数。</p>
<p>自定义的provider必须提供以下功能：</p>
<ul>
<li>提供pod、容器、资源的生命周期管理的功能</li>
<li>符合virtual kubelet提供的API</li>
<li>不直接访问k8s apiserver，定义获取数据的回调机制，例如configmap、secrets</li>
</ul>
<p>开源的provider</p>
<ul>
<li><a href="https://github.com/virtual-kubelet/alibabacloud-eci">Alibaba Cloud ECI Provider</a></li>
<li><a href="https://github.com/virtual-kubelet/azure-aci">Azure Container Instances Provider</a></li>
<li><a href="https://github.com/virtual-kubelet/aws-fargate">AWS Fargate Provider</a></li>
</ul>
<h1 id="5-自定义provider">5. 自定义provider</h1>
<p>创建自定义provider的目录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/virtual-kubelet/virtual-kubelet
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> virtual-kubelet
</span></span><span style="display:flex;"><span>mkdir providers/my-provider
</span></span></code></pre></div><h2 id="5-1-podlifecylcehandler">5.1. PodLifecylceHandler</h2>
<p>当pod被k8s创建、更新、删除时，会调用以下方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PodLifecycleHandler</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// CreatePod takes a Kubernetes Pod and deploys it within the provider.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">CreatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// UpdatePod takes a Kubernetes Pod and updates it within the provider.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// DeletePod takes a Kubernetes Pod and deletes it from the provider.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">DeletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// GetPod retrieves a pod by name from the provider (can be cached).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">GetPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// GetPodStatus retrieves the status of a pod by name from the provider.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">GetPodStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// GetPods retrieves a list of all pods running on the provider (can be cached).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">GetPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>PodLifecycleHandler</code>是被<code>PodController</code>来调用，来管理被分配到node上的pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPodController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podControllerConfig</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// &lt;-- instatiates the pod controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// &lt;-- starts watching for pods to be scheduled on the node
</span></span></span></code></pre></div><h2 id="5-2-podnotifier-optional">5.2. PodNotifier(optional)</h2>
<p><code>PodNotifier</code>是可选实现，该接口主要用来通知virtual kubelet的pod状态变化。如果没有实现该接口，virtual-kubelet会定期检查所有pod的状态。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PodNotifier</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// NotifyPods instructs the notifier to call the passed in function when
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// the pod status changes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// NotifyPods should not block callers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">NotifyPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-3-nodeprovider">5.3. NodeProvider</h2>
<p><code>NodeProvider</code>用来通知virtual-kubelet关于node状态的变化，virtual-kubelet会定期检查node是状态并相应地更新k8s。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">NodeProvider</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Ping checks if the node is still active.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// This is intended to be lightweight as it will be called periodically as a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// heartbeat to keep the node marked as ready in Kubernetes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Ping</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// NotifyNodeStatus is used to asynchronously monitor the node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// The passed in callback should be called any time there is a change to the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// node&#39;s status.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// This will generally trigger a call to the Kubernetes API server to update
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// the status.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// NotifyNodeStatus should not block callers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">NotifyNodeStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cb</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>NodeProvider</code>是被NodeController调用，来管理k8s中的node对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">nc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNodeController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeProvider</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeSpec</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// &lt;-- instantiate a node controller from a node provider and a kubernetes node spec
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">nc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// &lt;-- creates the node in kubernetes and starts up he controller
</span></span></span></code></pre></div><h2 id="5-4-测试">5.4. 测试</h2>
<p>进入到项目根目录</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>make <span style="color:#204a87">test</span>
</span></span></code></pre></div><h2 id="5-5-示例代码">5.5. 示例代码</h2>
<ul>
<li>
<p>Azure Container Instances Provider</p>
<p><a href="https://github.com/virtual-kubelet/azure-aci/blob/master/aci.go#L541">https://github.com/virtual-kubelet/azure-aci/blob/master/aci.go#L541</a></p>
</li>
<li>
<p>Alibaba Cloud ECI Provider</p>
<p><a href="https://github.com/virtual-kubelet/alibabacloud-eci/blob/master/eci.go#L177">https://github.com/virtual-kubelet/alibabacloud-eci/blob/master/eci.go#L177</a></p>
</li>
<li>
<p>AWS Fargate Provider</p>
<p><a href="https://github.com/virtual-kubelet/aws-fargate/blob/master/provider.go#L110">https://github.com/virtual-kubelet/aws-fargate/blob/master/provider.go#L110</a></p>
</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://github.com/virtual-kubelet/virtual-kubelet">https://github.com/virtual-kubelet/virtual-kubelet</a></li>
<li><a href="https://virtual-kubelet.io/docs/">https://virtual-kubelet.io/docs/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-67292fc70226b6bdc2365d752a4e8eb3">13.2.2 - Virtual Kubelet命令</h1>
    
	<h1 id="virtual-kubelet-help">virtual-kubelet --help</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#./virtual-kubelet --help</span>
</span></span><span style="display:flex;"><span>virtual-kubelet implements the Kubelet interface with a pluggable
</span></span><span style="display:flex;"><span>backend implementation allowing users to create kubernetes nodes without running the kubelet.
</span></span><span style="display:flex;"><span>This allows users to schedule kubernetes workloads on nodes that aren<span style="color:#4e9a06">&#39;t running Kubernetes.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Usage:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  virtual-kubelet [flags]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  virtual-kubelet [command]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Available Commands:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  help        Help about any command
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  providers   Show the list of supported providers
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  version     Show the version of the program
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Flags:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --cluster-domain string                 kubernetes cluster-domain (default is &#39;</span>cluster.local<span style="color:#4e9a06">&#39;) (default &#34;cluster.local&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --disable-taint                         disable the virtual-kubelet node taint
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --enable-node-lease                     use node leases (1.13) for node heartbeats
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --full-resync-period duration           how often to perform a full resync of pods between kubernetes and the provider (default 1m0s)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  -h, --help                                  help for virtual-kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --klog.alsologtostderr                  log to standard error as well as files
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --klog.log_backtrace_at traceLocation   when logging hits line file:N, emit a stack trace (default :0)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --klog.log_dir string                   If non-empty, write log files in this directory
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --klog.log_file string                  If non-empty, use this log file
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --klog.log_file_max_size uint           Defines the maximum size a log file can grow to. Unit is megabytes. If the value is 0, the maximum file size is unlimited. (default 1800)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --klog.logtostderr                      log to standard error instead of files (default true)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --klog.skip_headers                     If true, avoid header prefixes in the log messages
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --klog.skip_log_headers                 If true, avoid headers when opening log files
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --klog.stderrthreshold severity         logs at or above this threshold go to stderr (default 2)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --klog.v Level                          number for the log level verbosity
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --klog.vmodule moduleSpec               comma-separated list of pattern=N settings for file-filtered logging
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --kubeconfig string                     kube config file to use for connecting to the Kubernetes API server (default &#34;/root/.kube/config&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --log-level string                      set the log level, e.g. &#34;debug&#34;, &#34;info&#34;, &#34;warn&#34;, &#34;error&#34; (default &#34;info&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --metrics-addr string                   address to listen for metrics/stats requests (default &#34;:10255&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">      --namespace string                      kubernetes namespace (default is &#39;</span>all<span style="color:#a40000">&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --nodename string                       kubernetes node name <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;virtual-kubelet&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --os string                             Operating System <span style="color:#ce5c00;font-weight:bold">(</span>Linux/Windows<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;Linux&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --pod-sync-workers int                  <span style="color:#204a87">set</span> the number of pod synchronization workers <span style="color:#ce5c00;font-weight:bold">(</span>default 10<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --provider string                       cloud provider
</span></span><span style="display:flex;"><span>      --provider-config string                cloud provider configuration file
</span></span><span style="display:flex;"><span>      --startup-timeout duration              How long to <span style="color:#204a87">wait</span> <span style="color:#204a87;font-weight:bold">for</span> the virtual-kubelet to start
</span></span><span style="display:flex;"><span>      --trace-exporter strings                sets the tracing exporter to use, available exporters: <span style="color:#ce5c00;font-weight:bold">[</span>jaeger ocagent<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      --trace-sample-rate string              <span style="color:#204a87">set</span> probability of tracing samples
</span></span><span style="display:flex;"><span>      --trace-service-name string             sets the name of the service used to register with the trace exporter <span style="color:#ce5c00;font-weight:bold">(</span>default <span style="color:#4e9a06">&#34;virtual-kubelet&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --trace-tag map                         add tags to include with traces in <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">=</span>value form
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;virtual-kubelet [command] --help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information about a command.
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cc8a5dcb3a7129ec93a2c678792dbc72">13.3 - Karmada</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-9ef0c83954fd29dd94465f383242df3d">13.3.1 - Karmada介绍</h1>
    
	<blockquote>
<p>本文由网络资源整理以作记录</p>
</blockquote>
<h1 id="简介">简介</h1>
<p>Karmada（Kubernetes Armada）是基于Kubernetes原生API的多集群管理系统。在多云和混合云场景下，Karmada提供可插拔，全自动化管理多集群应用，实现多云集中管理、高可用性、故障恢复和流量调度。</p>
<h1 id="特性">特性</h1>
<ul>
<li>基于K8s原生API的跨集群应用管理，用户可以方便快捷地将应用从单集群迁移到多集群。</li>
<li>中心式操作和管理Kubernetes集群。</li>
<li>跨集群应用可在多集群上自动扩展，故障转移和负载均衡。</li>
<li>高级的调度策略：区域，可用区，云提供商，集群亲和性/反亲和性。</li>
<li>支持创建分发用户自定义（CustomResourceDefinitions）资源。</li>
</ul>
<h1 id="框架结构">框架结构</h1>
<p><img src="https://support.huaweicloud.com/productdesc-mcp/zh-cn_image_0000001094636778.png" alt="img"></p>
<ul>
<li>ETCD：存储Karmada API对象。</li>
<li>Karmada Scheduler：提供高级的多集群调度策略。</li>
<li>Karmada Controller Manager: 包含多个Controller，Controller监听karmada对象并且与成员集群API server进行通信并创建成员集群的k8s对象。
<ul>
<li>Cluster Controller：成员集群的生命周期管理与对象管理。</li>
<li>Policy Controller：监听PropagationPolicy对象，创建ResourceBinding，配置资源分发策略。</li>
<li>Binding Controller：监听ResourceBinding对象，并创建work对象响应资源清单。</li>
<li>Execution Controller：监听work对象，并将资源分发到成员集群中。</li>
</ul>
</li>
</ul>
<h1 id="资源分发流程">资源分发流程</h1>
<p><strong>基本概念</strong></p>
<ul>
<li>资源模板（Resource Template）：Karmada使用K8s原生API定义作为资源模板，便于快速对接K8s生态工具链。</li>
<li>分发策略（Propagaion Policy）：Karmada提供独立的策略API，用来配置资源分发策略。</li>
<li>差异化策略（Override Policy）：Karmada提供独立的差异化API，用来配置与集群相关的差异化配置。比如配置不同集群使用不同的镜像。</li>
</ul>
<p>Karmada资源分发流程图：</p>
<p><img src="https://support.huaweicloud.com/productdesc-mcp/zh-cn_image_0000001141316765.png" alt="img"></p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/karmada-io/karmada">https://github.com/karmada-io/karmada</a></li>
<li><a href="https://support.huaweicloud.com/productdesc-mcp/mcp_productdesc_0001.html">https://support.huaweicloud.com/productdesc-mcp/mcp_productdesc_0001.html</a></li>
</ul>

</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c4977ab2e03e75819e765edea4579afa">14 - 边缘容器</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0968bbb4adc6aa435ad759c90307bb98">14.1 - KubeEdge</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-996e093c65c41f7360acc920c5f48e28">14.1.1 - KubeEdge介绍</h1>
    
	<h1 id="1-kubeedge简介">1. KubeEdge简介</h1>
<p><code>KubeEdge</code>是基于kubernetes之上将容器化应用的编排能力拓展到边缘主机或边缘设备，在云端和边缘端提供网络通信，应用部署、元数据同步等功能。同时支持<strong>MQTT</strong>协议，允许开发者在边缘端自定义接入边缘设备。</p>
<h1 id="2-功能">2. 功能</h1>
<ul>
<li>边缘计算：提供边缘节点自治能力，边缘节点数据处理能力。</li>
<li>便捷部署：开发者可以开发http或mqtt协议的应用，运行在云端和边缘端。</li>
<li>k8s原生支持：可以通过k8s管理和监控边缘设备和边缘节点。</li>
<li>丰富的应用类型：可以在边缘端部署机器学习、图片识别、事件处理等应用。</li>
</ul>
<h1 id="3-组件">3. 组件</h1>
<h2 id="3-1-云端">3.1. 云端</h2>
<ul>
<li>
<p><a href="https://github.com/kubeedge/kubeedge/blob/master/docs/modules/cloud/cloudhub.md">CloudHub</a>：一个web socket服务器，负责监听云端的更新、缓存及向<code>EdgeHub</code>发送消息。</p>
</li>
<li>
<p><a href="https://github.com/kubeedge/kubeedge/blob/master/docs/modules/cloud/controller.md">EdgeController</a>：一个扩展的k8s控制器，负责管理边缘节点和pod元数据，同步边缘节点的数据，是<code>k8s-apiserver</code> 与<code>EdgeCore</code>的通信桥梁。</p>
</li>
<li>
<p><a href="https://github.com/kubeedge/kubeedge/blob/master/docs/modules/cloud/device_controller.md">DeviceController</a>：一个扩展的k8s控制器，负责管理节点设备，同步云端和边缘端的设备元数据和状态。</p>
</li>
</ul>
<h2 id="3-2-边缘端">3.2. 边缘端</h2>
<ul>
<li><a href="https://github.com/kubeedge/kubeedge/blob/master/docs/modules/edge/edgehub.md">EdgeHub</a>：一个web socket客户端，负责云端与边缘端的信息交互，其中包括将云端的资源变更同步到边缘端及边缘端的状态变化同步到云端。</li>
<li><a href="https://github.com/kubeedge/kubeedge/blob/master/docs/modules/edge/edged.md">Edged</a>：运行在边缘节点，管理容器化应用的agent，负责pod生命周期的管理，类似kubelet。</li>
<li><a href="https://github.com/kubeedge/kubeedge/blob/master/docs/modules/edge/eventbus.md">EventBus</a>：一个MQTT客户端，与MQTT服务端交互，提供发布/订阅的能力。</li>
<li>ServiceBus：一个HTTP客户端，与HTTP服务端交互。为云组件提供HTTP客户端功能，以访问在边缘运行的HTTP服务器。</li>
<li><a href="https://github.com/kubeedge/kubeedge/blob/master/docs/modules/edge/devicetwin.md">DeviceTwin</a>：负责存储设备状态并同步设备状态到云端，同时提供应用的接口查询。</li>
<li><a href="https://github.com/kubeedge/kubeedge/blob/master/docs/modules/edge/metamanager.md">MetaManager</a>：<code>edged</code>和<code>edgehub</code>之间的消息处理器，负责向轻量数据库（SQLite）存储或查询元数据。</li>
</ul>
<h1 id="4-架构图">4. 架构图</h1>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1580806242/article/kubernetes/kubeedge/kubeedge_arch.png" alt="kubeedge-arch"></p>
<p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubeedge/kubeedge">https://github.com/kubeedge/kubeedge</a></p>
</li>
<li>
<p><a href="https://kubeedge.readthedocs.io/en/latest/modules/kubeedge.html">https://kubeedge.readthedocs.io/en/latest/modules/kubeedge.html</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b753fdb4b0d5561c106c3c07d2715d9e">14.1.2 - KubeEdge源码分析</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-aca9a0997212b2f4813435f23c188a3d">14.1.2.1 - Kubeedge之cloudcore 源码分析</h1>
    
	<h1 id="kubeedge源码分析之cloudcore">kubeedge源码分析之cloudcore</h1>
<blockquote>
<p>本文源码分析基于<a href="https://github.com/kubeedge/kubeedge/releases/tag/v1.1.0">kubeedge v1.1.0</a></p>
</blockquote>
<p>本文主要分析cloudcore中CloudCoreCommand的基本流程，具体的<code>cloudhub</code>、<code>edgecontroller</code>、<code>devicecontroller</code>模块的实现逻辑待后续单独文章分析。</p>
<p>目录结构：</p>
<blockquote>
<p>cloud/cmd/cloudcore</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cloudcore
</span></span><span style="display:flex;"><span>├── app
</span></span><span style="display:flex;"><span>│   ├── options
</span></span><span style="display:flex;"><span>│   │   └── options.go
</span></span><span style="display:flex;"><span>│   └── server.go <span style="color:#8f5902;font-style:italic"># NewCloudCoreCommand、registerModules</span>
</span></span><span style="display:flex;"><span>└── cloudcore.go <span style="color:#8f5902;font-style:italic"># main函数</span>
</span></span></code></pre></div><p><code>cloudcore</code>部分包含以下模块：</p>
<ul>
<li>cloudhub</li>
<li>edgecontroller</li>
<li>devicecontroller</li>
</ul>
<h1 id="1-main函数">1. main函数</h1>
<p>kubeedge的代码采用cobra命令框架，代码风格与k8s源码风格类似。cmd目录主要为cobra command的基本内容及参数解析，pkg目录包含具体的实现逻辑。</p>
<blockquote>
<p>cloud/cmd/cloudcore/cloudcore.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCloudCoreCommand</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlushLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-newcloudcorecommand">2. NewCloudCoreCommand</h1>
<p><code>NewCloudCoreCommand</code>为cobra command的构造函数，该类函数一般包含以下部分：</p>
<ul>
<li>构造option</li>
<li>添加Flags</li>
<li>运行Run函数（核心）</li>
</ul>
<blockquote>
<p>cloud/cmd/cloudcore/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewCloudCoreCommand</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCloudCoreOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cloudcore&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Long</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`CloudCore is the core cloud part of KubeEdge, which contains three modules: cloudhub,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">edgecontroller, and devicecontroller. Cloudhub is a web server responsible for watching changes at the cloud side,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">caching and sending messages to EdgeHub. EdgeController is an extended kubernetes controller which manages 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">edge nodes and pods metadata so that the data can be targeted to a specific edge node. DeviceController is an extended 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">kubernetes controller which manages devices so that the device metadata/status date can be synced between edge and cloud.`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Run</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">verflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintAndExitIfRequested</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// To help debugging, immediately log version
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Version: %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">registerModules</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// start all modules
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">namedFs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">verflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namedFs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;global&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">globalflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddGlobalFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namedFs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;global&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">namedFs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSets</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">usageFmt</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;Usage:\n  %s\n&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cols</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">term</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TerminalSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetUsageFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStderr</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">usageFmt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseLine</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cliflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintSections</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStderr</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">namedFs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cols</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetHelpFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;%s\n\n&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">usageFmt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Long</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseLine</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cliflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintSections</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">namedFs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cols</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 构造option
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCloudCoreOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 执行run函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">registerModules</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 添加flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="3-registermodules">3. registerModules</h1>
<p>由于kubeedge的代码的大部分模块都采用了基于go-channel的消息通信框架<a href="https://kubeedge.readthedocs.io/en/latest/modules/beehive.html">Beehive</a>（待后续单独文章分析），因此在各模块启动之前，需要将该模块注册到beehive的框架中。</p>
<p>其中cloudcore部分涉及的模块有：</p>
<ul>
<li>cloudhub</li>
<li>edgecontroller</li>
<li>devicecontroller</li>
</ul>
<blockquote>
<p>cloud/cmd/cloudcore/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// registerModules register all the modules started in cloudcore
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">registerModules</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cloudhub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">edgecontroller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">devicecontroller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下以cloudhub为例说明注册的过程。</p>
<p>cloudhub结构体主要包含：</p>
<ul>
<li>context：上下文，用来传递消息上下文</li>
<li>stopChan：go channel通信</li>
</ul>
<p>beehive框架中的模块需要实现<code>Module</code>接口，因此cloudhub也实现了该接口，其中核心方法为Start，用来启动相应模块的运行。</p>
<blockquote>
<p>vendor/github.com/kubeedge/beehive/pkg/core/module.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Module interface
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Module</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Group</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Cleanup</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下为cloudHub结构体及注册函数。</p>
<blockquote>
<p>cloud/pkg/cloudhub/cloudhub.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">cloudHub</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">context</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">stopChan</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Register</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cloudHub</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>具体的注册实现函数为core.Register，注册过程实际上就是将具体的模块结构体放入一个以模块名为key的map映射中，待后续调用。</p>
<blockquote>
<p>vendor/github.com/kubeedge/beehive/pkg/core/module.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Register register module
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#000">Module</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isModuleEnabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">modules</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span>  <span style="color:#8f5902;font-style:italic">//将具体的模块结构体放入一个以模块名为key的map映射中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LOGGER</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;module &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; registered&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">disabledModules</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LOGGER</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;module &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34; is not register, please check modules.yaml&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-core-run">4. core.Run</h1>
<p>CloudCoreCommand命令的Run函数实际上是运行beehive框架中注册的所有模块。</p>
<p>其中包括两部分逻辑：</p>
<ul>
<li>启动运行所有注册模块</li>
<li>监听信号并做优雅清理</li>
</ul>
<blockquote>
<p>vendor/github.com/kubeedge/beehive/pkg/core/core.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Run starts the modules and in the end does module cleanup
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">//Address the module registration and start the core
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">StartModules</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// monitor system signal and shutdown gracefully
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">GracefulShutdown</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-startmodules">5. StartModules</h1>
<p><code>StartModules</code>获取context上下文，并以goroutine的方式运行所有已注册的模块。其中Start函数即每个模块的具体实现<code>Module</code>接口中的Start方法。不同模块各自定义自己的具体Start方法实现。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">coreContext</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetContext</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MsgCtxTypeChannel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coreContext</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>具体实现如下：</p>
<blockquote>
<p>vendor/github.com/kubeedge/beehive/pkg/core/core.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// StartModules starts modules that are registered
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">StartModules</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">coreContext</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetContext</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MsgCtxTypeChannel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">modules</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">GetModules</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">module</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">modules</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">//Init the module
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">coreContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddModule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">//Assemble typeChannels for send2Group
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">coreContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddModuleGroup</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Group</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">coreContext</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LOGGER</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;starting module &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="6-gracefulshutdown">6. GracefulShutdown</h1>
<p>当收到相关信号，则执行各个模块实现的Cleanup方法。</p>
<blockquote>
<p>vendor/github.com/kubeedge/beehive/pkg/core/core.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// GracefulShutdown is if it gets the special signals it does modules cleanup
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">GracefulShutdown</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Signal</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">signal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Notify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SIGINT</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SIGHUP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SIGTERM</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SIGQUIT</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SIGILL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SIGTRAP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SIGABRT</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LOGGER</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;got os signal &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">//Cleanup each modules
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">modules</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">GetModules</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">module</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">modules</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LOGGER</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Cleanup module &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cleanup</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/kubeedge/kubeedge/tree/release-1.1/cloud/cmd/cloudcore">https://github.com/kubeedge/kubeedge/tree/release-1.1/cloud/cmd/cloudcore</a></li>
<li><a href="https://github.com/kubeedge/kubeedge/tree/release-1.1/vendor/github.com/kubeedge/beehive/pkg/core">https://github.com/kubeedge/kubeedge/tree/release-1.1/vendor/github.com/kubeedge/beehive/pkg/core</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-46c48a2a09bc26250f3bd1939c76797f">14.1.2.2 - Kubeedge之edgecore 源码分析</h1>
    
	<h1 id="kubeedge源码分析之edgecore">kubeedge源码分析之edgecore</h1>
<blockquote>
<p>本文源码分析基于<a href="https://github.com/kubeedge/kubeedge/releases/tag/v1.1.0">kubeedge v1.1.0</a></p>
</blockquote>
<p>本文主要分析<code>edgecore</code>中<code>EdgeCoreCommand</code>的基本流程，具体的<code>edged</code>、<code>edgehub</code>、<code>metamanager</code>等模块的实现逻辑待后续单独文章分析。</p>
<p>目录结构：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>edgecore
</span></span><span style="display:flex;"><span>├── app
</span></span><span style="display:flex;"><span>│   ├── options
</span></span><span style="display:flex;"><span>│   │   └── options.go
</span></span><span style="display:flex;"><span>│   └── server.go  <span style="color:#8f5902;font-style:italic"># NewEdgeCoreCommand 、registerModules</span>
</span></span><span style="display:flex;"><span>└── edgecore.go  <span style="color:#8f5902;font-style:italic"># main</span>
</span></span></code></pre></div><p>edgecore模块包含：</p>
<ul>
<li>edged</li>
<li>edgehub</li>
<li>metamanager</li>
<li>eventbus</li>
<li>servicebus</li>
<li>devicetwin</li>
<li>edgemesh</li>
</ul>
<h1 id="1-main函数">1. main函数</h1>
<p>main入口函数，仍然是cobra命令框架格式。</p>
<blockquote>
<p>edge/cmd/edgecore/edgecore.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewEdgeCoreCommand</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlushLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-newedgecorecommand">2. NewEdgeCoreCommand</h1>
<p><code>NewEdgeCoreCommand</code>与<code>NewCloudCoreCommand</code>一样构造对应的cobra command结构体。</p>
<blockquote>
<p>edge/cmd/edgecore/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewEdgeCoreCommand create edgecore cmd
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewEdgeCoreCommand</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewEdgeCoreOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;edgecore&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Long</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`Edgecore is the core edge part of KubeEdge, which contains six modules: devicetwin, edged, 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">edgehub, eventbus, metamanager, and servicebus. DeviceTwin is responsible for storing device status 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">and syncing device status to the cloud. It also provides query interfaces for applications. Edged is an 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">agent that runs on edge nodes and manages containerized applications and devices. Edgehub is a web socket 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">client responsible for interacting with Cloud Service for the edge computing (like Edge Controller as in the KubeEdge 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Architecture). This includes syncing cloud-side resource updates to the edge, and reporting 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">edge-side host and device status changes to the cloud. EventBus is a MQTT client to interact with MQTT 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">servers (mosquito), offering publish and subscribe capabilities to other components. MetaManager 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">is the message processor between edged and edgehub. It is also responsible for storing/retrieving metadata 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">to/from a lightweight database (SQLite).ServiceBus is a HTTP client to interact with HTTP servers (REST), 
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">offering HTTP client capabilities to components of cloud to reach HTTP servers running at edge. `</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Run</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">verflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintAndExitIfRequested</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// To help debugging, immediately log version
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Version: %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">registerModules</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// start all modules
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">namedFs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">verflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namedFs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;global&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">globalflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddGlobalFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namedFs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;global&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">namedFs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSets</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">usageFmt</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;Usage:\n  %s\n&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cols</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">term</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TerminalSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetUsageFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStderr</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">usageFmt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseLine</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cliflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintSections</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStderr</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">namedFs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cols</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetHelpFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;%s\n\n&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">usageFmt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Long</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseLine</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cliflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintSections</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">namedFs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cols</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewEdgeCoreOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">registerModules</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h1 id="3-registermodules">3. registerModules</h1>
<p>edgecore仍然采用<a href="https://kubeedge.readthedocs.io/en/latest/modules/beehive.html">Beehive</a>通信框架，模块调用前先注册对应的模块。具体参考<a href="https://www.huweihuang.com/kubernetes-notes/kubeedge/code-analysis/cloudcore.html#3-registermodules">cloudcore.registerModules</a>处的分析，此处不再展开分析注册流程。此处注册的是edgecore中涉及的组件。</p>
<blockquote>
<p>edge/cmd/edgecore/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// registerModules register all the modules started in edgecore
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">registerModules</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">devicetwin</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">edged</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">edgehub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">eventbus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">edgemesh</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metamanager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">servicebus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">test</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dbm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitDBManager</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-core-run">4. core.Run</h1>
<p>core.Run与<a href="https://www.huweihuang.com/kubernetes-notes/kubeedge/code-analysis/cloudcore.html#4-corerun">cloudcore.run</a>处逻辑一致不再展开分析。</p>
<blockquote>
<p>vendor/github.com/kubeedge/beehive/pkg/core/core.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Run starts the modules and in the end does module cleanup
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#8f5902;font-style:italic">//Address the module registration and start the core
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#000">StartModules</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>   <span style="color:#8f5902;font-style:italic">// monitor system signal and shutdown gracefully
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#000">GracefulShutdown</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/kubeedge/kubeedge/tree/release-1.1/edge/cmd/edgecore">https://github.com/kubeedge/kubeedge/tree/release-1.1/edge/cmd/edgecore</a></li>
</ul>

</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4e40ff60e81cf41810e8f710325c3732">14.2 - OpenYurt</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-168a4f39638381fbf3c73746ce7bf5de">14.2.1 - OpenYurt部署</h1>
    
	<blockquote>
<p>本文主要介绍部署openyurt组件到k8s集群中。</p>
</blockquote>
<h2 id="1-给云端节点和边缘节点打标签">1. 给云端节点和边缘节点打标签</h2>
<p>openyurt将k8s节点分为云端节点和边缘节点，云端节点主要运行一些云端的业务，边缘节点运行边缘业务。当与 <code>apiserver</code> 断开连接时，只有运行在边缘自治的节点上的Pod才不会被驱逐。通过打 <code>openyurt.io/is-edge-worker</code> 的标签的方式来区分，<code>false</code>表示云端节点，<code>true</code>表示边缘节点。</p>
<p>云端组件：</p>
<ul>
<li>
<p>yurt-controller-manager</p>
</li>
<li>
<p>yurt-tunnel-server</p>
</li>
</ul>
<p>边缘组件：</p>
<ul>
<li>
<p>yurt-hub</p>
</li>
<li>
<p>yurt-tunnel-agent</p>
</li>
</ul>
<h3 id="1-1-openyurt-io-is-edge-worker节点标签">1.1. openyurt.io/is-edge-worker节点标签</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 云端节点，值为false</span>
</span></span><span style="display:flex;"><span>kubectl label node us-west-1.192.168.0.87 openyurt.io/is-edge-worker<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 边缘节点，值为true</span>
</span></span><span style="display:flex;"><span>kubectl label node us-west-1.192.168.0.88 openyurt.io/is-edge-worker<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span></code></pre></div><h3 id="1-2-给边缘节点开启自治模式">1.2. 给边缘节点开启自治模式</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl annotate node us-west-1.192.168.0.88 node.beta.openyurt.io/autonomy<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span></code></pre></div><h2 id="2-安装准备">2. 安装准备</h2>
<h3 id="2-1-调整k8s组件的配置">2.1. 调整k8s组件的配置</h3>
<p>参考<a href="https://blog.huweihuang.com/kubernetes-notes/edge/openyurt/update-k8s-for-openyurt/">调整k8s组件的配置</a></p>
<h3 id="2-2-部署tunnel-dns">2.2. 部署tunnel-dns</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/openyurtio/openyurt/master/config/setup/yurt-tunnel-dns.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f yurt-tunnel-dns.yaml
</span></span></code></pre></div><p>获取clusterIP，作为kube-apiserver的专用nameserver地址。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl -n kube-system get svc yurt-tunnel-dns -o<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;{.spec.clusterIP}&#39;</span>
</span></span></code></pre></div><h2 id="3-部署openyurt控制面">3. 部署openyurt控制面</h2>
<p>通过helm来部署控制面，所有helm charts都可以在<a href="https://github.com/openyurtio/openyurt-helm">openyurt-helm 仓库</a>中找到。</p>
<p>快捷安装可参考脚本：<a href="https://github.com/huweihuang/kubeadm-scripts/blob/main/openyurt/cloud/helm-install-openyurt.sh">helm-install-openyurt.sh</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add openyurt https://openyurtio.github.io/openyurt-helm
</span></span></code></pre></div><h3 id="3-1-yurt-app-manager">3.1. yurt-app-manager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm upgrade --install yurt-app-manager -n kube-system openyurt/yurt-app-manager
</span></span></code></pre></div><h3 id="3-2-openyurt">3.2. openyurt</h3>
<p>在<code>openyurt/openyurt</code>中的组件包括：</p>
<ul>
<li><a href="https://openyurt.io/zh/docs/core-concepts/yurt-controller-manager">yurt-controller-manager</a>: 防止apiserver在断开连接时驱逐运行在边缘节点上的pod</li>
<li><a href="https://openyurt.io/zh/docs/core-concepts/yurttunnel">yurt-tunnel-server</a>: 在云端构建云边隧道</li>
<li><a href="https://openyurt.io/zh/docs/core-concepts/yurttunnel">yurt-tunnel-agent</a>: 在边缘侧构建云边隧道</li>
</ul>
<p>由于yurt-tunnel-server默认使用host模式，因此可能存在边缘端的agent无法访问云端的tunnel-server，需要为tunnel-server配置一个可访问的地址。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下载并解压</span>
</span></span><span style="display:flex;"><span>helm pull openyurt/openyurt --untar
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 修改tunnel相关配置</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> openyurt 
</span></span><span style="display:flex;"><span>vi values.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 示例：</span>
</span></span><span style="display:flex;"><span>yurtTunnelServer:
</span></span><span style="display:flex;"><span>  replicaCount: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>  tolerations: <span style="color:#ce5c00;font-weight:bold">[]</span>
</span></span><span style="display:flex;"><span>  parameters:
</span></span><span style="display:flex;"><span>    certDnsNames: <span style="color:#4e9a06">&#34;&lt;tunnel server的域名&gt;&#34;</span>
</span></span><span style="display:flex;"><span>    tunnelAgentConnectPort: &lt;tunnel server端口，默认为10262&gt;
</span></span><span style="display:flex;"><span>    certIps: <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>yurtTunnelAgent:
</span></span><span style="display:flex;"><span>  replicaCount: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>  tolerations: <span style="color:#ce5c00;font-weight:bold">[]</span>
</span></span><span style="display:flex;"><span>  parameters:
</span></span><span style="display:flex;"><span>    tunnelserverAddr: <span style="color:#4e9a06">&#34;&lt;tunnel server的地址，包括端口&gt;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># install</span>
</span></span><span style="display:flex;"><span>helm install openyurt ./openyurt
</span></span></code></pre></div><h2 id="4-部署-yurthub-edge">4. 部署 Yurthub(edge)</h2>
<p>在 <code>yurt-controller-manager</code> 启动并正常运行后，以静态 pod 的方式部署 <code>Yurthub</code>。</p>
<ol>
<li>为 yurthub 创建全局配置(即RBAC, configmap)</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/openyurtio/openyurt/master/config/setup/yurthub-cfg.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f yurthub-cfg.yaml
</span></span></code></pre></div><ol start="2">
<li>在边缘节点以static pod方式创建yurthub</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /etc/kubernetes/manifests/
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /etc/kubernetes/manifests/
</span></span><span style="display:flex;"><span>wget https://raw.githubusercontent.com/openyurtio/openyurt/master/config/setup/yurthub.yaml 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取bootstrap token</span>
</span></span><span style="display:flex;"><span>kubeadm token create
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 假设 apiserver 的地址是 1.2.3.4:6443，bootstrap token 是 07401b.f395accd246ae52d</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#4e9a06">&#39;s|__kubernetes_master_address__|1.2.3.4:6443|;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">s|__bootstrap_token__|07401b.f395accd246ae52d|&#39;</span> /etc/kubernetes/manifests/yurthub.yaml
</span></span></code></pre></div><h2 id="5-重置-kubelet">5. 重置 Kubelet</h2>
<p>重置 kubelet 服务，让它通过 yurthub 访问apiserver。为 kubelet 服务创建一个新的 kubeconfig 文件来访问apiserver。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p /var/lib/openyurt
</span></span><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt; EOF &gt; /var/lib/openyurt/kubelet.conf
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">clusters:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">- cluster:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    server: http://127.0.0.1:10261
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  name: default-cluster
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">contexts:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">- context:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    cluster: default-cluster
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    user: default-auth
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  name: default-context
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">current-context: default-context
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">kind: Config
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">preferences: {}
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><p>修改<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sed -i <span style="color:#4e9a06">&#34;s|KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=\/etc\/kubernetes\/bootstrap-kubelet.conf\ --kubeconfig=\/etc\/kubernetes\/kubelet.conf|KUBELET_KUBECONFIG_ARGS=--kubeconfig=\/var\/lib\/openyurt\/kubelet.conf|g&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
</span></span></code></pre></div><p>重启kubelet服务</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> systemctl restart kubelet
</span></span></code></pre></div><h2 id="6-yurthub部署脚本">6. yurthub部署脚本</h2>
<p>根据以上部署步骤，整理部署脚本。需要修改脚本内容的<code>master-addr</code>和<code>token</code>字段。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -e
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> -x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">### install yurthub ###</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/kubernetes/manifests/
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> /etc/kubernetes/manifests/
</span></span><span style="display:flex;"><span>wget https://raw.githubusercontent.com/openyurtio/openyurt/master/config/setup/yurthub.yaml 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">### 修改master和token字段</span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#4e9a06">&#39;s|__kubernetes_master_address__|&lt;master-addr&gt;:6443|;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">s|__bootstrap_token__|&lt;token&gt;|&#39;</span> /etc/kubernetes/manifests/yurthub.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir -p /var/lib/openyurt
</span></span><span style="display:flex;"><span>cat <span style="color:#4e9a06">&lt;&lt; EOF &gt; /var/lib/openyurt/kubelet.conf
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">apiVersion: v1
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">clusters:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">- cluster:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    server: http://127.0.0.1:10261
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  name: default-cluster
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">contexts:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">- context:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    cluster: default-cluster
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    namespace: default
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    user: default-auth
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  name: default-context
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">current-context: default-context
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">kind: Config
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">preferences: {}
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cp /etc/systemd/system/kubelet.service.d/10-kubeadm.conf /etc/systemd/system/kubelet.service.d/10-kubeadm.conf.bak
</span></span><span style="display:flex;"><span>sed -i <span style="color:#4e9a06">&#34;s|KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=\/etc\/kubernetes\/bootstrap-kubelet.conf\ --kubeconfig=\/etc\/kubernetes\/kubelet.conf|KUBELET_KUBECONFIG_ARGS=--kubeconfig=\/var\/lib\/openyurt\/kubelet.conf|g&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>    /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl daemon-reload <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> systemctl restart kubelet
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://openyurt.io/zh/docs/installation/manually-setup">https://openyurt.io/zh/docs/installation/manually-setup</a></li>
<li><a href="https://openyurt.io/zh/docs/installation/openyurt-prepare">https://openyurt.io/zh/docs/installation/openyurt-prepare</a></li>
<li><a href="https://openyurt.io/zh/docs/installation/yurtadm-join/#2-%E5%9C%A8%E5%AD%98%E9%87%8F%E7%9A%84k8s%E8%8A%82%E7%82%B9%E4%B8%8A%E5%AE%89%E8%A3%85openyurt-node%E7%BB%84%E4%BB%B6">在存量的K8s节点上安装OpenYurt Node组件</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7f94c71d7e452edb45aebaf5597df77f">14.2.2 - OpenYurt 安装相关Kubernetes配置调整</h1>
    
	<p>安装openyurt，为了适配边缘场景，需要对k8s组件进行调整。其中包括：</p>
<ul>
<li>
<p>kube-apiserver</p>
</li>
<li>
<p>kube-controller-manager</p>
</li>
<li>
<p>kube-proxy</p>
</li>
<li>
<p>CoreDNS</p>
</li>
</ul>
<h1 id="1-kube-apiserver">1. kube-apiserver</h1>
<p>为了实现云边通信，即用户可以正常使用kubectl exec/logs的功能来登录或查看边缘容器的信息。需要将kube-apiserver访问kubelet的地址调整为hostname优先。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">$ vi /etc/kubernetes/manifests/kube-apiserver.yaml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dnsPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;None&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 1. dnsPolicy修改为None</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">dnsConfig</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># 2. 增加dnsConfig配置</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">nameservers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#0000cf;font-weight:bold">1.2.3.4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 使用yurt-tunnel-dns service的clusterIP替换</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">searches</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">kube-system.svc.cluster.local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">svc.cluster.local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">cluster.local</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">options</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ndots</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;5&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">kube-apiserver</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- --<span style="color:#000">kubelet-preferred-address-types=Hostname,InternalIP,ExternalIP</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 3. 把Hostname放在第一位</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="2-kube-controller-manager">2. kube-controller-manager</h1>
<p>禁用默认的 <code>nodelifecycle</code> 控制器，当节点断连时不驱逐pod。</p>
<p><code>nodelifecycle</code>控制器主要用来根据node的status及lease的更新时间来决定是否要<code>驱逐节点上的pod</code>。为了让 <code>yurt-controller-mamanger</code> 能够正常工作，因此需要禁用controller的驱逐功能。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim /etc/kubernetes/manifests/kube-controller-manager.yaml
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在--controllers=*,bootstrapsigner,tokencleaner后面添加,-nodelifecycle </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 即参数为： --controllers=*,bootstrapsigner,tokencleaner,-nodelifecycle</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 如果kube-controller-manager是以static pod部署，修改yaml文件后会自动重启。</span>
</span></span></code></pre></div><h1 id="3-coredns">3. CoreDNS</h1>
<p>将coredns从deployment部署改为daemonset部署。</p>
<p>将deployment的coredns副本数调整为0。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl scale --replicas<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> deployment/coredns -n kube-system
</span></span></code></pre></div><p>创建daemonset的coredns。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/huweihuang/kubeadm-scripts/main/openyurt/yurt-tunnel/coredns.ds.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl apply -f 
</span></span></code></pre></div><p>支持流量拓扑：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 利用openyurt实现endpoint过滤</span>
</span></span><span style="display:flex;"><span>kubectl annotate svc kube-dns -n kube-system openyurt.io/topologyKeys<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;openyurt.io/nodepool&#39;</span>
</span></span></code></pre></div><h1 id="4-kube-proxy">4. kube-proxy</h1>
<p>云边端场景下，边缘节点间很有可能无法互通，因此需要endpoints基于nodepool进行拓扑。直接将kube-proxy的kubeconfig配置删除，将apiserver请求经过yurthub即可解决服务拓扑问题。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl edit cm -n kube-system kube-proxy
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">data</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">config.conf</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">|-</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    bindAddress: 0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    bindAddressHardFail: false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    clientConnection:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      acceptContentTypes: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      burst: 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      contentType: &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      #kubeconfig: /var/lib/kube-proxy/kubeconfig.conf &lt;-- 删除这个配置
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">      qps: 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    clusterCIDR: 100.64.0.0/10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    configSyncPeriod: 0s</span><span style="color:#f8f8f8;text-decoration:underline">    
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">// 省略</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://openyurt.io/zh/docs/installation/openyurt-prepare/">https://openyurt.io/zh/docs/installation/openyurt-prepare/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6d600212dc5f4e80d93baefe76275030">14.2.3 - OpenYurt源码分析</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-44aac785c423d0dcd0ca0cfde0575633">14.2.3.1 - OpenYurt之YurtHub源码分析</h1>
    
	<blockquote>
<p>本文分析<code>yurthub</code>源码，第一部分。</p>
<p>本文以commit id：<code>180282663457080119a1bc6076cce20c922b5c50</code>， 对应版本tag: <code>v1.2.1</code> 的源码分析yurthub的实现逻辑。</p>
</blockquote>
<p>yurthub是部署在每个边缘节点上用来实现边缘自治的组件。在云边通信正常的情况下实现apiserver的请求转发，断网的情况下通过本地的缓存数据保证节点上容器的正常运行。</p>
<p>基本架构图：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1681567428/article/openyurt/yurthub.png" alt=""></p>
<p>pkg包中yurthub代码目录结构；</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yurthub
</span></span><span style="display:flex;"><span>├── cachemanager  <span style="color:#8f5902;font-style:italic"># cache 管理器，</span>
</span></span><span style="display:flex;"><span>├── certificate <span style="color:#8f5902;font-style:italic"># 证书token管理</span>
</span></span><span style="display:flex;"><span>├── filter 
</span></span><span style="display:flex;"><span>├── gc <span style="color:#8f5902;font-style:italic"># GCManager</span>
</span></span><span style="display:flex;"><span>├── healthchecker <span style="color:#8f5902;font-style:italic"># cloud apiserver 探火机制</span>
</span></span><span style="display:flex;"><span>├── kubernetes <span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span>├── metrics
</span></span><span style="display:flex;"><span>├── network <span style="color:#8f5902;font-style:italic"># 网络iptables配置 </span>
</span></span><span style="display:flex;"><span>├── otaupdate
</span></span><span style="display:flex;"><span>├── poolcoordinator
</span></span><span style="display:flex;"><span>├── proxy <span style="color:#8f5902;font-style:italic"># 核心代码，反向代理机制，包括remote proxy和local proxy</span>
</span></span><span style="display:flex;"><span>├── server <span style="color:#8f5902;font-style:italic"># yurthub server</span>
</span></span><span style="display:flex;"><span>├── storage <span style="color:#8f5902;font-style:italic"># 本地存储的实现</span>
</span></span><span style="display:flex;"><span>├── tenant
</span></span><span style="display:flex;"><span>├── transport
</span></span><span style="display:flex;"><span>└── util
</span></span></code></pre></div><h1 id="1-newcmdstartyurthub">1. NewCmdStartYurtHub</h1>
<p><code>openyurt</code>的代码风格与k8s的一致，由cmd为入口，pkg为主要的实现逻辑。</p>
<p>以下是cmd的main函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">newRand</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSource</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UnixNano</span><span style="color:#000;font-weight:bold">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">newRand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UnixNano</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCmdStartYurtHub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetupSignalContext</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddGoFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>main 函数主要创建 NewCmdStartYurtHub 对象。NewCmd的函数一般都包含以下的几个部分，运行顺序从上到下：</p>
<ol>
<li>
<p>NewYurtHubOptions：创建option参数对象，主要用于flag参数解析到option的结构体。</p>
</li>
<li>
<p>yurtHubOptions.AddFlags(cmd.Flags())：添加AddFlags，设置flag参数信息。</p>
</li>
<li>
<p>yurtHubOptions.Validate()：校验flag解析后的option的参数合法性。</p>
</li>
<li>
<p>yurtHubCfg, err := config.Complete(yurtHubOptions)：将option的参数转换为config的对象。</p>
</li>
<li>
<p>Run(ctx, yurtHubCfg)：基于config执行run函数，运行cmd的核心逻辑。</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewCmdStartYurtHub creates a *cobra.Command object with default parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewCmdStartYurtHub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">yurtHubOptions</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewYurtHubOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetHubName</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Short</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Launch &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetHubName</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Long</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;Launch &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetHubName</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">yurtHubOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Version</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: %#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetHubName</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s version: %#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetHubName</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">VisitAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">flag</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flag</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;FLAG: --%s=%q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">yurtHubOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Validate</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;validate options: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">yurtHubCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yurtHubOptions</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;complete %s configuration error, %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetHubName</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s cfg: %#+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetHubName</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">yurtHubCfg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yurtHubCfg</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;run %s failed, %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetHubName</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">yurtHubOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以上flag、option、config的构建函数此处不做分析，以下分析run函数的逻辑。</p>
<h1 id="2-run-ctx-yurthubcfg">2. Run(ctx, yurtHubCfg)</h1>
<p>Run函数部分主要构建了几个manager，每个manager各司其职，负责对应的逻辑。有的manager在该函数中直接构建后执行manager.run的逻辑。有的则作为参数传入下一级函数中再执行manager.run函数。</p>
<p>主要包括以下的manager：</p>
<ul>
<li>
<p>transportManager</p>
</li>
<li>
<p>cloudHealthChecker</p>
</li>
<li>
<p>restConfigMgr</p>
</li>
<li>
<p>cacheMgr</p>
</li>
<li>
<p>gcMgr</p>
</li>
<li>
<p>tenantMgr</p>
</li>
<li>
<p>NetworkMgr</p>
</li>
</ul>
<p>每个manager的实现细节此处暂不做分析。</p>
<p>此处先贴一下完整源码，避免读者还需要去翻代码。</p>
<blockquote>
<p>代码：<a href="https://github.com/openyurtio/openyurt/blob/180282663457080119a1bc6076cce20c922b5c50/cmd/yurthub/app/start.go">/cmd/yurthub/app/start.go</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run runs the YurtHubConfiguration. This should never exit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurtHubConfiguration</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">trace</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. new transport manager&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 构造NewTransportManager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">transportManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">transport</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTransportManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;could not new transport manager, %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">trace</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. prepare cloud kube clients&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cloudClients</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createClients</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HeartbeatTimeoutSeconds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteServers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoordinatorServerURL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">transportManager</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to create cloud clients, %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">trace</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">cloudHealthChecker</span> <span style="color:#000">healthchecker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MultipleBackendsHealthChecker</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingMode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingModeEdge</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. create health checkers for remote servers and pool coordinator&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cloudHealthChecker</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">healthchecker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCloudAPIServerHealthChecker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cloudClients</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;could not new cloud health checker, %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. disable health checker for node %s because it is a cloud node&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// In cloud mode, cloud health checker is not needed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// This fake checker will always report that the cloud is healthy and pool coordinator is unhealthy.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">cloudHealthChecker</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">healthchecker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewFakeChecker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">trace</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. new restConfig manager&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">restConfigMgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">hubrest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRestConfigManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cloudHealthChecker</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;could not new restConfig manager, %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">trace</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">cacheMgr</span> <span style="color:#000">cachemanager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CacheManager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingMode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingModeEdge</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. new cache manager with storage wrapper and serializer manager&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cacheMgr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cachemanager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCacheManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageWrapper</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SerializerManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RESTMapperManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedFactory</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. disable cache manager for node %s because it is a cloud node&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">trace</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingMode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingModeEdge</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. new gc manager for node %s, and gc frequency is a random time between %d min and %d min&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GCFrequency</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GCFrequency</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gcMgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">gc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewGCManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">restConfigMgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;could not new gc manager, %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 直接运行manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">gcMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. disable gc manager for node %s because it is a cloud node&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">trace</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. new tenant sa manager&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tenantMgr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">tenant</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TenantNs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedFactory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">trace</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">coordinatorHealthCheckerGetter</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">healthchecker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HealthChecker</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">getFakeCoordinatorHealthChecker</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">coordinatorTransportManagerGetter</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">transport</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">getFakeCoordinatorTransportManager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">coordinatorGetter</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">poolcoordinator</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Coordinator</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">getFakeCoordinator</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableCoordinator</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. start to run coordinator&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">trace</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">coordinatorInformerRegistryChan</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// coordinatorRun will register secret informer into sharedInformerFactory, and start a new goroutine to periodically check
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// if certs has been got from cloud APIServer. It will close the coordinatorInformerRegistryChan if the secret channel has
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// been registered into informer factory.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">coordinatorHealthCheckerGetter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coordinatorTransportManagerGetter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coordinatorGetter</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">coordinatorRun</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">restConfigMgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cloudHealthChecker</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">coordinatorInformerRegistryChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// wait for coordinator informer registry
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;waiting for coordinator informer registry&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">coordinatorInformerRegistryChan</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;coordinator informer registry finished&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Start the informer factory if all informers have been registered
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurtSharedFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. new reverse proxy handler for remote servers&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 将之前构造的manager作为参数构建yurtProxyHandler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">yurtProxyHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">proxy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewYurtReverseProxyHandler</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cacheMgr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">transportManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cloudHealthChecker</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">tenantMgr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">coordinatorGetter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">coordinatorTransportManagerGetter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">coordinatorHealthCheckerGetter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;could not create reverse proxy handler, %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">trace</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NetworkMgr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NetworkMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d. new %s server and begin to serve&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetHubName</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 基于yurtProxyHandler运行一个http server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunYurtHubServers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yurtProxyHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">restConfigMgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;could not run hub servers, %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hub agent exited&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>除了上述的各种manager的构造及运行外，run函数中还构建了<code>yurtProxyHandler</code>，最终执行<code>RunYurtHubServers</code>运行一组不会退出的http server。以下先不对manager的实现做展开，而直接分析RunYurtHubServers的逻辑。RunYurtHubServers的代码在pkg包中。</p>
<h1 id="3-runyurthubservers">3. RunYurtHubServers</h1>
<p>RunYurtHubServers就是一个传统的http server的运行逻辑，主要包括几个不同类型的http server。http server的运行逻辑可以概括如下：</p>
<ol>
<li>
<p>hubServerHandler := mux.NewRouter()： 新建路由创建handler</p>
</li>
<li>
<p>registerHandlers(hubServerHandler, cfg, rest)： 注册路由</p>
</li>
<li>
<p>YurtHubServerServing.Serve：执行http server.Serve函数启动一个server服务。</p>
</li>
</ol>
<p>http server分为两类：</p>
<ul>
<li>
<p>yurthub http server: yurthub metrics, healthz的接口。</p>
</li>
<li>
<p>yurthub proxy server: 代理kube-apiserver的请求。</p>
</li>
</ul>
<h2 id="3-1-yurthubserverserving">3.1. YurtHubServerServing</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#000">hubServerHandler</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRouter</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">registerHandlers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">hubServerHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// start yurthub http server for serving metrics, pprof.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurtHubServerServing</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurtHubServerServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">hubServerHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>registerHandlers的路由内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// registerHandler registers handlers for yurtHubServer, and yurtHubServer can handle requests like profiling, healthz, update token.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">registerHandlers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Router</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurtHubConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rest</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RestConfigManager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// register handlers for update join token
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/v1/token&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">updateTokenHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertManager</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#000">Methods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;POST&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;PUT&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// register handler for health check
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/v1/healthz&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">healthz</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Methods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;GET&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/v1/readyz&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">readyz</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertManager</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#000">Methods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;GET&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// register handler for profile
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableProfiling</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">profile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Install</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// register handler for metrics
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/metrics&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">promhttp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// register handler for ota upgrade
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/pods&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ota</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageWrapper</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#000">Methods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;GET&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/openyurt.io/v1/namespaces/{ns}/pods/{podname}/upgrade&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ota</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HealthyCheck</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ota</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#000">Methods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;POST&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以上路由不做深入分析。</p>
<h2 id="3-2-yurthubproxyserverserving">3.2. YurtHubProxyServerServing</h2>
<p>YurtHubProxyServerServing主要代理kube-apiserver的转发请求。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// start yurthub proxy servers for forwarding requests to cloud kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingMode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingModeEdge</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">proxyHandler</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">wrapNonResourceHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">proxyHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurtHubProxyServerServing</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurtHubProxyServerServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">proxyHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下分析yurtProxyHandler的逻辑。</p>
<h2 id="3-3-newyurtreverseproxyhandler">3.3. NewYurtReverseProxyHandler</h2>
<p>NewYurtReverseProxyHandler主要创建了http handler 代理所有转发请求。</p>
<p>1、创建Load Balancer，主要用来转发apiserver的请求。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#000">lb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">remote</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewLoadBalancer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">yurtHubCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LBMode</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">yurtHubCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteServers</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">localCacheMgr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">transportMgr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">coordinatorGetter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cloudHealthChecker</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">yurtHubCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FilterManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">yurtHubCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingMode</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>2、创建local Proxy，主要用来转发本地缓存的请求。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// When yurthub works in Edge mode, we may use local proxy or pool proxy to handle
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// the request when offline.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">localProxy</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">local</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewLocalProxy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">localCacheMgr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">cloudHealthChecker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsHealthy</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">isCoordinatorHealthy</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">yurtHubCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MinRequestTimeout</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">localProxy</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">local</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithFakeTokenInject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">localProxy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yurtHubCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SerializerManager</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>3、创建yurtReverseProxy</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#000">yurtProxy</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">yurtReverseProxy</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">resolver</span><span style="color:#000;font-weight:bold">:</span>                      <span style="color:#000">resolver</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">loadBalancer</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#000">lb</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cloudHealthChecker</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">cloudHealthChecker</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">coordinatorHealtCheckerGetter</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">coordinatorHealthCheckerGetter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">localProxy</span><span style="color:#000;font-weight:bold">:</span>                    <span style="color:#000">localProxy</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">poolProxy</span><span style="color:#000;font-weight:bold">:</span>                     <span style="color:#000">poolProxy</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxRequestsInFlight</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">yurtHubCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxRequestInFlight</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">isCoordinatorReady</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">isCoordinatorReady</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">enablePoolCoordinator</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">yurtHubCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableCoordinator</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">tenantMgr</span><span style="color:#000;font-weight:bold">:</span>                     <span style="color:#000">tenantMgr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">workingMode</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">yurtHubCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingMode</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">yurtProxy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">buildHandlerChain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yurtProxy</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span></code></pre></div><h1 id="4-yurtreverseproxy">4. yurtReverseProxy</h1>
<p><code>yurtReverseProxy</code>主要是作为实现反向代理的结构体。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">yurtReverseProxy</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">resolver</span>                      <span style="color:#000">apirequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestInfoResolver</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">loadBalancer</span>                  <span style="color:#000">remote</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LoadBalancer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cloudHealthChecker</span>            <span style="color:#000">healthchecker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MultipleBackendsHealthChecker</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">coordinatorHealtCheckerGetter</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">healthchecker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HealthChecker</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">localProxy</span>                    <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">poolProxy</span>                     <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxRequestsInFlight</span>           <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tenantMgr</span>                     <span style="color:#000">tenant</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">isCoordinatorReady</span>            <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">workingMode</span>                   <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingMode</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">enablePoolCoordinator</span>         <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>反向代理服务</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">yurtReverseProxy</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workingMode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingModeCloud</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">loadBalancer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsKubeletLeaseReq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handleKubeletLease</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsEventCreateRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsPoolScopedResouceListWatchRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">poolScopedResouceHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsSubjectAccessReviewCreateGetRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subjectAccessReviewHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// For resource request that do not need to be handled by pool-coordinator,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// handling the request with cloud apiserver or local cache.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cloudHealthChecker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsHealthy</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">loadBalancer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localProxy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心逻辑：如果是云端apiserver可以访问的通，则通过loadbalaner来转发，否则就通过localproxy来转发读取本地节点的数据。</p>
<h1 id="5-loadbalancer">5. LoadBalancer</h1>
<p>LoadBalancer是个本地的负载均衡逻辑，通过轮询的方式去请求cloud的apiserver，当云边网络通信是正常的时候反向代理apiserver的请求，并做本地缓存持久化。断网的时候则读取本地的缓存数据。</p>
<ul>
<li>
<p>backends：真实反向代理的后端</p>
</li>
<li>
<p>algo: 处理负载均衡策略，轮询或者按优先级</p>
</li>
<li>
<p>localCacheMgr: 本地缓存管理的manager</p>
</li>
</ul>
<blockquote>
<p>代码：<a href="https://github.com/openyurtio/openyurt/blob/180282663457080119a1bc6076cce20c922b5c50/pkg/yurthub/proxy/remote/loadbalancer.go">/pkg/yurthub/proxy/remote/loadbalancer.go</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">loadBalancer</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">backends</span>          <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteProxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">algo</span>              <span style="color:#000">loadBalancerAlgo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">localCacheMgr</span>     <span style="color:#000">cachemanager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CacheManager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">filterManager</span>     <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">coordinatorGetter</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">poolcoordinator</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Coordinator</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">workingMode</span>       <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkingMode</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">stopCh</span>            <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-1-newloadbalancer">5.1. NewLoadBalancer</h2>
<p>NewLoadBalancer构建一个remote的反向代理，主要包含添加romote server proxy和处理负载均衡策略两部分。</p>
<p>1、添加多个apiserver的地址，创建remote proxy实现反向代理操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#000">backends</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteProxy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">remoteServers</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">remoteServers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRemoteProxy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">remoteServers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">lb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">modifyResponse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">errorHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">transportMgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;could not new proxy backend(%s), %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">remoteServers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">backends</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">backends</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>2、处理负载均衡策略：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">algo</span> <span style="color:#000">loadBalancerAlgo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">lbMode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;rr&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">algo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rrLoadBalancerAlgo</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">backends</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backends</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">checker</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">healthChecker</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;priority&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">algo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">priorityLoadBalancerAlgo</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">backends</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backends</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">checker</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">healthChecker</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">algo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rrLoadBalancerAlgo</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">backends</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backends</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">checker</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">healthChecker</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-2-loadbalancer-servehttp">5.2. loadBalancer.ServeHTTP</h2>
<p>loadBalancer实现ServeHTTP的接口，通过负载均衡策略挑选出一个可用的反向代理backend。再调用backend的ServeHTTP方法实现具体的反向代理操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// pick a remote proxy based on the load balancing algorithm.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">rp</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">lb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">algo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PickOne</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="5-3-errorhandler">5.3. errorHandler</h2>
<p>如果请求apiserver失败，当verb=get/list, 则读取cache中的内容。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lb</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">loadBalancer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">errorHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;remote proxy error handler: %s, %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">lb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localCacheMgr</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">lb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localCacheMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CanCacheFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">rw</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatusBadGateway</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">info</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">apirequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestInfoFrom</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">info</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Verb</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;get&#34;</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">info</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Verb</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;list&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a40000">#</span> <span style="color:#000">读取cache内容</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">lb</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localCacheMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QueryCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteObject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatusOK</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rw</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteHeader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatusBadGateway</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-4-querycache">5.4. QueryCache</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// QueryCache get runtime object from backend storage for request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cm</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">QueryCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">info</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">apirequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestInfoFrom</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">info</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">info</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Resource</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to get request info for request %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">info</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsResourceRequest</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to QueryCache for getting non-resource request %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a40000">#</span> <span style="color:#000">根据verb查询storage中的数据</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">info</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Verb</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queryListObject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;patch&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queryOneObject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to QueryCache, unsupported verb %s of request %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">info</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Verb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-5-查询storage中的数据">5.5. 查询storage中的数据</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cm</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cacheManager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">queryOneObject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;component: %s try to get key: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">comp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Key</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">storage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to get obj %s from storage, %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Key</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>目前存储有两种接口实现，一个是本地磁盘存储，一个是etcd存储。以下以磁盘存储为例分析。</p>
<blockquote>
<p>代码：<a href="https://github.com/openyurtio/openyurt/blob/180282663457080119a1bc6076cce20c922b5c50/pkg/yurthub/storage/disk/storage.go">/pkg/yurthub/storage/disk/storage.go</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Get will get content from the regular file that specified by key.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If key points to a dir, return ErrKeyHasNoContent.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ds</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">diskStorage</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#000">storage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utils</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValidateKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">storageKey</span><span style="color:#000;font-weight:bold">{});</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">storage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrKeyIsEmpty</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">storageKey</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">storageKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ds</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lockKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">storageKey</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">storage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrStorageAccessConflict</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unLockKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">storageKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ds</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">baseDir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">storageKey</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Key</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fsOperator</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrNotExists</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">storage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrStorageNotFound</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrIsNotFile</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">storage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrKeyHasNoContent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to read file at %s, %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="6-remoteproxy">6. RemoteProxy</h1>
<p>RemoteProxy实现一个具体的反向代理操作。</p>
<p>字段说明：</p>
<ul>
<li>
<p>reverseProxy：http的ReverseProxy</p>
</li>
<li>
<p>remoteServer：apiserver的地址</p>
</li>
</ul>
<blockquote>
<p>代码：<a href="https://github.com/openyurtio/openyurt/blob/180282663457080119a1bc6076cce20c922b5c50/pkg/yurthub/proxy/util/remote.go">/pkg/yurthub/proxy/util/remote.go</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// RemoteProxy is an reverse proxy for remote server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">RemoteProxy</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">reverseProxy</span>         <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">httputil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReverseProxy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">remoteServer</span>         <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">currentTransport</span>     <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RoundTripper</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bearerTransport</span>      <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RoundTripper</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">upgradeHandler</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">proxy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpgradeAwareHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">bearerUpgradeHandler</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">proxy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpgradeAwareHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">stopCh</span>               <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>实现ReverseProxy的ServeHTTP接口。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rp</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RemoteProxy</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">httpstream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsUpgradeRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;get upgrade request %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isBearerRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">rp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bearerUpgradeHandler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">rp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">upgradeHandler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">rp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reverseProxy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>实现错误处理的接口。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">responder</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed while proxying request %s, %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatusInternalServerError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="7-localproxy">7. LocalProxy</h1>
<p>LocalProxy是一个当云边网络断开的时候，用于处理本地kubelet请求的数据的代理。</p>
<p>字段说明：</p>
<ul>
<li>cacheMgr：主要包含本地cache的一个处理管理器。</li>
</ul>
<blockquote>
<p>代码：<a href="https://github.com/openyurtio/openyurt/blob/180282663457080119a1bc6076cce20c922b5c50/pkg/yurthub/proxy/local/local.go">/pkg/yurthub/proxy/local/local.go</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// LocalProxy is responsible for handling requests when remote servers are unhealthy
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">LocalProxy</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cacheMgr</span>           <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CacheManager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">isCloudHealthy</span>     <span style="color:#000">IsHealthy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">isCoordinatorReady</span> <span style="color:#000">IsHealthy</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">minRequestTimeout</span>  <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>LocalProxy实现ServeHTTP接口，根据不同的k8s请求类型，执行不同的操作：</p>
<ul>
<li>
<p>watch：lp.localWatch(w, req)</p>
</li>
<li>
<p>create：lp.localPost(w, req)</p>
</li>
<li>
<p>delete, deletecollection: localDelete(w, req)</p>
</li>
<li>
<p>list., get, update：lp.localReqCache(w, req)</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ServeHTTP implements http.Handler for LocalProxy
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lp</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">LocalProxy</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">reqInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">apirequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestInfoFrom</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">reqInfo</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">reqInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsResourceRequest</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;go into local proxy for request %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">reqInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Verb</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;watch&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">lp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localWatch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">lp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localPost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;deletecollection&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">localDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// list, get, update
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">lp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">localReqCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;could not proxy local for %s, %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Err</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;local proxy does not support request(%s), requestInfo: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqInfoString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reqInfo</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Err</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">apierrors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBadRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;local proxy does not support request(%s)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">))),</span> <span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="7-1-localreqcache">7.1. localReqCache</h2>
<p>当边缘网络断连的时候，kubelet执行get list的操作时，通过localReqCache请求本地缓存的数据，返回给kubelet对应的k8s元数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// localReqCache handles Get/List/Update requests when remote servers are unhealthy
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lp</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">LocalProxy</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">localReqCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">lp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CanCacheFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;can not cache for %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">apierrors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBadRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;can not cache for %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">lp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QueryCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Is</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">storage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrStorageNotFound</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Is</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hubmeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrGVRNotRecognized</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;object not found for %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">reqInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">apirequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestInfoFrom</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">apierrors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNotFound</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupResource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Group</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">reqInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">APIGroup</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Resource</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">reqInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Resource</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">reqInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to query cache for %s, %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">apierrors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInternalError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">obj</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;no cache object for %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">apierrors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInternalError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;no cache object for %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hubutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReqString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteObject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatusOK</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码为：</p>
<p>查询本地缓存，返回缓存数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">lp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QueryCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteObject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatusOK</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="总结">总结</h1>
<p>yurthub是实现边缘断网自治的核心组件，核心逻辑是kubelet向apiserver的请求会通过yurhub进行转发，如果apiserver的接口可通，则将请求结果返回，并存储到本地，如果接口不可通，则读取本地的数据。</p>
<p>yurthub本质是一个反向代理的http server, 核心逻辑主要包括 ：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">proxy</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">反向代理的实现</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cachemanager</span><span style="color:#a40000">：</span><span style="color:#000">cache的实现</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">storage</span><span style="color:#a40000">：</span><span style="color:#000">本地存储的实现</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/openyurtio/openyurt">https://github.com/openyurtio/openyurt</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1069f62a63aea9ada9ee4b47caf8d66a">14.2.3.2 - OpenYurt之TunnelServer源码分析</h1>
    
	<blockquote>
<p>本文以commit id：<code>180282663457080119a1bc6076cce20c922b5c50</code>， 对应版本tag: <code>v1.2.1</code> 的源码分析tunnel-server的实现逻辑。</p>
</blockquote>
<h1 id="1-tunnel-server简介">1. Tunnel-server简介</h1>
<p>云与边一般位于不同网络平面，同时边缘节点普遍位于防火墙内部，采用云(中心)边协同架构，将导致原生 K8s 系统的运维监控能力面临如下挑战:</p>
<ul>
<li>K8s 原生运维能力缺失(如 kubectl logs/exec 等无法执行)</li>
<li>社区主流监控运维组件无法工作(如 Prometheus/metrics-server )</li>
</ul>
<p>在 OpenYurt 中，引入了专门的组件 YurtTunnel 负责解决云边通信问题。反向通道是解决跨网络通信的一种常见方式，而 YurtTunnel 的本质也是一个反向通道。 它是一个典型的C/S结构的组件，由部署于云端的 YurtTunnelServer 和部署于边缘节点上的 YurtTunnelAgent组成。</p>
<p>本文主要分析tunnel-server的代理逻辑。</p>
<p>以下是基本架构图：</p>
<img title="" src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1682566581/article/openyurt/tunnel_components.jpg" alt="" width="628">
<p>pkg中的目录结构：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>yurttunnel
</span></span><span style="display:flex;"><span>├── agent  <span style="color:#8f5902;font-style:italic"># tunnel agent代码</span>
</span></span><span style="display:flex;"><span>├── constants <span style="color:#8f5902;font-style:italic"># 常量值</span>
</span></span><span style="display:flex;"><span>├── handlerwrapper
</span></span><span style="display:flex;"><span>├── informers
</span></span><span style="display:flex;"><span>├── kubernetes  <span style="color:#8f5902;font-style:italic"># k8s clientset工具包</span>
</span></span><span style="display:flex;"><span>├── server  <span style="color:#8f5902;font-style:italic"># 核心代码： tunnel server逻辑</span>
</span></span><span style="display:flex;"><span>├── trafficforward  <span style="color:#8f5902;font-style:italic"># iptables和dns操作</span>
</span></span><span style="display:flex;"><span>└── util
</span></span></code></pre></div><h1 id="2-newyurttunnelservercommand">2. NewYurttunnelServerCommand</h1>
<p>main函数入口：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewYurttunnelServerCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddGoFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s failed: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetServerName</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下是NewYurttunnelServerCommand构造函数，常见的三件套，不做展开：</p>
<ul>
<li>
<p>读取参数：serverOptions.AddFlags(cmd.Flags())</p>
</li>
<li>
<p>生成配置：cfg.Complete()</p>
</li>
<li>
<p>执行Run函数：核心逻辑</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewYurttunnelServerCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">serverOptions</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServerOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;Launch &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetServerName</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Short</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetServerName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; sends requests to &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetAgentName</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">RunE</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">serverOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Args</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NoArgs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">serverOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-run-cfg-complete-stopch">3. Run(cfg.Complete(), stopCh)</h1>
<p>Run函数最终是运行一个tunnelserver的常驻进程。在之前会做一些controller或manager的准备工作。</p>
<p>其中包括：</p>
<ul>
<li>
<p>DNS controller</p>
</li>
<li>
<p>IP table manager</p>
</li>
<li>
<p>certificate manager</p>
</li>
<li>
<p>RegisterInformersForTunnelServer</p>
</li>
</ul>
<p>首先是构建并运行上述的manager或controller， 源码中的注释也大概描述了主要流程：</p>
<ol>
<li>
<p>注册tunnel所需的SharedInformerFactory</p>
</li>
<li>
<p>运行dns controller</p>
</li>
<li>
<p>运行ip table manager</p>
</li>
<li>
<p>给tunnel server创建certificate manager</p>
</li>
<li>
<p>给tunnel agent 创建certificate manager</p>
</li>
<li>
<p>创建handler wrappers</p>
</li>
<li>
<p>生成TLS 证书</p>
</li>
<li>
<p>运行tunnel server</p>
</li>
</ol>
<p>以下是部分代码，已删除无关紧要的代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// run starts the yurttunel-server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CompletedConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// register informers that tunnel server need
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">informers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterInformersForTunnelServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedInformerFactory</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 0. start the DNS controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableDNSController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dnsController</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dns</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCoreDNSRecordController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">dnsController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 1. start the IP table manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableIptables</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">iptablesMgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">iptables</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewIptablesManagerWithIPFamily</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">iptablesMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 2. create a certificate manager for the tunnel server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">certManagerFactory</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">certfactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCertManagerFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ips</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dnsNames</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getTunnelServerIPsAndDNSNamesBeforeInformerSynced</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">serverCertMgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">certManagerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">serverCertMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 3. create a certificate manager for the tunnel proxy client
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">tunnelProxyCertMgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">certManagerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tunnelProxyCertMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 4. create handler wrappers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">mInitializer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">initializer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMiddlewareInitializer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedInformerFactory</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">wrappers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">wraphandler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitHandlerWrappers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mInitializer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsIPv6</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// after all of informers are configured completed, start the shared index informer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedInformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 5. waiting for the certificate is generated
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PollUntil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// keep polling until the certificate is signed
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">serverCertMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Current</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">tunnelProxyCertMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Current</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;waiting for the master to sign the %s certificate&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetServerName</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 6. generate the TLS configuration based on the latest certificate
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">tlsCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">certmanager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenTLSConfigUseCurrentCertAndCertPool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serverCertMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Current</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RootCert</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;server&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">proxyClientTlsCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">certmanager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenTLSConfigUseCurrentCertAndCertPool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tunnelProxyCertMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Current</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RootCert</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;client&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 7. start the server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">ts</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTunnelServer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EgressSelectorEnabled</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InterceptorServerUDSFile</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAddrForMaster</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenInsecureAddrForMaster</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAddrForAgent</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">tlsCfg</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">proxyClientTlsCfg</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">wrappers</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProxyStrategy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 8. start meta server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunMetaServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenMetaAddr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-tunnelserver">3. TunnelServer</h1>
<p>anpTunnelServer实现了TunnelServer的接口，以下分析TunnelServer.Run的部分。</p>
<p>run部分主要运行了三个server</p>
<ul>
<li>
<p>proxyServer： 主要是重定向apiserver的请求到tunnel server</p>
</li>
<li>
<p>MasterServer：</p>
</li>
<li>
<p>AgentServer：主要运行一个grpc server与tunnel agent连接，即云边反向隧道</p>
</li>
</ul>
<blockquote>
<p>代码参考：<a href="https://github.com/openyurtio/openyurt/blob/180282663457080119a1bc6076cce20c922b5c50/pkg/yurttunnel/server/anpserver.go">/pkg/yurttunnel/server/anpserver.go</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run runs the yurttunnel-server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ats</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">anpTunnelServer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">proxyServer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">anpserver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewProxyServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uuid</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">anpserver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProxyStrategy</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">anpserver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProxyStrategy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">proxyStrategy</span><span style="color:#000;font-weight:bold">)},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">anpserver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AgentTokenAuthenticationOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 1. start the proxier
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">proxierErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">runProxier</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">anpserver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Tunnel</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">proxyServer</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">egressSelectorEnabled</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptorServerUDSFile</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tlsCfg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">wrappedHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">wh</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WrapHandler</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">NewRequestInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">interceptorServerUDSFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">proxyClientTlsCfg</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrappers</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 2. start the master server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">masterServerErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">runMasterServer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">wrappedHandler</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">egressSelectorEnabled</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverMasterAddr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverMasterInsecureAddr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tlsCfg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 3. start the agent server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">agentServerErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">runAgentServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tlsCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverAgentAddr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">proxyServer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-runagentserver">4. runAgentServer</h1>
<p>runAgentServer主要运行一个grpc server与edge端的agent形成grpc连接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// runAgentServer runs a grpc server that handles connections from the yurttunel-agent
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NOTE agent server is responsible for managing grpc connection yurttunel-server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and yurttunnel-agent, and the proxy server is responsible for redirecting requests
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to corresponding yurttunel-agent
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">runAgentServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tlsCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tls</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">agentServerAddr</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">proxyServer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">anpserver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProxyServer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">serverOption</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Creds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">credentials</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTLS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tlsCfg</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ka</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">keepalive</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerParameters</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Ping the client if it is idle for `Time` seconds to ensure the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// connection is still active
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">constants</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurttunnelANPGrpcKeepAliveTimeSec</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Wait `Timeout` second for the ping ack before assuming the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// connection is dead
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">Timeout</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">constants</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurttunnelANPGrpcKeepAliveTimeoutSec</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">grpcServer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serverOption</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeepaliveParams</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ka</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">anpagent</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterAgentServiceServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">grpcServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">proxyServer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">listener</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">agentServerAddr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;start handling connection from agents&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fail to listen to agent on %s: %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">agentServerAddr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">grpcServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">listener</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-interceptor">5. Interceptor</h1>
<p>Interceptor（请求拦截器）拦截kube-apiserver的请求转发给tunnel，通过tunnel请求kubelet。</p>
<p>流程图：</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1683615159/article/openyurt/tunnel_sequence_diag.webp" title="" alt="" width="719">
<blockquote>
<p>代码地址：<a href="https://github.com/openyurtio/openyurt/blob/180282663457080119a1bc6076cce20c922b5c50/pkg/yurttunnel/server/interceptor.go">/pkg/yurttunnel/server/interceptor.go</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewRequestInterceptor creates a interceptor object that intercept request from kube-apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewRequestInterceptor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">udsSockFile</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tls</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RequestInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">udsSockFile</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InsecureSkipVerify</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">contextDialer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addr</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">header</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Header</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isTLS</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Sending request to %q.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">proxyConn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dial</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unix&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">udsSockFile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;dialing proxy %q failed: %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">udsSockFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">connectHeaders</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">supportedHeaders</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">header</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">h</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">connectHeaders</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s\r\n%s: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">connectHeaders</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">proxyConn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;CONNECT %s HTTP/1.1\r\nHost: localhost%s\r\n\r\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">connectHeaders</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">br</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">newBufioReader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">proxyConn</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">putBufioReader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">br</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadResponse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">br</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">proxyConn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;reading HTTP response from CONNECT to %s via proxy %s failed: %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">udsSockFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatusCode</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">200</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">proxyConn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;proxy error from %s while dialing %s, code %d: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">udsSockFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatusCode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// if the request scheme is https, setup a tls connection over the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// proxy tunnel (i.e. interceptor &lt;--tls--&gt; kubelet)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isTLS</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">tlsTunnelConn</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">tls</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">proxyConn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">tlsTunnelConn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handshake</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">proxyConn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fail to setup TLS handshake through the Tunnel: %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;successfully setup TLS connection to %q with headers: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">connectHeaders</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">tlsTunnelConn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;successfully setup connection to %q with headers: %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">connectHeaders</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">proxyConn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">RequestInterceptor</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">contextDialer</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">contextDialer</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://openyurt.io/zh/docs/core-concepts/yurttunnel">https://openyurt.io/zh/docs/core-concepts/yurttunnel</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3b9e3758058f48d61627e36fd3599ee0">14.2.3.3 - OpenYurt之Tunnel-Agent源码分析</h1>
    
	<h1 id="1-tunnel-agent简介">1. Tunnel-Agent简介</h1>
<p>tunnel-agent是通过daemonset部署在每个worker节点，通过grpc协议与云端的tunnel-server建立连接。以下分析tunnel-agent的源码逻辑。</p>
<p>常用的启动参数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>      - args:
</span></span><span style="display:flex;"><span>        - --node-name<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>NODE_NAME<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        - --node-ip<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>POD_IP<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        - --tunnelserver-addr<span style="color:#ce5c00;font-weight:bold">=</span>tunnel-server-address<span style="color:#ce5c00;font-weight:bold">[</span>ip:port<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>        - --v<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>        command:
</span></span><span style="display:flex;"><span>        - yurt-tunnel-agent
</span></span></code></pre></div><h1 id="2-newyurttunnelagentcommand">2. NewYurttunnelAgentCommand</h1>
<p>NewYurttunnelAgentCommand还是常用命令代码三板斧，此处不做展开，直接分析Run函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewYurttunnelAgentCommand creates a new yurttunnel-agent command
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewYurttunnelAgentCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">agentOptions</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAgentOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 已经删除非重要的代码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">RunE</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">agentOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">agentOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-run">3. Run</h1>
<p>Run函数即启动一个agent服务，主要包含以下几个步骤：</p>
<ol>
<li>
<p>先获取配置项tunnelserver-addr中的地址，如果地址不存在，则获取x-tunnel-server-svc的service 地址。（说明：一般情况下，tunnel-server跟agent不在同一个网络域，因此网络会不通，所以一般需要配置独立且可连通的地址，可以通过Nginx转发）</p>
</li>
<li>
<p>agent通过host的网络模式运行在宿主机上，启动证书manager。并等待证书生成。</p>
</li>
<li>
<p>生成连接tunnel-server的证书。</p>
</li>
<li>
<p>启动 yurttunnel-agent。</p>
</li>
<li>
<p>启动meta server。</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run starts the yurttunel-agent
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CompletedConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 1. get the address of the yurttunnel-server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">tunnelServerAddr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TunnelServerAddr</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tunnelServerAddr</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tunnelServerAddr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">serveraddr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetTunnelServerAddr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 2. create a certificate manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// As yurttunnel-agent will run on the edge node with Host network mode,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// we can use the status.podIP as the node IP
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">nodeIP</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">constants</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurttunnelAgentPodIPEnv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">agentCertMgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">certfactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCertManagerFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">certfactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertManagerConfig</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ComponentName</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetAgentName</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">CertDir</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertDir</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">SignerName</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">certificatesv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeAPIServerClientSignerName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">CommonName</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">constants</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurtTunnelAgentCSRCN</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Organizations</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">constants</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurtTunnelCSROrg</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">DNSNames</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NODE_NAME&#34;</span><span style="color:#000;font-weight:bold">)},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">IPs</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IP</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseIP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeIP</span><span style="color:#000;font-weight:bold">)},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">agentCertMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 2.1. waiting for the certificate is generated
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PollUntil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">agentCertMgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Current</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;certificate %s not signed, waiting...&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetAgentName</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 3. generate a TLS configuration for securing the connection to server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">tlsCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">certmanager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenTLSConfigUseCertMgrAndCA</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">agentCertMgr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">tunnelServerAddr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">constants</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">YurttunnelCAFile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 4. start the yurttunnel-agent
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">ta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">agent</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTunnelAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tlsCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tunnelServerAddr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AgentIdentifiers</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 5. start meta server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunMetaServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AgentMetaAddr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-tunnelagent">4. TunnelAgent</h1>
<p>TunnelAgent与tunnel-server建立tunnel，接收server的请求，并转发给kubelet。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TunnelAgent sets up tunnel to TunnelServer, receive requests
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// from tunnel, and forwards requests to kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">TunnelAgent</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewTunnelAgent generates a new TunnelAgent
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewTunnelAgent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tlsCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">tls</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tunnelServerAddr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">agentIdentifiers</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">TunnelAgent</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ata</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">anpTunnelAgent</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">tlsCfg</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">tlsCfg</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">tunnelServerAddr</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">tunnelServerAddr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">agentIdentifiers</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">agentIdentifiers</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ata</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-anptunnelagent-run">5. anpTunnelAgent.Run</h1>
<p>anpTunnelAgent使用apiserver-network-proxy包来实现tunnel逻辑。项目具体参考：<a href="https://github.com/kubernetes-sigs/apiserver-network-proxy">https://github.com/kubernetes-sigs/apiserver-network-proxy</a>)</p>
<blockquote>
<p>代码：<a href="https://github.com/openyurtio/openyurt/blob/180282663457080119a1bc6076cce20c922b5c50/pkg/yurttunnel/agent/anpagent.go">/pkg/yurttunnel/agent/anpagent.go</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// RunAgent runs the yurttunnel-agent which will try to connect yurttunnel-server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ata</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">anpTunnelAgent</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dialOption</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTransportCredentials</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">credentials</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTLS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ata</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tlsCfg</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">anpagent</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientSetConfig</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Address</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">ata</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tunnelServerAddr</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// 指定反向连接的目标地址
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">AgentID</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">ata</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">AgentIdentifiers</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">ata</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">agentIdentifiers</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">SyncInterval</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ProbeInterval</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">DialOptions</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DialOption</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">dialOption</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ServiceAccountTokenPath</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 调用apiserver-network-proxy的包来创建双向的grpc连接。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">cs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAgentClientSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;start serving grpc request redirected from %s: %s&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">projectinfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetServerName</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">ata</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tunnelServerAddr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下是apiserver-network-proxy的源码分析。</p>
<h1 id="6-apiserver-network-proxy-client分析">6. apiserver-network-proxy.Client分析</h1>
<p>具体代码参考：</p>
<ul>
<li><a href="https://github.com/kubernetes-sigs/apiserver-network-proxy/blob/master/pkg/agent/clientset.go">https://github.com/kubernetes-sigs/apiserver-network-proxy/blob/master/pkg/agent/clientset.go</a></li>
</ul>
<p>通过<code>NewAgentClientSet</code>创建一个client结构体。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ClientSetConfig</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">NewAgentClientSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ClientSet</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ClientSet</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">clients</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">agentID</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">cc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AgentID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">agentIdentifiers</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">cc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AgentIdentifiers</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">address</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">cc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">syncInterval</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">cc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncInterval</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">probeInterval</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">cc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProbeInterval</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">dialOptions</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">cc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DialOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">serviceAccountTokenPath</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceAccountTokenPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-1-client-serve">6.1. client.Serve</h2>
<p>client.Serve运行一个sync的goroutine的常驻进程，再调用syncOnce函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 运行一个sync的goroutine
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ClientSet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// sync makes sure that #clients &gt;= #proxy servers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ClientSet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shutdown</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">backoff</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resetBackoff</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">duration</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncOnce</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cannot sync once&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">duration</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">backoff</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">backoff</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resetBackoff</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">duration</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Jitter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">backoff</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backoff</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Jitter</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">duration</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>syncOnce</code>运行了真正执行grpc通信的client。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ClientSet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncOnce</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCount</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientsCount</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCount</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 创建封装的grpc client
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">serverCount</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">newAgentClient</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCount</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCount</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">serverCount</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">InfoS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server count change suggestion by server&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34;current&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCount</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;serverID&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;actual&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">serverCount</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCount</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">serverCount</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;closing connection failure when adding a client&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">InfoS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sync added client connecting to proxy server&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;serverID&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 运行封装后的grpc 连接
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="7-grpc-client">7. Grpc client</h1>
<p>代码参考：</p>
<ul>
<li><a href="https://github.com/kubernetes-sigs/apiserver-network-proxy/blob/master/pkg/agent/client.go">https://github.com/kubernetes-sigs/apiserver-network-proxy/blob/master/pkg/agent/client.go</a></li>
</ul>
<h2 id="7-1-newagentclient">7.1. newAgentClient</h2>
<p><code>newAgentClient</code>初始化一个grpc client，并启动连接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">newAgentClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">agentID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">agentIdentifiers</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ClientSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DialOption</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cs</span><span style="color:#000;font-weight:bold">:</span>                      <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">address</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">address</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">agentID</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">agentID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">agentIdentifiers</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">agentIdentifiers</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">opts</span><span style="color:#000;font-weight:bold">:</span>                    <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">probeInterval</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeInterval</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">serviceAccountTokenPath</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serviceAccountTokenPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">connManager</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">newConnectionManager</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 启动client的连接
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">serverCount</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">serverCount</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="7-2-connect">7.2. connect</h2>
<p>Connect使grpc连接代理服务器。它返回服务器ID</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Connect makes the grpc dial to the proxy server. It returns the serverID
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// it connects to.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 运行grpc dial连接
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">conn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dial</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">opts</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 已删除非必要的代码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// 创建stream
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">stream</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">agent</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAgentServiceClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conn</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">/* #nosec G104 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">serverID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">serverID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stream</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">/* #nosec G104 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">serverCount</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">serverCount</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stream</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">/* #nosec G104 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">conn</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">conn</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stream</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">stream</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverID</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">serverID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">InfoS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Connect to&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;server&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">serverID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">serverCount</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="7-3-serve">7.3. Serve()</h2>
<p><code>Serve</code>主要启动grpc双向传输通道的goroutine, 主要包括 send（发）和recv（收）2个操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 已经删除次要代码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 收包
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">pkt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recv</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">InfoS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[tracing] recv packet&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;type&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pkt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 根据不同包类型进行不同的处理
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">pkt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PacketType_DIAL_REQ</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">resp</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Packet</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PacketType_DIAL_RSP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Payload</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Packet_DialResponse</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">DialResponse</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DialResponse</span><span style="color:#000;font-weight:bold">{}},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// 运行proxy
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">remoteToProxy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">connID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">proxyToRemote</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">connID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 接收到数据
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PacketType_DATA</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pkt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetData</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConnectID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dataCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Data</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PacketType_CLOSE_REQ</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// 已删除
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="8-remotetoproxy和proxytoremote">8. remoteToProxy和proxyToRemote</h1>
<p>remoteToProxy</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">remoteToProxy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">connID</span> <span style="color:#204a87;font-weight:bold">int64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connContext</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">byte</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">resp</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Packet</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PacketType_DATA</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[:])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">InfoS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;received data from remote&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bytes&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;connID&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">connID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 删除次要代码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">resp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Payload</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Packet_Data</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Data</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Data</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Data</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">ConnectID</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">connID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;stream send failure&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;connID&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">connID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>proxyToRemote</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">proxyToRemote</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">connID</span> <span style="color:#204a87;font-weight:bold">int64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connContext</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dataCh</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pos</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pos</span><span style="color:#000;font-weight:bold">:])</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">InfoS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;write to remote&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;connID&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">connID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;lastData&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">n</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;write to remote with failure&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;connID&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">connID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;lastData&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">pos</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">n</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;use of closed network connection&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;conn write failure&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;connID&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">connID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="9-recv-和send">9. Recv() 和Send()</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pkt</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Packet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sendLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sendLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pkt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EOF</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObserveFailure</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DirectionToServer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Recv</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Packet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recvLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recvLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pkt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recv</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EOF</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObserveFailure</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DirectionFromServer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pkt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="10-总结">10. 总结</h1>
<p>Tunnel-agent本质是封装了<code>apiserver-network-proxy</code>库，最终运行一个grpc的双向收发数据包的通道，所以**本质上tunnel是通过grpc反向建立连接，并实现双向通信的能力。**因此该反向隧道能力的也可以通过其他双向通信的协议来实现，例如websocket（类似kubeedge通过websocket来实现反向隧道）。</p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/openyurtio/openyurt/blob/180282663457080119a1bc6076cce20c922b5c50/pkg/yurttunnel/agent/anpagent.go">/pkg/yurttunnel/agent/anpagent.go</a></li>
<li><a href="https://github.com/kubernetes-sigs/apiserver-network-proxy/blob/master/pkg/agent/client.go">https://github.com/kubernetes-sigs/apiserver-network-proxy/blob/master/pkg/agent/client.go</a></li>
<li><a href="https://github.com/kubernetes-sigs/apiserver-network-proxy/blob/master/pkg/agent/clientset.go">https://github.com/kubernetes-sigs/apiserver-network-proxy/blob/master/pkg/agent/clientset.go</a></li>
</ul>

</div>



    
	
  

    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c210a0cb3a647f8bd4de63d3a48b034f">15 - 虚拟化</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-2cbec24cf3dfd6c5ed1aa52ae9544fe0">15.1 - 虚拟化相关概念</h1>
    
	<h1 id="1-虚拟化">1. 虚拟化</h1>
<p>借助虚拟化技术，用户能以单个物理硬件系统为基础，创建多个模拟环境或专用资源，并使用一款名为“Hypervisor”（虚拟机监控程序）的软件直接连接到硬件，从而将一个系统划分为不同、单独而安全的环境，即虚拟机 (VM)。</p>
<p>虚拟化技术可以重新划分IT资源，提高资源的利用率。</p>
<h1 id="2-虚拟化的类型">2. 虚拟化的类型</h1>
<p><strong>全虚拟化（Full virtualization）</strong></p>
<p>全虚拟化使用未修改的guest操作系统版本，guest直接与CPU通信，是最快的虚拟化方法。</p>
<p><strong>半虚拟化（Paravirtualization）</strong></p>
<p>半虚拟化使用修改过的guest操作系统，guest与hypervisor通信，hypervisor将guest的调用传递给CPU和其他接口。因为通信经过hypervisor，因此比全虚拟化慢。</p>
<h1 id="3-hypervisor">3. hypervisor</h1>
<p><code>hypervisor</code>又称为 <strong>virtual machine monitor</strong> (<strong>VMM</strong>)，是一个创建和运行虚拟机的程序。被 hypervisor 用来运行一个或多个虚拟机的计算机称为宿主机（<code>host machine</code>），这些虚拟机则称为客户机（<code>guest machine</code>）。</p>
<p>在虚拟化技术中，Hypervisor（虚拟机监视器）是一种软件、固件或硬件，能够创建和运行虚拟机（VM）。Hypervisor 起到物理硬件与虚拟机之间的中介作用，管理和分配物理资源（如 CPU、内存、存储和网络）给虚拟机，并确保每个虚拟机的隔离性和安全性。</p>
<p><strong>Hypervisor 的功能</strong></p>
<ol>
<li><strong>虚拟化资源管理</strong>：
<ul>
<li>分配物理硬件资源（CPU、内存、存储、网络）给虚拟机。</li>
<li>管理和调度虚拟机的运行。</li>
</ul>
</li>
<li><strong>虚拟机隔离</strong>：
<ul>
<li>确保虚拟机之间的隔离性，防止一个虚拟机的故障或安全问题影响其他虚拟机。</li>
</ul>
</li>
<li><strong>硬件抽象</strong>：
<ul>
<li>抽象底层硬件，使虚拟机可以运行在不同的硬件平台上，而无需修改虚拟机内的操作系统和应用程序。</li>
</ul>
</li>
<li><strong>资源优化</strong>：
<ul>
<li>动态调整虚拟机资源，提供负载均衡、资源共享和节能功能。</li>
</ul>
</li>
<li><strong>高可用性和容错</strong>：
<ul>
<li>提供虚拟机快照、备份和恢复功能，确保高可用性和数据安全。</li>
<li>支持虚拟机迁移和克隆，方便运维管理。</li>
</ul>
</li>
</ol>
<p><strong>Hypervisor 的优点</strong></p>
<ul>
<li><strong>硬件利用率</strong>：通过虚拟化，可以更高效地利用物理硬件资源，减少硬件浪费。</li>
<li><strong>灵活性</strong>：虚拟机可以轻松创建、删除和迁移，方便开发、测试和部署。</li>
<li><strong>隔离性</strong>：虚拟机之间相互隔离，提高系统安全性和稳定性。</li>
<li><strong>成本效益</strong>：减少对物理硬件的需求，降低硬件和维护成本。</li>
</ul>
<h1 id="4-kvm">4. kvm</h1>
<p><code>kvm(Kernel-based Virtual Machine)</code>是Linux内核的虚拟化模块，可以利用Linux内核的功能来作为hypervisor。</p>
<p>KVM本身不进行模拟，而是暴露一个<code>/dev/kvm</code>接口。</p>
<p>使用KVM，可以在Linux的镜像上</p>
<img src="https://upload.wikimedia.org/wikipedia/commons/5/5c/Kernel-based_Virtual_Machine_zh-CN.svg" width="50%">
<h1 id="5-qemu">5. qemu</h1>
<p>QEMU（Quick Emulator）是一个开源的硬件虚拟化和仿真器软件。它被广泛用于创建和运行虚拟机，支持多种不同的硬件平台和操作系统。以下是对 QEMU 的详细介绍：</p>
<p><strong>QEMU 的主要特点</strong></p>
<ol>
<li><strong>虚拟化和仿真</strong>：
<ul>
<li><strong>虚拟化</strong>：QEMU 能够利用硬件虚拟化技术（如 Intel VT-x 和 AMD-V）来运行虚拟机。通过硬件辅助虚拟化，QEMU 可以提供接近原生性能的虚拟机运行环境。</li>
<li><strong>仿真</strong>：QEMU 还可以完全在软件中仿真硬件，无需硬件虚拟化支持。这种模式下，QEMU 能够仿真多种不同的 CPU 架构（如 x86、ARM、MIPS、PowerPC 等），适用于跨平台开发和测试。</li>
</ul>
</li>
<li><strong>多种平台支持</strong>：
<ul>
<li>QEMU 支持多种不同的主机平台和目标平台，能够在一个平台上运行不同架构的操作系统。这使得 QEMU 成为跨平台开发和测试的理想工具。</li>
</ul>
</li>
<li><strong>与 KVM 集成</strong>：
<ul>
<li>QEMU 可以与内核虚拟机（KVM）集成使用，以提高虚拟化性能。KVM 提供了基于 Linux 内核的高效虚拟化解决方案，而 QEMU 提供了强大的虚拟机管理和仿真功能。</li>
</ul>
</li>
<li><strong>设备仿真</strong>：
<ul>
<li>QEMU 提供了丰富的设备仿真功能，包括网络接口、磁盘存储、图形显示、USB 设备等。这些设备仿真使得虚拟机能够模拟真实硬件环境，方便开发和测试。</li>
</ul>
</li>
<li><strong>快照和恢复</strong>：
<ul>
<li>QEMU 支持虚拟机快照功能，允许用户在特定时刻保存虚拟机的状态，并在需要时恢复到该状态。这对于调试和测试非常有用。</li>
</ul>
</li>
</ol>
<h1 id="6-libvirt">6. libvirt</h1>
<p>Libvirt 是一个开源的虚拟化管理框架和工具集，用于管理不同的虚拟化技术，包括 KVM、QEMU、Xen、VMware ESXi、Hyper-V 以及其他一些虚拟化平台。它提供了一个统一的 API，用于创建、管理和监控虚拟机，使得对不同虚拟化技术的操作更加简化和一致。</p>
<img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/Libvirt_support.svg">
<h2 id="6-1-特点">6.1. 特点</h2>
<ol>
<li><strong>统一接口</strong></li>
</ol>
<ul>
<li>提供了一个统一的 API 和命令行工具，使用户和开发者可以通过一致的接口管理不同的虚拟化技术。</li>
</ul>
<ol start="2">
<li><strong>多种虚拟化技术支持</strong>：
<ul>
<li>支持多种虚拟化平台，如 KVM、QEMU、Xen、VMware ESXi、Hyper-V、LXC（Linux 容器）等，提供跨平台的虚拟化管理功能。</li>
</ul>
</li>
<li><strong>管理和监控</strong>：
<ul>
<li>提供强大的管理和监控功能，包括创建、启动、停止、迁移虚拟机，以及管理存储和网络资源。</li>
</ul>
</li>
<li><strong>XML 配置</strong>：
<ul>
<li>使用 XML 配置文件来定义虚拟机和资源，提供灵活和可扩展的配置方式，易于保存和版本控制。</li>
</ul>
</li>
<li><strong>安全性</strong>：
<ul>
<li>支持多种安全机制，如基于 SELinux 的安全策略，确保虚拟机和宿主系统的隔离性和安全性。</li>
</ul>
</li>
<li><strong>网络管理</strong>：
<ul>
<li>提供网络桥接、NAT、虚拟交换机等网络管理功能，支持复杂的网络拓扑配置。</li>
</ul>
</li>
<li><strong>存储管理</strong>：
<ul>
<li>支持多种存储后端，如本地磁盘、网络文件系统（NFS）、iSCSI、LVM 等，方便虚拟机的存储资源管理。</li>
</ul>
</li>
</ol>
<h2 id="6-2-主要组件">6.2. 主要组件</h2>
<ol>
<li><strong>libvirtd</strong>：
<ul>
<li>Libvirt 的守护进程，负责处理客户端请求和管理虚拟机。通过这个守护进程，可以与不同的虚拟化后端进行交互。</li>
</ul>
</li>
<li><strong>virsh</strong>：
<ul>
<li>Libvirt 的命令行工具，提供了一系列命令用于管理虚拟机和资源。通过 <code>virsh</code>，用户可以执行创建、启动、停止、迁移虚拟机等操作。</li>
</ul>
</li>
<li><strong>libvirt API</strong>：
<ul>
<li>提供 C 语言的库和 API，同时支持多种编程语言的绑定，如 Python、Perl、Ruby、Java、Go 等，使得开发者可以在不同的编程环境中使用 Libvirt 的功能。</li>
</ul>
</li>
</ol>
<h2 id="6-3-virsh命令">6.3. virsh命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 列出所有虚拟机</span>
</span></span><span style="display:flex;"><span>virsh list --all
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动虚拟机</span>
</span></span><span style="display:flex;"><span>virsh start &lt;vm_name&gt;
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 关闭虚拟机</span>
</span></span><span style="display:flex;"><span>virsh shutdown &lt;vm_name&gt;
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 定义新的虚拟机</span>
</span></span><span style="display:flex;"><span>virsh define /path/to/vm.xml
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建并启动虚拟机</span>
</span></span><span style="display:flex;"><span>virsh create /path/to/vm.xml
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 迁移虚拟机</span>
</span></span><span style="display:flex;"><span>virsh migrate --live &lt;vm_name&gt; qemu+ssh://destination_host/system
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/virtualization_getting_started_guide/chap-virtualization_getting_started-what_is_it">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/virtualization_getting_started_guide/chap-virtualization_getting_started-what_is_it</a></li>
<li><a href="https://en.wikipedia.org/wiki/Hypervisor">https://en.wikipedia.org/wiki/Hypervisor</a></li>
<li><a href="https://www.linux-kvm.org/page/Main_Page">https://www.linux-kvm.org/page/Main_Page</a></li>
<li><a href="http://www.linux-kvm.org/page/Documents">http://www.linux-kvm.org/page/Documents</a></li>
<li><a href="https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine">https://en.wikipedia.org/wiki/Kernel-based_Virtual_Machine</a></li>
<li><a href="https://wiki.qemu.org/Index.html">https://wiki.qemu.org/Index.html</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a2a32a829cbd887bf197ef0680184dee">15.2 - KubeVirt</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-2a8b79a417dc27c130946b2e968a1afe">15.2.1 - KubeVirt的介绍</h1>
    
	<blockquote>
<p>本文主要由<a href="https://mp.weixin.qq.com/s/IwA1QcGaooZAL96YjvTqjA">云原生虚拟化：基于 Kubevirt 构建边缘计算实例</a>文章重新整理而成。</p>
</blockquote>
<h1 id="1-kubevirt简介">1. kubevirt简介</h1>
<p>kubevirt是基于k8s之上，提供了一种通过k8s来编排和管理虚拟机的方式。</p>
<h1 id="2-架构图">2. 架构图</h1>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1650005691/article/kubernetes/kubevirt/architecture.png" width="70%">
<h2 id="2-1-组件说明">2.1. 组件说明</h2>
<table>
<thead>
<tr>
<th>分类</th>
<th>组件</th>
<th>部署方式</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>控制面</td>
<td>virt-api</td>
<td>deployment</td>
<td>自定义API，开机、关机、重启等，作为apiserver的插件，业务通过k8s apiserver请求virt-api。</td>
</tr>
<tr>
<td></td>
<td>virt-controller</td>
<td>deployment</td>
<td>管理和监控VMI对象的状态，控制VMI下的pod。</td>
</tr>
<tr>
<td>节点侧</td>
<td>virt-handler</td>
<td>daemonset</td>
<td>类似kubelet，管理宿主机上的所有虚拟机实例。</td>
</tr>
<tr>
<td></td>
<td>virt-launcher</td>
<td>virt-handler pod</td>
<td>调用libvirt和qemu创建虚拟机进程。</td>
</tr>
</tbody>
</table>
<p>virt-launcher与libvirt逻辑：</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1650271227/article/kubernetes/kubevirt/virt-launcher.jpg" width="50%">
<h2 id="2-2-自定义crd对象">2.2. 自定义CRD对象</h2>
<table>
<thead>
<tr>
<th>分类</th>
<th>CRD对象</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>虚机</td>
<td>VirtualMachineInstance（VMI）</td>
<td>代表运行的虚拟机实例</td>
</tr>
<tr>
<td></td>
<td>VirtualMachine（VM）</td>
<td>虚机对象，提供开机、关机、重启，管理VMI实例，与VMI的关系是1：1</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h1 id="3-创建虚拟机流程">3. 创建虚拟机流程</h1>
<blockquote>
<p>待补充</p>
</blockquote>
<p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubevirt/kubevirt">https://github.com/kubevirt/kubevirt</a></p>
</li>
<li>
<p><a href="http://kubevirt.io/user-guide/architecture/">Architecture - KubeVirt User-Guide</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s/IwA1QcGaooZAL96YjvTqjA">https://mp.weixin.qq.com/s/IwA1QcGaooZAL96YjvTqjA</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cd3e11634344ad9f892ec11fda6e4058">15.2.2 - KubeVirt的使用</h1>
    
	<h1 id="1-安装kubevirt">1. 安装kubevirt</h1>
<h2 id="1-1-修改镜像仓库">1.1. 修改镜像仓库</h2>
<p>针对私有环境，需要将所需镜像上传到自己的镜像仓库中。</p>
<p>涉及的镜像组件有</p>
<pre tabindex="0"><code>virt-operator
virt-api
virt-controller
virt-launcher
</code></pre><p>重命名镜像脚本如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubevirt组件版本</span>
</span></span><span style="display:flex;"><span><span style="color:#000">version</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 私有镜像仓库</span>
</span></span><span style="display:flex;"><span><span style="color:#000">registry</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 私有镜像仓库的namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#000">namespace</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">kubevirtRegistry</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;quay.io/kubevirt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">readonly</span> <span style="color:#000">APPLIST</span><span style="color:#ce5c00;font-weight:bold">=(</span>
</span></span><span style="display:flex;"><span>    virt-operator
</span></span><span style="display:flex;"><span>    virt-api
</span></span><span style="display:flex;"><span>    virt-controller
</span></span><span style="display:flex;"><span>    virt-launcher
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> app in <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">APPLIST</span><span style="color:#000;font-weight:bold">[@]</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 拉取镜像</span>
</span></span><span style="display:flex;"><span>    docker pull <span style="color:#4e9a06">${</span><span style="color:#000">kubevirtRegistry</span><span style="color:#4e9a06">}</span>/<span style="color:#4e9a06">${</span><span style="color:#000">app</span><span style="color:#4e9a06">}</span>:<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 重命名</span>
</span></span><span style="display:flex;"><span>    docker tag <span style="color:#4e9a06">${</span><span style="color:#000">kubevirtRegistry</span><span style="color:#4e9a06">}</span>/<span style="color:#4e9a06">${</span><span style="color:#000">app</span><span style="color:#4e9a06">}</span>:<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span> <span style="color:#4e9a06">${</span><span style="color:#000">registry</span><span style="color:#4e9a06">}</span>/<span style="color:#4e9a06">${</span><span style="color:#000">namespace</span><span style="color:#4e9a06">}</span>/<span style="color:#4e9a06">${</span><span style="color:#000">app</span><span style="color:#4e9a06">}</span>:<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 推送镜像</span>
</span></span><span style="display:flex;"><span>    docker push <span style="color:#4e9a06">${</span><span style="color:#000">registry</span><span style="color:#4e9a06">}</span>/<span style="color:#4e9a06">${</span><span style="color:#000">namespace</span><span style="color:#4e9a06">}</span>/<span style="color:#4e9a06">${</span><span style="color:#000">app</span><span style="color:#4e9a06">}</span>:<span style="color:#4e9a06">${</span><span style="color:#000">version</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;重新命名成功&#34;</span>
</span></span></code></pre></div><h2 id="1-2-部署virt-operator">1.2. 部署virt-operator</h2>
<p>通过kubevirt operator安装kubevirt相关组件，选择指定版本，下载<code>kubevirt-operator.yaml</code>和<code>kubevirt-cr.yaml</code>文件，并创建k8s相关对象。</p>
<blockquote>
<p>如果是私有镜像仓库，则需要将kubevirt-operator.yaml文件中镜像的名字替换为私有镜像仓库的地址，并提前按步骤1推送所需镜像到私有镜像仓库。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Pick an upstream version of KubeVirt to install</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#204a87">export</span> <span style="color:#000">RELEASE</span><span style="color:#ce5c00;font-weight:bold">=</span>v0.52.0
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Deploy the KubeVirt operator</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f https://github.com/kubevirt/kubevirt/releases/download/<span style="color:#4e9a06">${</span><span style="color:#000">RELEASE</span><span style="color:#4e9a06">}</span>/kubevirt-operator.yaml
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Create the KubeVirt CR (instance deployment request) which triggers the actual installation</span>
</span></span><span style="display:flex;"><span>$ kubectl apply -f https://github.com/kubevirt/kubevirt/releases/download/<span style="color:#4e9a06">${</span><span style="color:#000">RELEASE</span><span style="color:#4e9a06">}</span>/kubevirt-cr.yaml
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># wait until all KubeVirt components are up</span>
</span></span><span style="display:flex;"><span>$ kubectl -n kubevirt <span style="color:#204a87">wait</span> kv kubevirt --for <span style="color:#000">condition</span><span style="color:#ce5c00;font-weight:bold">=</span>Available
</span></span></code></pre></div><h2 id="1-3-部署virtctl">1.3. 部署virtctl</h2>
<p>virtctl用来启动和关闭虚拟机。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">VERSION</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>kubectl get kubevirt.kubevirt.io/kubevirt -n kubevirt -o<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;{.status.observedKubeVirtVersion}&#34;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>uname -s <span style="color:#000;font-weight:bold">|</span> tr A-Z a-z<span style="color:#204a87;font-weight:bold">)</span>-<span style="color:#204a87;font-weight:bold">$(</span>uname -m <span style="color:#000;font-weight:bold">|</span> sed <span style="color:#4e9a06">&#39;s/x86_64/amd64/&#39;</span><span style="color:#204a87;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">||</span> windows-amd64.exe
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">${</span><span style="color:#000">ARCH</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>curl -L -o virtctl https://github.com/kubevirt/kubevirt/releases/download/<span style="color:#4e9a06">${</span><span style="color:#000">VERSION</span><span style="color:#4e9a06">}</span>/virtctl-<span style="color:#4e9a06">${</span><span style="color:#000">VERSION</span><span style="color:#4e9a06">}</span>-<span style="color:#4e9a06">${</span><span style="color:#000">ARCH</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>chmod +x virtctl
</span></span><span style="display:flex;"><span>sudo install virtctl /usr/local/bin
</span></span></code></pre></div><h1 id="2-kubevirt部署产物">2. kubevirt部署产物</h1>
<p>通过手动部署virt-operator，会自动部署以下组件</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>部署方式</th>
<th>副本数</th>
</tr>
</thead>
<tbody>
<tr>
<td>virt-api</td>
<td>deployment</td>
<td>2</td>
</tr>
<tr>
<td>virt-controller</td>
<td>deployment</td>
<td>2</td>
</tr>
<tr>
<td>virt-handler</td>
<td>daemonset</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>具体参考:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#kg all -n kubevirt</span>
</span></span><span style="display:flex;"><span>NAME                                   READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/virt-api-5fb5cffb7f-hgjjh          1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          23h
</span></span><span style="display:flex;"><span>pod/virt-api-5fb5cffb7f-jcp7x          1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          23h
</span></span><span style="display:flex;"><span>pod/virt-controller-844cd4f58c-h8vsx   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          23h
</span></span><span style="display:flex;"><span>pod/virt-controller-844cd4f58c-vlxqs   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          23h
</span></span><span style="display:flex;"><span>pod/virt-handler-lb5ft                 1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          23h
</span></span><span style="display:flex;"><span>pod/virt-handler-mtr4d                 1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          22h
</span></span><span style="display:flex;"><span>pod/virt-handler-sxd2t                 1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          23h
</span></span><span style="display:flex;"><span>pod/virt-operator-8595f577cd-b9txg     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          23h
</span></span><span style="display:flex;"><span>pod/virt-operator-8595f577cd-p2f69     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          23h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>   AGE
</span></span><span style="display:flex;"><span>service/kubevirt-operator-webhook     ClusterIP   10.254.159.81    &lt;none&gt;        443/TCP   23h
</span></span><span style="display:flex;"><span>service/kubevirt-prometheus-metrics   ClusterIP   10.254.7.231     &lt;none&gt;        443/TCP   23h
</span></span><span style="display:flex;"><span>service/virt-api                      ClusterIP   10.254.244.139   &lt;none&gt;        443/TCP   23h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
</span></span><span style="display:flex;"><span>daemonset.apps/virt-handler   <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>       <span style="color:#0000cf;font-weight:bold">3</span>            <span style="color:#0000cf;font-weight:bold">3</span>           kubernetes.io/os<span style="color:#ce5c00;font-weight:bold">=</span>linux   23h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                              READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/virt-api          2/2     <span style="color:#0000cf;font-weight:bold">2</span>            <span style="color:#0000cf;font-weight:bold">2</span>           23h
</span></span><span style="display:flex;"><span>deployment.apps/virt-controller   2/2     <span style="color:#0000cf;font-weight:bold">2</span>            <span style="color:#0000cf;font-weight:bold">2</span>           23h
</span></span><span style="display:flex;"><span>deployment.apps/virt-operator     2/2     <span style="color:#0000cf;font-weight:bold">2</span>            <span style="color:#0000cf;font-weight:bold">2</span>           23h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                         DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>replicaset.apps/virt-api-5fb5cffb7f          <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>       23h
</span></span><span style="display:flex;"><span>replicaset.apps/virt-controller-844cd4f58c   <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>       23h
</span></span><span style="display:flex;"><span>replicaset.apps/virt-operator-8595f577cd     <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>         <span style="color:#0000cf;font-weight:bold">2</span>       23h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                            AGE   PHASE
</span></span><span style="display:flex;"><span>kubevirt.kubevirt.io/kubevirt   23h   Deployed
</span></span></code></pre></div><h1 id="3-创建虚拟机">3. 创建虚拟机</h1>
<p>通过vm.yaml创建虚拟机</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下载vm.yaml</span>
</span></span><span style="display:flex;"><span>wget https://kubevirt.io/labs/manifests/vm.yaml
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建虚拟机</span>
</span></span><span style="display:flex;"><span>kubectl apply -f https://kubevirt.io/labs/manifests/vm.yaml
</span></span></code></pre></div><p>vm.yaml文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubevirt.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">VirtualMachine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testvm</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">running</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">kubevirt.io/size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">small</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">kubevirt.io/domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">testvm</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">domain</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">devices</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">disks</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">containerdisk</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">disk</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">bus</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">virtio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cloudinitdisk</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">disk</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#204a87;font-weight:bold">bus</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">virtio</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">interfaces</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">masquerade</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">memory</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">64M</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">networks</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pod</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">containerdisk</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">containerDisk</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">quay.io/kubevirt/cirros-container-disk-demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">cloudinitdisk</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">cloudInitNoCloud</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">userDataBase64</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">SGkuXG4=</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>查看虚拟机</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get vms
</span></span><span style="display:flex;"><span>kubectl get vms -o yaml testvm
</span></span></code></pre></div><p>启动或暂停虚拟机</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动虚拟机</span>
</span></span><span style="display:flex;"><span>virtctl start testvm
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 关闭虚拟机</span>
</span></span><span style="display:flex;"><span>virtctl stop testvm
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 进入虚拟机</span>
</span></span><span style="display:flex;"><span>virtctl console testvm
</span></span></code></pre></div><p>删除虚拟机</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl delete vm testvm
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="http://kubevirt.io/user-guide/operations/installation/#installing-kubevirt-on-kubernetes">Installation - KubeVirt User-Guide</a></li>
<li><a href="https://kubevirt.io/quickstart_minikube/">KubeVirt quickstart with Minikube | KubeVirt.io</a></li>
<li><a href="https://kubevirt.io/labs/kubernetes/lab1.html">Use KubeVirt | KubeVirt.io</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-73293b67b2766ce22d69ea8c7756120a">15.3 - qemu创建虚拟机</h1>
    
	<h1 id="1-部署qemu-system-x86-64">1. 部署qemu-system-x86_64</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 更新包</span>
</span></span><span style="display:flex;"><span>sudo apt-get update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装QEMU和KVM相关的包。KVM（Kernel-based Virtual Machine）可以显著提高QEMU的性能。</span>
</span></span><span style="display:flex;"><span>sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装qemu-system-x86</span>
</span></span><span style="display:flex;"><span>sudo apt-get install -y qemu qemu-system-x86
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为了在非root用户下使用QEMU/KVM，需要将当前用户添加到 libvirt 和 kvm 组。</span>
</span></span><span style="display:flex;"><span>sudo usermod -aG libvirt <span style="color:#204a87;font-weight:bold">$(</span>whoami<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>sudo usermod -aG kvm <span style="color:#204a87;font-weight:bold">$(</span>whoami<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看版本</span>
</span></span><span style="display:flex;"><span>qemu-system-x86_64 --version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 验证命令</span>
</span></span><span style="display:flex;"><span>virsh list --all
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a6b67c3e1104112907046f1806bd86e3">16 - 监控体系</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0246871f1f5b13bc1876ca30494b9e94">16.1 - kube-prometheus-stack的使用</h1>
    
	<h1 id="1-kube-prometheus-stack简介">1. kube-prometheus-stack简介</h1>
<p>kube-prometheus-stack是prometheus监控k8s集群的套件，可以通过helm一键安装，同时带有监控的模板。</p>
<p>各组件包括</p>
<ul>
<li>grafana</li>
<li>kube-state-metrics</li>
<li>prometheus</li>
<li>alertmanager</li>
<li>node-exporter</li>
</ul>
<h1 id="2-安装kube-prometheus-stack">2. 安装kube-prometheus-stack</h1>
<p>执行以下命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack -n prometheus
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># helm install kube-prometheus-stack  prometheus-community/kube-prometheus-stack -n prometheus</span>
</span></span><span style="display:flex;"><span>NAME: kube-prometheus-stack
</span></span><span style="display:flex;"><span>LAST DEPLOYED: Wed May <span style="color:#0000cf;font-weight:bold">17</span> 17:12:24 <span style="color:#0000cf;font-weight:bold">2023</span>
</span></span><span style="display:flex;"><span>NAMESPACE: prometheus
</span></span><span style="display:flex;"><span>STATUS: deployed
</span></span><span style="display:flex;"><span>REVISION: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>NOTES:
</span></span><span style="display:flex;"><span>kube-prometheus-stack has been installed. Check its status by running:
</span></span><span style="display:flex;"><span>  kubectl --namespace prometheus get pods -l <span style="color:#4e9a06">&#34;release=kube-prometheus-stack&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Visit https://github.com/prometheus-operator/kube-prometheus <span style="color:#204a87;font-weight:bold">for</span> instructions on how to create <span style="color:#000;font-weight:bold">&amp;</span> configure Alertmanager and Prometheus instances using the Operator.
</span></span></code></pre></div><h1 id="3-查看安装结果">3. 查看安装结果</h1>
<ul>
<li>
<p>deployment</p>
<ul>
<li>kube-prometheus-stack-grafana</li>
<li>kube-prometheus-stack-kube-state-metrics</li>
<li>kube-prometheus-stack-operator</li>
</ul>
</li>
<li>
<p>statefulset</p>
<ul>
<li>prometheus-kube-prometheus-stack-prometheus</li>
<li>alertmanager-kube-prometheus-stack-alertmanager</li>
</ul>
</li>
<li>
<p>daemonset</p>
<ul>
<li>kube-prometheus-stack-prometheus-node-exporter</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kg all -n prometheus</span>
</span></span><span style="display:flex;"><span>NAME                                                            READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/alertmanager-kube-prometheus-stack-alertmanager-0           2/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m34s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-grafana-5bb7689dc8-lgrws              3/3     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m35s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-kube-state-metrics-5d6578867c-25xbq   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m35s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-operator-9c5fbdc68-nrn7h              1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m35s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-prometheus-node-exporter-8ghd8        1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          48s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-prometheus-node-exporter-brtp9        1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          29s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-prometheus-node-exporter-n4kdp        1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          88s
</span></span><span style="display:flex;"><span>pod/kube-prometheus-stack-prometheus-node-exporter-ttksv        1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          35s
</span></span><span style="display:flex;"><span>pod/prometheus-kube-prometheus-stack-prometheus-0               2/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m34s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>                      AGE
</span></span><span style="display:flex;"><span>service/alertmanager-operated                            ClusterIP   None             &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP   9m34s
</span></span><span style="display:flex;"><span>service/kube-prometheus-stack-alertmanager               ClusterIP   10.99.108.180    &lt;none&gt;        9093/TCP                     9m36s
</span></span><span style="display:flex;"><span>service/kube-prometheus-stack-grafana                    ClusterIP   10.110.62.28     &lt;none&gt;        80/TCP                       9m36s
</span></span><span style="display:flex;"><span>service/kube-prometheus-stack-kube-state-metrics         ClusterIP   10.110.105.139   &lt;none&gt;        8080/TCP                     9m35s
</span></span><span style="display:flex;"><span>service/kube-prometheus-stack-operator                   ClusterIP   10.96.147.204    &lt;none&gt;        443/TCP                      9m36s
</span></span><span style="display:flex;"><span>service/kube-prometheus-stack-prometheus                 ClusterIP   10.98.235.203    &lt;none&gt;        9090/TCP                     9m36s
</span></span><span style="display:flex;"><span>service/kube-prometheus-stack-prometheus-node-exporter   ClusterIP   10.105.99.77     &lt;none&gt;        9100/TCP                     9m36s
</span></span><span style="display:flex;"><span>service/prometheus-operated                              ClusterIP   None             &lt;none&gt;        9090/TCP                     9m34s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                                            DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
</span></span><span style="display:flex;"><span>daemonset.apps/kube-prometheus-stack-prometheus-node-exporter   <span style="color:#0000cf;font-weight:bold">4</span>         <span style="color:#0000cf;font-weight:bold">4</span>         <span style="color:#0000cf;font-weight:bold">4</span>       <span style="color:#0000cf;font-weight:bold">4</span>            <span style="color:#0000cf;font-weight:bold">4</span>           &lt;none&gt;          9m35s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                                       READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/kube-prometheus-stack-grafana              1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           9m35s
</span></span><span style="display:flex;"><span>deployment.apps/kube-prometheus-stack-kube-state-metrics   1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           9m35s
</span></span><span style="display:flex;"><span>deployment.apps/kube-prometheus-stack-operator             1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           9m35s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                                                               READY   AGE
</span></span><span style="display:flex;"><span>statefulset.apps/alertmanager-kube-prometheus-stack-alertmanager   1/1     9m34s
</span></span><span style="display:flex;"><span>statefulset.apps/prometheus-kube-prometheus-stack-prometheus       1/1     9m34s
</span></span></code></pre></div><h1 id="4-登录grafana">4. 登录grafana</h1>
<p>默认账号密码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>账号：admin
</span></span><span style="display:flex;"><span>密码：prom-operator
</span></span></code></pre></div><p>默认账号密码位于secret中，通过base64解码可得上述密码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kg secret -n prometheus kube-prometheus-stack-grafana -oyaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  admin-password: <span style="color:#000">cHJvbS1vcGVyYXRvcg</span><span style="color:#ce5c00;font-weight:bold">==</span>
</span></span><span style="display:flex;"><span>  admin-user: <span style="color:#000">YWRtaW4</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span></code></pre></div><p>模板内容：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1684392039/article/kubernetes/monitor/grafana.png" alt=""></p>
<p>pod数据：</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1684392101/article/kubernetes/monitor/pod-stats.png" alt=""></p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack">https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack</a></li>
<li><a href="https://github.com/prometheus-operator/kube-prometheus">https://github.com/prometheus-operator/kube-prometheus</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ba6ff3e130589d9a22b217a89ee69d71">16.2 - Kubernetes集群监控</h1>
    
	<h1 id="1-概述">1. 概述</h1>
<h2 id="1-1-cadvisor">1.1. cAdvisor</h2>
<p>cAdvisor对Node机器上的资源及容器进行实时监控和性能数据采集，包括CPU使用情况、内存使用情况、网络吞吐量及文件系统使用情况，cAdvisor集成在Kubelet中，当kubelet启动时会自动启动cAdvisor，即一个cAdvisor仅对一台Node机器进行监控。kubelet的启动参数--cadvisor-port可以定义cAdvisor对外提供服务的端口，默认为4194。可以通过浏览器<code>Node_IP:port</code>访问。项目主页：http://github.com/google/cadvisor。</p>
<h2 id="1-2-heapster">1.2. Heapster</h2>
<p>是对集群中的各个Node、Pod的资源使用数据进行采集，通过访问每个Node上Kubelet的API，再通过Kubelet调用cAdvisor的API来采集该节点上所有容器的性能数据。由Heapster进行数据汇聚，保存到后端存储系统中，例如InfluxDB，Google Cloud Logging等。项目主页为：https://github.com/kubernetes/heapster。</p>
<h2 id="1-3-influxdb">1.3. InfluxDB</h2>
<p>是分布式时序数据库（每条记录带有时间戳属性），主要用于实时数据采集、事件跟踪记录、存储时间图表、原始数据等。提供REST API用于数据的存储和查询。项目主页为http://InfluxDB.com。</p>
<h2 id="1-4-grafana">1.4. Grafana</h2>
<p>通过Dashboard将InfluxDB的时序数据展现成图表形式，便于查看集群运行状态。项目主页为http://Grafana.org。</p>
<h2 id="1-5-总体架构图">1.5. 总体架构图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579058/article/kubernetes/monitor/k8s-monitor-arch.png" alt="k8s监控架构图"></p>
<p>其中当前Kubernetes中，Heapster、InfluxDB、Grafana均以Pod的形式启动和运行。Heapster与Master需配置安全连接。</p>
<h1 id="2-部署与使用">2. 部署与使用</h1>
<h2 id="2-1-cadvisor">2.1. cAdvisor</h2>
<p>kubelet的启动参数--cadvisor-port可以定义cAdvisor对外提供服务的端口，默认为4194。可以通过浏览器<code>Node_IP:port</code>访问。也提供了REST API供客户端远程调用，API返回的格式为JSON，可以采用URL访问：http://<code>hostname</code>:<code>port</code>/api/<code>version</code>/<code>request</code>/</p>
<p>例如：<a href="http://14.152.49.100:4194/api/v1.3/machine">http://14.152.49.100:4194/api/v1.3/machine</a> 获取主机信息。</p>
<h2 id="2-2-service">2.2. Service</h2>
<h2 id="2-2-1-heapster-service">2.2.1. heapster-service</h2>
<p><strong>heapster-service.yaml</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">apiVersion:v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">kind:Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">label</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">kubenetes.io/cluster-service:&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">kubernetes.io/name:Heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">namespace:kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">port:80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">targetPort:8082</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">k8s-app:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-2-2-influxdb-service">2.2.2. influxdb-service</h2>
<p><strong>influxdb-service.yaml</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">apiVersion:v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">kind:Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">label:null</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name:monitoring-InfluxDB</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">namespace:kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">type:Nodeport</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">name:http</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">port:80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">targetPort:8083</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#000">name:api</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">port:8086</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">targetPort:8086</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">Nodeport:8086</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name:influxGrafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-2-3-grafana-service">2.2.3. grafana-service</h2>
<p><strong>grafana-service.yaml</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">apiVersion:v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">kind:Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">label</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">kubenetes.io/cluster-service:&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">kubernetes.io/name:monitoring-Grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name:monitoring-Grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">namespace:kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">type:Nodeport</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">port:80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">targetPort:8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#000">Nodeport:8085</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name:influxGrafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>使用type=NodePort将InfluxDB和Grafana暴露在Node的端口上，以便通过浏览器进行访问。</p>
<h2 id="2-2-4-创建service">2.2.4. 创建service</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create -f heapster-service.yaml
</span></span><span style="display:flex;"><span>kubectl create -f InfluxDB-service.yaml
</span></span><span style="display:flex;"><span>kubectl create -f Grafana-service.yaml
</span></span></code></pre></div><h2 id="2-3-replicationcontroller">2.3. ReplicationController</h2>
<h2 id="2-3-1-influxdb-grafana-controller">2.3.1. influxdb-grafana-controller</h2>
<p><strong>influxdb-grafana-controller-v3.yaml</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">apiVersion:v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">kind:ReplicationController</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">name:monitoring-influxdb-grafana-v3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">namespace:kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">k8s-app:influxGrafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">version:v3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">kubernetes.io/cluster-service:&#34;true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">replicas:1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">k8s-app:influxGrafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">version:v3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">k8s-app:influxGrafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">version:v3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">kubernetes.io/cluster-service:&#34;true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">image:gcr.io/google_containers/heapster_influxdb:v0.5</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">name:influxdb</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">cpu:100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">memory:500Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">cpu:100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">memory:500Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">containerPort:8083</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">containerPort:8086</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>-<span style="color:#000">name:influxdb-persistent-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">             </span><span style="color:#000">mountPath:/data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">image:grc.io/google_containers/heapster_grafana:v2.6.0-2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">name:grafana</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">limits</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">cpu:100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">memory:100Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">cpu:100m</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">memory:100Mi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">name:INFLUXDB_SERVICE_URL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">value:http://monitoring-influxdb:8086</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">name:GF_AUTH_BASIC_ENABLED</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">value:&#34;false&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">name:GF_AUTH_ANONYMOUS_ENABLED</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">value:&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">name:GF_AUTH_ANONYMOUS_ORG_ROLE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">value:Admin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">name:GF_SERVER_ROOT_URL</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">value:/api/v1/proxy/namespace/kube-system/services/monitoring-grafana/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#000">name:grafana-persistent-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#000">mountPath:/var</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">name:influxdb-persistent-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">emptyDir{}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">name:grafana-persistent-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#000">emptyDir{}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="2-3-2-heapster-controller">2.3.2. heapster-controller</h2>
<p><strong>heapster-controller.yaml</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#000">apiVersion:v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">kind:ReplicationController</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">k8s-app:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">name:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">version:v6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">name:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">namespace:kube-system</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">replicas:1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">name:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">k8s-app:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#000">version:v6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000">k8s-app:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#000">version:v6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                </span>- <span style="color:#000">image:gcr.io/google_containers/heapster:v0.17.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#000">name:heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span>- <span style="color:#000">/heapster</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span>- --<span style="color:#000">source=kubernetes:http://192.168.1.128:8080?inClusterConfig=flase&amp;kubeletHttps=true&amp;useServiceAccount=true&amp;auth=</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                    </span>- --<span style="color:#000">sink=InfluxDB:http://monitoring-InfluxDB:8086</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>Heapster设置启动参数说明：</p>
<p>1、–source</p>
<p>配置监控来源，本例中表示从k8s-Master获取各个Node的信息。在URL的参数部分，修改kubeletHttps、inClusterConfig、useServiceAccount的值。</p>
<p>2、–sink</p>
<p>配置后端的存储系统，本例中使用InfluxDB。URL中主机名的地址是InfluxDB的Service名字，需要DNS服务正常工作，如果没有配置DNS服务可使用Service的ClusterIP地址。</p>
<h2 id="2-3-3-创建replicationcontroller">2.3.3. 创建ReplicationController</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubelet create -f InfluxDB-Grafana-controller.yaml
</span></span><span style="display:flex;"><span>kubelet create -f heapster-controller.yaml
</span></span></code></pre></div><h1 id="3-查看界面及数据">3. 查看界面及数据</h1>
<h2 id="3-1-influxdb">3.1. InfluxDB</h2>
<p>访问任意一台Node机器的30083端口。</p>
<h2 id="3-2-grafana">3.2. Grafana</h2>
<p>访问任意一台Node机器的30080端口。</p>
<h1 id="4-容器化部署">4. 容器化部署</h1>
<h2 id="4-1-拉取镜像">4.1. 拉取镜像</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker pull influxdb:latest
</span></span><span style="display:flex;"><span>docker pull cadvisor:latest
</span></span><span style="display:flex;"><span>docker pull grafana:latest
</span></span><span style="display:flex;"><span>docker pull heapster:latest
</span></span></code></pre></div><h2 id="4-2-运行容器">4.2. 运行容器</h2>
<h2 id="4-2-1-influxdb">4.2.1. influxdb</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#influxdb</span>
</span></span><span style="display:flex;"><span>docker run -d -p 8083:8083 -p 8086:8086 --expose <span style="color:#0000cf;font-weight:bold">8090</span> --expose <span style="color:#0000cf;font-weight:bold">8099</span> --volume<span style="color:#ce5c00;font-weight:bold">=</span>/opt/data/influxdb:/data --name influxsrv influxdb:latest
</span></span></code></pre></div><h2 id="4-2-2-cadvisor">4.2.2. cadvisor</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#cadvisor</span>
</span></span><span style="display:flex;"><span>docker run --volume<span style="color:#ce5c00;font-weight:bold">=</span>/:/rootfs:ro --volume<span style="color:#ce5c00;font-weight:bold">=</span>/var/run:/var/run:rw --volume<span style="color:#ce5c00;font-weight:bold">=</span>/sys:/sys:ro --volume<span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/docker/:/var/lib/docker:ro --publish<span style="color:#ce5c00;font-weight:bold">=</span>8080:8080 --detach<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --link influxsrv:influxsrv --name<span style="color:#ce5c00;font-weight:bold">=</span>cadvisor cadvisor:latest -storage_driver<span style="color:#ce5c00;font-weight:bold">=</span>influxdb -storage_driver_db<span style="color:#ce5c00;font-weight:bold">=</span>cadvisor -storage_driver_host<span style="color:#ce5c00;font-weight:bold">=</span>influxsrv:8086
</span></span></code></pre></div><h2 id="4-2-3-grafana">4.2.3. grafana</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#grafana</span>
</span></span><span style="display:flex;"><span>docker run -d -p 3000:3000 -e <span style="color:#000">INFLUXDB_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span>influxsrv -e <span style="color:#000">INFLUXDB_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">8086</span> -e <span style="color:#000">INFLUXDB_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>cadvisor -e <span style="color:#000">INFLUXDB_USER</span><span style="color:#ce5c00;font-weight:bold">=</span>root -e <span style="color:#000">INFLUXDB_PASS</span><span style="color:#ce5c00;font-weight:bold">=</span>root --link influxsrv:influxsrv --name grafana grafana:latest
</span></span></code></pre></div><h2 id="4-2-4-heapster">4.2.4. heapster</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d -p 8082:8082 --net<span style="color:#ce5c00;font-weight:bold">=</span>host heapster:canary --source<span style="color:#ce5c00;font-weight:bold">=</span>kubernetes:http://<span style="color:#4e9a06">`</span>k8s-server-ip<span style="color:#4e9a06">`</span>:8080?inClusterConfig<span style="color:#ce5c00;font-weight:bold">=</span>false/<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000">useServiceAccount</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span> --sink<span style="color:#ce5c00;font-weight:bold">=</span>influxdb:http://<span style="color:#4e9a06">`</span>influxdb-ip<span style="color:#4e9a06">`</span>:8086
</span></span></code></pre></div><h2 id="4-3-访问">4.3. 访问</h2>
<p>在浏览器输入<code>IP</code>:<code>PORT</code></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-063a156fcf744316e09eb6d743179121">16.3 - cAdvisor介绍</h1>
    
	<h1 id="1-cadvisor简介">1. cAdvisor简介</h1>
<p>​    cAdvisor对Node机器上的资源及容器进行实时监控和性能数据采集，包括CPU使用情况、内存使用情况、网络吞吐量及文件系统使用情况，cAdvisor集成在Kubelet中，当kubelet启动时会自动启动cAdvisor，即一个cAdvisor仅对一台Node机器进行监控。kubelet的启动参数--cadvisor-port可以定义cAdvisor对外提供服务的端口，默认为4194。可以通过浏览器&lt;Node_IP:port&gt;访问。项目主页：<a href="">http://github.com/google/cadvisor。</a></p>
<h1 id="2-cadvisor结构图">2. cAdvisor结构图</h1>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510579058/article/kubernetes/monitor/cAdvisor.png" alt="cAdvisor"></p>
<h1 id="3-metrics">3. Metrics</h1>
<table>
<thead>
<tr>
<th>分类</th>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpu</td>
<td>cpu_usage_total</td>
<td></td>
</tr>
<tr>
<td></td>
<td>cpu_usage_system</td>
<td></td>
</tr>
<tr>
<td></td>
<td>cpu_usage_user</td>
<td></td>
</tr>
<tr>
<td></td>
<td>cpu_usage_per_cpu</td>
<td></td>
</tr>
<tr>
<td></td>
<td>load_average</td>
<td>Smoothed average of number of runnable threads x 1000</td>
</tr>
<tr>
<td>memory</td>
<td>memory_usage</td>
<td>Memory Usage</td>
</tr>
<tr>
<td></td>
<td>memory_working_set</td>
<td>Working set size</td>
</tr>
<tr>
<td>network</td>
<td>rx_bytes</td>
<td>Cumulative count of bytes received</td>
</tr>
<tr>
<td></td>
<td>rx_errors</td>
<td>Cumulative count of receive errors encountered</td>
</tr>
<tr>
<td></td>
<td>tx_bytes</td>
<td>Cumulative count of bytes transmitted</td>
</tr>
<tr>
<td></td>
<td>tx_errors</td>
<td>Cumulative count of transmit errors encountered</td>
</tr>
<tr>
<td>filesystem</td>
<td>fs_device</td>
<td>Filesystem device</td>
</tr>
<tr>
<td></td>
<td>fs_limit</td>
<td>Filesystem limit</td>
</tr>
<tr>
<td></td>
<td>fs_usage</td>
<td>Filesystem usage</td>
</tr>
</tbody>
</table>
<h1 id="4-cadvisor源码">4. cAdvisor源码</h1>
<h2 id="4-1-cadvisor入口函数">4.1. cAdvisor入口函数</h2>
<p><strong>cadvisor.go</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flush</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">versionFlag</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cAdvisor version %s (%s)/n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;version&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;revision&#34;</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">setMaxProcs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">memoryStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewMemoryStorage</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to initialize storage driver: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sysFs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sysfs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRealSysFs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create a system interface: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">collectorHttpClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createCollectorHttpClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">collectorCert</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">collectorKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">memoryStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sysFs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">maxHousekeepingInterval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">allowDynamicHousekeeping</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ignoreMetrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MetricSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">collectorHttpClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create a Container Manager: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mux</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServeMux</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">enableProfiling</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Index</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/cmdline&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cmdline</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/profile&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Profile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/debug/pprof/symbol&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pprof</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Symbol</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Register all HTTP handlers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cadvisorhttp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterHandlers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mux</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">httpAuthFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">httpAuthRealm</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">httpDigestFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">httpDigestRealm</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to register HTTP handlers: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cadvisorhttp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPrometheusHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mux</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prometheusEndpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Start the manager.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to start container manager: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Install signal handler.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">installSignalHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting cAdvisor version: %s-%s on port %d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;version&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;revision&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argPort</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">addr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s:%d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argIp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">argPort</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mux</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">memoryStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewMemoryStorage</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sysFs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sysfs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRealSysFs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">#</span><span style="color:#000">创建containerManager</span>
</span></span><span style="display:flex;"><span><span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">memoryStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sysFs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">maxHousekeepingInterval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">allowDynamicHousekeeping</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ignoreMetrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MetricSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">collectorHttpClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">#</span><span style="color:#000">启动containerManager</span>
</span></span><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h2 id="4-2-cadvisor-client的使用">4.2. cAdvisor Client的使用</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;github.com/google/cadvisor/client&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http://192.168.19.30:4194/&#34;</span><span style="color:#000;font-weight:bold">)</span>   <span style="color:#8f5902;font-style:italic">//http://&lt;host-ip&gt;:&lt;port&gt;/
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-2-1-client定义">4.2.1 client定义</h2>
<p><strong>cadvisor/client/client.go</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Client represents the base URL for a cAdvisor client.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Client</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">baseUrl</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewClient returns a new v1.3 client with the specified base URL.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">url</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HasSuffix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">url</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#4e9a06">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">baseUrl</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%sapi/v1.3/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">url</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-2-2-client方法">4.2.2. client方法</h2>
<p><strong>1）MachineInfo</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// MachineInfo returns the JSON machine information for this client.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// A non-nil error result indicates a problem with obtaining
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the JSON machine information data.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">MachineInfo</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">minfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MachineInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">machineInfoUrl</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MachineInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">httpGetJsonData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;machine info&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">minfo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ret</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>2）ContainerInfo</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ContainerInfo returns the JSON container information for the specified
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// container and request.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfoRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cinfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerInfoUrl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">httpGetJsonData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;container info for %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">cinfo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ret</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>3）DockerContainer</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Returns the JSON container information for the specified
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Docker container and request.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">DockerContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfoRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cinfo</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dockerInfoUrl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">httpGetJsonData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Docker container info for %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;expected to only receive 1 Docker container: %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ret</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cont</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">ret</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000">cinfo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cont</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>4）AllDockerContainers</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Returns the JSON container information for all Docker containers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">AllDockerContainers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfoRequest</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cinfo</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dockerInfoUrl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">httpGetJsonData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">query</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all Docker containers info&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">cinfo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ret</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cont</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">ret</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000">cinfo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cinfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cont</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>       <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c35df90033980941ba5c63379e5cfcbe">16.4 - Heapster介绍</h1>
    
	<h1 id="1-heapster简介">1. heapster简介</h1>
<p>Heapster是容器集群监控和性能分析工具，天然的支持Kubernetes和CoreOS。
Kubernetes有个出名的监控agent—cAdvisor。在每个kubernetes Node上都会运行cAdvisor，它会收集本机以及容器的监控数据(cpu,memory,filesystem,network,uptime)。</p>
<h1 id="2-heapster部署与配置">2. heapster部署与配置</h1>
<h2 id="2-1-注意事项">2.1. 注意事项</h2>
<p>需同步部署机器和被采集机器的时间：ntpdate time.windows.com</p>
<p>加入定时任务，定期同步时间</p>
<p>crontab –e</p>
<p>30 5 * * *          /usr/sbin/ntpdate time.windows.com          //每天早晨5点半执行</p>
<h2 id="2-2-容器式部署">2.2. 容器式部署</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#拉取镜像</span>
</span></span><span style="display:flex;"><span>docker pull heapster:latest
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#运行容器</span>
</span></span><span style="display:flex;"><span>docker run -d -p 8082:8082 --net<span style="color:#ce5c00;font-weight:bold">=</span>host heapster:latest --source<span style="color:#ce5c00;font-weight:bold">=</span>kubernetes:http://&lt;k8s-server-ip&gt;:8080?inClusterConfig<span style="color:#ce5c00;font-weight:bold">=</span>false<span style="color:#4e9a06">\&amp;</span><span style="color:#000">useServiceAccount</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span> --sink<span style="color:#ce5c00;font-weight:bold">=</span>influxdb:http://&lt;influxdb-ip&gt;:8086?db<span style="color:#ce5c00;font-weight:bold">=</span>&lt;k8s_env_zone&gt;
</span></span></code></pre></div><h2 id="2-3-配置说明">2.3. 配置说明</h2>
<p>可以参考<a href="https://github.com/kubernetes/heapster/tree/master/docs">官方文档</a></p>
<h2 id="2-3-1-source">2.3.1. –source</h2>
<p>–source: 指定数据获取源。这里指定kube-apiserver即可。
后缀参数：
inClusterConfig:
kubeletPort: 指定kubelet的使用端口，默认10255
kubeletHttps: 是否使用https去连接kubelets(默认：false)
apiVersion: 指定K8S的apiversion
insecure: 是否使用安全证书(默认：false)
auth: 安全认证
useServiceAccount: 是否使用K8S的安全令牌</p>
<h2 id="2-3-2-sink">2.3.2. –sink</h2>
<p>–sink: 指定后端数据存储。这里指定influxdb数据库。
后缀参数：
user: InfluxDB用户
pw: InfluxDB密码
db: 数据库名
secure: 安全连接到InfluxDB(默认：false)
withfields： 使用InfluxDB fields(默认：false)。</p>
<h1 id="3-metrics">3. Metrics</h1>
<table>
<thead>
<tr>
<th>分类</th>
<th>Metric Name</th>
<th>Description</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>cpu</td>
<td>cpu/limit</td>
<td>CPU hard limit in millicores.</td>
<td>CPU上限</td>
</tr>
<tr>
<td></td>
<td>cpu/node_capacity</td>
<td>Cpu capacity of a node.</td>
<td>Node节点的CPU容量</td>
</tr>
<tr>
<td></td>
<td>cpu/node_allocatable</td>
<td>Cpu allocatable of a node.</td>
<td>Node节点可分配的CPU</td>
</tr>
<tr>
<td></td>
<td>cpu/node_reservation</td>
<td>Share of cpu that is reserved on the node allocatable.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>cpu/node_utilization</td>
<td>CPU utilization as a share of node allocatable.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>cpu/request</td>
<td>CPU request (the guaranteed amount of resources) in millicores.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>cpu/usage</td>
<td>Cumulative CPU usage on all cores.</td>
<td>CPU总使用量</td>
</tr>
<tr>
<td></td>
<td>cpu/usage_rate</td>
<td>CPU usage on all cores in millicores.</td>
<td></td>
</tr>
<tr>
<td>filesystem</td>
<td>filesystem/usage</td>
<td>Total number of bytes consumed on a filesystem.</td>
<td>文件系统的使用量</td>
</tr>
<tr>
<td></td>
<td>filesystem/limit</td>
<td>The total size of filesystem in bytes.</td>
<td>文件系统的使用上限</td>
</tr>
<tr>
<td></td>
<td>filesystem/available</td>
<td>The number of available bytes remaining in a the filesystem</td>
<td>可用的文件系统容量</td>
</tr>
<tr>
<td></td>
<td>filesystem/inodes</td>
<td>The number of available inodes in a the filesystem</td>
<td></td>
</tr>
<tr>
<td></td>
<td>filesystem/inodes_free</td>
<td>The number of free inodes remaining in a the filesystem</td>
<td></td>
</tr>
<tr>
<td>memory</td>
<td>memory/limit</td>
<td>Memory hard limit in bytes.</td>
<td>内存上限</td>
</tr>
<tr>
<td></td>
<td>memory/major_page_faults</td>
<td>Number of major page faults.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/major_page_faults_rate</td>
<td>Number of major page faults per second.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/node_capacity</td>
<td>Memory capacity of a node.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/node_allocatable</td>
<td>Memory allocatable of a node.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/node_reservation</td>
<td>Share of memory that is reserved on the node allocatable.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/node_utilization</td>
<td>Memory utilization as a share of memory allocatable.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/page_faults</td>
<td>Number of page faults.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/page_faults_rate</td>
<td>Number of page faults per second.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/request</td>
<td>Memory request (the guaranteed amount of resources) in bytes.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/usage</td>
<td>Total memory usage.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/cache</td>
<td>Cache memory usage.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/rss</td>
<td>RSS memory usage.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>memory/working_set</td>
<td>Total working set usage. Working set is the memory being used and not easily dropped by the kernel.</td>
<td></td>
</tr>
<tr>
<td>network</td>
<td>network/rx</td>
<td>Cumulative number of bytes received over the network.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/rx_errors</td>
<td>Cumulative number of errors while receiving over the network.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/rx_errors_rate</td>
<td>Number of errors while receiving over the network per second.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/rx_rate</td>
<td>Number of bytes received over the network per second.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/tx</td>
<td>Cumulative number of bytes sent over the network</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/tx_errors</td>
<td>Cumulative number of errors while sending over the network</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/tx_errors_rate</td>
<td>Number of errors while sending over the network</td>
<td></td>
</tr>
<tr>
<td></td>
<td>network/tx_rate</td>
<td>Number of bytes sent over the network per second.</td>
<td></td>
</tr>
<tr>
<td></td>
<td>uptime</td>
<td>Number of milliseconds since the container was started.</td>
<td>-</td>
</tr>
</tbody>
</table>
<h1 id="4-labels">4. Labels</h1>
<table>
<thead>
<tr>
<th>Label Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>pod_id</td>
<td>Unique ID of a Pod</td>
</tr>
<tr>
<td>pod_name</td>
<td>User-provided name of a Pod</td>
</tr>
<tr>
<td>pod_namespace</td>
<td>The namespace of a Pod</td>
</tr>
<tr>
<td>container_base_image</td>
<td>Base image for the container</td>
</tr>
<tr>
<td>container_name</td>
<td>User-provided name of the container or full cgroup name for system containers</td>
</tr>
<tr>
<td>host_id</td>
<td>Cloud-provider specified or user specified Identifier of a node</td>
</tr>
<tr>
<td>hostname</td>
<td>Hostname where the container ran</td>
</tr>
<tr>
<td>labels</td>
<td>Comma-separated(Default) list of user-provided labels. Format is 'key:value'</td>
</tr>
<tr>
<td>namespace_id</td>
<td>UID of the namespace of a Pod</td>
</tr>
<tr>
<td>resource_id</td>
<td>A unique identifier used to differentiate multiple metrics of the same type. e.x. Fs partitions under filesystem/usage</td>
</tr>
</tbody>
</table>
<h1 id="5-heapster-api">5. heapster API</h1>
<p>见官方文档：<a href="https://github.com/kubernetes/heapster/blob/master/docs/model.md">https://github.com/kubernetes/heapster/blob/master/docs/model.md</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5a2ec7c9c0c23b6304b5fdd306263b4c">16.5 - Influxdb介绍</h1>
    
	<h1 id="1-influxdb简介">1. InfluxDB简介</h1>
<p>InfluxDB是一个当下比较流行的时序数据库，InfluxDB使用 Go 语言编写，无需外部依赖，安装配置非常方便，适合构建大型分布式系统的监控系统。</p>
<p>主要特色功能：</p>
<p>1）基于时间序列，支持与时间有关的相关函数（如最大，最小，求和等）</p>
<p>2）可度量性：你可以实时对大量数据进行计算</p>
<p>3）基于事件：它支持任意的事件数据</p>
<h1 id="2-influxdb安装">2. InfluxDB安装</h1>
<h2 id="1-安装">1）安装</h2>
<p>wget <a href="https://dl.influxdata.com/influxdb/releases/influxdb-0.13.0.x86_64.rpm">https://dl.influxdata.com/influxdb/releases/influxdb-0.13.0.x86_64.rpm</a></p>
<p>yum localinstall influxdb-0.13.0.armhf.rpm</p>
<h2 id="2-启动">2）启动</h2>
<p>service influxdb start</p>
<h2 id="3-访问">3）访问</h2>
<p>http://服务器IP:8083</p>
<h2 id="4-docker-image方式安装">4）docker image方式安装</h2>
<p>docker pull influxdb</p>
<p>docker run -d -p 8083:8083 -p 8086:8086 --expose 8090 --expose 8099 --volume=/opt/data/influxdb:/data --name influxsrv influxdb:latest</p>
<h1 id="3-influxdb的基本概念">3. InfluxDB的基本概念</h1>
<h2 id="3-1-与传统数据库中的名词做比较">3.1. 与传统数据库中的名词做比较</h2>
<table>
<thead>
<tr>
<th>influxDB中的名词</th>
<th>传统数据库中的概念</th>
</tr>
</thead>
<tbody>
<tr>
<td>database</td>
<td>数据库</td>
</tr>
<tr>
<td>measurement</td>
<td>数据库中的表</td>
</tr>
<tr>
<td>points</td>
<td>表里面的一行数据</td>
</tr>
</tbody>
</table>
<h2 id="3-2-influxdb中独有的概念">3.2. InfluxDB中独有的概念</h2>
<h2 id="3-2-1-point">3.2.1. Point</h2>
<p>Point由时间戳（time）、数据（field）、标签（tags）组成。</p>
<p>Point相当于传统数据库里的一行数据，如下表所示：</p>
<table>
<thead>
<tr>
<th>Point属性</th>
<th>传统数据库中的概念</th>
</tr>
</thead>
<tbody>
<tr>
<td>time</td>
<td>每个数据记录时间，是数据库中的主索引(会自动生成)</td>
</tr>
<tr>
<td>fields</td>
<td>各种记录值（没有索引的属性）也就是记录的值：温度， 湿度</td>
</tr>
<tr>
<td>tags</td>
<td>各种有索引的属性：地区，海拔</td>
</tr>
</tbody>
</table>
<h2 id="3-2-2-series">3.2.2. series</h2>
<p>所有在数据库中的数据，都需要通过图表来展示，而这个series表示这个表里面的数据，可以在图表上画成几条线：通过tags排列组合算出来</p>
<p>show series from cpu</p>
<h1 id="4-influxdb的基本操作">4. InfluxDB的基本操作</h1>
<p>InfluxDB提供三种操作方式：</p>
<p>1）客户端命令行方式</p>
<p>2）HTTP API接口</p>
<p>3）各语言API库</p>
<h2 id="4-1-influxdb数据库操作">4.1. InfluxDB数据库操作</h2>
<table>
<thead>
<tr>
<th>操作</th>
<th>命令</th>
</tr>
</thead>
<tbody>
<tr>
<td>显示数据库</td>
<td>show databases</td>
</tr>
<tr>
<td>创建数据库</td>
<td>create database <code>db_name</code></td>
</tr>
<tr>
<td>删除数据库</td>
<td>drop database <code>db_name</code></td>
</tr>
<tr>
<td>使用某个数据库</td>
<td>use <code>db_name</code></td>
</tr>
</tbody>
</table>
<h2 id="4-2-influxdb数据表操作">4.2. InfluxDB数据表操作</h2>
<table>
<thead>
<tr>
<th>操作</th>
<th>命令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>显示所有表</td>
<td>SHOW MEASUREMENTS</td>
<td></td>
</tr>
<tr>
<td>创建数据表</td>
<td>insert <code>table_name</code>,hostname=server01 value=442221834240i 1435362189575692182</td>
<td>其中 disk_free 就是表名，hostname是索引，value=xx是记录值，记录值可以有多个，最后是指定的时间</td>
</tr>
<tr>
<td>删除数据表</td>
<td>drop measurement <code>table_name</code></td>
<td></td>
</tr>
<tr>
<td>查看表内容</td>
<td>select * from <code>table_name</code></td>
<td></td>
</tr>
<tr>
<td>查看series</td>
<td>show series from <code>table_name</code></td>
<td>series表示这个表里面的数据，可以在图表上画成几条线，series主要通过tags排列组合算出来</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-92606946619161c3d94670cf180b1a17">16.6 - Grafana部署</h1>
    
	<h1 id="docker部署">Docker部署</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker run -d -p 3000:3000 grafana/grafana:latest
</span></span></code></pre></div><h1 id="k8s部署">K8S部署</h1>
<p>helm部署</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add grafana https://grafana.github.io/helm-charts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helm search repo grafana
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://grafana.com/docs/grafana/latest/setup-grafana/installation/">Install Grafana | Grafana documentation</a></p>
</li>
<li>
<p><a href="https://grafana.com/docs/grafana/latest/setup-grafana/installation/kubernetes/">Deploy Grafana on Kubernetes | Grafana documentation</a></p>
</li>
<li>
<p><a href="https://github.com/grafana/helm-charts">GitHub - grafana/helm-charts</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7b4b96a3a83b45c497c96ca31639e4fe">17 - Serverless</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e44de3d390def178636536ce707a8319">17.1 - knative介绍</h1>
    
	<h1 id="1-knative简介">1. knative简介</h1>
<p>knative是一个将serverless的能力扩展到k8s中的开源项目。serverless让开发者无需关注容器、镜像、运维等事项，集中精力于开发代码本身，即将代码通过免运维的形式交付给serverless平台。代码会在设定的条件下运行，并自动实现扩缩容。</p>
<h1 id="2-knative的组件">2. knative的组件</h1>
<p>knative主要包含三个部分：</p>
<ul>
<li>
<p><strong>build</strong>: 将代码转换为容器，主要包括</p>
<ul>
<li>将源代码从git仓库拉取下来，安装相关的依赖</li>
<li>构建容器镜像</li>
<li>将容器镜像推送到镜像仓库</li>
</ul>
</li>
<li>
<p><strong>Serving</strong>：创建一个可伸缩的部署。</p>
<ul>
<li>配置定义了服务的状态，包括版本管理，每次修改都创建一个新版本部署，并保留旧版本。</li>
<li>灵活的路由控制，可以控制百分比的路由到新版本和旧版本服务。</li>
<li>自动弹性伸缩，可以快速创建上千个实例或快速调整实例数为0。</li>
</ul>
</li>
<li>
<p><strong>Eventing</strong>：事件触发，通过定义各种事件使用knative自动来完成这些任务，而无需手动编写脚本。</p>
</li>
</ul>
<h1 id="3-部署knative">3. 部署knative</h1>
<p>部署knative主要是部署Serving和Eventing两个组件，可以单独部署也可以同时部署。</p>
<h2 id="3-1-部署serving">3.1. 部署Serving</h2>
<ol>
<li>
<p>部署CRD</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.10.1/serving-crds.yaml
</span></span></code></pre></div></li>
<li>
<p>部署Serving</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.10.1/serving-core.yaml
</span></span></code></pre></div></li>
<li>
<p>部署HPA autoscaling（可选）</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.10.1/serving-hpa.yaml
</span></span></code></pre></div></li>
</ol>
<p>查看部署结果</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kgdep -n knative-serving</span>
</span></span><span style="display:flex;"><span>NAME                                    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/activator               1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           107s
</span></span><span style="display:flex;"><span>deployment.apps/autoscaler              1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           107s
</span></span><span style="display:flex;"><span>deployment.apps/autoscaler-hpa          1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           107s
</span></span><span style="display:flex;"><span>deployment.apps/controller              1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           107s
</span></span><span style="display:flex;"><span>deployment.apps/domain-mapping          1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           107s
</span></span><span style="display:flex;"><span>deployment.apps/domainmapping-webhook   1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           107s
</span></span><span style="display:flex;"><span>deployment.apps/webhook                 1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           107s
</span></span></code></pre></div><h2 id="3-2-部署eventing">3.2. 部署Eventing</h2>
<ol>
<li>
<p>部署CRD</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://github.com/knative/eventing/releases/download/knative-v1.10.0/eventing-crds.yaml
</span></span></code></pre></div></li>
<li>
<p>部署Eventing</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f https://github.com/knative/eventing/releases/download/knative-v1.10.0/eventing-core.yaml
</span></span></code></pre></div></li>
</ol>
<p>查看部署结果</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kgdep -n knative-eventing</span>
</span></span><span style="display:flex;"><span>NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>eventing-controller     1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           2m13s
</span></span><span style="display:flex;"><span>eventing-webhook        1/1     <span style="color:#0000cf;font-weight:bold">1</span>            <span style="color:#0000cf;font-weight:bold">1</span>           2m13s
</span></span><span style="display:flex;"><span>pingsource-mt-adapter   0/0     <span style="color:#0000cf;font-weight:bold">0</span>            <span style="color:#0000cf;font-weight:bold">0</span>           2m13s
</span></span></code></pre></div><h1 id="4-部署knative客户端">4. 部署knative客户端</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> wget https://github.com/knative/client/releases/download/knative-v1.10.0/kn-linux-amd64
</span></span><span style="display:flex;"><span> chmod +x kn-linux-amd64
</span></span><span style="display:flex;"><span> mv kn-linux-amd64 /usr/bin/kn
</span></span></code></pre></div><p>kn命令：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kn
</span></span><span style="display:flex;"><span>kn is the <span style="color:#204a87">command</span> line interface <span style="color:#204a87;font-weight:bold">for</span> managing Knative Serving and Eventing resources
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Find more information about Knative at: https://knative.dev
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Serving Commands:
</span></span><span style="display:flex;"><span>  service      Manage Knative services
</span></span><span style="display:flex;"><span>  revision     Manage service revisions
</span></span><span style="display:flex;"><span>  route        List and describe service routes
</span></span><span style="display:flex;"><span>  domain       Manage domain mappings
</span></span><span style="display:flex;"><span>  container    Manage service<span style="color:#a40000">&#39;</span>s containers <span style="color:#ce5c00;font-weight:bold">(</span>experimental<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Eventing Commands:
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">source</span>       Manage event sources
</span></span><span style="display:flex;"><span>  broker       Manage message brokers
</span></span><span style="display:flex;"><span>  trigger      Manage event triggers
</span></span><span style="display:flex;"><span>  channel      Manage event channels
</span></span><span style="display:flex;"><span>  subscription Manage event subscriptions
</span></span><span style="display:flex;"><span>  eventtype    Manage eventtypes
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Other Commands:
</span></span><span style="display:flex;"><span>  plugin       Manage kn plugins
</span></span><span style="display:flex;"><span>  secret       Manage secrets
</span></span><span style="display:flex;"><span>  completion   Output shell completion code
</span></span><span style="display:flex;"><span>  version      Show the version of this client
</span></span></code></pre></div><h1 id="5-创建示例服务">5. 创建示例服务</h1>
<p>以下通过yaml的方式演示。</p>
<blockquote>
<p>vi hello.yaml</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">serving.knative.dev/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">hello</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ghcr.io/knative/helloworld-go:latest</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TARGET</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;World&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f hello.yaml
</span></span></code></pre></div><p>查看服务</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get ksvc</span>
</span></span><span style="display:flex;"><span>NAME    URL                                      LATESTCREATED   LATESTREADY   READY     REASON
</span></span><span style="display:flex;"><span>hello   http://hello.default.svc.cluster.local   hello-00001     hello-00001   Unknown   IngressNotConfigured
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubectl get po</span>
</span></span><span style="display:flex;"><span>NAME                                     READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>hello-00001-deployment-6469df75c-qpp5v   2/2     Running   <span style="color:#0000cf;font-weight:bold">0</span>          15m
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://www.ibm.com/topics/knative">https://www.ibm.com/topics/knative</a></li>
<li><a href="https://knative.dev/docs/concepts/">https://knative.dev/docs/concepts/</a></li>
<li><a href="https://knative.dev/docs/serving/">https://knative.dev/docs/serving/</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0b0757037fa2d97bf46505f9dd60576d">18 - </h1>
    
	<h1 id="summary">Summary</h1>
<h2 id="目录-a-id-introduction-a">目录 <a id="introduction"></a></h2>
<ul>
<li><a href="README.md">序言</a></li>
</ul>
<h2 id="云原生体系-a-id-paas-a">云原生体系 <a id="paas"></a></h2>
<ul>
<li><a href="paas/12-factor.md">12-Factor</a></li>
<li><a href="paas/k8s.md">K8S知识体系</a></li>
</ul>
<h2 id="安装与配置-a-id-setup-a">安装与配置 <a id="setup"></a></h2>
<ul>
<li><a href="setup/installer/_index.md">部署k8s集群</a>
<ul>
<li><a href="setup/installer/install-k8s-by-kubeadm.md">使用kubeadm安装生产环境kubernetes</a></li>
<li><a href="setup/installer/install-k8s-by-kubespray.md">使用kubespray安装kubernetes</a></li>
<li><a href="setup/installer/install-k8s-by-minikube.md">使用minikube安装kubernetes</a></li>
<li><a href="setup/installer/install-k8s-by-kind.md">使用kind安装kubernetes</a></li>
<li><a href="setup/installer/install-dashboard.md">安装k8s dashboard</a></li>
</ul>
</li>
<li><a href="setup/kubeadm-upgrade.md">kubeadm升级k8s集群</a></li>
<li><a href="setup/kubeadm-certs.md">kubeadm管理证书</a></li>
<li><a href="setup/k8s-cert.md">k8s证书及秘钥</a></li>
<li><a href="setup/k8s-version-release.md">k8s版本说明</a></li>
<li><a href="setup/k8s-changelog.md">k8s版本记录</a></li>
</ul>
<h2 id="基本概念-a-id-concepts-a">基本概念 <a id="concepts"></a></h2>
<ul>
<li><a href="concepts/architecture/_index.md">kubernetes架构</a>
<ul>
<li><a href="concepts/architecture/kubernetes-architecture.md">Kubernetes总架构图</a></li>
<li><a href="concepts/architecture/paas-based-on-docker-and-kubernetes.md">基于Docker及Kubernetes技术构建容器云（PaaS）平台概述</a></li>
</ul>
</li>
<li><a href="concepts/object/_index.md">kubernetes对象</a>
<ul>
<li><a href="concepts/object/understanding-kubernetes-objects.md">理解kubernetes对象</a></li>
<li><a href="concepts/object/kubernetes-basic-concepts.md">kubernetes常用对象说明</a></li>
</ul>
</li>
<li><a href="concepts/pod/_index.md">Pod</a>
<ul>
<li><a href="concepts/pod/pod.md">Pod介绍</a></li>
<li><a href="concepts/pod/pod-definition.md">Pod定义文件</a></li>
<li><a href="concepts/pod/pod-lifecycle.md">Pod生命周期</a></li>
<li><a href="concepts/pod/pod-probe.md">Pod健康检查</a></li>
<li><a href="concepts/pod/pod-volume.md">Pod存储卷</a></li>
<li><a href="concepts/pod/pod-scheduler.md">Pod控制器</a></li>
<li><a href="concepts/pod/pod-operation.md">Pod伸缩与升级</a></li>
</ul>
</li>
<li><a href="concepts/configmap/_index.md">配置</a>
<ul>
<li><a href="concepts/configmap/pod-configmap.md">ConfigMap</a></li>
</ul>
</li>
<li><a href="concepts/_index.md">Workload</a></li>
</ul>
<h2 id="核心原理-a-id-principle-a">核心原理 <a id="principle"></a></h2>
<ul>
<li><a href="principle/component/_index.md">核心组件</a>
<ul>
<li><a href="principle/component/kubernetes-core-principle-api-server.md">Api Server</a></li>
<li><a href="principle/component/kubernetes-core-principle-controller-manager.md">Controller Manager</a></li>
<li><a href="principle/component/kubernetes-core-principle-scheduler.md">Scheduler</a></li>
<li><a href="principle/component/kubernetes-core-principle-kubelet.md">Kubelet</a></li>
</ul>
</li>
<li><a href="principle/flow/_index.md">流程图</a>
<ul>
<li><a href="principle/flow/pod-flow.md">Pod创建流程</a></li>
<li><a href="principle/flow/pvc-flow.md">PVC创建流程</a></li>
</ul>
</li>
</ul>
<h2 id="容器网络-a-id-network-a">容器网络 <a id="network"></a></h2>
<ul>
<li><a href="network/docker-network.md">Docker网络</a></li>
<li><a href="network/kubernetes-network.md">K8S网络</a></li>
<li><a href="network/pod-dns.md">Pod的DNS策略</a></li>
<li><a href="network/flannel/_index.md">网络插件</a>
<ul>
<li><a href="network/flannel/flannel-introduction.md">Flannel介绍</a></li>
</ul>
</li>
<li><a href="network/cni/_index.md">CNI</a>
<ul>
<li><a href="network/cni/cni.md">CNI接口介绍</a></li>
<li><a href="network/cni/macvlan.md">Macvlan介绍</a></li>
</ul>
</li>
</ul>
<h2 id="容器存储-a-id-storage-a">容器存储 <a id="storage"></a></h2>
<ul>
<li><a href="storage/volume/_index.md">存储卷概念</a>
<ul>
<li><a href="storage/volume/volume.md">Volume</a></li>
<li><a href="storage/volume/persistent-volume.md">Persistent Volume</a></li>
<li><a href="storage/volume/persistent-volume-claim.md">Persistent Volume Claim</a></li>
<li><a href="storage/volume/storage-class.md">Storage Class</a></li>
<li><a href="storage/volume/dynamic-provisioning.md">Dynamic Volume Provisioning</a></li>
</ul>
</li>
<li><a href="storage/csi/_index.md">CSI</a>
<ul>
<li><a href="storage/csi/ceph/csi-cephfs-plugin.md">csi-cephfs-plugin</a></li>
<li><a href="storage/csi/ceph/deploy-csi-cephfs.md">部署csi-cephfs</a></li>
<li><a href="storage/csi/provisioner/cephfs-provisioner.md">部署cephfs-provisioner</a></li>
<li><a href="storage/csi/flexvolume.md">FlexVolume介绍</a></li>
</ul>
</li>
</ul>
<h2 id="资源隔离-a-id-resource-a">资源隔离 <a id="resource"></a></h2>
<ul>
<li><a href="resource/resource-quota.md">资源配额</a></li>
<li><a href="resource/limit-range.md">Pod限额</a></li>
<li><a href="resource/quality-of-service.md">资源服务质量</a></li>
<li><a href="resource/lxcfs/lxcfs.md">Lxcfs资源视图隔离</a></li>
</ul>
<h2 id="运维指南-a-id-operation-a">运维指南 <a id="operation"></a></h2>
<ul>
<li><a href="operation/kubernetes-troubleshooting.md">kubernetes集群问题排查</a></li>
<li><a href="operation/kubectl/_index.md">kubectl工具</a>
<ul>
<li><a href="operation/kubectl/install-kubectl.md">kubectl安装与配置</a></li>
<li><a href="operation/kubectl/kubectl-commands.md">kubectl命令说明</a></li>
<li><a href="operation/kubectl/kubectl-alias.md">kubectl命令别名</a></li>
<li><a href="operation/kubectl/kubectl-node-shell.md">kubectl进入node shell</a></li>
</ul>
</li>
<li><a href="operation/helm/_index.md">helm工具</a>
<ul>
<li><a href="operation/helm/helm-usage.md">helm的使用</a></li>
</ul>
</li>
<li><a href="operation/node/_index.md">节点迁移</a>
<ul>
<li><a href="operation/node/safely-drain-node.md">安全迁移节点</a></li>
<li><a href="operation/node/nodeselector-and-taint.md">指定Node调度与隔离</a></li>
</ul>
</li>
<li><a href="operation/registry/_index.md">镜像仓库</a>
<ul>
<li><a href="operation/registry/config-private-registry.md">配置私有的镜像仓库</a></li>
<li><a href="operation/registry/ImagePullSecrets.md">拉取私有镜像</a></li>
</ul>
</li>
<li><a href="operation/access/_index.md">访问控制</a>
<ul>
<li><a href="operation/access/rbac-auth.md">使用RBAC鉴权</a></li>
</ul>
</li>
<li><a href="operation/deployment/_index.md">版本发布</a>
<ul>
<li><a href="operation/deployment/canary-deployment.md">金丝雀发布</a></li>
</ul>
</li>
</ul>
<h2 id="开发指南-a-id-develop-a">开发指南 <a id="develop"></a></h2>
<ul>
<li><a href="develop/client-go.md">client-go的使用及源码分析</a></li>
<li><a href="develop/csi/_index.md">CSI插件开发</a>
<ul>
<li><a href="develop/csi/nfs-client-provisioner.md">nfs-client-provisioner源码分析</a></li>
<li><a href="develop/csi/csi-provisioner.md">csi-provisioner源码分析</a></li>
</ul>
</li>
<li><a href="develop/operator/_index.md">operator开发</a>
<ul>
<li><a href="develop/operator/kubebuilder.md">kubebuilder的使用</a></li>
<li><a href="develop/operator/develop-operator.md">如何开发一个Operator</a></li>
</ul>
</li>
<li><a href="develop/develop-k8s.md">k8s社区开发指南</a></li>
</ul>
<h2 id="问题排查-a-id-trouble-shooting-a">问题排查 <a id="trouble-shooting"></a></h2>
<ul>
<li><a href="trouble-shooting/node/_index.md">节点相关问题</a>
<ul>
<li><a href="trouble-shooting/node/keycreate-permission-denied.md">keycreate permission denied</a></li>
<li><a href="trouble-shooting/node/cgroup-pid-error.md">Cgroup不支持pid资源</a></li>
<li><a href="trouble-shooting/node/cgroup-subsystem-not-mount.md">Cgroup子系统无法挂载</a></li>
</ul>
</li>
<li><a href="trouble-shooting/pod-evicted.md">Pod驱逐</a></li>
<li><a href="trouble-shooting/pod-image-error.md">镜像拉取失败问题</a></li>
<li><a href="trouble-shooting/pvc-terminating.md">PVC Terminating</a></li>
</ul>
<hr>
<h2 id="源码分析-a-id-code-analysis-a">源码分析 <a id="code-analysis"></a></h2>
<ul>
<li><a href="code-analysis/code-analysis-notes.md">Kubernetes源码分析笔记</a></li>
<li><a href="code-analysis/kubelet/_index.md">kubelet</a>
<ul>
<li><a href="code-analysis/kubelet/NewKubeletCommand.md">NewKubeletCommand</a></li>
<li><a href="code-analysis/kubelet/NewMainKubelet.md">NewMainKubelet</a></li>
<li><a href="code-analysis/kubelet/startKubelet.md">startKubelet</a></li>
<li><a href="code-analysis/kubelet/syncLoopIteration.md">syncLoopIteration</a></li>
<li><a href="code-analysis/kubelet/syncPod.md">syncPod</a></li>
</ul>
</li>
<li><a href="code-analysis/kube-controller-manager/_index.md">kube-controller-manager</a>
<ul>
<li><a href="code-analysis/kube-controller-manager/NewControllerManagerCommand.md">NewControllerManagerCommand</a></li>
<li><a href="code-analysis/kube-controller-manager/deployment-controller.md">DeploymentController</a></li>
<li><a href="code-analysis/kube-controller-manager/sharedIndexInformer.md">Informer机制</a></li>
</ul>
</li>
<li><a href="code-analysis/kube-scheduler/_index.md">kube-scheduler</a>
<ul>
<li><a href="code-analysis/kube-scheduler/NewSchedulerCommand.md">NewSchedulerCommand</a></li>
<li><a href="code-analysis/kube-scheduler/registerAlgorithmProvider.md">registerAlgorithmProvider</a></li>
<li><a href="code-analysis/kube-scheduler/scheduleOne.md">scheduleOne</a></li>
<li><a href="code-analysis/kube-scheduler/findNodesThatFit.md">findNodesThatFit</a></li>
<li><a href="code-analysis/kube-scheduler/PrioritizeNodes.md">PrioritizeNodes</a></li>
<li><a href="code-analysis/kube-scheduler/preempt.md">preempt</a></li>
</ul>
</li>
<li><a href="code-analysis/kube-apiserver/_index.md">kube-apiserver</a>
<ul>
<li><a href="code-analysis/kube-apiserver/NewAPIServerCommand.md">NewAPIServerCommand</a></li>
</ul>
</li>
</ul>
<hr>
<h2 id="runtime-a-id-runtime-a">Runtime <a id="runtime"></a></h2>
<ul>
<li><a href="runtime/_index.md">Runtime</a>
<ul>
<li><a href="runtime/runtime.md">Runc和Containerd概述</a></li>
</ul>
</li>
<li><a href="runtime/containerd/_index.md">Containerd</a>
<ul>
<li><a href="runtime/containerd/install-containerd.md">安装Containerd</a></li>
</ul>
</li>
<li><a href="runtime/docker/_index.md">Docker</a>
<ul>
<li><a href="runtime/docker/docker-notes.md">Docker学习笔记</a></li>
</ul>
</li>
<li><a href="runtime/kata/_index.md">Kata Container</a>
<ul>
<li><a href="runtime/kata/kata-container.md">kata容器简介</a></li>
<li><a href="runtime/kata/kata-container-conf.md">kata配置</a></li>
</ul>
</li>
<li><a href="runtime/gpu/_index.md">GPU</a>
<ul>
<li><a href="runtime/gpu/nvidia-device-plugin.md">nvidia-device-plugin介绍</a></li>
</ul>
</li>
</ul>
<h2 id="etcd-a-id-etcd-a">Etcd <a id="etcd"></a></h2>
<ul>
<li><a href="etcd/etcd-introduction.md">Etcd介绍</a></li>
<li><a href="etcd/raft.md">Raft算法</a></li>
<li><a href="etcd/etcd-setup-flags.md">Etcd启动配置参数</a></li>
<li><a href="etcd/etcd-auth-and-security.md">Etcd访问控制</a></li>
<li><a href="etcd/etcdctl/_index.md">etcdctl命令工具</a>
<ul>
<li><a href="etcd/etcdctl/etcdctl-v3.md">etcdctl命令工具-V3</a></li>
<li><a href="etcd/etcdctl/etcdctl-v2.md">etcdctl命令工具-V2</a></li>
</ul>
</li>
<li><a href="etcd/k8s-etcd-data.md">Etcd中的k8s数据</a></li>
<li><a href="etcd/etcd-operator-usage.md">Etcd-Operator的使用</a></li>
</ul>
<h2 id="多集群管理-a-id-multi-cluster-a">多集群管理 <a id="multi-cluster"></a></h2>
<ul>
<li><a href="multi-cluster/k8s-multi-cluster-thinking.md">k8s多集群管理的思考</a></li>
<li><a href="multi-cluster/virtual-kubelet/_index.md">Virtual Kubelet</a>
<ul>
<li><a href="multi-cluster/virtual-kubelet/virtual-kubelet.md">Virtual Kubelet介绍</a></li>
<li><a href="multi-cluster/virtual-kubelet/virtual-kubelet-cmd.md">Virtual Kubelet 命令</a></li>
</ul>
</li>
<li><a href="multi-cluster/karmada/_index.md">Karmada</a>
<ul>
<li><a href="multi-cluster/karmada/karmada-introduction.md">Karmada介绍</a></li>
</ul>
</li>
</ul>
<h2 id="边缘容器-a-id-kubeedge-a">边缘容器 <a id="kubeedge"></a></h2>
<ul>
<li><a href="edge/kubeedge/kubeedge-arch.md">KubeEdge介绍</a></li>
<li><a href="edge/kubeedge/code-analysis/_index.md">KubeEdge源码分析</a>
<ul>
<li><a href="edge/kubeedge/code-analysis/cloudcore.md">cloudcore</a></li>
<li><a href="edge/kubeedge/code-analysis/edgecore.md">edgecore</a></li>
</ul>
</li>
<li><a href="edge/openyurt/_index.md">OpenYurt</a>
<ul>
<li><a href="edge/openyurt/install-openyurt.md">OpenYurt部署</a></li>
<li><a href="edge/openyurt/update-k8s-for-openyurt.md">OpenYurt部署之调整k8s配置</a></li>
</ul>
</li>
<li><a href="edge/openyurt/code-analysis/_index.md">OpenYurt源码分析</a>
<ul>
<li><a href="edge/openyurt/code-analysis/yurthub-code-analysis-1.md">YurtHub源码分析（1)</a></li>
<li><a href="edge/openyurt/code-analysis/tunnel-server-code-analysis.md">TunnelServer源码分析（1）</a></li>
<li><a href="edge/openyurt/code-analysis/tennel-agent-code-analysis.md">Tunnel-Agent源码分析</a></li>
</ul>
</li>
</ul>
<h2 id="虚拟化-a-id-kvm-a">虚拟化 <a id="kvm"></a></h2>
<ul>
<li><a href="kvm/vm-concept.md">虚拟化相关概念</a></li>
<li><a href="kvm/kubevirt/_index.md">KubeVirt</a>
<ul>
<li><a href="kvm/kubevirt/kubevirt-introduction.md">KubeVirt的介绍</a></li>
<li><a href="kvm/kubevirt/kubevirt-installation.md">KubeVirt的使用</a></li>
</ul>
</li>
</ul>
<h2 id="监控体系-a-id-monitor-a">监控体系 <a id="monitor"></a></h2>
<ul>
<li><a href="monitor/kubernetes-cluster-monitoring.md">监控体系介绍</a></li>
<li><a href="monitor/kube-promethus-stack.md">kube-prometheus-stack的使用</a></li>
<li><a href="monitor/cadvisor-introduction.md">cAdvisor介绍</a></li>
<li><a href="monitor/heapster-introduction.md">Heapster介绍</a></li>
<li><a href="monitor/influxdb-introduction.md">Influxdb介绍</a></li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2024 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
