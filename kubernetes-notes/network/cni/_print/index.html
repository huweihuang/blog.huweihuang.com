<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/kubernetes-notes/network/cni/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/kubernetes-notes/network/cni/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>CNI | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="CNI" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/kubernetes-notes/network/cni/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="CNI">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CNI"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/kubernetes-notes/" ><span class="active">Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/k8s-source-code-analysis/" ><span>Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/linux-notes/" ><span>Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.eb547862445a0b9050ad3128c2328ffd.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/kubernetes-notes/network/cni/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">CNI</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-2615520272860bbbdde444e096c7575e">CNI接口介绍</a></li>


    
  
    
    
	
<li>2: <a href="#pg-129b1f198fb56635dc5baed9387d2ce4">CNI插件选型</a></li>


    
  
    
    
	
<li>3: <a href="#pg-480ce0e572d2437e06aed1bd69e4be63">Macvlan介绍</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-2615520272860bbbdde444e096c7575e">1 - CNI接口介绍</h1>
    
	<h1 id="1-cni-container-network-interface">1. CNI（Container Network Interface）</h1>
<p>CNI（Container Network Interface）即容器网络接口，通过约定统一的容器网络接口，从而kubelet可以通过这个标准的API来调用不同的网络插件实现不同的网络功能。</p>
<p>kubelet启动参数--network-plugin=cni来指定CNI插件，kubelet从<code>--cni-conf-dir</code> （默认是 <code>/etc/cni/net.d</code>） 读取文件并使用 该文件中的 CNI 配置来设置各个 Pod 的网络。 CNI 配置文件必须与 <a href="https://github.com/containernetworking/cni/blob/master/SPEC.md#network-configuration">CNI 规约</a> 匹配，并且配置所引用的所有所需的 CNI 插件都应存在于 <code>--cni-bin-dir</code>（默认是 <code>/opt/cni/bin</code>）下。如果有多个CNI配置文件，kubelet 将会使用按文件名的字典顺序排列 的第一个作为配置文件。</p>
<p>CNI规范定义：</p>
<ul>
<li>
<p>网络配置文件的格式</p>
</li>
<li>
<p>容器runtime与CNI插件的通信协议</p>
</li>
<li>
<p>基于提供的配置执行网络插件的步骤</p>
</li>
<li>
<p>网络插件调用其他功能插件的步骤</p>
</li>
<li>
<p>插件返回给runtime结果的数据格式</p>
</li>
</ul>
<h1 id="2-cni配置文件格式">2. CNI配置文件格式</h1>
<p>CNI配置文件的格式为JSON格式，配置文件的默认路径：/etc/cni/net.d。插件二进制默认的路径为：/opt/cni/bin。</p>
<h2 id="2-1-主配置的字段">2.1. 主配置的字段</h2>
<ul>
<li>
<p><code>cniVersion</code> (string)：CNI规范使用的版本，例如版本为0.4.0。</p>
</li>
<li>
<p><code>name</code> (string)：目标网络的名称。</p>
</li>
<li>
<p><code>disableCheck</code> (boolean)：关闭CHECK操作。</p>
</li>
<li>
<p><code>plugins</code> (list)：CNI插件列表及插件配置。</p>
</li>
</ul>
<h2 id="2-2-插件配置字段">2.2. 插件配置字段</h2>
<p>根据不同的插件，插件配置所需的字段不同。</p>
<p>必选字段：</p>
<ul>
<li><code>type</code> (string)：节点上插件二进制的名称，比如bridge，sriov，macvlan等。</li>
</ul>
<p>可选字段：</p>
<ul>
<li>
<p><code>capabilities</code> (dictionary)</p>
</li>
<li>
<p><code>ipMasq</code> (boolean)：为目标网络配上Outbound Masquerade(地址伪装)，即：由容器内部通过网关向外发送数据包时，对数据包的源IP地址进行修改。</p>
<p>当我们的容器以宿主机作为网关时，这个参数是必须要设置的。否则，从容器内部发出的数据包就没有办法通过网关路由到其他网段。因为容器内部的IP地址无法被目标网段识别，所以这些数据包最终会被丢弃掉。</p>
</li>
<li>
<p><code>ipam</code> (dictionary)：IPAM(IP Adderss Management)即IP地址管理，提供了一系列方法用于对IP和路由进行管理。它对应的是由CNI提供的一组标准IPAM插件，比如像host-local，dhcp，static等。比如文中用到的bridge插件，会调用我们所指定的IPAM插件，实现对网络设备IP地址的分配和管理。**如果是自己开发的ipam插件，则相关的入参可以自己定义和实现。</p>
<p>以下以host-local为例说明。</p>
<ul>
<li>type：指定所用IPAM插件的名称，在我们的例子里，用的是host-local。</li>
<li>subnet：为目标网络分配网段，包括网络ID和子网掩码，以CIDR形式标记。在我们的例子里为<code>10.15.10.0/24</code>，也就是目标网段为<code>10.15.10.0</code>，子网掩码为<code>255.255.255.0</code>。</li>
<li>routes：用于指定路由规则，插件会为我们在容器的路由表里生成相应的规则。其中，dst表示希望到达的目标网段，以CIDR形式标记。gw对应网关的IP地址，也就是要到达目标网段所要经过的“next hop(下一跳)”。如果省略gw的话，那么插件会自动帮我们选择默认网关。在我们的例子里，gw选择的是默认网关，而dst为<code>0.0.0.0/0</code>则代表“任何网络”，表示数据包将通过默认网关发往任何网络。实际上，这对应的是一条默认路由规则，即：当所有其他路由规则都不匹配时，将选择该路由。</li>
<li>rangeStart：允许分配的IP地址范围的起始值</li>
<li>rangeEnd：允许分配的IP地址范围的结束值</li>
<li>gateway：为网关（也就是我们将要在宿主机上创建的bridge）指定的IP地址。如果省略的话，那么插件会自动从允许分配的IP地址范围内选择起始值作为网关的IP地址。</li>
</ul>
</li>
<li>
<p><code>dns</code> (dictionary, optional)：dns配置</p>
<ul>
<li>
<p><code>nameservers</code> (list of strings, optional)</p>
</li>
<li>
<p><code>domain</code> (string, optional)</p>
</li>
<li>
<p><code>search</code> (list of strings, optional)</p>
</li>
<li>
<p><code>options</code> (list of strings, optional)</p>
</li>
</ul>
</li>
</ul>
<h2 id="2-3-配置文件示例">2.3. 配置文件示例</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a40000">$</span> <span style="color:#a40000">mkdir</span> <span style="color:#a40000">-p</span> <span style="color:#a40000">/etc/cni/net.d</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">$</span> <span style="color:#a40000">cat</span> <span style="color:#a40000">&gt;/etc/cni/net.d/</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#a40000">-mynet.conf</span> <span style="color:#a40000">&lt;&lt;EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;cniVersion&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1.0.0&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;dbnet&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;plugins&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bridge&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// plugin specific parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">&#34;bridge&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cni0&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;keyA&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;some more&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;plugin specific&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;configuration&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;ipam&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;host-local&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// ipam specific
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">&#34;subnet&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;10.1.0.0/16&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;gateway&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;10.1.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;routes&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;dst&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;0.0.0.0/0&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;dns&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;nameservers&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;10.1.0.1&#34;</span> <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tuning&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;capabilities&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;mac&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;sysctl&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;net.core.somaxconn&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;500&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;portmap&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;capabilities&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;portMappings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-cni插件">3. CNI插件</h1>
<h2 id="3-1-安装插件">3.1. 安装插件</h2>
<p>安装CNI二进制插件，插件下载地：https://github.com/containernetworking/plugins/releases</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下载二进制</span>
</span></span><span style="display:flex;"><span>wget https://github.com/containernetworking/plugins/releases/download/v1.1.0/cni-plugins-linux-amd64-v1.1.0.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 解压文件</span>
</span></span><span style="display:flex;"><span>tar -zvxf cni-plugins-linux-amd64-v1.1.0.tgz -C /opt/cni/bin/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看解压文件</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ll -h</span>
</span></span><span style="display:flex;"><span>总用量 63M
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.7M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 bandwidth
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 4.1M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 bridge
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 9.3M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 dhcp
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 4.2M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 firewall
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.7M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 host-device
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.1M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 host-local
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.8M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 ipvlan
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.2M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 loopback
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.8M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 macvlan
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.6M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 portmap
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 4.0M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 ptp
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.4M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 sbr
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 2.7M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 static
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.3M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 tuning
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.8M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 vlan
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.4M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 vrf
</span></span></code></pre></div><h2 id="3-2-插件分类">3.2. 插件分类</h2>
<p>参考：https://www.cni.dev/plugins/current/</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>插件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>main</td>
<td>bridge</td>
<td>Creates a bridge, adds the host and the container to it</td>
</tr>
<tr>
<td></td>
<td>ipvlan</td>
<td>Adds an ipvlan interface in the container</td>
</tr>
<tr>
<td></td>
<td><strong>macvlan</strong></td>
<td>Creates a new MAC address, forwards all traffic to that to the container</td>
</tr>
<tr>
<td></td>
<td>ptp</td>
<td>Creates a veth pair</td>
</tr>
<tr>
<td></td>
<td><a href="https://www.cni.dev/plugins/current/main/host-device/">host-device</a></td>
<td>Moves an already-existing device into a container</td>
</tr>
<tr>
<td></td>
<td>vlan</td>
<td>Creates a vlan interface off a master</td>
</tr>
<tr>
<td>IPAM</td>
<td>dhcp</td>
<td>Runs a daemon on the host to make DHCP requests on behalf of a container</td>
</tr>
<tr>
<td></td>
<td>host-local</td>
<td>Maintains a local database of allocated IPs</td>
</tr>
<tr>
<td></td>
<td>static</td>
<td>Allocates static IPv4/IPv6 addresses to containers</td>
</tr>
<tr>
<td>meta</td>
<td>tuning</td>
<td>Changes sysctl parameters of an existing interface</td>
</tr>
<tr>
<td></td>
<td>portmap</td>
<td>An iptables-based portmapping plugin. Maps ports from the host’s address space to the container</td>
</tr>
<tr>
<td></td>
<td><strong>bandwidth</strong></td>
<td>Allows bandwidth-limiting through use of traffic control tbf (ingress/egress)</td>
</tr>
<tr>
<td></td>
<td>sbr</td>
<td>A plugin that configures source based routing for an interface (from which it is chained)</td>
</tr>
<tr>
<td></td>
<td>firewall</td>
<td>A firewall plugin which uses iptables or firewalld to add rules to allow traffic to/from the container</td>
</tr>
</tbody>
</table>
<h1 id="4-cni插件接口">4. CNI插件接口</h1>
<p>具体可参考：https://github.com/containernetworking/cni/blob/master/SPEC.md#cni-operations</p>
<p>CNI定义的接口操作有：</p>
<ul>
<li><code>ADD</code>：添加容器网络，在容器启动时调用。</li>
<li><code>DEL</code>：删除容器网络，在容器删除时调用。</li>
<li><code>CHECK</code>：检查容器网络是否正常。</li>
<li><code>VERSION</code>：显示插件版本。</li>
</ul>
<p>这些操作通过<code>CNI_COMMAND</code>环境变量来传递给CNI插件二进制。</p>
<p>其中环境变量包括：</p>
<ul>
<li>
<p><code>CNI_COMMAND</code>：命令操作，包括 <code>ADD</code>, <code>DEL</code>, <code>CHECK</code>, or <code>VERSION</code>。</p>
</li>
<li>
<p><code>CNI_CONTAINERID</code>:容器的ID，有runtime分配，不为空。</p>
</li>
<li>
<p><code>CNI_NETNS</code>:容器的网络命名空间，命名空间路径，例如：/run/netns/[nsname]</p>
</li>
<li>
<p><code>CNI_IFNAME</code>:容器内的网卡名称。</p>
</li>
<li>
<p><code>CNI_ARGS</code>:其他参数。</p>
</li>
<li>
<p><code>CNI_PATH</code>:CNI插件二进制的路径。</p>
</li>
</ul>
<h2 id="4-1-add接口-添加容器网络">4.1. ADD接口：添加容器网络</h2>
<p>在容器的网络命名空间<code>CNI_NETNS</code>中创建<code>CNI_IFNAME</code>网卡设备，或者调整网卡配置。</p>
<p>必选参数：</p>
<ul>
<li><code>CNI_COMMAND</code></li>
<li><code>CNI_CONTAINERID</code></li>
<li><code>CNI_NETNS</code></li>
<li><code>CNI_IFNAME</code></li>
</ul>
<p>可选参数：</p>
<ul>
<li><code>CNI_ARGS</code></li>
<li><code>CNI_PATH</code></li>
</ul>
<h2 id="4-2-del接口-删除容器网络">4.2. DEL接口：删除容器网络</h2>
<p>删除容器网络命名空间<code>CNI_NETNS</code>中的容器网卡<code>CNI_IFNAME</code>，或者撤销ADD修改操作。</p>
<p>必选参数：</p>
<ul>
<li><code>CNI_COMMAND</code></li>
<li><code>CNI_CONTAINERID</code></li>
<li><code>CNI_IFNAME</code></li>
</ul>
<p>可选参数：</p>
<ul>
<li><code>CNI_NETNS</code></li>
<li><code>CNI_ARGS</code></li>
<li><code>CNI_PATH</code></li>
</ul>
<h2 id="4-3-check接口-检查容器网络">4.3. CHECK接口：检查容器网络</h2>
<p>必选参数：</p>
<ul>
<li><code>CNI_COMMAND</code></li>
<li><code>CNI_CONTAINERID</code></li>
<li><code>CNI_NETNS</code></li>
<li><code>CNI_IFNAME</code></li>
</ul>
<p>可选参数：</p>
<ul>
<li><code>CNI_ARGS</code></li>
<li><code>CNI_PATH</code></li>
</ul>
<h2 id="4-4-version接口-输出cni的版本">4.4. VERSION接口：输出CNI的版本</h2>
<p>参考：</p>
<ul>
<li><a href="https://www.cni.dev/docs/spec/">https://www.cni.dev/docs/spec/</a></li>
<li><a href="https://github.com/containernetworking/cni">https://github.com/containernetworking/cni</a></li>
<li><a href="https://github.com/containernetworking/cni/blob/spec-v0.4.0/SPEC.md">https://github.com/containernetworking/cni/blob/spec-v0.4.0/SPEC.md</a></li>
<li><a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/">https://kubernetes.io/zh/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/</a></li>
<li><a href="https://github.com/containernetworking/plugins/tree/master/plugins">https://github.com/containernetworking/plugins/tree/master/plugins</a></li>
<li><a href="https://www.cni.dev/plugins/current/">https://www.cni.dev/plugins/current/</a></li>
<li><a href="https://cloud.tencent.com/developer/news/600713">https://cloud.tencent.com/developer/news/600713</a></li>
<li><a href="https://morningspace.github.io/tech/k8s-net-cni/#%E9%85%8D%E7%BD%AEcni%E6%8F%92%E4%BB%B6">配置CNI插件</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-129b1f198fb56635dc5baed9387d2ce4">2 - CNI插件选型</h1>
    
	<p>本文主要描述常用的CNI插件的选型，主要包括cilium，calico，flannel三种插件的对比。</p>
<h1 id="1-技术特点对比">1. 技术特点对比</h1>
<table>
<thead>
<tr>
<th>特性</th>
<th><strong>Cilium</strong></th>
<th><strong>Calico</strong></th>
<th><strong>Flannel</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>数据面技术</td>
<td>eBPF 加速</td>
<td>基于 iptables（支持 eBPF）</td>
<td>vxlan、host-gw、ipip 等隧道技术</td>
</tr>
<tr>
<td>转发效率</td>
<td>高（内核级加速，直通流量）</td>
<td>高（支持原生路由）</td>
<td>中（隧道技术增加开销）</td>
</tr>
<tr>
<td>可扩展性</td>
<td>优（支持高级 L7 策略）</td>
<td>优（支持原生路由和简单网络策略）</td>
<td>较低（以 L3 网络为主）</td>
</tr>
<tr>
<td>延迟</td>
<td>低（无需额外隧道或规则）</td>
<td>低（无隧道或 eBPF 模式）</td>
<td>较高（隧道封装增加延迟）</td>
</tr>
<tr>
<td>吞吐量</td>
<td>高（eBPF 高效转发）</td>
<td>中（依赖 iptables 或 eBPF）</td>
<td>较低（隧道开销显著）</td>
</tr>
</tbody>
</table>
<h1 id="2-性能指标对比">2. 性能指标对比</h1>
<table>
<thead>
<tr>
<th>性能指标</th>
<th><strong>Cilium</strong></th>
<th><strong>Calico</strong></th>
<th><strong>Flannel</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>吞吐量</strong></td>
<td>高（eBPF 高效转发）</td>
<td>中-高（取决于模式）</td>
<td>较低（隧道封装损耗较大）</td>
</tr>
<tr>
<td><strong>延迟</strong></td>
<td>低（直接路由模式最佳）</td>
<td>较低（非隧道模式表现良好）</td>
<td>较高（隧道增加延迟）</td>
</tr>
<tr>
<td><strong>CPU使用</strong></td>
<td>较高（eBPF 和可观测性功能）</td>
<td>中（iptables/eBPF 开销）</td>
<td>低（简单架构）</td>
</tr>
<tr>
<td><strong>内存使用</strong></td>
<td>较高（功能丰富）</td>
<td>中</td>
<td>低</td>
</tr>
</tbody>
</table>
<h1 id="3-测试数据示例">3. 测试数据示例</h1>
<p>以下是根据典型测试场景总结的指标（单位为吞吐量 Mbps 和延迟 ms）：</p>
<table>
<thead>
<tr>
<th>测试场景</th>
<th><strong>Cilium</strong></th>
<th><strong>Calico</strong></th>
<th><strong>Flannel</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>吞吐量 (单节点)</strong></td>
<td>~9,000 Mbps</td>
<td>~8,500 Mbps</td>
<td>~6,000 Mbps</td>
</tr>
<tr>
<td><strong>吞吐量 (跨节点)</strong></td>
<td>~8,000 Mbps</td>
<td>~7,500 Mbps</td>
<td>~5,000 Mbps</td>
</tr>
<tr>
<td><strong>延迟 (单节点)</strong></td>
<td>~0.2 ms</td>
<td>~0.3 ms</td>
<td>~1.0 ms</td>
</tr>
<tr>
<td><strong>延迟 (跨节点)</strong></td>
<td>~0.4 ms</td>
<td>~0.5 ms</td>
<td>~2.0 ms</td>
</tr>
</tbody>
</table>
<p>2020年测试数据：</p>
<p>数据来源：<a href="https://itnext.io/benchmark-results-of-kubernetes-network-plugins-cni-over-10gbit-s-network-updated-august-2020-6e1b757b9e49">Benchmark results of Kubernetes network plugins (CNI) over 10Gbit/s network (Updated: August 2020)</a></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1731839739/article/kubernetes/network/cni/cni-comparison.webp" alt=""></p>
<p>[2024年]单位带宽消耗的CPU和内存数据：</p>
<p>数据来源：<a href="https://itnext.io/benchmark-results-of-kubernetes-network-plugins-cni-over-40gbit-s-network-2024-156f085a5e4e#89d8-90c23c8caeb4-reply">Benchmark results of Kubernetes network plugins (CNI) over 40Gbit/s network -2024</a></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1731839992/article/kubernetes/network/cni/Resource-efficiency-per-CNI.webp" alt=""></p>
<p>以上可以看出cilium单位消耗的CPU和内存相比于flannel高。</p>
<h1 id="4-网络性能分析">4. 网络性能分析</h1>
<h2 id="4-1-cilium">4.1. Cilium</h2>
<ul>
<li><strong>吞吐量</strong>：基于 eBPF 的数据面技术，可直接在 Linux 内核中高效转发流量，减少上下文切换。使用直连路由模式（<code>--tunnel=disabled</code>）时，进一步减少封装开销。</li>
<li><strong>延迟</strong>：支持 Sidecar-less 的服务网格架构，能够降低服务间通信延迟。</li>
<li><strong>资源消耗</strong>：由于其高级功能（如 Hubble 可观测性和 L7 策略），在 CPU 和内存使用上高于其他插件。</li>
</ul>
<h2 id="4-2-calico">4.2. Calico</h2>
<ul>
<li><strong>吞吐量</strong>：非隧道模式下，基于 BGP 的原生路由性能接近裸机水平；启用 eBPF 模式时，性能进一步提升。</li>
<li><strong>延迟</strong>：表现良好，但在复杂网络策略下可能增加延迟。</li>
<li><strong>资源消耗</strong>：资源使用适中，适合大多数生产环境。</li>
</ul>
<h2 id="4-3-flannel">4.3. Flannel</h2>
<ul>
<li><strong>吞吐量</strong>：由于采用 VXLAN、IPIP 等隧道封装方式，其性能通常不如 Cilium 和 Calico。</li>
<li><strong>延迟</strong>：封装和解封装的额外操作导致延迟增加。</li>
<li><strong>资源消耗</strong>：架构简单，资源使用最低，适合资源有限的小型集群。</li>
</ul>
<h1 id="5-业务场景选型">5. 业务场景选型</h1>
<p><strong>1. Cilium：适合高性能与安全需求的场景</strong></p>
<ul>
<li>适用场景：
<ul>
<li><strong>微服务架构</strong>：Cilium 的 eBPF 技术支持 L7 数据包过滤、服务可观测性和无 Sidecar 服务网格，非常适合复杂微服务环境。</li>
<li><strong>边缘计算</strong>：在边缘节点上，需要低延迟和高吞吐量，Cilium 的直连路由模式（<code>--tunnel=disabled</code>）非常高效。</li>
<li><strong>多云和混合云</strong>：支持多种高级网络功能，如网络策略的灵活配置和透明的加密。</li>
</ul>
</li>
<li>局限性：
<ul>
<li>部署复杂度相对较高，对 Linux 内核版本有要求（推荐 5.3+）。</li>
<li>资源消耗比 Flannel 高。</li>
</ul>
</li>
</ul>
<p><strong>2. Calico：适合大规模、灵活策略的企业集群</strong></p>
<ul>
<li>适用场景：
<ul>
<li><strong>大规模 Kubernetes 集群</strong>：基于 BGP 的网络路由能够高效扩展，适合公有云和企业级大规模集群。</li>
<li><strong>注重安全策略</strong>：支持丰富的网络安全策略，并提供对接 eBPF 的能力，兼顾性能和策略灵活性。</li>
<li><strong>混合部署</strong>：Calico 可以在非 Kubernetes 工作负载中实现一致的网络策略。</li>
</ul>
</li>
<li>局限性：
<ul>
<li>默认基于 iptables 的实现在高负载下性能可能不如 Cilium 的 eBPF 数据面。</li>
<li>网络策略复杂度较高时，可能增加运维工作量。</li>
</ul>
</li>
</ul>
<p><strong>3. Flannel：适合轻量级和资源有限的集群</strong></p>
<ul>
<li>适用场景：
<ul>
<li><strong>小型集群</strong>：Flannel 架构简单，资源使用少，适合轻量化的 Kubernetes 部署。</li>
<li><strong>测试环境</strong>：性能需求较低的开发和测试环境中，可以快速搭建和运行。</li>
<li><strong>边缘计算（非高性能）</strong>：对网络性能要求较低的小型边缘节点可以使用。</li>
</ul>
</li>
<li>局限性：
<ul>
<li>在吞吐量和延迟上不如 Cilium 和 Calico，尤其是需要大量隧道封装时。</li>
<li>缺乏高级网络功能，例如复杂的网络策略和观测能力。</li>
</ul>
</li>
</ul>
<p><strong>4. 推荐选择总结</strong></p>
<table>
<thead>
<tr>
<th>场景类型</th>
<th>推荐插件</th>
<th>原因</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>高性能微服务架构</strong></td>
<td><strong>Cilium</strong></td>
<td>提供 eBPF 技术，支持复杂策略和低延迟网络</td>
</tr>
<tr>
<td><strong>大规模企业集群</strong></td>
<td><strong>Calico</strong></td>
<td>稳定、灵活，适合多样化和大规模 Kubernetes 部署</td>
</tr>
<tr>
<td><strong>资源受限环境</strong></td>
<td><strong>Flannel</strong></td>
<td>简单易用，资源消耗低</td>
</tr>
<tr>
<td><strong>边缘计算</strong></td>
<td><strong>Cilium/Flannel</strong></td>
<td>Cilium 适合高性能需求，Flannel 适合轻量级节点</td>
</tr>
<tr>
<td><strong>混合云/多云</strong></td>
<td><strong>Cilium/Calico</strong></td>
<td>Cilium 支持透明加密和现代架构，Calico 提供灵活网络策略支持</td>
</tr>
</tbody>
</table>
<p>参考：</p>
<ul>
<li><a href="https://docs.cilium.io/en/latest/operations/performance/benchmark/">https://docs.cilium.io/en/latest/operations/performance/benchmark/</a></li>
<li><a href="https://cilium.io/blog/2018/12/03/cni-performance/">https://cilium.io/blog/2018/12/03/cni-performance/</a></li>
<li><a href="https://cilium.io/blog/2021/05/11/cni-benchmark/">https://cilium.io/blog/2021/05/11/cni-benchmark/</a></li>
<li><a href="https://itnext.io/benchmark-results-of-kubernetes-network-plugins-cni-over-40gbit-s-network-2024-156f085a5e4e#89d8-90c23c8caeb4-reply">Benchmark results of Kubernetes network plugins (CNI) over 40Gbit/s network -2024</a></li>
<li><a href="https://itnext.io/benchmark-results-of-kubernetes-network-plugins-cni-over-10gbit-s-network-updated-august-2020-6e1b757b9e49">Benchmark results of Kubernetes network plugins (CNI) over 10Gbit/s network (Updated: August 2020)</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-480ce0e572d2437e06aed1bd69e4be63">3 - Macvlan介绍</h1>
    
	<h1 id="1-简介">1. 简介</h1>
<p>macvlan可以看做是物理接口eth（父接口）的子接口，每个macvlan都拥有独立的mac地址，可以被绑定IP作为正常的网卡接口使用。通过这个特性，可以实现在一个物理网络设备绑定多个IP，每个IP拥有独立的mac地址。该特性经常被应用在容器虚拟化中（容器可以配置macvlan的网络，将macvlan interface移动到容器的namespace中）。</p>
<p>示意图：</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan.jpg">
<h1 id="2-四种工作模式">2. 四种工作模式</h1>
<h2 id="2-1-vepa-virtual-ethernet-port-aggregator">2.1. VEPA (Virtual Ethernet Port Aggregator)</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan_vepa.jpg">
<p>VEPA为默认的工作模式，该模式下，所有macvlan发出的流量都会经过父接口，不管目的地是否与该macvlan共用一个父接口。</p>
<h2 id="2-2-bridge-mode">2.2. Bridge mode</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan_bridge.jpg">
<p>该bridge模式类似于传统的网桥模式，拥有相同父接口的macvlan可以直接进行通信，不需要将数据发给父接口转发。该模式下不需要交换机支持hairpin模式，性能比VEPA模式好。另外相对于传统的网桥模式，该模式不需要学习mac地址，不需要STP，使得其性能比传统的网桥性能好得多。但是如果父接口down掉，则所有子接口也会down，同时无法通信。</p>
<h2 id="2-3-private-mode">2.3. Private mode</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan_private.jpg">
<p>该模式是VEPA模式的增强版，</p>
<h2 id="2-4-passthru-mode">2.4. Passthru mode</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan_passthru.jpg">
<p>. </p>
<blockquote>
<p>待完善</p>
</blockquote>
<p>参考：</p>
<ul>
<li><a href="https://backreference.org/2014/03/20/some-notes-on-macvlanmacvtap/">https://backreference.org/2014/03/20/some-notes-on-macvlanmacvtap/</a></li>
<li><a href="https://github.com/containernetworking/plugins/tree/master/plugins/main/macvlan">https://github.com/containernetworking/plugins/tree/master/plugins/main/macvlan</a></li>
<li><a href="https://github.com/containernetworking/plugins/blob/master/plugins/main/macvlan/macvlan.go">https://github.com/containernetworking/plugins/blob/master/plugins/main/macvlan/macvlan.go</a></li>
<li><a href="http://wikibon.org/wiki/v/Edge_Virtual_Bridging">http://wikibon.org/wiki/v/Edge_Virtual_Bridging</a></li>
<li><a href="https://juejin.im/post/5ca183ad6fb9a05e5343a7e8">Linux 虚拟网卡技术：Macvlan</a></li>
<li><a href="http://hicu.be/bridge-vs-macvlan">http://hicu.be/bridge-vs-macvlan</a></li>
<li><a href="http://hicu.be/docker-networking-macvlan-bridge-mode-configuration">http://hicu.be/docker-networking-macvlan-bridge-mode-configuration</a></li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2025 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
