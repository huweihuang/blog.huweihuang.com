<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://k8s.huweihuang.com/kubernetes-notes/network/">
<link rel="alternate" type="application/rss&#43;xml" href="https://k8s.huweihuang.com/kubernetes-notes/network/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>容器网络 | HUWEIHUAHG</title>
<meta name="description" content="">
<meta property="og:title" content="容器网络" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://k8s.huweihuang.com/kubernetes-notes/network/" /><meta property="og:site_name" content="HUWEIHUAHG" />

<meta itemprop="name" content="容器网络">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="容器网络"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.cd6c2bbb05cdf98237b53882fed8c7a8b3fd7a7f7963d7cb305dd0d984782137.css" as="style">
<link href="/scss/main.min.cd6c2bbb05cdf98237b53882fed8c7a8b3fd7a7f7963d7cb305dd0d984782137.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">HUWEIHUAHG</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/kubernetes-notes/" ><span class="active">Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/k8s-source-code-analysis/" ><span>Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label="站内搜索…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/kubernetes-notes/network/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">容器网络</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-74c4bd794700f9208344a668233bf9d0">Docker网络</a></li>


    
  
    
    
	
<li>2: <a href="#pg-522f5907d7543b0318052a0b43976cfc">K8S网络</a></li>


    
  
    
    
	
<li>3: <a href="#pg-7939a3d9fca50e5749edc0a71a21c9c5">CNI</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-2615520272860bbbdde444e096c7575e">CNI接口介绍</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-480ce0e572d2437e06aed1bd69e4be63">Macvlan介绍</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-88a4539d1d63c4a8a931f76e2fb0b364">网络插件</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-2823d1f38cf03cb8645be41837a3231f">Flannel介绍</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-e1622b1588cb7127df05e7691bb911bd">k8s网关</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-181eada22ecde3bdfce4c31dff04e635">安装APISIX</a></li>


    
  
    
    
	
<li>5.2: <a href="#pg-152c1f49b08d537c43d684c68bdb1e9b">创建路由</a></li>


    
  
    
    
	
<li>5.3: <a href="#pg-dcc4be6cc2df9826bdbfe0119d889b8f">ingress-controller原理</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-74c4bd794700f9208344a668233bf9d0">1 - Docker网络</h1>
    
	<h1 id="1-docker的网络基础">1. Docker的网络基础</h1>
<h2 id="1-1-network-namespace">1.1. Network Namespace</h2>
<p>不同的网络命名空间中，协议栈是独立的，完全隔离，彼此之间无法通信。同一个网络命名空间有独立的路由表和独立的<code>Iptables/Netfilter</code>来提供包的转发、NAT、IP包过滤等功能。</p>
<h3 id="1-1-1-网络命名空间的实现">1.1.1. 网络命名空间的实现</h3>
<p>将与网络协议栈相关的全局变量变成一个<code>Net Namespace</code>变量的成员，然后在调用协议栈函数中加入一个Namepace参数。</p>
<h3 id="1-1-2-网络命名空间的操作">1.1.2. 网络命名空间的操作</h3>
<p>1、创建网络命名空间</p>
<p>ip netns add <code>name</code></p>
<p>2、在命名空间内执行命令</p>
<p>ip netns exec <code>name</code> <code>command</code></p>
<p>3、进入命名空间</p>
<p>ip netns exec <code>name</code> bash</p>
<h1 id="2-docker的网络实现">2. Docker的网络实现</h1>
<h2 id="2-1-容器网络">2.1. 容器网络</h2>
<p>Docker使用Linux桥接，在宿主机虚拟一个Docker容器网桥(docker0)，Docker启动一个容器时会根据Docker网桥的网段分配给容器一个IP地址，称为Container-IP，同时Docker网桥是每个容器的默认网关。因为在同一宿主机内的容器都接入同一个网桥，这样容器之间就能够通过容器的Container-IP直接通信。</p>
<p>Docker网桥是宿主机虚拟出来的，并不是真实存在的网络设备，外部网络是无法寻址到的，这也意味着外部网络无法通过直接Container-IP访问到容器。如果容器希望外部访问能够访问到，可以通过映射容器端口到宿主主机（端口映射），即docker run创建容器时候通过 -p 或 -P 参数来启用，访问容器的时候就通过[宿主机IP]:[容器端口]访问容器。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578957/article/kubernetes/network/container-network.png" alt="这里写图片描述"></p>
<h2 id="2-2-4类网络模式">2.2. 4类网络模式</h2>
<table>
<thead>
<tr>
<th>Docker网络模式</th>
<th>配置</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>host模式</td>
<td>--net=host</td>
<td>容器和宿主机共享Network namespace。</td>
</tr>
<tr>
<td>container模式</td>
<td>--net=container:NAME_or_ID</td>
<td>容器和另外一个容器共享Network namespace。 kubernetes中的pod就是多个容器共享一个Network namespace。</td>
</tr>
<tr>
<td>none模式</td>
<td>--net=none</td>
<td>容器有独立的Network namespace，但并没有对其进行任何网络设置，如分配veth pair 和网桥连接，配置IP等。</td>
</tr>
<tr>
<td>bridge模式</td>
<td>--net=bridge（默认为该模式）</td>
<td>桥接模式</td>
</tr>
</tbody>
</table>
<h1 id="3-docker网络模式">3. Docker网络模式</h1>
<h2 id="3-1-bridge桥接模式">3.1. bridge桥接模式</h2>
<p>在bridge模式下，Docker可以使用独立的网络栈。实现方式是父进程在创建子进程的时候通过传入<code>CLONE_NEWNET</code>的参数创建出一个网络命名空间。</p>
<p><strong>实现步骤：</strong></p>
<ol>
<li>Docker Daemon首次启动时会创建一个虚拟网桥docker0，地址通常为172.x.x.x开头，在私有的网络空间中给这个网络分配一个子网。</li>
<li>由Docker创建处理的每个容器，都会创建一个虚拟以太设备对（veth pair），一端关联到网桥，另一端使用Namespace技术映射到容器内的eth0设备，然后从网桥的地址段内给eth0接口分配一个IP地址。</li>
</ol>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578957/article/kubernetes/network/bridge.png" alt="这里写图片描述"></p>
<p>一般情况，宿主机IP与docker0 IP、容器IP是不同的IP段，默认情况，外部看不到docker0和容器IP，对于外部来说相当于docker0和容器的IP为内网IP。</p>
<h3 id="3-1-1-外部网络访问docker容器">3.1.1. 外部网络访问Docker容器</h3>
<p>外部访问docker容器可以通过<code>端口映射(NAT)</code>的方式，Docker使用NAT的方式将容器内部的服务与宿主机的某个端口port_1绑定。</p>
<p>外部访问容器的流程如下：</p>
<ol>
<li>外界网络通过宿主机的IP和映射的端口port_1访问。</li>
<li>当宿主机收到此类请求，会通过DNAT将请求的目标IP即宿主机IP和目标端口即映射端口port_1替换成容器的IP和容器的端口port_0。</li>
<li>由于宿主机上可以识别容器IP，所以宿主机将请求发给veth pair。</li>
<li>veth pair将请求发送给容器内部的eth0，由容器内部的服务进行处理。</li>
</ol>
<h3 id="3-1-2-docker容器访问外部网络">3.1.2. Docker容器访问外部网络</h3>
<p>docker容器访问外部网络的流程：</p>
<ol>
<li>
<p>docker容器向外部目标IP和目标端口port_2发起请求，请求报文中的源IP为容器IP。</p>
</li>
<li>
<p>请求通过容器内部的eth0到veth pair的另一端docker0网桥。</p>
</li>
<li>
<p>docker0网桥通过数据报转发功能将请求转发到宿主机的eth0。</p>
</li>
<li>
<p>宿主机处理请求时通过SNAT将请求中的源IP换成宿主机eth0的IP。</p>
</li>
<li>
<p>处理后的报文通过请求的目标IP发送到外部网络。</p>
</li>
</ol>
<h3 id="3-1-3-缺点">3.1.3. 缺点</h3>
<p>使用NAT的方式可能会带来性能的问题，影响网络传输效率。</p>
<h2 id="3-2-host模式">3.2. host模式</h2>
<p>host模式并没有给容器创建一个隔离的网络环境，而是和宿主机共用一个网络命名空间，容器使用宿主机的eth0和外界进行通信，同样容器也共用宿主机的端口资源，即分配端口可能存在与宿主机已分配的端口冲突的问题。</p>
<p>实现的方式即父进程在创建子进程的时候不传入<code>CLONE_NEWNET</code>的参数，从而和宿主机共享一个网络空间。</p>
<p>host模式没有通过NAT的方式进行转发因此性能上相对较好，但是不存在网络隔离性，可能产生端口冲突的问题。</p>
<h2 id="3-3-container模式">3.3. container模式</h2>
<p>container模式即docker容器可以使用其他容器的网络命名空间，即和其他容器处于同一个网络命名空间。</p>
<p>步骤：</p>
<ol>
<li>查找其他容器的网络命名空间。</li>
<li>新创建的容器的网络命名空间使用其他容器的网络命名空间。</li>
</ol>
<p>通过和其他容器共享网络命名空间的方式，可以让不同的容器之间处于相同的网络命名空间，可以直接通过localhost的方式进行通信，简化了强关联的多个容器之间的通信问题。</p>
<p>k8s中的pod的概念就是通过一组容器共享一个网络命名空间来达到pod内部的不同容器可以直接通过localhost的方式进行通信。</p>
<h2 id="3-4-none模式">3.4. none模式</h2>
<p>none模式即不为容器创建任何的网络环境，用户可以根据自己的需要手动去创建不同的网络定制配置。</p>
<p>参考：</p>
<ul>
<li>《Docker源码分析》</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-522f5907d7543b0318052a0b43976cfc">2 - K8S网络</h1>
    
	<h1 id="1-kubernetes网络模型">1. kubernetes网络模型</h1>
<h2 id="1-1-基础原则">1.1. 基础原则</h2>
<ol>
<li>每个Pod都拥有一个独立的IP地址，而且假定所有Pod都在一个可以直接连通的、扁平的网络空间中，不管是否运行在同一Node上都可以通过Pod的IP来访问。</li>
<li>k8s中Pod的IP是最小粒度IP。同一个Pod内所有的容器共享一个网络堆栈，该模型称为IP-per-Pod模型。</li>
<li>Pod由docker0实际分配的IP，Pod内部看到的IP地址和端口与外部保持一致。同一个Pod内的不同容器共享网络，可以通过localhost来访问对方的端口，类似同一个VM内的不同进程。</li>
<li>IP-per-Pod模型从端口分配、域名解析、服务发现、负载均衡、应用配置等角度看，Pod可以看作是一台独立的VM或物理机。</li>
</ol>
<h2 id="1-2-k8s对集群的网络要求">1.2. k8s对集群的网络要求</h2>
<ol>
<li>所有容器都可以不用NAT的方式同别的容器通信。</li>
<li>所有节点都可以在不同NAT的方式下同所有容器通信，反之亦然。</li>
<li>容器的地址和别人看到的地址是同一个地址。</li>
</ol>
<p>以上的集群网络要求可以通过第三方开源方案实现，例如flannel。</p>
<h2 id="1-3-网络架构图">1.3. 网络架构图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578957/article/kubernetes/network/network-arch.png" alt="这里写图片描述"></p>
<h2 id="1-4-k8s集群ip概念汇总">1.4. k8s集群IP概念汇总</h2>
<p>由集群外部到集群内部：</p>
<table>
<thead>
<tr>
<th>IP类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Proxy-IP</td>
<td>代理层公网地址IP，外部访问应用的网关服务器。[实际需要关注的IP]</td>
</tr>
<tr>
<td>Service-IP</td>
<td>Service的固定虚拟IP，Service-IP是内部，外部无法寻址到。</td>
</tr>
<tr>
<td>Node-IP</td>
<td>容器宿主机的主机IP。</td>
</tr>
<tr>
<td>Container-Bridge-IP</td>
<td>容器网桥（docker0）IP，容器的网络都需要通过容器网桥转发。</td>
</tr>
<tr>
<td>Pod-IP</td>
<td>Pod的IP，等效于Pod中网络容器的Container-IP。</td>
</tr>
<tr>
<td>Container-IP</td>
<td>容器的IP，容器的网络是个隔离的网络空间。</td>
</tr>
</tbody>
</table>
<h1 id="2-kubernetes的网络实现">2. kubernetes的网络实现</h1>
<p>k8s网络场景</p>
<ol>
<li>容器与容器之间的直接通信。</li>
<li>Pod与Pod之间的通信。</li>
<li>Pod到Service之间的通信。</li>
<li>集群外部与内部组件之间的通信。</li>
</ol>
<h2 id="2-1-pod网络">2.1. Pod网络</h2>
<p>Pod作为kubernetes的最小调度单元，Pod是容器的集合，是一个逻辑概念，Pod包含的容器都运行在同一个宿主机上，这些容器将拥有同样的网络空间，容器之间能够互相通信，它们能够在本地访问其它容器的端口。 实际上Pod都包含一个网络容器，它不做任何事情，只是用来接管Pod的网络，业务容器通过加入网络容器的网络从而实现网络共享。Pod网络本质上还是容器网络，所以Pod-IP就是网络容器的Container-IP。</p>
<p>一般将容器云平台的网络模型打造成一个扁平化网络平面，在这个网络平面内，Pod作为一个网络单元同Kubernetes Node的网络处于同一层级。</p>
<h2 id="2-2-pod内部容器之间的通信">2.2. Pod内部容器之间的通信</h2>
<p>同一个Pod之间的不同容器因为共享同一个网络命名空间，所以可以直接通过localhost直接通信。</p>
<h2 id="2-3-pod之间的通信">2.3. Pod之间的通信</h2>
<h3 id="2-3-1-同node的pod之间的通信">2.3.1. 同Node的Pod之间的通信</h3>
<p>同一个Node内，不同的Pod都有一个全局IP，可以直接通过Pod的IP进行通信。Pod地址和docker0在同一个网段。</p>
<p>在pause容器启动之前，会创建一个虚拟以太网接口对（veth pair），该接口对一端连着容器内部的eth0 ，一端连着容器外部的vethxxx，vethxxx会绑定到容器运行时配置使用的网桥bridge0上，从该网络的IP段中分配IP给容器的eth0。</p>
<p>当同节点上的Pod-A发包给Pod-B时，包传送路线如下：</p>
<pre tabindex="0"><code>pod-a的eth0—&gt;pod-a的vethxxx—&gt;bridge0—&gt;pod-b的vethxxx—&gt;pod-b的eth0
</code></pre><p>因为相同节点的bridge0是相通的，因此可以通过bridge0来完成不同pod直接的通信，但是不同节点的bridge0是不通的，因此不同节点的pod之间的通信需要将不同节点的bridge0给连接起来。</p>
<h3 id="2-3-2-不同node的pod之间的通信">2.3.2. 不同Node的Pod之间的通信</h3>
<p>不同的Node之间，Node的IP相当于外网IP，可以直接访问，而Node内的docker0和Pod的IP则是内网IP，无法直接跨Node访问。需要通过Node的网卡进行转发。</p>
<p>所以不同Node之间的通信需要达到两个条件：</p>
<ol>
<li>对整个集群中的Pod-IP分配进行规划，不能有冲突（可以通过第三方开源工具来管理，例如flannel）。</li>
<li>将Node-IP与该Node上的Pod-IP关联起来，通过Node-IP再转发到Pod-IP。</li>
</ol>
<p>不同节点的Pod之间的通信需要将不同节点的bridge0给连接起来。连接不同节点的bridge0的方式有好几种，主要有overlay和underlay，或常规的三层路由。</p>
<p>不同节点的bridge0需要不同的IP段，保证Pod IP分配不会冲突，节点的物理网卡eth0也要和该节点的网桥bridge0连接。因此，节点a上的pod-a发包给节点b上的pod-b，路线如下：</p>
<pre tabindex="0"><code>节点a上的pod-a的eth0—&gt;pod-a的vethxxx—&gt;节点a的bridge0—&gt;节点a的eth0—&gt;

节点b的eth0—&gt;节点b的bridge0—&gt;pod-b的vethxxx—&gt;pod-b的eth0
</code></pre><p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578957/article/kubernetes/network/pod-network.png" alt="这里写图片描述"></p>
<p><strong>1. Pod间实现通信</strong></p>
<p>例如：Pod1和Pod2（同主机），Pod1和Pod3(跨主机)能够通信</p>
<p>实现：因为Pod的Pod-IP是Docker网桥分配的，Pod-IP是同Node下全局唯一的。所以将不同Kubernetes Node的 Docker网桥配置成不同的IP网段即可。</p>
<p><strong>2. Node与Pod间实现通信</strong></p>
<p>例如：Node1和Pod1/ Pod2(同主机)，Pod3(跨主机)能够通信</p>
<p>实现：在容器集群中创建一个覆盖网络(Overlay Network)，联通各个节点，目前可以通过第三方网络插件来创建覆盖网络，比如Flannel和Open vSwitch等。</p>
<p>不同节点间的Pod访问也可以通过calico形成的Pod IP的路由表来解决。</p>
<h2 id="2-4-service网络">2.4. Service网络</h2>
<p>Service的就是在Pod之间起到服务代理的作用，对外表现为一个单一访问接口，将请求转发给Pod，Service的网络转发是Kubernetes实现服务编排的关键一环。Service都会生成一个虚拟IP，称为Service-IP， Kuberenetes Porxy组件负责实现Service-IP路由和转发，在容器覆盖网络之上又实现了虚拟转发网络。</p>
<p>Kubernetes Porxy实现了以下功能：</p>
<ol>
<li>转发访问Service的Service-IP的请求到Endpoints(即Pod-IP)。</li>
<li>监控Service和Endpoints的变化，实时刷新转发规则。</li>
<li>负载均衡能力。</li>
</ol>
<h1 id="3-开源的网络组件">3. 开源的网络组件</h1>
<h2 id="3-1-flannel">3.1. Flannel</h2>
<p>具体参考<a href="flannel/flannel-introduction.md">Flannel介绍</a></p>
<p>参考《Kubernetes权威指南》</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7939a3d9fca50e5749edc0a71a21c9c5">3 - CNI</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-2615520272860bbbdde444e096c7575e">3.1 - CNI接口介绍</h1>
    
	<h1 id="1-cni-container-network-interface">1. CNI（Container Network Interface）</h1>
<p>CNI（Container Network Interface）即容器网络接口，通过约定统一的容器网络接口，从而kubelet可以通过这个标准的API来调用不同的网络插件实现不同的网络功能。</p>
<p>kubelet启动参数--network-plugin=cni来指定CNI插件，kubelet从<code>--cni-conf-dir</code> （默认是 <code>/etc/cni/net.d</code>） 读取文件并使用 该文件中的 CNI 配置来设置各个 Pod 的网络。 CNI 配置文件必须与 <a href="https://github.com/containernetworking/cni/blob/master/SPEC.md#network-configuration">CNI 规约</a> 匹配，并且配置所引用的所有所需的 CNI 插件都应存在于 <code>--cni-bin-dir</code>（默认是 <code>/opt/cni/bin</code>）下。如果有多个CNI配置文件，kubelet 将会使用按文件名的字典顺序排列 的第一个作为配置文件。</p>
<p>CNI规范定义：</p>
<ul>
<li>
<p>网络配置文件的格式</p>
</li>
<li>
<p>容器runtime与CNI插件的通信协议</p>
</li>
<li>
<p>基于提供的配置执行网络插件的步骤</p>
</li>
<li>
<p>网络插件调用其他功能插件的步骤</p>
</li>
<li>
<p>插件返回给runtime结果的数据格式</p>
</li>
</ul>
<h1 id="2-cni配置文件格式">2. CNI配置文件格式</h1>
<p>CNI配置文件的格式为JSON格式，配置文件的默认路径：/etc/cni/net.d。插件二进制默认的路径为：/opt/cni/bin。</p>
<h2 id="2-1-主配置的字段">2.1. 主配置的字段</h2>
<ul>
<li>
<p><code>cniVersion</code> (string)：CNI规范使用的版本，例如版本为0.4.0。</p>
</li>
<li>
<p><code>name</code> (string)：目标网络的名称。</p>
</li>
<li>
<p><code>disableCheck</code> (boolean)：关闭CHECK操作。</p>
</li>
<li>
<p><code>plugins</code> (list)：CNI插件列表及插件配置。</p>
</li>
</ul>
<h2 id="2-2-插件配置字段">2.2. 插件配置字段</h2>
<p>根据不同的插件，插件配置所需的字段不同。</p>
<p>必选字段：</p>
<ul>
<li><code>type</code> (string)：节点上插件二进制的名称，比如bridge，sriov，macvlan等。</li>
</ul>
<p>可选字段：</p>
<ul>
<li>
<p><code>capabilities</code> (dictionary)</p>
</li>
<li>
<p><code>ipMasq</code> (boolean)：为目标网络配上Outbound Masquerade(地址伪装)，即：由容器内部通过网关向外发送数据包时，对数据包的源IP地址进行修改。</p>
<p>当我们的容器以宿主机作为网关时，这个参数是必须要设置的。否则，从容器内部发出的数据包就没有办法通过网关路由到其他网段。因为容器内部的IP地址无法被目标网段识别，所以这些数据包最终会被丢弃掉。</p>
</li>
<li>
<p><code>ipam</code> (dictionary)：IPAM(IP Adderss Management)即IP地址管理，提供了一系列方法用于对IP和路由进行管理。它对应的是由CNI提供的一组标准IPAM插件，比如像host-local，dhcp，static等。比如文中用到的bridge插件，会调用我们所指定的IPAM插件，实现对网络设备IP地址的分配和管理。**如果是自己开发的ipam插件，则相关的入参可以自己定义和实现。</p>
<p>以下以host-local为例说明。</p>
<ul>
<li>type：指定所用IPAM插件的名称，在我们的例子里，用的是host-local。</li>
<li>subnet：为目标网络分配网段，包括网络ID和子网掩码，以CIDR形式标记。在我们的例子里为<code>10.15.10.0/24</code>，也就是目标网段为<code>10.15.10.0</code>，子网掩码为<code>255.255.255.0</code>。</li>
<li>routes：用于指定路由规则，插件会为我们在容器的路由表里生成相应的规则。其中，dst表示希望到达的目标网段，以CIDR形式标记。gw对应网关的IP地址，也就是要到达目标网段所要经过的“next hop(下一跳)”。如果省略gw的话，那么插件会自动帮我们选择默认网关。在我们的例子里，gw选择的是默认网关，而dst为<code>0.0.0.0/0</code>则代表“任何网络”，表示数据包将通过默认网关发往任何网络。实际上，这对应的是一条默认路由规则，即：当所有其他路由规则都不匹配时，将选择该路由。</li>
<li>rangeStart：允许分配的IP地址范围的起始值</li>
<li>rangeEnd：允许分配的IP地址范围的结束值</li>
<li>gateway：为网关（也就是我们将要在宿主机上创建的bridge）指定的IP地址。如果省略的话，那么插件会自动从允许分配的IP地址范围内选择起始值作为网关的IP地址。</li>
</ul>
</li>
<li>
<p><code>dns</code> (dictionary, optional)：dns配置</p>
<ul>
<li>
<p><code>nameservers</code> (list of strings, optional)</p>
</li>
<li>
<p><code>domain</code> (string, optional)</p>
</li>
<li>
<p><code>search</code> (list of strings, optional)</p>
</li>
<li>
<p><code>options</code> (list of strings, optional)</p>
</li>
</ul>
</li>
</ul>
<h2 id="2-3-配置文件示例">2.3. 配置文件示例</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a40000">$</span> <span style="color:#a40000">mkdir</span> <span style="color:#a40000">-p</span> <span style="color:#a40000">/etc/cni/net.d</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">$</span> <span style="color:#a40000">cat</span> <span style="color:#a40000">&gt;/etc/cni/net.d/</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#a40000">-mynet.conf</span> <span style="color:#a40000">&lt;&lt;EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;cniVersion&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1.0.0&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;dbnet&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;plugins&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bridge&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// plugin specific parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">&#34;bridge&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cni0&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;keyA&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;some more&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;plugin specific&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;configuration&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;ipam&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;host-local&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// ipam specific
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">&#34;subnet&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;10.1.0.0/16&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;gateway&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;10.1.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;routes&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;dst&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;0.0.0.0/0&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;dns&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;nameservers&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;10.1.0.1&#34;</span> <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tuning&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;capabilities&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;mac&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;sysctl&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;net.core.somaxconn&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;500&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;portmap&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;capabilities&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;portMappings&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-cni插件">3. CNI插件</h1>
<h2 id="3-1-安装插件">3.1. 安装插件</h2>
<p>安装CNI二进制插件，插件下载地：https://github.com/containernetworking/plugins/releases</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下载二进制</span>
</span></span><span style="display:flex;"><span>wget https://github.com/containernetworking/plugins/releases/download/v1.1.0/cni-plugins-linux-amd64-v1.1.0.tgz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 解压文件</span>
</span></span><span style="display:flex;"><span>tar -zvxf cni-plugins-linux-amd64-v1.1.0.tgz -C /opt/cni/bin/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看解压文件</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ll -h</span>
</span></span><span style="display:flex;"><span>总用量 63M
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.7M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 bandwidth
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 4.1M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 bridge
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 9.3M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 dhcp
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 4.2M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 firewall
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.7M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 host-device
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.1M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 host-local
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.8M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 ipvlan
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.2M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 loopback
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.8M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 macvlan
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.6M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 portmap
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 4.0M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 ptp
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.4M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 sbr
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 2.7M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 static
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.3M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 tuning
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.8M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 vlan
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#0000cf;font-weight:bold">1</span> root root 3.4M 2月  <span style="color:#0000cf;font-weight:bold">24</span> 01:01 vrf
</span></span></code></pre></div><h2 id="3-2-插件分类">3.2. 插件分类</h2>
<p>参考：https://www.cni.dev/plugins/current/</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>插件</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>main</td>
<td>bridge</td>
<td>Creates a bridge, adds the host and the container to it</td>
</tr>
<tr>
<td></td>
<td>ipvlan</td>
<td>Adds an ipvlan interface in the container</td>
</tr>
<tr>
<td></td>
<td><strong>macvlan</strong></td>
<td>Creates a new MAC address, forwards all traffic to that to the container</td>
</tr>
<tr>
<td></td>
<td>ptp</td>
<td>Creates a veth pair</td>
</tr>
<tr>
<td></td>
<td><a href="https://www.cni.dev/plugins/current/main/host-device/">host-device</a></td>
<td>Moves an already-existing device into a container</td>
</tr>
<tr>
<td></td>
<td>vlan</td>
<td>Creates a vlan interface off a master</td>
</tr>
<tr>
<td>IPAM</td>
<td>dhcp</td>
<td>Runs a daemon on the host to make DHCP requests on behalf of a container</td>
</tr>
<tr>
<td></td>
<td>host-local</td>
<td>Maintains a local database of allocated IPs</td>
</tr>
<tr>
<td></td>
<td>static</td>
<td>Allocates static IPv4/IPv6 addresses to containers</td>
</tr>
<tr>
<td>meta</td>
<td>tuning</td>
<td>Changes sysctl parameters of an existing interface</td>
</tr>
<tr>
<td></td>
<td>portmap</td>
<td>An iptables-based portmapping plugin. Maps ports from the host’s address space to the container</td>
</tr>
<tr>
<td></td>
<td><strong>bandwidth</strong></td>
<td>Allows bandwidth-limiting through use of traffic control tbf (ingress/egress)</td>
</tr>
<tr>
<td></td>
<td>sbr</td>
<td>A plugin that configures source based routing for an interface (from which it is chained)</td>
</tr>
<tr>
<td></td>
<td>firewall</td>
<td>A firewall plugin which uses iptables or firewalld to add rules to allow traffic to/from the container</td>
</tr>
</tbody>
</table>
<h1 id="4-cni插件接口">4. CNI插件接口</h1>
<p>具体可参考：https://github.com/containernetworking/cni/blob/master/SPEC.md#cni-operations</p>
<p>CNI定义的接口操作有：</p>
<ul>
<li><code>ADD</code>：添加容器网络，在容器启动时调用。</li>
<li><code>DEL</code>：删除容器网络，在容器删除时调用。</li>
<li><code>CHECK</code>：检查容器网络是否正常。</li>
<li><code>VERSION</code>：显示插件版本。</li>
</ul>
<p>这些操作通过<code>CNI_COMMAND</code>环境变量来传递给CNI插件二进制。</p>
<p>其中环境变量包括：</p>
<ul>
<li>
<p><code>CNI_COMMAND</code>：命令操作，包括 <code>ADD</code>, <code>DEL</code>, <code>CHECK</code>, or <code>VERSION</code>。</p>
</li>
<li>
<p><code>CNI_CONTAINERID</code>:容器的ID，有runtime分配，不为空。</p>
</li>
<li>
<p><code>CNI_NETNS</code>:容器的网络命名空间，命名空间路径，例如：/run/netns/[nsname]</p>
</li>
<li>
<p><code>CNI_IFNAME</code>:容器内的网卡名称。</p>
</li>
<li>
<p><code>CNI_ARGS</code>:其他参数。</p>
</li>
<li>
<p><code>CNI_PATH</code>:CNI插件二进制的路径。</p>
</li>
</ul>
<h2 id="4-1-add接口-添加容器网络">4.1. ADD接口：添加容器网络</h2>
<p>在容器的网络命名空间<code>CNI_NETNS</code>中创建<code>CNI_IFNAME</code>网卡设备，或者调整网卡配置。</p>
<p>必选参数：</p>
<ul>
<li><code>CNI_COMMAND</code></li>
<li><code>CNI_CONTAINERID</code></li>
<li><code>CNI_NETNS</code></li>
<li><code>CNI_IFNAME</code></li>
</ul>
<p>可选参数：</p>
<ul>
<li><code>CNI_ARGS</code></li>
<li><code>CNI_PATH</code></li>
</ul>
<h2 id="4-2-del接口-删除容器网络">4.2. DEL接口：删除容器网络</h2>
<p>删除容器网络命名空间<code>CNI_NETNS</code>中的容器网卡<code>CNI_IFNAME</code>，或者撤销ADD修改操作。</p>
<p>必选参数：</p>
<ul>
<li><code>CNI_COMMAND</code></li>
<li><code>CNI_CONTAINERID</code></li>
<li><code>CNI_IFNAME</code></li>
</ul>
<p>可选参数：</p>
<ul>
<li><code>CNI_NETNS</code></li>
<li><code>CNI_ARGS</code></li>
<li><code>CNI_PATH</code></li>
</ul>
<h2 id="4-3-check接口-检查容器网络">4.3. CHECK接口：检查容器网络</h2>
<h2 id="4-4-version接口-输出cni的版本">4.4. VERSION接口：输出CNI的版本</h2>
<p>参考：</p>
<ul>
<li><a href="https://www.cni.dev/docs/spec/">https://www.cni.dev/docs/spec/</a></li>
<li><a href="https://github.com/containernetworking/cni">https://github.com/containernetworking/cni</a></li>
<li><a href="https://github.com/containernetworking/cni/blob/spec-v0.4.0/SPEC.md">https://github.com/containernetworking/cni/blob/spec-v0.4.0/SPEC.md</a></li>
<li><a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/">https://kubernetes.io/zh/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/</a></li>
<li><a href="https://github.com/containernetworking/plugins/tree/master/plugins">https://github.com/containernetworking/plugins/tree/master/plugins</a></li>
<li><a href="https://www.cni.dev/plugins/current/">https://www.cni.dev/plugins/current/</a></li>
<li><a href="https://cloud.tencent.com/developer/news/600713">https://cloud.tencent.com/developer/news/600713</a></li>
<li><a href="https://morningspace.github.io/tech/k8s-net-cni/#%E9%85%8D%E7%BD%AEcni%E6%8F%92%E4%BB%B6">配置CNI插件</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-480ce0e572d2437e06aed1bd69e4be63">3.2 - Macvlan介绍</h1>
    
	<h1 id="1-简介">1. 简介</h1>
<p>macvlan可以看做是物理接口eth（父接口）的子接口，每个macvlan都拥有独立的mac地址，可以被绑定IP作为正常的网卡接口使用。通过这个特性，可以实现在一个物理网络设备绑定多个IP，每个IP拥有独立的mac地址。该特性经常被应用在容器虚拟化中（容器可以配置macvlan的网络，将macvlan interface移动到容器的namespace中）。</p>
<p>示意图：</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan.jpg">
<h1 id="2-四种工作模式">2. 四种工作模式</h1>
<h2 id="2-1-vepa-virtual-ethernet-port-aggregator">2.1. VEPA (Virtual Ethernet Port Aggregator)</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan_vepa.jpg">
<p>VEPA为默认的工作模式，该模式下，所有macvlan发出的流量都会经过父接口，不管目的地是否与该macvlan共用一个父接口。</p>
<h2 id="2-2-bridge-mode">2.2. Bridge mode</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan_bridge.jpg">
<p>该bridge模式类似于传统的网桥模式，拥有相同父接口的macvlan可以直接进行通信，不需要将数据发给父接口转发。该模式下不需要交换机支持hairpin模式，性能比VEPA模式好。另外相对于传统的网桥模式，该模式不需要学习mac地址，不需要STP，使得其性能比传统的网桥性能好得多。但是如果父接口down掉，则所有子接口也会down，同时无法通信。</p>
<h2 id="2-3-private-mode">2.3. Private mode</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan_private.jpg">
<p>该模式是VEPA模式的增强版，</p>
<h2 id="2-4-passthru-mode">2.4. Passthru mode</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1595764512/article/kubernetes/macvlan/macvlan_passthru.jpg">
<p>. </p>
<blockquote>
<p>待完善</p>
</blockquote>
<p>参考：</p>
<ul>
<li><a href="https://backreference.org/2014/03/20/some-notes-on-macvlanmacvtap/">https://backreference.org/2014/03/20/some-notes-on-macvlanmacvtap/</a></li>
<li><a href="https://github.com/containernetworking/plugins/tree/master/plugins/main/macvlan">https://github.com/containernetworking/plugins/tree/master/plugins/main/macvlan</a></li>
<li><a href="https://github.com/containernetworking/plugins/blob/master/plugins/main/macvlan/macvlan.go">https://github.com/containernetworking/plugins/blob/master/plugins/main/macvlan/macvlan.go</a></li>
<li><a href="http://wikibon.org/wiki/v/Edge_Virtual_Bridging">http://wikibon.org/wiki/v/Edge_Virtual_Bridging</a></li>
<li><a href="https://juejin.im/post/5ca183ad6fb9a05e5343a7e8">Linux 虚拟网卡技术：Macvlan</a></li>
<li><a href="http://hicu.be/bridge-vs-macvlan">http://hicu.be/bridge-vs-macvlan</a></li>
<li><a href="http://hicu.be/docker-networking-macvlan-bridge-mode-configuration">http://hicu.be/docker-networking-macvlan-bridge-mode-configuration</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-88a4539d1d63c4a8a931f76e2fb0b364">4 - 网络插件</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-2823d1f38cf03cb8645be41837a3231f">4.1 - Flannel介绍</h1>
    
	<h1 id="1-flannel是什么-what">1. flannel是什么（what）</h1>
<h2 id="1-1-概述">1.1. 概述</h2>
<p>Flannel是CoreOS团队针对Kubernetes设计的一个网络规划服务，简单来说，它的功能是让集群中的不同节点主机创建的Docker容器都具有全集群唯一的虚拟IP地址。
Flannel官网：https://github.com/coreos/flannel</p>
<h2 id="1-2-补充知识点">1.2. 补充知识点</h2>
<h2 id="1-覆盖网络-overlay-network"><strong>1、覆盖网络[overlay network]</strong></h2>
<p>运行在一个网上的网（应用层网络），并不依靠ip地址来传递消息，而是采用一种映射机制，把ip地址和identifiers做映射来资源定位。</p>
<h2 id="2-路由"><strong>2、路由</strong></h2>
<p>互联网是由路由器连接的网络组合而成，路由器按照路由表、路由协议等机制实现对数据包正确地转发，从而到达目标主机。路由器根据数据包中目标主机的IP地址和路由控制表比较得出下一个接收数据的路由器。</p>
<p><strong>1）静态路由：事先设置好路由器和主机中的路由表信息。</strong></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578569/article/flannel/static-route.png" alt="静态路由"></p>
<p><strong>2）动态路由：让路由协议在运行中自动修改并设置路由表信息。</strong></p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578568/article/flannel/dynamic-route.png" alt="动态路由"></p>
<h1 id="2-为什么使用flannel-why">2. 为什么使用flannel（why）</h1>
<p>在默认的Docker配置中，每个节点上的Docker服务会分别负责所在节点容器的IP分配。这样导致的一个问题是，不同节点上容器可能获得相同的内外IP地址。</p>
<p>Flannel的设计目的就是为集群中的所有节点重新规划IP地址的使用规则，从而使得不同节点上的容器能够获得“同属一个内网”且”不重复的”IP地址，并让属于不同节点上的容器能够直接通过内网IP通信。</p>
<h1 id="3-如何实现flannel-how">3. 如何实现flannel（how）</h1>
<p>Flannel实质上是一种“覆盖网络(overlay network)”，也就是将TCP数据包装在另一种网络包里面进行路由转发和通信，目前已经支持UDP、VxLAN、AWS VPC和GCE路由等数据转发方式，默认的节点间数据通信方式是UDP转发。</p>
<h2 id="3-1-flannel原理图">3.1. flannel原理图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578568/article/flannel/flannel.png" alt="flannel"></p>
<ol>
<li>数据从源容器中发出后，经由所在主机的docker0虚拟网卡转发到flannel0虚拟网卡，这是个P2P的虚拟网卡，flanneld服务监听在网卡的另外一端。</li>
<li>Flannel通过Etcd服务维护了一张节点间的路由表。</li>
<li>源主机的flanneld服务将原本的数据内容UDP封装后根据自己的路由表投递给目的节点的flanneld服务，数据到达以后被解包，然后直 接进入目的节点的flannel0虚拟网卡，然后被转发到目的主机的docker0虚拟网卡，最后就像本机容器通信一下的有docker0路由到达目标容 器。</li>
</ol>
<h2 id="3-2-实现说明">3.2. 实现说明</h2>
<h2 id="1-udp封装"><strong>1、UDP封装</strong></h2>
<p>原始数据是在起始节点的Flannel服务上进行UDP封装的，投递到目的节点后就被另一端的Flannel服务还原成了原始的数据包，两边的Docker服务都感觉不到这个过程的存在。 UDP的数据内容部分其实是另一个ICMP（也就是ping命令）的数据包。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578569/article/flannel/udp.png" alt="UDP封装"></p>
<h2 id="2-为docker分配不同的ip段"><strong>2、为docker分配不同的IP段</strong></h2>
<p>Flannel通过Etcd分配了每个节点可用的IP地址段后，偷偷的修改了Docker的启动参数。</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578568/article/flannel/docker-init-args.png" alt="docker启动参数"></p>
<p>注意其中的“--bip=172.17.18.1/24”这个参数，它限制了所在节点容器获得的IP范围。</p>
<p>这个IP范围是由Flannel自动分配的，由Flannel通过保存在Etcd服务中的记录确保它们不会重复。</p>
<h2 id="3-路由规则"><strong>3、路由规则</strong></h2>
<p>1）数据发送节点的路由表</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578568/article/flannel/DataSendRouteTable.png" alt="数据发送节点路由表"></p>
<p>2）数据接收节点的路由表</p>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578568/article/flannel/DataReceiveRouteTable.png" alt="数据接收节点路由表"></p>
<p>例如现在有一个数据包要从IP为172.17.18.2的容器发到IP为172.17.46.2的容器。根据数据发送节点的路由表，它只与 172.17.0.0/16匹配这条记录匹配，因此数据从docker0出来以后就被投递到了flannel0。同理在目标节点，由于投递的地址是一个容 器，因此目的地址一定会落在docker0对于的172.17.46.0/24这个记录上，自然的被投递到了docker0网卡。</p>
<h2 id="3-3-flannel的安装与配置">3.3. flannel的安装与配置</h2>
<h2 id="1-安装"><strong>1、安装</strong></h2>
<pre tabindex="0"><code>wget http://&lt;官网&gt;/flannel/flannel-0.2.0-10.el7.x86_64.rpm
yum localinstall -y flannel-0.2.0-10.el7.x86_64.rpm
</code></pre><h2 id="2-配置"><strong>2、配置</strong></h2>
<p>vi /etc/sysconfig/flanneld</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Flanneld configuration options</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># etcd url location. Point this to the server where etcd runs</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_ETCD</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;http://127.0.0.1:4001&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># etcd config key. This is the configuration key that flannel queries</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># For address range assignment</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_ETCD_KEY</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/xxx/flannel/product/network&#34;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Any additional options that you want to pass</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FLANNEL_OPTIONS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34; -iface=eth0&#34;</span>
</span></span></code></pre></div><h2 id="3-初始化flannel的etcd配置"><strong>3、初始化flannel的etcd配置</strong></h2>
<pre tabindex="0"><code>etcdctl set /xxx/flannel/network/config &#39;{
   &#34;Network&#34;: &#34;10.0.0.0/16&#34;,
   &#34;Backend&#34;: {
       &#34;Type&#34;: &#34;vxlan&#34;
   }
}&#39;
</code></pre>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e1622b1588cb7127df05e7691bb911bd">5 - k8s网关</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-181eada22ecde3bdfce4c31dff04e635">5.1 - 安装APISIX</h1>
    
	<blockquote>
<p>本文主要介绍通过k8s来部署apisix及apisix-ingress-controller，使用apisix作为k8s内Pod互相访问的网关。</p>
</blockquote>
<h2 id="1-环境准备">1.  环境准备</h2>
<h3 id="1-1-安装helm">1.1. 安装helm</h3>
<p>参考：<a href="https://helm.sh/zh/docs/intro/install/">Helm | 安装</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 <span style="color:#000;font-weight:bold">|</span> bash
</span></span></code></pre></div><p>helm添加仓库</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add apisix https://charts.apiseven.com
</span></span><span style="display:flex;"><span>helm repo update
</span></span></code></pre></div><h3 id="1-2-安装etcd">1.2. 安装ETCD</h3>
<p>可以提前准备好etcd环境，也可以使用apisix官方的helm命令安装，但是需要存在默认是storageclass来提供pv挂载。</p>
<h2 id="2-一键安装全部">2. 一键安装全部</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install apisix apisix/apisix --set gateway.type<span style="color:#ce5c00;font-weight:bold">=</span>NodePort --set ingress-controller.enabled<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --namespace<span style="color:#ce5c00;font-weight:bold">=</span>apisix --create-namespace
</span></span></code></pre></div><p>或通过以下方式分别安装各组件。</p>
<h2 id="3-安装apisix">3. 安装apisix</h2>
<p>参考：<a href="https://github.com/apache/apisix-helm-chart/blob/master/docs/en/latest/apisix.md">apisix-helm-chart/apisix.md at master · apache/apisix-helm-chart · GitHub</a></p>
<h3 id="3-1-安装">3.1. 安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install apisix apisix/apisix --namespace apisix --create-namespace  
</span></span></code></pre></div><p>卸载</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm uninstall apisix --namespace apisix
</span></span></code></pre></div><h3 id="3-2-修改配置">3.2. 修改配置</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl edit cm apisix-napisix
</span></span></code></pre></div><p>可选：</p>
<ul>
<li>
<p>修改apisix端口。</p>
</li>
<li>
<p>修改etcd地址。</p>
</li>
<li>
<p>修改admin key值。</p>
</li>
<li>
<p>修改日志路径。</p>
</li>
<li>
<p>使用etcd存储stream配置或者静态文件存储stream配置</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apisix:
</span></span><span style="display:flex;"><span>  node_listen: <span style="color:#0000cf;font-weight:bold">8000</span> <span style="color:#8f5902;font-style:italic"># APISIX listening port</span>
</span></span><span style="display:flex;"><span>  config_center: etcd     <span style="color:#8f5902;font-style:italic"># etcd: use etcd to store the config value</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#8f5902;font-style:italic"># yaml: fetch the config value from local yaml file `/your_path/conf/apisix.yaml`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>etcd:
</span></span><span style="display:flex;"><span>  host: <span style="color:#4e9a06">&#34;http://foo:2379&#34;</span> <span style="color:#8f5902;font-style:italic"># etcd address</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>admin_key
</span></span><span style="display:flex;"><span>  -
</span></span><span style="display:flex;"><span>    name: <span style="color:#4e9a06">&#34;admin&#34;</span>
</span></span><span style="display:flex;"><span>    key: newsupersecurekey  <span style="color:#8f5902;font-style:italic"># 请修改 key 的值</span>
</span></span><span style="display:flex;"><span>    role: admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nginx_config:
</span></span><span style="display:flex;"><span>  error_log: /var/log/apisix_error.log
</span></span><span style="display:flex;"><span>  http:
</span></span><span style="display:flex;"><span>    access_log: /var/log/apisix_access.log
</span></span><span style="display:flex;"><span>    access_log_format: <span style="color:#4e9a06">&#34;</span><span style="color:#000">$time_iso8601</span><span style="color:#4e9a06">|</span><span style="color:#000">$remote_addr</span><span style="color:#4e9a06"> - </span><span style="color:#000">$remote_user</span><span style="color:#4e9a06">|</span><span style="color:#000">$http_host</span><span style="color:#4e9a06">|\&#34;</span><span style="color:#000">$request</span><span style="color:#4e9a06">\&#34;|</span><span style="color:#000">$status</span><span style="color:#4e9a06">|</span><span style="color:#000">$body_bytes_sent</span><span style="color:#4e9a06">|</span><span style="color:#000">$request_time</span><span style="color:#4e9a06">|\&#34;</span><span style="color:#000">$http_referer</span><span style="color:#4e9a06">\&#34;|\&#34;</span><span style="color:#000">$http_user_agent</span><span style="color:#4e9a06">\&#34;|</span><span style="color:#000">$upstream_addr</span><span style="color:#4e9a06">|</span><span style="color:#000">$upstream_status</span><span style="color:#4e9a06">|</span><span style="color:#000">$upstream_response_time</span><span style="color:#4e9a06">|\&#34;</span><span style="color:#000">$upstream_scheme</span><span style="color:#4e9a06">://</span><span style="color:#000">$upstream_host$upstream_uri</span><span style="color:#4e9a06">\&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plugin_attr:
</span></span><span style="display:flex;"><span>  log-rotate:
</span></span><span style="display:flex;"><span>    interval: <span style="color:#0000cf;font-weight:bold">3600</span>    <span style="color:#8f5902;font-style:italic"># rotate interval (unit: second)</span>
</span></span><span style="display:flex;"><span>    max_kept: <span style="color:#0000cf;font-weight:bold">48</span>     <span style="color:#8f5902;font-style:italic"># max number of log files will be kept</span>
</span></span><span style="display:flex;"><span>    enable_compression: <span style="color:#204a87">false</span>
</span></span></code></pre></div><h2 id="4-安装apisix-ingress-controller">4. 安装apisix-ingress-controller</h2>
<p>参考：<a href="https://github.com/apache/apisix-helm-chart/blob/master/docs/en/latest/apisix-ingress-controller.md">apisix-helm-chart/apisix-ingress-controller.md at master · apache/apisix-helm-chart · GitHub</a></p>
<h3 id="4-1-安装">4.1. 安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm install apisix-ingress-controller apisix/apisix-ingress-controller --namespace apisix --create-namespace
</span></span></code></pre></div><p>卸载</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm uninstall apisix-ingress-controller --namespace apisix
</span></span></code></pre></div><h3 id="4-2-修改配置">4.2. 修改配置</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl edit cm apisix-configmap -napisix
</span></span></code></pre></div><p>配置</p>
<ul>
<li>
<p>apisix地址</p>
</li>
<li>
<p>apisix admin key</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>default_cluster_base_url: http://apisix-admin.apisix.svc.cluster.local:9180/apisix/admin
</span></span><span style="display:flex;"><span>default_cluster_admin_key: <span style="color:#4e9a06">&#34;edd1c9f034335f136f87ad84b625c8f1&#34;</span>
</span></span></code></pre></div><h2 id="5-安装dashboard">5. 安装dashboard</h2>
<h3 id="5-1-安装">5.1. 安装</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm repo add apisix https://charts.apiseven.com
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>helm install apisix-dashboard apisix/apisix-dashboard --namespace apisix --create-namespace 
</span></span></code></pre></div><p>卸载</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm uninstall apisix-dashboard --namespace apisix
</span></span></code></pre></div><h3 id="5-2-修改配置">5.2. 修改配置</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl edit cm apisix-dashboard -napisix
</span></span></code></pre></div><ul>
<li>
<p>端口</p>
</li>
<li>
<p>etcd地址</p>
</li>
<li>
<p>登录账号密码</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  conf.yaml: <span style="color:#000;font-weight:bold">|</span>-
</span></span><span style="display:flex;"><span>    conf:
</span></span><span style="display:flex;"><span>      listen:
</span></span><span style="display:flex;"><span>        host: 0.0.0.0
</span></span><span style="display:flex;"><span>        port: <span style="color:#0000cf;font-weight:bold">9000</span>
</span></span><span style="display:flex;"><span>      etcd:
</span></span><span style="display:flex;"><span>        prefix: <span style="color:#4e9a06">&#34;/apisix&#34;</span>
</span></span><span style="display:flex;"><span>        endpoints:
</span></span><span style="display:flex;"><span>          - 10.65.240.210:2379
</span></span><span style="display:flex;"><span>      log:
</span></span><span style="display:flex;"><span>        error_log:
</span></span><span style="display:flex;"><span>          level: warn
</span></span><span style="display:flex;"><span>          file_path: /dev/stderr
</span></span><span style="display:flex;"><span>        access_log:
</span></span><span style="display:flex;"><span>          file_path: /dev/stdout
</span></span><span style="display:flex;"><span>    authentication:
</span></span><span style="display:flex;"><span>      secert: secert
</span></span><span style="display:flex;"><span>      expire_time: <span style="color:#0000cf;font-weight:bold">3600</span>
</span></span><span style="display:flex;"><span>      users:
</span></span><span style="display:flex;"><span>        - username: admin
</span></span><span style="display:flex;"><span>          password: admin
</span></span></code></pre></div><h2 id="6-查看helm安装列表">6. 查看helm安装列表</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># helm list -n apisix</span>
</span></span><span style="display:flex;"><span>NAME                NAMESPACE    REVISION    UPDATED                                    STATUS      CHART                     APP VERSION
</span></span><span style="display:flex;"><span>apisix              apisix       <span style="color:#0000cf;font-weight:bold">1</span>           2022-08-23 16:19:47.678174579 +0800 +08    deployed    apisix-0.11.0             2.15.0
</span></span><span style="display:flex;"><span>apisix-dashboard    apisix       <span style="color:#0000cf;font-weight:bold">1</span>           2022-08-23 20:36:37.55042356 +0800 +08     deployed    apisix-dashboard-0.6.0    2.13.0
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/apache/apisix-helm-chart">https://github.com/apache/apisix-helm-chart</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/zh/docs/apisix/installation-guide/">https://apisix.apache.org/zh/docs/apisix/installation-guide/</a></p>
</li>
<li>
<p><a href="https://github.com/apache/apisix-ingress-controller/blob/master/install.md">https://github.com/apache/apisix-ingress-controller/blob/master/install.md</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-152c1f49b08d537c43d684c68bdb1e9b">5.2 - 创建路由</h1>
    
	<p>本文主要介绍三种方式来创建apisix的路由规则。需要提前创建好k8s service作为路由的后端标识来关联<code>endpoints</code>。</p>
<h2 id="0-创建k8s-service">0. 创建k8s service</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">APP}-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">NAMESPACE}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">k8s-app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{<span style="color:#000">APP}</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TCP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">targetPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">9376</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>路由规则主要包括：</p>
<ul>
<li>
<p>hosts：域名</p>
</li>
<li>
<p>paths：访问路径</p>
</li>
<li>
<p>backends:</p>
<ul>
<li>
<p>serviceName</p>
</li>
<li>
<p>servicePort</p>
</li>
</ul>
</li>
</ul>
<h2 id="1-使用apisixroute创建路由规则">1. 使用ApisixRoute创建路由规则</h2>
<p>使用<code>ApisixRoute</code>自定义CRD创建路由规则，具体参考：<a href="https://github.com/apache/apisix-ingress-controller/blob/master/samples/deploy/crd/v1/ApisixRoute.yaml">reference</a>。</p>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># httpbin-route.yaml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apisix.apache.org/v2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ApisixRoute</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">httpserver-route</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">http</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rule1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">match</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">local.httpbin.org</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">paths</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">/*</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">backends</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">       </span>- <span style="color:#204a87;font-weight:bold">serviceName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">httpbin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#204a87;font-weight:bold">servicePort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在k8s中创建ApisixRoute。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f httpbin-route.yaml
</span></span></code></pre></div><h2 id="2-使用ingress创建路由规则">2. 使用ingress创建路由规则</h2>
<p>使用k8s ingress来创建路由规则，示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># httpbin-ingress.yaml</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Note use apiVersion is networking.k8s.io/v1, so please make sure your</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># Kubernetes cluster version is v1.19.0 or higher.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">networking.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Ingress</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">httpserver-ingress</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># apisix-ingress-controller is only interested in Ingress</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># resources with the matched ingressClass name, in our case,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># it&#39;s apisix.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ingressClassName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apisix</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">local.httpbin.org</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">http</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">paths</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">backend</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">service</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">httpbin</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">pathType</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Prefix</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建k8s ingress。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f httpbin-ingress.yaml
</span></span></code></pre></div><h2 id="3-使用admin-api创建路由规则">3. 使用Admin API创建路由规则</h2>
<p>直接调用Admin API或者使用dashboard创建路由规则。</p>
<blockquote>
<p>TODO</p>
</blockquote>
<h2 id="4-验证路由规则">4. 验证路由规则</h2>
<p>基于上述的方式，apisix-ingress-controller会调用apisix admin的接口自动创建<code>routes</code>和<code>upstreams</code>两个信息存入etcd，通过业务域名访问apisix就可以访问到具体的pod。</p>
<p><strong>服务调用</strong></p>
<p>将业务域名解析到apisix的IP上（如果是物理机部署可以是VIP，或者k8s部署的clusterIP）。</p>
<p>访问业务域名：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -v http://local.httpbin.org
</span></span></code></pre></div><h2 id="5-查看etcd中的路由规则">5. 查看etcd中的路由规则</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl get /apisix --prefix
</span></span></code></pre></div><h3 id="5-1-routes">5.1. routes</h3>
<p>/apisix/routes/</p>
<p>通过ingress创建的routes</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;host&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;local.httpbin.org&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;create_time&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1661251916</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ing_default_httpserver-ingress_37a4f3ae&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;uris&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;\/&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;\/*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;upstream_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;5ce57b8e&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;labels&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;managed-by&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;apisix-ingress-controller&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;priority&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;desc&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Created by apisix-ingress-controller, DO NOT modify it manually&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;update_time&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1661397119</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;148730bb&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过ApisixRoute创建的routes</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;priority&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;create_time&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1661397584</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;default_httpserver-route_rule1&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;status&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;uris&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;\/*&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;upstream_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;5ce57b8e&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hosts&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;local.httpbin.org&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;labels&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;managed-by&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;apisix-ingress-controller&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;desc&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Created by apisix-ingress-controller, DO NOT modify it manually&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;update_time&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1661397584</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;add8e28c&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-2-upstreams">5.2. upstreams</h3>
<p>/apisix/upstreams/5ce57b8e</p>
<p>相同的backend，使用ingress或ApisixRoute创建后生成的<code>upstreams</code>相同。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;scheme&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;http&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;pass_host&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;pass&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;default_httpbin_80&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;nodes&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;host&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;10.244.3.167&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;priority&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;port&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">80</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&#34;weight&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;roundrobin&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;labels&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&#34;managed-by&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;apisix-ingress-controller&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hash_on&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;vars&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;create_time&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1661251916</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;5ce57b8e&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;update_time&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1661397584</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;desc&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Created by apisix-ingress-controller, DO NOT modify it manually&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://apisix.apache.org/zh/docs/ingress-controller/getting-started/">https://apisix.apache.org/zh/docs/ingress-controller/getting-started/</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/zh/docs/ingress-controller/tutorials/index/">https://apisix.apache.org/zh/docs/ingress-controller/tutorials/index/</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/zh/docs/ingress-controller/tutorials/proxy-the-httpbin-service/">https://apisix.apache.org/zh/docs/ingress-controller/tutorials/proxy-the-httpbin-service/</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/zh/docs/ingress-controller/tutorials/proxy-the-httpbin-service-with-ingress/">https://apisix.apache.org/zh/docs/ingress-controller/tutorials/proxy-the-httpbin-service-with-ingress/</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dcc4be6cc2df9826bdbfe0119d889b8f">5.3 - ingress-controller原理</h1>
    
	<h2 id="ingress-controller架构图">ingress-controller架构图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1661409689/article/kubernetes/network/apisix/scene.png" alt=""></p>
<h2 id="ingress-controller流程图">ingress-controller流程图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1661409688/article/kubernetes/network/apisix/flow.png" alt=""></p>
<h2 id="apisixroute同步逻辑">ApisixRoute同步逻辑</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1661409688/article/kubernetes/network/apisix/sync-logic-controller.png" alt=""></p>
<h2 id="数据结构转换">数据结构转换</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1661409896/article/kubernetes/network/apisix/struct-compare.png" alt=""></p>
<p>参考：</p>
<ul>
<li>
<p><a href="https://apisix.apache.org/zh/docs/ingress-controller/getting-started/">https://apisix.apache.org/zh/docs/ingress-controller/getting-started/</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/zh/docs/ingress-controller/design/">https://apisix.apache.org/zh/docs/ingress-controller/design/</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/k8s.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>





  </body>
</html>
