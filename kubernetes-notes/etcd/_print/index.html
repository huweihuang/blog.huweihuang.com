<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/kubernetes-notes/etcd/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/kubernetes-notes/etcd/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Etcd集群 | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="Etcd集群" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/kubernetes-notes/etcd/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="Etcd集群">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Etcd集群"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/kubernetes-notes/" ><span class="active">Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/k8s-source-code-analysis/" ><span>Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/linux-notes/" ><span>Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.b8fc3823ae0d1da0e663a0aff640a2c4.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/kubernetes-notes/etcd/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">Etcd集群</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-790c9f020791536f12a8f4f2e60bb914">Etcd介绍</a></li>


    
  
    
    
	
<li>2: <a href="#pg-2153ad1a70a2192ad6ff5dcb8c29bd49">部署Etcd集群</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-31e195c42dfd9340fbf23dfba270e363">使用etcdadm部署Etcd集群</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-8bd6848988eb003ae620bdb956eab247">Raft算法</a></li>


    
  
    
    
	
<li>4: <a href="#pg-f59fc1654fa973038724952697876837">etcdctl命令工具</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-1b0fb3194b02b6bcfc867e444706d68a">etcdctl-V3</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-5ffa00ab05d9d30dfcd302587e50d29c">etcdctl-V2</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-d37dcd0642e22e58b477424b99aae67a">Etcd访问控制</a></li>


    
  
    
    
	
<li>6: <a href="#pg-b579ae1cd3d66837e46a7cfa1d995677">Etcd启动配置参数</a></li>


    
  
    
    
	
<li>7: <a href="#pg-f0607d0d7eaa382cf2171ad2fb4c6485">Etcd中的k8s数据</a></li>


    
  
    
    
	
<li>8: <a href="#pg-71893bf7906a4195ee237a3f2ab53af1">etcd-operator的使用</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-790c9f020791536f12a8f4f2e60bb914">1 - Etcd介绍</h1>
    
	<h1 id="1-etcd是什么-what">1. Etcd是什么（what）</h1>
<p>etcd is a distributed, consistent key-value store for shared configuration and service discovery, with a focus on being:</p>
<ul>
<li>Secure: automatic TLS with optional client cert authentication[可选的SSL客户端证书认证：支持https访问 ]</li>
<li>Fast: benchmarked 10,000 writes/sec[单实例每秒 1000 次写操作]</li>
<li>Reliable: properly distributed using Raft[使用Raft保证一致性]</li>
</ul>
<p>etcd是一个分布式、一致性的键值存储系统，主要用于配置共享和服务发现。[以上内容来自etcd官网]</p>
<h1 id="2-为什么使用etcd-why">2. 为什么使用Etcd（why）</h1>
<h2 id="2-1-etcd的优势">2.1. Etcd的优势</h2>
<ol>
<li>简单。使用Go语言编写部署简单；使用HTTP作为接口使用简单；使用Raft算法保证强一致性让用户易于理解。</li>
<li>数据持久化。etcd默认数据一更新就进行持久化。</li>
<li>安全。etcd支持SSL客户端安全认证。</li>
</ol>
<h1 id="3-如何实现etcd架构-how">3. 如何实现Etcd架构（how）</h1>
<h2 id="3-1-etcd的相关名词解释">3.1. Etcd的相关名词解释</h2>
<ul>
<li>Raft：etcd所采用的保证分布式系统强一致性的算法。</li>
<li>Node：一个Raft状态机实例。</li>
<li>Member： 一个etcd实例。它管理着一个Node，并且可以为客户端请求提供服务。</li>
<li>Cluster：由多个Member构成可以协同工作的etcd集群。</li>
<li>Peer：对同一个etcd集群中另外一个Member的称呼。</li>
<li>Client： 向etcd集群发送HTTP请求的客户端。</li>
<li>WAL：预写式日志，etcd用于持久化存储的日志格式。</li>
<li>snapshot：etcd防止WAL文件过多而设置的快照，存储etcd数据状态。</li>
<li>Proxy：etcd的一种模式，为etcd集群提供反向代理服务。</li>
<li>Leader：Raft算法中通过竞选而产生的处理所有数据提交的节点。</li>
<li>Follower：竞选失败的节点作为Raft中的从属节点，为算法提供强一致性保证。</li>
<li>Candidate：当Follower超过一定时间接收不到Leader的心跳时转变为Candidate开始竞选。【候选人】</li>
<li>Term：某个节点成为Leader到下一次竞选时间，称为一个Term。【任期】</li>
<li>Index：数据项编号。Raft中通过Term和Index来定位数据。</li>
</ul>
<h2 id="3-2-etcd的架构图">3.2. Etcd的架构图</h2>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578532/article/etcd/etcd-architecture.jpg" alt="etcd的架构图"></p>
<p>一个用户的请求发送过来，会经由HTTP Server转发给Store进行具体的事务处理，如果涉及到节点的修改，则交给Raft模块进行状态的变更、日志的记录，然后再同步给别的etcd节点以确认数据提交，最后进行数据的提交，再次同步。</p>
<h2 id="1-http-server">1、HTTP Server:</h2>
<p>用于处理用户发送的API请求以及其它etcd节点的同步与心跳信息请求。</p>
<h2 id="2-raft">2、Raft:</h2>
<p>Raft强一致性算法的具体实现，是etcd的核心。</p>
<h2 id="3-wal">3、WAL:</h2>
<p>Write Ahead Log（预写式日志），是etcd的数据存储方式，用于系统提供原子性和持久性的一系列技术。除了在内存中存有所有数据的状态以及节点的索引以外，etcd就通过WAL进行持久化存储。WAL中，所有的数据提交前都会事先记录日志。</p>
<ol>
<li>
<p>Entry[日志内容]:</p>
<p>负责存储具体日志的内容。</p>
</li>
<li>
<p>Snapshot[快照内容]:</p>
<p>Snapshot是为了防止数据过多而进行的状态快照，日志内容发生变化时保存Raft的状态。</p>
</li>
</ol>
<h2 id="4-store">4、Store:</h2>
<p>用于处理etcd支持的各类功能的事务，包括数据索引、节点状态变更、监控与反馈、事件处理与执行等等，是etcd对用户提供的大多数API功能的具体实现。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2153ad1a70a2192ad6ff5dcb8c29bd49">2 - 部署Etcd集群</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-31e195c42dfd9340fbf23dfba270e363">2.1 - 使用etcdadm部署Etcd集群</h1>
    
	<h2 id="1-安装etcdadm">1. 安装etcdadm</h2>
<p>在<a href="https://github.com/kubernetes-sigs/etcdadm/releases">Releases · kubernetes-sigs/etcdadm · GitHub</a>中选择需要部署的版本，示例如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/kubernetes-sigs/etcdadm/releases/download/v0.1.5/etcdadm-linux-amd64
</span></span><span style="display:flex;"><span>mv etcdadm-linux-amd64 /usr/bin/etcdadm
</span></span><span style="display:flex;"><span>chmod +x /usr/bin/etcdadm
</span></span></code></pre></div><h2 id="2-部署etcd集群">2. 部署etcd集群</h2>
<h3 id="2-1-init">2.1. init</h3>
<p>etcd的版本可以在 <a href="https://github.com/etcd-io/etcd/releases">Releases · etcd-io/etcd · GitHub</a> 中查询。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdadm init --name &lt;node1&gt; --version<span style="color:#ce5c00;font-weight:bold">=</span>3.5.4
</span></span></code></pre></div><h3 id="2-2-上传证书到其他机器">2.2. 上传证书到其他机器</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 登录node2 node3</span>
</span></span><span style="display:flex;"><span>mkdir -p /etc/etcd/pki
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将node1的/etc/etcd/pki/ca.* 拷贝到node2 node3 /etc/etcd/pki/</span>
</span></span><span style="display:flex;"><span>scp /etc/etcd/pki/ca.* node2:/etc/etcd/pki/
</span></span></code></pre></div><h3 id="2-3-join">2.3. join</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdadm join https://&lt;node1&gt;:2379 --name<span style="color:#ce5c00;font-weight:bold">=</span>&lt;node2&gt; --version<span style="color:#ce5c00;font-weight:bold">=</span>3.5.4
</span></span><span style="display:flex;"><span>etcdadm join https://&lt;node1&gt;:2379 --name<span style="color:#ce5c00;font-weight:bold">=</span>&lt;node3&gt; --version<span style="color:#ce5c00;font-weight:bold">=</span>3.5.4
</span></span></code></pre></div><h2 id="3-查看集群状态">3. 查看集群状态</h2>
<p>设置etcdctl环境变量</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加endpoint</span>
</span></span><span style="display:flex;"><span>cat &gt;&gt; /etc/etcd/etcdctl.env <span style="color:#4e9a06">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">export ETCDCTL_ENDPOINTS=node1:2379,node2:2379,node2:2379
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 拷贝命令脚本到/usr/bin/</span>
</span></span><span style="display:flex;"><span>cp /opt/bin/etcdctl /opt/bin/etcdctl.sh /usr/bin/
</span></span></code></pre></div><p>查看集群状态</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ etcdctl.sh endpoint status -w table
</span></span><span style="display:flex;"><span>+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>      ENDPOINT      <span style="color:#000;font-weight:bold">|</span>        ID        <span style="color:#000;font-weight:bold">|</span> VERSION <span style="color:#000;font-weight:bold">|</span> DB SIZE <span style="color:#000;font-weight:bold">|</span> IS LEADER <span style="color:#000;font-weight:bold">|</span> IS LEARNER <span style="color:#000;font-weight:bold">|</span> RAFT TERM <span style="color:#000;font-weight:bold">|</span> RAFT INDEX <span style="color:#000;font-weight:bold">|</span> RAFT APPLIED INDEX <span style="color:#000;font-weight:bold">|</span> ERRORS <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> node1:2379 <span style="color:#000;font-weight:bold">|</span> 5fe84cb4a0ef4e69 <span style="color:#000;font-weight:bold">|</span>   3.5.4 <span style="color:#000;font-weight:bold">|</span>   <span style="color:#0000cf;font-weight:bold">20</span> kB <span style="color:#000;font-weight:bold">|</span>      <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#204a87">false</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000;font-weight:bold">|</span>                 <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000;font-weight:bold">|</span>        <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> node2:2379 <span style="color:#000;font-weight:bold">|</span> cb8d48da0ea9b8c0 <span style="color:#000;font-weight:bold">|</span>   3.5.4 <span style="color:#000;font-weight:bold">|</span>   <span style="color:#0000cf;font-weight:bold">20</span> kB <span style="color:#000;font-weight:bold">|</span>     <span style="color:#204a87">false</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#204a87">false</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000;font-weight:bold">|</span>                 <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000;font-weight:bold">|</span>        <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> node3:2379 <span style="color:#000;font-weight:bold">|</span> fafa80c55eebeffa <span style="color:#000;font-weight:bold">|</span>   3.5.4 <span style="color:#000;font-weight:bold">|</span>   <span style="color:#0000cf;font-weight:bold">20</span> kB <span style="color:#000;font-weight:bold">|</span>     <span style="color:#204a87">false</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#204a87">false</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000;font-weight:bold">|</span>                 <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#000;font-weight:bold">|</span>        <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+--------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span></code></pre></div><h2 id="4-etcd启动配置文件">4. Etcd启动配置文件</h2>
<p>systemd service</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># cat /etc/systemd/system/etcd.service</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Unit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Description</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd
</span></span><span style="display:flex;"><span><span style="color:#000">Documentation</span><span style="color:#ce5c00;font-weight:bold">=</span>https://github.com/coreos/etcd
</span></span><span style="display:flex;"><span><span style="color:#000">Conflicts</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-member.service
</span></span><span style="display:flex;"><span><span style="color:#000">Conflicts</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd2.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Service<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">EnvironmentFile</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/etcd.env
</span></span><span style="display:flex;"><span><span style="color:#000">ExecStart</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/bin/etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">=</span>notify
</span></span><span style="display:flex;"><span><span style="color:#000">TimeoutStartSec</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Restart</span><span style="color:#ce5c00;font-weight:bold">=</span>on-failure
</span></span><span style="display:flex;"><span><span style="color:#000">RestartSec</span><span style="color:#ce5c00;font-weight:bold">=</span>5s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">LimitNOFILE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">65536</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Nice</span><span style="color:#ce5c00;font-weight:bold">=</span>-10
</span></span><span style="display:flex;"><span><span style="color:#000">IOSchedulingClass</span><span style="color:#ce5c00;font-weight:bold">=</span>best-effort
</span></span><span style="display:flex;"><span><span style="color:#000">IOSchedulingPriority</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#000">MemoryLow</span><span style="color:#ce5c00;font-weight:bold">=</span>200M
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Install<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">WantedBy</span><span style="color:#ce5c00;font-weight:bold">=</span>multi-user.target
</span></span></code></pre></div><p>/etc/etcd/etcd.env</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">ETCD_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd01
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Initial cluster configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_CLUSTER</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">etcd01</span><span style="color:#ce5c00;font-weight:bold">=</span>https://node1:2380
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_CLUSTER_TOKEN</span><span style="color:#ce5c00;font-weight:bold">=</span>88ad6def
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_CLUSTER_STATE</span><span style="color:#ce5c00;font-weight:bold">=</span>new
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Peer configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span style="color:#ce5c00;font-weight:bold">=</span>https://node1:2380
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_LISTEN_PEER_URLS</span><span style="color:#ce5c00;font-weight:bold">=</span>https://node1:2380
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_CLIENT_CERT_AUTH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_PEER_CERT_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/pki/peer.crt
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_PEER_KEY_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/pki/peer.key
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_PEER_TRUSTED_CA_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/pki/ca.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Client/server configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_ADVERTISE_CLIENT_URLS</span><span style="color:#ce5c00;font-weight:bold">=</span>https://node1:2379
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_LISTEN_CLIENT_URLS</span><span style="color:#ce5c00;font-weight:bold">=</span>https://node1:2379,https://127.0.0.1:2379
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_PEER_CLIENT_CERT_AUTH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_CERT_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/pki/server.crt
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_KEY_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/pki/server.key
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_TRUSTED_CA_FILE</span><span style="color:#ce5c00;font-weight:bold">=</span>/etc/etcd/pki/ca.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Other</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_DATA_DIR</span><span style="color:#ce5c00;font-weight:bold">=</span>/var/lib/etcd
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_STRICT_RECONFIG_CHECK</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000">GOMAXPROCS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">48</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes-sigs/etcdadm">GitHub - kubernetes-sigs/etcdadm</a></p>
</li>
<li>
<p><a href="https://etcd.io/docs/v3.5/op-guide/clustering/">Clustering Guide | etcd</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8bd6848988eb003ae620bdb956eab247">3 - Raft算法</h1>
    
	<h1 id="1-raft协议-分布式一致性算法">1. Raft协议[分布式一致性算法]</h1>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1510578532/article/etcd/raft.png" alt="raft"></p>
<p>raft算法中涉及三种角色，分别是：</p>
<ul>
<li><code>follower</code>: 跟随者</li>
<li><code>candidate</code>: 候选者，选举过程中的中间状态角色</li>
<li><code>leader</code>: 领导者</li>
</ul>
<h1 id="2-过程">2. 过程</h1>
<h2 id="2-1-选举">2.1. 选举</h2>
<p>有两个timeout来控制选举，第一个是<code>election timeout</code>，该时间是节点从follower到成为candidate的时间，该时间是150到300毫秒之间的随机值。另一个是<code>heartbeat timeout</code>。</p>
<ul>
<li>当某个节点经历完<code>election timeout</code>成为candidate后，开启新的一个选举周期，他向其他节点发起投票请求（Request Vote），如果接收到消息的节点在该周期内还没投过票则给这个candidate投票，然后节点重置他的election timeout。</li>
<li>当该candidate获得大部分的选票，则可以当选为leader。</li>
<li>leader就开始发送<code>append entries</code>给其他follower节点，这个消息会在内部指定的<code>heartbeat timeout</code>时间内发出，follower收到该信息则响应给leader。</li>
<li>这个选举周期会继续，直到某个follower没有收到心跳，并成为candidate。</li>
<li>如果某个选举周期内，有两个candidate同时获得相同多的选票，则会等待一个新的周期重新选举。</li>
</ul>
<h2 id="2-2-同步">2.2. 同步</h2>
<p>当选举过程结束，选出了leader，则leader需要把所有的变更同步的系统中的其他节点，该同步也是通过发送<code>Append Entries</code>的消息的方式。</p>
<ul>
<li>首先一个客户端发送一个更新给leader，这个更新会添加到leader的日志中。</li>
<li>然后leader会在给follower的下次心跳探测中发送该更新。</li>
<li>一旦大多数follower收到这个更新并返回给leader，leader提交这个更新，然后返回给客户端。</li>
</ul>
<h2 id="2-3-网络分区">2.3. 网络分区</h2>
<ul>
<li>当发生网络分区的时候，在不同分区的节点接收不到leader的心跳，则会开启一轮选举，形成不同leader的多个分区集群。</li>
<li>当客户端给不同leader的发送更新消息时，不同分区集群中的节点个数小于原先集群的一半时，更新不会被提交，而节点个数大于集群数一半时，更新会被提交。</li>
<li>当网络分区恢复后，被提交的更新会同步到其他的节点上，其他节点未提交的日志会被回滚并匹配新leader的日志，保证全局的数据是一致的。</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="http://thesecretlivesofdata.com/raft/">http://thesecretlivesofdata.com/raft/</a></li>
<li><a href="https://raft.github.io/raft.pdf">https://raft.github.io/raft.pdf</a></li>
<li><a href="https://raft.github.io/">https://raft.github.io/</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f59fc1654fa973038724952697876837">4 - etcdctl命令工具</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1b0fb3194b02b6bcfc867e444706d68a">4.1 - etcdctl-V3</h1>
    
	<blockquote>
<p><code>etcdctl</code>的<code>v3</code>版本与<code>v2</code>版本使用命令有所不同，本文介绍<code>etcdctl v3</code>版本的命令工具的使用方式。</p>
</blockquote>
<h1 id="1-etcdctl的安装">1. etcdctl的安装</h1>
<p><code>etcdctl</code>的二进制文件可以在 <a href="https://github.com/coreos/etcd/releases">github.com/coreos/etcd/releases</a> 选择对应的版本下载，例如可以执行以下<code>install_etcdctl.sh</code>的脚本，修改其中的版本信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ETCD_VER</span><span style="color:#ce5c00;font-weight:bold">=</span>v3.3.4
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_DIR</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-download
</span></span><span style="display:flex;"><span><span style="color:#000">DOWNLOAD_URL</span><span style="color:#ce5c00;font-weight:bold">=</span>https://github.com/coreos/etcd/releases/download
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Download</span>
</span></span><span style="display:flex;"><span>mkdir <span style="color:#4e9a06">${</span><span style="color:#000">ETCD_DIR</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> <span style="color:#4e9a06">${</span><span style="color:#000">ETCD_DIR</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>wget <span style="color:#4e9a06">${</span><span style="color:#000">DOWNLOAD_URL</span><span style="color:#4e9a06">}</span>/<span style="color:#4e9a06">${</span><span style="color:#000">ETCD_VER</span><span style="color:#4e9a06">}</span>/etcd-<span style="color:#4e9a06">${</span><span style="color:#000">ETCD_VER</span><span style="color:#4e9a06">}</span>-linux-amd64.tar.gz 
</span></span><span style="display:flex;"><span>tar -xzvf etcd-<span style="color:#4e9a06">${</span><span style="color:#000">ETCD_VER</span><span style="color:#4e9a06">}</span>-linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># install</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> etcd-<span style="color:#4e9a06">${</span><span style="color:#000">ETCD_VER</span><span style="color:#4e9a06">}</span>-linux-amd64
</span></span><span style="display:flex;"><span>cp etcdctl /usr/local/bin/
</span></span></code></pre></div><h1 id="2-etcdctl-v3">2. etcdctl V3</h1>
<p>使用<code>etcdctl</code>v3的版本时，需设置环境变量<code>ETCDCTL_API=3</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或者在`/etc/profile`文件中添加环境变量</span>
</span></span><span style="display:flex;"><span>vi /etc/profile
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#204a87">source</span> /etc/profile
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 或者在命令执行前加 ETCDCTL_API=3</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> member list
</span></span></code></pre></div><p>查看当前etcdctl的版本信息<code>etcdctl version</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@k8s-dbg-master-1 etcd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># etcdctl version</span>
</span></span><span style="display:flex;"><span>etcdctl version: 3.3.4
</span></span><span style="display:flex;"><span>API version: 3.3
</span></span></code></pre></div><p>更多命令帮助可以查询<code>etcdctl —help</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@k8s-dbg-master-1 etcd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># etcdctl --help</span>
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>	etcdctl - A simple <span style="color:#204a87">command</span> line client <span style="color:#204a87;font-weight:bold">for</span> etcd3.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>	etcdctl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERSION:
</span></span><span style="display:flex;"><span>	3.3.4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>API VERSION:
</span></span><span style="display:flex;"><span>	3.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>	get			Gets the key or a range of keys
</span></span><span style="display:flex;"><span>	put			Puts the given key into the store
</span></span><span style="display:flex;"><span>	del			Removes the specified key or range of keys <span style="color:#ce5c00;font-weight:bold">[</span>key, range_end<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	txn			Txn processes all the requests in one transaction
</span></span><span style="display:flex;"><span>	compaction		Compacts the event <span style="color:#204a87">history</span> in etcd
</span></span><span style="display:flex;"><span>	alarm disarm		Disarms all alarms
</span></span><span style="display:flex;"><span>	alarm list		Lists all alarms
</span></span><span style="display:flex;"><span>	defrag			Defragments the storage of the etcd members with given endpoints
</span></span><span style="display:flex;"><span>	endpoint health		Checks the healthiness of endpoints specified in <span style="color:#4e9a06">`</span>--endpoints<span style="color:#4e9a06">`</span> flag
</span></span><span style="display:flex;"><span>	endpoint status		Prints out the status of endpoints specified in <span style="color:#4e9a06">`</span>--endpoints<span style="color:#4e9a06">`</span> flag
</span></span><span style="display:flex;"><span>	endpoint hashkv		Prints the KV <span style="color:#204a87">history</span> <span style="color:#204a87">hash</span> <span style="color:#204a87;font-weight:bold">for</span> each endpoint in --endpoints
</span></span><span style="display:flex;"><span>	move-leader		Transfers leadership to another etcd cluster member.
</span></span><span style="display:flex;"><span>	watch			Watches events stream on keys or prefixes
</span></span><span style="display:flex;"><span>	version			Prints the version of etcdctl
</span></span><span style="display:flex;"><span>	lease grant		Creates leases
</span></span><span style="display:flex;"><span>	lease revoke		Revokes leases
</span></span><span style="display:flex;"><span>	lease timetolive	Get lease information
</span></span><span style="display:flex;"><span>	lease list		List all active leases
</span></span><span style="display:flex;"><span>	lease keep-alive	Keeps leases alive <span style="color:#ce5c00;font-weight:bold">(</span>renew<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	member add		Adds a member into the cluster
</span></span><span style="display:flex;"><span>	member remove		Removes a member from the cluster
</span></span><span style="display:flex;"><span>	member update		Updates a member in the cluster
</span></span><span style="display:flex;"><span>	member list		Lists all members in the cluster
</span></span><span style="display:flex;"><span>	snapshot save		Stores an etcd node backend snapshot to a given file
</span></span><span style="display:flex;"><span>	snapshot restore	Restores an etcd member snapshot to an etcd directory
</span></span><span style="display:flex;"><span>	snapshot status		Gets backend snapshot status of a given file
</span></span><span style="display:flex;"><span>	make-mirror		Makes a mirror at the destination etcd cluster
</span></span><span style="display:flex;"><span>	migrate			Migrates keys in a v2 store to a mvcc store
</span></span><span style="display:flex;"><span>	lock			Acquires a named lock
</span></span><span style="display:flex;"><span>	elect			Observes and participates in leader election
</span></span><span style="display:flex;"><span>	auth <span style="color:#204a87">enable</span>		Enables authentication
</span></span><span style="display:flex;"><span>	auth disable		Disables authentication
</span></span><span style="display:flex;"><span>	user add		Adds a new user
</span></span><span style="display:flex;"><span>	user delete		Deletes a user
</span></span><span style="display:flex;"><span>	user get		Gets detailed information of a user
</span></span><span style="display:flex;"><span>	user list		Lists all users
</span></span><span style="display:flex;"><span>	user passwd		Changes password of user
</span></span><span style="display:flex;"><span>	user grant-role		Grants a role to a user
</span></span><span style="display:flex;"><span>	user revoke-role	Revokes a role from a user
</span></span><span style="display:flex;"><span>	role add		Adds a new role
</span></span><span style="display:flex;"><span>	role delete		Deletes a role
</span></span><span style="display:flex;"><span>	role get		Gets detailed information of a role
</span></span><span style="display:flex;"><span>	role list		Lists all roles
</span></span><span style="display:flex;"><span>	role grant-permission	Grants a key to a role
</span></span><span style="display:flex;"><span>	role revoke-permission	Revokes a key from a role
</span></span><span style="display:flex;"><span>	check perf		Check the performance of the etcd cluster
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">help</span>			Help about any <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>      --cacert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>				verify certificates of TLS-enabled secure servers using this CA bundle
</span></span><span style="display:flex;"><span>      --cert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS certificate file
</span></span><span style="display:flex;"><span>      --command-timeout<span style="color:#ce5c00;font-weight:bold">=</span>5s			timeout <span style="color:#204a87;font-weight:bold">for</span> short running <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">(</span>excluding dial timeout<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --debug<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>				<span style="color:#204a87">enable</span> client-side debug logging
</span></span><span style="display:flex;"><span>      --dial-timeout<span style="color:#ce5c00;font-weight:bold">=</span>2s				dial timeout <span style="color:#204a87;font-weight:bold">for</span> client connections
</span></span><span style="display:flex;"><span>  -d, --discovery-srv<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>			domain name to query <span style="color:#204a87;font-weight:bold">for</span> SRV records describing cluster endpoints
</span></span><span style="display:flex;"><span>      --endpoints<span style="color:#ce5c00;font-weight:bold">=[</span>127.0.0.1:2379<span style="color:#ce5c00;font-weight:bold">]</span>		gRPC endpoints
</span></span><span style="display:flex;"><span>      --hex<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>				print byte strings as hex encoded strings
</span></span><span style="display:flex;"><span>      --insecure-discovery<span style="color:#ce5c00;font-weight:bold">[=</span>true<span style="color:#ce5c00;font-weight:bold">]</span>		accept insecure SRV records describing cluster endpoints
</span></span><span style="display:flex;"><span>      --insecure-skip-tls-verify<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>	skip server certificate verification
</span></span><span style="display:flex;"><span>      --insecure-transport<span style="color:#ce5c00;font-weight:bold">[=</span>true<span style="color:#ce5c00;font-weight:bold">]</span>		disable transport security <span style="color:#204a87;font-weight:bold">for</span> client connections
</span></span><span style="display:flex;"><span>      --keepalive-time<span style="color:#ce5c00;font-weight:bold">=</span>2s			keepalive <span style="color:#204a87">time</span> <span style="color:#204a87;font-weight:bold">for</span> client connections
</span></span><span style="display:flex;"><span>      --keepalive-timeout<span style="color:#ce5c00;font-weight:bold">=</span>6s			keepalive timeout <span style="color:#204a87;font-weight:bold">for</span> client connections
</span></span><span style="display:flex;"><span>      --key<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS key file
</span></span><span style="display:flex;"><span>      --user<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					username<span style="color:#ce5c00;font-weight:bold">[</span>:password<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">for</span> authentication <span style="color:#ce5c00;font-weight:bold">(</span>prompt <span style="color:#204a87;font-weight:bold">if</span> password is not supplied<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -w, --write-out<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;simple&#34;</span>			<span style="color:#204a87">set</span> the output format <span style="color:#ce5c00;font-weight:bold">(</span>fields, json, protobuf, simple, table<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="3-etcdctl-常用命令">3. etcdctl 常用命令</h1>
<h2 id="3-1-指定etcd集群">3.1. 指定etcd集群</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">HOST_1</span><span style="color:#ce5c00;font-weight:bold">=</span>10.240.0.17
</span></span><span style="display:flex;"><span><span style="color:#000">HOST_2</span><span style="color:#ce5c00;font-weight:bold">=</span>10.240.0.18
</span></span><span style="display:flex;"><span><span style="color:#000">HOST_3</span><span style="color:#ce5c00;font-weight:bold">=</span>10.240.0.19
</span></span><span style="display:flex;"><span><span style="color:#000">ENDPOINTS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$HOST_1</span>:2379,<span style="color:#000">$HOST_2</span>:2379,<span style="color:#000">$HOST_3</span>:2379
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> member list
</span></span></code></pre></div><p>如果etcd设置了证书访问，则需要添加证书相关参数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> --cacert<span style="color:#ce5c00;font-weight:bold">=</span>&lt;ca-file&gt; --cert<span style="color:#ce5c00;font-weight:bold">=</span>&lt;cert-file&gt; --key<span style="color:#ce5c00;font-weight:bold">=</span>&lt;key-file&gt;  &lt;command&gt;
</span></span></code></pre></div><p>参数说明如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  --cacert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>				verify certificates of TLS-enabled secure servers using this CA bundle
</span></span><span style="display:flex;"><span>  --cert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS certificate file
</span></span><span style="display:flex;"><span>  --key<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS key file
</span></span><span style="display:flex;"><span>  --endpoints<span style="color:#ce5c00;font-weight:bold">=[</span>127.0.0.1:2379<span style="color:#ce5c00;font-weight:bold">]</span>		gRPC endpoints
</span></span></code></pre></div><p>可以自定义alias命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># alias 命令，避免每次需要输入证书参数</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">ectl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;ETCDCTL_API=3 etcdctl --endpoints=$ENDPOINTS --cacert=&lt;ca-file&gt; --cert=&lt;cert-file&gt; --key=&lt;key-file&gt;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 直接使用别名执行命令</span>
</span></span><span style="display:flex;"><span>ectl &lt;command&gt;
</span></span></code></pre></div><h2 id="3-2-增删改查">3.2. 增删改查</h2>
<p><strong>1、增</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put foo <span style="color:#4e9a06">&#34;Hello World!&#34;</span>
</span></span></code></pre></div><p><strong>2、查</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> get foo
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> --write-out<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;json&#34;</span> get foo
</span></span></code></pre></div><p>基于相同前缀查找</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put web1 value1
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put web2 value2
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put web3 value3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> get web --prefix
</span></span></code></pre></div><p>列出所有的key</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> get / --prefix --keys-only
</span></span></code></pre></div><p>3、<strong>删</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put key myvalue
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> del key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put k1 value1
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> put k2 value2
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> del k --prefix
</span></span></code></pre></div><h2 id="3-3-集群状态">3.3. 集群状态</h2>
<p>集群状态主要是<code>etcdctl endpoint status</code> 和<code>etcdctl endpoint health</code>两条命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --write-out<span style="color:#ce5c00;font-weight:bold">=</span>table --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> endpoint status
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>+------------------+------------------+---------+---------+-----------+-----------+------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>     ENDPOINT     <span style="color:#000;font-weight:bold">|</span>        ID        <span style="color:#000;font-weight:bold">|</span> VERSION <span style="color:#000;font-weight:bold">|</span> DB SIZE <span style="color:#000;font-weight:bold">|</span> IS LEADER <span style="color:#000;font-weight:bold">|</span> RAFT TERM <span style="color:#000;font-weight:bold">|</span> RAFT INDEX <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+------------------+------------------+---------+---------+-----------+-----------+------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> 10.240.0.17:2379 <span style="color:#000;font-weight:bold">|</span> 4917a7ab173fabe7 <span style="color:#000;font-weight:bold">|</span> 3.0.0   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">45</span> kB   <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">true</span>      <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#0000cf;font-weight:bold">16726</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> 10.240.0.18:2379 <span style="color:#000;font-weight:bold">|</span> 59796ba9cd1bcd72 <span style="color:#000;font-weight:bold">|</span> 3.0.0   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">45</span> kB   <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">false</span>     <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#0000cf;font-weight:bold">16726</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> 10.240.0.19:2379 <span style="color:#000;font-weight:bold">|</span> 94df724b66343e6c <span style="color:#000;font-weight:bold">|</span> 3.0.0   <span style="color:#000;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">45</span> kB   <span style="color:#000;font-weight:bold">|</span> <span style="color:#204a87">false</span>     <span style="color:#000;font-weight:bold">|</span>         <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#000;font-weight:bold">|</span>      <span style="color:#0000cf;font-weight:bold">16726</span> <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+------------------+------------------+---------+---------+-----------+-----------+------------+
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">$ENDPOINTS</span> endpoint health
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>10.240.0.17:2379 is healthy: successfully committed proposal: <span style="color:#000">took</span> <span style="color:#ce5c00;font-weight:bold">=</span> 3.345431ms
</span></span><span style="display:flex;"><span>10.240.0.19:2379 is healthy: successfully committed proposal: <span style="color:#000">took</span> <span style="color:#ce5c00;font-weight:bold">=</span> 3.767967ms
</span></span><span style="display:flex;"><span>10.240.0.18:2379 is healthy: successfully committed proposal: <span style="color:#000">took</span> <span style="color:#ce5c00;font-weight:bold">=</span> 4.025451ms
</span></span></code></pre></div><h2 id="3-4-集群成员">3.4. 集群成员</h2>
<p>跟集群成员相关的命令如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>	member add		    Adds a member into the cluster
</span></span><span style="display:flex;"><span>	member remove		Removes a member from the cluster
</span></span><span style="display:flex;"><span>	member update		Updates a member in the cluster
</span></span><span style="display:flex;"><span>	member list		    Lists all members in the cluster
</span></span></code></pre></div><p>例如 <code>etcdctl member list</code>列出集群成员的命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span>http://172.16.5.4:12379 member list -w table
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>+-----------------+---------+-------+------------------------+-----------------------------------------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>       ID        <span style="color:#000;font-weight:bold">|</span> STATUS  <span style="color:#000;font-weight:bold">|</span> NAME  <span style="color:#000;font-weight:bold">|</span>       PEER ADDRS       <span style="color:#000;font-weight:bold">|</span>                 CLIENT ADDRS                  <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------------+---------+-------+------------------------+-----------------------------------------------+
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span> c856d92a82ba66a <span style="color:#000;font-weight:bold">|</span> started <span style="color:#000;font-weight:bold">|</span> etcd0 <span style="color:#000;font-weight:bold">|</span> http://172.16.5.4:2380 <span style="color:#000;font-weight:bold">|</span> http://172.16.5.4:2379,http://172.16.5.4:4001 <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>+-----------------+---------+-------+------------------------+-----------------------------------------------+
</span></span></code></pre></div><h1 id="4-etcdctl-get">4. etcdctl get</h1>
<p>使用<code>etcdctl {command} --help</code>可以查看具体命令的帮助信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># etcdctl get --help</span>
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>	get - Gets the key or a range of keys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>	etcdctl get <span style="color:#ce5c00;font-weight:bold">[</span>options<span style="color:#ce5c00;font-weight:bold">]</span> &lt;key&gt; <span style="color:#ce5c00;font-weight:bold">[</span>range_end<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>      --consistency<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;l&#34;</span>			Linearizable<span style="color:#ce5c00;font-weight:bold">(</span>l<span style="color:#ce5c00;font-weight:bold">)</span> or Serializable<span style="color:#ce5c00;font-weight:bold">(</span>s<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --from-key<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>		Get keys that are greater than or equal to the given key using byte compare
</span></span><span style="display:flex;"><span>      --keys-only<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>		Get only the keys
</span></span><span style="display:flex;"><span>      --limit<span style="color:#ce5c00;font-weight:bold">=</span>0				Maximum number of results
</span></span><span style="display:flex;"><span>      --order<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>			Order of results<span style="color:#000;font-weight:bold">;</span> ASCEND or DESCEND <span style="color:#ce5c00;font-weight:bold">(</span>ASCEND by default<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --prefix<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>			Get keys with matching prefix
</span></span><span style="display:flex;"><span>      --print-value-only<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>	Only write values when using the <span style="color:#4e9a06">&#34;simple&#34;</span> output format
</span></span><span style="display:flex;"><span>      --rev<span style="color:#ce5c00;font-weight:bold">=</span>0				Specify the kv revision
</span></span><span style="display:flex;"><span>      --sort-by<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>			Sort target<span style="color:#000;font-weight:bold">;</span> CREATE, KEY, MODIFY, VALUE, or VERSION
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GLOBAL OPTIONS:
</span></span><span style="display:flex;"><span>      --cacert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>				verify certificates of TLS-enabled secure servers using this CA bundle
</span></span><span style="display:flex;"><span>      --cert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS certificate file
</span></span><span style="display:flex;"><span>      --command-timeout<span style="color:#ce5c00;font-weight:bold">=</span>5s			timeout <span style="color:#204a87;font-weight:bold">for</span> short running <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">(</span>excluding dial timeout<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      --debug<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>				<span style="color:#204a87">enable</span> client-side debug logging
</span></span><span style="display:flex;"><span>      --dial-timeout<span style="color:#ce5c00;font-weight:bold">=</span>2s				dial timeout <span style="color:#204a87;font-weight:bold">for</span> client connections
</span></span><span style="display:flex;"><span>      --endpoints<span style="color:#ce5c00;font-weight:bold">=[</span>127.0.0.1:2379<span style="color:#ce5c00;font-weight:bold">]</span>		gRPC endpoints
</span></span><span style="display:flex;"><span>      --hex<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>				print byte strings as hex encoded strings
</span></span><span style="display:flex;"><span>      --insecure-skip-tls-verify<span style="color:#ce5c00;font-weight:bold">[=</span>false<span style="color:#ce5c00;font-weight:bold">]</span>	skip server certificate verification
</span></span><span style="display:flex;"><span>      --insecure-transport<span style="color:#ce5c00;font-weight:bold">[=</span>true<span style="color:#ce5c00;font-weight:bold">]</span>		disable transport security <span style="color:#204a87;font-weight:bold">for</span> client connections
</span></span><span style="display:flex;"><span>      --key<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS key file
</span></span><span style="display:flex;"><span>      --user<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					username<span style="color:#ce5c00;font-weight:bold">[</span>:password<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">for</span> authentication <span style="color:#ce5c00;font-weight:bold">(</span>prompt <span style="color:#204a87;font-weight:bold">if</span> password is not supplied<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  -w, --write-out<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;simple&#34;</span>			<span style="color:#204a87">set</span> the output format <span style="color:#ce5c00;font-weight:bold">(</span>fields, json, protobuf, simple, table<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>文章参考：</p>
<p><a href="https://coreos.com/etcd/docs/latest/demo.html">https://coreos.com/etcd/docs/latest/demo.html</a></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5ffa00ab05d9d30dfcd302587e50d29c">4.2 - etcdctl-V2</h1>
    
	<h1 id="1-etcdctl介绍">1. etcdctl介绍</h1>
<p>etcdctl是一个命令行的客户端，它提供了一下简洁的命令，可理解为命令工具集，可以方便我们在对服务进行测试或者手动修改数据库内容。etcdctl与其他xxxctl的命令原理及操作类似（例如kubectl，systemctl）。</p>
<p>用法：etcdctl [global options] command [command options][args...]</p>
<h1 id="2-etcd常用命令">2. Etcd常用命令</h1>
<h2 id="2-1-数据库操作命令">2.1. 数据库操作命令</h2>
<p>etcd 在键的组织上采用了层次化的空间结构（类似于文件系统中目录的概念），数据库操作围绕对键值和目录的 CRUD [增删改查]（符合 REST 风格的一套操作：Create, Read, Update, Delete）完整生命周期的管理。</p>
<p>具体的命令选项参数可以通过 etcdctl command --help来获取相关帮助。</p>
<h2 id="2-1-1-对象为键值">2.1.1. 对象为键值</h2>
<ol>
<li>
<h3 id="set-增-无论是否存在-etcdctl-set-key-value">set[增:无论是否存在]:etcdctl set key value</h3>
</li>
<li>
<h3 id="mk-增-必须不存在-etcdctl-mk-key-value">mk[增:必须不存在]:etcdctl mk key value</h3>
</li>
<li>
<h3 id="rm-删-etcdctl-rm-key">rm[删]:etcdctl rm key</h3>
</li>
<li>
<h3 id="update-改-etcdctl-update-key-value">update[改]:etcdctl update key value</h3>
</li>
<li>
<h3 id="get-查-etcdctl-get-key">get[查]:etcdctl get key</h3>
</li>
</ol>
<h2 id="2-1-2-对象为目录">2.1.2. 对象为目录</h2>
<ol>
<li>
<h3 id="setdir-增-无论是否存在-etcdctl-setdir-dir">setdir[增:无论是否存在]:etcdctl setdir dir</h3>
</li>
<li>
<h3 id="mkdir-增-必须不存在-etcdctl-mkdir-dir">mkdir[增:必须不存在]: etcdctl mkdir dir</h3>
</li>
<li>
<h3 id="rmdir-删-etcdctl-rmdir-dir">rmdir[删]:etcdctl rmdir dir</h3>
</li>
<li>
<h3 id="updatedir-改-etcdctl-updatedir-dir">updatedir[改]:etcdctl updatedir dir</h3>
</li>
<li>
<h3 id="ls-查-etcdclt-ls">ls[查]:etcdclt ls</h3>
</li>
</ol>
<h2 id="2-2-非数据库操作命令">2.2. 非数据库操作命令</h2>
<ol>
<li>
<h3 id="backup-备份-etcd-的数据">backup[备份 etcd 的数据]</h3>
<p>etcdctl backup</p>
</li>
<li>
<h3 id="watch-监测一个键值的变化-一旦键值发生更新-就会输出最新的值并退出">watch[监测一个键值的变化，一旦键值发生更新，就会输出最新的值并退出]</h3>
<p>etcdctl watch key</p>
</li>
<li>
<h3 id="exec-watch-监测一个键值的变化-一旦键值发生更新-就执行给定命令">exec-watch[监测一个键值的变化，一旦键值发生更新，就执行给定命令]</h3>
<p>etcdctl exec-watch key --sh -c &quot;ls&quot;</p>
</li>
<li>
<h3 id="member-通过-list-add-remove-update-命令列出-添加-删除-更新etcd-实例到-etcd-集群中">member[通过 list、add、remove、update 命令列出、添加、删除 、更新etcd 实例到 etcd 集群中]</h3>
<p>etcdctl member list；etcdctl member add 实例；etcdctl member remove 实例；etcdctl member update 实例。</p>
</li>
<li>
<h3 id="etcdctl-cluster-health-检查集群健康状态">etcdctl cluster-health[检查集群健康状态]</h3>
</li>
</ol>
<h2 id="2-3-常用配置参数">2.3. 常用配置参数</h2>
<p>设置配置文件，默认为/etc/etcd/etcd.conf。</p>
<table>
<thead>
<tr>
<th>配置参数</th>
<th>参数说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>配置参数</td>
<td>参数说明</td>
</tr>
<tr>
<td>-name</td>
<td>节点名称</td>
</tr>
<tr>
<td>-data-dir</td>
<td>保存日志和快照的目录，默认为当前工作目录，指定节点的数据存储目录</td>
</tr>
<tr>
<td>-addr</td>
<td>公布的ip地址和端口。 默认为127.0.0.1:2379</td>
</tr>
<tr>
<td>-bind-addr</td>
<td>用于客户端连接的监听地址，默认为-addr配置</td>
</tr>
<tr>
<td>-peers</td>
<td>集群成员逗号分隔的列表，例如 127.0.0.1:2380,127.0.0.1:2381</td>
</tr>
<tr>
<td>-peer-addr</td>
<td>集群服务通讯的公布的IP地址，默认为 127.0.0.1:2380.</td>
</tr>
<tr>
<td>-peer-bind-addr</td>
<td>集群服务通讯的监听地址，默认为-peer-addr配置</td>
</tr>
<tr>
<td>-wal-dir</td>
<td>指定节点的was文件的存储目录，若指定了该参数，wal文件会和其他数据文件分开存储</td>
</tr>
<tr>
<td>-listen-client-urls</td>
<td></td>
</tr>
<tr>
<td>-listen-peer-urls</td>
<td>监听URL，用于与其他节点通讯</td>
</tr>
<tr>
<td>-initial-advertise-peer-urls</td>
<td>告知集群其他节点url.</td>
</tr>
<tr>
<td>-advertise-client-urls</td>
<td>告知客户端url, 也就是服务的url</td>
</tr>
<tr>
<td>-initial-cluster-token</td>
<td>集群的ID</td>
</tr>
<tr>
<td>-initial-cluster</td>
<td>集群中所有节点</td>
</tr>
<tr>
<td>-initial-cluster-state</td>
<td>-initial-cluster-state=new 表示从无到有搭建etcd集群</td>
</tr>
<tr>
<td>-discovery-srv</td>
<td>用于DNS动态服务发现，指定DNS SRV域名</td>
</tr>
<tr>
<td>-discovery</td>
<td>用于etcd动态发现，指定etcd发现服务的URL [https://discovery.etcd.io/],用环境变量表示</td>
</tr>
</tbody>
</table>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d37dcd0642e22e58b477424b99aae67a">5 - Etcd访问控制</h1>
    
	<h1 id="1-etcd资源类型">1. ETCD资源类型</h1>
<p>There are three types of resources in etcd</p>
<ul>
<li><code>permission resources</code>: users and roles in the user store</li>
<li><code>key-value resources</code>: key-value pairs in the key-value store</li>
<li><code>settings resources</code>: security settings, auth settings, and dynamic etcd cluster settings (election/heartbeat)</li>
</ul>
<h1 id="2-权限资源">2. 权限资源</h1>
<p><strong>Users</strong>：user用来设置身份认证（user：passwd），一个用户可以拥有多个角色，每个角色被分配一定的权限（只读、只写、可读写），用户分为root用户和非root用户。</p>
<p><strong>Roles</strong>：角色用来关联权限，角色主要三类：root角色。默认创建root用户时即创建了root角色，该角色拥有所有权限；guest角色，默认自动创建，主要用于非认证使用。普通角色，由root用户创建角色，并分配指定权限。</p>
<p>注意：如果没有指定任何验证方式，即没显示指定以什么用户进行访问，那么默认会设定为 guest 角色。默认情况下 guest 也是具有全局访问权限的。如果不希望未授权就获取或修改etcd的数据，则可收回guest角色的权限或删除该角色，etcdctl role revoke 。</p>
<p><strong>Permissions</strong>:权限分为只读、只写、可读写三种权限，权限即对指定目录或key的读写权限。</p>
<h1 id="3-etcd访问控制">3. ETCD访问控制</h1>
<h2 id="3-1-访问控制相关命令">3.1. 访问控制相关命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   etcdctl - A simple <span style="color:#204a87">command</span> line client <span style="color:#204a87;font-weight:bold">for</span> etcd.
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   etcdctl <span style="color:#ce5c00;font-weight:bold">[</span>global options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>VERSION:
</span></span><span style="display:flex;"><span>   2.2.0
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   user         user add, grant and revoke subcommands
</span></span><span style="display:flex;"><span>   role         role add, grant and revoke subcommands
</span></span><span style="display:flex;"><span>   auth         overall auth controls  
</span></span><span style="display:flex;"><span>GLOBAL OPTIONS:
</span></span><span style="display:flex;"><span>   --peers, -C          a comma-delimited list of machine addresses in the cluster <span style="color:#ce5c00;font-weight:bold">(</span>default: <span style="color:#4e9a06">&#34;http://127.0.0.1:4001,http://127.0.0.1:2379&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   --endpoint           a comma-delimited list of machine addresses in the cluster <span style="color:#ce5c00;font-weight:bold">(</span>default: <span style="color:#4e9a06">&#34;http://127.0.0.1:4001,http://127.0.0.1:2379&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   --cert-file          identify HTTPS client using this SSL certificate file
</span></span><span style="display:flex;"><span>   --key-file           identify HTTPS client using this SSL key file
</span></span><span style="display:flex;"><span>   --ca-file            verify certificates of HTTPS-enabled servers using this CA bundle
</span></span><span style="display:flex;"><span>   --username, -u       provide username<span style="color:#ce5c00;font-weight:bold">[</span>:password<span style="color:#ce5c00;font-weight:bold">]</span> and prompt <span style="color:#204a87;font-weight:bold">if</span> password is not supplied.
</span></span><span style="display:flex;"><span>   --timeout <span style="color:#4e9a06">&#39;1s&#39;</span>       connection timeout per request
</span></span></code></pre></div><h2 id="3-2-user相关命令">3.2. user相关命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@localhost etcd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># etcdctl user --help</span>
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   etcdctl user - user add, grant and revoke subcommands
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   etcdctl user <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   add      add a new user <span style="color:#204a87;font-weight:bold">for</span> the etcd cluster
</span></span><span style="display:flex;"><span>   get      get details <span style="color:#204a87;font-weight:bold">for</span> a user
</span></span><span style="display:flex;"><span>   list     list all current users
</span></span><span style="display:flex;"><span>   remove   remove a user <span style="color:#204a87;font-weight:bold">for</span> the etcd cluster
</span></span><span style="display:flex;"><span>   grant    grant roles to an etcd user
</span></span><span style="display:flex;"><span>   revoke   revoke roles <span style="color:#204a87;font-weight:bold">for</span> an etcd user
</span></span><span style="display:flex;"><span>   passwd   change password <span style="color:#204a87;font-weight:bold">for</span> a user
</span></span><span style="display:flex;"><span>   help, h  Shows a list of commands or <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> one <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --help, -h   show <span style="color:#204a87">help</span>
</span></span></code></pre></div><h2 id="3-2-1-添加root用户并设置密码">3.2.1. 添加root用户并设置密码</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> user add root</p>
<h2 id="3-2-2-添加非root用户并设置密码">3.2.2. 添加非root用户并设置密码</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 user add huwh</p>
<h2 id="3-2-3-查看当前所有用户">3.2.3. 查看当前所有用户</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 user list</p>
<h2 id="3-2-4-将用户添加到对应角色">3.2.4. 将用户添加到对应角色</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 user grant --roles test1 phpor</p>
<h2 id="3-2-5-查看用户拥有哪些角色">3.2.5. 查看用户拥有哪些角色</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 user get phpor</p>
<h2 id="3-3-role相关命令">3.3. role相关命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@localhost etcd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># etcdctl role --help</span>
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   etcdctl role - role add, grant and revoke subcommands
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   etcdctl role <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   add      add a new role <span style="color:#204a87;font-weight:bold">for</span> the etcd cluster
</span></span><span style="display:flex;"><span>   get      get details <span style="color:#204a87;font-weight:bold">for</span> a role
</span></span><span style="display:flex;"><span>   list     list all roles
</span></span><span style="display:flex;"><span>   remove   remove a role from the etcd cluster
</span></span><span style="display:flex;"><span>   grant    grant path matches to an etcd role
</span></span><span style="display:flex;"><span>   revoke   revoke path matches <span style="color:#204a87;font-weight:bold">for</span> an etcd role
</span></span><span style="display:flex;"><span>   help, h  Shows a list of commands or <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> one <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --help, -h   show <span style="color:#204a87">help</span>
</span></span></code></pre></div><h2 id="3-3-1-添加角色">3.3.1. 添加角色</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:2379 role add test1</p>
<h2 id="3-3-2-查看所有角色">3.3.2. 查看所有角色</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 role list</p>
<h2 id="3-3-3-给角色分配权限">3.3.3. 给角色分配权限</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@localhost etcd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># etcdctl role grant --help</span>
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   grant - grant path matches to an etcd role
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   <span style="color:#204a87">command</span> grant <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --path   Path granted <span style="color:#204a87;font-weight:bold">for</span> the role to access
</span></span><span style="display:flex;"><span>   --read   Grant read-only access
</span></span><span style="display:flex;"><span>   --write  Grant write-only access
</span></span><span style="display:flex;"><span>   --readwrite  Grant read-write access
</span></span></code></pre></div><p>1、只包含目录
etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 role grant --readwrite --path /test1 test1</p>
<p>2、包括目录和子目录或文件
etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:123 role grant --readwrite --path /test1/* test1</p>
<h2 id="3-3-4-查看角色所拥有的权限">3.3.4. 查看角色所拥有的权限</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> --username root:2379 role get test1</p>
<h2 id="3-4-auth相关操作">3.4. auth相关操作</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@localhost etcd<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># etcdctl auth --help</span>
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   etcdctl auth - overall auth controls
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   etcdctl auth <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>   <span style="color:#204a87">enable</span>   <span style="color:#204a87">enable</span> auth access controls
</span></span><span style="display:flex;"><span>   disable  disable auth access controls
</span></span><span style="display:flex;"><span>   help, h  Shows a list of commands or <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> one <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --help, -h   show <span style="color:#204a87">help</span>
</span></span></code></pre></div><h2 id="3-4-1-开启认证">3.4.1. 开启认证</h2>
<p>etcdctl --endpoints <a href="http://172.16.22.36:2379/">http://172.16.22.36:2379</a> auth enable</p>
<h1 id="4-访问控制设置步骤">4. 访问控制设置步骤</h1>
<table>
<thead>
<tr>
<th>顺序</th>
<th>步骤</th>
<th>命令</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>添加root用户</td>
<td>etcdctl --endpoints http://<ip>:<port> user add root</td>
</tr>
<tr>
<td>2</td>
<td>开启认证</td>
<td>etcdctl --endpoints http://<ip>:<port> auth enable</td>
</tr>
<tr>
<td>3</td>
<td>添加非root用户</td>
<td>etcdctl --endpoints http://<ip>:<port> –username root:<passwd> user add <user></td>
</tr>
<tr>
<td>4</td>
<td>添加角色</td>
<td>etcdctl --endpoints http://<ip>:<port> –username root:<passwd> role add <role></td>
</tr>
<tr>
<td>5</td>
<td>给角色授权（只读、只写、可读写）</td>
<td>etcdctl --endpoints http://<ip>:<port> –username root:<passwd> role grant --readwrite --path <path> <role></td>
</tr>
<tr>
<td>6</td>
<td>给用户分配角色（即分配了角色对应的权限）</td>
<td>etcdctl --endpoints http://<ip>:<port> –username root:<passwd> user grant --roles <role> <user></td>
</tr>
</tbody>
</table>
<h1 id="5-访问认证的api调用">5. 访问认证的API调用</h1>
<p>更多参考</p>
<ul>
<li>
<p><a href="https://coreos.com/etcd/docs/latest/v2/auth_api.html">https://coreos.com/etcd/docs/latest/v2/auth_api.html</a></p>
</li>
<li>
<p><a href="https://coreos.com/etcd/docs/latest/v2/authentication.html">https://coreos.com/etcd/docs/latest/v2/authentication.html</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b579ae1cd3d66837e46a7cfa1d995677">6 - Etcd启动配置参数</h1>
    
	<h1 id="1-etcd配置参数">1. Etcd配置参数</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/ <span style="color:#8f5902;font-style:italic"># etcd --help</span>
</span></span><span style="display:flex;"><span>usage: etcd <span style="color:#ce5c00;font-weight:bold">[</span>flags<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>       start an etcd server
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       etcd --version
</span></span><span style="display:flex;"><span>       show the version of etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       etcd -h <span style="color:#000;font-weight:bold">|</span> --help
</span></span><span style="display:flex;"><span>       show the <span style="color:#204a87">help</span> information about etcd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       etcd --config-file
</span></span><span style="display:flex;"><span>       path to the server configuration file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       etcd gateway
</span></span><span style="display:flex;"><span>       run the stateless pass-through etcd TCP connection forwarding proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>       etcd grpc-proxy
</span></span><span style="display:flex;"><span>       run the stateless etcd v3 gRPC L7 reverse proxy
</span></span></code></pre></div><h2 id="1-1-member-flags">1.1. member flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>member flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	--name <span style="color:#4e9a06">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>		human-readable name <span style="color:#204a87;font-weight:bold">for</span> this member.
</span></span><span style="display:flex;"><span>	--data-dir <span style="color:#4e9a06">&#39;${name}.etcd&#39;</span>
</span></span><span style="display:flex;"><span>		path to the data directory.
</span></span><span style="display:flex;"><span>	--wal-dir <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the dedicated wal directory.
</span></span><span style="display:flex;"><span>	--snapshot-count <span style="color:#4e9a06">&#39;100000&#39;</span>
</span></span><span style="display:flex;"><span>		number of committed transactions to trigger a snapshot to disk.
</span></span><span style="display:flex;"><span>	--heartbeat-interval <span style="color:#4e9a06">&#39;100&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> of a heartbeat interval.
</span></span><span style="display:flex;"><span>	--election-timeout <span style="color:#4e9a06">&#39;1000&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> an election to timeout. See tuning documentation <span style="color:#204a87;font-weight:bold">for</span> details.
</span></span><span style="display:flex;"><span>	--initial-election-tick-advance <span style="color:#4e9a06">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>		whether to fast-forward initial election ticks on boot <span style="color:#204a87;font-weight:bold">for</span> faster election.
</span></span><span style="display:flex;"><span>	--listen-peer-urls <span style="color:#4e9a06">&#39;http://localhost:2380&#39;</span>
</span></span><span style="display:flex;"><span>		list of URLs to listen on <span style="color:#204a87;font-weight:bold">for</span> peer traffic.
</span></span><span style="display:flex;"><span>	--listen-client-urls <span style="color:#4e9a06">&#39;http://localhost:2379&#39;</span>
</span></span><span style="display:flex;"><span>		list of URLs to listen on <span style="color:#204a87;font-weight:bold">for</span> client traffic.
</span></span><span style="display:flex;"><span>	--max-snapshots <span style="color:#4e9a06">&#39;5&#39;</span>
</span></span><span style="display:flex;"><span>		maximum number of snapshot files to retain <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> is unlimited<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--max-wals <span style="color:#4e9a06">&#39;5&#39;</span>
</span></span><span style="display:flex;"><span>		maximum number of wal files to retain <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> is unlimited<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--cors <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		comma-separated whitelist of origins <span style="color:#204a87;font-weight:bold">for</span> CORS <span style="color:#ce5c00;font-weight:bold">(</span>cross-origin resource sharing<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--quota-backend-bytes <span style="color:#4e9a06">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span>		raise alarms when backend size exceeds the given quota <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> defaults to low space quota<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--max-txn-ops <span style="color:#4e9a06">&#39;128&#39;</span>
</span></span><span style="display:flex;"><span>		maximum number of operations permitted in a transaction.
</span></span><span style="display:flex;"><span>	--max-request-bytes <span style="color:#4e9a06">&#39;1572864&#39;</span>
</span></span><span style="display:flex;"><span>		maximum client request size in bytes the server will accept.
</span></span><span style="display:flex;"><span>	--grpc-keepalive-min-time <span style="color:#4e9a06">&#39;5s&#39;</span>
</span></span><span style="display:flex;"><span>		minimum duration interval that a client should <span style="color:#204a87">wait</span> before pinging server.
</span></span><span style="display:flex;"><span>	--grpc-keepalive-interval <span style="color:#4e9a06">&#39;2h&#39;</span>
</span></span><span style="display:flex;"><span>		frequency duration of server-to-client ping to check <span style="color:#204a87;font-weight:bold">if</span> a connection is alive <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> to disable<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--grpc-keepalive-timeout <span style="color:#4e9a06">&#39;20s&#39;</span>
</span></span><span style="display:flex;"><span>		additional duration of <span style="color:#204a87">wait</span> before closing a non-responsive connection <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> to disable<span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span></code></pre></div><h2 id="1-2-clustering-flags">1.2. clustering flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>clustering flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	--initial-advertise-peer-urls <span style="color:#4e9a06">&#39;http://localhost:2380&#39;</span>
</span></span><span style="display:flex;"><span>		list of this member<span style="color:#4e9a06">&#39;s peer URLs to advertise to the rest of the cluster.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">	--initial-cluster &#39;</span><span style="color:#000">default</span><span style="color:#ce5c00;font-weight:bold">=</span>http://localhost:2380<span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">		initial cluster configuration for bootstrapping.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">	--initial-cluster-state &#39;</span>new<span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">		initial cluster state (&#39;</span>new<span style="color:#4e9a06">&#39; or &#39;</span>existing<span style="color:#4e9a06">&#39;).
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">	--initial-cluster-token &#39;</span>etcd-cluster<span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">		initial cluster token for the etcd cluster during bootstrap.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">		Specifying this can protect you from unintended cross-cluster interaction when running multiple clusters.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">	--advertise-client-urls &#39;</span>http://localhost:2379<span style="color:#4e9a06">&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">		list of this member&#39;</span>s client URLs to advertise to the public.
</span></span><span style="display:flex;"><span>		The client URLs advertised should be accessible to machines that talk to etcd cluster. etcd client libraries parse these URLs to connect to the cluster.
</span></span><span style="display:flex;"><span>	--discovery <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		discovery URL used to bootstrap the cluster.
</span></span><span style="display:flex;"><span>	--discovery-fallback <span style="color:#4e9a06">&#39;proxy&#39;</span>
</span></span><span style="display:flex;"><span>		expected behavior <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;exit&#39;</span> or <span style="color:#4e9a06">&#39;proxy&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span> when discovery services fails.
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;proxy&#34;</span> supports v2 API only.
</span></span><span style="display:flex;"><span>	--discovery-proxy <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		HTTP proxy to use <span style="color:#204a87;font-weight:bold">for</span> traffic to discovery service.
</span></span><span style="display:flex;"><span>	--discovery-srv <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		dns srv domain used to bootstrap the cluster.
</span></span><span style="display:flex;"><span>	--strict-reconfig-check <span style="color:#4e9a06">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>		reject reconfiguration requests that would cause quorum loss.
</span></span><span style="display:flex;"><span>	--auto-compaction-retention <span style="color:#4e9a06">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span>		auto compaction retention length. <span style="color:#0000cf;font-weight:bold">0</span> means disable auto compaction.
</span></span><span style="display:flex;"><span>	--auto-compaction-mode <span style="color:#4e9a06">&#39;periodic&#39;</span>
</span></span><span style="display:flex;"><span>		interpret <span style="color:#4e9a06">&#39;auto-compaction-retention&#39;</span> one of: periodic<span style="color:#000;font-weight:bold">|</span>revision. <span style="color:#4e9a06">&#39;periodic&#39;</span> <span style="color:#204a87;font-weight:bold">for</span> duration based retention, defaulting to hours <span style="color:#204a87;font-weight:bold">if</span> no <span style="color:#204a87">time</span> unit is provided <span style="color:#ce5c00;font-weight:bold">(</span>e.g. <span style="color:#4e9a06">&#39;5m&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>. <span style="color:#4e9a06">&#39;revision&#39;</span> <span style="color:#204a87;font-weight:bold">for</span> revision number based retention.
</span></span><span style="display:flex;"><span>	--enable-v2 <span style="color:#4e9a06">&#39;true&#39;</span>
</span></span><span style="display:flex;"><span>		Accept etcd V2 client requests.
</span></span></code></pre></div><h2 id="1-3-proxy-flags">1.3. proxy flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>proxy flags:
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;proxy&#34;</span> supports v2 API only.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	--proxy <span style="color:#4e9a06">&#39;off&#39;</span>
</span></span><span style="display:flex;"><span>		proxy mode setting <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;off&#39;</span>, <span style="color:#4e9a06">&#39;readonly&#39;</span> or <span style="color:#4e9a06">&#39;on&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--proxy-failure-wait <span style="color:#0000cf;font-weight:bold">5000</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> an endpoint will be held in a failed state.
</span></span><span style="display:flex;"><span>	--proxy-refresh-interval <span style="color:#0000cf;font-weight:bold">30000</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> of the endpoints refresh interval.
</span></span><span style="display:flex;"><span>	--proxy-dial-timeout <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> a dial to timeout.
</span></span><span style="display:flex;"><span>	--proxy-write-timeout <span style="color:#0000cf;font-weight:bold">5000</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> a write to timeout.
</span></span><span style="display:flex;"><span>	--proxy-read-timeout <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">(</span>in milliseconds<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">for</span> a <span style="color:#204a87">read</span> to timeout.
</span></span></code></pre></div><h2 id="1-4-security-flags">1.4. security flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>security flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	--ca-file <span style="color:#4e9a06">&#39;&#39;</span> <span style="color:#ce5c00;font-weight:bold">[</span>DEPRECATED<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		path to the client server TLS CA file. <span style="color:#4e9a06">&#39;-ca-file ca.crt&#39;</span> could be replaced by <span style="color:#4e9a06">&#39;-trusted-ca-file ca.crt -client-cert-auth&#39;</span> and etcd will perform the same.
</span></span><span style="display:flex;"><span>	--cert-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the client server TLS cert file.
</span></span><span style="display:flex;"><span>	--key-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the client server TLS key file.
</span></span><span style="display:flex;"><span>	--client-cert-auth <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">enable</span> client cert authentication.
</span></span><span style="display:flex;"><span>	--client-crl-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the client certificate revocation list file.
</span></span><span style="display:flex;"><span>	--trusted-ca-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the client server TLS trusted CA cert file.
</span></span><span style="display:flex;"><span>	--auto-tls <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		client TLS using generated certificates.
</span></span><span style="display:flex;"><span>	--peer-ca-file <span style="color:#4e9a06">&#39;&#39;</span> <span style="color:#ce5c00;font-weight:bold">[</span>DEPRECATED<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		path to the peer server TLS CA file. <span style="color:#4e9a06">&#39;-peer-ca-file ca.crt&#39;</span> could be replaced by <span style="color:#4e9a06">&#39;-peer-trusted-ca-file ca.crt -peer-client-cert-auth&#39;</span> and etcd will perform the same.
</span></span><span style="display:flex;"><span>	--peer-cert-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the peer server TLS cert file.
</span></span><span style="display:flex;"><span>	--peer-key-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the peer server TLS key file.
</span></span><span style="display:flex;"><span>	--peer-client-cert-auth <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">enable</span> peer client cert authentication.
</span></span><span style="display:flex;"><span>	--peer-trusted-ca-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the peer server TLS trusted CA file.
</span></span><span style="display:flex;"><span>	--peer-auto-tls <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		peer TLS using self-generated certificates <span style="color:#204a87;font-weight:bold">if</span> --peer-key-file and --peer-cert-file are not provided.
</span></span><span style="display:flex;"><span>	--peer-crl-file <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		path to the peer certificate revocation list file.
</span></span></code></pre></div><h2 id="1-5-logging-flags">1.5. logging flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>logging flags
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	--debug <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">enable</span> debug-level logging <span style="color:#204a87;font-weight:bold">for</span> etcd.
</span></span><span style="display:flex;"><span>	--log-package-levels <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		specify a particular log level <span style="color:#204a87;font-weight:bold">for</span> each etcd package <span style="color:#ce5c00;font-weight:bold">(</span>eg: <span style="color:#4e9a06">&#39;etcdmain=CRITICAL,etcdserver=DEBUG&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span><span style="display:flex;"><span>	--log-output <span style="color:#4e9a06">&#39;default&#39;</span>
</span></span><span style="display:flex;"><span>		specify <span style="color:#4e9a06">&#39;stdout&#39;</span> or <span style="color:#4e9a06">&#39;stderr&#39;</span> to skip journald logging even when running under systemd.
</span></span></code></pre></div><h2 id="1-6-unsafe-flags">1.6. unsafe flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>unsafe flags:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Please be CAUTIOUS when using unsafe flags because it will <span style="color:#204a87">break</span> the guarantees
</span></span><span style="display:flex;"><span>given by the consensus protocol.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	--force-new-cluster <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		force to create a new one-member cluster.
</span></span></code></pre></div><h2 id="1-7-profiling-flags">1.7. profiling flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>profiling flags:
</span></span><span style="display:flex;"><span>	--enable-pprof <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		Enable runtime profiling data via HTTP server. Address is at client URL + <span style="color:#4e9a06">&#34;/debug/pprof/&#34;</span>
</span></span><span style="display:flex;"><span>	--metrics <span style="color:#4e9a06">&#39;basic&#39;</span>
</span></span><span style="display:flex;"><span>		Set level of detail <span style="color:#204a87;font-weight:bold">for</span> exported metrics, specify <span style="color:#4e9a06">&#39;extensive&#39;</span> to include histogram metrics.
</span></span><span style="display:flex;"><span>	--listen-metrics-urls <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		List of URLs to listen on <span style="color:#204a87;font-weight:bold">for</span> metrics.
</span></span></code></pre></div><h2 id="1-8-auth-flags">1.8. auth flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>auth flags:
</span></span><span style="display:flex;"><span>	--auth-token <span style="color:#4e9a06">&#39;simple&#39;</span>
</span></span><span style="display:flex;"><span>		Specify a v3 authentication token <span style="color:#204a87">type</span> and its options <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;simple&#39;</span> or <span style="color:#4e9a06">&#39;jwt&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span></code></pre></div><h2 id="1-9-experimental-flags">1.9. experimental flags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>experimental flags:
</span></span><span style="display:flex;"><span>	--experimental-initial-corrupt-check <span style="color:#4e9a06">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">enable</span> to check data corruption before serving any client/peer traffic.
</span></span><span style="display:flex;"><span>	--experimental-corrupt-check-time <span style="color:#4e9a06">&#39;0s&#39;</span>
</span></span><span style="display:flex;"><span>		duration of <span style="color:#204a87">time</span> between cluster corruption check passes.
</span></span><span style="display:flex;"><span>	--experimental-enable-v2v3 <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>		serve v2 requests through the v3 backend under a given prefix.
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f0607d0d7eaa382cf2171ad2fb4c6485">7 - Etcd中的k8s数据</h1>
    
	<h1 id="1-读取数据key">1. 读取数据key</h1>
<p>使用以下命令列出所有的key。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> etcdctl --endpoints<span style="color:#ce5c00;font-weight:bold">=</span>&lt;etcd-ip-1&gt;:2379,&lt;etcd-ip-2&gt;:2379,&lt;etcd-ip-3&gt;:2379 --cacert<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/pki/etcd/ca.crt  --key<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/pki/apiserver-etcd-client.key  --cert<span style="color:#ce5c00;font-weight:bold">=</span>/etc/kubernetes/pki/apiserver-etcd-client.crt get / --prefix --keys-only
</span></span></code></pre></div><p>参数说明：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  --cacert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>				verify certificates of TLS-enabled secure servers using this CA bundle
</span></span><span style="display:flex;"><span>  --cert<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS certificate file
</span></span><span style="display:flex;"><span>  --key<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;&#34;</span>					identify secure client using this TLS key file
</span></span><span style="display:flex;"><span>  --endpoints<span style="color:#ce5c00;font-weight:bold">=[</span>127.0.0.1:2379<span style="color:#ce5c00;font-weight:bold">]</span>		gRPC endpoints
</span></span></code></pre></div><p>可以使用alias来重命名etcdctl一串的命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">ectl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;ETCDCTL_API=3 etcdctl --endpoints=&lt;etcd-ip-1&gt;:2379,&lt;etcd-ip-2&gt;:2379,&lt;etcd-ip-3&gt;:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt  --key=/etc/kubernetes/pki/apiserver-etcd-client.key  --cert=/etc/kubernetes/pki/apiserver-etcd-client.crt&#39;</span>
</span></span></code></pre></div><h1 id="2-集群数据">2. 集群数据</h1>
<h2 id="2-1-node">2.1. node</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/minions/&lt;node-ip-1&gt;
</span></span><span style="display:flex;"><span>/registry/minions/&lt;node-ip-2&gt;
</span></span><span style="display:flex;"><span>/registry/minions/&lt;node-ip-3&gt;
</span></span></code></pre></div><p>其他信息：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/leases/kube-node-lease/&lt;node-ip-1&gt;
</span></span><span style="display:flex;"><span>/registry/leases/kube-node-lease/&lt;node-ip-2&gt;
</span></span><span style="display:flex;"><span>/registry/leases/kube-node-lease/&lt;node-ip-3&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>/registry/masterleases/&lt;node-ip-2&gt;
</span></span><span style="display:flex;"><span>/registry/masterleases/&lt;node-ip-3&gt;
</span></span></code></pre></div><h1 id="3-k8s对象数据">3. k8s对象数据</h1>
<p>k8s对象数据的格式</p>
<h2 id="3-1-namespace">3.1. namespace</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/namespaces/default
</span></span><span style="display:flex;"><span>/registry/namespaces/game
</span></span><span style="display:flex;"><span>/registry/namespaces/kube-node-lease
</span></span><span style="display:flex;"><span>/registry/namespaces/kube-public
</span></span><span style="display:flex;"><span>/registry/namespaces/kube-system
</span></span></code></pre></div><h2 id="3-2-namespace级别对象">3.2. namespace级别对象</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/<span style="color:#ce5c00;font-weight:bold">{</span>resource<span style="color:#ce5c00;font-weight:bold">}</span>/<span style="color:#ce5c00;font-weight:bold">{</span>namespace<span style="color:#ce5c00;font-weight:bold">}</span>/<span style="color:#ce5c00;font-weight:bold">{</span>resource_name<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下以常见k8s对象为例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># deployment</span>
</span></span><span style="display:flex;"><span>/registry/deployments/default/game-2048
</span></span><span style="display:flex;"><span>/registry/deployments/kube-system/prometheus-operator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># replicasets</span>
</span></span><span style="display:flex;"><span>/registry/replicasets/default/game-2048-c7d589ccf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># pod</span>
</span></span><span style="display:flex;"><span>/registry/pods/default/game-2048-c7d589ccf-8lsbw
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># statefulsets</span>
</span></span><span style="display:flex;"><span>/registry/statefulsets/kube-system/prometheus-k8s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># daemonsets</span>
</span></span><span style="display:flex;"><span>/registry/daemonsets/kube-system/kube-proxy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># secrets</span>
</span></span><span style="display:flex;"><span>/registry/secrets/default/default-token-tbfmb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># serviceaccounts</span>
</span></span><span style="display:flex;"><span>/registry/serviceaccounts/default/default
</span></span></code></pre></div><p><strong>service</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># service</span>
</span></span><span style="display:flex;"><span>/registry/services/specs/default/game-2048
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># endpoints</span>
</span></span><span style="display:flex;"><span>/registry/services/endpoints/default/game-2048
</span></span></code></pre></div><h1 id="4-读取数据value">4. 读取数据value</h1>
<p>由于k8s默认etcd中的数据是通过protobuf格式存储，因此看到的key和value的值是一串字符串。</p>
<blockquote>
<p>alias ectl='ETCDCTL_API=3 etcdctl --endpoints=<etcd-ip-1>:2379,<etcd-ip-2>:2379,<etcd-ip-3>:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt  --key=/etc/kubernetes/pki/apiserver-etcd-client.key  --cert=/etc/kubernetes/pki/apiserver-etcd-client.crt'</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ectl get /registry/namespaces/test -w json |jq</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;header&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;cluster_id&#34;</span>: 12113422651334595000,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;member_id&#34;</span>: 8381627376898157000,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;revision&#34;</span>: 12321629,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;raft_term&#34;</span>: <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;kvs&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;L3JlZ2lzdHJ5L25hbWVzcGFjZXMvdGVzdA==&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;create_revision&#34;</span>: 11670741,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;mod_revision&#34;</span>: 11670741,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;version&#34;</span>: 1,
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;value&#34;</span>: <span style="color:#4e9a06">&#34;azhzAAoPCgJ2MRIJTmFtZXNwYWNlElwKQgoEdGVzdBIAGgAiACokYWM1YmJjOTQtNTkxZi0xMWVhLWJiOTQtNmM5MmJmM2I3NmI1MgA4AEIICJuf3fIFEAB6ABIMCgprdWJlcm5ldGVzGggKBkFjdGl2ZRoAIgA=&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">]</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;count&#34;</span>: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中key可以通过base64解码出来</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;L3JlZ2lzdHJ5L25hbWVzcGFjZXMvdGVzdA==&#34;</span> <span style="color:#000;font-weight:bold">|</span> base64 --decode
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># output</span>
</span></span><span style="display:flex;"><span>/registry/namespaces/test
</span></span></code></pre></div><p>value是值可以通过安装<a href="https://github.com/openshift/origin/tree/master/tools/etcdhelper">etcdhelper</a>工具解析出来。</p>
<blockquote>
<p>alias ehelper='etcdhelper -key /etc/kubernetes/pki/apiserver-etcd-client.key -cert /etc/kubernetes/pki/apiserver-etcd-client.crt -cacert /etc/kubernetes/pki/etcd/ca.crt'</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ehelper get /registry/namespaces/test</span>
</span></span><span style="display:flex;"><span>/v1, <span style="color:#000">Kind</span><span style="color:#ce5c00;font-weight:bold">=</span>Namespace
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;kind&#34;</span>: <span style="color:#4e9a06">&#34;Namespace&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;apiVersion&#34;</span>: <span style="color:#4e9a06">&#34;v1&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;metadata&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;name&#34;</span>: <span style="color:#4e9a06">&#34;test&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;uid&#34;</span>: <span style="color:#4e9a06">&#34;ac5bbc94-591f-11ea-bb94-6c92bf3b76b5&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;creationTimestamp&#34;</span>: <span style="color:#4e9a06">&#34;2020-02-27T05:11:55Z&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;spec&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;finalizers&#34;</span>: <span style="color:#ce5c00;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>      <span style="color:#4e9a06">&#34;kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;status&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;phase&#34;</span>: <span style="color:#4e9a06">&#34;Active&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-注意事项">5. 注意事项</h1>
<ul>
<li>由于k8s的etcd数据为了性能考虑，默认通过<code>protobuf</code>格式存储，不要通过手动的方式去修改或添加k8s数据。</li>
<li>不推荐使用json格式存储etcd数据，如果需要json格式，可以使用<code>--storage-media-type=application/json</code>参数存储，参考：https://github.com/kubernetes/kubernetes/issues/44670</li>
</ul>
<h1 id="6-快捷命令">6. 快捷命令</h1>
<p>由于etcdctl的命令需要添加很多认证参数和endpoints的参数，因此可以使用别名的方式来简化命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># etcdctl </span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">ectl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;ETCDCTL_API=3 etcdctl --endpoints=&lt;etcd-ip-1&gt;:2379,&lt;etcd-ip-2&gt;:2379,&lt;etcd-ip-3&gt;:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt  --key=/etc/kubernetes/pki/apiserver-etcd-client.key  --cert=/etc/kubernetes/pki/apiserver-etcd-client.crt&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># etcdhelper</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">alias</span> <span style="color:#000">ehelper</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;etcdhelper -key /etc/kubernetes/pki/apiserver-etcd-client.key -cert /etc/kubernetes/pki/apiserver-etcd-client.crt -cacert /etc/kubernetes/pki/etcd/ca.crt&#39;</span>
</span></span></code></pre></div><h2 id="6-1-etcdhelper的使用">6.1. etcdhelper的使用</h2>
<p><code>etcdhelper</code>文档参考：https://github.com/openshift/origin/tree/master/tools/etcdhelper</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 必要的认证参数</span>
</span></span><span style="display:flex;"><span>-key - points to master.etcd-client.key
</span></span><span style="display:flex;"><span>-cert - points to master.etcd-client.crt
</span></span><span style="display:flex;"><span>-cacert - points to ca.crt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 命令操作参数</span>
</span></span><span style="display:flex;"><span>ls - list all keys starting with prefix
</span></span><span style="display:flex;"><span>get - get the specific value of a key
</span></span><span style="display:flex;"><span>dump - dump the entire contents of the etcd
</span></span></code></pre></div><p>示例</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ehelper ls /registry/leases/
</span></span><span style="display:flex;"><span>/registry/leases/kube-node-lease/&lt;ip-1&gt;
</span></span><span style="display:flex;"><span>/registry/leases/kube-node-lease/&lt;ip-2&gt;
</span></span><span style="display:flex;"><span>/registry/leases/kube-node-lease/&lt;ip-3&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ehelper get &lt;key&gt;
</span></span></code></pre></div><h1 id="7-rbac">7. RBAC</h1>
<p>附RBAC相关的key。</p>
<p><strong>clusterrolebindings</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/clusterrolebindings/cluster-admin
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/flannel
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/galaxy
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/helm
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/kube-state-metrics
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/kubeadm:kubelet-bootstrap
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/kubeadm:node-autoapprove-bootstrap
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/kubeadm:node-autoapprove-certificate-rotation
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/kubeadm:node-proxier
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/lbcf-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/prometheus-k8s
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/prometheus-operator
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:aws-cloud-provider
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:basic-user
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:attachdetach-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:certificate-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:clusterrole-aggregation-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:cronjob-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:daemon-set-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:deployment-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:disruption-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:endpoint-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:expand-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:generic-garbage-collector
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:horizontal-pod-autoscaler
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:job-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:namespace-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:node-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:persistent-volume-binder
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:pod-garbage-collector
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:pv-protection-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:pvc-protection-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:replicaset-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:replication-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:resourcequota-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:route-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:service-account-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:service-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:statefulset-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:controller:ttl-controller
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:coredns
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:discovery
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:kube-controller-manager
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:kube-dns
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:kube-scheduler
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:node
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:node-proxier
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:public-info-viewer
</span></span><span style="display:flex;"><span>/registry/clusterrolebindings/system:volume-scheduler
</span></span></code></pre></div><p><strong>clusterroles</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/clusterroles/admin
</span></span><span style="display:flex;"><span>/registry/clusterroles/cluster-admin
</span></span><span style="display:flex;"><span>/registry/clusterroles/edit
</span></span><span style="display:flex;"><span>/registry/clusterroles/flannel
</span></span><span style="display:flex;"><span>/registry/clusterroles/kube-state-metrics
</span></span><span style="display:flex;"><span>/registry/clusterroles/lbcf-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/prometheus-k8s
</span></span><span style="display:flex;"><span>/registry/clusterroles/prometheus-operator
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:aggregate-to-admin
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:aggregate-to-edit
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:aggregate-to-view
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:auth-delegator
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:aws-cloud-provider
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:basic-user
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:certificates.k8s.io:certificatesigningrequests:nodeclient
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:attachdetach-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:certificate-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:clusterrole-aggregation-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:cronjob-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:daemon-set-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:deployment-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:disruption-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:endpoint-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:expand-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:generic-garbage-collector
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:horizontal-pod-autoscaler
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:job-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:namespace-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:node-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:persistent-volume-binder
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:pod-garbage-collector
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:pv-protection-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:pvc-protection-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:replicaset-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:replication-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:resourcequota-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:route-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:service-account-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:service-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:statefulset-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:controller:ttl-controller
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:coredns
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:csi-external-attacher
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:csi-external-provisioner
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:discovery
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:heapster
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:kube-aggregator
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:kube-controller-manager
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:kube-dns
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:kube-scheduler
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:kubelet-api-admin
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:node
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:node-bootstrapper
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:node-problem-detector
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:node-proxier
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:persistent-volume-provisioner
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:public-info-viewer
</span></span><span style="display:flex;"><span>/registry/clusterroles/system:volume-scheduler
</span></span><span style="display:flex;"><span>/registry/clusterroles/view
</span></span></code></pre></div><p><strong>rolebindings</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/rolebindings/kube-public/kubeadm:bootstrap-signer-clusterinfo
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-public/system:controller:bootstrap-signer
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/kube-proxy
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/kube-state-metrics
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/kubeadm:kubeadm-certs
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/kubeadm:kubelet-config-1.14
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/kubeadm:nodes-kubeadm-config
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/system::extension-apiserver-authentication-reader
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/system::leader-locking-kube-controller-manager
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/system::leader-locking-kube-scheduler
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/system:controller:bootstrap-signer
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/system:controller:cloud-provider
</span></span><span style="display:flex;"><span>/registry/rolebindings/kube-system/system:controller:token-cleaner
</span></span></code></pre></div><p><strong>roles</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/registry/roles/kube-public/kubeadm:bootstrap-signer-clusterinfo
</span></span><span style="display:flex;"><span>/registry/roles/kube-public/system:controller:bootstrap-signer
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/extension-apiserver-authentication-reader
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/kube-proxy
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/kube-state-metrics-resizer
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/kubeadm:kubeadm-certs
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/kubeadm:kubelet-config-1.14
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/kubeadm:nodes-kubeadm-config
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/system::leader-locking-kube-controller-manager
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/system::leader-locking-kube-scheduler
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/system:controller:bootstrap-signer
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/system:controller:cloud-provider
</span></span><span style="display:flex;"><span>/registry/roles/kube-system/system:controller:token-cleaner
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/etcd-io/etcd/tree/master/etcdctl">https://github.com/etcd-io/etcd/tree/master/etcdctl</a></li>
<li><a href="https://github.com/openshift/origin/tree/master/tools/etcdhelper">https://github.com/openshift/origin/tree/master/tools/etcdhelper</a></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/guide/using-etcdctl-to-access-kubernetes-data.html">using-etcdctl-to-access-kubernetes-data</a></li>
<li><a href="https://int32bit.me/2019/12/01/%E5%A6%82%E4%BD%95%E8%AF%BB%E5%8F%96Kubernetes%E5%AD%98%E5%82%A8%E5%9C%A8etcd%E4%B8%8A%E7%9A%84%E6%95%B0%E6%8D%AE/">如何读取Kubernetes存储在etcd上的数据</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/issues/44670">https://github.com/kubernetes/kubernetes/issues/44670</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-71893bf7906a4195ee237a3f2ab53af1">8 - etcd-operator的使用</h1>
    
	<blockquote>
<p>本文主要介绍etcd-operator的部署及使用</p>
</blockquote>
<h1 id="1-部署rbac">1. 部署RBAC</h1>
<p>下载<a href="https://github.com/coreos/etcd-operator/blob/master/example/rbac/create_role.sh">create_role.sh</a>、<a href="https://github.com/coreos/etcd-operator/blob/master/example/rbac/cluster-role-binding-template.yaml">cluster-role-binding-template.yaml</a>、<a href="https://github.com/coreos/etcd-operator/blob/master/example/rbac/cluster-role-template.yaml">cluster-role-template.yaml</a></p>
<p>例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- cluster-role-binding-template.yaml
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- cluster-role-template.yaml
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- create_role.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 部署rbac</span>
</span></span><span style="display:flex;"><span>kubectl create ns operator
</span></span><span style="display:flex;"><span>bash create_role.sh --namespace<span style="color:#ce5c00;font-weight:bold">=</span>operator  <span style="color:#8f5902;font-style:italic"># namespace与etcd-operator的ns一致</span>
</span></span></code></pre></div><p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bash create_role.sh --namespace<span style="color:#ce5c00;font-weight:bold">=</span>operator
</span></span><span style="display:flex;"><span>+ <span style="color:#000">ROLE_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-operator
</span></span><span style="display:flex;"><span>+ <span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-operator
</span></span><span style="display:flex;"><span>+ <span style="color:#000">NAMESPACE</span><span style="color:#ce5c00;font-weight:bold">=</span>default
</span></span><span style="display:flex;"><span>+ <span style="color:#204a87;font-weight:bold">for</span> i in <span style="color:#4e9a06">&#39;&#34;$@&#34;&#39;</span>
</span></span><span style="display:flex;"><span>+ <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">$i</span> in
</span></span><span style="display:flex;"><span>+ <span style="color:#000">NAMESPACE</span><span style="color:#ce5c00;font-weight:bold">=</span>operator
</span></span><span style="display:flex;"><span>+ <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;Creating role with ROLE_NAME=etcd-operator, NAMESPACE=operator&#39;</span>
</span></span><span style="display:flex;"><span>Creating role with <span style="color:#000">ROLE_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-operator, <span style="color:#000">NAMESPACE</span><span style="color:#ce5c00;font-weight:bold">=</span>operator
</span></span><span style="display:flex;"><span>+ sed -e <span style="color:#4e9a06">&#39;s/&lt;ROLE_NAME&gt;/etcd-operator/g&#39;</span> -e <span style="color:#4e9a06">&#39;s/&lt;NAMESPACE&gt;/operator/g&#39;</span> cluster-role-template.yaml
</span></span><span style="display:flex;"><span>+ kubectl create -f -
</span></span><span style="display:flex;"><span>clusterrole.rbac.authorization.k8s.io/etcd-operator created
</span></span><span style="display:flex;"><span>+ <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;Creating role binding with ROLE_NAME=etcd-operator, ROLE_BINDING_NAME=etcd-operator, NAMESPACE=operator&#39;</span>
</span></span><span style="display:flex;"><span>Creating role binding with <span style="color:#000">ROLE_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-operator, <span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span>etcd-operator, <span style="color:#000">NAMESPACE</span><span style="color:#ce5c00;font-weight:bold">=</span>operator
</span></span><span style="display:flex;"><span>+ sed -e <span style="color:#4e9a06">&#39;s/&lt;ROLE_NAME&gt;/etcd-operator/g&#39;</span> -e <span style="color:#4e9a06">&#39;s/&lt;ROLE_BINDING_NAME&gt;/etcd-operator/g&#39;</span> -e <span style="color:#4e9a06">&#39;s/&lt;NAMESPACE&gt;/operator/g&#39;</span> cluster-role-binding-template.yaml
</span></span><span style="display:flex;"><span>+ kubectl create -f -
</span></span><span style="display:flex;"><span>clusterrolebinding.rbac.authorization.k8s.io/etcd-operator created
</span></span></code></pre></div><h2 id="1-1-create-role-sh-脚本">1.1. create_role.sh 脚本</h2>
<p>create_role.sh有三个入参，可以指定--namespace参数，该参数与etcd-operator部署的namespace应一致。默认为default。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -o errexit
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> -o nounset
</span></span><span style="display:flex;"><span><span style="color:#204a87">set</span> -o pipefail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ETCD_OPERATOR_ROOT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>dirname <span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">BASH_SOURCE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">)</span>/../..
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print_usage<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>basename <span style="color:#4e9a06">&#34;</span><span style="color:#000">$0</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06"> - Create Kubernetes RBAC role and role bindings for etcd-operator
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Usage: </span><span style="color:#204a87;font-weight:bold">$(</span>basename <span style="color:#4e9a06">&#34;</span><span style="color:#000">$0</span><span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06"> [options...]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Options:
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --role-name=STRING         Name of ClusterRole to create
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                               (default=\&#34;etcd-operator\&#34;, environment variable: ROLE_NAME)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --role-binding-name=STRING Name of ClusterRoleBinding to create
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                               (default=\&#34;etcd-operator\&#34;, environment variable: ROLE_BINDING_NAME)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  --namespace=STRING         namespace to create role and role binding in. Must already exist.
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                               (default=\&#34;default\&#34;, environment variable: NAMESPACE)
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;</span> &gt;<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ROLE_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_NAME</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">etcd</span><span style="color:#000;font-weight:bold">-operator</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">etcd</span><span style="color:#000;font-weight:bold">-operator</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">NAMESPACE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">NAMESPACE</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">default</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> i in <span style="color:#4e9a06">&#34;</span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">do</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">$i</span> in
</span></span><span style="display:flex;"><span>    --role-name<span style="color:#ce5c00;font-weight:bold">=</span>*<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ROLE_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">#*=</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>    --role-binding-name<span style="color:#ce5c00;font-weight:bold">=</span>*<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">#*=</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>    --namespace<span style="color:#ce5c00;font-weight:bold">=</span>*<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">NAMESPACE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">#*=</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>    -h<span style="color:#000;font-weight:bold">|</span>--help<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      print_usage
</span></span><span style="display:flex;"><span>      <span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span>    *<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      print_usage
</span></span><span style="display:flex;"><span>      <span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">;;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">esac</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Creating role with ROLE_NAME=</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, NAMESPACE=</span><span style="color:#4e9a06">${</span><span style="color:#000">NAMESPACE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>sed -e <span style="color:#4e9a06">&#34;s/&lt;ROLE_NAME&gt;/</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/g&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -e <span style="color:#4e9a06">&#34;s/&lt;NAMESPACE&gt;/</span><span style="color:#4e9a06">${</span><span style="color:#000">NAMESPACE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/g&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">&#34;cluster-role-template.yaml&#34;</span> <span style="color:#000;font-weight:bold">|</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  kubectl create -f -
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;Creating role binding with ROLE_NAME=</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, ROLE_BINDING_NAME=</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">, NAMESPACE=</span><span style="color:#4e9a06">${</span><span style="color:#000">NAMESPACE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>sed -e <span style="color:#4e9a06">&#34;s/&lt;ROLE_NAME&gt;/</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/g&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -e <span style="color:#4e9a06">&#34;s/&lt;ROLE_BINDING_NAME&gt;/</span><span style="color:#4e9a06">${</span><span style="color:#000">ROLE_BINDING_NAME</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/g&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  -e <span style="color:#4e9a06">&#34;s/&lt;NAMESPACE&gt;/</span><span style="color:#4e9a06">${</span><span style="color:#000">NAMESPACE</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">/g&#34;</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  <span style="color:#4e9a06">&#34;cluster-role-binding-template.yaml&#34;</span> <span style="color:#000;font-weight:bold">|</span> <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  kubectl create -f -
</span></span></code></pre></div><h2 id="1-2-cluster-role-binding-template-yaml">1.2. cluster-role-binding-template.yaml</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRoleBinding</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;ROLE_BINDING_NAME&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">roleRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">apiGroup</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;ROLE_NAME&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subjects</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ServiceAccount</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;NAMESPACE&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="1-3-cluster-role-template-yaml">1.3. cluster-role-template.yaml</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">rbac.authorization.k8s.io/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClusterRole</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">&lt;ROLE_NAME&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">etcd.database.coreos.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">etcdclusters</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">etcdbackups</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">etcdrestores</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">apiextensions.k8s.io</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">customresourcedefinitions</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">pods</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">services</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">endpoints</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">persistentvolumeclaims</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">events</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">apps</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">deployments</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;*&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># The following permissions can be removed if not using S3 backup and TLS</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">apiGroups</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">secrets</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">verbs</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">get</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="2-部署etcd-operator">2. 部署etcd-operator</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create -f etcd-operator.yaml
</span></span></code></pre></div><p>etcd-operator.yaml如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">operator  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 与rbac指定的ns一致</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">registry.cn-shenzhen.aliyuncs.com/huweihuang/etcd-operator:v0.9.4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">command</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">etcd-operator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#8f5902;font-style:italic"># Uncomment to act for resources in all namespaces. More information in doc/user/clusterwide.md</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- -<span style="color:#000">cluster-wide</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MY_POD_NAMESPACE</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">valueFrom</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">fieldRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">fieldPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metadata.namespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">MY_POD_NAME</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">valueFrom</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">fieldRef</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">fieldPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">metadata.name</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>查看CRD</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#kubectl get customresourcedefinitions</span>
</span></span><span style="display:flex;"><span>NAME                                       CREATED AT
</span></span><span style="display:flex;"><span>etcdclusters.etcd.database.coreos.com      2020-08-01T13:02:18Z
</span></span></code></pre></div><p>查看etcd-operator的日志是否OK。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>k logs -f etcd-operator-545df8d445-qpf6n -n operator
</span></span><span style="display:flex;"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2020-08-01T13:02:18Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;etcd-operator Version: 0.9.4&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2020-08-01T13:02:18Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Git SHA: c8a1c64&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2020-08-01T13:02:18Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Go Version: go1.11.5&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2020-08-01T13:02:18Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Go OS/Arch: linux/amd64&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;2020-08-01T13:02:18Z&#34;</span> <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Event(v1.ObjectReference{Kind:\&#34;Endpoints\&#34;, Namespace:\&#34;operator\&#34;, Name:\&#34;etcd-operator\&#34;, UID:\&#34;7de38cff-1b7b-4bf2-9837-473fa66c9366\&#34;, APIVersion:\&#34;v1\&#34;, ResourceVersion:\&#34;41195930\&#34;, FieldPath:\&#34;\&#34;}): type: &#39;Normal&#39; reason: &#39;LeaderElection&#39; etcd-operator-545df8d445-qpf6n became leader&#34;</span>
</span></span></code></pre></div><p>以上内容表示etcd-operator运行正常。</p>
<h1 id="3-部署etcd集群">3. 部署etcd集群</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create -f etcd-cluster.yaml
</span></span></code></pre></div><blockquote>
<p>当开启clusterwide则etcd集群与etcd-operator的ns可不同。</p>
</blockquote>
<p>etcd-cluster.yaml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;etcd.database.coreos.com/v1beta2&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;EtcdCluster&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;default-etcd-cluster&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">## Adding this annotation make this cluster managed by clusterwide operators</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic">## namespaced operators ignore it</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">annotations</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">etcd.database.coreos.com/scope</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">clusterwide</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">etcd  </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 此处的ns表示etcd集群部署在哪个ns下</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">size</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;v3.3.18&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">repository</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">registry.cn-shenzhen.aliyuncs.com/huweihuang/etcd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">pod</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">busyboxImage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">registry.cn-shenzhen.aliyuncs.com/huweihuang/busybox:1.28.0-glibc</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>查看集群部署结果</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kgpo -n etcd
</span></span><span style="display:flex;"><span>NAME                              READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>default-etcd-cluster-b6phnpf8z8   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          3m3s
</span></span><span style="display:flex;"><span>default-etcd-cluster-hhgq4sbtgr   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          109s
</span></span><span style="display:flex;"><span>default-etcd-cluster-ttfh5fj92b   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          2m29s
</span></span></code></pre></div><h1 id="4-访问etcd集群">4. 访问etcd集群</h1>
<p>查看service</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kgsvc -n etcd
</span></span><span style="display:flex;"><span>NAME                          TYPE        CLUSTER-IP        EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>             AGE
</span></span><span style="display:flex;"><span>default-etcd-cluster          ClusterIP   None              &lt;none&gt;        2379/TCP,2380/TCP   5m37s
</span></span><span style="display:flex;"><span>default-etcd-cluster-client   ClusterIP   192.168.255.244   &lt;none&gt;        2379/TCP            5m37s
</span></span></code></pre></div><p>使用service地址访问</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看集群健康状态</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> etcdctl --endpoints 192.168.255.244:2379 endpoint health
</span></span><span style="display:flex;"><span>192.168.255.244:2379 is healthy: successfully committed proposal: <span style="color:#000">took</span> <span style="color:#ce5c00;font-weight:bold">=</span> 1.96126ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 写数据</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> etcdctl --endpoints 192.168.255.244:2379 put foo bar
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 读数据</span>
</span></span><span style="display:flex;"><span>$ <span style="color:#000">ETCDCTL_API</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span> etcdctl --endpoints 192.168.255.244:2379 get foo
</span></span><span style="display:flex;"><span>foo
</span></span><span style="display:flex;"><span>bar
</span></span></code></pre></div><h1 id="5-销毁etcd-operator">5. 销毁etcd-operator</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl delete -f example/deployment.yaml
</span></span><span style="display:flex;"><span>kubectl delete endpoints etcd-operator
</span></span><span style="display:flex;"><span>kubectl delete crd etcdclusters.etcd.database.coreos.com
</span></span><span style="display:flex;"><span>kubectl delete clusterrole etcd-operator
</span></span><span style="display:flex;"><span>kubectl delete clusterrolebinding etcd-operator
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/coreos/etcd-operator">https://github.com/coreos/etcd-operator</a></li>
<li><a href="https://github.com/coreos/etcd-operator/blob/master/doc/user/install_guide.md">https://github.com/coreos/etcd-operator/blob/master/doc/user/install_guide.md</a></li>
<li><a href="https://github.com/coreos/etcd-operator/blob/master/doc/user/client_service.md">https://github.com/coreos/etcd-operator/blob/master/doc/user/client_service.md</a></li>
<li><a href="https://github.com/coreos/etcd-operator/blob/master/doc/user/spec_examples.md">https://github.com/coreos/etcd-operator/blob/master/doc/user/spec_examples.md</a></li>
<li><a href="https://github.com/coreos/etcd-operator/blob/master/doc/user/cluster_tls.md">https://github.com/coreos/etcd-operator/blob/master/doc/user/cluster_tls.md</a></li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2024 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
