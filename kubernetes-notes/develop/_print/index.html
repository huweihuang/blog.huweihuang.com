<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/kubernetes-notes/develop/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/kubernetes-notes/develop/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>开发指南 | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="开发指南" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/kubernetes-notes/develop/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="开发指南">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="开发指南"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/kubernetes-notes/" ><span class="active">Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/k8s-source-code-analysis/" ><span>Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/linux-notes/" ><span>Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.54ee970df80c037329fb71398d405564.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/kubernetes-notes/develop/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">开发指南</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-73557ed651edbfdf7203caf9eea45f16">client-go的使用及源码分析</a></li>


    
  
    
    
	
<li>2: <a href="#pg-75c48100cb89c80d973b7c57a96377f6">operator开发</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-15fa0d56cfe1e152b7d82dfc0c656c29">kubebuilder的使用</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-e0f9d77a375a891566ac10e26e32ae95">如何开发一个Operator</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-c891529cb3c8cef200ec4a9ae6cf4cb7">CSI插件开发</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-3b99a3043c0685804c1f4dcda6d8a2d1">csi-provisioner源码分析</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-8e67c5a44cf8290f780929adc85773bf">nfs-client-provisioner源码分析</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-7b4726c5697dc81fca76b5397c272027">k8s社区开发指南</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-73557ed651edbfdf7203caf9eea45f16">1 - client-go的使用及源码分析</h1>
    
	<h1 id="1-client-go简介">1. client-go简介</h1>
<h2 id="1-1-client-go说明">1.1 client-go说明</h2>
<p>​	client-go是一个调用kubernetes集群资源对象API的客户端，即通过client-go实现对kubernetes集群中资源对象（包括deployment、service、ingress、replicaSet、pod、namespace、node等）的增删改查等操作。大部分对kubernetes进行前置API封装的二次开发都通过client-go这个第三方包来实现。</p>
<p>​	client-go官方文档：https://github.com/kubernetes/client-go</p>
<h2 id="1-2-示例代码">1.2 示例代码</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git clone https://github.com/huweihuang/client-go.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> client-go
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#保证本地HOME目录有配置kubernetes集群的配置文件</span>
</span></span><span style="display:flex;"><span>go run client-go.go
</span></span></code></pre></div><p><strong><a href="https://github.com/huweihuang/client-go/blob/master/client-go.go">client-go.go</a></strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;path/filepath&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metav1</span> <span style="color:#4e9a06">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">kubeconfig</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">home</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">homeDir</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">home</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeconfig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kubeconfig&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">home</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.kube&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;(optional) absolute path to the kubeconfig file&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeconfig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kubeconfig&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;absolute path to the kubeconfig file&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// uses the current context in kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientcmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuildConfigFromFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeconfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// creates the clientset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;There are %d pods in the cluster\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Items</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">homeDir</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HOME&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">h</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;USERPROFILE&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// windows
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-3-运行结果">1.3 运行结果</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>➜ go run client-go.go
</span></span><span style="display:flex;"><span>There are <span style="color:#0000cf;font-weight:bold">9</span> pods in the cluster
</span></span><span style="display:flex;"><span>There are <span style="color:#0000cf;font-weight:bold">7</span> pods in the cluster
</span></span><span style="display:flex;"><span>There are <span style="color:#0000cf;font-weight:bold">7</span> pods in the cluster
</span></span><span style="display:flex;"><span>There are <span style="color:#0000cf;font-weight:bold">7</span> pods in the cluster
</span></span><span style="display:flex;"><span>There are <span style="color:#0000cf;font-weight:bold">7</span> pods in the cluster
</span></span></code></pre></div><h1 id="2-client-go源码分析">2. client-go源码分析</h1>
<p><strong>client-go源码</strong>：https://github.com/kubernetes/client-go</p>
<p><strong>client-go源码目录结构</strong></p>
<ul>
<li>The <code>kubernetes</code> package contains the clientset to access Kubernetes API.</li>
<li>The <code>discovery</code> package is used to discover APIs supported by a Kubernetes API server.</li>
<li>The <code>dynamic</code> package contains a dynamic client that can perform generic operations on arbitrary Kubernetes API objects.</li>
<li>The <code>transport</code> package is used to set up auth and start a connection.</li>
<li>The <code>tools/cache</code> package is useful for writing controllers.</li>
</ul>
<h2 id="2-1-kubeconfig">2.1 kubeconfig</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#000">kubeconfig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kubeconfig&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">home</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.kube&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;(optional) absolute path to the kubeconfig file&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>获取kubernetes配置文件kubeconfig的绝对路径。一般路径为<code>$HOME/.kube/config</code>。该文件主要用来配置本地连接的kubernetes集群。</p>
<p>config内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>clusters:
</span></span><span style="display:flex;"><span>- cluster:
</span></span><span style="display:flex;"><span>    server: http://&lt;kube-master-ip&gt;:8080
</span></span><span style="display:flex;"><span>  name: k8s
</span></span><span style="display:flex;"><span>contexts:
</span></span><span style="display:flex;"><span>- context:
</span></span><span style="display:flex;"><span>    cluster: k8s
</span></span><span style="display:flex;"><span>    namespace: default
</span></span><span style="display:flex;"><span>    user: <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>  name: default
</span></span><span style="display:flex;"><span>current-context: default
</span></span><span style="display:flex;"><span>kind: Config
</span></span><span style="display:flex;"><span>preferences: <span style="color:#ce5c00;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>users: <span style="color:#ce5c00;font-weight:bold">[]</span>
</span></span></code></pre></div><h2 id="2-2-rest-config">2.2 rest.config</h2>
<p>通过参数（master的url或者kubeconfig路径）和<code>BuildConfigFromFlags</code>方法来获取<code>rest.Config</code>对象，一般是通过参数kubeconfig的路径。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientcmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuildConfigFromFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeconfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>BuildConfigFromFlags函数源码</strong></p>
<p><a href="https://github.com/kubernetes/client-go/blob/master/tools/clientcmd/client_config.go#L522">k8s.io/client-go/tools/clientcmd/client_config.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// BuildConfigFromFlags is a helper function that builds configs from a master
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// url or a kubeconfig filepath. These are passed in as command line flags for cluster
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// components. Warnings should reflect this usage. If neither masterUrl or kubeconfigPath
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// are passed in we fallback to inClusterConfig. If inClusterConfig fails, we fallback
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to the default config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">BuildConfigFromFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">masterUrl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeconfigPath</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">restclient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeconfigPath</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">masterUrl</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeconfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">restclient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InClusterConfig</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">kubeconfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error creating inClusterConfig, falling back to default config: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewNonInteractiveDeferredLoadingClientConfig</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ClientConfigLoadingRules</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">ExplicitPath</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">kubeconfigPath</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ConfigOverrides</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">ClusterInfo</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">clientcmdapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Server</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">masterUrl</span><span style="color:#000;font-weight:bold">}}).</span><span style="color:#000">ClientConfig</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-clientset">2.3 clientset</h2>
<p>通过<code>*rest.Config</code>参数和<code>NewForConfig</code>方法来获取<code>clientset</code>对象，<code>clientset</code>是多个<code>client</code>的集合，每个<code>client</code>可能包含不同版本的方法调用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="2-3-1-newforconfig">2.3.1 NewForConfig</h3>
<p><code>NewForConfig</code>函数就是初始化clientset中的每个client。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/clientset.go#L396">k8s.io/client-go/kubernetes/clientset.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewForConfig creates a new Clientset for the given config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">configShallowCopy</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">cs</span> <span style="color:#000">Clientset</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">appsV1beta1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">appsv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">configShallowCopy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">coreV1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">configShallowCopy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-3-2-clientset的结构体">2.3.2 clientset的结构体</h3>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/clientset.go#L118">k8s.io/client-go/kubernetes/clientset.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Clientset contains the clients for groups. Each group has exactly one
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// version included in a Clientset.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Clientset</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">discovery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DiscoveryClient</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">admissionregistrationV1alpha1</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">admissionregistrationv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdmissionregistrationV1alpha1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">appsV1beta1</span>                   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">appsv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">appsV1beta2</span>                   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">appsv1beta2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta2Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">authenticationV1</span>              <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">authenticationv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthenticationV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">authenticationV1beta1</span>         <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">authenticationv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthenticationV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">authorizationV1</span>               <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">authorizationv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthorizationV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">authorizationV1beta1</span>          <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">authorizationv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthorizationV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">autoscalingV1</span>                 <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">autoscalingv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AutoscalingV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">autoscalingV2beta1</span>            <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">autoscalingv2beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AutoscalingV2beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">batchV1</span>                       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">batchv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">batchV1beta1</span>                  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">batchv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">batchV2alpha1</span>                 <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">batchv2alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV2alpha1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">certificatesV1beta1</span>           <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">certificatesv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertificatesV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">coreV1</span>                        <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">extensionsV1beta1</span>             <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">extensionsv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">networkingV1</span>                  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">networkingv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NetworkingV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">policyV1beta1</span>                 <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">policyv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PolicyV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rbacV1</span>                        <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rbacv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rbacV1beta1</span>                   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rbacv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rbacV1alpha1</span>                  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rbacv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1alpha1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">schedulingV1alpha1</span>            <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulingv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingV1alpha1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">settingsV1alpha1</span>              <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">settingsv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SettingsV1alpha1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">storageV1beta1</span>                <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">storagev1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1beta1Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">storageV1</span>                     <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">storagev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1Client</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-3-3-clientset-interface">2.3.3 clientset.Interface</h3>
<p>clientset实现了以下的Interface，因此可以通过调用以下方法获得具体的client。例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><p><strong>clientset的方法集接口</strong></p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/clientset.go#L54">k8s.io/client-go/kubernetes/clientset.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Interface</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Discovery</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">discovery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DiscoveryInterface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AdmissionregistrationV1alpha1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">admissionregistrationv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdmissionregistrationV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Admissionregistration</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">admissionregistrationv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdmissionregistrationV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">appsv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AppsV1beta2</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">appsv1beta2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta2Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Apps</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">appsv1beta2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta2Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AuthenticationV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">authenticationv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthenticationV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">authenticationv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthenticationV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AuthenticationV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">authenticationv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthenticationV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AuthorizationV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">authorizationv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthorizationV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Authorization</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">authorizationv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthorizationV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AuthorizationV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">authorizationv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuthorizationV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AutoscalingV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">autoscalingv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AutoscalingV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Autoscaling</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">autoscalingv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AutoscalingV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AutoscalingV2beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">autoscalingv2beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AutoscalingV2beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BatchV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">batchv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Batch</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">batchv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BatchV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">batchv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">BatchV2alpha1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">batchv2alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BatchV2alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">CertificatesV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">certificatesv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertificatesV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Certificates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">certificatesv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertificatesV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Core</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">extensionsv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Extensions</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">extensionsv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NetworkingV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">networkingv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NetworkingV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Networking</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">networkingv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NetworkingV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PolicyV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">policyv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PolicyV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Policy</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">policyv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PolicyV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RbacV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">rbacv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Rbac</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">rbacv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RbacV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">rbacv1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RbacV1alpha1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">rbacv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RbacV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">SchedulingV1alpha1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">schedulingv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Scheduling</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">schedulingv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">SettingsV1alpha1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">settingsv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SettingsV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Settings</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">settingsv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SettingsV1alpha1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">StorageV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">storagev1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1beta1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">StorageV1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">storagev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated: please explicitly pick a version if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Storage</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">storagev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1Interface</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-4-corev1client">2.4 CoreV1Client</h2>
<p>我们以clientset中的<code>CoreV1Client</code>为例做分析。</p>
<p>通过传入的配置信息<code>rest.Config</code>初始化<code>CoreV1Client</code>对象。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/clientset.go#L464">k8s.io/client-go/kubernetes/clientset.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Go" data-lang="Go"><span style="display:flex;"><span><span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">coreV1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">configShallowCopy</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="2-4-1-corev1-newforconfig">2.4.1 corev1.NewForConfig</h3>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/core_client.go#L116:6">k8s.io/client-go/kubernetes/typed/core/v1/core_client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewForConfig creates a new CoreV1Client for the given config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">setConfigDefaults</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RESTClientFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>corev1.NewForConfig</code>方法本质是调用了<code>rest.RESTClientFor(&amp;config)</code>方法创建<code>RESTClient</code>对象，即<code>CoreV1Client</code>的本质就是一个<code>RESTClient</code>对象。</p>
<h3 id="2-4-2-corev1client结构体">2.4.2 CoreV1Client结构体</h3>
<p>以下是<code>CoreV1Client</code>结构体的定义：</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/core_client.go#L47:6">k8s.io/client-go/kubernetes/typed/core/v1/core_client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// CoreV1Client is used to interact with features provided by the  group.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">CoreV1Client</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">restClient</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>CoreV1Client</code>实现了<code>CoreV1Interface</code>的接口，即以下方法，从而对kubernetes的资源对象进行增删改查的操作。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/core_client.go#L51">k8s.io/client-go/kubernetes/typed/core/v1/core_client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//CoreV1Client的方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ComponentStatuses</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">ComponentStatusInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//ConfigMaps
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ConfigMaps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ConfigMapInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Endpoints
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Endpoints</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">EndpointsInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Events</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">EventInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">LimitRanges</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">LimitRangeInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Namespaces
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Namespaces</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">NamespaceInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Nodes</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">NodeInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">PersistentVolumeInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PersistentVolumeClaims</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PersistentVolumeClaimInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PodInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PodTemplates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PodTemplateInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//ReplicationControllers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ReplicationControllers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ReplicationControllerInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ResourceQuotas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ResourceQuotaInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Secrets</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">SecretInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Services
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServiceInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServiceAccounts</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServiceAccountInterface</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-4-3-corev1interface">2.4.3 CoreV1Interface</h3>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/core_client.go#L26">k8s.io/client-go/kubernetes/typed/core/v1/core_client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">CoreV1Interface</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ComponentStatusesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ConfigMapsGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">EndpointsGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">EventsGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">LimitRangesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NamespacesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NodesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PersistentVolumesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PersistentVolumeClaimsGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PodsGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PodTemplatesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReplicationControllersGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ResourceQuotasGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">SecretsGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ServicesGetter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ServiceAccountsGetter</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>CoreV1Interface</code>中包含了各种<code>kubernetes</code>对象的调用接口，例如<code>PodsGetter</code>是对kubernetes中<code>pod</code>对象增删改查操作的接口。<code>ServicesGetter</code>是对<code>service</code>对象的操作的接口。</p>
<h3 id="2-4-4-podsgetter">2.4.4 PodsGetter</h3>
<p>以下我们以<code>PodsGetter</code>接口为例分析<code>CoreV1Client</code>对<code>pod</code>对象的增删改查接口调用。</p>
<p>示例中的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><p><strong>CoreV1().Pods()</strong></p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/core_client.go#L87">k8s.io/client-go/kubernetes/typed/core/v1/core_client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PodInterface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">newPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>newPods()</strong></p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/pod.go#L54">k8s.io/client-go/kubernetes/typed/core/v1/pod.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// newPods returns a Pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">newPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CoreV1Client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ns</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>CoreV1().Pods()</code>的方法实际上是调用了<code>newPods()</code>的方法，创建了一个<code>pods</code>对象，<code>pods</code>对象继承了<code>rest.Interface</code>接口，即最终的实现本质是<code>RESTClient</code>的HTTP调用。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/pod.go#L48">k8s.io/client-go/kubernetes/typed/core/v1/pod.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pods implements PodInterface
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">pods</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ns</span>     <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>pods</code>对象实现了<code>PodInterface</code>接口。<code>PodInterface</code>定义了<code>pods</code>对象的增删改查等方法。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/pod.go#L34">k8s.io/client-go/kubernetes/typed/core/v1/pod.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodInterface has methods to work with Pod resources.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PodInterface</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeleteCollection</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listOptions</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Patch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pt</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PatchType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subresources</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PodExpansion</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>PodsGetter</strong></p>
<p>PodsGetter继承了PodInterface的接口。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/pod.go#L28">k8s.io/client-go/kubernetes/typed/core/v1/pod.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodsGetter has a method to return a PodInterface.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// A group&#39;s client should implement this interface.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PodsGetter</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PodInterface</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>Pods().List()</strong></p>
<p>pods.List()方法通过<code>RESTClient</code>的HTTP调用来实现对kubernetes的pod资源的获取。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/pod.go#L75">k8s.io/client-go/kubernetes/typed/core/v1/pod.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// List takes label and field selectors, and returns the list of Pods that match those selectors.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodList</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ns</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Resource</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pods&#34;</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">VersionedParams</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">scheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParameterCodec</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Do</span><span style="color:#000;font-weight:bold">().</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Into</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以上分析了<code>clientset.CoreV1().Pods(&quot;&quot;).List(metav1.ListOptions{})</code>对pod资源获取的过程，最终是调用<code>RESTClient</code>的方法实现。</p>
<h2 id="2-5-restclient">2.5 RESTClient</h2>
<p>以下分析<code>RESTClient</code>的创建过程及作用。</p>
<p><code>RESTClient</code>对象的创建同样是依赖传入的config信息。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/kubernetes/typed/core/v1/core_client.go#L121">k8s.io/client-go/kubernetes/typed/core/v1/core_client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RESTClientFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="2-5-1-rest-restclientfor">2.5.1 rest.RESTClientFor</h3>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/rest/config.go#L182">k8s.io/client-go/rest/config.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// RESTClientFor returns a RESTClient that satisfies the requested attributes on a client Config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// object. Note that a RESTClient may require fields that are optional when initializing a Client.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// A RESTClient created by this method is generic - it expects to operate on an API that follows
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the Kubernetes conventions, but may not be the Kubernetes API.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">RESTClientFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">qps</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QPS</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">burst</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Burst</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">baseURL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">versionedAPIPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">defaultServerUrlFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">transport</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">TransportFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">httpClient</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">transport</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultTransport</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">httpClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Transport</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">transport</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">httpClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewRESTClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">baseURL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">versionedAPIPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContentConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">qps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">burst</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimiter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">httpClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>RESTClientFor</code>函数调用了<code>NewRESTClient</code>的初始化函数。</p>
<h3 id="2-5-2-newrestclient">2.5.2 NewRESTClient</h3>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/rest/client.go#L91">k8s.io/client-go/rest/client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewRESTClient creates a new RESTClient. This client performs generic REST functions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// such as Get, Put, Post, and Delete on specified paths.  Codec controls encoding and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// decoding of responses from the server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewRESTClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">baseURL</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">versionedAPIPath</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span> <span style="color:#000">ContentConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">maxQPS</span> <span style="color:#204a87;font-weight:bold">float32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">maxBurst</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rateLimiter</span> <span style="color:#000">flowcontrol</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimiter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">client</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">base</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">baseURL</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">serializers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createSerializers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">base</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">base</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">versionedAPIPath</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">versionedAPIPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">contentConfig</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">serializers</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">serializers</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">createBackoffMgr</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">readExpBackoffConfig</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Throttle</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">throttle</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Client</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-5-3-restclient结构体">2.5.3 RESTClient结构体</h3>
<p>以下介绍RESTClient的结构体定义，RESTClient结构体中包含了<code>http.Client</code>，即本质上RESTClient就是一个<code>http.Client</code>的封装实现。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/rest/client.go#L54">k8s.io/client-go/rest/client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// RESTClient imposes common Kubernetes API conventions on a set of resource paths.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The baseURL is expected to point to an HTTP or HTTPS path that is the parent
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// of one or more resources.  The server should return a decodable API resource
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// object, or an api.Status object which contains information about the reason for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// any failure.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Most consumers should use client.New() to get a Kubernetes API client.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">RESTClient</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// base is the root URL for all invocations of the client
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">base</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// versionedAPIPath is a path segment connecting the base URL to the resource root
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">versionedAPIPath</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// contentConfig is the information used to communicate with the server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">contentConfig</span> <span style="color:#000">ContentConfig</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// serializers contain all serializers for underlying content type.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">serializers</span> <span style="color:#000">Serializers</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// creates BackoffManager that is passed to requests.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">createBackoffMgr</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">BackoffManager</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO extract this into a wrapper interface via the RESTClient interface in kubectl.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Throttle</span> <span style="color:#000">flowcontrol</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimiter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Set specific behavior of the client.  If not set http.DefaultClient will be used.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Client</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-5-4-restclient-interface">2.5.4 RESTClient.Interface</h3>
<p>RESTClient实现了以下的接口方法：</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/rest/client.go#L42">k8s.io/client-go/rest/client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Interface captures the set of operations for generically interacting with Kubernetes REST apis.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Interface</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">GetRateLimiter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">flowcontrol</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimiter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Verb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">verb</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Post</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Put</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Patch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pt</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PatchType</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Get</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">APIVersion</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersion</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在调用HTTP方法（Post()，Put()，Get()，Delete() ）时，实际上调用了Verb(verb string)函数。</p>
<p><a href="https://github.com/kubernetes/client-go/blob/87887458218a51f3944b2f4c553eb38173458e97/rest/client.go#L208">k8s.io/client-go/rest/client.go</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Verb begins a request with a verb (GET, POST, PUT, DELETE).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Example usage of RESTClient&#39;s request building interface:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// c, err := NewRESTClient(...)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// if err != nil { ... }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// resp, err := c.Verb(&#34;GET&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  Path(&#34;pods&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  SelectorParam(&#34;labels&#34;, &#34;area=staging&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  Timeout(10*time.Second).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  Do()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// if err != nil { ... }
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// list, ok := resp.(*api.PodList)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Verb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">verb</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Request</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">backoff</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createBackoffMgr</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">verb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">base</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">versionedAPIPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">contentConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serializers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backoff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Throttle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">verb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">base</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">versionedAPIPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">contentConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serializers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backoff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Throttle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>Verb</code>函数调用了<code>NewRequest</code>方法，最后调用<code>Do()</code>方法实现一个HTTP请求获取Result。</p>
<h2 id="2-6-总结">2.6 总结</h2>
<p><code>client-go</code>对kubernetes资源对象的调用，需要先获取kubernetes的配置信息，即<code>$HOME/.kube/config</code>。</p>
<p>整个调用的过程如下：</p>
<p>kubeconfig→rest.config→clientset→具体的client(CoreV1Client)→具体的资源对象(pod)→RESTClient→http.Client→HTTP请求的发送及响应</p>
<p>通过clientset中不同的client和client中不同资源对象的方法实现对kubernetes中资源对象的增删改查等操作，常用的client有<code>CoreV1Client</code>、<code>AppsV1beta1Client</code>、<code>ExtensionsV1beta1Client</code>等。</p>
<h1 id="3-client-go对k8s资源的调用">3. client-go对k8s资源的调用</h1>
<p><strong>创建clientset</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//获取kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kubeconfig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kubeconfig&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">home</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.kube&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;(optional) absolute path to the kubeconfig file&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建config	
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientcmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuildConfigFromFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeconfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建clientset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//具体的资源调用见以下例子
</span></span></span></code></pre></div><h2 id="3-1-deployment">3.1 deployment</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明deployment对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">deployment</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//构造deployment对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//更新deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//删除deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//查询deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//列出deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">deploymentList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//watch deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">watchInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><h2 id="3-2-service">3.2 service</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明service对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">service</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//构造service对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建service
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//更新service
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//删除service
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//查询service
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//列出service
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">serviceList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//watch service
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">watchInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Services</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><h2 id="3-3-ingress">3.3 ingress</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明ingress对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ingress</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//构造ingress对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建ingress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Ingresses</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//更新ingress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Ingresses</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//删除ingress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Ingresses</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//查询ingress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Ingresses</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">ingress</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//列出ingress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ingressList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Ingresses</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//watch ingress
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">watchInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Ingresses</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><h2 id="3-4-replicaset">3.4 replicaSet</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明replicaSet对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">replicaSet</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1beta1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSet</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//构造replicaSet对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建replicaSet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//更新replicaSet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//删除replicaSet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//查询replicaSet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">replicaSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//列出replicaSet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">replicaSetList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//watch replicaSet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">watchInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><p>新版的kubernetes中一般通过deployment来创建replicaSet，再通过replicaSet来控制pod。</p>
<h2 id="3-5-pod">3.5 pod</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明pod对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//更新pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//删除pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//查询pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//列出pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">podList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//watch pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">watchInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><h2 id="3-6-statefulset">3.6 statefulset</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//声明statefulset对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">statefulset</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatefulSet</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//创建statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//更新statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">&gt;)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//删除statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//查询statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">&gt;,</span> <span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//列出statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">statefulsetList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//watch statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">watchInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(&lt;</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">&gt;).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">meta_v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span></code></pre></div><p>​	通过以上对kubernetes的资源对象的操作函数可以看出，每个资源对象都有增删改查等方法，基本调用逻辑类似。一般二次开发只需要创建deployment、service、ingress三个资源对象即可，pod对象由deployment包含的replicaSet来控制创建和删除。函数调用的入参一般只有<code>NAMESPACE</code>和<code>kubernetesObject</code>两个参数，部分操作有<code>Options</code>的参数。在创建前，需要对资源对象构造数据，可以理解为编辑一个资源对象的yaml文件，然后通过<code>kubectl create -f xxx.yaml</code>来创建对象。</p>
<p>参考文档:</p>
<ul>
<li><a href="https://github.com/kubernetes/client-go">https://github.com/kubernetes/client-go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-75c48100cb89c80d973b7c57a96377f6">2 - operator开发</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-15fa0d56cfe1e152b7d82dfc0c656c29">2.1 - kubebuilder的使用</h1>
    
	<h1 id="1-kubebuilder">1. kubebuilder</h1>
<h2 id="1-1-安装kubebuilder">1.1. 安装kubebuilder</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># download kubebuilder and install locally.</span>
</span></span><span style="display:flex;"><span>curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/<span style="color:#204a87;font-weight:bold">$(</span>go env GOOS<span style="color:#204a87;font-weight:bold">)</span>/<span style="color:#204a87;font-weight:bold">$(</span>go env GOARCH<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>chmod +x kubebuilder <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> mv kubebuilder /usr/local/bin/
</span></span></code></pre></div><h2 id="1-2-kubebuilder命令">1.2. kubebuilder命令</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Development kit <span style="color:#204a87;font-weight:bold">for</span> building Kubernetes extensions and tools.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Provides libraries and tools to create new projects, APIs and controllers.
</span></span><span style="display:flex;"><span>Includes tools <span style="color:#204a87;font-weight:bold">for</span> packaging artifacts into an installer container.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Typical project lifecycle:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- initialize a project:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  kubebuilder init --domain example.com --license apache2 --owner <span style="color:#4e9a06">&#34;The Kubernetes authors&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- create one or more a new resource APIs and add your code to them:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  kubebuilder create api --group &lt;group&gt; --version &lt;version&gt; --kind &lt;Kind&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Create resource will prompt the user <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87;font-weight:bold">if</span> it should scaffold the Resource and / or Controller. To only
</span></span><span style="display:flex;"><span>scaffold a Controller <span style="color:#204a87;font-weight:bold">for</span> an existing Resource, <span style="color:#204a87;font-weight:bold">select</span> <span style="color:#4e9a06">&#34;n&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> Resource. To only define
</span></span><span style="display:flex;"><span>the schema <span style="color:#204a87;font-weight:bold">for</span> a Resource without writing a Controller, <span style="color:#204a87;font-weight:bold">select</span> <span style="color:#4e9a06">&#34;n&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> Controller.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>After the scaffold is written, api will run make on the project.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Usage:
</span></span><span style="display:flex;"><span>  kubebuilder <span style="color:#ce5c00;font-weight:bold">[</span>command<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Available Commands:
</span></span><span style="display:flex;"><span>  create      Scaffold a Kubernetes API or webhook.
</span></span><span style="display:flex;"><span>  edit        This <span style="color:#204a87">command</span> will edit the project configuration
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">help</span>        Help about any <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>  init        Initialize a new project
</span></span><span style="display:flex;"><span>  version     Print the kubebuilder version
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>  -h, --help   <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> kubebuilder
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Use <span style="color:#4e9a06">&#34;kubebuilder [command] --help&#34;</span> <span style="color:#204a87;font-weight:bold">for</span> more information about a command.
</span></span></code></pre></div><h1 id="2-操作步骤">2. 操作步骤</h1>
<h2 id="2-1-初始化">2.1. 初始化</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir <span style="color:#000">$GOPATH</span>/src/github.com/huweihuang/operator-example
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> <span style="color:#000">$GOPATH</span>/src/github.com/huweihuang/operator-example
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>go mod init github.com/huweihuang/operator-example
</span></span></code></pre></div><h2 id="2-2-创建项目">2.2. 创建项目</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubebuilder init --domain github.com --license apache2 --owner &#34;Hu Weihuang&#34;</span>
</span></span><span style="display:flex;"><span>Writing scaffold <span style="color:#204a87;font-weight:bold">for</span> you to edit...
</span></span><span style="display:flex;"><span>Get controller runtime:
</span></span><span style="display:flex;"><span>$ go get sigs.k8s.io/controller-runtime@v0.5.0
</span></span><span style="display:flex;"><span>Update go.mod:
</span></span><span style="display:flex;"><span>$ go mod tidy
</span></span><span style="display:flex;"><span>Running make:
</span></span><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span>go: creating new go.mod: module tmp
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io v0.2.5
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io/controller-tools/cmd v0.2.5
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io/controller-tools/cmd/controller-gen v0.2.5
</span></span><span style="display:flex;"><span>/Users/weihuanghu/go/bin/controller-gen object:headerFile<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;hack/boilerplate.go.txt&#34;</span> <span style="color:#000">paths</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;./...&#34;</span>
</span></span><span style="display:flex;"><span>go fmt ./...
</span></span><span style="display:flex;"><span>go vet ./...
</span></span><span style="display:flex;"><span>go build -o bin/manager main.go
</span></span><span style="display:flex;"><span>Next: define a resource with:
</span></span><span style="display:flex;"><span>$ kubebuilder create api
</span></span></code></pre></div><p>查看生成文件：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./
</span></span><span style="display:flex;"><span>├── Dockerfile
</span></span><span style="display:flex;"><span>├── Makefile
</span></span><span style="display:flex;"><span>├── PROJECT
</span></span><span style="display:flex;"><span>├── bin
</span></span><span style="display:flex;"><span>│   └── manager
</span></span><span style="display:flex;"><span>├── config
</span></span><span style="display:flex;"><span>│   ├── certmanager
</span></span><span style="display:flex;"><span>│   │   ├── certificate.yaml
</span></span><span style="display:flex;"><span>│   │   ├── kustomization.yaml
</span></span><span style="display:flex;"><span>│   │   └── kustomizeconfig.yaml
</span></span><span style="display:flex;"><span>│   ├── default
</span></span><span style="display:flex;"><span>│   │   ├── kustomization.yaml
</span></span><span style="display:flex;"><span>│   │   ├── manager_auth_proxy_patch.yaml
</span></span><span style="display:flex;"><span>│   │   ├── manager_webhook_patch.yaml
</span></span><span style="display:flex;"><span>│   │   └── webhookcainjection_patch.yaml
</span></span><span style="display:flex;"><span>│   ├── manager
</span></span><span style="display:flex;"><span>│   │   ├── kustomization.yaml
</span></span><span style="display:flex;"><span>│   │   └── manager.yaml
</span></span><span style="display:flex;"><span>│   ├── prometheus
</span></span><span style="display:flex;"><span>│   │   ├── kustomization.yaml
</span></span><span style="display:flex;"><span>│   │   └── monitor.yaml
</span></span><span style="display:flex;"><span>│   ├── rbac
</span></span><span style="display:flex;"><span>│   │   ├── auth_proxy_client_clusterrole.yaml
</span></span><span style="display:flex;"><span>│   │   ├── auth_proxy_role.yaml
</span></span><span style="display:flex;"><span>│   │   ├── auth_proxy_role_binding.yaml
</span></span><span style="display:flex;"><span>│   │   ├── auth_proxy_service.yaml
</span></span><span style="display:flex;"><span>│   │   ├── kustomization.yaml
</span></span><span style="display:flex;"><span>│   │   ├── leader_election_role.yaml
</span></span><span style="display:flex;"><span>│   │   ├── leader_election_role_binding.yaml
</span></span><span style="display:flex;"><span>│   │   └── role_binding.yaml
</span></span><span style="display:flex;"><span>│   └── webhook
</span></span><span style="display:flex;"><span>│       ├── kustomization.yaml
</span></span><span style="display:flex;"><span>│       ├── kustomizeconfig.yaml
</span></span><span style="display:flex;"><span>│       └── service.yaml
</span></span><span style="display:flex;"><span>├── go.mod
</span></span><span style="display:flex;"><span>├── go.sum
</span></span><span style="display:flex;"><span>├── hack
</span></span><span style="display:flex;"><span>│   └── boilerplate.go.txt
</span></span><span style="display:flex;"><span>└── main.go
</span></span></code></pre></div><h2 id="2-3-创建api">2.3. 创建API</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># kubebuilder create api --group webapp --version v1 --kind Guestbook</span>
</span></span><span style="display:flex;"><span>Create Resource <span style="color:#ce5c00;font-weight:bold">[</span>y/n<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>y
</span></span><span style="display:flex;"><span>Create Controller <span style="color:#ce5c00;font-weight:bold">[</span>y/n<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>y
</span></span><span style="display:flex;"><span>Writing scaffold <span style="color:#204a87;font-weight:bold">for</span> you to edit...
</span></span><span style="display:flex;"><span>api/v1/guestbook_types.go
</span></span><span style="display:flex;"><span>controllers/guestbook_controller.go
</span></span><span style="display:flex;"><span>Running make:
</span></span><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span>go: creating new go.mod: module tmp
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io/controller-tools/cmd v0.2.5
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io/controller-tools/cmd/controller-gen v0.2.5
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io v0.2.5
</span></span><span style="display:flex;"><span>/Users/weihuanghu/go/bin/controller-gen object:headerFile<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;hack/boilerplate.go.txt&#34;</span> <span style="color:#000">paths</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;./...&#34;</span>
</span></span><span style="display:flex;"><span>go fmt ./...
</span></span><span style="display:flex;"><span>go vet ./...
</span></span><span style="display:flex;"><span>go build -o bin/manager main.go
</span></span></code></pre></div><p>查看创建文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>api
</span></span><span style="display:flex;"><span>└── v1
</span></span><span style="display:flex;"><span>    ├── groupversion_info.go
</span></span><span style="display:flex;"><span>    ├── guestbook_types.go
</span></span><span style="display:flex;"><span>    └── zz_generated.deepcopy.go
</span></span><span style="display:flex;"><span>controllers
</span></span><span style="display:flex;"><span>├── guestbook_controller.go
</span></span><span style="display:flex;"><span>└── suite_test.go
</span></span></code></pre></div><p>查看api/v1/guestbook_types.go</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// GuestbookSpec defines the desired state of Guestbook
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">GuestbookSpec</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// INSERT ADDITIONAL SPEC FIELDS - desired state of cluster
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Quantity of instances
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +kubebuilder:validation:Minimum=1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +kubebuilder:validation:Maximum=10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Size</span> <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#4e9a06">`json:&#34;size&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Name of the ConfigMap for GuestbookSpec&#39;s configuration
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +kubebuilder:validation:MaxLength=15
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// +kubebuilder:validation:MinLength=1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">ConfigMapName</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;configMapName&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// +kubebuilder:validation:Enum=Phone;Address;Name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Type</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;alias,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// GuestbookStatus defines the observed state of Guestbook
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">GuestbookStatus</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// INSERT ADDITIONAL STATUS FIELD - define observed state of cluster
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// PodName of the active Guestbook node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Active</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;active&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// PodNames of the standby Guestbook nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Standby</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`json:&#34;standby&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// +kubebuilder:object:root=true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// +kubebuilder:subresource:status
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// +kubebuilder:resource:scope=Cluster
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Guestbook is the Schema for the guestbooks API
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Guestbook</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeMeta</span>   <span style="color:#4e9a06">`json:&#34;,inline&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span> <span style="color:#4e9a06">`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Spec</span>   <span style="color:#000">GuestbookSpec</span>   <span style="color:#4e9a06">`json:&#34;spec,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Status</span> <span style="color:#000">GuestbookStatus</span> <span style="color:#4e9a06">`json:&#34;status,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-troubleshooting">3. troubleshooting</h1>
<h2 id="3-1-controller-gen-no-such-file-or-directory">3.1. controller-gen: No such file or directory</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>➜  operator-example kubebuilder init --domain github.com --license apache2 --owner <span style="color:#4e9a06">&#34;Hu Weihuang&#34;</span>
</span></span><span style="display:flex;"><span>Writing scaffold <span style="color:#204a87;font-weight:bold">for</span> you to edit...
</span></span><span style="display:flex;"><span>Get controller runtime:
</span></span><span style="display:flex;"><span>$ go get sigs.k8s.io/controller-runtime@v0.5.0
</span></span><span style="display:flex;"><span>Update go.mod:
</span></span><span style="display:flex;"><span>$ go mod tidy
</span></span><span style="display:flex;"><span>Running make:
</span></span><span style="display:flex;"><span>$ make
</span></span><span style="display:flex;"><span>go: creating new go.mod: module tmp
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io v0.2.5
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io/controller-tools/cmd v0.2.5
</span></span><span style="display:flex;"><span>go: finding sigs.k8s.io/controller-tools/cmd/controller-gen v0.2.5
</span></span><span style="display:flex;"><span>/Users/weihuanghu/go:/Users/weihuanghu/k8spath/bin/controller-gen object:headerFile<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;hack/boilerplate.go.txt&#34;</span> <span style="color:#000">paths</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;./...&#34;</span>
</span></span><span style="display:flex;"><span>/bin/sh: /Users/weihuanghu/go:/Users/weihuanghu/k8spath/bin/controller-gen: No such file or directory
</span></span><span style="display:flex;"><span>make: *** <span style="color:#ce5c00;font-weight:bold">[</span>generate<span style="color:#ce5c00;font-weight:bold">]</span> Error <span style="color:#0000cf;font-weight:bold">127</span>
</span></span><span style="display:flex;"><span>2020/04/13 14:34:47 failed to initialize project: <span style="color:#204a87">exit</span> status <span style="color:#0000cf;font-weight:bold">2</span>
</span></span></code></pre></div><p>由于本地存在多个GOPATH的目录，而获取了非当前项目下的GOPATH目录，因此将当前项目所在的GOPATH目录export到GOPATH环境变量中，就可以解决。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">GOPATH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/path/to/gopath&#34;</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/">https://kubernetes.io/zh/docs/concepts/extend-kubernetes/operator/</a></li>
<li><a href="https://github.com/kubernetes-sigs/kubebuilder">https://github.com/kubernetes-sigs/kubebuilder</a></li>
<li><a href="https://book.kubebuilder.io/quick-start.html">https://book.kubebuilder.io/quick-start.html</a></li>
<li><a href="https://operatorhub.io/">https://operatorhub.io/</a></li>
<li><a href="https://devops.college/developing-kubernetes-operator-is-now-easy-with-operator-framework-d3194a7428ff">https://devops.college/developing-kubernetes-operator-is-now-easy-with-operator-framework-d3194a7428ff</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e0f9d77a375a891566ac10e26e32ae95">2.2 - 如何开发一个Operator</h1>
    
	<p>开发一个k8s operator组件主要会用到以下几个仓库或工具：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder">kubebuilder</a>/<a href="https://github.com/operator-framework/operator-sdk">operator-sdk</a>：主要用于创建CRD对象。</p>
</li>
<li>
<p><a href="https://github.com/kubernetes-sigs/controller-runtime">controller-manager</a>：主要用于实现operator的controller逻辑。</p>
</li>
</ul>
<p>本文以kubebuilder的工具和<a href="https://github.com/kubernetes-sigs/controller-runtime/blob/main/examples/crd/main.go">controller-manager example</a>为例。</p>
<h1 id="1-准备工具环境及创建项目">1. 准备工具环境及创建项目</h1>
<p>安装kubebuilder工具</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -L -o kubebuilder https://go.kubebuilder.io/dl/latest/<span style="color:#204a87;font-weight:bold">$(</span>go env GOOS<span style="color:#204a87;font-weight:bold">)</span>/<span style="color:#204a87;font-weight:bold">$(</span>go env GOARCH<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>chmod +x kubebuilder <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> mv kubebuilder /usr/local/bin/
</span></span></code></pre></div><p>创建operator项目目录</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubebuilder init --domain example.com --license apache2 --owner <span style="color:#4e9a06">&#34;Your Name&#34;</span> --repo github.com/example/my-operator
</span></span></code></pre></div><p>将 <code>example.com</code> 替换为你的域名，<code>Your Name</code> 替换为你的名字，<code>github.com/example/my-operator</code> 替换为你的 GitHub 仓库。</p>
<h1 id="2-创建crd对象">2. 创建CRD对象</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubebuilder create api --group mygroup --version v1alpha1 --kind MyResource
</span></span></code></pre></div><p>这将在 <code>api/v1alpha1</code> 文件夹中创建一个名为 <code>myresource_types.go</code> 的文件，其中定义了 <code>MyResource</code> 资源的规范和状态。</p>
<p>编辑 <code>api/v1alpha1/myresource_types.go</code> 文件，添加自定义资源的规范和状态字段。</p>
<h1 id="3-实现控制器逻辑">3. 实现控制器逻辑</h1>
<p>在 <code>controllers/myresource_controller.go</code> 文件中实现控制器逻辑。该部分是不同的CRD实现自定义逻辑的核心部分。</p>
<p>主要包含以下几个部分：</p>
<ol>
<li>
<p><strong>定义ReconcileMyResource结构体。</strong></p>
</li>
<li>
<p><strong>实现<code>func (r *ReconcileMyResource) Reconcile(ctx context.Context, request reconcile.Request) (reconcile.Result, error)</code>函数接口。</strong></p>
</li>
<li>
<p><strong>定义finalizer逻辑。</strong></p>
</li>
<li>
<p><strong>定义reconcile逻辑。</strong></p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">controllers</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;github.com/go-logr/logr&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/controller/controllerutil&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/controller/inject&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/reconcile&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">myv1alpha1</span> <span style="color:#4e9a06">&#34;github.com/example/my-operator/api/v1alpha1&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">corev1</span> <span style="color:#4e9a06">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;k8s.io/apimachinery/pkg/api/errors&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/client&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/controller&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">logf</span> <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/log&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/log/zap&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/manager&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/reconcile&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;sigs.k8s.io/controller-runtime/pkg/source&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">log</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">logf</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;controller_myresource&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Add creates a new MyResource Controller and adds it to the Manager. The Manager will set fields on the Controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and Start it when the Manager is Started.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newReconciler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// newReconciler returns a new reconcile.Reconciler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">newReconciler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reconciler</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ReconcileMyResource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetClient</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">scheme</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetScheme</span><span style="color:#000;font-weight:bold">()}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// blank assignment to verify that ReconcileMyResource implements reconcile.Reconciler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">_</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reconciler</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ReconcileMyResource</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ReconcileMyResource reconciles a MyResource object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ReconcileMyResource</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">client</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">scheme</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Reconcile reads that state of the cluster for a MyResource object and makes changes based on the state read
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and what is in the MyResource.Spec
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ReconcileMyResource</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Reconcile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">reqLogger</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Namespace&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">reqLogger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Reconciling MyResource&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Fetch the MyResource instance
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">myresource</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">myv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MyResource</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespacedName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">myresource</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotFound</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// Request object not found, could have been deleted after reconcile request.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// Owned objects are automatically garbage collected. For additional cleanup logic use finalizers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// Return and don&#39;t requeue
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Result</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Error reading the object - requeue the request.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Result</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Add finalizer logic here
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Add reconcile logic here
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Result</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-注册控制器">4. 注册控制器</h1>
<p>在 <code>main.go</code> 文件中注册控制器，主要包含以下几个步骤</p>
<ol>
<li>
<p><strong>ctrl.SetLogger(zap.New())：注册日志工具</strong></p>
</li>
<li>
<p><strong>ctrl.NewManager：创建一个manager，必要时可设置选主逻辑。</strong></p>
</li>
<li>
<p><strong>ctrl.NewControllerManagedBy(mgr)：预计mgr创建manager controller并注册Reconciler。</strong></p>
</li>
<li>
<p><strong>mgr.Start(ctrl.SetupSignalHandler()): 运行mgr。</strong></p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// set logger
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLogger</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">zap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Set up a Manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetConfigOrDie</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Options</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">myv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchemeBuilder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">MetricsBindAddress</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">metricsHost</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">Port</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#0000cf;font-weight:bold">9443</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">enableLeaderElection</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">LeaderElectionID</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;my-operator-lock&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unable to start manager&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// in a real controller, we&#39;d create a new scheme for this
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddToScheme</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetScheme</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unable to add scheme&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Create a new Reconciler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ReconcileMyResource</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetClient</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">scheme</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetScheme</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Create a new Controller and register the Reconciler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerManagedBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">For</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">myv1alpha1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MyResource</span><span style="color:#000;font-weight:bold">{}).</span>     <span style="color:#8f5902;font-style:italic">// 自定义crd
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>                        <span style="color:#8f5902;font-style:italic">// 注册Reconciler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unable to create controller&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewWebhookManagedBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">For</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ChaosPod</span><span style="color:#000;font-weight:bold">{}).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unable to create webhook&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;starting manager&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetupSignalHandler</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;problem running manager&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li>
<p><a href="https://book.kubebuilder.io/cronjob-tutorial/controller-implementation.html">Implementing a controller - The Kubebuilder Book</a></p>
</li>
<li>
<p><a href="https://qiankunli.github.io/2020/08/10/controller_runtime.html">controller-runtime源码分析 | 李乾坤的博客</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder">Kubebuilder - SDK for building Kubernetes APIs using CRDs</a></p>
</li>
<li>
<p><a href="https://github.com/operator-framework/operator-sdk">operator-framework/operator-sdk: SDK for building Kubernetes applications.</a></p>
</li>
<li>
<p><a href="https://blog.hdls.me/16500403497126.html">https://blog.hdls.me/16500403497126.html</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes-sigs/kubebuilder/blob/master/docs/book/src/multiversion-tutorial/testdata/project/controllers/cronjob_controller.go">kubebuilder-cronjob_controller</a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c891529cb3c8cef200ec4a9ae6cf4cb7">3 - CSI插件开发</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-3b99a3043c0685804c1f4dcda6d8a2d1">3.1 - csi-provisioner源码分析</h1>
    
	<blockquote>
<p>本文主要分析<code>csi-provisioner</code>的源码，关于开发一个<code>Dynamic Provisioner</code>，具体可参考<a href="https://www.huweihuang.com/kubernetes-notes/develop/nfs-client-provisioner.html">nfs-client-provisioner的源码分析</a></p>
</blockquote>
<h1 id="1-dynamic-provisioner">1. Dynamic Provisioner</h1>
<h2 id="1-1-provisioner-interface">1.1. Provisioner Interface</h2>
<p>开发<code>Dynamic Provisioner</code>需要实现<a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/volume.go#L29">Provisioner</a>接口，该接口有两个方法，分别是：</p>
<ul>
<li>Provision：创建存储资源，并且返回一个PV对象。</li>
<li>Delete：移除对应的存储资源，但并没有删除PV对象。</li>
</ul>
<h2 id="1-2-开发provisioner的步骤">1.2. 开发provisioner的步骤</h2>
<ol>
<li>写一个<code>provisioner</code>实现<code>Provisioner</code>接口（包含<code>Provision</code>和<code>Delete</code>的方法）。</li>
<li>通过该<code>provisioner</code>构建<code>ProvisionController</code>。</li>
<li>执行<code>ProvisionController</code>的<code>Run</code>方法。</li>
</ol>
<h1 id="2-csi-provisioner">2. CSI Provisioner</h1>
<p>CSI Provisioner的源码可参考：https://github.com/kubernetes-csi/external-provisioner。</p>
<h2 id="2-1-main-函数-https-github-com-kubernetes-csi-external-provisioner-blob-master-cmd-csi-provisioner-csi-provisioner-go">2.1. <a href="https://github.com/kubernetes-csi/external-provisioner/blob/master/cmd/csi-provisioner/csi-provisioner.go">Main 函数</a></h2>
<h3 id="2-1-1-读取环境变量">2.1.1. 读取环境变量</h3>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisioner</span>          <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;provisioner&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Name of the provisioner. The provisioner will only provision volumes for claims that request a StorageClass with a provisioner field set equal to this name.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">master</span>               <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;master&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Master URL to build a client config from. Either this or kubeconfig needs to be set if the provisioner is being run out of cluster.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeconfig</span>           <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kubeconfig&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Absolute path to the kubeconfig file. Either this or master needs to be set if the provisioner is being run out of cluster.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">csiEndpoint</span>          <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;csi-address&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/run/csi/socket&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;The gRPC endpoint for Target CSI Volume&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">connectionTimeout</span>    <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;connection-timeout&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Timeout for waiting for CSI driver socket.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeNamePrefix</span>     <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;volume-name-prefix&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;pvc&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Prefix to apply to the name of a created volume&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeNameUUIDLength</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;volume-name-uuid-length&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Truncates generated UUID of a created volume to this length. Defaults behavior is to NOT truncate.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">showVersion</span>          <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;version&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Show version.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisionController</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProvisionController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">version</span>             <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;unknown&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;logtostderr&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">showVersion</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Version: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>	
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>	
</span></span></code></pre></div><p>通过<code>init函数</code>解析相关参数，其实<code>provisioner</code>指明为PVC提供PV的provisioner的名字，需要和<code>StorageClass</code>对象中的<code>provisioner</code>字段一致。</p>
<h3 id="2-1-2-获取clientset对象">2.1.2. 获取clientset对象</h3>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// get the KUBECONFIG from env if specified (useful for local/debug cluster)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kubeconfigEnv</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KUBECONFIG&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeconfigEnv</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Found KUBECONFIG environment variable set, using that..&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeconfig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeconfigEnv</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">master</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeconfig</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Either master or kubeconfig specified. building kube config from that..&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">clientcmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuildConfigFromFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">master</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeconfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Building kube configs for running in cluster...&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InClusterConfig</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create config: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create client: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// snapclientset.NewForConfig creates a new Clientset for VolumesnapshotV1alpha1Client
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">snapClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">snapclientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create snapshot client: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">csiAPIClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csiclientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create CSI API client: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过读取对应的k8s的配置，创建<code>clientset</code>对象，用来执行k8s对应的API，其中主要包括对PV和PVC等对象的创建删除等操作。</p>
<h3 id="2-1-3-k8s版本校验">2.1.3. k8s版本校验</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The controller needs to know what the server version is because out-of-tree
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// provisioners aren&#39;t officially supported until 1.5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">serverVersion</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Discovery</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ServerVersion</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error getting server version: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>获取了k8s的版本信息，因为provisioners的功能在k8s 1.5及以上版本才支持。</p>
<h3 id="2-1-4-连接-csi-socket">2.1.4. 连接 csi socket</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Generate a unique ID for this provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">timeStamp</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UnixNano</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">identity</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormatInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">timeStamp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;-&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Itoa</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Intn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;-&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">provisioner</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Provisioner will stay in Init until driver opens csi socket, once it&#39;s done
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// controller will exit this loop and proceed normally.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">socketDown</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000">grpcClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConn</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">socketDown</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">csiEndpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connectionTimeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">socketDown</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在<code>Provisioner</code>会停留在初始化状态，直到<code>csi socket</code>连接成功才正常运行。如果连接失败，会暂停<code>10秒</code>后重试，其中涉及以下2个参数：</p>
<ul>
<li>csiEndpoint：CSI Volume的gRPC地址，默认通过为<code>/run/csi/socket</code>。</li>
<li>connectionTimeout：连接CSI driver socket的超时时间，默认为10秒。</li>
</ul>
<h3 id="2-1-5-构造csi-provisioner对象">2.1.5. 构造csi-Provisioner对象</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create the provisioner: it implements the Provisioner interface expected by
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">csiProvisioner</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCSIProvisioner</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">csiAPIClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">csiEndpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connectionTimeout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">identity</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">volumeNamePrefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">volumeNameUUIDLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">snapClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">provisionController</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewProvisionController</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">csiProvisioner</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">serverVersion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GitVersion</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>通过参数<code>clientset</code>,<code> csiAPIClient</code>, <code>csiEndpoint</code>, <code>connectionTimeout</code>, <code>identity</code>, <code>volumeNamePrefix</code>, <code>volumeNameUUIDLength</code>,<code> grpcClient</code>, <code>snapClient</code>构造csi-Provisioner对象。</p>
<p>通过<code>csiProvisioner</code>构造<code>ProvisionController</code>对象。</p>
<h3 id="2-1-6-运行provisioncontroller">2.1.6. 运行ProvisionController</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisionController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>ProvisionController</code>实现了具体的PV和PVC的相关逻辑，<code>Run</code>方法以常驻进程的方式运行。</p>
<h2 id="2-2-provision-https-github-com-kubernetes-csi-external-provisioner-blob-master-pkg-controller-controller-go-l336-和-delete-https-github-com-kubernetes-csi-external-provisioner-blob-master-pkg-controller-controller-go-l606-方法">2.2. <a href="https://github.com/kubernetes-csi/external-provisioner/blob/master/pkg/controller/controller.go#L336">Provision</a>和<a href="https://github.com/kubernetes-csi/external-provisioner/blob/master/pkg/controller/controller.go#L606">Delete</a>方法</h2>
<h3 id="2-2-1-provision方法">2.2.1. Provision方法</h3>
<blockquote>
<p><code>csiProvisioner</code>的<code>Provision</code>方法具体源码参考：https://github.com/kubernetes-csi/external-provisioner/blob/master/pkg/controller/controller.go#L336</p>
</blockquote>
<p><code>Provision</code>方法用来创建存储资源，并且返回一个<code>PV</code>对象。其中入参是<code>VolumeOptions</code>，用来指定<code>PV</code>对象的相关属性。</p>
<p><strong>1、构造PV相关属性</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">makeVolumeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeNamePrefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeNameUUIDLength</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>2、构造CSIPersistentVolumeSource相关属性</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">driverState</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">checkDriverState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">needSnapshotSupport</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Resolve controller publish, node stage, node publish secret references
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">controllerPublishSecretRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getSecretReference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerPublishSecretNameKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerPublishSecretNamespaceKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">nodeStageSecretRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getSecretReference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeStageSecretNameKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeStageSecretNamespaceKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">nodePublishSecretRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getSecretReference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodePublishSecretNameKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodePublishSecretNamespaceKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">volumeAttributes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">provisionerIDKey</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">identity</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Attributes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeAttributes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">fsType</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ToLower</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;fstype&#34;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fsType</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fsType</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fsType</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">defaultFSType</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>3、创建CSI CreateVolumeRequest</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create a CSI CreateVolumeRequest and Response
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateVolumeRequest</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">VolumeCapabilities</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">volumeCaps</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">CapacityRange</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CapacityRange</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">RequiredBytes</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volSizeBytes</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CreateVolumeRequest %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">rep</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateVolumeResponse</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backoff</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backoffDuration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Factor</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backoffFactor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Steps</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backoffSteps</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExponentialBackoff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rep</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// CreateVolume has finished successfully
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FromError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">codes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeadlineExceeded</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// CreateVolume timed out, give it another chance to complete
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CreateVolume timeout: %s has expired, operation will be retried&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// CreateVolume failed , no reason to retry, bailing from ExponentialBackoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volume</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create volume rep: %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volume</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">respCap</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetVolume</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">GetCapacityBytes</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">respCap</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">volSizeBytes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">capErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;created volume capacity %v less than requested capacity %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">respCap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volSizeBytes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">delReq</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolumeRequest</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">VolumeId</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetVolume</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">GetId</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">delReq</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerDeleteSecrets</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">provisionerCredentials</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">delReq</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">capErr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%v. Cleanup of volume %s failed, volume is orphaned: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">capErr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">capErr</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>Provison</code>方法核心功能是调用<code>p.csiClient.CreateVolume(ctx, &amp;req)</code>。</p>
<p><strong>4、构造PV对象</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pv</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeSpec</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">PersistentVolumeReclaimPolicy</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeReclaimPolicy</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AccessModes</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AccessModes</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Capacity</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceList</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceStorage</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#000">bytesToGiQuantity</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">respCap</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// TODO wait for CSI VolumeSource API
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">PersistentVolumeSource</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeSource</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">CSI</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CSIPersistentVolumeSource</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Driver</span><span style="color:#000;font-weight:bold">:</span>                     <span style="color:#000">driverState</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">driverName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">VolumeHandle</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeIdToHandle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Id</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">FSType</span><span style="color:#000;font-weight:bold">:</span>                     <span style="color:#000">fsType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">VolumeAttributes</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">volumeAttributes</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">ControllerPublishSecretRef</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">controllerPublishSecretRef</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">NodeStageSecretRef</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">nodeStageSecretRef</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">NodePublishSecretRef</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">nodePublishSecretRef</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">driverState</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">capabilities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Has</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PluginCapability_ACCESSIBILITY_CONSTRAINTS</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeAffinity</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">GenerateVolumeNodeAffinity</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AccessibleTopology</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;successfully created PV %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeSource</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pv</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span></code></pre></div><p><code>Provision</code>方法只是通过<code>VolumeOptions</code>参数来构建<code>PV</code>对象，并没有执行具体<code>PV</code>的创建或删除的操作。</p>
<p>不同类型的<code>Provisioner</code>的，一般是<code>PersistentVolumeSource</code>类型和参数不同，例如<code>csi-provisioner</code>对应的<code>PersistentVolumeSource</code>为<code>CSI</code>，并且需要传入<code>CSI</code>相关的参数：</p>
<ul>
<li><code>Driver</code></li>
<li><code>VolumeHandle</code></li>
<li><code>FSType</code></li>
<li><code>VolumeAttributes</code></li>
<li><code>ControllerPublishSecretRef</code></li>
<li><code>NodeStageSecretRef</code></li>
<li><code>NodePublishSecretRef</code></li>
</ul>
<h3 id="2-2-2-delete方法">2.2.2. Delete方法</h3>
<blockquote>
<p><code>csiProvisioner</code>的<code>delete</code>方法具体源码参考：https://github.com/kubernetes-csi/external-provisioner/blob/master/pkg/controller/controller.go#L606</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">csiProvisioner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CSI</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;invalid CSI PV&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeId</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeHandleToId</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CSI</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumeHandle</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">checkDriverState</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolumeRequest</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">VolumeId</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">volumeId</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// get secrets if StorageClass specifies it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">storageClassName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageClassName</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">storageClassName</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">storageClass</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StorageClasses</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">storageClassName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{});</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Resolve provision secret credentials.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// No PVC is provided when resolving provision/delete secret names, since the PVC may or may not exist at delete time.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">provisionerSecretRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getSecretReference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">provisionerSecretNameKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">provisionerSecretNamespaceKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">storageClass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">credentials</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getCredentials</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">provisionerSecretRef</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerDeleteSecrets</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">credentials</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>Delete</code>方法主要是调用了<code>p.csiClient.DeleteVolume(ctx, &amp;req)</code>方法。</p>
<h2 id="2-3-总结">2.3. 总结</h2>
<p><code>csi provisioner</code>实现了<code>Provisioner</code>接口，其中包含<code>Provison</code>和<code>Delete</code>两个方法:</p>
<ul>
<li><code>Provision</code>：调用<code>csiClient.CreateVolume</code>方法，同时构造并返回PV对象。</li>
<li><code>Delete</code>：调用<code>csiClient.DeleteVolume</code>方法。</li>
</ul>
<p><code>csi provisioner</code>的核心方法都调用了<code>csi-client</code>相关方法。</p>
<h1 id="3-csi-client">3. csi-client</h1>
<blockquote>
<p><code>csi client</code>的相关代码参考：https://github.com/container-storage-interface/spec/blob/master/lib/go/csi/v0/csi.pb.go</p>
</blockquote>
<h2 id="3-1-构造csi-client">3.1. 构造csi-client</h2>
<h3 id="3-1-1-构造grpcclient">3.1.1. 构造grpcClient</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Provisioner will stay in Init until driver opens csi socket, once it&#39;s done
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// controller will exit this loop and proceed normally.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">socketDown</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000">grpcClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConn</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">socketDown</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">csiEndpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connectionTimeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">socketDown</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过连接<code>csi socket</code>，连接成功才构造可用的<code>grpcClient</code>。</p>
<h3 id="3-1-2-构造csi-client">3.1.2. 构造csi-client</h3>
<p>通过<code>grpcClient</code>构造<code>csi-client</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create the provisioner: it implements the Provisioner interface expected by
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">csiProvisioner</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCSIProvisioner</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">csiAPIClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">csiEndpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">connectionTimeout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">identity</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">volumeNamePrefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">volumeNameUUIDLength</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">snapClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>NewCSIProvisioner</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewCSIProvisioner creates new CSI provisioner
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewCSIProvisioner</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">csiAPIClient</span> <span style="color:#000">csiclientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">csiEndpoint</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">connectionTimeout</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">identity</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeNamePrefix</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeNameUUIDLength</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">grpcClient</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConn</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">snapshotClient</span> <span style="color:#000">snapclientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Provisioner</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">csiClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisioner</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">csiProvisioner</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">csiAPIClient</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">csiAPIClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">snapshotClient</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">snapshotClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">connectionTimeout</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">identity</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">identity</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">volumeNamePrefix</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">volumeNamePrefix</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">volumeNameUUIDLength</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">volumeNameUUIDLength</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">provisioner</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong><a href="https://github.com/container-storage-interface/spec/blob/master/lib/go/csi/v0/csi.pb.go#L4353">NewControllerClient</a></strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">csiClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">grpcClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">controllerClient</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConn</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewControllerClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ControllerClient</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">controllerClient</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">cc</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-csiclient-createvolume">3.2. csiClient.CreateVolume</h2>
<p><code>csi provisoner</code>中调用<code>csiClient.CreateVolume</code>代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backoff</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backoffDuration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Factor</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backoffFactor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Steps</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">backoffSteps</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExponentialBackoff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rep</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// CreateVolume has finished successfully
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FromError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">codes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeadlineExceeded</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// CreateVolume timed out, give it another chance to complete
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CreateVolume timeout: %s has expired, operation will be retried&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// CreateVolume failed , no reason to retry, bailing from ExponentialBackoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><p><strong>CreateVolumeRequest的构造：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create a CSI CreateVolumeRequest and Response
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateVolumeRequest</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">VolumeCapabilities</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">volumeCaps</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">CapacityRange</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CapacityRange</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">RequiredBytes</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volSizeBytes</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumeContentSource</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">volumeContentSource</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AccessibilityRequirements</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">requirements</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerCreateSecrets</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">provisionerCredentials</span>
</span></span></code></pre></div><p><strong>具体的<code>Create</code>实现方法如下：</strong></p>
<blockquote>
<p>其中<code>csiClient</code>是个接口类型</p>
</blockquote>
<p>具体代码参考<a href="https://github.com/container-storage-interface/spec/blob/master/lib/go/csi/v0/csi.pb.go#L4357">controllerClient.CreateVolume</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controllerClient</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">CreateVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">in</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CreateVolumeRequest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CallOption</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CreateVolumeResponse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">CreateVolumeResponse</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Invoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/csi.v0.Controller/CreateVolume&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">in</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-csiclient-deletevolume">3.3. csiClient.DeleteVolume</h2>
<p><code>csi provisoner</code>中调用<code>csiClient.DeleteVolume</code>代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">csiProvisioner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolumeRequest</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">VolumeId</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">volumeId</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// get secrets if StorageClass specifies it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>DeleteVolumeRequest的构造：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteVolumeRequest</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">VolumeId</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">volumeId</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerDeleteSecrets</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">credentials</span>
</span></span></code></pre></div><p>将构造的<code>DeleteVolumeRequest</code>传给<code>DeleteVolume</code>方法。</p>
<p><strong>具体的<code>Delete</code>实现方法如下：</strong></p>
<p>具体代码参考：<a href="https://github.com/container-storage-interface/spec/blob/master/lib/go/csi/v0/csi.pb.go#L4366">controllerClient.DeleteVolume</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controllerClient</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">DeleteVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">in</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeleteVolumeRequest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CallOption</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeleteVolumeResponse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">out</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DeleteVolumeResponse</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Invoke</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/csi.v0.Controller/DeleteVolume&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">in</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">out</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-provisioncontroller-run-https-github-com-kubernetes-incubator-external-storage-blob-master-lib-controller-controller-go-l565">4. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L565">ProvisionController.Run</a></h1>
<p>自定义的<code>provisioner</code>实现了<code>Provisoner接口</code>的<code>Provision</code>和<code>Delete</code>方法，这两个方法主要对后端存储做创建和删除操作，并没有对PV对象进行创建和删除操作。</p>
<p>PV对象的相关操作具体由<code>ProvisionController</code>中的<code>provisionClaimOperation</code>和<code>deleteVolumeOperation</code>具体执行，同时调用了具体<code>provisioner</code>的<code>Provision</code>和<code>Delete</code>两个方法来对存储数据做处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisionController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>这块代码逻辑可参考：<a href="https://www.huweihuang.com/kubernetes-notes/develop/nfs-client-provisioner.html#3-provisioncontroller">nfs-client-provisioner 源码分析</a></p>
<p>参考文章：</p>
<ul>
<li><a href="https://github.com/kubernetes-csi/external-provisioner">https://github.com/kubernetes-csi/external-provisioner</a></li>
<li><a href="https://github.com/container-storage-interface/spec">https://github.com/container-storage-interface/spec</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/storage/container-storage-interface.md">https://github.com/kubernetes/community/blob/master/contributors/design-proposals/storage/container-storage-interface.md</a></li>
<li><a href="https://github.com/container-storage-interface/spec/blob/master/spec.md">https://github.com/container-storage-interface/spec/blob/master/spec.md</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8e67c5a44cf8290f780929adc85773bf">3.2 - nfs-client-provisioner源码分析</h1>
    
	<blockquote>
<p>如果要开发一个<code>Dynamic Provisioner</code>，需要使用到<a href="https://github.com/kubernetes-incubator/external-storage/tree/master/lib">the helper library</a>。</p>
</blockquote>
<h1 id="1-dynamic-provisioner">1. Dynamic Provisioner</h1>
<h2 id="1-1-provisioner-interface">1.1. Provisioner Interface</h2>
<p>开发<code>Dynamic Provisioner</code>需要实现<a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/volume.go#L29">Provisioner</a>接口，该接口有两个方法，分别是：</p>
<ul>
<li>Provision：创建存储资源，并且返回一个PV对象。</li>
<li>Delete：移除对应的存储资源，但并没有删除PV对象。</li>
</ul>
<p><a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/volume.go#L29">Provisioner</a> 接口源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Provisioner is an interface that creates templates for PersistentVolumes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and can create the volume as a new resource in the infrastructure provider.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It can also remove the volume it created from the underlying storage
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// provider.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Provisioner</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Provision creates a volume i.e. the storage asset and returns a PV object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// for the volume
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Provision</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">VolumeOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Delete removes the storage asset that was created by Provision backing the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// given PV. Does not delete the PV object itself.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// May return IgnoredError to indicate that the call has been ignored and no
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// action taken.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-2-volumeoptions">1.2. VolumeOptions</h2>
<p><code>Provisioner</code>接口的<code>Provision</code>方法的入参是一个<code>VolumeOptions</code>对象。<code>VolumeOptions</code>对象包含了创建PV对象所需要的信息，例如：PV的回收策略，PV的名字，PV所对应的PVC对象以及PVC的<code>StorageClass</code>对象使用的参数等。</p>
<p><a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/volume.go#L73">VolumeOptions</a> 源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// VolumeOptions contains option information about a volume
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// https://github.com/kubernetes/kubernetes/blob/release-1.4/pkg/volume/plugins.go
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">VolumeOptions</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Reclamation policy for a persistent volume
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">PersistentVolumeReclaimPolicy</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeReclaimPolicy</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// PV.Name of the appropriate PersistentVolume. Used to generate cloud
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// volume name.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">PVName</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// PV mount options. Not validated - mount of the PVs will simply fail if one is invalid.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">MountOptions</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// PVC is reference to the claim that lead to provisioning of a new PV.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Provisioners *must* create a PV that would be matched by this PVC,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// i.e. with required capacity, accessMode, labels matching PVC.Selector and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// so on.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">PVC</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Volume provisioning parameters from StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Parameters</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Node selected by the scheduler for the volume.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">SelectedNode</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Topology constraint parameter from StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">AllowedTopologies</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TopologySelectorTerm</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-3-provisioncontroller">1.3. ProvisionController</h2>
<p><code>ProvisionController</code>是一个给PVC提供PV的控制器，具体执行<code>Provisioner</code>接口的<code>Provision</code>和<code>Delete</code>的方法的所有逻辑。</p>
<h2 id="1-4-开发provisioner的步骤">1.4. 开发provisioner的步骤</h2>
<ol>
<li>写一个<code>provisioner</code>实现<code>Provisioner</code>接口（包含<code>Provision</code>和<code>Delete</code>的方法）。</li>
<li>通过该<code>provisioner</code>构建<code>ProvisionController</code>。</li>
<li>执行<code>ProvisionController</code>的<code>Run</code>方法。</li>
</ol>
<h1 id="2-nfs-client-provisioner">2. NFS Client Provisioner</h1>
<p><code>nfs-client-provisioner</code>是一个<code>automatic provisioner</code>，使用NFS作为存储，自动创建PV和对应的PVC，本身不提供NFS存储，需要外部先有一套NFS存储服务。</p>
<ul>
<li>PV以 <code>${namespace}-${pvcName}-${pvName}</code>的命名格式提供（在NFS服务器上）</li>
<li>PV回收的时候以 <code>archieved-${namespace}-${pvcName}-${pvName}</code> 的命名格式（在NFS服务器上）</li>
</ul>
<p>以下通过<code>nfs-client-provisioner</code>的源码分析来说明开发自定义<code>provisioner</code>整个过程。<code>nfs-client-provisioner</code>的主要代码都在<a href="https://github.com/kubernetes-incubator/external-storage/blob/master/nfs-client/cmd/nfs-client-provisioner/provisioner.go">provisioner.go</a>的文件中。</p>
<blockquote>
<p><code>nfs-client-provisioner</code>源码地址：https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client</p>
</blockquote>
<h2 id="2-1-main函数-https-github-com-kubernetes-incubator-external-storage-blob-master-nfs-client-cmd-nfs-client-provisioner-provisioner-go-l148">2.1. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/nfs-client/cmd/nfs-client-provisioner/provisioner.go#L148">Main函数</a></h2>
<h3 id="2-1-1-读取环境变量">2.1.1. 读取环境变量</h3>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;logtostderr&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NFS_SERVER&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NFS_SERVER not set&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NFS_PATH&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NFS_PATH not set&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisionerName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">provisionerNameKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">provisionerName</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;environment variable %s is not set! Please set it.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">provisionerNameKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>   
</span></span></code></pre></div><p>main函数先获取<code>NFS_SERVER</code>、<code>NFS_PATH</code>、<code>PROVISIONER_NAME</code>三个环境变量的值，因此在部署nfs-client-provisioner的时候，需要将这三个环境变量的值传入。</p>
<ul>
<li><code>NFS_SERVER</code>：NFS服务端的IP地址。</li>
<li><code>NFS_PATH</code>：NFS服务端设置的共享目录</li>
<li><code>PROVISIONER_NAME</code>：provisioner的名字，需要和<code>StorageClass</code>对象中的<code>provisioner</code>字段一致。</li>
</ul>
<p>例如<code>StorageClass</code>对象的yaml文件如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">storage.k8s.io/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">StorageClass</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">managed-nfs-storage</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">provisioner</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fuseim.pri/ifs</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># or choose another name, must match deployment&#39;s env PROVISIONER_NAME&#39;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">parameters</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">archiveOnDelete</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;false&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># When set to &#34;false&#34; your PVs will not be archived by the provisioner upon deletion of the PVC.</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="2-1-2-获取clientset对象">2.1.2. 获取clientset对象</h3>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create an InClusterConfig and use it to create a client for the controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to use to communicate with Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InClusterConfig</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create config: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create client: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过读取对应的k8s的配置，创建<code>clientset</code>对象，用来执行k8s对应的API，其中主要包括对PV和PVC等对象的创建删除等操作。</p>
<h3 id="2-1-3-构造nfsprovisioner对象">2.1.3. 构造nfsProvisioner对象</h3>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The controller needs to know what the server version is because out-of-tree
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// provisioners aren&#39;t officially supported until 1.5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">serverVersion</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Discovery</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ServerVersion</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error getting server version: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">clientNFSProvisioner</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">nfsProvisioner</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">server</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">path</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过<code>clientset</code>、<code>server</code>、<code>path</code>等值构造<code>nfsProvisioner</code>对象，同时还获取了k8s的版本信息，因为provisioners的功能在k8s 1.5及以上版本才支持。</p>
<p><code>nfsProvisioner</code>类型定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">nfsProvisioner</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">server</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">path</span>   <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">_</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Provisioner</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">nfsProvisioner</span><span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></div><p><code>nfsProvisioner</code>是一个自定义的<code>provisioner</code>，用来实现<code>Provisioner</code>的接口，其中的属性除了<code>server</code>、<code>path</code>这两个关于NFS相关的参数，还包含了<code>client</code>，主要用来调用k8s的API。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">_</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Provisioner</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">nfsProvisioner</span><span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></div><p>以上用法用来检测<code>nfsProvisioner</code>是否实现了<code>Provisioner</code>的接口。</p>
<h3 id="2-1-4-构建并运行provisioncontroller">2.1.4. 构建并运行ProvisionController</h3>
<p>源码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start the provision controller which will dynamically provision efs NFS
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PVs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewProvisionController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">provisionerName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clientNFSProvisioner</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">serverVersion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GitVersion</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">pc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>通过<code>nfsProvisioner</code>构造<code>ProvisionController</code>对象并执行<code>Run</code>方法，<code>ProvisionController</code>实现了具体的PV和PVC的相关逻辑，<code>Run</code>方法以常驻进程的方式运行。</p>
<h2 id="2-2-provision-https-github-com-kubernetes-incubator-external-storage-blob-master-nfs-client-cmd-nfs-client-provisioner-provisioner-go-l56-和-delete-https-github-com-kubernetes-incubator-external-storage-blob-master-nfs-client-cmd-nfs-client-provisioner-provisioner-go-l99-方法">2.2. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/nfs-client/cmd/nfs-client-provisioner/provisioner.go#L56">Provision</a>和<a href="https://github.com/kubernetes-incubator/external-storage/blob/master/nfs-client/cmd/nfs-client-provisioner/provisioner.go#L99">Delete</a>方法</h2>
<h3 id="2-2-1-provision方法">2.2.1. Provision方法</h3>
<blockquote>
<p><code>nfsProvisioner</code>的<code>Provision</code>方法具体源码参考：https://github.com/kubernetes-incubator/external-storage/blob/master/nfs-client/cmd/nfs-client-provisioner/provisioner.go#L56</p>
</blockquote>
<p><code>Provision</code>方法用来创建存储资源，并且返回一个<code>PV</code>对象。其中入参是<code>VolumeOptions</code>，用来指定<code>PV</code>对象的相关属性。</p>
<p><strong>1、构建PV和PVC的名称</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nfsProvisioner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Provision</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumeOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Selector</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;claim Selector is not supported&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;nfs provisioner: VolumeOptions %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pvcNamespace</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pvcName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pvName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">pvcNamespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvcName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVName</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#4e9a06">&#34;-&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fullPath</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mountPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;creating path %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fullPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fullPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0777</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unable to create directory to provision new pv: &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Chmod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fullPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0777</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>通过<code>VolumeOptions</code>的入参，构建PV和PVC的名称，以及创建路径path。</p>
<p><strong>2、构造PV对象</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pv</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeSpec</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">PersistentVolumeReclaimPolicy</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeReclaimPolicy</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AccessModes</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AccessModes</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MountOptions</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MountOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Capacity</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceList</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceStorage</span><span style="color:#000;font-weight:bold">):</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Resources</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Requests</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceStorage</span><span style="color:#000;font-weight:bold">)],</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">PersistentVolumeSource</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeSource</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">NFS</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NFSVolumeSource</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Server</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Path</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">path</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">ReadOnly</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pv</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span></code></pre></div><p>综上可以看出，<code>Provision</code>方法只是通过<code>VolumeOptions</code>参数来构建<code>PV</code>对象，并没有执行具体<code>PV</code>的创建或删除的操作。</p>
<p>不同类型的<code>Provisioner</code>的，一般是<code>PersistentVolumeSource</code>类型和参数不同，例如<code>nfs-provisioner</code>对应的<code>PersistentVolumeSource</code>为<code>NFS</code>，并且需要传入<code>NFS</code>相关的参数：<code>Server</code>，<code>Path</code>等。</p>
<h3 id="2-2-2-delete方法">2.2.2. Delete方法</h3>
<blockquote>
<p><code>nfsProvisioner</code>的<code>delete</code>方法具体源码参考：https://github.com/kubernetes-incubator/external-storage/blob/master/nfs-client/cmd/nfs-client-provisioner/provisioner.go#L99</p>
</blockquote>
<p><strong>1、获取pvName和path等相关参数</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nfsProvisioner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeSource</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NFS</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Path</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pvName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Base</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">oldPath</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mountPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldPath</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;path %s does not exist, deletion skipped&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>通过<code>path</code>和<code>pvName</code>生成<code>oldPath</code>，其中<code>oldPath</code>是原先NFS服务器上<code>pod</code>对应的数据持久化存储路径。</p>
<p><strong>2、获取archiveOnDelete参数并删除数据</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Get the storage class for this volume.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">storageClass</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getClassForVolume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Determine if the &#34;archiveOnDelete&#34; parameter exists.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If it exists and has a falsey value, delete the directory.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Otherwise, archive it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">archiveOnDelete</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">storageClass</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;archiveOnDelete&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">archiveBool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseBool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">archiveOnDelete</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">archiveBool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果<code>storageClass</code>对象中指定<code>archiveOnDelete</code>参数并且值为<code>false</code>，则会自动删除<code>oldPath</code>下的所有数据，即<code>pod</code>对应的数据持久化存储数据。</p>
<blockquote>
<p><code>archiveOnDelete</code>字面意思为删除时是否存档，false表示不存档，即删除数据，true表示存档，即重命名路径。</p>
</blockquote>
<p><strong>3、重命名旧数据路径</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">archivePath</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mountPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;archived-&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;archiving path %s to %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">archivePath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Rename</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">archivePath</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>如果<code>storageClass</code>对象中没有指定<code>archiveOnDelete</code>参数或者值为<code>true</code>，表明需要删除时存档，即将<code>oldPath</code>重命名，命名格式为<code>oldPath</code>前面增加<code>archived-</code>的前缀。</p>
<h1 id="3-provisioncontroller-https-github-com-kubernetes-incubator-external-storage-blob-master-lib-controller-controller-go-l82">3. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L82">ProvisionController</a></h1>
<h2 id="3-1-provisioncontroller结构体">3.1. ProvisionController结构体</h2>
<blockquote>
<p>源码具体参考：https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L82</p>
</blockquote>
<p><code>ProvisionController</code>是一个给PVC提供PV的控制器，具体执行<code>Provisioner</code>接口的<code>Provision</code>和<code>Delete</code>的方法的所有逻辑。</p>
<h3 id="3-1-1-入参">3.1.1. 入参</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ProvisionController is a controller that provisions PersistentVolumes for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PersistentVolumeClaims.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ProvisionController</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// The name of the provisioner for which this controller dynamically
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// provisions volumes. The value of annDynamicallyProvisioned and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// annStorageProvisioner to set &amp; watch for, respectively
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">provisionerName</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// The provisioner the controller will use to provision and delete volumes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Presumably this implementer of Provisioner carries its own
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// volume-specific options and such that it needs in order to provision
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// volumes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">provisioner</span> <span style="color:#000">Provisioner</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Kubernetes cluster server version:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// * 1.4: storage classes introduced as beta. Technically out-of-tree dynamic
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// provisioning is not officially supported, though it works
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// * 1.5: storage classes stay in beta. Out-of-tree dynamic provisioning is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// officially supported
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// * 1.6: storage classes enter GA
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kubeVersion</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">utilversion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Version</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>   
</span></span></code></pre></div><p><code>client</code>、<code>provisionerName</code>、<code>provisioner</code>、<code>kubeVersion</code>等属性作为<code>NewProvisionController</code>的入参。</p>
<ul>
<li><code>client</code>：clientset客户端，用来调用k8s的API。</li>
<li><code>provisionerName</code>：provisioner的名字，需要和<code>StorageClass</code>对象中的<code>provisioner</code>字段一致。</li>
<li><code>provisioner</code>：具体的provisioner的实现者，本文为<code>nfsProvisioner</code>。</li>
<li><code>kubeVersion</code>：k8s的版本信息。</li>
</ul>
<h3 id="3-1-2-controller和informer">3.1.2. Controller和Informer</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ProvisionController</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">claimInformer</span>    <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedInformer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">claims</span>           <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">claimController</span>  <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeInformer</span>   <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedInformer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumes</span>          <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeController</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">classInformer</span>    <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedInformer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">classes</span>          <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">classController</span>  <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p><code>ProvisionController</code>结构体中包含了<code>PV</code>、<code>PVC</code>、<code>StorageClass</code>三个对象的<code>Controller</code>、<code>Informer</code>和<code>Store</code>，主要用来执行这三个对象的相关操作。</p>
<ul>
<li>Controller：通用的控制框架</li>
<li>Informer：消息通知器</li>
<li>Store：通用的对象存储接口</li>
</ul>
<h3 id="3-1-3-workqueue">3.1.3. workqueue</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ProvisionController</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">claimQueue</span>  <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimitingInterface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volumeQueue</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimitingInterface</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p><code>claimQueue</code>和<code>volumeQueue</code>分别是<code>PV</code>和<code>PVC</code>的任务队列。</p>
<h3 id="3-1-4-其他">3.1.4. 其他</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Identity of this controller, generated at creation time and not persisted
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// across restarts. Useful only for debugging, for seeing the source of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// events. controller.provisioner may have its own, different notion of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// identity which may/may not persist across restarts
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">id</span>            <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000">component</span>     <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000">eventRecorder</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventRecorder</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">resyncPeriod</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">exponentialBackOffOnError</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000">threadiness</span>               <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">createProvisionedPVRetryCount</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000">createProvisionedPVInterval</span>   <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">failedProvisionThreshold</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedDeleteThreshold</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The port for metrics server to serve on.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">metricsPort</span> <span style="color:#204a87;font-weight:bold">int32</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The IP address for metrics server to serve on.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">metricsAddress</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The path of metrics endpoint path.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">metricsPath</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Parameters of leaderelection.LeaderElectionConfig.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">leaseDuration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">renewDeadline</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">retryPeriod</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">hasRun</span>     <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000">hasRunLock</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span></code></pre></div><h2 id="3-2-newprovisioncontroller-https-github-com-kubernetes-incubator-external-storage-blob-master-lib-controller-controller-go-l418-方法">3.2. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L418">NewProvisionController</a>方法</h2>
<blockquote>
<p>源码地址：https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L418</p>
</blockquote>
<p><code>NewProvisionController</code>方法主要用来构造<code>ProvisionController</code>。</p>
<h3 id="3-2-1-初始化默认值">3.2.1. 初始化默认值</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewProvisionController creates a new provision controller using
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the given configuration parameters and with private (non-shared) informers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewProvisionController</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span> <span style="color:#000">kubernetes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisionerName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">provisioner</span> <span style="color:#000">Provisioner</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeVersion</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProvisionController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProvisionController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ProvisionController</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span>                        <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">provisionerName</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">provisionerName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeVersion</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">utilversion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MustParseSemantic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeVersion</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">id</span><span style="color:#000;font-weight:bold">:</span>                            <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">component</span><span style="color:#000;font-weight:bold">:</span>                     <span style="color:#000">component</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#000">DefaultResyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">exponentialBackOffOnError</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">DefaultExponentialBackOffOnError</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">threadiness</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">DefaultThreadiness</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">createProvisionedPVRetryCount</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">DefaultCreateProvisionedPVRetryCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">createProvisionedPVInterval</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">DefaultCreateProvisionedPVInterval</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">failedProvisionThreshold</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">DefaultFailedProvisionThreshold</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">failedDeleteThreshold</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">DefaultFailedDeleteThreshold</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">leaseDuration</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">DefaultLeaseDuration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">renewDeadline</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">DefaultRenewDeadline</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">retryPeriod</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">DefaultRetryPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metricsPort</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">DefaultMetricsPort</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metricsAddress</span><span style="color:#000;font-weight:bold">:</span>                <span style="color:#000">DefaultMetricsAddress</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metricsPath</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">DefaultMetricsPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">hasRun</span><span style="color:#000;font-weight:bold">:</span>                        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">hasRunLock</span><span style="color:#000;font-weight:bold">:</span>                    <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><h3 id="3-2-2-初始化任务队列">3.2.2. 初始化任务队列</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">ratelimiter</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMaxOfRateLimiter</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewItemExponentialFailureRateLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BucketRateLimiter</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Limiter</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exponentialBackOffOnError</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ratelimiter</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMaxOfRateLimiter</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewItemExponentialFailureRateLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">15</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BucketRateLimiter</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Limiter</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewLimiter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Limit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimQueue</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNamedRateLimitingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ratelimiter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;claims&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeQueue</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNamedRateLimitingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ratelimiter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;volumes&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="3-2-3-listwatch">3.2.3. ListWatch</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PVC
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">claimSource</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListWatch</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumeClaims</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceAll</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WatchFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumeClaims</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceAll</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PV
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">volumeSource</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListWatch</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WatchFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">classSource</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListWatch</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StorageClasses</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WatchFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StorageClasses</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>list-watch</code>机制是k8s中用来监听对象变化的核心机制，<code>ListWatch</code>包含<code>ListFunc</code>和<code>WatchFunc</code>两个函数，且不能为空，以上代码分别构造了PV、PVC、StorageClass三个对象的<code>ListWatch</code>结构体。该机制的实现在<code>client-go</code>的<code>cache</code>包中，具体参考：https://godoc.org/k8s.io/client-go/tools/cache。</p>
<p>更多<code>ListWatch</code>代码如下:</p>
<blockquote>
<p>具体参考：https://github.com/kubernetes-incubator/external-storage/blob/89b0aaf6413b249b37834b124fc314ef7b8ee949/vendor/k8s.io/client-go/tools/cache/listwatch.go#L34</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListerWatcher is any object that knows how to perform an initial list and start a watch on a resource.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ListerWatcher</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// List should return a list type object; the Items field will be extracted, and the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// ResourceVersion field will be used to start the watch in the right place.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Watch should begin a watch at the specified version.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListFunc knows how to list resources
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ListFunc</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// WatchFunc knows how to watch resources
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">WatchFunc</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListWatch knows how to list and watch a set of apiserver resources.  It satisfies the ListerWatcher interface.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It is a convenience function for users of NewReflector, etc.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListFunc and WatchFunc must not be nil
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ListWatch</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListFunc</span>  <span style="color:#000">ListFunc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WatchFunc</span> <span style="color:#000">WatchFunc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// DisableChunking requests no chunking for this list watcher.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">DisableChunking</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-2-4-resourceeventhandlerfuncs">3.2.4. ResourceEventHandlerFuncs</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PVC
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">claimHandler</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forgetWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PV
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">volumeHandler</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forgetWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// StorageClass
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">classHandler</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We don&#39;t need an actual event handler for StorageClasses,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// but we must pass a non-nil one to cache.NewInformer()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>ResourceEventHandlerFuncs</code>是资源事件处理函数，主要用来对k8s资源对象<code>增删改</code>变化的事件进行消息通知，该函数实现了<code>ResourceEventHandler</code>的接口。具体代码逻辑在<code>client-go</code>的cache包中。</p>
<p>更多<code>ResourceEventHandlerFuncs</code>代码可参考：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ResourceEventHandler can handle notifications for events that happen to a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// resource. The events are informational only, so you can&#39;t return an
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * OnAdd is called when an object is added.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * OnUpdate is called when an object is modified. Note that oldObj is the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      last known state of the object-- it is possible that several changes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      were combined together, so you can&#39;t use this to see every single
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      change. OnUpdate is also called when a re-list happens, and it will
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      get called even if nothing changed. This is useful for periodically
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      evaluating or syncing something.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * OnDelete will get the final state of the item if it is known, otherwise
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      it will get an object of type DeletedFinalStateUnknown. This can
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      happen if the watch is closed and misses the delete event and we don&#39;t
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      notice the deletion until the subsequent re-list.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ResourceEventHandler</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OnAdd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OnUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OnDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ResourceEventHandlerFuncs is an adaptor to let you easily specify as many or
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// as few of the notification functions as you want while still implementing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ResourceEventHandler.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ResourceEventHandlerFuncs</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AddFunc</span>    <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateFunc</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeleteFunc</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-2-5-构造store和controller">3.2.5. 构造Store和Controller</h3>
<p><strong>1、PVC</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimInformer</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddEventHandlerWithResyncPeriod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claimHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimController</span> <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetStore</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetController</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimController</span> <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInformer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">claimSource</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaim</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">claimHandler</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>2、PV</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeInformer</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddEventHandlerWithResyncPeriod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volumeHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeController</span> <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetStore</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetController</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeController</span> <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInformer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">volumeSource</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">volumeHandler</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>3、StorageClass</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classInformer</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// no resource event handler needed for StorageClasses
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classController</span> <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetStore</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetController</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classController</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInformer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">classSource</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">versionedClassType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">classHandler</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过<code>cache.NewInformer</code>的方法构造，入参是<code>ListWatch</code>结构体和<code>ResourceEventHandlerFuncs</code>函数等，返回值是<code>Store</code>和<code>Controller</code>。</p>
<p>通过以上各个部分的构造，最后返回一个具体的<code>ProvisionController</code>对象。</p>
<h2 id="3-3-provisioncontroller-run-https-github-com-kubernetes-incubator-external-storage-blob-master-lib-controller-controller-go-l565-方法">3.3. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L565">ProvisionController.Run</a>方法</h2>
<p><code>ProvisionController</code>的<code>Run</code>方法是以常驻进程的方式运行，函数内部再运行其他的controller。</p>
<h3 id="3-3-1-prometheus数据收集">3.3.1. prometheus数据收集</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run starts all of this controller&#39;s control loops
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProvisionController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">run</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metricsPort</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MustRegister</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Collector</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaimProvisionTotal</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaimProvisionFailedTotal</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaimProvisionDurationSeconds</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeDeleteTotal</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeDeleteFailedTotal</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeDeleteDurationSeconds</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metricsPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">promhttp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">address</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">JoinHostPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metricsAddress</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormatInt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metricsPort</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting metrics server at %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">address</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Forever</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to listen on %s: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>        
</span></span></code></pre></div><h3 id="3-3-2-controller-run">3.3.2. Controller.Run</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If a SharedInformer has been passed in, this controller should not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// call Run again
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimInformer</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeInformer</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classInformer</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">classController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>运行消息通知器Informer。</p>
<h3 id="3-3-3-worker">3.3.3. Worker</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">threadiness</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runClaimWorker</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runVolumeWorker</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>runClaimWorker</code>和<code>runVolumeWorker</code>分别为PVC和PV的worker，这两个的具体执行体分别是<code>processNextClaimWorkItem</code>和<code>processNextVolumeWorkItem</code>。</p>
<p>执行流程如下：</p>
<p><strong>PVC的函数调用流程</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>runClaimWorker→processNextClaimWorkItem→syncClaimHandler→syncClaim→provisionClaimOperation
</span></span></code></pre></div><p><strong>PV的函数调用流程</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>runVolumeWorker→processNextVolumeWorkItem→syncVolumeHandler→syncVolume→deleteVolumeOperation
</span></span></code></pre></div><p>可见最后执行的函数分别是<code>provisionClaimOperation</code>和<code>deleteVolumeOperation</code>。</p>
<h2 id="3-4-operation">3.4. Operation</h2>
<h3 id="3-4-1-provisionclaimoperation-https-github-com-kubernetes-incubator-external-storage-blob-master-lib-controller-controller-go-l923">3.4.1. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L923">provisionClaimOperation</a></h3>
<p>1、<code>provisionClaimOperation</code>入参是PVC，通过PVC获得PV对象，并判断PV对象是否存在，如果存在则退出后续操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// provisionClaimOperation attempts to provision a volume for the given claim.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Returns error, which indicates whether provisioning should be retried
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// (requeue the claim) or not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProvisionController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">provisionClaimOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaim</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Most code here is identical to that found in controller.go of kube&#39;s PV controller...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">claimClass</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">helper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPersistentVolumeClaimClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">operation</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;provision %q class %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">claimToClaimKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">claimClass</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;started&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">//  A previous doProvisionClaim may just have finished while we were waiting for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  the locks. Check that PV (with deterministic name) hasn&#39;t been provisioned
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  yet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">pvName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getProvisionedVolumeNameForClaim</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">volume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Volume has been already provisioned, nothing to do.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;persistentvolume %q already exists, skipping&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>2、获取StorageClass对象中的<code>Provisioner</code>和<code>ReclaimPolicy</code>参数，如果<code>provisionerName</code>和<code>StorageClass</code>对象中的<code>provisioner</code>字段不一致则报错并退出执行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">parameters</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getStorageClassFields</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claimClass</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error getting claim&#39;s StorageClass&#39;s fields: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">provisioner</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">provisionerName</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// class.Provisioner has either changed since shouldProvision() or
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// annDynamicallyProvisioned contains different provisioner than
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// class.Provisioner.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unknown provisioner %q requested in claim&#39;s StorageClass&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Check if this provisioner can provision this claim.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">canProvision</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ProvisioningFailed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;failed to provision volume: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">reclaimPolicy</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeReclaimDelete</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeVersion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AtLeast</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">utilversion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MustParseSemantic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;v1.8.0&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">reclaimPolicy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fetchReclaimPolicy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claimClass</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>3、执行具体的<code>provisioner.Provision</code>方法，构建PV对象，例如本文中的<code>provisioner</code>是<code>nfs-provisioner</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">VolumeOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PersistentVolumeReclaimPolicy</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">reclaimPolicy</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PVName</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">pvName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PVC</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">claim</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MountOptions</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">mountOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Parameters</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">parameters</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">SelectedNode</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">selectedNode</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AllowedTopologies</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">allowedTopologies</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Provisioning&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;External provisioner is provisioning volume for claim %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">claimToClaimKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Provision</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ierr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">IgnoredError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Provision ignored, do nothing and hope another provisioner will provision it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;volume provision ignored: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ierr</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to provision volume with StorageClass %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">claimClass</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ProvisioningFailed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>4、创建k8s的PV对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Try to create the PV object several times
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createProvisionedPVRetryCount</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;trying to save persistentvvolume %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">apierrs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsAlreadyExists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Save succeeded.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;persistentvolume %q already exists, reusing&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;persistentvolume %q saved&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Save failed, try again after a while.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;failed to save persistentvolume %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createProvisionedPVInterval</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>5、创建PV失败，清理存储资源。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Save failed. Now we have a storage asset outside of Kubernetes,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// but we don&#39;t have appropriate PV object for it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Emit some event here and try to delete the storage asset several
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// times.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createProvisionedPVRetryCount</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Delete succeeded
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;cleaning volume %q succeeded&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Delete failed, try again after a while.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;failed to clean volume %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createProvisionedPVInterval</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Delete failed several times. There is an orphaned volume and there
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// is nothing we can do about it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">strerr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error cleaning provisioned volume for claim %s: %v. Please delete manually.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">claimToClaimKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerr</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">claim</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ProvisioningCleanupFailed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strerr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果创建成功，则打印成功的日志，并返回<code>nil</code>。</p>
<h3 id="3-4-2-deletevolumeoperation-https-github-com-kubernetes-incubator-external-storage-blob-master-lib-controller-controller-go-l1096">3.4.2. <a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go#L1096">deleteVolumeOperation</a></h3>
<p>1、<code>deleteVolumeOperation</code>入参是PV，先获得PV对象，并判断是否需要删除。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// deleteVolumeOperation attempts to delete the volume backing the given
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// volume. Returns error, which indicates whether deletion should be retried
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// (requeue the volume) or not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ProvisionController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">deleteVolumeOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolume</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// This method may have been waiting for a volume lock for some time.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Our check does not have to be as sophisticated as PV controller&#39;s, we can
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// trust that the PV controller has set the PV to Released/Failed and it&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// ours to delete
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">newVolume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shouldDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newVolume</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;persistentvolume no longer needs deletion, skipping&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>2、调用具体的<code>provisioner</code>的<code>Delete</code>方法，例如，如果是nfs-provisioner，则是调用nfs-provisioner的Delete方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">provisioner</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ierr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">IgnoredError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Delete ignored, do nothing and hope another provisioner will delete it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;volume deletion ignored: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ierr</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Delete failed, emit an event.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;volume deletion failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Event</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;VolumeFailedDelete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>3、删除k8s中的PV对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Delete the volume
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumes</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Oops, could not delete the volume and therefore the controller will
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// try to delete the volume again on next update.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">operation</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;failed to delete persistentvolume: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-总结">4. 总结</h1>
<ol>
<li><code>Provisioner</code>接口包含<code>Provision</code>和<code>Delete</code>两个方法，自定义的<code>provisioner</code>需要实现这两个方法，这两个方法只是处理了跟存储类型相关的事项，并没有针对<code>PV</code>、<code>PVC</code>对象的增删等操作。</li>
<li><code>Provision</code>方法主要用来构造PV对象，不同类型的<code>Provisioner</code>的，一般是<code>PersistentVolumeSource</code>类型和参数不同，例如<code>nfs-provisioner</code>对应的<code>PersistentVolumeSource</code>为<code>NFS</code>，并且需要传入<code>NFS</code>相关的参数：<code>Server</code>，<code>Path</code>等。</li>
<li><code>Delete</code>方法主要针对对应的存储类型，做数据存档（备份）或删除的处理。</li>
<li><code>StorageClass</code>对象需要单独创建，用来指定具体的<code>provisioner</code>来执行相关逻辑。</li>
<li><code>provisionClaimOperation</code>和<code>deleteVolumeOperation</code>具体执行了k8s中<code>PV</code>对象的创建和删除操作，同时调用了具体<code>provisioner</code>的<code>Provision</code>和<code>Delete</code>两个方法来对存储数据做处理。</li>
</ol>
<p>参考文章</p>
<ul>
<li><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/docs/demo/hostpath-provisioner">https://github.com/kubernetes-incubator/external-storage/tree/master/docs/demo/hostpath-provisioner</a></li>
<li><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client">https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client</a></li>
<li><a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go">https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/controller.go</a></li>
<li><a href="https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/volume.go">https://github.com/kubernetes-incubator/external-storage/blob/master/lib/controller/volume.go</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7b4726c5697dc81fca76b5397c272027">4 - k8s社区开发指南</h1>
    
	<h1 id="1-社区说明">1. 社区说明</h1>
<h2 id="1-1-community-membership">1.1. Community membership</h2>
<table>
<thead>
<tr>
<th>Role</th>
<th>Responsibilities</th>
<th>Requirements</th>
<th>Defined by</th>
</tr>
</thead>
<tbody>
<tr>
<td>Member</td>
<td>Active contributor in the community</td>
<td>Sponsored by 2 reviewers and multiple contributions to the project</td>
<td>Kubernetes GitHub org member</td>
</tr>
<tr>
<td>Reviewer</td>
<td>Review contributions from other members</td>
<td>History of review and authorship in a subproject</td>
<td><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/owners.md">OWNERS</a> file reviewer entry</td>
</tr>
<tr>
<td>Approver</td>
<td>Contributions acceptance approval</td>
<td>Highly experienced active reviewer and contributor to a subproject</td>
<td><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/owners.md">OWNERS</a> file approver entry</td>
</tr>
<tr>
<td>Subproject owner</td>
<td>Set direction and priorities for a subproject</td>
<td>Demonstrated responsibility and excellent technical judgement for the subproject</td>
<td><a href="https://github.com/kubernetes/community/blob/master/sigs.yaml">sigs.yaml</a> subproject <a href="https://github.com/kubernetes/community/blob/master/contributors/guide/owners.md">OWNERS</a> file <em>owners</em> entry</td>
</tr>
</tbody>
</table>
<h2 id="1-2-社区活动日历">1.2. 社区活动日历</h2>
<p><a href="https://www.kubernetes.dev/resources/calendar/">Community Calendar | Kubernetes Contributors</a></p>
<h2 id="1-3-加入k8s-slack">1.3. 加入k8s slack</h2>
<p>点击 <a href="https://communityinviter.com/apps/kubernetes/community">https://communityinviter.com/apps/kubernetes/community</a></p>
<h2 id="1-4-特别兴趣小组-sig">1.4. 特别兴趣小组（SIG）</h2>
<p>列表： <a href="https://github.com/kubernetes/community/blob/master/sig-list.md">https://github.com/kubernetes/community/blob/master/sig-list.md</a></p>
<h1 id="2-编译k8s仓库">2. 编译k8s仓库</h1>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/2c6c4566eff972d6c1320b5f8ad795f88c822d09/build/README.md">Building Kubernetes</a></li>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/development.md#building-kubernetes">https://github.com/kubernetes/community/blob/master/contributors/devel/development.md#building-kubernetes</a></li>
</ul>
<h2 id="2-1-编译二进制">2.1. 编译二进制</h2>
<h3 id="2-1-1-基于docker构建容器编译">2.1.1. 基于docker构建容器编译。</h3>
<blockquote>
<p>该方式为官方镜像及二进制文件的构建方式。</p>
</blockquote>
<p>构建镜像(大小：5.97GB)为： kube-build:build-8faa8d3cb7-5-v1.27.0-go1.20.6-bullseye.0</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/kubernetes/kubernetes.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> kubernetes
</span></span><span style="display:flex;"><span>build/run.sh make <span style="color:#8f5902;font-style:italic"># 构建全部</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#指定模块构建</span>
</span></span><span style="display:flex;"><span>build/run.sh make kubeadm
</span></span></code></pre></div><p>输出如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># build/run.sh make</span>
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:39:11<span style="color:#ce5c00;font-weight:bold">]</span> Verifying Prerequisites....
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:39:16<span style="color:#ce5c00;font-weight:bold">]</span> Building Docker image kube-build:build-8faa8d3cb7-5-v1.27.0-go1.20.6-bullseye.0
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:40:49<span style="color:#ce5c00;font-weight:bold">]</span> Creating data container kube-build-data-8faa8d3cb7-5-v1.27.0-go1.20.6-bullseye.0
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:40:50<span style="color:#ce5c00;font-weight:bold">]</span> Syncing sources to container
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:40:58<span style="color:#ce5c00;font-weight:bold">]</span> Output from this container will be rsynced out upon completion. Set <span style="color:#000">KUBE_RUN_COPY_OUTPUT</span><span style="color:#ce5c00;font-weight:bold">=</span>n to disable.
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:40:58<span style="color:#ce5c00;font-weight:bold">]</span> Running build command...
</span></span><span style="display:flex;"><span>go: downloading go.uber.org/automaxprocs v1.5.2
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:41:04<span style="color:#ce5c00;font-weight:bold">]</span> Setting GOMAXPROCS: <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>Go version: go version go1.20.6 linux/amd64
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:41:04<span style="color:#ce5c00;font-weight:bold">]</span> Building go targets <span style="color:#204a87;font-weight:bold">for</span> linux/amd64
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kube-proxy <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kube-apiserver <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kube-controller-manager <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kubelet <span style="color:#ce5c00;font-weight:bold">(</span>non-static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kubeadm <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kube-scheduler <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/component-base/logs/kube-log-runner <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kube-aggregator <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/apiextensions-apiserver <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cluster/gce/gci/mounter <span style="color:#ce5c00;font-weight:bold">(</span>non-static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kubectl <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kubectl-convert <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    github.com/onsi/ginkgo/v2/ginkgo <span style="color:#ce5c00;font-weight:bold">(</span>non-static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/test/e2e/e2e.test <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">test</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/test/conformance/image/go-runner <span style="color:#ce5c00;font-weight:bold">(</span>non-static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kubemark <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    github.com/onsi/ginkgo/v2/ginkgo <span style="color:#ce5c00;font-weight:bold">(</span>non-static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/test/e2e_node/e2e_node.test <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">test</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Env <span style="color:#204a87;font-weight:bold">for</span> linux/amd64: <span style="color:#000">GOOS</span><span style="color:#ce5c00;font-weight:bold">=</span>linux <span style="color:#000">GOARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>amd64 <span style="color:#000">GOROOT</span><span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/go <span style="color:#000">CGO_ENABLED</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">CC</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>Coverage is disabled.
</span></span><span style="display:flex;"><span>Coverage is disabled.
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:48:17<span style="color:#ce5c00;font-weight:bold">]</span> Placing binaries
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 18:48:25<span style="color:#ce5c00;font-weight:bold">]</span> Syncing out of container
</span></span></code></pre></div><p>产物文件在<code>_output</code>目录上。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubernetes/_output# tree
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>-- dockerized
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>-- bin
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- linux
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>       <span style="color:#4e9a06">`</span>-- amd64
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- apiextensions-apiserver
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- e2e_node.test
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- e2e.test
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- ginkgo
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- go-runner
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kubeadm
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kube-aggregator
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kube-apiserver
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kube-controller-manager
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kubectl
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kubectl-convert
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kubelet
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kube-log-runner
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kubemark
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kube-proxy
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- kube-scheduler
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#000;font-weight:bold">|</span>-- mounter
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#000;font-weight:bold">|</span>           <span style="color:#4e9a06">`</span>-- ncpu
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">|</span>   <span style="color:#4e9a06">`</span>-- go
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">`</span>-- images
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">`</span>-- kube-build:build-8faa8d3cb7-5-v1.27.0-go1.20.6-bullseye.0
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">|</span>-- Dockerfile
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">|</span>-- localtime
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">|</span>-- rsyncd.password
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">`</span>-- rsyncd.sh
</span></span></code></pre></div><h3 id="2-1-2-基于构建机环境编译">2.1.2. 基于构建机环境编译</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/kubernetes/kubernetes.git
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> kubernetes
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 构建全部二进制</span>
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 构建指定二进制</span>
</span></span><span style="display:flex;"><span>make <span style="color:#000">WHAT</span><span style="color:#ce5c00;font-weight:bold">=</span>cmd/kubeadm
</span></span></code></pre></div><p>输出如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># make WHAT=cmd/kubeadm</span>
</span></span><span style="display:flex;"><span>go version go1.20.6 linux/amd64
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 19:30:55<span style="color:#ce5c00;font-weight:bold">]</span> Setting GOMAXPROCS: <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>+++ <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0804</span> 19:30:56<span style="color:#ce5c00;font-weight:bold">]</span> Building go targets <span style="color:#204a87;font-weight:bold">for</span> linux/amd64
</span></span><span style="display:flex;"><span>    k8s.io/kubernetes/cmd/kubeadm <span style="color:#ce5c00;font-weight:bold">(</span>static<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-2-编译镜像">2.2. 编译镜像</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/kubernetes/kubernetes
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> kubernetes
</span></span><span style="display:flex;"><span>make quick-release
</span></span></code></pre></div><h1 id="3-如何给k8s提交pr">3. 如何给k8s提交PR</h1>
<p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/pull-requests.md">https://github.com/kubernetes/community/blob/master/contributors/guide/pull-requests.md</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/first-contribution.md">https://github.com/kubernetes/community/blob/master/contributors/guide/first-contribution.md</a></p>
</li>
<li>
<p><a href="https://go.k8s.io/bot-commands">Here is the bot commands documentation</a>.</p>
</li>
<li>
<p> <a href="https://git.k8s.io/community/contributors/devel/sig-testing/testing.md">testing guide</a></p>
</li>
</ul>
<p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes/community/">https://github.com/kubernetes/community/</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/community/tree/master/contributors/guide">https://github.com/kubernetes/community/tree/master/contributors/guide</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/first-contribution.md">https://github.com/kubernetes/community/blob/master/contributors/guide/first-contribution.md</a></p>
</li>
<li>
<p> <a href="https://go.k8s.io/good-first-issue">issues labeled as a good first issue</a></p>
</li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2024 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
