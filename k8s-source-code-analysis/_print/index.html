<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/k8s-source-code-analysis/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/k8s-source-code-analysis/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Kubernetes源码分析 | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="Kubernetes源码分析" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/k8s-source-code-analysis/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="Kubernetes源码分析">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes源码分析"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/kubernetes-notes/" ><span>Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/k8s-source-code-analysis/" ><span class="active">Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/linux-notes/" ><span>Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.16f3c2880a3c8f3cec052b95e5efa0c6.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/k8s-source-code-analysis/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">Kubernetes源码分析</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-a33b1310946243aa1ab533d02100a146">summary</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-126baf4a062055c4772a376173711a62">k8s核心数据结构分析</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-4c953da4e29ee04497441a42b5126e86">k8s中Etcd存储的实现</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-3033d4afe8fcee3f8a9d2c099dd5b04e">kube-apiserver</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-1d0c5119a423537de8c993fbd3cc3ebe">kube-apiserver源码分析（一）之 NewAPIServerCommand</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-dac34401574b403cd1a9f38c0bc9fd52">kube-controller-manager</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-e90778a963162288e7bcb659355fb477">controller-manager 源码思维导图</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-62456a4dd94fd74fda9ec5ad3c5ab14a">kube-controller-manager源码分析（一）之 NewControllerManagerCommand</a></li>


    
  
    
    
	
<li>3.3: <a href="#pg-ce1deaa7afc18bcddb66cab3ff6be50b">kube-controller-manager源码分析（二）之 DeploymentController</a></li>


    
  
    
    
	
<li>3.4: <a href="#pg-d5650ecfb85232b23f95315845a0783f">kube-controller-manager源码分析（三）之 Informer机制</a></li>


    
  
    
    
	
<li>3.5: <a href="#pg-bc0b8c343e4b4530b9dc8bf6f49b5e5d">kube-controller-manager源码分析（四）之 ReplicaSetController</a></li>


    
  
    
    
	
<li>3.6: <a href="#pg-8d44ce2359b0825a7ddd3cf8b2255b9c">kube-controller-manager源码分析（五）之 DaemonSetController</a></li>


    
  
    
    
	
<li>3.7: <a href="#pg-18dccce09a15e696cf7da7b309e68dae">controller-runtime源码分析</a></li>


    
  
    
    
	
<li>3.8: <a href="#pg-a167c51f6d71759ce1fb280bf2d2542d">workqueue源码分析</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-5dffb45fbf5394ee40d3271948c99485">kube-scheduler</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-81ad0a7153dd8d183646f8d1ebd1c6a5">kube-scheduler 源码思维导图</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-450020ba5dcfaba3eb90de8c14204285">kube-scheduler源码分析（一）之 NewSchedulerCommand</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-098ce169e4f76190487656ba8c3899d7">kube-scheduler源码分析（二）之 调度算法</a></li>


    
  
    
    
	
<li>4.4: <a href="#pg-1b30fb2a64678cfd3eec2198ed1461cc">kube-scheduler源码分析（三）之 调度流程</a></li>


    
  
    
    
	
<li>4.5: <a href="#pg-ea2ce71fd47cea6adf169e5d35e56977">kube-scheduler源码分析（四）之 预选策略</a></li>


    
  
    
    
	
<li>4.6: <a href="#pg-8621391b1d2292ec57a9ce7538fe1a47">kube-scheduler源码分析（五）之 优选策略</a></li>


    
  
    
    
	
<li>4.7: <a href="#pg-198aaa69380bc8e1d54162e3ae00b4be">kube-scheduler源码分析（六）之 抢占逻辑</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-b7be2a83ad06d778ca900e4c7dc85b09">kubelet</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-5516fcb212e4fbbdc29a202ed629314d">kubelet 源码思维导图</a></li>


    
  
    
    
	
<li>5.2: <a href="#pg-e2cf6c7dbb69ed9905bbe6a48da441ab">kubelet源码分析（一）之 NewKubeletCommand</a></li>


    
  
    
    
	
<li>5.3: <a href="#pg-f143779d871d6a62ac575beff2e8515b">kubelet源码分析（二）之 NewMainKubelet</a></li>


    
  
    
    
	
<li>5.4: <a href="#pg-81cae8093c76076822c064c1cb2ac31c">kubelet源码分析（三）之 RunKubelet</a></li>


    
  
    
    
	
<li>5.5: <a href="#pg-a2b7e6297d422710a490f3a64d66c478">kubelet源码分析（四）之 syncLoopIteration</a></li>


    
  
    
    
	
<li>5.6: <a href="#pg-46bab922ea9b5daead85570c299c80aa">kubelet源码分析（五）之 syncPod</a></li>


    
  
    
    
	
<li>5.7: <a href="#pg-530d7df789771887e02908b769f6701c">runc源码分析</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-a33b1310946243aa1ab533d02100a146">1 - summary</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-126baf4a062055c4772a376173711a62">1.1 - k8s核心数据结构分析</h1>
    
	<blockquote>
<p>本文基于《Kubernetes源码剖析》整理，结合k8s v1.22.0代码分析</p>
</blockquote>
<h1 id="概述">概述</h1>
<p>k8s声明式API的思想，以资源描述对象为中心，声明对象的<code>spec</code>，通过系统维持<code>status</code>状态始终是用户声明的资源描述<code>spec</code>，具体可以参考<a href="https://www.huweihuang.com/kubernetes-notes/concepts/object/understanding-kubernetes-objects.html">理解k8s资源对象</a>。k8s是一个完全以资源为中心的系统，本质是一个资源控制系统--注册、管理、调度资源并维护资源的状态。k8s将资源进行再次分组和版本化，形成Group(资源组)、Version(资源版本)、Resource(资源)【其中kind表示资源种类】</p>
<h1 id="资源描述对象">资源描述对象</h1>
<p>资源描述对象必须的声明元素如下：</p>
<ul>
<li>apiVersion：kubernetes API的版本，包含<code>&lt;group&gt;/&lt;version&gt;</code></li>
<li>kind：kubernetes对象的类型</li>
<li>metadata：唯一标识该对象的元数据，包括name，UID，可选的namespace</li>
<li>spec：标识对象的详细信息，不同对象的spec的格式不同，可以嵌套其他对象的字段。</li>
</ul>
<p>说明：</p>
<ol>
<li>
<p><code>&lt;group&gt;/&lt;version&gt;/&lt;resource&gt;</code>表示唯一一种资源对象，例如<code>apps/v1/deployment</code>。</p>
</li>
<li>
<p>每种资源对象都有增删改查的操作方法。具体可包含8类操作接口：</p>
</li>
</ol>
<ul>
<li>
<p>增：create</p>
</li>
<li>
<p>删：delete，deletecollection</p>
</li>
<li>
<p>改：update，patch</p>
</li>
<li>
<p>查：get，list，watch</p>
</li>
</ul>
<ol start="3">
<li>除了内置的k8s资源对象，可用CRD自定义资源对象，在k8s系统中使用。</li>
</ol>
<p>示例：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx-deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx:1.7.9</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h1 id="资源对象分类及代码目录">资源对象分类及代码目录</h1>
<h1 id="资源对象通用结构">资源对象通用结构</h1>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4c953da4e29ee04497441a42b5126e86">1.2 - k8s中Etcd存储的实现</h1>
    
	<blockquote>
<p>本文基于《Kubernetes源码剖析》整理，结合k8s v1.22.0代码分析</p>
</blockquote>
<h1 id="概述">概述</h1>
<p>k8s基于Etcd作为存储，Etcd是分布式的KV存储集群，Etcd中存储了k8s的<code>元数据</code>、<code>事件数据</code>、<code>状态数据</code>等，数据前缀为<code>/registry</code>下，具体的各类对象的key可以参考<a href="https://www.huweihuang.com/kubernetes-notes/etcd/k8s-etcd-data.html">Etcd中的k8s数据</a>。</p>
<blockquote>
<p>Etcd作为k8s唯一存储，兼具了<code>MySQL存储元数据</code>和<code>消息队列存储任务事件</code>的功能。</p>
</blockquote>
<h1 id="etcd存储架构设计">Etcd存储架构设计</h1>
<p>k8s对etcd的操作进行了分层封装，从上(k8s)到下(etcd)，分别为：</p>
<ul>
<li>RESTStorage（k8s对象操作封装）</li>
<li>RegistryStore（BeforeFunc,AfterFunc）</li>
<li>Storage.Interface（增删改查方法封装）</li>
<li>CacherStorage（Etcd缓存层）</li>
<li>UnderlyingStorage（与Etcd交互）</li>
</ul>
<h1 id="reststorage存储接口">RESTStorage存储接口</h1>
<p>每种k8s资源实现RESTStorage接口，接口代码如下：</p>
<blockquote>
<p>kubernetes/staging/src/k8s.io/apiserver/pkg/registry/rest/rest.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Storage is a generic interface for RESTful storage services.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Resources which are exported to the RESTful API of apiserver need to implement this interface. It is expected
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// that objects may implement any of the below interfaces.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Storage</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// New returns an empty object that can be used with Create and Update after request data has been put into it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// This object must be a pointer type for use with Codec.DecodeInto([]byte, runtime.Object)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">New</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>k8s基于etcd相关封装代码主要在<code>/pkg/registry</code>目录下。</p>
<p>其中每种资源对于storage接口的实现定义在<code>/pkg/registry/&lt;资源组&gt;/&lt;资源&gt;/storage/storage.go</code>。以下以<code>deployment</code>为例串联k8s中关于etcd的调用流程，调用顺序从上(k8s)到下(etcd)。</p>
<h2 id="deploymentstorage">DeploymentStorage</h2>
<blockquote>
<p>kubernetes/pkg/registry/apps/deployment/storage/storage.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// DeploymentStorage includes dummy storage for Deployments and for Scale subresource.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">DeploymentStorage</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Deployment</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">REST</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Status</span>     <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">StatusREST</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Scale</span>      <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ScaleREST</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Rollback</span>   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RollbackREST</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// REST implements a RESTStorage for Deployments.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">REST</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericregistry</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">categories</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// StatusREST implements the REST endpoint for changing the status of a deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">StatusREST</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">store</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericregistry</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ScaleREST implements a Scale for Deployment.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ScaleREST</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">store</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericregistry</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// RollbackREST implements the REST endpoint for initiating the rollback of a deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">RollbackREST</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">store</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericregistry</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3033d4afe8fcee3f8a9d2c099dd5b04e">2 - kube-apiserver</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1d0c5119a423537de8c993fbd3cc3ebe">2.1 - kube-apiserver源码分析（一）之 NewAPIServerCommand</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析<code>kube-apiserver</code>中<code>cmd</code>部分的代码，即<code>NewAPIServerCommand</code>相关的代码。更多具体的逻辑待后续文章分析。</p>
<p><code>kube-apiserver</code>的<code>cmd</code>部分目录代码结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kube-apiserver
</span></span><span style="display:flex;"><span>├── apiserver.go   <span style="color:#8f5902;font-style:italic"># kube-apiserver的main入口</span>
</span></span><span style="display:flex;"><span>└── app
</span></span><span style="display:flex;"><span>    ├── aggregator.go
</span></span><span style="display:flex;"><span>    ├── apiextensions.go
</span></span><span style="display:flex;"><span>    ├── options  <span style="color:#8f5902;font-style:italic"># 初始化kube-apiserver使用到的option</span>
</span></span><span style="display:flex;"><span>    │   ├── options.go     <span style="color:#8f5902;font-style:italic"># 包括：NewServerRunOptions、Flags等</span>
</span></span><span style="display:flex;"><span>    │   ├── options_test.go
</span></span><span style="display:flex;"><span>    │   └── validation.go
</span></span><span style="display:flex;"><span>    ├── server.go   <span style="color:#8f5902;font-style:italic"># 包括：NewAPIServerCommand、Run、CreateServerChain、Complete等</span>
</span></span></code></pre></div><h1 id="1-main">1. Main</h1>
<blockquote>
<p>此部分代码位于cmd/kube-apiserver/apiserver.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UTC</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UnixNano</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAPIServerCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetupSignalHandler</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: once we switch everything over to Cobra commands, we can go back to calling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// utilflag.InitFlags() (by removing its pflag.Parse() call). For now, we have to set the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// normalize func and add the go flag set by hand.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetNormalizeFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">utilflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WordSepNormalizeFunc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddGoFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">goflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// utilflag.InitFlags()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlushLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error: %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 初始化APIServerCommand
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAPIServerCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetupSignalHandler</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 执行Execute
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h1 id="2-newapiservercommand">2. NewAPIServerCommand</h1>
<blockquote>
<p>此部分的代码位于/cmd/kube-apiserver/app/server.go</p>
</blockquote>
<p><code>NewAPIServerCommand</code>即<a href="https://github.com/spf13/cobra">Cobra</a>命令行框架的构造函数，主要包括三部分：</p>
<ul>
<li>构造option</li>
<li>添加Flags</li>
<li>执行Run函数</li>
</ul>
<p>完整代码如下：</p>
<blockquote>
<p>此部分代码位于cmd/kube-apiserver/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewAPIServerCommand creates a *cobra.Command object with default parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewAPIServerCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServerRunOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;kube-apiserver&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Long</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`The Kubernetes API server validates and configures data
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">for the api objects which include pods, services, replicationcontrollers, and
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">others. The API Server services REST operations and provides the frontend to the
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">cluster&#39;s shared state through which all other components interact.`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">RunE</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">verflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintAndExitIfRequested</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">utilflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// set default options
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">completedOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// validate options
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">errs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">completedOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Validate</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">utilerrors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAggregate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">completedOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">namedFlagSets</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">namedFlagSets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSets</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">usageFmt</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;Usage:\n  %s\n&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cols</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">apiserverflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TerminalSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetUsageFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStderr</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">usageFmt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseLine</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">apiserverflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintSections</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStderr</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">namedFlagSets</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cols</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetHelpFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;%s\n\n&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">usageFmt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Long</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseLine</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">apiserverflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintSections</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">namedFlagSets</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cols</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 构造option
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServerRunOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 添加flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">fs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">namedFlagSets</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">namedFlagSets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSets</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// set default options
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">completedOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">completedOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="3-newserverrunoptions">3. NewServerRunOptions</h1>
<p><code>NewServerRunOptions</code>基于默认的参数构造<code>ServerRunOptions</code>结构体。<code>ServerRunOptions</code>是apiserver运行的配置信息。具体结构体定义如下。</p>
<h2 id="3-1-serverrunoptions">3.1. ServerRunOptions</h2>
<p>其中主要的配置如下：</p>
<ul>
<li>GenericServerRunOptions</li>
<li>Etcd</li>
<li>SecureServing</li>
<li>KubeletConfig</li>
<li>...</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ServerRunOptions runs a kubernetes api server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ServerRunOptions</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">GenericServerRunOptions</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerRunOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Etcd</span>                    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EtcdOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">SecureServing</span>           <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServingOptionsWithLoopback</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">InsecureServing</span>         <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeprecatedInsecureServingOptionsWithLoopback</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Audit</span>                   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuditOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Features</span>                <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FeatureOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Admission</span>               <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdmissionOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Authentication</span>          <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuiltInAuthenticationOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Authorization</span>           <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuiltInAuthorizationOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">CloudProvider</span>           <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CloudProviderOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">StorageSerialization</span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageSerializationOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">APIEnablement</span>           <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">APIEnablementOptions</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AllowPrivileged</span>           <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">EnableLogsHandler</span>         <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">EventTTL</span>                  <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">KubeletConfig</span>             <span style="color:#000">kubeletclient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletClientConfig</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">KubernetesServiceNodePort</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MaxConnectionBytesPerSec</span>  <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ServiceClusterIPRange</span>     <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IPNet</span> <span style="color:#8f5902;font-style:italic">// TODO: make this a list
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ServiceNodePortRange</span>      <span style="color:#000">utilnet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PortRange</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">SSHKeyfile</span>                <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">SSHUser</span>                   <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ProxyClientCertFile</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ProxyClientKeyFile</span>  <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">EnableAggregatorRouting</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MasterCount</span>            <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">EndpointReconcilerType</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ServiceAccountSigningKeyFile</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-newserverrunoptions">3.2. NewServerRunOptions</h2>
<p><code>NewServerRunOptions</code>初始化配置结构体。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewServerRunOptions creates a new ServerRunOptions object with default parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewServerRunOptions</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ServerRunOptions</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ServerRunOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">genericoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServerRunOptions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Etcd</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">genericoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewEtcdOptions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">storagebackend</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDefaultConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultEtcdPathPrefix</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSecureServingOptions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">InsecureServing</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInsecureServingOptions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Audit</span><span style="color:#000;font-weight:bold">:</span>                <span style="color:#000">genericoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAuditOptions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Features</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">genericoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewFeatureOptions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Admission</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAdmissionOptions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBuiltInAuthenticationOptions</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">WithAll</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Authorization</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBuiltInAuthorizationOptions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">CloudProvider</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCloudProviderOptions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">StorageSerialization</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewStorageSerializationOptions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">APIEnablement</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">genericoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAPIEnablementOptions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">EnableLogsHandler</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">EventTTL</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Hour</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MasterCount</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">EndpointReconcilerType</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reconcilers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaseEndpointReconcilerType</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">kubeletclient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletClientConfig</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Port</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">ports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletPort</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ReadOnlyPort</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">ports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletReadOnlyPort</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">PreferredAddressTypes</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// --override-hostname
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeHostName</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// internal, preferring DNS if reported
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInternalDNS</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInternalIP</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// external, preferring DNS if reported
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeExternalDNS</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeExternalIP</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">EnableHttps</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">HTTPTimeout</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ServiceNodePortRange</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultServiceNodePortRange</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceClusterIPRange</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultServiceIPCIDR</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Overwrite the default for storage data format.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Etcd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultStorageMediaType</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;application/vnd.kubernetes.protobuf&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-complete">3.3. Complete</h2>
<p>当kube-apiserver的flags被解析后，调用<code>Complete</code>完成默认配置。</p>
<blockquote>
<p>此部分代码位于cmd/kube-apiserver/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Should be called after kube-apiserver flags parsed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerRunOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">completedServerRunOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">options</span> <span style="color:#000">completedServerRunOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// set defaults
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultAdvertiseAddress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServingOptions</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultAdvertiseAddress</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InsecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeprecatedInsecureServingOptions</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">serviceIPRange</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">apiServerServiceIP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">master</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultServiceIPRange</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceClusterIPRange</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error determining service IP ranges: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceClusterIPRange</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">serviceIPRange</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaybeDefaultWithSelfSignedCerts</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdvertiseAddress</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;kubernetes.default.svc&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kubernetes.default&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kubernetes&#34;</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IP</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">apiServerServiceIP</span><span style="color:#000;font-weight:bold">});</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error creating self-signed certificates: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExternalHost</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdvertiseAddress</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExternalHost</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AdvertiseAddress</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">hostname</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Hostname</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExternalHost</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">hostname</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error finding host name: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;external host was not specified, using %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExternalHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ApplyAuthorization</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authorization</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Use (ServiceAccountSigningKeyFile != &#34;&#34;) as a proxy to the user enabling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// TokenRequest functionality. This defaulting was convenient, but messed up
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// a lot of people when they rotated their serving cert with no idea it was
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// connected to their service account keys. We are taking this oppurtunity to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// remove this problematic defaulting.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceAccountSigningKeyFile</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Default to the private server key for service account token signing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceAccounts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyFiles</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerCert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertKey</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyFile</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeauthenticator</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsValidServiceAccountKeyFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerCert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertKey</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyFile</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceAccounts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyFiles</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerCert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertKey</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyFile</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;No TLS key provided, service account token authentication disabled&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Etcd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeserializationCacheSize</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// When size of cache is not explicitly set, estimate its size based on
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// target memory usage.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Initializing deserialization cache size based on %dMB limit&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TargetRAMMB</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// This is the heuristics that from memory capacity is trying to infer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// the maximum number of nodes in the cluster and set cache sizes based
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// on that value.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// From our documentation, we officially recommend 120GB machines for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// 2000 nodes, and we scale from that point. Thus we assume ~60MB of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// capacity per node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// TODO: We may consider deciding that some percentage of memory will
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// be used for the deserialization cache and divide it by the max object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// size to compute its size. We may even go further and measure
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// collective sizes of the objects in the cache.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">clusterSize</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TargetRAMMB</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">60</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Etcd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeserializationCacheSize</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">25</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">clusterSize</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Etcd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeserializationCacheSize</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">1000</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Etcd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeserializationCacheSize</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Etcd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableWatchCache</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Initializing cache sizes based on %dMB limit&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TargetRAMMB</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sizes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cachesize</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewHeuristicWatchCacheSizes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TargetRAMMB</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">userSpecified</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">serveroptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseWatchCacheSizes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Etcd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WatchCacheSizes</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">resource</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">userSpecified</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">sizes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">resource</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">size</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Etcd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WatchCacheSizes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">serveroptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteWatchCacheSizes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sizes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: remove when we stop supporting the legacy group version.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">APIEnablement</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RuntimeConfig</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">APIEnablement</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RuntimeConfig</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;v1&#34;</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HasPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;v1/&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">||</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;api/v1&#34;</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HasPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;api/v1/&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">APIEnablement</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RuntimeConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">APIEnablement</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RuntimeConfig</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;/v1&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;api/legacy&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">APIEnablement</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RuntimeConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerRunOptions</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">s</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-addflagset">3. AddFlagSet</h1>
<p><code>AddFlagSet</code>主要的作用是通过外部传入的flag的具体值，解析的时候传递给option的结构体，最终给apiserver使用。</p>
<p>其中<code>NewAPIServerCommand</code>关于<code>AddFlagSet</code>的相关代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">fs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">namedFlagSets</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">namedFlagSets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSets</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-1-flags">3.1. Flags</h2>
<p><code>Flags</code>完整代码如下：</p>
<blockquote>
<p>此部分代码位于cmd/kube-apiserver/app/options/options.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Flags returns flags for a specific APIServer by section name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ServerRunOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span> <span style="color:#000">apiserverflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamedFlagSets</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Add the generic flags.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericServerRunOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddUniversalFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;generic&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Etcd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;etcd&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;secure serving&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InsecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;insecure serving&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InsecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddUnqualifiedFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;insecure serving&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// TODO: remove it until kops stops using `--address`
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Audit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;auditing&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;features&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;authentication&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authorization</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;authorization&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CloudProvider</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cloud provider&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageSerialization</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;storage&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">APIEnablement</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;api enablement&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Admission</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;admission&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Note: the weird &#34;&#34;+ in below lines seems to be the only way to get gofmt to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// arrange these text blocks sensibly. Grrr.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fss</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;misc&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DurationVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTTL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;event-ttl&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTTL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Amount of time to retain events.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BoolVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllowPrivileged</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;allow-privileged&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllowPrivileged</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;If true, allow privileged containers. [default=false]&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BoolVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableLogsHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;enable-logs-handler&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableLogsHandler</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;If true, install a /logs handler for the apiserver logs.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated in release 1.9
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SSHUser</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ssh-user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SSHUser</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;If non-empty, use secure SSH proxy to the nodes, using this user name&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MarkDeprecated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ssh-user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;This flag will be removed in a future version.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deprecated in release 1.9
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SSHKeyfile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ssh-keyfile&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SSHKeyfile</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;If non-empty, use secure SSH proxy to the nodes, using this user keyfile&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MarkDeprecated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ssh-keyfile&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;This flag will be removed in a future version.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int64Var</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxConnectionBytesPerSec</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;max-connection-bytes-per-sec&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxConnectionBytesPerSec</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;If non-zero, throttle each user connection to this number of bytes/sec. &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Currently only applies to long-running requests.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IntVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MasterCount</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;apiserver-count&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MasterCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;The number of apiservers running in the cluster, must be a positive number. (In use when --endpoint-reconciler-type=master-count is enabled.)&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EndpointReconcilerType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;endpoint-reconciler-type&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EndpointReconcilerType</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Use an endpoint reconciler (&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reconcilers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllTypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Names</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;, &#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#4e9a06">&#34;)&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// See #14282 for details on how to test/try this option out.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// TODO: remove this comment once this option is tested in CI.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IntVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubernetesServiceNodePort</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kubernetes-service-node-port&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubernetesServiceNodePort</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;If non-zero, the Kubernetes master service (which apiserver creates/maintains) will be &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;of type NodePort, using this as the value of the port. If zero, the Kubernetes master &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;service will be of type ClusterIP.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IPNetVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceClusterIPRange</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;service-cluster-ip-range&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceClusterIPRange</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;A CIDR notation IP range from which to assign service cluster IPs. This must not &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;overlap with any IP ranges assigned to nodes for pods.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Var</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceNodePortRange</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;service-node-port-range&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;A port range to reserve for services with NodePort visibility. &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Example: &#39;30000-32767&#39;. Inclusive at both ends of the range.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Kubelet related flags:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BoolVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableHttps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kubelet-https&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableHttps</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Use https for kubelet connections.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringSliceVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreferredAddressTypes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kubelet-preferred-address-types&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreferredAddressTypes</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;List of the preferred NodeAddressTypes to use for kubelet connections.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UintVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Port</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kubelet-port&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Port</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;DEPRECATED: kubelet port.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MarkDeprecated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kubelet-port&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kubelet-port is deprecated and will be removed.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UintVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadOnlyPort</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kubelet-read-only-port&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadOnlyPort</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;DEPRECATED: kubelet port.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DurationVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HTTPTimeout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kubelet-timeout&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HTTPTimeout</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Timeout for kubelet operations.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kubelet-client-certificate&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertFile</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Path to a client cert file for TLS.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kubelet-client-key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyFile</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Path to a client key file for TLS.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CAFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kubelet-certificate-authority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CAFile</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Path to a cert file for the certificate authority.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: delete this flag in 1.13
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">repair</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BoolVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">repair</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;repair-malformed-updates&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;deprecated&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MarkDeprecated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;repair-malformed-updates&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;This flag will be removed in a future version&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProxyClientCertFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;proxy-client-cert-file&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProxyClientCertFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Client certificate used to prove the identity of the aggregator or kube-apiserver &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;when it must call out during a request. This includes proxying requests to a user &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;api-server and calling out to webhook admission plugins. It is expected that this &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;cert includes a signature from the CA in the --requestheader-client-ca-file flag. &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;That CA is published in the &#39;extension-apiserver-authentication&#39; configmap in &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;the kube-system namespace. Components receiving calls from kube-aggregator should &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;use that CA to perform their half of the mutual TLS verification.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProxyClientKeyFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;proxy-client-key-file&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProxyClientKeyFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Private key for the client certificate used to prove the identity of the aggregator or kube-apiserver &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;when it must call out during a request. This includes proxying requests to a user &#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;api-server and calling out to webhook admission plugins.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BoolVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableAggregatorRouting</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;enable-aggregator-routing&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableAggregatorRouting</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Turns on aggregator routing requests to endpoints IP rather than cluster IP.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceAccountSigningKeyFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;service-account-signing-key-file&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceAccountSigningKeyFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Path to the file that contains the current private key of the service account token issuer. The issuer will sign issued ID tokens with this private key. (Requires the &#39;TokenRequest&#39; feature gate.)&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fss</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-run">4. Run</h1>
<p><code>Run</code>以常驻的方式运行apiserver。</p>
<p><strong>主要内容如下：</strong></p>
<ol>
<li>构造一个聚合的server结构体。</li>
<li>执行PrepareRun。</li>
<li>最终执行Run。</li>
</ol>
<blockquote>
<p>此部分代码位于cmd/kube-apiserver/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run runs the specified APIServer.  This should never exit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">completeOptions</span> <span style="color:#000">completedServerRunOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// To help debugging, immediately log version
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Version: %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">server</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">CreateServerChain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">completeOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrepareRun</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-1-createserverchain">4.1. CreateServerChain</h2>
<p>构造聚合的Server。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>首先生成config对象，包括<code>kubeAPIServerConfig</code>、<code>apiExtensionsConfig</code>。</li>
<li>再通过config生成server对象，包括<code>apiExtensionsServer</code>、<code>kubeAPIServer</code>。</li>
<li>执行<code>apiExtensionsServer</code>、<code>kubeAPIServer</code>的<code>PrepareRun</code>部分。</li>
<li>生成聚合的config对象<code>aggregatorConfig</code>。</li>
<li>基于<code>aggregatorConfig</code>、<code>kubeAPIServer</code>、<code>apiExtensionsServer</code>生成聚合的server<code>aggregatorServer</code>。</li>
</ol>
<blockquote>
<p>此部分代码位于cmd/kube-apiserver/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// CreateServerChain creates the apiservers connected via delegation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">CreateServerChain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">completedOptions</span> <span style="color:#000">completedServerRunOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericapiserver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericAPIServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeTunneler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">proxyTransport</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">CreateNodeDialer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">completedOptions</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeAPIServerConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">insecureServingInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">serviceResolver</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pluginInitializer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">admissionPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">CreateKubeAPIServerConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">completedOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeTunneler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">proxyTransport</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If additional API servers are added, they should be gated.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">apiExtensionsConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createAPIExtensionsConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeAPIServerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeAPIServerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtraConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VersionedInformers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pluginInitializer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">completedOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerRunOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">completedOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MasterCount</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">apiExtensionsServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createAPIExtensionsServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">apiExtensionsConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">genericapiserver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewEmptyDelegate</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeAPIServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">CreateKubeAPIServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeAPIServerConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">apiExtensionsServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericAPIServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">admissionPostStartHook</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// otherwise go down the normal path of standing the aggregator up in front of the API server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// this wires up openapi
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kubeAPIServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericAPIServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrepareRun</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// This will wire up openapi for extension api server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">apiExtensionsServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericAPIServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrepareRun</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// aggregator comes last in the chain
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">aggregatorConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createAggregatorConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeAPIServerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">completedOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerRunOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeAPIServerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtraConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VersionedInformers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">serviceResolver</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">proxyTransport</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pluginInitializer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">aggregatorServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createAggregatorServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">aggregatorConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeAPIServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericAPIServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">apiExtensionsServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informers</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// we don&#39;t need special handling for innerStopCh because the aggregator server doesn&#39;t create any go routines
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">insecureServingInfo</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">insecureHandlerChain</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeserver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BuildInsecureHandlerChain</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">aggregatorServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericAPIServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UnprotectedHandler</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">kubeAPIServerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">insecureServingInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">insecureHandlerChain</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeAPIServerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestTimeout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">aggregatorServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenericAPIServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-2-preparerun">4.2. PrepareRun</h2>
<p><code>PrepareRun</code>主要执行一些API安装操作。</p>
<blockquote>
<p>此部分的代码位于vendor/k8s.io/apiserver/pkg/server/genericapiserver.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PrepareRun does post API installation setup steps.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">GenericAPIServer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">PrepareRun</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">preparedGenericAPIServer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">swaggerConfig</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">routes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Swagger</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">swaggerConfig</span><span style="color:#000;font-weight:bold">}.</span><span style="color:#000">Install</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GoRestfulContainer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">openAPIConfig</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">routes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OpenAPI</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Config</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">openAPIConfig</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}.</span><span style="color:#000">Install</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GoRestfulContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NonGoRestfulMux</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">installHealthz</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Register audit backend preShutdownHook.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuditBackend</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPreShutdownHook</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;audit-backend&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AuditBackend</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Shutdown</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">preparedGenericAPIServer</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-3-preparedgenericapiserver-run">4.3. preparedGenericAPIServer.Run</h2>
<p><code>preparedGenericAPIServer.Run</code>运行一个安全的http server。具体的实现逻辑待后续文章分析。</p>
<blockquote>
<p>此部分代码位于vendor/k8s.io/apiserver/pkg/server/genericapiserver.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run spawns the secure http server. It only returns if stopCh is closed
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// or the secure port cannot be listened on initially.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#000">preparedGenericAPIServer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NonBlockingRun</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunPreShutdownHooks</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Wait for all requests to finish, which are bounded by the RequestTimeout variable.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlerChainWaitGroup</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心函数：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NonBlockingRun</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>preparedGenericAPIServer.Run</code>主要是调用<code>NonBlockingRun</code>函数，最终运行一个http server。该部分逻辑待后续文章分析。</p>
<h1 id="5-总结">5. 总结</h1>
<p><code>NewAPIServerCommand</code>采用了<a href="https://github.com/spf13/cobra">Cobra</a>命令行框架，该框架使用主要包含以下部分：</p>
<ul>
<li>构造option参数，提供给执行主体(例如 本文的server)作为配置参数使用。</li>
<li>添加Flags，主要用来通过传入的flags参数最终解析成option中使用的结构体属性。</li>
<li>执行Run函数，执行主体的运行逻辑部分（核心部分）。</li>
</ul>
<p>其中Run函数的主要内容如下：</p>
<ol>
<li>构造一个聚合的server结构体。</li>
<li>执行PrepareRun。</li>
<li>最终执行preparedGenericAPIServer.Run。</li>
</ol>
<p><code>preparedGenericAPIServer.Run</code>主要是调用<code>NonBlockingRun</code>函数，最终运行一个http server。<code>NonBlockingRun</code>的具体逻辑待后续文章再单独分析。</p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kube-apiserver">https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kube-apiserver</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-apiserver/app/server.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-apiserver/app/server.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-apiserver/app/aggregator.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-apiserver/app/aggregator.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-apiserver/app/options/options.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-apiserver/app/options/options.go</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dac34401574b403cd1a9f38c0bc9fd52">3 - kube-controller-manager</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e90778a963162288e7bcb659355fb477">3.1 - controller-manager 源码思维导图</h1>
    
	<h2 id="源码整体结构图">源码整体结构图</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1618721763/article/code-analysis/kube-controller-manager/controller-manager.png" width="100%">

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-62456a4dd94fd74fda9ec5ad3c5ab14a">3.2 - kube-controller-manager源码分析（一）之 NewControllerManagerCommand</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
<p>本文主要分析https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kube-controller-manager 部分的代码。</p>
</blockquote>
<p>本文主要分析 <code>kubernetes/cmd/kube-controller-manager</code>部分，该部分主要涉及各种类型的<code>controller</code>的参数解析，及初始化，例如 <code>deployment controller</code> 和<code>statefulset controller</code>。并没有具体<code>controller</code>运行的详细逻辑，该部分位于<code>kubernetes/pkg/controller</code>模块，待后续文章分析。</p>
<p><code>kube-controller-manager</code>的<code>cmd</code>部分代码目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kube-controller-manager
</span></span><span style="display:flex;"><span>├── app
</span></span><span style="display:flex;"><span>│   ├── apps.go   <span style="color:#8f5902;font-style:italic"># 包含:startDeploymentController、startReplicaSetController、startStatefulSetController、startDaemonSetController</span>
</span></span><span style="display:flex;"><span>│   ├── autoscaling.go <span style="color:#8f5902;font-style:italic"># startHPAController</span>
</span></span><span style="display:flex;"><span>│   ├── batch.go  <span style="color:#8f5902;font-style:italic"># startJobController、startCronJobController</span>
</span></span><span style="display:flex;"><span>│   ├── bootstrap.go
</span></span><span style="display:flex;"><span>│   ├── certificates.go
</span></span><span style="display:flex;"><span>│   ├── cloudproviders.go
</span></span><span style="display:flex;"><span>│   ├── config
</span></span><span style="display:flex;"><span>│   │   └── config.go   <span style="color:#8f5902;font-style:italic"># config: controller manager执行的上下文</span>
</span></span><span style="display:flex;"><span>│   ├── controllermanager.go   <span style="color:#8f5902;font-style:italic"># 包含:NewControllerManagerCommand、Run、NewControllerInitializers、StartControllers等</span>
</span></span><span style="display:flex;"><span>│   ├── core.go   <span style="color:#8f5902;font-style:italic"># startServiceController、startNodeIpamController、startPersistentVolumeBinderController、startNamespaceController等</span>
</span></span><span style="display:flex;"><span>│   ├── options    <span style="color:#8f5902;font-style:italic"># 包含不同controller的option参数</span>
</span></span><span style="display:flex;"><span>│   │   ├── attachdetachcontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── csrsigningcontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── daemonsetcontroller.go   <span style="color:#8f5902;font-style:italic"># DaemonSetControllerOptions</span>
</span></span><span style="display:flex;"><span>│   │   ├── deploymentcontroller.go  <span style="color:#8f5902;font-style:italic"># DeploymentControllerOptions</span>
</span></span><span style="display:flex;"><span>│   │   ├── deprecatedcontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── endpointcontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── garbagecollectorcontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── hpacontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── jobcontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── namespacecontroller.go   <span style="color:#8f5902;font-style:italic"># NamespaceControllerOptions</span>
</span></span><span style="display:flex;"><span>│   │   ├── nodeipamcontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── nodelifecyclecontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── options.go  <span style="color:#8f5902;font-style:italic"># KubeControllerManagerOptions、NewKubeControllerManagerOptions</span>
</span></span><span style="display:flex;"><span>│   │   ├── persistentvolumebindercontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── podgccontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── replicasetcontroller.go   <span style="color:#8f5902;font-style:italic"># ReplicaSetControllerOptions</span>
</span></span><span style="display:flex;"><span>│   │   ├── replicationcontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── resourcequotacontroller.go
</span></span><span style="display:flex;"><span>│   │   ├── serviceaccountcontroller.go
</span></span><span style="display:flex;"><span>│   │   └── ttlafterfinishedcontroller.go
</span></span><span style="display:flex;"><span>└── controller-manager.go  <span style="color:#8f5902;font-style:italic"># main入口函数</span>
</span></span></code></pre></div><h1 id="1-main函数-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kube-controller-manager-controller-manager-go-l41">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/controller-manager.go#L41">Main函数</a></h1>
<p><code>kube-controller-manager</code>的入口函数<code>Main</code>函数，仍然是采用统一的代码风格，使用<a href="https://github.com/spf13/cobra">Cobra</a>命令行框架。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UTC</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UnixNano</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerManagerCommand</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: once we switch everything over to Cobra commands, we can go back to calling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// utilflag.InitFlags() (by removing its pflag.Parse() call). For now, we have to set the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// normalize func and add the go flag set by hand.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetNormalizeFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">utilflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WordSepNormalizeFunc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddGoFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">goflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// utilflag.InitFlags()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlushLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 初始化命令行结构体
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerManagerCommand</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 执行Execute
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h1 id="2-newcontrollermanagercommand-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kube-controller-manager-app-controllermanager-go-l77">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/app/controllermanager.go#L77">NewControllerManagerCommand</a></h1>
<p>该部分代码位于：<code>kubernetes/cmd/kube-controller-manager/app/controllermanager.go</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewControllerManagerCommand creates a *cobra.Command object with default parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewControllerManagerCommand</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;kube-controller-manager&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Long</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`The Kubernetes controller manager is a daemon that embeds
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">the core control loops shipped with Kubernetes. In applications of robotics and
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">automation, a control loop is a non-terminating loop that regulates the state of
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">the system. In Kubernetes, a controller is a control loop that watches the shared
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">state of the cluster through the apiserver and makes changes attempting to move the
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">current state towards the desired state. Examples of controllers that ship with
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Kubernetes today are the replication controller, endpoints controller, namespace
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">controller, and serviceaccounts controller.`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Run</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">verflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintAndExitIfRequested</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">utilflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">KnownControllers</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">ControllersDisabledByDefault</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>构建一个<code>*cobra.Command</code>对象，然后执行<code>Run</code>函数。</p>
<h2 id="2-1-newkubecontrollermanageroptions">2.1. NewKubeControllerManagerOptions</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewKubeControllerManagerOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unable to initialize command options: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>初始化controllerManager的参数，其中主要包括了各种controller的option，例如<code>DeploymentControllerOptions</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// DeploymentControllerOptions holds the DeploymentController options.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">DeploymentControllerOptions</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ConcurrentDeploymentSyncs</span>      <span style="color:#204a87;font-weight:bold">int32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeploymentControllerSyncPeriod</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewKubeControllerManagerOptions creates a new KubeControllerManagerOptions with a default config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewKubeControllerManagerOptions</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">KubeControllerManagerOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewDefaultComponentConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InsecureKubeControllerManagerPort</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">KubeControllerManagerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Generic</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">cmoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewGenericControllerManagerConfigurationOptions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Generic</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">KubeCloudShared</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cmoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewKubeCloudSharedOptions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeCloudShared</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AttachDetachController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">AttachDetachControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ReconcilerSyncLoopPeriod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AttachDetachController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReconcilerSyncLoopPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">CSRSigningController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">CSRSigningControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ClusterSigningCertFile</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CSRSigningController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClusterSigningCertFile</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ClusterSigningKeyFile</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CSRSigningController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClusterSigningKeyFile</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ClusterSigningDuration</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CSRSigningController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClusterSigningDuration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DaemonSetController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">DaemonSetControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ConcurrentDaemonSetSyncs</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DaemonSetController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentDaemonSetSyncs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">DeploymentControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ConcurrentDeploymentSyncs</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentDeploymentSyncs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">DeploymentControllerSyncPeriod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentControllerSyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DeprecatedFlags</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">DeprecatedControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">RegisterRetryCount</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeprecatedController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterRetryCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">EndpointController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">EndpointControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ConcurrentEndpointSyncs</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EndpointController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentEndpointSyncs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">GarbageCollectorController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">GarbageCollectorControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ConcurrentGCSyncs</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GarbageCollectorController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentGCSyncs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">EnableGarbageCollector</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GarbageCollectorController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableGarbageCollector</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">HPAController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">HPAControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">HorizontalPodAutoscalerSyncPeriod</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HPAController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HorizontalPodAutoscalerSyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">HorizontalPodAutoscalerUpscaleForbiddenWindow</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HPAController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HorizontalPodAutoscalerUpscaleForbiddenWindow</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">HorizontalPodAutoscalerDownscaleForbiddenWindow</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HPAController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HorizontalPodAutoscalerDownscaleForbiddenWindow</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">HorizontalPodAutoscalerDownscaleStabilizationWindow</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HPAController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HorizontalPodAutoscalerDownscaleStabilizationWindow</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">HorizontalPodAutoscalerCPUInitializationPeriod</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HPAController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HorizontalPodAutoscalerCPUInitializationPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">HorizontalPodAutoscalerInitialReadinessDelay</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HPAController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HorizontalPodAutoscalerInitialReadinessDelay</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">HorizontalPodAutoscalerTolerance</span><span style="color:#000;font-weight:bold">:</span>                    <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HPAController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HorizontalPodAutoscalerTolerance</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">HorizontalPodAutoscalerUseRESTClients</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HPAController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HorizontalPodAutoscalerUseRESTClients</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">JobController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">JobControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ConcurrentJobSyncs</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">JobController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentJobSyncs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">NamespaceController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">NamespaceControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">NamespaceSyncPeriod</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceSyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ConcurrentNamespaceSyncs</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentNamespaceSyncs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">NodeIPAMController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">NodeIPAMControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">NodeCIDRMaskSize</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeIPAMController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeCIDRMaskSize</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">NodeLifecycleController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">NodeLifecycleControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">EnableTaintManager</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLifecycleController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableTaintManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">NodeMonitorGracePeriod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLifecycleController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeMonitorGracePeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">NodeStartupGracePeriod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLifecycleController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeStartupGracePeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">PodEvictionTimeout</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLifecycleController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodEvictionTimeout</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">PersistentVolumeBinderController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">PersistentVolumeBinderControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">PVClaimBinderSyncPeriod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeBinderController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVClaimBinderSyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">VolumeConfiguration</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeBinderController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumeConfiguration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">PodGCController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">PodGCControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">TerminatedPodGCThreshold</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodGCController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TerminatedPodGCThreshold</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ReplicaSetController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ReplicaSetControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ConcurrentRSSyncs</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentRSSyncs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ReplicationController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ReplicationControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ConcurrentRCSyncs</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicationController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentRCSyncs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ResourceQuotaController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ResourceQuotaControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ResourceQuotaSyncPeriod</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceQuotaController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceQuotaSyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ConcurrentResourceQuotaSyncs</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceQuotaController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentResourceQuotaSyncs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">SAController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">SAControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ConcurrentSATokenSyncs</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SAController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentSATokenSyncs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ServiceController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cmoptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ConcurrentServiceSyncs</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentServiceSyncs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">TTLAfterFinishedController</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">TTLAfterFinishedControllerOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ConcurrentTTLSyncs</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TTLAfterFinishedController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentTTLSyncs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">apiserveroptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSecureServingOptions</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">WithLoopback</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">InsecureServing</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">apiserveroptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeprecatedInsecureServingOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">BindAddress</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseIP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Generic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">BindPort</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">componentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Generic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Port</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">BindNetwork</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}).</span><span style="color:#000">WithLoopback</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">apiserveroptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDelegatingAuthenticationOptions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Authorization</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">apiserveroptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDelegatingAuthorizationOptions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteKubeConfigFileOptional</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authorization</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteKubeConfigFileOptional</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authorization</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AlwaysAllowPaths</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;/healthz&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerCert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertDirectory</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/var/run/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServerCert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PairName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;kube-controller-manager&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BindPort</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeControllerManagerPort</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">gcIgnoredResources</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#000">kubectrlmgrconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupResource</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">garbagecollector</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultIgnoredResources</span><span style="color:#000;font-weight:bold">()))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">garbagecollector</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultIgnoredResources</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">gcIgnoredResources</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gcIgnoredResources</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubectrlmgrconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupResource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Group</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Group</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Resource</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Resource</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GarbageCollectorController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GCIgnoredResources</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">gcIgnoredResources</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-addflagset">2.2. AddFlagSet</h2>
<p>添加参数及帮助函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">fs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">namedFlagSets</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">KnownControllers</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">ControllersDisabledByDefault</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">namedFlagSets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSets</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">usageFmt</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;Usage:\n  %s\n&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cols</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">apiserverflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TerminalSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetUsageFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStderr</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">usageFmt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseLine</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">apiserverflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintSections</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStderr</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">namedFlagSets</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cols</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetHelpFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;%s\n\n&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">usageFmt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Long</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseLine</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">apiserverflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintSections</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">namedFlagSets</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cols</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><h1 id="3-run-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kube-controller-manager-app-controllermanager-go-l141">3. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/app/controllermanager.go#L141">Run</a></h1>
<blockquote>
<p>此部分的代码位于cmd/kube-controller-manager/app/controllermanager.go</p>
</blockquote>
<p>基于<code>KubeControllerManagerOptions</code>运行controllerManager，不退出。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run runs the KubeControllerManagerOptions.  This should never exit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CompletedConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">run</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">CreateControllerContext</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rootClientBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clientBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error building controller context: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">saTokenControllerInitFunc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">serviceAccountTokenControllerStarter</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">rootClientBuilder</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">rootClientBuilder</span><span style="color:#000;font-weight:bold">}.</span><span style="color:#000">startServiceAccountTokenController</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">StartControllers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">saTokenControllerInitFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewControllerInitializers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LoopMode</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">unsecuredMux</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error starting controllers: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformersStarted</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Run函数涉及的核心代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 创建controller的context
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">CreateControllerContext</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rootClientBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clientBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 启动各种controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">StartControllers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">saTokenControllerInitFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewControllerInitializers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LoopMode</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">unsecuredMux</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>其中<code>StartControllers</code>中的入参<code>NewControllerInitializers</code>初始化了各种controller。</p>
<h2 id="3-1-createcontrollercontext">3.1. CreateControllerContext</h2>
<p><code>CreateControllerContext</code>构建了各种controller所需的资源的上下文，各种controller在启动时，入参为该context，具体参考<code>initFn(ctx)</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// CreateControllerContext creates a context struct containing references to resources needed by the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// controllers such as the cloud provider and clientBuilder. rootClientBuilder is only used for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the shared-informers client and token controller.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">CreateControllerContext</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CompletedConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rootClientBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clientBuilder</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerClientBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ControllerContext</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">versionedClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rootClientBuilder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientOrDie</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;shared-informers&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sharedInformers</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">informers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSharedInformerFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">versionedClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ResyncPeriod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If apiserver is not running we should wait for some time and fail only then. This is particularly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// important when we start apiserver and controller manager at the same time.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">genericcontrollermanager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForAPIServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">versionedClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ControllerContext</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to wait for apiserver being healthy: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Use a discovery client capable of being refreshed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">discoveryClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rootClientBuilder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientOrDie</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;controller-discovery&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cachedClient</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cacheddiscovery</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMemCacheClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">discoveryClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Discovery</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">restMapper</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">restmapper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDeferredDiscoveryRESTMapper</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cachedClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">restMapper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reset</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">30</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">availableResources</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">GetAvailableResources</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rootClientBuilder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ControllerContext</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cloud</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">loopMode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createCloudProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeCloudShared</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CloudProvider</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeCloudShared</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExternalCloudVolumePlugin</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeCloudShared</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CloudProvider</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CloudConfigFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeCloudShared</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllowUntaggedCloud</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sharedInformers</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ControllerContext</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ControllerContext</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ClientBuilder</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">clientBuilder</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">sharedInformers</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">RESTMapper</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">restMapper</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AvailableResources</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">availableResources</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Cloud</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">cloud</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">LoopMode</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">loopMode</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">:</span>               <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">InformersStarted</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ResyncPeriod</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">ResyncPeriod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码为<code>NewSharedInformerFactory</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 创建SharedInformerFactory
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">sharedInformers</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">informers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSharedInformerFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">versionedClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ResyncPeriod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)())</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 赋值给ControllerContext
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ControllerContext</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">sharedInformers</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>SharedInformerFactory</code>提供了公共的k8s对象的<code>informers</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// SharedInformerFactory provides shared informers for resources in all known
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// API group versions.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">SharedInformerFactory</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">internalinterfaces</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedInformerFactory</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ForResource</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resource</span> <span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionResource</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">GenericInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Admissionregistration</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">admissionregistration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Apps</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Autoscaling</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">autoscaling</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Batch</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">batch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Certificates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">certificates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Coordination</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">coordination</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Core</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Events</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Extensions</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">extensions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Networking</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">networking</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Policy</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">policy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Rbac</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">rbac</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Scheduling</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">scheduling</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Settings</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Storage</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">storage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-newcontrollerinitializers">3.2. NewControllerInitializers</h2>
<p><code>NewControllerInitializers</code>定义了各种controller的类型和其对于的启动函数，例如<code>deployment``、statefulset</code>、<code>replicaset</code>、<code>replicationcontroller</code>、<code>namespace</code>等。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewControllerInitializers is a public map of named controller groups (you can start more than one in an init func)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// paired to their InitFunc.  This allows for structured downstream composition and subdivision.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewControllerInitializers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">loopMode</span> <span style="color:#000">ControllerLoopMode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">InitFunc</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">InitFunc</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;endpoint&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startEndpointController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;replicationcontroller&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startReplicationController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;podgc&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startPodGCController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;resourcequota&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startResourceQuotaController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;namespace&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startNamespaceController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;serviceaccount&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startServiceAccountController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;garbagecollector&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startGarbageCollectorController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;daemonset&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startDaemonSetController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;job&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startJobController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;deployment&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startDeploymentController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;replicaset&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startReplicaSetController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;horizontalpodautoscaling&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startHPAController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;disruption&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startDisruptionController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;statefulset&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startStatefulSetController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;cronjob&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startCronJobController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;csrsigning&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startCSRSigningController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;csrapproving&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startCSRApprovingController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;csrcleaner&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startCSRCleanerController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;ttl&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startTTLController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;bootstrapsigner&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startBootstrapSignerController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;tokencleaner&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startTokenCleanerController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;nodeipam&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startNodeIpamController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">loopMode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">IncludeCloudLoops</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;service&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startServiceController</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;route&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startRouteController</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// TODO: volume controller into the IncludeCloudLoops only set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// TODO: Separate cluster in cloud check from node lifecycle controller.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;nodelifecycle&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startNodeLifecycleController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;persistentvolume-binder&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startPersistentVolumeBinderController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;attachdetach&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startAttachDetachController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;persistentvolume-expander&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startVolumeExpandController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;clusterrole-aggregation&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startClusterRoleAggregrationController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;pvc-protection&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startPVCProtectionController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;pv-protection&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startPVProtectionController</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;ttl-after-finished&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startTTLAfterFinishedController</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">controllers</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-startcontrollers">3.3. StartControllers</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">StartControllers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">ControllerContext</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">startSATokenController</span> <span style="color:#000">InitFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllers</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">InitFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">unsecuredMux</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">mux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PathRecorderMux</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">initFn</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">controllers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsControllerEnabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%q is disabled&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Jitter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Generic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerStartInterval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ControllerStartJitter</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">debugHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">started</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">initFn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error starting %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">started</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Skipping %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">debugHandler</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">unsecuredMux</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">basePath</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;/debug/controllers/&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">controllerName</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">unsecuredMux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UnlistedHandle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">basePath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StripPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">basePath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">debugHandler</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">unsecuredMux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UnlistedHandlePrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">basePath</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StripPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">basePath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">debugHandler</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Started %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">initFn</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">controllers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">debugHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">started</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">initFn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>   
</span></span></code></pre></div><p>启动各种controller，controller的启动函数在<code>NewControllerInitializers</code>中定义了，例如：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// deployment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;deployment&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startDeploymentController</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// statefulset
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">controllers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;statefulset&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">startStatefulSetController</span>
</span></span></code></pre></div><h2 id="3-4-informerfactory-start">3.4. InformerFactory.Start</h2>
<p><code>InformerFactory</code>实际上是<code>SharedInformerFactory</code>，具体的实现逻辑在<code>client-go</code>中的informer的实现机制。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformersStarted</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="3-4-1-sharedinformerfactory">3.4.1. SharedInformerFactory</h3>
<p>SharedInformerFactory是一个informer工厂的接口定义。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// SharedInformerFactory a small interface to allow for adding an informer without an import cycle
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">SharedInformerFactory</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">InformerFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newFunc</span> <span style="color:#000">NewInformerFunc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedIndexInformer</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-4-2-sharedinformerfactory-start">3.4.2. sharedInformerFactory.Start</h3>
<p>Start方法初始化各种类型的informer</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start initializes all requested informers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sharedInformerFactory</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">informerType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">informer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">informers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedInformers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">informerType</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">informer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedInformers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">informerType</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-4-3-sharedindexinformer-run">3.4.3. sharedIndexInformer.Run</h3>
<p>sharedIndexInformer.Run具体运行了sharedIndexInformer的实现逻辑，该部分待后续对informer机制做专题分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sharedIndexInformer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fifo</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewDeltaFIFO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MetaNamespaceKeyFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">fifo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ListerWatcher</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listerWatcher</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ObjectType</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objectType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">FullResyncPeriod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncCheckPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">RetryOnError</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ShouldResync</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shouldResync</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Process</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleDeltas</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controller</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">clock</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">started</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Separate stop channel because Processor should be stopped strictly after controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">processorStopCh</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Group</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>              <span style="color:#8f5902;font-style:italic">// Wait for Processor to stop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processorStopCh</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// Tell Processor to stop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartWithChannel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processorStopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheMutationDetector</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartWithChannel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processorStopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stopped</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#8f5902;font-style:italic">// Don&#39;t want any new listeners
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-initfn-ctx">4. initFn(ctx)</h1>
<p><code>initFn</code>实际调用的就是各种类型的controller，代码位于<code>kubernetes/cmd/kube-controller-manager/app/apps.go</code>，本文以<code>startStatefulSetController</code>和<code>startDeploymentController</code>为例，controller中实际调用的函数逻辑位于<code>kubernetes/pkg/controller</code>中，待后续分析。</p>
<h2 id="4-1-startstatefulsetcontroller-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kube-controller-manager-app-apps-go-l55">4.1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/app/apps.go#L55">startStatefulSetController</a></h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">startStatefulSetController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">ControllerContext</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AvailableResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionResource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Group</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;apps&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Version</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;v1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Resource</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;statefulsets&#34;</span><span style="color:#000;font-weight:bold">}]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">statefulset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewStatefulSetController</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Core</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Apps</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">StatefulSets</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Core</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PersistentVolumeClaims</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Apps</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ControllerRevisions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientBuilder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientOrDie</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;statefulset-controller&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">).</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中使用到了<code>InformerFactory</code>，包含了Pods、StatefulSets、PersistentVolumeClaims、ControllerRevisions的informer。</p>
<p><code>startStatefulSetController</code>主要调用的函数为<code>NewStatefulSetController</code>和对应的<code>Run</code>函数。</p>
<h2 id="4-2-startdeploymentcontroller-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kube-controller-manager-app-apps-go-l82">4.2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/app/apps.go#L82">startDeploymentController</a></h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">startDeploymentController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">ControllerContext</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AvailableResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionResource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Group</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;apps&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Version</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;v1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Resource</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;deployments&#34;</span><span style="color:#000;font-weight:bold">}]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDeploymentController</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Apps</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Apps</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Core</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientBuilder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientOrDie</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;deployment-controller&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error creating Deployment controller: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentDeploymentSyncs</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>startDeploymentController</code>主要调用的函数为<code>NewDeploymentController</code>和对应的<code>Run</code>函数。该部分逻辑在<code>kubernetes/pkg/controller</code>中。</p>
<h1 id="5-总结">5. 总结</h1>
<ol>
<li>Kube-controller-manager的代码风格仍然是<a href="https://github.com/spf13/cobra">Cobra</a>命令行框架。通过构造<code>ControllerManagerCommand</code>，然后执行<code>command.Execute()</code>函数。基本的流程就是构造option，添加Flags，执行Run函数。</li>
<li>cmd部分的调用流程如下：<code>Main--&gt;NewControllerManagerCommand--&gt; Run(c.Complete(), wait.NeverStop)--&gt;StartControllers--&gt;initFn(ctx)--&gt;startDeploymentController/startStatefulSetController--&gt;sts.NewStatefulSetController.Run/dc.NewDeploymentController.Run--&gt;pkg/controller</code>。</li>
<li>其中<code>CreateControllerContext</code>函数用来创建各类型controller所需要使用的context，<code>NewControllerInitializers</code>初始化了各种类型的controller，其中就包括<code>DeploymentController</code>和<code>StatefulSetController</code>等。</li>
</ol>
<p>基本流程如下：</p>
<ol>
<li>构造controller manager option，并转化为Config对象，执行Run函数。</li>
<li>基于Config对象创建ControllerContext，其中包含InformerFactory。</li>
<li>基于ControllerContext运行各种controller，各种controller的定义在<code>NewControllerInitializers</code>中。</li>
<li>执行InformerFactory.Start。</li>
<li>每种controller都会构造自身的结构体并执行对应的Run函数。</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kube-controller-manager">https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kube-controller-manager</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/controller-manager.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/controller-manager.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/app/controllermanager.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/app/controllermanager.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/app/apps.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/app/apps.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ce1deaa7afc18bcddb66cab3ff6be50b">3.3 - kube-controller-manager源码分析（二）之 DeploymentController</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要以<code>deployment controller</code>为例，分析该类controller的运行逻辑。此部分代码主要为位于<code>pkg/controller/deployment</code>。<code>pkg/controller</code>部分的代码包括了各种类型的controller的具体实现。</p>
<p><code>controller manager</code>的<code>pkg</code>部分代码目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>controller  <span style="color:#8f5902;font-style:italic"># 主要包含各种controller的具体实现</span>
</span></span><span style="display:flex;"><span>├── apis
</span></span><span style="display:flex;"><span>├── bootstrap
</span></span><span style="display:flex;"><span>├── certificates
</span></span><span style="display:flex;"><span>├── client_builder.go
</span></span><span style="display:flex;"><span>├── cloud
</span></span><span style="display:flex;"><span>├── clusterroleaggregation
</span></span><span style="display:flex;"><span>├── controller_ref_manager.go
</span></span><span style="display:flex;"><span>├── controller_utils.go  <span style="color:#8f5902;font-style:italic"># WaitForCacheSync</span>
</span></span><span style="display:flex;"><span>├── cronjob
</span></span><span style="display:flex;"><span>├── daemon
</span></span><span style="display:flex;"><span>├── deployment   <span style="color:#8f5902;font-style:italic"># deployment controller</span>
</span></span><span style="display:flex;"><span>│   ├── deployment_controller.go <span style="color:#8f5902;font-style:italic"># NewDeploymentController、Run、syncDeployment</span>
</span></span><span style="display:flex;"><span>│   ├── progress.go   <span style="color:#8f5902;font-style:italic"># syncRolloutStatus</span>
</span></span><span style="display:flex;"><span>│   ├── recreate.go   <span style="color:#8f5902;font-style:italic"># rolloutRecreate</span>
</span></span><span style="display:flex;"><span>│   ├── rollback.go   <span style="color:#8f5902;font-style:italic"># rollback</span>
</span></span><span style="display:flex;"><span>│   ├── rolling.go    <span style="color:#8f5902;font-style:italic"># rolloutRolling</span>
</span></span><span style="display:flex;"><span>│   ├── sync.go
</span></span><span style="display:flex;"><span>├── disruption  <span style="color:#8f5902;font-style:italic"># disruption controller</span>
</span></span><span style="display:flex;"><span>├── endpoint
</span></span><span style="display:flex;"><span>├── garbagecollector
</span></span><span style="display:flex;"><span>├── <span style="color:#204a87">history</span>
</span></span><span style="display:flex;"><span>├── job
</span></span><span style="display:flex;"><span>├── lookup_cache.go
</span></span><span style="display:flex;"><span>├── namespace   <span style="color:#8f5902;font-style:italic"># namespace controller</span>
</span></span><span style="display:flex;"><span>├── nodeipam
</span></span><span style="display:flex;"><span>├── nodelifecycle
</span></span><span style="display:flex;"><span>├── podautoscaler
</span></span><span style="display:flex;"><span>├── podgc
</span></span><span style="display:flex;"><span>├── replicaset   <span style="color:#8f5902;font-style:italic"># replicaset controller</span>
</span></span><span style="display:flex;"><span>├── replication  <span style="color:#8f5902;font-style:italic"># replication controller</span>
</span></span><span style="display:flex;"><span>├── resourcequota
</span></span><span style="display:flex;"><span>├── route
</span></span><span style="display:flex;"><span>├── service   <span style="color:#8f5902;font-style:italic"># service controller</span>
</span></span><span style="display:flex;"><span>├── serviceaccount
</span></span><span style="display:flex;"><span>├── statefulset   <span style="color:#8f5902;font-style:italic"># statefulset controller</span>
</span></span><span style="display:flex;"><span>└── volume  <span style="color:#8f5902;font-style:italic"># PersistentVolumeController、AttachDetachController、PVCProtectionController</span>
</span></span></code></pre></div><h1 id="1-startdeploymentcontroller-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kube-controller-manager-app-apps-go-l82">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/app/apps.go#L82">startDeploymentController</a></h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">startDeploymentController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">ControllerContext</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AvailableResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionResource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Group</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;apps&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Version</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;v1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Resource</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;deployments&#34;</span><span style="color:#000;font-weight:bold">}]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDeploymentController</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Apps</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Apps</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Core</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientBuilder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientOrDie</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;deployment-controller&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error creating Deployment controller: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentDeploymentSyncs</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>startDeploymentController</code>主要调用的函数为<code>NewDeploymentController</code>和对应的<code>Run</code>函数。该部分逻辑在<code>kubernetes/pkg/controller</code>中。</p>
<h1 id="2-newdeploymentcontroller">2. NewDeploymentController</h1>
<p><code>NewDeploymentController</code>主要构建<code>DeploymentController</code>结构体。</p>
<p>该部分主要处理了以下逻辑：</p>
<ul>
<li>构建并运行事件处理器<code>eventBroadcaster</code>。</li>
<li>初始化赋值<code>rsControl</code>、<code>clientset</code>、<code>workqueue</code>。</li>
<li>添加<code>dInformer</code>、<code>rsInformer</code>、<code>podInformer</code>的<code>ResourceEventHandlerFuncs</code>，其中主要为<code>AddFunc</code>、<code>UpdateFunc</code>、<code>DeleteFunc</code>三类方法。</li>
<li>构造deployment、rs、pod的Informer的Lister函数和HasSynced函数。</li>
<li>调用<code>syncHandler</code>，来实现<code>syncDeployment</code>。</li>
</ul>
<h2 id="2-1-eventbroadcaster">2.1. eventBroadcaster</h2>
<p>调用事件处理器来记录deployment相关的事件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">eventBroadcaster</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBroadcaster</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartLogging</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: remove the wrapper when every clients have moved to use the clientset.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartRecordingToSink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventSinkImpl</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#000">Events</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)})</span>
</span></span></code></pre></div><h2 id="2-2-rscontrol">2.2. rsControl</h2>
<p>构造<code>DeploymentController</code>，包括<code>clientset</code>、<code>workqueue</code>和<code>rsControl</code>。其中<code>rsControl</code>是具体实现rs逻辑的controller。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRecorder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">scheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventSource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Component</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;deployment-controller&#34;</span><span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">queue</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNamedRateLimitingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultControllerRateLimiter</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;deployment&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsControl</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RealRSControl</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-informer-addeventhandler">2.3. Informer().AddEventHandler</h2>
<p>添加<code>dInformer</code>、<code>rsInformer</code>、<code>podInformer</code>的<code>ResourceEventHandlerFuncs</code>，其中主要为<code>AddFunc</code>、<code>UpdateFunc</code>、<code>DeleteFunc</code>三类方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">dInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addDeployment</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateDeployment</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// This will enter the sync loop and no-op, because the deployment has been deleted from the store.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteDeployment</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addReplicaSet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateReplicaSet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteReplicaSet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deletePod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><h2 id="2-4-informer-lister">2.4. Informer.Lister()</h2>
<p>调用<code>dInformer</code>、<code>rsInformer</code>和<code>podInformer</code>的<code>Lister()</code>方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dLister</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lister</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsLister</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lister</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podLister</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lister</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h2 id="2-5-informer-hassynced">2.5. Informer().HasSynced</h2>
<p>调用<code>Informer().HasSynced</code>，判断是否缓存完成；</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dListerSynced</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsListerSynced</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podListerSynced</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span>
</span></span></code></pre></div><h2 id="2-6-synchandler">2.6. syncHandler</h2>
<p><code>syncHandler</code>具体为<code>syncDeployment</code>，syncHandler负责deployment的同步实现。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncHandler</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncDeployment</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueDeployment</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueue</span>
</span></span></code></pre></div><p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewDeploymentController creates a new DeploymentController.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewDeploymentController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dInformer</span> <span style="color:#000">extensionsinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsInformer</span> <span style="color:#000">extensionsinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podInformer</span> <span style="color:#000">coreinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">client</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">eventBroadcaster</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBroadcaster</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartLogging</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: remove the wrapper when every clients have moved to use the clientset.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartRecordingToSink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventSinkImpl</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#000">Events</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">client</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">GetRateLimiter</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterMetricAndTrackRateLimiterUsage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;deployment_controller&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">GetRateLimiter</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">client</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRecorder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">scheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventSource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Component</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;deployment-controller&#34;</span><span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">queue</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNamedRateLimitingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultControllerRateLimiter</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;deployment&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsControl</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RealRSControl</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addDeployment</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateDeployment</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// This will enter the sync loop and no-op, because the deployment has been deleted from the store.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteDeployment</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addReplicaSet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateReplicaSet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteReplicaSet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deletePod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncHandler</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncDeployment</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueDeployment</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dLister</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lister</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsLister</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lister</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podLister</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lister</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dListerSynced</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsListerSynced</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podListerSynced</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-deploymentcontroller-run">3. DeploymentController.Run</h1>
<p>Run执行watch和sync的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run begins watching and syncing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">workers</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ShutDown</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting deployment controller&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Shutting down deployment controller&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;deployment&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dListerSynced</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsListerSynced</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podListerSynced</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">workers</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">worker</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-1-waitforcachesync">3.1. WaitForCacheSync</h2>
<p><code>WaitForCacheSync</code>主要是用来在<code>List-Watch</code>机制中可以保持当前cache的数据与etcd的数据一致。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// WaitForCacheSync is a wrapper around cache.WaitForCacheSync that generates log messages
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// indicating that the controller identified by controllerName is waiting for syncs, followed by
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// either a successful or failed sync.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">cacheSyncs</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerSynced</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Waiting for caches to sync for %s controller&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cacheSyncs</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unable to sync caches for %s controller&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Caches are synced for %s controller&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-dc-worker">3.2. dc.worker</h2>
<p><code>worker</code>调用了<code>processNextWorkItem</code>，<code>processNextWorkItem</code>最终调用了<code>syncHandler</code>，而<code>syncHandler</code>在<code>NewDeploymentController</code>中赋值的具体函数为<code>syncDeployment</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// worker runs a worker thread that just dequeues items, processes them, and marks them done.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It enforces that the syncHandler is never invoked concurrently with the same key.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">worker</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processNextWorkItem</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">processNextWorkItem</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">quit</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">quit</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handleErr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>NewDeploymentController</code>中的<code>syncHandler</code>赋值：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewDeploymentController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dInformer</span> <span style="color:#000">appsinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsInformer</span> <span style="color:#000">appsinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podInformer</span> <span style="color:#000">coreinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">client</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncHandler</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncDeployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><h1 id="4-syncdeployment">4. syncDeployment</h1>
<p><code>syncDeployment</code>基于给定的key执行sync deployment的操作。</p>
<p>主要流程如下：</p>
<ol>
<li>通过<code>SplitMetaNamespaceKey</code>获取namespace和deployment对象的name。</li>
<li>调用Lister的接口获取的deployment的对象。</li>
<li><code>getReplicaSetsForDeployment</code>获取deployment管理的ReplicaSet对象。</li>
<li><code>getPodMapForDeployment</code>获取deployment管理的pod，基于ReplicaSet来分组。</li>
<li><code>checkPausedConditions</code>检查deployment是否是<code>pause</code>状态并添加合适的<code>condition</code>。</li>
<li><code>isScalingEvent</code>检查deployment的更新是否来自于一个scale的事件，如果是则执行scale的操作。</li>
<li>根据<code>DeploymentStrategyType</code>类型执行<code>rolloutRecreate</code>或<code>rolloutRolling</code>。</li>
</ol>
<p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// syncDeployment will sync the deployment with the given key.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This function is not meant to be invoked concurrently with the same key.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Started syncing deployment %q (%v)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">startTime</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Finished syncing deployment %q (%v)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Since</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SplitMetaNamespaceKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotFound</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Deployment %v has been deleted&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Deep-copy otherwise we are mutating our cache.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// TODO: Deep-copy only when needed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">everything</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LabelSelector</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepEqual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Selector</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">everything</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;SelectingAll&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;This deployment is selecting all pods. A non-empty selector is required.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObservedGeneration</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Generation</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObservedGeneration</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Generation</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtensionsV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">UpdateStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// List ReplicaSets owned by this Deployment, while reconciling ControllerRef
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// through adoption/orphaning.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getReplicaSetsForDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// List all Pods owned by this Deployment, grouped by their ReplicaSet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Current uses of the podMap are:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// * check if a Pod is labeled correctly with the pod-template-hash label.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// * check that no old Pods are running in the middle of Recreate Deployments.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodMapForDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncStatusOnly</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Update deployment conditions with an Unknown condition when pausing/resuming
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// a deployment. In this way, we can be sure that we won&#39;t timeout when a user
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// resumes a Deployment with a set progressDeadlineSeconds.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">checkPausedConditions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Paused</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// rollback is not re-entrant in case the underlying replica sets are updated with a new
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// revision so we should ensure that we won&#39;t proceed to update replica sets until we
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// make sure that the deployment has cleaned up its rollback spec in subsequent enqueues.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RollbackTo</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rollback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">scalingEvent</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isScalingEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">scalingEvent</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Strategy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">extensions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RecreateDeploymentStrategyType</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rolloutRecreate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">extensions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RollingUpdateDeploymentStrategyType</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rolloutRolling</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unexpected deployment strategy type: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Strategy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-1-get-deployment">4.1. Get deployment</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// get namespace and deployment name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SplitMetaNamespaceKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// get deployment by name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="4-2-getreplicasetsfordeployment">4.2. getReplicaSetsForDeployment</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// List ReplicaSets owned by this Deployment, while reconciling ControllerRef
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// through adoption/orphaning.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getReplicaSetsForDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>getReplicaSetsForDeployment具体代码:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// getReplicaSetsForDeployment uses ControllerRefManager to reconcile
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ControllerRef by adopting and orphaning.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It returns the list of ReplicaSets that this Deployment should manage.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">getReplicaSetsForDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// List all ReplicaSets to find those we own but that no longer match our
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// selector. They will be orphaned by ClaimReplicaSets().
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">labels</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Everything</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">deploymentSelector</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LabelSelectorAsSelector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Selector</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;deployment %s/%s has invalid label selector: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If any adoptions are attempted, we should first recheck for deletion with
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// an uncached quorum read sometime after listing ReplicaSets (see #42639).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">canAdoptFunc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RecheckDeletionTimestamp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fresh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fresh</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;original Deployment %v/%v is gone: got uid %v, wanted %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fresh</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fresh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cm</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewReplicaSetControllerRefManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsControl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">deploymentSelector</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerKind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">canAdoptFunc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClaimReplicaSets</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-3-getpodmapfordeployment">4.3. getPodMapForDeployment</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// List all Pods owned by this Deployment, grouped by their ReplicaSet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Current uses of the podMap are:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// * check if a Pod is labeled correctly with the pod-template-hash label.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// * check that no old Pods are running in the middle of Recreate Deployments.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodMapForDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>getPodMapForDeployment具体代码：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// getPodMapForDeployment returns the Pods managed by a Deployment.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It returns a map from ReplicaSet UID to a list of Pods controlled by that RS,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// according to the Pod&#39;s ControllerRef.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">getPodMapForDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Get all Pods that potentially belong to this Deployment.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">selector</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LabelSelectorAsSelector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Selector</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">selector</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Group Pods by their controller (if it&#39;s in rsList).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">podMap</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">rsList</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodList</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Do not ignore inactive Pods because Recreate Deployments need to verify that no
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// Pods from older versions are running before spinning up new Pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">controllerRef</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetControllerOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">controllerRef</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Only append if we care about this UID.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">controllerRef</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">podList</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Items</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podList</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Items</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-4-checkpausedconditions">4.4. checkPausedConditions</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Update deployment conditions with an Unknown condition when pausing/resuming
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// a deployment. In this way, we can be sure that we won&#39;t timeout when a user
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// resumes a Deployment with a set progressDeadlineSeconds.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">checkPausedConditions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Paused</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>checkPausedConditions具体代码:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// checkPausedConditions checks if the given deployment is paused or not and adds an appropriate condition.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// These conditions are needed so that we won&#39;t accidentally report lack of progress for resumed deployments
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// that were paused for longer than progressDeadlineSeconds.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">checkPausedConditions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">deploymentutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HasProgressDeadline</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cond</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">deploymentutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetDeploymentCondition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentProgressing</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cond</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">cond</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">deploymentutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TimedOutReason</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// If we have reported lack of progress, do not overwrite it with a paused condition.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pausedCondExists</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cond</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">cond</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">deploymentutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PausedDeployReason</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">needsUpdate</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Paused</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">pausedCondExists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">condition</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">deploymentutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDeploymentCondition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentProgressing</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionUnknown</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">deploymentutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PausedDeployReason</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Deployment is paused&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">deploymentutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetDeploymentCondition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">condition</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">needsUpdate</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Paused</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">pausedCondExists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">condition</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">deploymentutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDeploymentCondition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentProgressing</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionUnknown</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">deploymentutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResumedDeployReason</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Deployment is resumed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">deploymentutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetDeploymentCondition</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">condition</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">needsUpdate</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">needsUpdate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">UpdateStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-5-isscalingevent">4.5. isScalingEvent</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">scalingEvent</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isScalingEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">scalingEvent</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>isScalingEvent具体代码:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// isScalingEvent checks whether the provided deployment has been updated with a scaling event
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// by looking at the desired-replicas annotation in the active replica sets of the deployment.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// rsList should come from getReplicaSetsForDeployment(d).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// podMap should come from getPodMapForDeployment(d, rsList).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">isScalingEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getAllReplicaSetsAndSyncRevision</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">allRSs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FilterActiveReplicaSets</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allRSs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">desired</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">deploymentutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetDesiredReplicasAnnotation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">desired</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Replicas</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-6-rolloutrecreate">4.6. rolloutRecreate</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Strategy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RecreateDeploymentStrategyType</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rolloutRecreate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>rolloutRecreate具体代码:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// rolloutRecreate implements the logic for recreating a replica set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">rolloutRecreate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podMap</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodList</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Don&#39;t create a new RS if not already existed, so that we avoid scaling up before scaling down.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getAllReplicaSetsAndSyncRevision</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">allRSs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">activeOldRSs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FilterActiveReplicaSets</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// scale down old replica sets.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">scaledDown</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scaleDownOldReplicaSetsForRecreate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">activeOldRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">scaledDown</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Update DeploymentStatus.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncRolloutStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Do not process a deployment when it has old pods running.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">oldPodsRunning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncRolloutStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If we need to create a new RS, create it now.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">newRS</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getAllReplicaSetsAndSyncRevision</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">allRSs</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// scale up new replica set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scaleUpNewReplicaSetForRecreate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentComplete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cleanupDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Sync deployment status.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncRolloutStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-7-rolloutrolling">4.7. rolloutRolling</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Strategy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RecreateDeploymentStrategyType</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rolloutRecreate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RollingUpdateDeploymentStrategyType</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rolloutRolling</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>rolloutRolling具体代码:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// rolloutRolling implements the logic for rolling a new replica set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">rolloutRolling</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getAllReplicaSetsAndSyncRevision</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">allRSs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Scale up, if we can.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">scaledUp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reconcileNewReplicaSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">scaledUp</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Update DeploymentStatus
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncRolloutStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Scale down, if we can.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">scaledDown</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reconcileOldReplicaSets</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FilterActiveReplicaSets</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">scaledDown</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Update DeploymentStatus
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncRolloutStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">deploymentutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentComplete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cleanupDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Sync deployment status
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncRolloutStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allRSs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-总结">5. 总结</h1>
<p><code>startDeploymentController</code>主要包括<code>NewDeploymentController</code>和<code>DeploymentController.Run</code>两部分。</p>
<p><code>NewDeploymentController</code>主要构建<code>DeploymentController</code>结构体。</p>
<p>该部分主要处理了以下逻辑：</p>
<ol>
<li>构建并运行事件处理器<code>eventBroadcaster</code>。</li>
<li>初始化赋值<code>rsControl</code>、<code>clientset</code>、<code>workqueue</code>。</li>
<li>添加<code>dInformer</code>、<code>rsInformer</code>、<code>podInformer</code>的<code>ResourceEventHandlerFuncs</code>，其中主要为<code>AddFunc</code>、<code>UpdateFunc</code>、<code>DeleteFunc</code>三类方法。</li>
<li>构造deployment、rs、pod的Informer的Lister函数和HasSynced函数。</li>
<li>赋值<code>syncHandler</code>，来实现<code>syncDeployment</code>。</li>
</ol>
<p><code>DeploymentController.Run</code>主要包含<code>WaitForCacheSync</code>和<code>syncDeployment</code>两部分。</p>
<p><code>syncDeployment</code>基于给定的key执行sync deployment的操作。</p>
<p>主要流程如下：</p>
<ol>
<li>通过<code>SplitMetaNamespaceKey</code>获取namespace和deployment对象的name。</li>
<li>调用Lister的接口获取的deployment的对象。</li>
<li><code>getReplicaSetsForDeployment</code>获取deployment管理的ReplicaSet对象。</li>
<li><code>getPodMapForDeployment</code>获取deployment管理的pod，基于ReplicaSet来分组。</li>
<li><code>checkPausedConditions</code>检查deployment是否是<code>pause</code>状态并添加合适的<code>condition</code>。</li>
<li><code>isScalingEvent</code>检查deployment的更新是否来自于一个scale的事件，如果是则执行scale的操作。</li>
<li>根据<code>DeploymentStrategyType</code>类型执行<code>rolloutRecreate</code>或<code>rolloutRolling</code>。</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/controller/deployment/deployment_controller.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/controller/deployment/deployment_controller.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/controller/deployment/rolling.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/controller/deployment/rolling.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/app/apps.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-controller-manager/app/apps.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d5650ecfb85232b23f95315845a0783f">3.4 - kube-controller-manager源码分析（三）之 Informer机制</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析k8s中各个核心组件经常使用到的<code>Informer</code>机制(即List-Watch)。该部分的代码主要位于<code>client-go</code>这个第三方包中。</p>
<p>此部分的逻辑主要位于<code>/vendor/k8s.io/client-go/tools/cache</code>包中，代码目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cache
</span></span><span style="display:flex;"><span>├── controller.go  <span style="color:#8f5902;font-style:italic"># 包含：Config、Run、processLoop、NewInformer、NewIndexerInformer</span>
</span></span><span style="display:flex;"><span>├── delta_fifo.go  <span style="color:#8f5902;font-style:italic"># 包含：NewDeltaFIFO、DeltaFIFO、AddIfNotPresent</span>
</span></span><span style="display:flex;"><span>├── expiration_cache.go
</span></span><span style="display:flex;"><span>├── expiration_cache_fakes.go
</span></span><span style="display:flex;"><span>├── fake_custom_store.go
</span></span><span style="display:flex;"><span>├── fifo.go   <span style="color:#8f5902;font-style:italic"># 包含：Queue、FIFO、NewFIFO</span>
</span></span><span style="display:flex;"><span>├── heap.go
</span></span><span style="display:flex;"><span>├── index.go    <span style="color:#8f5902;font-style:italic"># 包含：Indexer、MetaNamespaceIndexFunc</span>
</span></span><span style="display:flex;"><span>├── listers.go
</span></span><span style="display:flex;"><span>├── listwatch.go   <span style="color:#8f5902;font-style:italic"># 包含：ListerWatcher、ListWatch、List、Watch</span>
</span></span><span style="display:flex;"><span>├── mutation_cache.go
</span></span><span style="display:flex;"><span>├── mutation_detector.go
</span></span><span style="display:flex;"><span>├── reflector.go   <span style="color:#8f5902;font-style:italic"># 包含：Reflector、NewReflector、Run、ListAndWatch</span>
</span></span><span style="display:flex;"><span>├── reflector_metrics.go
</span></span><span style="display:flex;"><span>├── shared_informer.go  <span style="color:#8f5902;font-style:italic"># 包含：NewSharedInformer、WaitForCacheSync、Run、HasSynced</span>
</span></span><span style="display:flex;"><span>├── store.go  <span style="color:#8f5902;font-style:italic"># 包含：Store、MetaNamespaceKeyFunc、SplitMetaNamespaceKey</span>
</span></span><span style="display:flex;"><span>├── testing
</span></span><span style="display:flex;"><span>│   ├── fake_controller_source.go
</span></span><span style="display:flex;"><span>├── thread_safe_store.go  <span style="color:#8f5902;font-style:italic"># 包含：ThreadSafeStore、threadSafeMap</span>
</span></span><span style="display:flex;"><span>├── undelta_store.go
</span></span></code></pre></div><h1 id="0-原理示意图">0. 原理示意图</h1>
<p><a href="https://www.kubernetes.org.cn/1283.html">示意图1</a>：</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1555472372/article/code-analysis/informer/client-go.png" width="100%">
<p><a href="https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md">示意图2</a>：</p>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1555479782/article/code-analysis/informer/client-go-controller-interaction.jpg" width="100%">
<h2 id="0-1-client-go组件">0.1. client-go组件</h2>
<ul>
<li>
<p><code>Reflector</code>：reflector用来watch特定的k8s API资源。具体的实现是通过<code>ListAndWatch</code>的方法，watch可以是k8s内建的资源或者是自定义的资源。当reflector通过watch API接收到有关新资源实例存在的通知时，它使用相应的列表API获取新创建的对象，并将其放入watchHandler函数内的Delta Fifo队列中。</p>
</li>
<li>
<p><code>Informer</code>：informer从Delta Fifo队列中弹出对象。执行此操作的功能是processLoop。base controller的作用是保存对象以供以后检索，并调用我们的控制器将对象传递给它。</p>
</li>
<li>
<p><code>Indexer</code>：索引器提供对象的索引功能。典型的索引用例是基于对象标签创建索引。 Indexer可以根据多个索引函数维护索引。Indexer使用线程安全的数据存储来存储对象及其键。 在Store中定义了一个名为<code>MetaNamespaceKeyFunc</code>的默认函数，该函数生成对象的键作为该对象的<code>&lt;namespace&gt; / &lt;name&gt;</code>组合。</p>
</li>
</ul>
<h2 id="0-2-自定义controller组件">0.2. 自定义controller组件</h2>
<ul>
<li>
<p><code>Informer reference</code>：指的是Informer实例的引用，定义如何使用自定义资源对象。 自定义控制器代码需要创建对应的Informer。</p>
</li>
<li>
<p><code>Indexer reference</code>: 自定义控制器对Indexer实例的引用。自定义控制器需要创建对应的Indexser。</p>
</li>
</ul>
<blockquote>
<p>client-go中提供<code>NewIndexerInformer</code>函数可以创建Informer 和 Indexer。</p>
</blockquote>
<ul>
<li>
<p><code>Resource Event Handlers</code>：资源事件回调函数，当它想要将对象传递给控制器时，它将被调用。 编写这些函数的典型模式是获取调度对象的key，并将该key排入工作队列以进行进一步处理。</p>
</li>
<li>
<p><code>Work queue</code>：任务队列。 编写资源事件处理程序函数以提取传递的对象的key并将其添加到任务队列。</p>
</li>
<li>
<p><code>Process Item</code>：处理任务队列中对象的函数， 这些函数通常使用Indexer引用或Listing包装器来重试与该key对应的对象。</p>
</li>
</ul>
<h1 id="1-sharedinformerfactory-start">1. sharedInformerFactory.Start</h1>
<p>在controller-manager的Run函数部分调用了InformerFactory.Start的方法。</p>
<blockquote>
<p>此部分代码位于/cmd/kube-controller-manager/app/controllermanager.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run runs the KubeControllerManagerOptions.  This should never exit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CompletedConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformersStarted</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>InformerFactory是一个<code>SharedInformerFactory</code>的接口，接口定义如下：</p>
<blockquote>
<p>此部分代码位于vendor/k8s.io/client-go/informers/internalinterfaces/factory_interfaces.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// SharedInformerFactory a small interface to allow for adding an informer without an import cycle
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">SharedInformerFactory</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">InformerFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newFunc</span> <span style="color:#000">NewInformerFunc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedIndexInformer</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Start方法初始化各种类型的informer，并且每个类型起了个informer.Run的goroutine。</p>
<blockquote>
<p>此部分代码位于vendor/k8s.io/client-go/informers/factory.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start initializes all requested informers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sharedInformerFactory</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">informerType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">informer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">informers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedInformers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">informerType</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">informer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedInformers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">informerType</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-sharedindexinformer-run">2. sharedIndexInformer.Run</h1>
<blockquote>
<p>此部分的代码位于/vendor/k8s.io/client-go/tools/cache/shared_informer.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sharedIndexInformer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fifo</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewDeltaFIFO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MetaNamespaceKeyFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">fifo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ListerWatcher</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listerWatcher</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ObjectType</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objectType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">FullResyncPeriod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncCheckPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">RetryOnError</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ShouldResync</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shouldResync</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Process</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleDeltas</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controller</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">clock</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">started</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Separate stop channel because Processor should be stopped strictly after controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">processorStopCh</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Group</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>              <span style="color:#8f5902;font-style:italic">// Wait for Processor to stop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processorStopCh</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// Tell Processor to stop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartWithChannel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processorStopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheMutationDetector</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartWithChannel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processorStopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stopped</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#8f5902;font-style:italic">// Don&#39;t want any new listeners
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-1-newdeltafifo">2.1. NewDeltaFIFO</h2>
<p>DeltaFIFO是一个对象变化的存储队列，依据先进先出的原则，process的函数接收该队列的Pop方法的输出对象来处理相关功能。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">fifo</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewDeltaFIFO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MetaNamespaceKeyFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexer</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-2-config">2.2. Config</h2>
<p>构造controller的配置文件，构造process，即HandleDeltas，该函数为后面使用到的process函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">fifo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListerWatcher</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listerWatcher</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ObjectType</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objectType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">FullResyncPeriod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncCheckPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RetryOnError</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ShouldResync</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shouldResync</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Process</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleDeltas</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-controller">2.3. controller</h2>
<p>调用New(cfg)，构建sharedIndexInformer的controller。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controller</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">clock</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">started</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}()</span>
</span></span></code></pre></div><h2 id="2-4-cachemutationdetector-run">2.4. cacheMutationDetector.Run</h2>
<p>调用s.cacheMutationDetector.Run，检查缓存对象是否变化。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartWithChannel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processorStopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheMutationDetector</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>defaultCacheMutationDetector.Run</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">defaultCacheMutationDetector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// we DON&#39;T want protection from panics.  If we&#39;re running this code, we want to die
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CompareObjects</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">After</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">period</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>CompareObjects</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">defaultCacheMutationDetector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">CompareObjects</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">altered</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedObjs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepEqual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cached</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">copied</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CACHE %s[%d] ALTERED!\n%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">diff</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectDiff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cached</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">copied</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">altered</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">altered</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cache %s modified&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">failureFunc</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">failureFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-5-processor-run">2.5. processor.run</h2>
<p>调用s.processor.run，将调用sharedProcessor.run，会调用Listener.run和Listener.pop,执行处理queue的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartWithChannel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processorStopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>sharedProcessor.Run</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sharedProcessor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listenersLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RLock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listenersLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RUnlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listener</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listeners</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">listener</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">listener</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listenersLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RLock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listenersLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RUnlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listener</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listeners</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">listener</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addCh</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// Tell .pop() to stop. .pop() will tell .run() to stop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// Wait for all .pop() and .run() to stop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>该部分逻辑待后面分析。</p>
<h2 id="2-6-controller-run">2.6. controller.Run</h2>
<p>调用s.controller.Run，构建Reflector，进行对etcd的缓存</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stopped</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#8f5902;font-style:italic">// Don&#39;t want any new listeners
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>controller.Run</p>
<blockquote>
<p>此部分代码位于/vendor/k8s.io/client-go/tools/cache/controller.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run begins processing items, and will continue until a value is sent down stopCh.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It&#39;s an error to call Run more than once.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run blocks; call via go.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewReflector</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListerWatcher</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FullResyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ShouldResync</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ShouldResync</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reflectorMutex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reflector</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">r</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reflectorMutex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Group</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartWithChannel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processLoop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 构建Reflector
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewReflector</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListerWatcher</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FullResyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 运行Reflector
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartWithChannel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 执行processLoop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processLoop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="3-reflector">3. Reflector</h1>
<h2 id="3-1-reflector">3.1. Reflector</h2>
<p><code>Reflector</code>的主要作用是watch指定的k8s资源，并将变化同步到本地是<code>store</code>中。<code>Reflector</code>只会放置指定的<code>expectedType</code>类型的资源到<code>store</code>中，除非<code>expectedType</code>为nil。如果<code>resyncPeriod</code>不为零，那么<code>Reflector</code>为以<code>resyncPeriod</code>为周期定期执行list的操作，这样就可以使用<code>Reflector</code>来定期处理所有的对象，也可以逐步处理变化的对象。</p>
<p>常用属性说明：</p>
<ul>
<li>expectedType：期望放入缓存store的资源类型。</li>
<li>store：watch的资源对应的本地缓存。</li>
<li>listerWatcher：list和watch的接口。</li>
<li>period：watch的周期，默认为1秒。</li>
<li>resyncPeriod：resync的周期，当非零的时候，会按该周期执行list。</li>
<li>lastSyncResourceVersion：最新一次看到的资源的版本号，主要在watch时候使用。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Reflector watches a specified resource and causes all changes to be reflected in the given store.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Reflector</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// name identifies this reflector. By default it will be a file:line if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// metrics tracks basic metric information about the reflector
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">metrics</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">reflectorMetrics</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// The type of object we expect to place in the store.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">expectedType</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// The destination to sync up with the watch source
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">store</span> <span style="color:#000">Store</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// listerWatcher is used to perform lists and watches.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">listerWatcher</span> <span style="color:#000">ListerWatcher</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// period controls timing between one watch ending and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the beginning of the next one.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">period</span>       <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">resyncPeriod</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ShouldResync</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// clock allows tests to manipulate time
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">clock</span> <span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Clock</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// lastSyncResourceVersion is the resource version token last
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// observed when doing a sync with the underlying store
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// it is thread safe, but not synchronized with the underlying store
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">lastSyncResourceVersion</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// lastSyncResourceVersionMutex guards read/write access to lastSyncResourceVersion
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">lastSyncResourceVersionMutex</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RWMutex</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-newreflector">3.2. NewReflector</h2>
<p>NewReflector主要用来构建Reflector的结构体。</p>
<blockquote>
<p>此部分的代码位于/vendor/k8s.io/client-go/tools/cache/reflector.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewReflector creates a new Reflector object which will keep the given store up to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// date with the server&#39;s contents for the given resource. Reflector promises to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// only put things in the store that have the type of expectedType, unless expectedType
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// is nil. If resyncPeriod is non-zero, then lists will be executed after every
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// resyncPeriod, so that you can use reflectors to periodically process everything as
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// well as incrementally processing the things that change.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewReflector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lw</span> <span style="color:#000">ListerWatcher</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">expectedType</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">store</span> <span style="color:#000">Store</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resyncPeriod</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Reflector</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewNamedReflector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">getDefaultReflectorName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">internalPackages</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">lw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">store</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// reflectorDisambiguator is used to disambiguate started reflectors.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// initialized to an unstable value to ensure meaning isn&#39;t attributed to the suffix.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">reflectorDisambiguator</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UnixNano</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">12345</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewNamedReflector same as NewReflector, but with a specified name for logging
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewNamedReflector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lw</span> <span style="color:#000">ListerWatcher</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">expectedType</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">store</span> <span style="color:#000">Store</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resyncPeriod</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Reflector</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">reflectorSuffix</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">reflectorDisambiguator</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Reflector</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// we need this to be unique per process (some names are still the same)but obvious who it belongs to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">newReflectorMetrics</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">makeValidPromethusMetricLabel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;reflector_&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#4e9a06">&#34;_%d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reflectorSuffix</span><span style="color:#000;font-weight:bold">))),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">listerWatcher</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">lw</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">store</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">store</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">period</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">clock</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RealClock</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">r</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-reflector-run">3.3. Reflector.Run</h2>
<p>Reflector.Run主要执行了<code>ListAndWatch</code>的方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run starts a watch and handles watch events. Will restart the watch if it is closed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run will exit when stopCh is closed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Reflector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting reflector %v (%s) from %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListAndWatch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">period</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-4-listandwatch">3.4. ListAndWatch</h2>
<p>ListAndWatch第一次会列出所有的对象，并获取资源对象的版本号，然后watch资源对象的版本号来查看是否有被变更。首先会将资源版本号设置为0，<code>list()</code>可能会导致本地的缓存相对于etcd里面的内容存在延迟，<code>Reflector</code>会通过<code>watch</code>的方法将延迟的部分补充上，使得本地的缓存数据与etcd的数据保持一致。</p>
<h3 id="3-4-1-list">3.4.1. List</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ListAndWatch first lists all items and get the resource version at the moment of call,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and then use the resource version to watch.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It returns error if ListAndWatch didn&#39;t even try to initialize watch.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Reflector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ListAndWatch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Listing and watching %v from %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">resourceVersion</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Explicitly set &#34;0&#34; as resource version - it&#39;s fine for the List()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// to be served from cache and potentially be delayed relative to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// etcd contents. Reflector framework will catch up via Watch() eventually.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">ResourceVersion</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;0&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">numberOfLists</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Inc</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listerWatcher</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: Failed to list %v: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Since</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Seconds</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">listMetaInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListAccessor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: Unable to understand list result %#v: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">resourceVersion</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">listMetaInterface</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetResourceVersion</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">items</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtractList</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: Unable to understand list result %#v (%v)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">numberOfItemsInList</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resourceVersion</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: Unable to sync list result: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setLastSyncResourceVersion</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resourceVersion</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>首先将资源的版本号设置为0，然后调用<code>listerWatcher.List(options)</code>，列出所有list的内容。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 版本号设置为0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">ResourceVersion</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;0&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// list接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listerWatcher</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>获取资源版本号，并将list的内容提取成对象列表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 获取版本号
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">resourceVersion</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">listMetaInterface</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetResourceVersion</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 将list的内容提取成对象列表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExtractList</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">list</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>将list中对象列表的内容和版本号存储到本地的缓存store中，并全量替换已有的store的内容。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resourceVersion</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>syncWith调用了store的Replace的方法来替换原来store中的数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// syncWith replaces the store&#39;s items with the given list.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Reflector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">items</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resourceVersion</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">found</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">item</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">items</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">found</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">found</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">item</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Replace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">found</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resourceVersion</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Store.Replace方法定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Store</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Replace will delete the contents of the store, using instead the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// given list. Store takes ownership of the list, you should not reference
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// it after calling this function.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Replace</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>最后设置最新的资源版本号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setLastSyncResourceVersion</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resourceVersion</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>setLastSyncResourceVersion:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Reflector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">setLastSyncResourceVersion</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastSyncResourceVersionMutex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastSyncResourceVersionMutex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastSyncResourceVersion</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rv</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Atoi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastResourceVersion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rv</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-4-2-store-resync">3.4.2. store.Resync</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">resyncerrc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cancelCh</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cancelCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">resyncCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cleanup</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncChan</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// Call the last one written into cleanup
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">resyncCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">cancelCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ShouldResync</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ShouldResync</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: forcing resync&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Resync</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">resyncerrc</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cleanup</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">resyncCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cleanup</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncChan</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}()</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Resync</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>store的具体对象为<code>DeltaFIFO</code>，即调用DeltaFIFO.Resync</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Resync will send a sync event for each item
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeltaFIFO</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Resync</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">knownObjects</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">keys</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">knownObjects</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListKeys</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">keys</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncKeyLocked</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-4-3-watch">3.4.3. Watch</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// give the stopCh a chance to stop the loop, even in case of continue statements further down on errors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">timemoutseconds</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">minWatchTimeout</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seconds</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Float64</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1.0</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">options</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ResourceVersion</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">resourceVersion</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// We want to avoid situations of hanging watchers. Stop any wachers that do not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// receive any events within the timeout window.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">TimeoutSeconds</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">timemoutseconds</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">numberOfWatches</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Inc</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listerWatcher</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EOF</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// watch closed normally
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrUnexpectedEOF</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: Watch for %v closed with unexpected EOF: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: Failed to watch %v: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// If this is &#34;connection refused&#34; error, it means that most likely apiserver is not responsive.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// It doesn&#39;t make sense to re-list all objects because most likely we will be able to restart
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// watch where we ended.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// If that&#39;s the case wait and resend watch request.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">urlError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">opError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">urlError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OpError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">errno</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">opError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errno</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">errno</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ECONNREFUSED</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">watchHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">resourceVersion</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resyncerrc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">errorStopRequested</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: watch of %v ended with: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>设置watch的超时时间，默认为5分钟。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">timemoutseconds</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">minWatchTimeout</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seconds</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Float64</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1.0</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000">options</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ResourceVersion</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">resourceVersion</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We want to avoid situations of hanging watchers. Stop any wachers that do not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// receive any events within the timeout window.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">TimeoutSeconds</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">timemoutseconds</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>执行listerWatcher.Watch(options)。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listerWatcher</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>执行watchHandler。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">watchHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">resourceVersion</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resyncerrc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="3-4-4-watchhandler">3.4.4. watchHandler</h3>
<p>watchHandler主要是通过watch的方式保证当前的资源版本是最新的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// watchHandler watches w and keeps *resourceVersion up to date.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Reflector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">watchHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resourceVersion</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errc</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">eventCount</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Stopping the watcher should be idempotent and if we return from this function there&#39;s no way
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// we&#39;re coming back in with the same watch interface.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">w</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// update metrics
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">numberOfItemsInWatch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">eventCount</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">watchDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Since</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Seconds</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">loop</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errorStopRequested</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">errc</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResultChan</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">break</span> <span style="color:#000">loop</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">apierrs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FromObject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">a</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: expected type %v, but watch event object had type %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Accessor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: unable to understand watch event %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">newResourceVersion</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetResourceVersion</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Added</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: unable to add watch event object (%#v) to store: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Modified</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: unable to update watch event object (%#v) to store: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deleted</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// TODO: Will any consumers need access to the &#34;last known
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#8f5902;font-style:italic">// state&#34;, which is passed in event.Object? If so, may need
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#8f5902;font-style:italic">// to change this.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: unable to delete watch event object (%#v) from store: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: unable to understand watch event %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">resourceVersion</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newResourceVersion</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setLastSyncResourceVersion</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newResourceVersion</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">eventCount</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">watchDuration</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Sub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">watchDuration</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">eventCount</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">numberOfShortWatches</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Inc</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;very short watch: %s: Unexpected watch close - watch lasted less than a second and no items received&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: Watch close - %v total %v items received&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">eventCount</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>获取watch接口中的事件的channel，来获取事件的内容。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResultChan</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>        
</span></span></code></pre></div><p>当获得添加、更新、删除的事件时，将对应的对象更新到本地缓存store中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Added</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: unable to add watch event object (%#v) to store: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Modified</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: unable to update watch event object (%#v) to store: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deleted</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: Will any consumers need access to the &#34;last known
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// state&#34;, which is passed in event.Object? If so, may need
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// to change this.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">store</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: unable to delete watch event object (%#v) from store: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: unable to understand watch event %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">event</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>更新当前的最新版本号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">newResourceVersion</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetResourceVersion</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">resourceVersion</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newResourceVersion</span>
</span></span><span style="display:flex;"><span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setLastSyncResourceVersion</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newResourceVersion</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>通过对Reflector模块的分析，可以看到多次使用到本地缓存store模块，而store的数据由DeltaFIFO赋值而来，以下针对DeltaFIFO和store做分析。</p>
<h1 id="4-deltafifo">4. DeltaFIFO</h1>
<p>DeltaFIFO由NewDeltaFIFO初始化，并赋值给config.Queue。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sharedIndexInformer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fifo</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewDeltaFIFO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MetaNamespaceKeyFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">fifo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><h2 id="4-1-newdeltafifo">4.1. NewDeltaFIFO</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewDeltaFIFO returns a Store which can be used process changes to items.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// keyFunc is used to figure out what key an object should have. (It&#39;s
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// exposed in the returned DeltaFIFO&#39;s KeyOf() method, with bonus features.)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// &#39;compressor&#39; may compress as many or as few items as it wants
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// (including returning an empty slice), but it should do what it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// does quickly since it is called while the queue is locked.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// &#39;compressor&#39; may be nil if you don&#39;t want any delta compression.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// &#39;keyLister&#39; is expected to return a list of keys that the consumer of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// this queue &#34;knows about&#34;. It is used to decide which items are missing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// when Replace() is called; &#39;Deleted&#39; deltas are produced for these items.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It may be nil if you don&#39;t need to detect all deletions.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: consider merging keyLister with this object, tracking a list of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//       &#34;known&#34; keys when Pop() is called. Have to think about how that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//       affects error retrying.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO(lavalamp): I believe there is a possible race only when using an
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//                 external known object source that the above TODO would
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//                 fix.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Also see the comment on DeltaFIFO.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewDeltaFIFO</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">keyFunc</span> <span style="color:#000">KeyFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">compressor</span> <span style="color:#000">DeltaCompressor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">knownObjects</span> <span style="color:#000">KeyListerGetter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeltaFIFO</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">DeltaFIFO</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">items</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">Deltas</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">queue</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">keyFunc</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">keyFunc</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">deltaCompressor</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">compressor</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">knownObjects</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">knownObjects</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cond</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">L</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">f</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>controller.Run的部分调用了NewReflector。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewReflector</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListerWatcher</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FullResyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>NewReflector构造函数，将c.config.Queue赋值给Reflector.store的属性。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewReflector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lw</span> <span style="color:#000">ListerWatcher</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">expectedType</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">store</span> <span style="color:#000">Store</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resyncPeriod</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Reflector</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewNamedReflector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">getDefaultReflectorName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">internalPackages</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">lw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">store</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewNamedReflector same as NewReflector, but with a specified name for logging
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewNamedReflector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lw</span> <span style="color:#000">ListerWatcher</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">expectedType</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">store</span> <span style="color:#000">Store</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resyncPeriod</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Reflector</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">reflectorSuffix</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">reflectorDisambiguator</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Reflector</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// we need this to be unique per process (some names are still the same)but obvious who it belongs to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">newReflectorMetrics</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">makeValidPromethusMetricLabel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;reflector_&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#4e9a06">&#34;_%d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reflectorSuffix</span><span style="color:#000;font-weight:bold">))),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">listerWatcher</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">lw</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">store</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">store</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">expectedType</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">period</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">resyncPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">clock</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RealClock</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">r</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-2-deltafifo">4.2. DeltaFIFO</h2>
<p>DeltaFIFO是一个生产者与消费者的队列，其中Reflector是生产者，消费者调用Pop()的方法。</p>
<p>DeltaFIFO主要用在以下场景：</p>
<ul>
<li>希望对象变更最多处理一次</li>
<li>处理对象时，希望查看自上次处理对象以来发生的所有事情</li>
<li>要处理对象的删除</li>
<li>希望定期重新处理对象</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// DeltaFIFO is like FIFO, but allows you to process deletes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// DeltaFIFO is a producer-consumer queue, where a Reflector is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// intended to be the producer, and the consumer is whatever calls
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the Pop() method.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// DeltaFIFO solves this use case:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * You want to process every object change (delta) at most once.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * When you process an object, you want to see everything
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//    that&#39;s happened to it since you last processed it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * You want to process the deletion of objects.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * You might want to periodically reprocess objects.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// DeltaFIFO&#39;s Pop(), Get(), and GetByKey() methods return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// interface{} to satisfy the Store/Queue interfaces, but it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// will always return an object of type Deltas.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// A note on threading: If you call Pop() in parallel from multiple
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// threads, you could end up with multiple threads processing slightly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// different versions of the same object.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// A note on the KeyLister used by the DeltaFIFO: It&#39;s main purpose is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to list keys that are &#34;known&#34;, for the purpose of figuring out which
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// items have been deleted when Replace() or Delete() are called. The deleted
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// object will be included in the DeleteFinalStateUnknown markers. These objects
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// could be stale.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// You may provide a function to compress deltas (e.g., represent a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// series of Updates as a single Update).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">DeltaFIFO</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// lock/cond protects access to &#39;items&#39; and &#39;queue&#39;.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">lock</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RWMutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cond</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cond</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We depend on the property that items in the set are in
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the queue and vice versa, and that all Deltas in this
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// map have at least one Delta.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">items</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">Deltas</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">queue</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// populated is true if the first batch of items inserted by Replace() has been populated
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// or Delete/Add/Update was called first.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">populated</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// initialPopulationCount is the number of items inserted by the first call of Replace()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">initialPopulationCount</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// keyFunc is used to make the key used for queued item
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// insertion and retrieval, and should be deterministic.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">keyFunc</span> <span style="color:#000">KeyFunc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// deltaCompressor tells us how to combine two or more
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// deltas. It may be nil.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">deltaCompressor</span> <span style="color:#000">DeltaCompressor</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// knownObjects list keys that are &#34;known&#34;, for the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// purpose of figuring out which items have been deleted
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// when Replace() or Delete() is called.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">knownObjects</span> <span style="color:#000">KeyListerGetter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Indication the queue is closed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Used to indicate a queue is closed so a control loop can exit when a queue is empty.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Currently, not used to gate any of CRED operations.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">closed</span>     <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">closedLock</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-3-queue-store">4.3. Queue &amp; Store</h2>
<p>DeltaFIFO的类型是Queue接口，Reflector.store是Store接口，Queue接口是一个存储队列，Process的方法执行Queue.Pop出来的数据对象，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Queue is exactly like a Store, but has a Pop() method too.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Queue</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Store</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Pop blocks until it has something to process.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// It returns the object that was process and the result of processing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// The PopProcessFunc may return an ErrRequeue{...} to indicate the item
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// should be requeued before releasing the lock on the queue.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PopProcessFunc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// AddIfNotPresent adds a value previously
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// returned by Pop back into the queue as long
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// as nothing else (presumably more recent)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// has since been added.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">AddIfNotPresent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Return true if the first batch of items has been popped
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">HasSynced</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Close queue
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-store">5. store</h1>
<p><code>Store</code>是一个通用的存储接口，Reflector通过watch server的方式更新数据到store中，store给Reflector提供本地的缓存，让Reflector可以像消息队列一样的工作。</p>
<p><code>Store</code>实现的是一种可以准确的写入对象和获取对象的机制。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Store is a generic object storage interface. Reflector knows how to watch a server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and update a store. A generic store is provided, which allows Reflector to be used
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// as a local caching system, and an LRU store, which allows Reflector to work like a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// queue of items yet to be processed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Store makes no assumptions about stored object identity; it is the responsibility
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// of a Store implementation to provide a mechanism to correctly key objects and to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// define the contract for obtaining objects by some arbitrary key type.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Store</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListKeys</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">item</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">exists</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">GetByKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">item</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">exists</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Replace will delete the contents of the store, using instead the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// given list. Store takes ownership of the list, you should not reference
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// it after calling this function.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Replace</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Resync</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中<code>Replace</code>方法会删除原来store中的内容，并将新增的list的内容存入store中，即完全替换数据。</p>
<h2 id="6-1-cache">6.1.  cache</h2>
<p>cache实现了store的接口，而cache的具体实现又是调用<code>ThreadSafeStore</code>接口来实现功能的。</p>
<p>cache的功能主要有以下两点：</p>
<ul>
<li>通过keyFunc计算对象的key</li>
<li>调用ThreadSafeStorage接口的方法</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// cache responsibilities are limited to:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//	1. Computing keys for objects via keyFunc
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  2. Invoking methods of a ThreadSafeStorage interface
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">cache</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// cacheStorage bears the burden of thread safety for the cache
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">cacheStorage</span> <span style="color:#000">ThreadSafeStore</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// keyFunc is used to make the key for objects stored in and retrieved from items, and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// should be deterministic.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">keyFunc</span> <span style="color:#000">KeyFunc</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中ListAndWatch主要用到以下的方法：</p>
<p><strong>cache.Replace</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Replace will delete the contents of &#39;c&#39;, using instead the given list.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// &#39;c&#39; takes ownership of the list, you should not reference the list again
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// after calling this function.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Replace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">list</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">resourceVersion</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">items</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">item</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">list</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">keyFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">item</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">KeyError</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">item</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">items</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">item</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheStorage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Replace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resourceVersion</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>cache.Add</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Add inserts an item into the cache.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">keyFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">KeyError</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheStorage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>cache.Update</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Update sets an item in the cache to its updated state.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">keyFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">KeyError</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheStorage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>cache.Delete</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Delete removes an item from the cache.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">keyFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">KeyError</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheStorage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-2-threadsafestore">6.2. ThreadSafeStore</h2>
<p>cache的具体是调用<code>ThreadSafeStore</code>来实现的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ThreadSafeStore is an interface that allows concurrent access to a storage backend.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TL;DR caveats: you must not modify anything returned by Get or List as it will break
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the indexing feature in addition to not being thread safe.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The guarantees of thread safety provided by List/Get are only valid if the caller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// treats returned items as read-only. For example, a pointer inserted in the store
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// through `Add` will be returned as is by `Get`. Multiple clients might invoke `Get`
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// on the same key and modify the pointer in a non-thread-safe way. Also note that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// modifying objects stored by the indexers (if any) will *not* automatically lead
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to a re-index. So it&#39;s not a good idea to directly modify the objects returned by
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Get/List, in general.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ThreadSafeStore</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">item</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">exists</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">List</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListKeys</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Replace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Index</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">indexName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">IndexKeys</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">indexName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">indexKey</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListIndexFuncValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ByIndex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">indexName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">indexKey</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">GetIndexers</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">Indexers</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// AddIndexers adds more indexers to this store.  If you call this after you already have data
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// in the store, the results are undefined.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">AddIndexers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newIndexers</span> <span style="color:#000">Indexers</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Resync</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>threadSafeMap</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// threadSafeMap implements ThreadSafeStore
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">threadSafeMap</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lock</span>  <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RWMutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">items</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// indexers maps a name to an IndexFunc
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">indexers</span> <span style="color:#000">Indexers</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// indices maps a name to an Index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">indices</span> <span style="color:#000">Indices</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="6-processloop">6. processLoop</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processLoop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在controller.Run方法中会调用processLoop，以下分析<code>processLoop</code>的处理逻辑。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// processLoop drains the work queue.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: Consider doing the processing in parallel. This will require a little thought
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to make sure that we don&#39;t end up processing the same object multiple times
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// concurrently.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: Plumb through the stopCh here (and down to the queue) so that this can
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// actually exit when the controller is stopped. Or just give up on this stuff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ever being stoppable. Converting this whole package to use Context would
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// also be helpful.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">processLoop</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PopProcessFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Process</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">FIFOClosedError</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RetryOnError</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// This is the safe way to re-enqueue.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddIfNotPresent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>processLoop主要处理任务队列中的任务，其中处理逻辑是调用具体的<code>ProcessFunc</code>函数来实现，核心代码为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PopProcessFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Process</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h2 id="5-1-deltafifo-pop">5.1. DeltaFIFO.Pop</h2>
<p>Pop会阻塞住直到队列里面添加了新的对象，如果有多个对象，按照先进先出的原则处理，如果某个对象没有处理成功会重新被加入该队列中。</p>
<p>Pop中会调用具体的process函数来处理对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Pop blocks until an item is added to the queue, and then returns it.  If
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// multiple items are ready, they are returned in the order in which they were
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// added/updated. The item is removed from the queue (and the store) before it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// is returned, so if you don&#39;t successfully process it, you need to add it back
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// with AddIfNotPresent().
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// process function is called under lock, so it is safe update data structures
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// in it that need to be in sync with the queue (e.g. knownKeys). The PopProcessFunc
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// may return an instance of ErrRequeue with a nested error to indicate the current
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// item should be requeued (equivalent to calling AddIfNotPresent under the lock).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Pop returns a &#39;Deltas&#39;, which has a complete list of all the things
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// that happened to the object (deltas) while it was sitting in the queue.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeltaFIFO</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Pop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">process</span> <span style="color:#000">PopProcessFunc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// When the queue is empty, invocation of Pop() is blocked until new item is enqueued.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// When Close() is called, the f.closed is set and the condition is broadcasted.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// Which causes this loop to continue and return from the Pop().
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsClosed</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">FIFOClosedError</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cond</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">:]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">item</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">initialPopulationCount</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">initialPopulationCount</span><span style="color:#ce5c00;font-weight:bold">--</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Item may have been deleted subsequently.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">item</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">ErrRequeue</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addIfNotPresent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">item</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Don&#39;t need to copyDeltas here, because we&#39;re transferring
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// ownership to the caller.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">item</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">item</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">item</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">ErrRequeue</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addIfNotPresent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">item</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Don&#39;t need to copyDeltas here, because we&#39;re transferring
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// ownership to the caller.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">item</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-2-handledeltas">5.2. HandleDeltas</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">fifo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ListerWatcher</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listerWatcher</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ObjectType</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">objectType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">FullResyncPeriod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncCheckPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">RetryOnError</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ShouldResync</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shouldResync</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Process</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleDeltas</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中process函数就是在sharedIndexInformer.Run方法中，给config.Process赋值的<code>HandleDeltas</code>函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sharedIndexInformer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandleDeltas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">blockDeltas</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">blockDeltas</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// from oldest to newest
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">Deltas</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Sync</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Added</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Updated</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">isSync</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">Sync</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cacheMutationDetector</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddObject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">old</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">distribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updateNotification</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">old</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">isSync</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">distribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addNotification</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">isSync</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Deleted</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">distribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deleteNotification</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Sync</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Added</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Updated</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">old</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">indexer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">distribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updateNotification</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">old</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">isSync</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">distribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addNotification</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">isSync</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Deleted</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">distribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deleteNotification</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Object</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>根据不同的类型，调用<code>processor.distribute</code>方法，该方法将对象加入<code>processorListener</code>的channel中。</p>
<h2 id="5-3-sharedprocessor-distribute">5.3. sharedProcessor.distribute</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sharedProcessor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">distribute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">sync</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listenersLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RLock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listenersLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RUnlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">sync</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listener</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncingListeners</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">listener</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listener</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listeners</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">listener</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>processorListener.add:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">processorListener</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">notification</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">notification</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>综合以上的分析，可以看出processLoop通过调用HandleDeltas，再调用distribute，processorListener.add最终将不同更新类型的对象加入<code>processorListener</code>的channel中，供processorListener.Run使用。以下分析processorListener.Run的部分。</p>
<h1 id="7-processor">7. processor</h1>
<p>processor的主要功能就是记录了所有的回调函数实例(即 ResourceEventHandler 实例)，并负责触发这些函数。在sharedIndexInformer.Run部分会调用processor.run。</p>
<p>流程：</p>
<ol>
<li>listenser的add函数负责将notify装进pendingNotifications。</li>
<li>pop函数取出pendingNotifications的第一个nofify,输出到nextCh channel。</li>
<li>run函数则负责取出notify，然后根据notify的类型(增加、删除、更新)触发相应的处理函数，这些函数是在不同的<code>NewXxxcontroller</code>实现中注册的。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sharedIndexInformer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartWithChannel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processorStopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="7-1-sharedprocessor-run">7.1. sharedProcessor.Run</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sharedProcessor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listenersLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RLock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listenersLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RUnlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listener</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listeners</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">listener</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">listener</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listenersLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RLock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listenersLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RUnlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listener</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listeners</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">listener</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addCh</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// Tell .pop() to stop. .pop() will tell .run() to stop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// Wait for all .pop() and .run() to stop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="7-1-1-listener-pop">7.1.1. listener.pop</h3>
<p>pop函数取出pendingNotifications的第一个nofify,输出到nextCh channel。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">processorListener</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">pop</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nextCh</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// Tell .run() to stop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">nextCh</span> <span style="color:#204a87;font-weight:bold">chan</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">notification</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">nextCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">notification</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Notification dispatched
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ok</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">notification</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pendingNotifications</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadOne</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// Nothing to pop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">nextCh</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#8f5902;font-style:italic">// Disable this select case
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">notificationToAdd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">notification</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// No notification to pop (and pendingNotifications is empty)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#8f5902;font-style:italic">// Optimize the case - skip adding to pendingNotifications
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">notification</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">notificationToAdd</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">nextCh</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nextCh</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// There is already a notification waiting to be dispatched
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pendingNotifications</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteOne</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">notificationToAdd</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="7-1-2-listener-run">7.1.2. listener.run</h3>
<p>listener.run部分根据不同的更新类型调用不同的处理函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">processorListener</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">next</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nextCh</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">notification</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">next</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">updateNotification</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">notification</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">notification</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">addNotification</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnAdd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">notification</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">deleteNotification</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">notification</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unrecognized notification: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中具体的实现函数handler是在NewDeploymentController（其他不同类型的controller类似）中赋值的，而该handler是一个接口，具体如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ResourceEventHandler can handle notifications for events that happen to a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// resource. The events are informational only, so you can&#39;t return an
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * OnAdd is called when an object is added.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * OnUpdate is called when an object is modified. Note that oldObj is the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      last known state of the object-- it is possible that several changes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      were combined together, so you can&#39;t use this to see every single
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      change. OnUpdate is also called when a re-list happens, and it will
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      get called even if nothing changed. This is useful for periodically
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      evaluating or syncing something.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//  * OnDelete will get the final state of the item if it is known, otherwise
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      it will get an object of type DeletedFinalStateUnknown. This can
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      happen if the watch is closed and misses the delete event and we don&#39;t
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      notice the deletion until the subsequent re-list.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ResourceEventHandler</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OnAdd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OnUpdate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OnDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="7-2-resourceeventhandler">7.2. ResourceEventHandler</h2>
<p>以下以DeploymentController的处理逻辑为例。</p>
<p>在<code>NewDeploymentController</code>部分会注册deployment的事件函数，以下注册了三种类型的事件函数，其中包括：dInformer、rsInformer和podInformer。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewDeploymentController creates a new DeploymentController.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewDeploymentController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dInformer</span> <span style="color:#000">extensionsinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsInformer</span> <span style="color:#000">extensionsinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podInformer</span> <span style="color:#000">coreinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">client</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addDeployment</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateDeployment</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// This will enter the sync loop and no-op, because the deployment has been deleted from the store.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteDeployment</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addReplicaSet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateReplicaSet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteReplicaSet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deletePod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><h3 id="7-2-1-adddeployment">7.2.1. addDeployment</h3>
<p>以下以<code>addDeployment</code>为例，addDeployment主要是将对象加入到enqueueDeployment的队列中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">addDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">extensions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Adding deployment %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>enqueueDeployment的定义</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">DeploymentController</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">enqueueDeployment</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deployment</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">extensions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>将dc.enqueue赋值给dc.enqueueDeployment</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueDeployment</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueue</span>
</span></span></code></pre></div><p>dc.enqueue调用了dc.queue.Add(key)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">enqueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deployment</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">extensions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Couldn&#39;t get key for object %#v: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>dc.queue主要记录了需要被同步的deployment的对象，供syncDeployment使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">queue</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNamedRateLimitingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultControllerRateLimiter</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;deployment&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>NewNamedRateLimitingQueue</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewNamedRateLimitingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rateLimiter</span> <span style="color:#000">RateLimiter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">RateLimitingInterface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rateLimitingType</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DelayingInterface</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">NewNamedDelayingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">rateLimiter</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">rateLimiter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过以上分析，可以看出processor记录了不同类似的事件函数，其中事件函数在NewXxxController构造函数部分注册，具体事件函数的处理，一般是将需要处理的对象加入对应的controller的任务队列中，然后由类似syncDeployment的同步函数来维持期望状态的同步逻辑。</p>
<h1 id="8-总结">8. 总结</h1>
<p>本文分析的部分主要是k8s的<code>informer</code>机制，即<code>List-Watch</code>机制。</p>
<h2 id="8-1-reflector">8.1. Reflector</h2>
<p><code>Reflector</code>的主要作用是watch指定的k8s资源，并将变化同步到本地是<code>store</code>中。<code>Reflector</code>只会放置指定的<code>expectedType</code>类型的资源到<code>store</code>中，除非<code>expectedType</code>为nil。如果<code>resyncPeriod</code>不为零，那么<code>Reflector</code>为以<code>resyncPeriod</code>为周期定期执行list的操作，这样就可以使用<code>Reflector</code>来定期处理所有的对象，也可以逐步处理变化的对象。</p>
<h2 id="8-2-listandwatch">8.2. ListAndWatch</h2>
<p><code>ListAndWatch</code>第一次会列出所有的对象，并获取资源对象的版本号，然后watch资源对象的版本号来查看是否有被变更。首先会将资源版本号设置为0，<code>list()</code>可能会导致本地的缓存相对于etcd里面的内容存在延迟，<code>Reflector</code>会通过<code>watch</code>的方法将延迟的部分补充上，使得本地的缓存数据与etcd的数据保持一致。</p>
<h2 id="8-3-deltafifo">8.3. DeltaFIFO</h2>
<p><code>DeltaFIFO</code>是一个生产者与消费者的队列，其中Reflector是生产者，消费者调用Pop()的方法。</p>
<p>DeltaFIFO主要用在以下场景：</p>
<ul>
<li>希望对象变更最多处理一次</li>
<li>处理对象时，希望查看自上次处理对象以来发生的所有事情</li>
<li>要处理对象的删除</li>
<li>希望定期重新处理对象</li>
</ul>
<h2 id="8-4-store">8.4. store</h2>
<p><code>Store</code>是一个通用的存储接口，Reflector通过watch server的方式更新数据到store中，store给Reflector提供本地的缓存，让Reflector可以像消息队列一样的工作。</p>
<p><code>Store</code>实现的是一种可以准确的写入对象和获取对象的机制。</p>
<h2 id="8-5-processor">8.5. processor</h2>
<p><code>processor</code>的主要功能就是记录了所有的回调函数实例(即 ResourceEventHandler 实例)，并负责触发这些函数。在sharedIndexInformer.Run部分会调用processor.run。</p>
<p>流程：</p>
<ol>
<li>listenser的add函数负责将notify装进pendingNotifications。</li>
<li>pop函数取出pendingNotifications的第一个nofify,输出到nextCh channel。</li>
<li>run函数则负责取出notify，然后根据notify的类型(增加、删除、更新)触发相应的处理函数，这些函数是在不同的<code>NewXxxcontroller</code>实现中注册的。</li>
</ol>
<p><code>processor</code>记录了不同类似的事件函数，其中事件函数在<code>NewXxxController</code>构造函数部分注册，具体事件函数的处理，一般是将需要处理的对象加入对应的controller的任务队列中，然后由类似<code>syncDeployment</code>的同步函数来维持期望状态的同步逻辑。</p>
<h2 id="8-6-主要步骤">8.6. 主要步骤</h2>
<ol>
<li>在controller-manager的Run函数部分调用了InformerFactory.Start的方法，Start方法初始化各种类型的informer，并且每个类型起了个informer.Run的goroutine。</li>
<li>informer.Run的部分先生成一个DeltaFIFO的队列来存储对象变化的数据。然后调用processor.Run和controller.Run函数。</li>
<li>controller.Run函数会生成一个Reflector，<code>Reflector</code>的主要作用是watch指定的k8s资源，并将变化同步到本地是<code>store</code>中。<code>Reflector</code>以<code>resyncPeriod</code>为周期定期执行list的操作，这样就可以使用<code>Reflector</code>来定期处理所有的对象，也可以逐步处理变化的对象。</li>
<li>Reflector接着执行ListAndWatch函数，ListAndWatch第一次会列出所有的对象，并获取资源对象的版本号，然后watch资源对象的版本号来查看是否有被变更。首先会将资源版本号设置为0，<code>list()</code>可能会导致本地的缓存相对于etcd里面的内容存在延迟，<code>Reflector</code>会通过<code>watch</code>的方法将延迟的部分补充上，使得本地的缓存数据与etcd的数据保持一致。</li>
<li>controller.Run函数还会调用processLoop函数，processLoop通过调用HandleDeltas，再调用distribute，processorListener.add最终将不同更新类型的对象加入<code>processorListener</code>的channel中，供processorListener.Run使用。</li>
<li>processor的主要功能就是记录了所有的回调函数实例(即 ResourceEventHandler 实例)，并负责触发这些函数。processor记录了不同类型的事件函数，其中事件函数在NewXxxController构造函数部分注册，具体事件函数的处理，一般是将需要处理的对象加入对应的controller的任务队列中，然后由类似syncDeployment的同步函数来维持期望状态的同步逻辑。</li>
</ol>
<p>参考文章：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes/client-go/tree/master/tools/cache">https://github.com/kubernetes/client-go/tree/master/tools/cache</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md">https://github.com/kubernetes/sample-controller/blob/master/docs/controller-client-go.md</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/client-go/blob/master/examples/workqueue/main.go">https://github.com/kubernetes/client-go/blob/master/examples/workqueue/main.go</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bc0b8c343e4b4530b9dc8bf6f49b5e5d">3.5 - kube-controller-manager源码分析（四）之 ReplicaSetController</h1>
    
	<p>本文主要分析replicaset-controller的源码逻辑，replicas对象创建主要是由deployment-controller中封装。而replicas是pod的维护控制器。可以把replicas理解为deployment中的版本控制器，该控制器封装每次版本的pod对象。</p>
<h1 id="1-startreplicasetcontroller">1. startReplicaSetController</h1>
<p>startReplicaSetController函数是ReplicaSetController的入口函数。基本的操作即new controller对象，然后起一个goroutine运行run函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">startReplicaSetController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerContext</span> <span style="color:#000">ControllerContext</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">replicaset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewReplicaSetController</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FromContext</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Apps</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Core</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientBuilder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientOrDie</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;replicaset-controller&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">replicaset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BurstReplicas</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">).</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentRSSyncs</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-newreplicasetcontroller">2. NewReplicaSetController</h1>
<p>NewReplicaSetController初始化controller对象，最终通过NewBaseController实现具体的初始化操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewReplicaSetController configures a replica set controller with the specified event recorder
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewReplicaSetController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span> <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsInformer</span> <span style="color:#000">appsinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podInformer</span> <span style="color:#000">coreinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeClient</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">burstReplicas</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ReplicaSetController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">eventBroadcaster</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBroadcaster</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">legacyregistry</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unable to register metrics&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewBaseController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">burstReplicas</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchemeGroupVersion</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithKind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ReplicaSet&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;replicaset_controller&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;replicaset&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RealPodControl</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRecorder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">scheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventSource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Component</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;replicaset-controller&#34;</span><span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-1-newbasecontroller">2.1. NewBaseController</h2>
<p>NewBaseController是一个常见的k8s controller构建函数，主要包括以下几个部分：</p>
<ul>
<li>初始化常用client，包括kube client</li>
<li>添加event handler对象。</li>
<li>添加informer索引。</li>
<li>添加informer syncCache的函数，在处理controller逻辑前先同步一下etcd的数据到本地cache。</li>
<li>赋值syncHandler函数，是具体实现controller逻辑的函数。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewBaseController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span> <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsInformer</span> <span style="color:#000">appsinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podInformer</span> <span style="color:#000">coreinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeClient</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">burstReplicas</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">gvk</span> <span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metricOwnerName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">queueName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podControl</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodControlInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">eventBroadcaster</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventBroadcaster</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ReplicaSetController</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 初始化常用配置
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">rsc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ReplicaSetController</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">gvk</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podControl</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">podControl</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">burstReplicas</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">burstReplicas</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">expectations</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewUIDTrackingControllerExpectations</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerExpectations</span><span style="color:#000;font-weight:bold">()),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">queue</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNamedRateLimitingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultControllerRateLimiter</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">queueName</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 添加event handler对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addRS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateRS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteRS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 添加informer索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddIndexers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Indexers</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controllerUIDIndex</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSet</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">controllerRef</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetControllerOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">controllerRef</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerRef</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsIndexer</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">GetIndexer</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsLister</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lister</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 初始化informer的sync函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsListerSynced</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rsInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// This invokes the ReplicaSet for every pod change, eg: host assignment. Though this might seem like
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// overkill the most frequent pod update is status, and the associated ReplicaSet will only list from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// local storage, so it should be ok.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podLister</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lister</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podListerSynced</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 初始化syncHandler函数，该函数为具体实现controller业务逻辑的函数。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncHandler</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncReplicaSet</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rsc</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-run">3. Run</h1>
<p><code>Run</code>函数仍然是k8s controller的代码风格。主要包含了以下几个部分。</p>
<ul>
<li>同步本地cache内容</li>
<li>运行多个不退出的goroutine处理控制器逻辑。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rsc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ReplicaSetController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">workers</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 已删除非核心逻辑代码。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ShutDown</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 处理前同步下cache的内容。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForNamedCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podListerSynced</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsListerSynced</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 运行指定个数的goroutine来处理controller逻辑。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">workers</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UntilWithContext</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">worker</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-1-processnextworkitem">3.1. processNextWorkItem</h2>
<p><code>processNextWorkItemz</code>主要运行syncHandler函数，和对返回的错误进行处理。</p>
<ul>
<li>如果错误为空，则不再入队。</li>
<li>如果错误不为空，则入队重新处理。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rsc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ReplicaSetController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">worker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processNextWorkItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rsc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ReplicaSetController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">processNextWorkItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">quit</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">quit</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 具体的逻辑代码由syncHandler实现。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 如果错误为空，则不再入队
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Forget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sync %q failed with %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 如果错误不为空，则重新入队
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddRateLimited</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-syncreplicaset">4. syncReplicaSet</h1>
<p><code>syncReplicaSet</code>是syncHandler的具体实现，常见的syncHandler的实现包含以下几个部分</p>
<ul>
<li>获取集群中的controller对象，例如 rs。</li>
<li>获取该controller对象及其子对象的当前状态。</li>
<li>对比当前状态与预期状态是否一致。</li>
<li>更新当前状态，以上循环直到当前状态达到期望状态。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rsc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ReplicaSetController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncReplicaSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 已删除非核心代码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SplitMetaNamespaceKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 获取集群中的rs对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rsLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">apierrors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotFound</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;deleted&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;kind&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expectations</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteExpectations</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rsNeedsSync</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expectations</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SatisfiedExpectations</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 获取指定selector下pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">selector</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LabelSelectorAsSelector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Selector</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">allPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">labels</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Everything</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">filteredPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FilterActivePods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allPods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">filteredPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">claimPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">selector</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filteredPods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 处理replica逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">manageReplicasErr</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rsNeedsSync</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">manageReplicasErr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">manageReplicas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filteredPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rs</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">newStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">calculateStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filteredPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">manageReplicasErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 更新状态
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">updatedRS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">updateReplicaSetStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AppsV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ReplicaSets</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Resync the ReplicaSet after MinReadySeconds as a last line of defense to guard against clock-skew.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">manageReplicasErr</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">updatedRS</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MinReadySeconds</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">updatedRS</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadyReplicas</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updatedRS</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Replicas</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">updatedRS</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AvailableReplicas</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updatedRS</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Replicas</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddAfter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updatedRS</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MinReadySeconds</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">manageReplicasErr</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-managereplicas">5. manageReplicas</h1>
<p><code>manageReplicas</code>主要实现pod的创建和删除，从而保证当前rs下的pod跟预期的一致。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rsc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ReplicaSetController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">manageReplicas</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filteredPods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 计算当前的pod数量和预期的pod是否一致。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">diff</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredPods</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Replicas</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rsKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 如果少于预期
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">diff</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 则批量创建pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">successfulCreations</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">slowStartBatch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">diff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SlowStartInitialBatchSize</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podControl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreatePods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Template</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GroupVersionKind</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 如果pod数量多于预期
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">diff</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">relatedPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getIndirectlyRelatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Choose which Pods to delete, preferring those in earlier phases of startup.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">podsToDelete</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getPodsToDelete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">relatedPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">diff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">errCh</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">diff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">diff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podsToDelete</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">targetPod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 批量删除pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podControl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">targetPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 处理错误
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">errCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// all errors have been reported before and they&#39;re likely to be the same, so we&#39;ll only return the first one we hit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="总结">总结</h1>
<p>replicaset-controller的代码逻辑相对简单，基本的代码风格是k8s控制器通用的代码逻辑，由于k8s的代码风格高度一致，因此如果读清楚一类controller的控制逻辑。其他的控制器的代码逻辑大同小异。</p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/replicaset/replica_set.go">https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/replicaset/replica_set.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8d44ce2359b0825a7ddd3cf8b2255b9c">3.6 - kube-controller-manager源码分析（五）之 DaemonSetController</h1>
    
	<p>本文主要分析<code>DaemonSetController</code>的源码逻辑，daemonset是运行在指定节点上的服务，常用来作为agent类的服务来配置，也是k8s最常用的控制器之一。</p>
<h1 id="1-startdaemonsetcontroller">1. startDaemonSetController</h1>
<p>startDaemonSetController是入口函数，先New后Run。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">startDaemonSetController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerContext</span> <span style="color:#000">ControllerContext</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">daemon</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDaemonSetsController</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Apps</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">DaemonSets</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Apps</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ControllerRevisions</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Core</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Core</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">V1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Nodes</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientBuilder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientOrDie</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;daemon-set-controller&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">flowcontrol</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBackOff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">15</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Minute</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error creating DaemonSets controller: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerContext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DaemonSetController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConcurrentDaemonSetSyncs</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-newdaemonsetscontroller">2. NewDaemonSetsController</h1>
<p>NewDaemonSetsController仍然是常见的k8s controller初始化逻辑:</p>
<ul>
<li>常用配置初始化</li>
<li>根据所需要的对象，添加event handler，便于监听所需要对象的事件变化，此处包括ds, pod，node三个对象。</li>
<li>赋值syncHandler，即具体实现是syncDaemonSet函数。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewDaemonSetsController</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">daemonSetInformer</span> <span style="color:#000">appsinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DaemonSetInformer</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">historyInformer</span> <span style="color:#000">appsinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerRevisionInformer</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podInformer</span> <span style="color:#000">coreinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeInformer</span> <span style="color:#000">coreinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInformer</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeClient</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">failedPodsBackoff</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">flowcontrol</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Backoff</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DaemonSetsController</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 常用配置初始化
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">dsc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">DaemonSetsController</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRecorder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">scheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventSource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Component</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;daemonset-controller&#34;</span><span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podControl</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RealPodControl</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRecorder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">scheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventSource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Component</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;daemonset-controller&#34;</span><span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">crControl</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RealControllerRevisionControl</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">burstReplicas</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">BurstReplicas</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">expectations</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerExpectations</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">queue</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNamedRateLimitingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultControllerRateLimiter</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;daemonset&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 添加event handler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">daemonSetInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addDaemonset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateDaemonset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteDaemonset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dsLister</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">daemonSetInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lister</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dsStoreSynced</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">daemonSetInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">historyInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addHistory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateHistory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteHistory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">historyLister</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">historyInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lister</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">historyStoreSynced</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">historyInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 添加pod的event handler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podLister</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lister</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podStoreSynced</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">podInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 添加node的event handler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">nodeInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeStoreSynced</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">nodeInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeLister</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">nodeInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lister</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 赋值syncHandler，具体的controller处理代码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncHandler</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncDaemonSet</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueDaemonSet</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">failedPodsBackoff</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">failedPodsBackoff</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-run">3. Run</h1>
<p><code>Run</code>函数与其他controller的逻辑一致不再分析，具体可以阅读本源码分析系列的replicaset-controller分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dsc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DaemonSetsController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">workers</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartStructuredLogging</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartRecordingToSink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventSinkImpl</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Events</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Shutdown</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ShutDown</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">logger</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FromContext</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting daemon sets controller&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Shutting down daemon sets controller&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForNamedCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;daemon sets&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podStoreSynced</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeStoreSynced</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">historyStoreSynced</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dsStoreSynced</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">workers</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UntilWithContext</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runWorker</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">failedPodsBackoff</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GC</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BackoffGCInterval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-1-processnextworkitem">3.1. processNextWorkItem</h2>
<p><code>processNextWorkItem</code>可参考replicaset-controller对该部分的分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dsc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DaemonSetsController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">runWorker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processNextWorkItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// processNextWorkItem deals with one key off the queue.  It returns false when it&#39;s time to quit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dsc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DaemonSetsController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">processNextWorkItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">dsKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">quit</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">quit</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dsKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dsKey</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Forget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dsKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%v failed with : %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dsKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddRateLimited</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dsKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-syncdaemonset">4. syncDaemonSet</h1>
<p><code>syncDaemonSet</code>是控制器具体的实现逻辑，即每个控制器的核心实现大部分在syncHandler这个函数中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dsc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DaemonSetsController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncDaemonSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#8f5902;font-style:italic">// 为了突出代码重点，已删除非必要部分。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	 <span style="color:#8f5902;font-style:italic">// 获取集群中的ds对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SplitMetaNamespaceKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dsLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DaemonSets</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	 <span style="color:#8f5902;font-style:italic">// 获取机器列表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#000">nodeList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">labels</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Everything</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">everything</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LabelSelector</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepEqual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ds</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Selector</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">everything</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">eventRecorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SelectingAllReason</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;This daemon set is selecting all pods. A non-empty selector is required.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#8f5902;font-style:italic">// Construct histories of the DaemonSet, and get the hash of current history
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#000">cur</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">old</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constructHistory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">hash</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cur</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Labels</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultDaemonSetUniqueLabelKey</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expectations</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SatisfiedExpectations</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dsKey</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// Only update status. Don&#39;t raise observedGeneration since controller didn&#39;t process object of that generation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateDaemonSetStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hash</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#8f5902;font-style:italic">// 处理daemonset中的pod创建及删除
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateDaemonSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hash</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dsKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">old</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#8f5902;font-style:italic">// 更新状态
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#000">statusErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateDaemonSetStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hash</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">statusErr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">statusErr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed to update status&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;daemonSet&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KObj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ds</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">statusErr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">statusErr</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-manage">5. manage</h1>
<p><code>manage</code>是具体的daemonset的pod创建及删除的具体代码。manage入口在updateDaemonSet的函数中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dsc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DaemonSetsController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">updateDaemonSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DaemonSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeList</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hash</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">old</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerRevision</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// manage处理pod的创建及删除
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">manage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hash</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cleanupHistory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">old</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to clean up revisions of DaemonSet: %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下是manage的具体代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dsc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DaemonSetsController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">manage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DaemonSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeList</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hash</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#8f5902;font-style:italic">// 查找daemonset中pod和node的映射
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#000">nodeToDaemonPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getNodesToDaemonPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	 <span style="color:#8f5902;font-style:italic">// 计算需要创建和删除的pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">nodesNeedingDaemonPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podsToDelete</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodeList</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">nodesNeedingDaemonPodsOnNode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podsToDeleteOnNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podsShouldBeOnNode</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeToDaemonPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hash</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">nodesNeedingDaemonPods</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodesNeedingDaemonPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodesNeedingDaemonPodsOnNode</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">podsToDelete</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podsToDelete</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podsToDeleteOnNode</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#8f5902;font-style:italic">// Remove unscheduled pods assigned to not existing nodes when daemonset pods are scheduled by scheduler.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#8f5902;font-style:italic">// If node doesn&#39;t exist then pods are never scheduled and can&#39;t be deleted by PodGCController.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#000">podsToDelete</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podsToDelete</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">getUnscheduledPodsWithoutNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeToDaemonPods</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#8f5902;font-style:italic">// 根据上述的计算结果，实现具体创建和删除pod的操作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podsToDelete</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodesNeedingDaemonPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hash</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="6-syncnodes">6. syncNodes</h1>
<p><code>syncNodes</code>根据传入的需要创建和删除的pod，实现具体的创建和删除pod的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dsc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DaemonSetsController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DaemonSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podsToDelete</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodesNeedingDaemonPods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hash</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 已删除次要代码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">dsKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ds</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">batchSize</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">integer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IntMin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">createDiff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SlowStartInitialBatchSize</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">pos</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">createDiff</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">pos</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">batchSize</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pos</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">integer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IntMin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">batchSize</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">createDiff</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pos</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">batchSize</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#000">pos</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">batchSize</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">errorCount</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">createWait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">batchSize</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pos</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">pos</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">batchSize</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ix</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">createWait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// 批量创建pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podControl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreatePods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podTemplate</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerKind</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">createWait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">deleteWait</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">deleteWait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deleteDiff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">deleteDiff</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ix</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">deleteWait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// 批量删除pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podControl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podsToDelete</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ix</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">dsc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expectations</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionObserved</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dsKey</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">deleteWait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 处理错误
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">errors</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">errCh</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">errors</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">utilerrors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAggregate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errors</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/daemon/daemon_controller.go">https://github.com/kubernetes/kubernetes/blob/master/pkg/controller/daemon/daemon_controller.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-18dccce09a15e696cf7da7b309e68dae">3.7 - controller-runtime源码分析</h1>
    
	<blockquote>
<p>本文主要分析controller-runtime的源码，源码版本为v0.16.3</p>
</blockquote>
<h1 id="1-概述">1. 概述</h1>
<p>controller-runtime源码地址：https://github.com/kubernetes-sigs/controller-runtime。</p>
<p>controller-runtime项目是一个用于快速构建k8s operator的工具包。其中kubebuilder和operator-sdk项目都是通过controller-runtime项目来快速编写k8s operator的工具。</p>
<p>本文以kubebuilder的代码生成架构为例，分析controller-runtime的逻辑。kubebuilder框架生成的代码参考：<a href="https://github.com/huweihuang/venus">https://github.com/huweihuang/venus</a></p>
<h1 id="2-controller-runtime架构图">2. controller-runtime架构图</h1>
<p><img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1700367468/article/kubernetes/kubebuilder/controller_runtime_overview.jpg" alt=""></p>
<p>代码目录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pkg
</span></span><span style="display:flex;"><span>├── builder
</span></span><span style="display:flex;"><span>├── cache
</span></span><span style="display:flex;"><span>├── client  <span style="color:#8f5902;font-style:italic"># client用于操作k8s的对象</span>
</span></span><span style="display:flex;"><span>├── cluster
</span></span><span style="display:flex;"><span>├── config
</span></span><span style="display:flex;"><span>├── controller  <span style="color:#8f5902;font-style:italic"># controller逻辑</span>
</span></span><span style="display:flex;"><span>├── envtest
</span></span><span style="display:flex;"><span>├── event
</span></span><span style="display:flex;"><span>├── finalizer
</span></span><span style="display:flex;"><span>├── handler
</span></span><span style="display:flex;"><span>├── internal  <span style="color:#8f5902;font-style:italic"># 核心代码 controller的具体实现</span>
</span></span><span style="display:flex;"><span>├── leaderelection
</span></span><span style="display:flex;"><span>├── manager   <span style="color:#8f5902;font-style:italic"># 核心代码</span>
</span></span><span style="display:flex;"><span>├── predicate
</span></span><span style="display:flex;"><span>├── ratelimiter
</span></span><span style="display:flex;"><span>├── reconcile
</span></span><span style="display:flex;"><span>├── recorder
</span></span><span style="display:flex;"><span>├── scheme
</span></span><span style="display:flex;"><span>├── <span style="color:#204a87">source</span>
</span></span><span style="display:flex;"><span>└── webhook
</span></span></code></pre></div><h1 id="3-operator框架逻辑">3. Operator框架逻辑</h1>
<blockquote>
<p>代码参考：https://github.com/huweihuang/venus/blob/main/cmd/app/operator.go#L71</p>
</blockquote>
<p>operator代码框架的主体逻辑包括以下几个部分。</p>
<ul>
<li>
<p><code>manager</code>：主要用来管理多个的controller，构建，注册，运行controller。</p>
</li>
<li>
<p><code>controller</code>：主要用来封装reconciler的控制器。</p>
</li>
<li>
<p><code>reconciler</code>：具体执行业务逻辑的函数。</p>
</li>
</ul>
<p>manger的框架主要包含以下几个部分。</p>
<ul>
<li>
<p>mgr:=ctrl.NewManager：构建一个manager对象。</p>
</li>
<li>
<p>Reconciler.SetupWithManager(mgr)：注册controller到manager对象。</p>
</li>
<li>
<p>mgr.Start(ctrl.SetupSignalHandler())：运行manager从而运行controller的逻辑。</p>
</li>
</ul>
<p>代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 构建manager对象，主要的初始化参数包括
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// - kubeconfig
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// - controller的option参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetConfigOrDie</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Options</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">scheme</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Metrics</span><span style="color:#000;font-weight:bold">:</span>                <span style="color:#000">metricsserver</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Options</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">BindAddress</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">opt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MetricsAddr</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">HealthProbeBindAddress</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">opt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProbeAddr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">opt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableLeaderElection</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">LeaderElectionID</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#4e9a06">&#34;52609143.huweihuang.com&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">MaxConcurrentReconciles</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">opt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxConcurrentReconciles</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 将controller注册到manager中，并初始化controller对象。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">venuscontroller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RedisReconciler</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Client</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetClient</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetScheme</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">SetupWithManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unable to create controller&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;controller&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Redis&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 运行manager对象，从而运行controller中的reconcile逻辑。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetupSignalHandler</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setupLog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;problem running manager&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-newmanager">4. NewManager</h1>
<p>NewManager初始化一个manager 用来管理和创建controller对象。一个manager可以关联多个controller对象。manager是一个接口，而最终是实现结构体是<code>controllerManager</code>的对象。</p>
<h2 id="4-1-manager接口">4.1. Manager接口</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Manager</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Cluster holds a variety of methods to interact with a cluster.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Add will set requested dependencies on the component, and cause the component to be
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// started when Start is called.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Depending on if a Runnable implements LeaderElectionRunnable interface, a Runnable can be run in either
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// non-leaderelection mode (always running) or leader election mode (managed by leader election if enabled).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 通过Runnable接口将具体的controller注册到manager中。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Runnable</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start starts all registered Controllers and blocks until the context is cancelled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Returns an error if there is an error starting any controller.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If LeaderElection is used, the binary must be exited immediately after this returns,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// otherwise components that need leader election might continue to run after the leader
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// lock was lost.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 运行具体的逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-2-newcontrollermanager">4.2. NewControllerManager</h2>
<p>New构建一个具体的controllerManager的对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span> <span style="color:#000">Options</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">Manager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Set default values for options fields
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">options</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">setOptionsDefaults</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">errChan</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">runnables</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">newRunnables</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BaseContext</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">controllerManager</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">stopProcedureEngaged</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#000">pointer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">:</span>                       <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">runnables</span><span style="color:#000;font-weight:bold">:</span>                     <span style="color:#000">runnables</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">errChan</span><span style="color:#000;font-weight:bold">:</span>                       <span style="color:#000">errChan</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">recorderProvider</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">recorderProvider</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">resourceLock</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#000">resourceLock</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">metricsServer</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">metricsServer</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">controllerConfig</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">logger</span><span style="color:#000;font-weight:bold">:</span>                        <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Logger</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">elected</span><span style="color:#000;font-weight:bold">:</span>                       <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">webhookServer</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WebhookServer</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">leaderElectionID</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElectionID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">leaseDuration</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaseDuration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">renewDeadline</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RenewDeadline</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">retryPeriod</span><span style="color:#000;font-weight:bold">:</span>                   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RetryPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">healthProbeListener</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">healthProbeListener</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">readinessEndpointName</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadinessEndpointName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">livenessEndpointName</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LivenessEndpointName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pprofListener</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">pprofListener</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gracefulShutdownTimeout</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GracefulShutdownTimeout</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">internalProceduresStop</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">leaderElectionStopped</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">leaderElectionReleaseOnCancel</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElectionReleaseOnCancel</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-setupwithmanager">5. SetupWithManager</h1>
<p>SetupWithManager将具体的controller注册到manager中。其中通过<code>Complete</code>完成controller的初始化。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// SetupWithManager sets up the controller with the Manager.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">RedisReconciler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">SetupWithManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewControllerManagedBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">For</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">venusv1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">{}).</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>SetupWithManager通过NewControllerManagedBy方法构建了一个Builder的对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Builder builds a Controller.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Builder</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">forInput</span>         <span style="color:#000">ForInput</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ownsInput</span>        <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">OwnsInput</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">watchesInput</span>     <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">WatchesInput</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mgr</span>              <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">globalPredicates</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Predicate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ctrl</span>             <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ctrlOptions</span>      <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Options</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span>             <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ControllerManagedBy returns a new controller builder that will be started by the provided Manager.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ControllerManagedBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Builder</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Builder</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过builder对象完成controller的初始化。</p>
<h2 id="5-1-controller初始化">5.1. controller初始化</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Build builds the Application Controller and returns the Controller it created.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">blder</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Builder</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Build</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reconciler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Set the ControllerManagedBy
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">blder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">doController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>  <span style="color:#8f5902;font-style:italic">// 初始化controller
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Set the Watch
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">blder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">doWatch</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>   <span style="color:#8f5902;font-style:italic">// 添加event handler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">blder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ctrl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>doController</code>最终通过调用<code>NewUnmanaged</code>构建一个controller对象。并传入自定义的reconciler对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mgr</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span> <span style="color:#000">Options</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewUnmanaged</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Add the controller as a Manager components
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mgr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewUnmanaged returns a new controller without adding it to the manager. The
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// caller is responsible for starting the returned controller.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewUnmanaged</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mgr</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span> <span style="color:#000">Options</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reconciler</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;must specify Reconciler&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Create controller with dependencies set
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Do</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reconciler</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#8f5902;font-style:italic">// 将具体的reconciler函数传递到controller的reconciler。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">MakeQueue</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimitingInterface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRateLimitingQueueWithConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimiter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimitingQueueConfig</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span> <span style="color:#8f5902;font-style:italic">// 初始化任务队列
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">MaxConcurrentReconciles</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxConcurrentReconciles</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// 设置controller的并发数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">CacheSyncTimeout</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CacheSyncTimeout</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>                    <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">LogConstructor</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogConstructor</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">RecoverPanic</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RecoverPanic</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">LeaderElected</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeedLeaderElection</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span></code></pre></div><h2 id="5-2-添加event-handler">5.2. 添加event handler</h2>
<p><code>doWatch</code>最终会运行informer.start添加event handler。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Watch implements controller.Controller.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span> <span style="color:#000">source</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evthdler</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prct</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Predicate</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Controller hasn&#39;t started yet, store the watches locally and return.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// These watches are going to be held on the controller struct until the manager or user calls Start(...).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Started</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startWatches</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startWatches</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">watchDescription</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">evthdler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">prct</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogConstructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting EventSource&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;source&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evthdler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prct</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>add event handler</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">is</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventHandler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">queue</span> <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RateLimitingInterface</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">prct</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Predicate</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Informer should have been specified by the user.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">is</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;must specify Informer.Informer&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">is</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">internal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prct</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">HandlerFuncs</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="6-mgr-start">6. mgr.Start</h1>
<p>controllerManager运行之前注册的runnables的函数，其中包括controller的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">cm</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">controllerManager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start and wait for caches.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runnables</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Caches</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">internalCtx</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the non-leaderelection Runnables after the cache has synced.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runnables</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Others</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">internalCtx</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the leader election and all required runnables.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithCancel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">leaderElectionCancel</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cancel</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resourceLock</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startLeaderElection</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">errChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// Treat not having leader election enabled the same as being elected.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startLeaderElectionRunnables</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">errChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elected</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-1-controller-start">6.1. controller.start</h2>
<p>start主要包含2个部分</p>
<ul>
<li>同步cache：WaitForSync</li>
<li>启动指定并发数的worker：processNextWorkItem</li>
</ul>
<p>该部分的代码逻辑跟k8s controller-manager中的具体的controller的逻辑类似。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">watch</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startWatches</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">syncingSource</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">watch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">source</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncingSource</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// 同步list-watch中的cache数据。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">syncingSource</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sourceStartCtx</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 运行指定并发数的processNextWorkItem任务。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// Launch workers to process resources
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogConstructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting workers&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;worker count&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxConcurrentReconciles</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxConcurrentReconciles</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxConcurrentReconciles</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// Run a worker thread that just dequeues items, processes them, and marks them done.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#8f5902;font-style:italic">// It enforces that the reconcileHandler is never invoked concurrently with the same object.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processNextWorkItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-2-processnextworkitem">6.2. processNextWorkItem</h2>
<p>经典的<code>processNextWorkItem</code>函数，最终调用<code>reconcileHandler</code>来处理具体的逻辑。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">processNextWorkItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shutdown</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">shutdown</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Stop working
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctrlmetrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ActiveWorkers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">ctrlmetrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ActiveWorkers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reconcileHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="7-reconcilehandler">7. reconcileHandler</h1>
<p><code>reconcileHandler</code>部分的代码是整个reconciler逻辑中的核心，自定义的reconciler函数最终是调用了reconcileHandler来实现，并且该函数描述了具体的任务队列处理的几种类型。</p>
<ul>
<li><code>err != nil</code>：如果错误不为空，则重新入队，等待处理。</li>
<li><code>result.RequeueAfter &gt; 0</code>：如果指定RequeueAfter &gt; 0，则做延迟入队处理。</li>
<li><code>result.Requeue</code>：如何指定了requeue则表示马上重新入队处理。</li>
<li><code>err == nil</code> : 如果错误为空，表示reconcile成功，则移除队列的任务。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Controller</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">reconcileHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 获取k8s crd的具体对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// As the item in the workqueue is actually invalid, we call
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// Forget here else we&#39;d go into a loop of attempting to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// process a work item that is invalid.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Forget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogConstructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Queue item was not a Request&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;type&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%T&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Return true, don&#39;t take a break
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 调用用户定义的Reconcile函数，并对返回结果进行处理。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reconcile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 如果错误不为空，则重新入队，等待处理
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Is</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reconcile</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TerminalError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ctrlmetrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TerminalReconcileErrors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Inc</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddRateLimited</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequeueAfter</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 如果指定了延迟入队，则做延迟入队处理
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Forget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddAfter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequeueAfter</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Requeue</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 如果指定了马上入队，则做相应处理
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddRateLimited</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 如果错误为空，表示reconcile成功，则移除队列的任务
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Reconcile successful&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Finally, if no error occurs we Forget this item so it does not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// get queued again until another change happens.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Forget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="8-总结">8. 总结</h1>
<ol>
<li>controller-runtime封装了k8s-controller-manager控制器的主要逻辑，其中就包括创建list-watch对象，waitForSync等，创建任务队列，将任务处理的goroutine抽象成一个reconcile函数，使用户更方便的编写operator工具。</li>
<li>kubebuilder是一个基于controller-runtime框架的命令生成工具。可以用于快速生成和部署crd对象，快速生成controller-runtime框架的基本代码。</li>
<li>controller-runtime框架的最核心是reconcileHandler函数，该函数定义了reconcile的4种错误处理及入队重试的类型。可以根据具体的业务需求选择合适的方法来处理。</li>
</ol>
<p>参考：</p>
<ul>
<li>
<p><a href="https://qiankunli.github.io/2020/08/10/controller_runtime.html">controller-runtime源码分析</a></p>
</li>
<li>
<p><a href="https://qiankunli.github.io/2022/11/24/controller_runtime_detail.html">controller-runtime细节分析</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a167c51f6d71759ce1fb280bf2d2542d">3.8 - workqueue源码分析</h1>
    
	<p>本文主要分析client-go中使用的workqueue，从而来分析k8s是如何基于任务队列做并发控制的。其中代码参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/client-go/tree/release-1.30">https://github.com/kubernetes/client-go/tree/release-1.30</a></li>
</ul>
<h1 id="1-概述">1. 概述</h1>
<p>k8s的控制器大多是基于任务队列的方式进行并发控制，甚至包括基于controller-manager开发的自定义operator控制器。以下我们以deployment controller为例展示workqueue在k8s中的使用。</p>
<h1 id="2-deployment中的workqueue">2. Deployment中的workqueue</h1>
<h2 id="2-1-初始化workqueue">2.1. 初始化workqueue</h2>
<p>Deployment 的构建函数NewDeploymentController中初始化了任务队列和对于event事件处理相对应的workqueue的操作。</p>
<ol>
<li>初始化workqueue的限速任务队列。</li>
<li>添加event handler使得deployment对象入队，等待处理。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewDeploymentController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dInformer</span> <span style="color:#000">appsinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeploymentInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rsInformer</span> <span style="color:#000">appsinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podInformer</span> <span style="color:#000">coreinformers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">client</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 初始化一个限速的任务队列
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">queue</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNamedRateLimitingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultControllerRateLimiter</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;deployment&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 添加 add, update, delete的event handler, 其中handler的操作都添加对象到任务队列中。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  	<span style="color:#000">dInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">oldObj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// This will enter the sync loop and no-op, because the deployment has been deleted from the store.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 定义队列处理函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueDeployment</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueue</span>
</span></span></code></pre></div><p>以下显示event handler具体逻辑，可见，无论是add，update，delete event handler都是调用enqueueDeployment的函数，而enqueueDeployment实际上就是初始化函数中的dc.enqueue。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">addDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span> <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Adding deployment&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;deployment&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KObj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">updateDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span> <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">old</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cur</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">oldD</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">old</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">curD</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cur</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Updating deployment&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;deployment&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KObj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">oldD</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">curD</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">deleteDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logger</span> <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Logger</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Deleting deployment&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;deployment&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KObj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enqueueDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-添加任务到队列">2.2. 添加任务到队列</h2>
<p>以下是dc.enqueue的具体实现，可见最终的调用workqueue的Add方法，添加对象到任务队列中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">enqueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deployment</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">apps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployment</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeyFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 添加到任务队列中。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>   <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中key是<code>namespace/name</code>的拼接字符串，通过MetaNamespaceKeyFunc函数获取对象的key。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 通过该函数获取k8s对象中处理的key。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">MetaNamespaceKeyFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">ExplicitKey</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">objName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ObjectToName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">objName</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 拼接namespace和name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">objName</span> <span style="color:#000">ObjectName</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">String</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">objName</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">objName</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;/&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">objName</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">objName</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-读取任务队列">2.3. 读取任务队列</h2>
<p>deployment controller会调用<code>dc.queue.Get()</code>来读取任务队列中的对象。该goroutine是一个常驻的逻辑实时获取。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">processNextWorkItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 读取任务队列
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">quit</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">quit</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 返回将key设置为done。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 处理任务
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handleErr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>任务的错误处理：</p>
<ol>
<li>如果错误为空，则调用Forget移出队列</li>
<li>如果小于最大重试次数，则加入延迟队列</li>
<li>如果大于最大重试次数，则移出队列。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">handleErr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 如果错误为空，则调用Forget移出队列
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HasStatusCause</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceTerminatingCause</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Forget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ns</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keyErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SplitMetaNamespaceKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 如果小于最大重试次数，则加入延迟队列
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumRequeues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">maxRetries</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddRateLimited</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 如果大于最大重试次数，则移出队列。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Dropping deployment out of the queue&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;deployment&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ns</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;err&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Forget</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>syncDeployment获取deployment对象，基于ns和name重新获取deployment。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DeploymentController</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncDeployment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 拆分key获取ns和name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SplitMetaNamespaceKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 基于ns和name获取deployment对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deployments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotFound</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">logger</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Deployment has been deleted&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;deployment&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// deepcopy deployment对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">deployment</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><blockquote>
<p>待完善</p>
</blockquote>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5dffb45fbf5394ee40d3271948c99485">4 - kube-scheduler</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-81ad0a7153dd8d183646f8d1ebd1c6a5">4.1 - kube-scheduler 源码思维导图</h1>
    
	<h2 id="源码整体结构图">源码整体结构图</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1618721802/article/code-analysis/kube-scheduler/scheduler.png" width="100%">

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-450020ba5dcfaba3eb90de8c14204285">4.2 - kube-scheduler源码分析（一）之 NewSchedulerCommand</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>scheduler的<code>cmd</code>代码目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kube-scheduler
</span></span><span style="display:flex;"><span>├── BUILD
</span></span><span style="display:flex;"><span>├── OWNERS
</span></span><span style="display:flex;"><span>├── app            <span style="color:#8f5902;font-style:italic"># app的目录下主要为运行scheduler相关的对象</span>
</span></span><span style="display:flex;"><span>│   ├── BUILD
</span></span><span style="display:flex;"><span>│   ├── config      
</span></span><span style="display:flex;"><span>│   │   ├── BUILD
</span></span><span style="display:flex;"><span>│   │   └── config.go    <span style="color:#8f5902;font-style:italic"># Scheduler的配置对象config</span>
</span></span><span style="display:flex;"><span>│   ├── options      <span style="color:#8f5902;font-style:italic"># options主要记录 Scheduler 使用到的参数</span>
</span></span><span style="display:flex;"><span>│   │   ├── BUILD
</span></span><span style="display:flex;"><span>│   │   ├── configfile.go
</span></span><span style="display:flex;"><span>│   │   ├── deprecated.go
</span></span><span style="display:flex;"><span>│   │   ├── deprecated_test.go
</span></span><span style="display:flex;"><span>│   │   ├── insecure_serving.go
</span></span><span style="display:flex;"><span>│   │   ├── insecure_serving_test.go
</span></span><span style="display:flex;"><span>│   │   ├── options.go    <span style="color:#8f5902;font-style:italic"># 主要包括Options、NewOptions、AddFlags、Config等函数</span>
</span></span><span style="display:flex;"><span>│   │   └── options_test.go
</span></span><span style="display:flex;"><span>│   └── server.go    <span style="color:#8f5902;font-style:italic"># 主要包括 NewSchedulerCommand、NewSchedulerConfig、Run等函数</span>
</span></span><span style="display:flex;"><span>└── scheduler.go     <span style="color:#8f5902;font-style:italic"># main入口函数</span>
</span></span></code></pre></div><h1 id="1-main-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kube-scheduler-scheduler-go-l34-函数">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/scheduler.go#L34">Main</a>函数</h1>
<blockquote>
<p>此部分的代码为/cmd/kube-scheduler/scheduler.go</p>
</blockquote>
<p><code>kube-scheduler</code>的入口函数<code>Main</code>函数，仍然是采用统一的代码风格，使用<a href="https://github.com/spf13/cobra">Cobra</a>命令行框架。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UTC</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UnixNano</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSchedulerCommand</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: once we switch everything over to Cobra commands, we can go back to calling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// utilflag.InitFlags() (by removing its pflag.Parse() call). For now, we have to set the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// normalize func and add the go flag set by hand.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetNormalizeFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">utilflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WordSepNormalizeFunc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddGoFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">goflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// utilflag.InitFlags()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlushLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 初始化scheduler命令结构体
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSchedulerCommand</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 执行Execute
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h1 id="2-newschedulercommand-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kube-scheduler-app-server-go-l68">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/app/server.go#L68">NewSchedulerCommand</a></h1>
<blockquote>
<p>此部分的代码为/cmd/kube-scheduler/app/server.go</p>
</blockquote>
<p><code>NewSchedulerCommand</code>主要用来构造和初始化SchedulerCommand结构体，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewSchedulerCommand creates a *cobra.Command object with default parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewSchedulerCommand</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unable to initialize command options: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;kube-scheduler&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Long</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`The Kubernetes scheduler is a policy-rich, topology-aware,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">workload-specific function that significantly impacts availability, performance,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">and capacity. The scheduler needs to take into account individual and collective
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">resource requirements, quality of service requirements, hardware/software/policy
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">constraints, affinity and anti-affinity specifications, data locality, inter-workload
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">interference, deadlines, and so on. Workload-specific requirements will be exposed
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">through the API as necessary.`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Run</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">verflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintAndExitIfRequested</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">utilflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;arguments are not supported\n&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">errs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Validate</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">utilerrors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAggregate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteConfigTo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteConfigFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteConfigTo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Wrote configuration to: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteConfigTo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MarkFlagFilename</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;yaml&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;yml&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;json&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 构造option
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 初始化config对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 执行run函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 添加参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><h2 id="2-1-newoptions">2.1. NewOptions</h2>
<p>NewOptions主要用来构造SchedulerServer使用的参数和上下文，其中核心参数是<code>KubeSchedulerConfiguration</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><strong>NewOptions</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewOptions returns default scheduler app options.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewOptions</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Options</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">newDefaultComponentConfig</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">hhost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hport</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">splitHostIntPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HealthzBindAddress</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Options</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// TODO: enable with apiserveroptions.NewSecureServingOptions()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">CombinedInsecureServing</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">CombinedInsecureServingOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Healthz</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">apiserveroptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeprecatedInsecureServingOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">BindNetwork</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Metrics</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">apiserveroptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeprecatedInsecureServingOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">BindNetwork</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">BindPort</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">hport</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">BindAddress</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">hhost</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// TODO: enable with apiserveroptions.NewDelegatingAuthenticationOptions()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">Authorization</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// TODO: enable with apiserveroptions.NewDelegatingAuthorizationOptions()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">Deprecated</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">DeprecatedOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">UseLegacyPolicyConfig</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">PolicyConfigMapNamespace</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceSystem</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-options-config">2.2. Options.Config</h2>
<p>Config初始化调度器的配置对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>Config函数主要执行以下操作：</p>
<ul>
<li>构建scheduler client、leaderElectionClient、eventClient。</li>
<li>创建event recorder</li>
<li>设置leader选举</li>
<li>创建informer对象，主要函数有<code>NewSharedInformerFactory</code>和<code>NewPodInformer</code>。</li>
</ul>
<p>Config具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Config return a scheduler config object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Options</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Config</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulerappconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">schedulerappconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ApplyTo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// prepare kube clients.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">leaderElectionClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">eventClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createClients</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConnection</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Master</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RenewDeadline</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Prepare event clients.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">eventBroadcaster</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBroadcaster</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">recorder</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRecorder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">legacyscheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventSource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Component</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerName</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Set up leader election if enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">leaderElectionConfig</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">leaderelection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElectionConfig</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElect</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">leaderElectionConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">makeLeaderElectionConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">leaderElectionClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">informers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSharedInformerFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPodInformer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">eventClient</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">recorder</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Broadcaster</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">eventBroadcaster</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">leaderElectionConfig</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-addflags">2.3. AddFlags</h2>
<p><code>AddFlags</code>为SchedulerServer添加指定的参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>AddFlags函数的具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// AddFlags adds flags for the scheduler options.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Options</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;The path to the configuration file. Flags override values in this file.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteConfigTo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;write-config-to&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteConfigTo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;If set, write the configuration values to this file and exit.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Master</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;master&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Master</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;The address of the Kubernetes API server (overrides any value in kubeconfig)&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CombinedInsecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authorization</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deprecated</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">leaderelectionconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BindFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElectionConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlag</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-run-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kube-scheduler-app-server-go-l126">3. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/app/server.go#L126">Run</a></h1>
<blockquote>
<p>此部分的代码为/cmd/kube-scheduler/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code> Run</code>运行一个不退出的常驻进程，来执行scheduler的相关操作。</p>
<p>Run函数的主要内容如下：</p>
<ul>
<li>通过scheduler config来创建scheduler的结构体。</li>
<li>运行event broadcaster、healthz server、metrics server。</li>
<li>运行所有的informer并在调度前等待cache的同步（重点）。</li>
<li>执行<code>sched.Run()</code>来运行scheduler的调度逻辑。</li>
<li>如果多个scheduler并开启了<code>LeaderElect</code>，则执行leader选举。</li>
</ul>
<p>以下对重点代码分开分析：</p>
<h2 id="3-1-newschedulerconfig">3.1. NewSchedulerConfig</h2>
<blockquote>
<p>NewSchedulerConfig初始化SchedulerConfig（此部分具体逻辑待后续专门分析），最后初始化生成scheduler结构体。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Build a scheduler config from the provided algorithm source.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">schedulerConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewSchedulerConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create the scheduler.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">scheduler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewFromConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="3-2-informerfactory-start">3.2. InformerFactory.Start</h2>
<p>运行PodInformer，并运行InformerFactory。此部分的逻辑为client-go的informer机制，在<a href="https://www.huweihuang.com/kubernetes-notes/code-analysis/kube-controller-manager/sharedIndexInformer.html">Informer机制</a>中有详细分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start all informers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="3-3-waitforcachesync">3.3. WaitForCacheSync</h2>
<p>在调度前等待cache同步。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Wait for all caches to sync before scheduling.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scheduler&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="3-3-1-informerfactory-waitforcachesync">3.3.1. InformerFactory.WaitForCacheSync</h3>
<p><code>InformerFactory.WaitForCacheSync</code>等待所有启动的informer的cache进行同步，保持本地的store信息与etcd的信息是最新一致的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// WaitForCacheSync waits for all started informers&#39; cache were synced.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sharedInformerFactory</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">informers</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedIndexInformer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">informers</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedIndexInformer</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">informerType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">informer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">informers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedInformers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">informerType</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">informers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">informerType</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">informer</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">informers</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">informType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">informer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">informers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">res</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">informType</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">informer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HasSynced</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">res</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>接着调用<code> cache.WaitForCacheSync</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// WaitForCacheSync waits for caches to populate.  It returns true if it was successful, false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// if the controller should shutdown
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">cacheSyncs</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">InformerSynced</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PollUntil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncedPollPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncFunc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">cacheSyncs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">syncFunc</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;stop requested&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;caches populated&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-3-2-controller-waitforcachesync">3.3.2. controller.WaitForCacheSync</h3>
<p><code>controller.WaitForCacheSync</code>是对<code>cache.WaitForCacheSync</code>的一层封装，通过不同的controller的名字来记录不同controller等待cache同步。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scheduler&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>controller.WaitForCacheSync</code>具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// WaitForCacheSync is a wrapper around cache.WaitForCacheSync that generates log messages
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// indicating that the controller identified by controllerName is waiting for syncs, followed by
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// either a successful or failed sync.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">cacheSyncs</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerSynced</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Waiting for caches to sync for %s controller&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cacheSyncs</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unable to sync caches for %s controller&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Caches are synced for %s controller&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-4-leaderelection">3.4. LeaderElection</h2>
<p>如果有多个scheduler，并开启leader选举，则运行<code>LeaderElector</code>直到选举结束或退出。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If leader election is enabled, run via LeaderElector until done and exit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Callbacks</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">leaderelection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderCallbacks</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">OnStartedLeading</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">run</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">OnStoppedLeading</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;lost master&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">leaderElector</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">leaderelection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewLeaderElector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;couldn&#39;t create leader elector: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">leaderElector</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;lost lease&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-5-scheduler-run">3.5. Scheduler.Run</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Prepare a reusable run function.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">run</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithCancel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TODO</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#8f5902;font-style:italic">// TODO once Run() accepts a context, it should be used here
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>Scheduler.Run</code>先等待cache同步，然后开启调度逻辑的goroutine。</p>
<p>Scheduler.Run的具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run begins watching and scheduling. It waits for cache to be synced, then starts a goroutine and returns immediately.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scheduleOne</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StopEverything</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以上是对<code>/cmd/kube-scheduler/scheduler.go</code>部分代码的分析，<code>Scheduler.Run</code>后续的具体代码位于<code>pkg/scheduler/scheduler.go</code>待后续文章分析。</p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kube-scheduler">https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kube-scheduler</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/scheduler.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/app/server.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/app/server.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-098ce169e4f76190487656ba8c3899d7">4.3 - kube-scheduler源码分析（二）之 调度算法</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>此部分主要介绍调度中使用的各种调度算法，包括调度算法的注册部分。注册部分的代码主要在<code>/pkg/scheduler/algorithmprovider</code>中，具体的预选策略和优选策略的算法实现在<code>/pkg/scheduler/algorithm</code>中。</p>
<h1 id="1-applyfeaturegates">1. ApplyFeatureGates</h1>
<p>注册调度算法的调用入口在SchedulerCommand的Run函数中。</p>
<blockquote>
<p>此部分代码位于/cmd/kube-scheduler/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run runs the Scheduler.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">schedulerserverconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CompletedConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Apply algorithms based on feature gates.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// TODO: make configurable?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">algorithmprovider</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ApplyFeatureGates</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><p>ApplyFeatureGates的具体实现在<code>pkg/scheduler/algorithmprovider</code>的包中。</p>
<blockquote>
<p>此部分代码位于/pkg/scheduler/algorithmprovider/plugins.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ApplyFeatureGates applies algorithm by feature gates.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ApplyFeatureGates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">defaults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ApplyFeatureGates</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ApplyFeatureGates具体实现如下：</p>
<blockquote>
<p>此部分代码位于/pkg/scheduler/algorithmprovider/defaults/defaults.go</p>
</blockquote>
<p>根据feature移除部分调度策略。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ApplyFeatureGates applies algorithm by feature gates.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ApplyFeatureGates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TaintNodesByCondition</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Remove &#34;CheckNodeCondition&#34;, &#34;CheckNodeMemoryPressure&#34;, &#34;CheckNodePIDPressurePred&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// and &#34;CheckNodeDiskPressure&#34; predicates
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeConditionPred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeMemoryPressurePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeDiskPressurePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodePIDPressurePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Remove key &#34;CheckNodeCondition&#34;, &#34;CheckNodeMemoryPressure&#34; and &#34;CheckNodeDiskPressure&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// from ALL algorithm provider
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// The key will be removed from all providers which in algorithmProviderMap[]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// if you just want remove specific provider, call func RemovePredicateKeyFromAlgoProvider()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePredicateKeyFromAlgorithmProviderMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeConditionPred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePredicateKeyFromAlgorithmProviderMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeMemoryPressurePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePredicateKeyFromAlgorithmProviderMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeDiskPressurePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePredicateKeyFromAlgorithmProviderMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodePIDPressurePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined based on whether a pod can tolerate all of the node&#39;s taints
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterMandatoryFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodToleratesNodeTaintsPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodToleratesNodeTaints</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined based on whether a pod can tolerate unschedulable of node
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterMandatoryFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeUnschedulablePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeUnschedulablePredicate</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Insert Key &#34;PodToleratesNodeTaints&#34; and &#34;CheckNodeUnschedulable&#34; To All Algorithm Provider
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// The key will insert to all providers which in algorithmProviderMap[]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// if you just want insert to specific provider, call func InsertPredicateKeyToAlgoProvider()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InsertPredicateKeyToAlgorithmProviderMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodToleratesNodeTaintsPred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InsertPredicateKeyToAlgorithmProviderMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeUnschedulablePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;TaintNodesByCondition is enabled, PodToleratesNodeTaints predicate is mandatory&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Prioritizes nodes that satisfy pod&#39;s resource limits
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceLimitsPriorityFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ResourceLimitsPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceLimitsPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-init">2. init</h1>
<p>当函数逻辑调用到<code>algorithmprovider</code>包时，就会自动调用init的初始化函数，此部分主要包括对预选算法和优选算法的注册。</p>
<blockquote>
<p>此部分代码位于/pkg/scheduler/algorithmprovider/defaults/defaults.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Register functions that extract metadata used by predicates and priorities computations.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPredicateMetadataProducerFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadataProducer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPredicateMetadataFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityMetadataProducerFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityMetadataProducer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPriorityMetadataFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatefulSetLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">registerAlgorithmProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">defaultPredicates</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">defaultPriorities</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// IMPORTANT NOTES for predicate developers:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// We are using cached predicate result for pods belonging to the same equivalence class.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// So when implementing a new predicate, you are expected to check whether the result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// of your predicate function can be affected by related API object change (ADD/DELETE/UPDATE).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If yes, you are expected to invalidate the cached predicate result for related API object change.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// For example:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// https://github.com/kubernetes/kubernetes/blob/36a218e/plugin/pkg/scheduler/factory/factory.go#L422
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Registers predicates and priorities that are not enabled by default, but user can pick when creating their
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// own set of priorities/predicates.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// PodFitsPorts has been replaced by PodFitsHostPorts for better user understanding.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// For backwards compatibility with 1.0, PodFitsPorts is registered as well.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PodFitsPorts&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHostPorts</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Fit is defined based on the absence of port conflicts.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This predicate is actually a default predicate, because it is invoked from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// predicates.GeneralPredicates()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHostPortsPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHostPorts</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Fit is determined by resource availability.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This predicate is actually a default predicate, because it is invoked from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// predicates.GeneralPredicates()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsResourcesPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsResources</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Fit is determined by the presence of the Host parameter and a string match
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This predicate is actually a default predicate, because it is invoked from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// predicates.GeneralPredicates()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostNamePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Fit is determined by node selector query.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MatchNodeSelectorPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodMatchNodeSelector</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// ServiceSpreadingPriority is a priority config factory that spreads pods by minimizing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the number of pods (belonging to the same service) on the same node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Register the factory so that it&#39;s available, but do not include it as part of the default priorities
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Largely replaced by &#34;SelectorSpreadPriority&#34;, but registered for backward compatibility with 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityConfigFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;ServiceSpreadingPriority&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfigFactory</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">MapReduceFunction</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityMapFunction</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityReduceFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSelectorSpreadPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EmptyControllerLister</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EmptyReplicaSetLister</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EmptyStatefulSetLister</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Weight</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// EqualPriority is a prioritizer function that gives an equal weight of one to all nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Register the priority function so that its available
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// but do not include it as part of the default priorities
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;EqualPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EqualPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Optional, cluster-autoscaler friendly priority function - give used nodes higher priority.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MostRequestedPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MostRequestedPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;RequestedToCapacityRatioPriority&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedToCapacityRatioResourceAllocationPriorityDefault</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PriorityMap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下对init中的注册进行拆分介绍。</p>
<h2 id="2-1-registeralgorithmprovider">2.1. registerAlgorithmProvider</h2>
<p>此部分主要注册默认的预选和优选策略。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Register functions that extract metadata used by predicates and priorities computations.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPredicateMetadataProducerFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadataProducer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPredicateMetadataFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityMetadataProducerFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityMetadataProducer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPriorityMetadataFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatefulSetLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">registerAlgorithmProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">defaultPredicates</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">defaultPriorities</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p><strong>registerAlgorithmProvider</strong></p>
<p>注册AlgorithmProvider，其中包括<code>DefaultProvider</code>和<code>ClusterAutoscalerProvider</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">registerAlgorithmProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priSet</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Registers algorithm providers. By default we use &#39;DefaultProvider&#39;, but user can specify one to be used
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// by specifying flag.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterAlgorithmProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultProvider</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priSet</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Cluster autoscaler friendly scheduling algorithm.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterAlgorithmProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ClusterAutoscalerProvider</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predSet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">copyAndReplace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;LeastRequestedPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;MostRequestedPriority&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-registerfitpredicate">2.2. RegisterFitPredicate</h2>
<p>在init部分注册预选策略函数。</p>
<p>预选策略如下：</p>
<table>
<thead>
<tr>
<th>调度策略</th>
<th>函数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>PodFitsPorts</td>
<td>PodFitsHostPorts</td>
<td>PodFitsPorts已经被PodFitsHostPorts代替，此处主要是为了兼容性。</td>
</tr>
<tr>
<td>PodFitsHostPortsPred</td>
<td>PodFitsHostPorts</td>
<td>判断是否与宿主机的端口冲突。</td>
</tr>
<tr>
<td>PodFitsResourcesPred</td>
<td>PodFitsResources</td>
<td>判断node资源是否充足。</td>
</tr>
<tr>
<td>HostNamePred</td>
<td>PodFitsHost</td>
<td>判断pod所指定调度的节点是否是当前的节点。</td>
</tr>
<tr>
<td>MatchNodeSelectorPred</td>
<td>PodMatchNodeSelector</td>
<td>判断pod指定的node selector是否匹配当前的node。</td>
</tr>
</tbody>
</table>
<p>具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodFitsPorts has been replaced by PodFitsHostPorts for better user understanding.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// For backwards compatibility with 1.0, PodFitsPorts is registered as well.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PodFitsPorts&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHostPorts</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Fit is defined based on the absence of port conflicts.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This predicate is actually a default predicate, because it is invoked from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// predicates.GeneralPredicates()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHostPortsPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHostPorts</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Fit is determined by resource availability.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This predicate is actually a default predicate, because it is invoked from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// predicates.GeneralPredicates()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsResourcesPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsResources</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Fit is determined by the presence of the Host parameter and a string match
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This predicate is actually a default predicate, because it is invoked from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// predicates.GeneralPredicates()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostNamePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Fit is determined by node selector query.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MatchNodeSelectorPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodMatchNodeSelector</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-3-registerpriorityfunction2">2.3. RegisterPriorityFunction2</h2>
<p>在init部分注册优选策略函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// EqualPriority is a prioritizer function that gives an equal weight of one to all nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Register the priority function so that its available
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// but do not include it as part of the default priorities
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;EqualPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EqualPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Optional, cluster-autoscaler friendly priority function - give used nodes higher priority.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MostRequestedPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MostRequestedPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;RequestedToCapacityRatioPriority&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedToCapacityRatioResourceAllocationPriorityDefault</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PriorityMap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="3-defaultpredicates">3. defaultPredicates</h1>
<p>此部分为默认预选策略的注册函数。</p>
<p>默认的预选策略如下：</p>
<table>
<thead>
<tr>
<th>预选策略</th>
<th>函数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>NoVolumeZoneConflictPred</td>
<td>NewVolumeZonePredicate</td>
<td>判断pod使用到的volume是否有节点的要求。目前只支持pvc。</td>
</tr>
<tr>
<td>MaxEBSVolumeCountPred</td>
<td>NewMaxPDVolumeCountPredicate</td>
<td>判断pod使用EBSVolume在该节点上是否已经达到上限了。</td>
</tr>
<tr>
<td>MaxGCEPDVolumeCountPred</td>
<td>NewMaxPDVolumeCountPredicate</td>
<td>判断pod使用GCEPDVolume在该节点上是否已经达到上限了。</td>
</tr>
<tr>
<td>MaxAzureDiskVolumeCountPred</td>
<td>NewMaxPDVolumeCountPredicate</td>
<td>判断pod使用AzureDiskVolume在该节点上是否已经达到上限了。</td>
</tr>
<tr>
<td>MaxCSIVolumeCountPred</td>
<td>NewCSIMaxVolumeLimitPredicate</td>
<td>判断CSIVolume是否达到上限了。</td>
</tr>
<tr>
<td>MatchInterPodAffinityPred</td>
<td>NewPodAffinityPredicate</td>
<td>匹配pod的亲缘性。</td>
</tr>
<tr>
<td>NoDiskConflictPred</td>
<td>NoDiskConflict</td>
<td>判断是否有disk volumes的冲突。</td>
</tr>
<tr>
<td>GeneralPred</td>
<td>GeneralPredicates</td>
<td>通用的预选策略</td>
</tr>
<tr>
<td>CheckNodeMemoryPressurePred</td>
<td>CheckNodeMemoryPressurePredicate</td>
<td>判断节点内存是否充足。</td>
</tr>
<tr>
<td>CheckNodeDiskPressurePred</td>
<td>CheckNodeDiskPressurePredicate</td>
<td>判断节点是否有磁盘压力。</td>
</tr>
<tr>
<td>CheckNodePIDPressurePred</td>
<td>CheckNodePIDPressurePredicate</td>
<td>判断节点上的PID</td>
</tr>
<tr>
<td>CheckNodeConditionPred</td>
<td>CheckNodeConditionPredicate</td>
<td>判断node是否ready。</td>
</tr>
<tr>
<td>PodToleratesNodeTaintsPred</td>
<td>PodToleratesNodeTaints</td>
<td>判断pod是否可以容忍节点的taints。</td>
</tr>
<tr>
<td>CheckVolumeBindingPred</td>
<td>NewVolumeBindingPredicate</td>
<td>判断是否有volume拓扑的要求。</td>
</tr>
</tbody>
</table>
<p>具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">defaultPredicates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewString</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by volume zone requirements.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NoVolumeZoneConflictPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewVolumeZonePredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVCInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageClassInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by whether or not there would be too many AWS EBS volumes attached to the node
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxEBSVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMaxPDVolumeCountPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EBSVolumeFilterType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVCInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by whether or not there would be too many GCE PD volumes attached to the node
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxGCEPDVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMaxPDVolumeCountPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GCEPDVolumeFilterType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVCInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by whether or not there would be too many Azure Disk volumes attached to the node
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxAzureDiskVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMaxPDVolumeCountPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AzureDiskVolumeFilterType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVCInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxCSIVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCSIMaxVolumeLimitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVCInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by inter-pod affinity.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MatchInterPodAffinityPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPodAffinityPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by non-conflicting disk volumes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NoDiskConflictPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NoDiskConflict</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// GeneralPredicates are the predicates that are enforced by all Kubernetes components
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// (e.g. kubelet and all schedulers)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GeneralPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GeneralPredicates</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by node memory pressure condition.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeMemoryPressurePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeMemoryPressurePredicate</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by node disk pressure condition.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeDiskPressurePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeDiskPressurePredicate</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by node pid pressure condition.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodePIDPressurePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodePIDPressurePredicate</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by node conditions: not ready, network unavailable or out of disk.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterMandatoryFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeConditionPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeConditionPredicate</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined based on whether a pod can tolerate all of the node&#39;s taints
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodToleratesNodeTaintsPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodToleratesNodeTaints</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by volume topology requirements.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckVolumeBindingPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewVolumeBindingPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumeBinder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-defaultpriorities">4. defaultPriorities</h1>
<p>此部分主要为默认优选策略的注册函数。</p>
<p>默认优选策略如下：</p>
<table>
<thead>
<tr>
<th>优选策略</th>
<th>函数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>SelectorSpreadPriority</td>
<td>NewSelectorSpreadPriority</td>
<td>属于相同service和rs下的pod尽量分布在不同的node上。</td>
</tr>
<tr>
<td>InterPodAffinityPriority</td>
<td>NewInterPodAffinityPriority</td>
<td>根据pod的亲缘性，将相同拓扑域中的pod放在同一个节点</td>
</tr>
<tr>
<td>LeastRequestedPriority</td>
<td>LeastRequestedPriorityMap</td>
<td>按最少请求的利用率对节点进行优先级排序。</td>
</tr>
<tr>
<td>BalancedResourceAllocation</td>
<td>BalancedResourceAllocationMap</td>
<td>实现资源的平衡使用。</td>
</tr>
<tr>
<td>NodePreferAvoidPodsPriority</td>
<td>CalculateNodePreferAvoidPodsPriorityMap</td>
<td>将此权重设置为足以覆盖所有其他优先级函数。</td>
</tr>
<tr>
<td>NodeAffinityPriority</td>
<td>CalculateNodeAffinityPriorityMap</td>
<td>pod指定label节点调度，来匹配node亲缘性。</td>
</tr>
<tr>
<td>TaintTolerationPriority</td>
<td>ComputeTaintTolerationPriorityMap</td>
<td>pod有设置tolerate属性来容忍node的taint。</td>
</tr>
<tr>
<td>ImageLocalityPriority</td>
<td>ImageLocalityPriorityMap</td>
<td>根据节点上是否有该pod使用到的镜像打分。</td>
</tr>
</tbody>
</table>
<p>具体代码实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">defaultPriorities</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewString</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// spreads pods by minimizing the number of pods (belonging to the same service or replication controller) on the same node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityConfigFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34;SelectorSpreadPriority&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfigFactory</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">MapReduceFunction</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityMapFunction</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityReduceFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSelectorSpreadPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatefulSetLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Weight</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// pods should be placed in the same topological domain (e.g. same node, same rack, same zone, same power domain, etc.)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// as some other pods, or, conversely, should not be placed in the same topological domain as some other pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityConfigFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34;InterPodAffinityPriority&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfigFactory</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Function</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityFunction</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInterPodAffinityPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HardPodAffinitySymmetricWeight</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Weight</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Prioritize nodes by least requested utilization.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;LeastRequestedPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeastRequestedPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Prioritizes nodes to help achieve balanced resource usage
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;BalancedResourceAllocation&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BalancedResourceAllocationMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Set this weight large enough to override all other priority functions.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// TODO: Figure out a better way to do this, maybe at same time as fixing #24720.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NodePreferAvoidPodsPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CalculateNodePreferAvoidPodsPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Prioritizes nodes that have labels matching NodeAffinity
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NodeAffinityPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CalculateNodeAffinityPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CalculateNodeAffinityPriorityReduce</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Prioritizes nodes that marked with taint which pod can tolerate.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;TaintTolerationPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComputeTaintTolerationPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComputeTaintTolerationPriorityReduce</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// ImageLocalityPriority prioritizes nodes that have images requested by the pod present.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ImageLocalityPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ImageLocalityPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithmprovider/defaults/defaults.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithmprovider/defaults/defaults.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1b30fb2a64678cfd3eec2198ed1461cc">4.4 - kube-scheduler源码分析（三）之 调度流程</h1>
    
	<h1 id="scheduleone">scheduleOne</h1>
<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析<code>/pkg/scheduler/</code>中调度的基本流程。具体的<code>预选调度逻辑</code>、<code>优选调度逻辑</code>、<code>节点抢占逻辑</code>待后续再独立分析。</p>
<p>scheduler的<code>pkg</code>代码目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>scheduler
</span></span><span style="display:flex;"><span>├── algorithm         <span style="color:#8f5902;font-style:italic"># 主要包含调度的算法</span>
</span></span><span style="display:flex;"><span>│   ├── predicates    <span style="color:#8f5902;font-style:italic"># 预选的策略</span>
</span></span><span style="display:flex;"><span>│   ├── priorities    <span style="color:#8f5902;font-style:italic"># 优选的策略</span>
</span></span><span style="display:flex;"><span>│   ├── scheduler_interface.go    <span style="color:#8f5902;font-style:italic"># ScheduleAlgorithm、SchedulerExtender接口定义</span>
</span></span><span style="display:flex;"><span>│   ├── types.go      <span style="color:#8f5902;font-style:italic"># 使用到的type的定义</span>
</span></span><span style="display:flex;"><span>├── algorithmprovider
</span></span><span style="display:flex;"><span>│   ├── defaults
</span></span><span style="display:flex;"><span>│   │   ├── defaults.go    <span style="color:#8f5902;font-style:italic"># 默认算法的初始化操作，包括预选和优选策略</span>
</span></span><span style="display:flex;"><span>├── cache      <span style="color:#8f5902;font-style:italic"># scheduler调度使用到的cache</span>
</span></span><span style="display:flex;"><span>│   ├── cache.go    <span style="color:#8f5902;font-style:italic"># schedulerCache</span>
</span></span><span style="display:flex;"><span>│   ├── interface.go
</span></span><span style="display:flex;"><span>│   ├── node_info.go
</span></span><span style="display:flex;"><span>│   ├── node_tree.go
</span></span><span style="display:flex;"><span>├── core       <span style="color:#8f5902;font-style:italic"># 调度逻辑的核心代码</span>
</span></span><span style="display:flex;"><span>│   ├── equivalence
</span></span><span style="display:flex;"><span>│   │   ├── eqivalence.go       <span style="color:#8f5902;font-style:italic"># 存储相同pod的调度结果缓存，主要给预选策略使用</span>
</span></span><span style="display:flex;"><span>│   ├── extender.go
</span></span><span style="display:flex;"><span>│   ├── generic_scheduler.go    <span style="color:#8f5902;font-style:italic"># genericScheduler,主要包含默认调度器的调度逻辑</span>
</span></span><span style="display:flex;"><span>│   ├── scheduling_queue.go     <span style="color:#8f5902;font-style:italic"># 调度使用到的队列，主要用来存储需要被调度的pod</span>
</span></span><span style="display:flex;"><span>├── factory
</span></span><span style="display:flex;"><span>│   ├── factory.go   <span style="color:#8f5902;font-style:italic"># 主要包括NewConfigFactory、NewPodInformer，监听pod事件来更新调度队列</span>
</span></span><span style="display:flex;"><span>├── metrics
</span></span><span style="display:flex;"><span>│   └── metrics.go   <span style="color:#8f5902;font-style:italic"># 主要给prometheus使用</span>
</span></span><span style="display:flex;"><span>├── scheduler.go <span style="color:#8f5902;font-style:italic"># pkg部分的Run入口(核心代码)，主要包含Run、scheduleOne、schedule、preempt等函数</span>
</span></span><span style="display:flex;"><span>└── volumebinder
</span></span><span style="display:flex;"><span>    └── volume_binder.go   <span style="color:#8f5902;font-style:italic"># volume bind</span>
</span></span></code></pre></div><h1 id="1-scheduler-run-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-scheduler-go-l181">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/scheduler.go#L181">Scheduler.Run</a></h1>
<blockquote>
<p>此部分代码位于pkg/scheduler/scheduler.go</p>
</blockquote>
<p>此处为具体调度逻辑的入口。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run begins watching and scheduling. It waits for cache to be synced, then starts a goroutine and returns immediately.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scheduleOne</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StopEverything</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-scheduler-scheduleone-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-scheduler-go-l395">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/scheduler.go#L395">Scheduler.scheduleOne</a></h1>
<blockquote>
<p>此部分代码位于pkg/scheduler/scheduler.go</p>
</blockquote>
<p><code>scheduleOne</code>主要为单个pod选择一个适合的节点，为调度逻辑的核心函数。</p>
<p><strong>对单个pod进行调度的基本流程如下：</strong></p>
<ol>
<li>通过podQueue的待调度队列中弹出需要调度的pod。</li>
<li>通过具体的调度算法为该pod选出合适的节点，其中调度算法就包括预选和优选两步策略。</li>
<li>如果上述调度失败，则会尝试抢占机制，将优先级低的pod剔除，让优先级高的pod调度成功。</li>
<li>将该pod和选定的节点进行假性绑定，存入scheduler cache中，方便具体绑定操作可以异步进行。</li>
<li>实际执行绑定操作，将node的名字添加到pod的节点相关属性中。</li>
</ol>
<p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// scheduleOne does the entire scheduling workflow for a single pod.  It is serialized on the scheduling algorithm&#39;s host fitting.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">scheduleOne</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NextPod</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedScheduling&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;skip schedule deleting pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Skip schedule deleting pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Attempting to schedule pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Synchronously attempt to find a fit for the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// schedule() may have failed because the pod would not fit on any host, so we try to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// preempt, with the expectation that the next time the pod is tried for scheduling it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// will fit due to the preemption. It is also possible that a different pod will schedule
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// into the resources that were preempted, but this is harmless.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">preemptionStartTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionAttempts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Inc</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPremptionEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Tell the cache to assume that a pod now is running on a given node, even though it hasn&#39;t been bound yet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This allows us to keep scheduling without waiting on binding to occur.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">assumedPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Assume volumes first before assuming the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If all volumes are completely bound, then allBound is true and binding will be skipped.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Otherwise, binding of volumes is started after the pod is assumed, but before pod binding.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This function modifies &#39;assumedPod&#39; if volume binding is required.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">allBound</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">assumeVolumes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// assume modifies `assumedPod` by setting NodeName=suggestedHost
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">assume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// bind the pod to its host asynchronously (we can do this b/c of the assumption step above).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Bind volumes first before Pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">allBound</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bindVolumes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Binding</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UID</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Target</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectReference</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Node&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">E2eSchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Internal error binding pod: (%v)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下对重要代码分别进行分析。</p>
<h1 id="3-config-nextpod">3. config.NextPod</h1>
<p>通过<code>podQueue</code>的方式存储待调度的pod队列，<code>NextPod</code>拿出下一个需要被调度的pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NextPod</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedScheduling&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;skip schedule deleting pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Skip schedule deleting pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Attempting to schedule pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>NextPod</code>的具体函数在factory.go的CreateFromKey函数中定义，如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">configFactory</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">CreateFromKeys</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateKeys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityKeys</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">extenders</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerExtender</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">scheduler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">scheduler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">NextPod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getNextPod</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>      
</span></span></code></pre></div><h2 id="3-1-getnextpod">3.1. getNextPod</h2>
<p>通过一个podQueue来存储需要调度的pod的队列，通过队列Pop的方式弹出需要被调度的pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">configFactory</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">getNextPod</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;About to try and schedule pod %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error while retrieving next pod from scheduling queue: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-scheduler-schedule">4. Scheduler.schedule</h1>
<blockquote>
<p>此部分代码位于pkg/scheduler/scheduler.go</p>
</blockquote>
<p>此部分为调度逻辑的核心，通过不同的算法为具体的pod选择一个最合适的节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Synchronously attempt to find a fit for the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// schedule() may have failed because the pod would not fit on any host, so we try to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// preempt, with the expectation that the next time the pod is tried for scheduling it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// will fit due to the preemption. It is also possible that a different pod will schedule
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// into the resources that were preempted, but this is harmless.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">preemptionStartTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionAttempts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Inc</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPremptionEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>schedule</code>通过调度算法返回一个最优的节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// schedule implements the scheduling algorithm and returns the suggested host.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pod</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedScheduling&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConditionUpdater</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodCondition</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodScheduled</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Status</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionFalse</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Reason</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodReasonUnschedulable</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Message</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-1-schedulealgorithm">4.1. ScheduleAlgorithm</h2>
<p><code>ScheduleAlgorithm</code>是一个调度算法的接口，主要的实现体是<code>genericScheduler</code>，后续分析<code>genericScheduler.Schedule</code>。</p>
<p><code>ScheduleAlgorithm</code>接口定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ScheduleAlgorithm is an interface implemented by things that know how to schedule pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// onto machines.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ScheduleAlgorithm</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">selectedMachine</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Preempt receives scheduling errors for a pod and tries to create room for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the pod by preempting lower priority pods if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// It returns the node where preemption happened, a list of preempted pods, a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// list of pods whose nominated node name should be removed, and error if any.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">selectedNode</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptedPods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cleanupNominatedPods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Predicates() returns a pointer to a map of predicate functions. This is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// exposed for testing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Predicates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">FitPredicate</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Prioritizers returns a slice of priority config. This is exposed for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// testing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Prioritizers</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">PriorityConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-genericscheduler-schedule-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-core-generic-scheduler-go-l117">5. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go#L117">genericScheduler.Schedule</a></h1>
<blockquote>
<p>此部分代码位于/pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<p><code>genericScheduler.Schedule</code>实现了基本的调度逻辑，基于给定需要调度的pod和node列表，如果执行成功返回调度的节点的名字，如果执行失败，则返回错误和原因。主要通过预选和优选两步操作完成调度的逻辑。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>对pod做基本性检查，目前主要是对pvc的检查。</li>
<li>通过<code>findNodesThatFit</code>预选策略选出满足调度条件的node列表。</li>
<li>通过<code>PrioritizeNodes</code>优选策略给预选的node列表中的node进行打分。</li>
<li>在打分的node列表中选择一个分数最高的node作为调度的节点。</li>
</ol>
<p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Schedule tries to schedule the given pod to one of the nodes in the node list.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If it succeeds, it will return the name of the node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If it fails, it will return a FitError error with reasons.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utiltrace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Scheduling %s/%s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogIfLong</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podPassesBasicChecks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pvcLister</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ErrNoNodesAvailable</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Used for all fit and priority funcs.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateNodeNameToInfoMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Computing predicates&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startPredicateEvalTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findNodesThatFit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">NumAllNodes</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">FailedPredicates</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPredicateEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPredicateEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPredicateEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Prioritizing&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startPriorityEvalTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// When only one node after predicate, just use it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPriorityEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metaPrioritiesInterface</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">priorityMetaProducer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">PrioritizeNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaPrioritiesInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prioritizers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPriorityEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Selecting host&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">selectHost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-1-podpassesbasicchecks">5.1. podPassesBasicChecks</h2>
<p>podPassesBasicChecks主要做一下基本性检查，目前主要是对pvc的检查。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podPassesBasicChecks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pvcLister</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>podPassesBasicChecks具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// podPassesBasicChecks makes sanity checks on the pod if it can be scheduled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">podPassesBasicChecks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvcLister</span> <span style="color:#000">corelisters</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaimLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Check PVCs used by the pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">namespace</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">manifest</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">manifest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volumes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">manifest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volumes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaim</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Volume is not a PVC, ignore
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pvcName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaim</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClaimName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pvc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pvcLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaims</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pvcName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// The error has already enough context (&#34;persistentvolumeclaim &#34;myclaim&#34; not found&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pvc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;persistentvolumeclaim %q is being deleted&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-2-findnodesthatfit">5.2. findNodesThatFit</h2>
<p>预选，通过预选函数来判断每个节点是否适合被该Pod调度。</p>
<blockquote>
<p>具体的<code>findNodesThatFit</code>代码实现细节待后续文章独立分析。</p>
</blockquote>
<p><code>genericScheduler.Schedule</code>中对<code>findNodesThatFit</code>的调用过程如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Computing predicates&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">startPredicateEvalTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findNodesThatFit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">NumAllNodes</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">FailedPredicates</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPredicateEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPredicateEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPredicateEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h2 id="5-3-prioritizenodes">5.3. PrioritizeNodes</h2>
<p>优选，从满足的节点中选择出最优的节点。</p>
<p>具体操作如下：</p>
<ul>
<li>PrioritizeNodes通过并行运行各个优先级函数来对节点进行优先级排序。</li>
<li>每个优先级函数会给节点打分，打分范围为0-10分。</li>
<li>0 表示优先级最低的节点，10表示优先级最高的节点。</li>
<li>每个优先级函数也有各自的权重。</li>
<li>优先级函数返回的节点分数乘以权重以获得加权分数。</li>
<li>最后组合（添加）所有分数以获得所有节点的总加权分数。</li>
</ul>
<blockquote>
<p>具体<code>PrioritizeNodes</code>的实现逻辑待后续文章独立分析。</p>
</blockquote>
<p><code>genericScheduler.Schedule</code>中对<code>PrioritizeNodes</code>的调用过程如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Prioritizing&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">startPriorityEvalTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// When only one node after predicate, just use it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPriorityEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">metaPrioritiesInterface</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">priorityMetaProducer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">PrioritizeNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaPrioritiesInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prioritizers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPriorityEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h2 id="5-4-selecthost">5.4. selectHost</h2>
<p><code>scheduler</code>在最后会从<code>priorityList</code>中选择分数最高的一个节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Selecting host&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">selectHost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>selectHost</code>获取优先级的节点列表，然后从分数最高的节点以循环方式选择一个节点。</p>
<p>具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// selectHost takes a prioritized list of nodes and then picks one
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// in a round-robin manner from the nodes that had the highest score.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">selectHost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;empty priorityList&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxScores</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">findMaxScores</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ix</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastNodeIndex</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#204a87">uint64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxScores</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastNodeIndex</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">maxScores</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ix</span><span style="color:#000;font-weight:bold">]].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-4-1-findmaxscores">5.4.1. findMaxScores</h3>
<p><code>findMaxScores</code>返回<code>priorityList</code>中具有最高<code>Score</code>的节点的索引。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// findMaxScores returns the indexes of nodes in the &#34;priorityList&#34; that has the highest &#34;Score&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">findMaxScores</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxScoreIndexes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxScore</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hp</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityList</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">hp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Score</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">maxScore</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">maxScore</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">hp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">maxScoreIndexes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">maxScoreIndexes</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">maxScoreIndexes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxScoreIndexes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">hp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">maxScore</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">maxScoreIndexes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxScoreIndexes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">maxScoreIndexes</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="6-scheduler-preempt">6. Scheduler.preempt</h1>
<p>如果pod在预选和优选调度中失败，则执行抢占操作。抢占主要是将低优先级的pod的资源空间腾出给待调度的高优先级的pod。</p>
<blockquote>
<p>具体<code>Scheduler.preempt</code>的实现逻辑待后续文章独立分析。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// schedule() may have failed because the pod would not fit on any host, so we try to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// preempt, with the expectation that the next time the pod is tried for scheduling it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// will fit due to the preemption. It is also possible that a different pod will schedule
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// into the resources that were preempted, but this is harmless.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">preemptionStartTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionAttempts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Inc</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPremptionEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="7-scheduler-assume">7. Scheduler.assume</h1>
<p>将该pod和选定的节点进行假性绑定，存入scheduler cache中，方便可以继续执行调度逻辑，而不需要等待绑定操作的发生，具体绑定操作可以异步进行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Tell the cache to assume that a pod now is running on a given node, even though it hasn&#39;t been bound yet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This allows us to keep scheduling without waiting on binding to occur.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">assumedPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Assume volumes first before assuming the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If all volumes are completely bound, then allBound is true and binding will be skipped.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Otherwise, binding of volumes is started after the pod is assumed, but before pod binding.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This function modifies &#39;assumedPod&#39; if volume binding is required.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">allBound</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">assumeVolumes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// assume modifies `assumedPod` by setting NodeName=suggestedHost
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">assume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果假性绑定成功则发送请求给apiserver，如果失败则scheduler会立即释放已分配给假性绑定的pod的资源。</p>
<p>assume方法的具体实现：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// assume signals to the cache that a pod is already in the cache, so that binding can be asynchronous.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// assume modifies `assumed`.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">assume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Optimistically assume that the binding will succeed and send it to apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// in the background.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If the binding fails, scheduler will release resources allocated to assumed pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// immediately.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">host</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// NOTE: Because the scheduler uses snapshots of SchedulerCache and the live
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// version of Ecache, updates must be written to SchedulerCache before
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// invalidating Ecache.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AssumePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scheduler cache AssumePod failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// This is most probably result of a BUG in retrying logic.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// We report an error here so that pod scheduling can be retried.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// This relies on the fact that Error will check if the pod has been bound
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// to a node and if so will not add it back to the unscheduled pods queue
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// (otherwise this would cause an infinite loop).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedScheduling&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;AssumePod failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConditionUpdater</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodCondition</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodScheduled</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Status</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionFalse</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Reason</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;SchedulerError&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Message</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Optimistically assume that the binding will succeed, so we need to invalidate affected
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// predicates in equivalence cache.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If the binding fails, these invalidated item will not break anything.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ecache</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ecache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InvalidateCachedPredicateItemForPodAdd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="8-scheduler-bind">8. Scheduler.bind</h1>
<p>异步的方式给pod绑定到具体的调度节点上。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// bind the pod to its host asynchronously (we can do this b/c of the assumption step above).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Bind volumes first before Pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">allBound</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bindVolumes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Binding</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UID</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Target</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectReference</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Node&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">E2eSchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Internal error binding pod: (%v)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}()</span>
</span></span></code></pre></div><p>bind具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// bind binds a pod to a given node defined in a binding object.  We expect this to run asynchronously, so we
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// handle binding metrics internally.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Binding</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">bindingStart</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If binding succeeded then PodScheduled condition will be updated in apiserver so that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// it&#39;s atomic with setting host.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetBinder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FinishBinding</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scheduler cache FinishBinding failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to bind pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ForgetPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scheduler cache ForgetPod failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedScheduling&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Binding rejected: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConditionUpdater</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodCondition</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodScheduled</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Status</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionFalse</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Reason</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;BindingRejected&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BindingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bindingStart</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Binding</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bindingStart</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Scheduled&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Successfully assigned %v/%v to %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Target</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="9-总结">9. 总结</h1>
<p>本文主要分析了单个pod的调度过程。具体流程如下：</p>
<ol>
<li>通过podQueue的待调度队列中弹出需要调度的pod。</li>
<li>通过具体的调度算法为该pod选出合适的节点，其中调度算法就包括预选和优选两步策略。</li>
<li>如果上述调度失败，则会尝试抢占机制，将优先级低的pod剔除，让优先级高的pod调度成功。</li>
<li>将该pod和选定的节点进行假性绑定，存入scheduler cache中，方便具体绑定操作可以异步进行。</li>
<li>实际执行绑定操作，将node的名字添加到pod的节点相关属性中。</li>
</ol>
<p>其中核心的部分为通过具体的调度算法选出调度节点的过程，即<code>genericScheduler.Schedule</code>的实现部分。该部分包括预选和优选两个部分。</p>
<p><code>genericScheduler.Schedule</code>调度的基本流程如下：</p>
<ol>
<li>对pod做基本性检查，目前主要是对pvc的检查。</li>
<li>通过<code>findNodesThatFit</code>预选策略选出满足调度条件的node列表。</li>
<li>通过<code>PrioritizeNodes</code>优选策略给预选的node列表中的node进行打分。</li>
<li>在打分的node列表中选择一个分数最高的node作为调度的节点。</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/scheduler.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ea2ce71fd47cea6adf169e5d35e56977">4.5 - kube-scheduler源码分析（四）之 预选策略</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析调度逻辑中的预选策略，即第一步筛选出符合pod调度条件的节点。</p>
<h1 id="1-调用入口-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-core-generic-scheduler-go-l117">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go#L117">调用入口</a></h1>
<p>预选，通过预选函数来判断每个节点是否适合被该Pod调度。</p>
<p><code>genericScheduler.Schedule</code>中对<code>findNodesThatFit</code>的调用过程如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 列出所有的节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ErrNoNodesAvailable</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Used for all fit and priority funcs.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateNodeNameToInfoMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Computing predicates&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startPredicateEvalTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 调用findNodesThatFit过滤出预选节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findNodesThatFit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">NumAllNodes</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">FailedPredicates</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// metrics
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPredicateEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPredicateEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			  <span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPredicateEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 调用findNodesThatFit过滤出预选节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findNodesThatFit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="2-findnodesthatfit-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-core-generic-scheduler-go-l365">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go#L365">findNodesThatFit</a></h1>
<p><code>findNodesThatFit</code>基于给定的预选函数过滤node，每个node传入到预选函数中来确实该节点是否符合要求。</p>
<p><code>findNodesThatFit</code>的入参是被调度的pod和当前的节点列表，返回预选节点列表和错误。</p>
<p><code>findNodesThatFit</code>基本流程如下：</p>
<ol>
<li>设置可行节点的总数，作为预选节点数组的容量，避免总节点过多需要筛选的节点过多。</li>
<li>通过<code>NodeTree</code>不断获取下一个节点来判断该节点是否满足pod的调度条件。</li>
<li>通过之前注册的各种预选函数来判断当前节点是否符合pod的调度条件。</li>
<li>最后返回满足调度条件的node列表，供下一步的优选操作。</li>
</ol>
<p><code>findNodesThatFit</code>完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Filters the nodes to find the ones that fit based on the given predicate functions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Each node is passed through the predicate functions to determine if it is a fit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">findNodesThatFit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">FailedPredicateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">filtered</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">failedPredicateMap</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">FailedPredicateMap</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">filtered</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">nodes</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">allNodes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeTree</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">NumNodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">numNodesToFind</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">numFeasibleNodesToFind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// Create filtered list with enough space to avoid growing it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// and allow assigning.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">filtered</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">numNodesToFind</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">errs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MessageCountMap</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">predicateResultLock</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">filteredLen</span>         <span style="color:#204a87;font-weight:bold">int32</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">equivClass</span>          <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">equivalence</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Class</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithCancel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// We can use the same metadata producer for all nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">meta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicateMetaProducer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equivalenceCache</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#8f5902;font-style:italic">// getEquivalenceClassInfo will return immediately if no equivalence pod found
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>         <span style="color:#000">equivClass</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">equivalence</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">checkNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">nodeCache</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">equivalence</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeCache</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">nodeName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeTree</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Next</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equivalenceCache</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">nodeCache</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equivalenceCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNodeCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">fits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podFitsOnNode</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">nodeCache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">alwaysCheckAllPredicates</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">equivClass</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">errs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">()]</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fits</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">filteredLen</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">length</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">numNodesToFind</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">filteredLen</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">length</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">failedPredicates</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// Stops searching for more nodes once the configured number of feasible nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// are found.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParallelizeUntil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">checkNode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">filtered</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#000">filteredLen</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">FailedPredicateMap</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateAggregateFromMessageCountMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">extender</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsInterested</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">filteredList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsIgnorable</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Skipping extender %v as it returned error %v and has ignorable flag set&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">FailedPredicateMap</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">failedNodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedMsg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">failedMap</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">found</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">failedNodeName</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">found</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">failedNodeName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">failedNodeName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">failedNodeName</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewFailureReason</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedMsg</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">filtered</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">filteredList</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下对<code>findNodesThatFit</code>分段分析。</p>
<h1 id="3-numfeasiblenodestofind">3. numFeasibleNodesToFind</h1>
<p><code>findNodesThatFit</code>先基于所有的节点找出可行的节点是总数。<code>numFeasibleNodesToFind</code>的作用主要是避免当节点过多（超过100）影响调度的效率。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">allNodes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeTree</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">NumNodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">numNodesToFind</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">numFeasibleNodesToFind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create filtered list with enough space to avoid growing it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and allow assigning.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">filtered</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">numNodesToFind</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>numFeasibleNodesToFind</code>基本流程如下：</p>
<ul>
<li>如果所有的node节点小于<code>minFeasibleNodesToFind</code>(当前默认为100)则返回节点数。</li>
<li>如果节点数超100，则取指定计分的百分比的节点数，当该百分比后的数目仍小于<code>minFeasibleNodesToFind</code>，则返回<code>minFeasibleNodesToFind</code>。</li>
<li>如果百分比后的数目大于<code>minFeasibleNodesToFind</code>，则返回该百分比。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// numFeasibleNodesToFind returns the number of feasible nodes that once found, the scheduler stops
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// its search for more feasible nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">numFeasibleNodesToFind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">numAllNodes</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">numAllNodes</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minFeasibleNodesToFind</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">percentageOfNodesToScore</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">||</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">percentageOfNodesToScore</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">numAllNodes</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">numNodes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">numAllNodes</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">percentageOfNodesToScore</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">numNodes</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minFeasibleNodesToFind</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">minFeasibleNodesToFind</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">numNodes</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-checknode">4. checkNode</h1>
<p><code>checkNode</code>是一个校验node是否符合要求的函数，其中实际调用到的核心函数是<code>podFitsOnNode</code>。再通过<code>workqueue</code>并发执行<code>checkNode</code>操作。</p>
<p><strong><code>checkNode</code>主要流程如下：</strong></p>
<ol>
<li>通过cache中的nodeTree不断获取下一个node。</li>
<li>将当前node和pod传入<code>podFitsOnNode</code>判断当前node是否符合要求。</li>
<li>如果当前node符合要求就将当前node加入预选节点的数组中<code>filtered</code>。</li>
<li>如果当前node不满足要求，则加入到失败的数组中，并记录原因。</li>
<li>通过<code>workqueue.ParallelizeUntil</code>并发执行<code>checkNode</code>函数，一旦找到配置的可行节点数，就停止搜索更多节点。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">checkNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">nodeCache</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">equivalence</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeCache</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeTree</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Next</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equivalenceCache</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeCache</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equivalenceCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNodeCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podFitsOnNode</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeCache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">alwaysCheckAllPredicates</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">equivClass</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">errs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">()]</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fits</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">filteredLen</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">length</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">numNodesToFind</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">filteredLen</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">length</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">failedPredicates</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>workqueue的并发操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Stops searching for more nodes once the configured number of feasible nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// are found.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParallelizeUntil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">checkNode</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>ParallelizeUntil</code>具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ParallelizeUntil is a framework that allows for parallelizing N
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// independent pieces of work until done or the context is canceled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ParallelizeUntil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">workers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pieces</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">doWorkPiece</span> <span style="color:#000">DoWorkPieceFunc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">stop</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">toProcess</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pieces</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">pieces</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">toProcess</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">i</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">toProcess</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pieces</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">workers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">workers</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pieces</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">workers</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">workers</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">piece</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">toProcess</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stop</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">doWorkPiece</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">piece</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-podfitsonnode">5. podFitsOnNode</h1>
<p><code>podFitsOnNode</code>主要内容如下：</p>
<ul>
<li>
<p><code>podFitsOnNode</code>会检查给定的某个Node是否满足预选的函数。</p>
</li>
<li>
<p>对于给定的pod，<code>podFitsOnNode</code>会检查是否有相同的pod存在，尽量复用缓存过的预选结果。</p>
</li>
</ul>
<p><code>podFitsOnNode</code>主要在<code>Schedule</code>（调度）和<code>Preempt</code>（抢占）的时候被调用。</p>
<p>当在<code>Schedule</code>中被调用的时候，主要判断是否可以被调度到当前节点，依据为当前节点上所有已存在的pod及被提名要运行到该节点的具有相等或更高优先级的pod。</p>
<p>当在<code>Preempt</code>中被调用的时候，即发生抢占的时候，通过<code>SelectVictimsOnNode</code>函数选出需要被移除的pod，移除后然后将预调度的pod调度到该节点上。</p>
<p><strong>podFitsOnNode基本流程如下：</strong></p>
<ol>
<li>遍历之前注册好的预选策略<code>predicates.Ordering</code>，并获取预选策略的执行函数。</li>
<li>遍历执行每个预选函数，并返回是否合适，预选失败的原因和错误。</li>
<li>如果预选函数执行的结果不合适，则加入预选失败的数组中。</li>
<li>最后返回预选失败的个数是否为0，和预选失败的原因。</li>
</ol>
<p><strong>入参：</strong></p>
<ul>
<li>pod</li>
<li>PredicateMetadata</li>
<li>NodeInfo</li>
<li>predicateFuncs</li>
<li>schedulercache.Cache</li>
<li>nodeCache</li>
<li>SchedulingQueue</li>
<li>alwaysCheckAllPredicates</li>
<li>equivClass</li>
</ul>
<p><strong>出参：</strong></p>
<ul>
<li>fit</li>
<li>PredicateFailureReason</li>
</ul>
<p>完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// podFitsOnNode checks whether a node given by NodeInfo satisfies the given predicate functions.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// For given pod, podFitsOnNode will check if any equivalent pod exists and try to reuse its cached
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// predicate results as possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This function is called from two different places: Schedule and Preempt.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// When it is called from Schedule, we want to test whether the pod is schedulable
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// on the node with all the existing pods on the node plus higher and equal priority
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pods nominated to run on the node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// When it is called from Preempt, we should remove the victims of preemption and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// add the nominated pods. Removal of the victims is done by SelectVictimsOnNode().
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It removes victims from meta and NodeInfo before calling this function.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">podFitsOnNode</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">meta</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadata</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">info</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicateFuncs</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cache</span> <span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeCache</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">equivalence</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeCache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">queue</span> <span style="color:#000">SchedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">alwaysCheckAllPredicates</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">equivClass</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">equivalence</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Class</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">eCacheAvailable</span>  <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">failedPredicates</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podsAdded</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We run predicates twice in some cases. If the node has greater or equal priority
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// nominated pods, we run them when those pods are added to meta and nodeInfo.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If all predicates succeed in this pass, we run them again when these
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// nominated pods are not added. This second pass is necessary because some
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// predicates such as inter-pod affinity may not pass without the nominated pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If there are no nominated pods for the node or if the first run of the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// predicates fail, we don&#39;t run the second pass.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// We consider only equal or higher priority pods in the first pass, because
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// those are the current &#34;pod&#34; must yield to them and not take a space opened
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// for running them. It is ok if the current &#34;pod&#34; take resources freed for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// lower priority pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Requiring that the new pod is schedulable in both circumstances ensures that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// we are making a conservative decision: predicates like resources and inter-pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// anti-affinity are more likely to fail when the nominated pods are treated
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// as running, while predicates like pod affinity are more likely to fail when
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the nominated pods are treated as not running. We can&#39;t just assume the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// nominated pods are running because they are not running right now and in fact,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// they may end up getting scheduled to a different node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metaToUse</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">meta</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeInfoToUse</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">info</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">podsAdded</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoToUse</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">addNominatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">info</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">podsAdded</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedPredicates</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Bypass eCache if node has any nominated pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// TODO(bsalamat): consider using eCache and adding proper eCache invalidations
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// when pods are nominated or their nominations change.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">eCacheAvailable</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">equivClass</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">nodeCache</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">podsAdded</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateKey</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ordering</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fit</span>     <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">reasons</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">err</span>     <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">//TODO (yastij) : compute average predicate restrictiveness to export it as Prometheus metric
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exist</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">predicateFuncs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">predicateKey</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">exist</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">eCacheAvailable</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">fit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reasons</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">nodeCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">equivClass</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">fit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reasons</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoToUse</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">fit</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#8f5902;font-style:italic">// eCache is available and valid, and predicates result is unfit, record the fail reasons
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>					<span style="color:#000">failedPredicates</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedPredicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reasons</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#8f5902;font-style:italic">// if alwaysCheckAllPredicates is false, short circuit all predicates when one predicate fails.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>					<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">alwaysCheckAllPredicates</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infoln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;since alwaysCheckAllPredicates has not been set, the predicate &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>							<span style="color:#4e9a06">&#34;evaluation is short circuited and there are chances &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>							<span style="color:#4e9a06">&#34;of other predicates failing as well.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedPredicates</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-1-predicatefuncs">5.1. predicateFuncs</h2>
<p>根据之前初注册好的预选策略函数来执行预选，判断节点是否符合调度。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateKey</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ordering</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exist</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">predicateFuncs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">predicateKey</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">exist</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">eCacheAvailable</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reasons</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">nodeCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">equivClass</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reasons</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoToUse</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>预选策略如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicatesOrdering</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">CheckNodeConditionPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CheckNodeUnschedulablePred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">GeneralPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HostNamePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PodFitsHostPortsPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MatchNodeSelectorPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PodFitsResourcesPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NoDiskConflictPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">PodToleratesNodeTaintsPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PodToleratesNodeNoExecuteTaintsPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CheckNodeLabelPresencePred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">CheckServiceAffinityPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxEBSVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxGCEPDVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxCSIVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MaxAzureDiskVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CheckVolumeBindingPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NoVolumeZoneConflictPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">CheckNodeMemoryPressurePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CheckNodePIDPressurePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CheckNodeDiskPressurePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MatchInterPodAffinityPred</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="6-podfitsresources">6. PodFitsResources</h1>
<p>以下以<code>PodFitsResources</code>这个预选函数为例做分析，其他重要的预选函数待后续单独分析。</p>
<p><code>PodFitsResources</code>用来检查一个节点是否有足够的资源来运行当前的pod，包括CPU、内存、GPU等。</p>
<p><strong>PodFitsResources基本流程如下：</strong></p>
<ol>
<li>判断当前节点上pod总数加上预调度pod个数是否大于node的可分配pod总数，若是则不允许调度。</li>
<li>判断pod的request值是否都为0，若是则允许调度。</li>
<li>判断pod的request值加上当前node上所有pod的request值总和是否大于node的可分配资源，若是则不允许调度。</li>
<li>判断pod的拓展资源request值加上当前node上所有pod对应的request值总和是否大于node对应的可分配资源，若是则不允许调度。</li>
</ol>
<p><code>PodFitsResources</code>的注册代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsResourcesPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsResources</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>PodFitsResources入参：</strong></p>
<ul>
<li>
<p>pod</p>
</li>
<li>
<p>nodeInfo</p>
</li>
<li>
<p>PredicateMetadata</p>
</li>
</ul>
<p><strong>PodFitsResources出参：</strong></p>
<ul>
<li>fit</li>
<li>PredicateFailureReason</li>
</ul>
<p>PodFitsResources完整代码：</p>
<blockquote>
<p>此部分的代码位于pkg/scheduler/algorithm/predicates/predicates.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodFitsResources checks if a node has sufficient resources, such as cpu, memory, gpu, opaque int resources etc to run a pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// First return value indicates whether a node has sufficient resources to run a pod while the second return value indicates the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// predicate failure reasons if the node has insufficient resources to run the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">PodFitsResources</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;node not found&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">allowedPodNumber</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllowedPodNumber</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">())</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">allowedPodNumber</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourcePods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">())),</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allowedPodNumber</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// No extended resources should be ignored by default.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ignoredExtendedResources</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">podRequest</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Resource</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">predicateMeta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">predicateMetadata</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podRequest</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">predicateMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podRequest</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">predicateMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ignoredExtendedResources</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ignoredExtendedResources</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">predicateMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ignoredExtendedResources</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// We couldn&#39;t parse metadata - fallback to computing it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">podRequest</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">GetResourceRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">allocatable</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllocatableResource</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">MilliCPU</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceCPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">MilliCPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Memory</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceMemory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">EphemeralStorage</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEphemeralStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">EphemeralStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">rName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rQuant</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v1helper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsExtendedResourceName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// If this resource is one of the extended resources that should be
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// ignored, we will skip checking it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ignoredExtendedResources</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Has</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">rQuant</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">]))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// We explicitly don&#39;t do glog.V(10).Infof() to avoid computing all the parameters if this is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// not logged. There is visible performance gain from it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Schedule Pod %+v on Node %+v is allowed, Node is running only %v out of %v Pods.&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">podName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">allowedPodNumber</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-1-nodeinfo">6.1. NodeInfo</h2>
<p><code>NodeInfo</code>是node的聚合信息，主要包括：</p>
<ul>
<li>node：k8s node的结构体</li>
<li>pods：当前node上pod的数量</li>
<li>requestedResource：当前node上所有pod的request总和</li>
<li>allocatableResource：node的实际所有的可分配资源(对应于Node.Status.Allocatable.*)，可理解为node的资源总量。</li>
</ul>
<blockquote>
<p>此部分代码位于pkg/scheduler/cache/node_info.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NodeInfo is node level aggregated information.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">NodeInfo</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Overall node information.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pods</span>             <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podsWithAffinity</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">usedPorts</span>        <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPortInfo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Total requested resource of all pods on this node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// It includes assumed pods which scheduler sends binding to apiserver but
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// didn&#39;t get it as scheduled yet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">requestedResource</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Resource</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nonzeroRequest</span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Resource</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We store allocatedResources (which is Node.Status.Allocatable.*) explicitly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// as int64, to avoid conversions and accessing map.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">allocatableResource</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Resource</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Cached taints of the node for faster lookup.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">taints</span>    <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Taint</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">taintsErr</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// imageStates holds the entry of an image if and only if this image is on the node. The entry can be used for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// checking an image&#39;s existence and advanced usage (e.g., image locality scheduling policy) based on the image
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// state information.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">imageStates</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ImageStateSummary</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TransientInfo holds the information pertaining to a scheduling cycle. This will be destructed at the end of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// scheduling cycle.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// TODO: @ravig. Remove this once we have a clear approach for message passing across predicates and priorities.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">TransientInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">transientSchedulerInfo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Cached conditions of node for faster lookup.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">memoryPressureCondition</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionStatus</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">diskPressureCondition</span>   <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionStatus</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pidPressureCondition</span>    <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionStatus</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Whenever NodeInfo changes, generation is bumped.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This is used to avoid cloning it if the object didn&#39;t change.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">generation</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-2-resource">6.2. Resource</h2>
<p><code>Resource</code>是可计算资源的集合体。主要包括：</p>
<ul>
<li>MilliCPU</li>
<li>Memory</li>
<li>EphemeralStorage</li>
<li>AllowedPodNumber：允许的pod总数(对应于Node.Status.Allocatable.Pods().Value())，一般为110。</li>
<li>ScalarResources</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Resource is a collection of compute resource.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Resource</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MilliCPU</span>         <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Memory</span>           <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">EphemeralStorage</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We store allowedPodNumber (which is Node.Status.Allocatable.Pods().Value())
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// explicitly as int, to avoid conversions and improve performance.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">AllowedPodNumber</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// ScalarResources
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ScalarResources</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceName</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<p>以下分析podFitsOnNode的具体流程。</p>
<h2 id="6-3-allowedpodnumber">6.3. allowedPodNumber</h2>
<p>首先获取节点的信息，先判断如果该节点当前所有的pod的个数加上当前预调度的pod是否会大于该节点允许的pod的总数，一般为110个。如果超过，则<code>predicateFails</code>数组增加1，即当前节点不适合该pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;node not found&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span>
</span></span><span style="display:flex;"><span><span style="color:#000">allowedPodNumber</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllowedPodNumber</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">())</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">allowedPodNumber</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourcePods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">())),</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allowedPodNumber</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-4-podrequest">6.4. podRequest</h2>
<p>如果podRequest都为0，则允许调度到该节点，直接返回结果。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-5-allocatableresource">6.5. AllocatableResource</h2>
<p>如果当前预调度的pod的request资源加上当前node上所有pod的request总和大于该node的可分配资源总量，则不允许调度到该节点，直接返回结果。其中request资源包括CPU、内存、storage。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">allocatable</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllocatableResource</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">MilliCPU</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceCPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">MilliCPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Memory</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceMemory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">EphemeralStorage</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEphemeralStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">EphemeralStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-6-scalarresources">6.6. ScalarResources</h2>
<p>判断其他拓展的标量资源，是否该pod的request值加上当前node上所有pod的对应资源的request总和大于该node上对应资源的可分配总量，如果是，则不允许调度到该节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">rName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rQuant</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v1helper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsExtendedResourceName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// If this resource is one of the extended resources that should be
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// ignored, we will skip checking it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ignoredExtendedResources</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Has</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">rQuant</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">]))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="7-总结">7. 总结</h1>
<p><code>findNodesThatFit</code>基于给定的预选函数过滤node，每个node传入到预选函数中来确实该节点是否符合要求。</p>
<p><code>findNodesThatFit</code>的入参是被调度的pod和当前的节点列表，返回预选节点列表和错误。</p>
<p><strong><code>findNodesThatFit</code>基本流程如下：</strong></p>
<ol>
<li>设置可行节点的总数，作为预选节点数组的容量，避免总节点过多导致需要筛选的节点过多，效率低。</li>
<li>通过<code>NodeTree</code>不断获取下一个节点来判断该节点是否满足pod的调度条件。</li>
<li>通过之前注册的各种预选函数来判断当前节点是否符合pod的调度条件。</li>
<li>最后返回满足调度条件的node列表，供下一步的优选操作。</li>
</ol>
<h2 id="7-1-checknode">7.1. checkNode</h2>
<p><code>checkNode</code>是一个校验node是否符合要求的函数，其中实际调用到的核心函数是<code>podFitsOnNode</code>。再通过<code>workqueue</code>并发执行<code>checkNode</code>操作。</p>
<p><strong><code>checkNode</code>主要流程如下：</strong></p>
<ol>
<li>通过cache中的nodeTree不断获取下一个node。</li>
<li>将当前node和pod传入<code>podFitsOnNode</code>判断当前node是否符合要求。</li>
<li>如果当前node符合要求就将当前node加入预选节点的数组中<code>filtered</code>。</li>
<li>如果当前node不满足要求，则加入到失败的数组中，并记录原因。</li>
<li>通过<code>workqueue.ParallelizeUntil</code>并发执行<code>checkNode</code>函数，一旦找到配置的可行节点数，就停止搜索更多节点。</li>
</ol>
<h2 id="7-2-podfitsonnode">7.2. podFitsOnNode</h2>
<p>其中会调用到核心函数podFitsOnNode。</p>
<p><code>podFitsOnNode</code>主要内容如下：</p>
<ul>
<li>
<p><code>podFitsOnNode</code>会检查给定的某个Node是否满足预选的函数。</p>
</li>
<li>
<p>对于给定的pod，<code>podFitsOnNode</code>会检查是否有相同的pod存在，尽量复用缓存过的预选结果。</p>
</li>
</ul>
<p><code>podFitsOnNode</code>主要在<code>Schedule</code>（调度）和<code>Preempt</code>（抢占）的时候被调用。</p>
<p>当在<code>Schedule</code>中被调用的时候，主要判断是否可以被调度到当前节点，依据为当前节点上所有已存在的pod及被提名要运行到该节点的具有相等或更高优先级的pod。</p>
<p>当在<code>Preempt</code>中被调用的时候，即发生抢占的时候，通过<code>SelectVictimsOnNode</code>函数选出需要被移除的pod，移除后然后将预调度的pod调度到该节点上。</p>
<p><strong>podFitsOnNode基本流程如下：</strong></p>
<ol>
<li>遍历之前注册好的预选策略<code>predicates.Ordering</code>，并获取预选策略的执行函数。</li>
<li>遍历执行每个<code>预选函数</code>，并返回是否合适，预选失败的原因和错误。</li>
<li>如果预选函数执行的结果不合适，则加入预选失败的数组中。</li>
<li>最后返回预选失败的个数是否为0，和预选失败的原因。</li>
</ol>
<h2 id="7-3-podfitsresources">7.3. PodFitsResources</h2>
<blockquote>
<p>本文只示例分析了其中一个重要的预选函数：PodFitsResources</p>
</blockquote>
<p><code>PodFitsResources</code>用来检查一个节点是否有足够的资源来运行当前的pod，包括CPU、内存、GPU等。</p>
<p><strong>PodFitsResources基本流程如下：</strong></p>
<ol>
<li>判断当前节点上pod总数加上预调度pod个数是否大于node的可分配pod总数，若是则不允许调度。</li>
<li>判断pod的request值是否都为0，若是则允许调度。</li>
<li>判断pod的request值加上当前node上所有pod的request值总和是否大于node的可分配资源，若是则不允许调度。</li>
<li>判断pod的拓展资源request值加上当前node上所有pod对应的request值总和是否大于node对应的可分配资源，若是则不允许调度。</li>
</ol>
<p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithm/predicates/predicates.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithm/predicates/predicates.go</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8621391b1d2292ec57a9ce7538fe1a47">4.6 - kube-scheduler源码分析（五）之 优选策略</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析<code>优选策略</code>逻辑，即从预选的节点中选择出最优的节点。优选策略的具体实现函数为<code>PrioritizeNodes</code>。<code>PrioritizeNodes</code>最终返回是一个记录了各个节点分数的列表。</p>
<h1 id="1-调用入口-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-core-generic-scheduler-go-l165">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go#L165">调用入口</a></h1>
<p><code>genericScheduler.Schedule</code>中对<code>PrioritizeNodes</code>的调用过程如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Prioritizing&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startPriorityEvalTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// When only one node after predicate, just use it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPriorityEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metaPrioritiesInterface</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">priorityMetaProducer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 执行优选逻辑的操作，返回记录各个节点分数的列表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">PrioritizeNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaPrioritiesInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prioritizers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPriorityEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 基于预选节点filteredNodes进一步筛选优选的节点，返回记录各个节点分数的列表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">PrioritizeNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaPrioritiesInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prioritizers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="2-prioritizenodes-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-core-generic-scheduler-go-l602">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go#L602">PrioritizeNodes</a></h1>
<p>优选，从满足的节点中选择出最优的节点。<code>PrioritizeNodes</code>最终返回是一个记录了各个节点分数的列表。</p>
<p>具体操作如下：</p>
<ul>
<li>PrioritizeNodes通过并行运行各个优先级函数来对节点进行优先级排序。</li>
<li>每个优先级函数会给节点打分，打分范围为0-10分。</li>
<li>0 表示优先级最低的节点，10表示优先级最高的节点。</li>
<li>每个优先级函数也有各自的权重。</li>
<li>优先级函数返回的节点分数乘以权重以获得加权分数。</li>
<li>最后组合（添加）所有分数以获得所有节点的总加权分数。</li>
</ul>
<p><strong>PrioritizeNodes主要流程如下：</strong></p>
<ol>
<li>如果没有设置优选函数和拓展函数，则全部节点设置相同的分数，直接返回。</li>
<li>依次给node执行map函数进行打分。</li>
<li>再对上述map函数的执行结果执行reduce函数计算最终得分。</li>
<li>最后根据不同优先级函数的权重对得分取加权平均数。</li>
</ol>
<p><strong>入参：</strong></p>
<ul>
<li>pod</li>
<li>nodeNameToInfo</li>
<li>meta interface{},</li>
<li>priorityConfigs</li>
<li>nodes</li>
<li>extenders</li>
</ul>
<p><strong>出参：</strong></p>
<ul>
<li>HostPriorityList：记录节点分数的列表。</li>
</ul>
<p><code>HostPriority</code>定义如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HostPriority represents the priority of scheduling to a particular host, higher priority is better.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">HostPriority</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Name of the host
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Host</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Score associated with the host
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Score</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>PrioritizeNodes</code>完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PrioritizeNodes prioritizes the nodes by running the individual priority functions in parallel.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Each priority function is expected to set a score of 0-10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 0 is the lowest priority score (least preferred node) and 10 is the highest
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Each priority function can also have its own weight
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The node scores returned by the priority function are multiplied by the weights to get weighted scores
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// All scores are finally combined (added) to get the total weighted scores of all nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">PrioritizeNodes</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeNameToInfo</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">meta</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfig</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodes</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">extenders</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerExtender</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If no priority configs are provided, then the EqualPriority function is applied
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This is required to generate the priority list in the required format
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">EqualPriorityMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">result</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">errs</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">appendError</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">errs</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">priorityConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Function</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// DEPRECATED
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfig</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">appendError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">processNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Function</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">appendError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parallelize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">processNode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">priorityConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reduce</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfig</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reduce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">appendError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%v -&gt; %v: %v, Score: (%d)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Score</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Wait for all computations to be finished.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAggregate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Summarize all scores.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Score</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Weight</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">nodes</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">combinedScores</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">extender</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">extenders</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsInterested</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ext</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerExtender</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">prioritizedList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">weight</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prioritize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#8f5902;font-style:italic">// Prioritization errors from extender can be ignored, let k8s/other extenders determine the priorities
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>					<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prioritizedList</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">score</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prioritizedList</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prioritizedList</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">combinedScores</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">host</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">score</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">weight</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">extender</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// wait for all go routines to finish
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">combinedScores</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Host %s =&gt; Score %d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<p>以下对<code>PrioritizeNodes</code>分段进行分析。</p>
<h1 id="3-equalprioritymap">3. EqualPriorityMap</h1>
<p>如果没有提供优选函数和拓展函数，则将所有的节点设置为相同的优先级，即节点的score都为1，然后直接返回结果。(但一般情况下优选函数列表都不为空)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If no priority configs are provided, then the EqualPriority function is applied
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This is required to generate the priority list in the required format
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">EqualPriorityMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>EqualPriorityMap具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// EqualPriorityMap is a prioritizer function that gives an equal weight of one to all nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">EqualPriorityMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;node not found&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Host</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Score</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-processnode">4. processNode</h1>
<p><code>processNode</code>就是基于index拿出node的信息，调用之前注册的各种优选函数（此处是<code>mapFunction</code>），通过优选函数对node和pod进行处理，最后返回一个记录node分数的列表<code>result</code>。<code>processNode</code>同样也使用<code>workqueue.Parallelize</code>来进行并行处理。(<code>processNode</code>类似于预选逻辑<code>findNodesThatFit</code>中使用到的<code>checkNode</code>的作用)</p>
<p>其中优选函数是通过<code>priorityConfigs</code>来记录，每类优选函数包括<code>PriorityMapFunction</code>和<code>PriorityReduceFunction</code>两种函数。优选函数的注册部分可参考<a href="registerAlgorithmProvider.md">registerAlgorithmProvider</a>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">processNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Function</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">appendError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 并行执行processNode
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parallelize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">processNode</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>priorityConfigs</code>定义如下：</p>
<p>核心属性：</p>
<ul>
<li>Map ：PriorityMapFunction</li>
<li>Reduce：PriorityReduceFunction</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PriorityConfig is a config used for a priority function.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PriorityConfig</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span>   <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Map</span>    <span style="color:#000">PriorityMapFunction</span>   
</span></span><span style="display:flex;"><span>	<span style="color:#000">Reduce</span> <span style="color:#000">PriorityReduceFunction</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: Remove it after migrating all functions to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Map-Reduce pattern.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Function</span> <span style="color:#000">PriorityFunction</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Weight</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>具体的优选函数处理逻辑待下文分析，本文会以<code>NewSelectorSpreadPriority</code>函数为例。</p>
<h1 id="5-prioritymapfunction">5. PriorityMapFunction</h1>
<p><code>PriorityMapFunction</code>是一个计算给定节点的每个节点结果的函数。</p>
<p><code>PriorityMapFunction</code>定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PriorityMapFunction is a function that computes per-node results for a given node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: Figure out the exact API of this method.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: Change interface{} to a specific type.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PriorityMapFunction</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>PriorityMapFunction是在<code>processNode</code>中调用的，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>下文会分析<code>NewSelectorSpreadPriority</code>在的map函数<code>CalculateSpreadPriorityMap</code>。</p>
<h1 id="6-priorityreducefunction">6. PriorityReduceFunction</h1>
<p><code>PriorityReduceFunction</code>是一个聚合每个节点结果并计算所有节点的最终得分的函数。</p>
<p><code>PriorityReduceFunction</code>定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PriorityReduceFunction is a function that aggregated per-node results and computes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// final scores for all nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: Figure out the exact API of this method.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: Change interface{} to a specific type.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PriorityReduceFunction</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">nodeNameToInfo</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span></code></pre></div><p>PrioritizeNodes中对reduce函数调用部分如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">priorityConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reduce</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfig</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reduce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">appendError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%v -&gt; %v: %v, Score: (%d)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Score</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>下文会分析<code>NewSelectorSpreadPriority</code>在的reduce函数<code>CalculateSpreadPriorityReduce</code>。</p>
<h1 id="7-summarize-all-scores">7. Summarize all scores</h1>
<p>先等待计算完成再计算加权平均数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Wait for all computations to be finished.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAggregate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>计算所有节点的加权平均数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Summarize all scores.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Score</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Weight</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>当设置了拓展的计算方式，则增加拓展计算方式的加权平均数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">nodes</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">combinedScores</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">extender</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">extenders</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsInterested</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ext</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerExtender</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">prioritizedList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">weight</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prioritize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// Prioritization errors from extender can be ignored, let k8s/other extenders determine the priorities
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prioritizedList</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">score</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prioritizedList</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prioritizedList</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">combinedScores</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">host</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">score</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">weight</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">extender</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// wait for all go routines to finish
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">combinedScores</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="8-newselectorspreadpriority">8. NewSelectorSpreadPriority</h1>
<p>以下以<code>NewSelectorSpreadPriority</code>这个优选函数来做分析，其他重要的优选函数待后续专门分析。</p>
<p><code>NewSelectorSpreadPriority</code>主要的功能是将属于相同service和rs下的pod尽量分布在不同的node上。</p>
<p>该函数的注册代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/algorithmprovider/defaults/defaults.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ServiceSpreadingPriority is a priority config factory that spreads pods by minimizing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the number of pods (belonging to the same service) on the same node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Register the factory so that it&#39;s available, but do not include it as part of the default priorities
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Largely replaced by &#34;SelectorSpreadPriority&#34;, but registered for backward compatibility with 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityConfigFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;ServiceSpreadingPriority&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfigFactory</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MapReduceFunction</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityMapFunction</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityReduceFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSelectorSpreadPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EmptyControllerLister</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EmptyReplicaSetLister</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EmptyStatefulSetLister</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Weight</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>NewSelectorSpreadPriority</code>的具体实现如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/algorithm/priorities/selector_spreading.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewSelectorSpreadPriority creates a SelectorSpread.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewSelectorSpreadPriority</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">serviceLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllerLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">replicaSetLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">statefulSetLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatefulSetLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityMapFunction</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityReduceFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">selectorSpread</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">SelectorSpread</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">serviceLister</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">serviceLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controllerLister</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">controllerLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">replicaSetLister</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">replicaSetLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">statefulSetLister</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">statefulSetLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">selectorSpread</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CalculateSpreadPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">selectorSpread</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CalculateSpreadPriorityReduce</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>NewSelectorSpreadPriority</code>主要包括map和reduce两种函数，分别对应<code>CalculateSpreadPriorityMap</code>，<code>CalculateSpreadPriorityReduce</code>。</p>
<h2 id="8-1-calculatespreadprioritymap-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-algorithm-priorities-selector-spreading-go-l66">8.1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithm/priorities/selector_spreading.go#L66">CalculateSpreadPriorityMap</a></h2>
<p><code>CalculateSpreadPriorityMap</code>的主要作用是将相同service、RC、RS或statefulset的pod分布在不同的节点上。当调度一个pod的时候，先寻找与该pod匹配的service、RS、RC或statefulset，然后寻找与其selector匹配的已存在的pod，寻找存在这类pod最少的节点。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>寻找与该pod对应的service、RS、RC、statefulset匹配的selector。</li>
<li>遍历当前节点的所有pod，将该节点上已存在的selector匹配到的pod的个数作为该节点的分数（此时，分数大的表示匹配到的pod越多，越不符合被调度的条件，该分数在reduce阶段会被按10分制处理成分数大的越符合被调度的条件）。</li>
</ol>
<blockquote>
<p>此部分代码位于pkg/scheduler/algorithm/priorities/selector_spreading.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// CalculateSpreadPriorityMap spreads pods across hosts, considering pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// belonging to the same service,RC,RS or StatefulSet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// When a pod is scheduled, it looks for services, RCs,RSs and StatefulSets that match the pod,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// then finds existing pods that match those selectors.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It favors nodes that have fewer existing matching pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// i.e. it pushes the scheduler towards a node where there&#39;s the smallest number of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pods which match the same service, RC,RSs or StatefulSets selectors as the pod being scheduled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">SelectorSpread</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">CalculateSpreadPriorityMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">selectors</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">labels</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Selector</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;node not found&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">priorityMeta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">priorityMetadata</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">selectors</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">priorityMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podSelectors</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">selectors</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">getSelectors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serviceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controllerLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">replicaSetLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statefulSetLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">selectors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Host</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Score</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodePod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">nodePod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// When we are replacing a failed pod, we often see the previous
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// deleted version while scheduling the replacement.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// Ignore the previous deleted version for spreading purposes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// (it can still be considered for resource restrictions etc.)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">nodePod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;skipping pending-deleted pod: %s/%s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodePod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodePod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">selector</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">selectors</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">selector</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Matches</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">labels</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodePod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Labels</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">count</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Host</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Score</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下分段分析：</p>
<p>先获得selector。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">selectors</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">getSelectors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serviceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controllerLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">replicaSetLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statefulSetLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>计算节点上匹配selector的pod的个数，作为该节点分数，该分数并不是最终节点的分数，只是中间过渡的记录状态。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodePod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">selector</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">selectors</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">selector</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Matches</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">labels</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodePod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Labels</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">count</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="8-2-calculatespreadpriorityreduce-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-algorithm-priorities-selector-spreading-go-l117">8.2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithm/priorities/selector_spreading.go#L117">CalculateSpreadPriorityReduce</a></h2>
<p><code>CalculateSpreadPriorityReduce</code>根据节点上现有匹配pod的数量计算每个节点的十分制的分数，具有较少现有匹配pod的节点的分数越高，表示节点越可能被调度到。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>记录所有节点中匹配到pod个数最多的节点的分数（即匹配到的pod最多的个数）。</li>
<li>遍历所有的节点，按比例取十分制的得分，计算方式为：(节点中最多匹配pod的个数-当前节点pod的个数)/节点中最多匹配pod的个数。此时，分数越高表示该节点上匹配到的pod的个数越少，越可能被调度到，即满足把相同selector的pod分散到不同节点的需求。</li>
</ol>
<blockquote>
<p>此部分代码位于pkg/scheduler/algorithm/priorities/selector_spreading.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// CalculateSpreadPriorityReduce calculates the source of each node
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// based on the number of existing matching pods on the node
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// where zone information is included on the nodes, it favors nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// in zones with fewer existing matching pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">SelectorSpread</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">CalculateSpreadPriorityReduce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">nodeNameToInfo</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">countsByZone</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxCountByZone</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxCountByNodeName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">maxCountByNodeName</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">maxCountByNodeName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilnode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetZoneKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">countsByZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">zoneID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">countsByZone</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">countsByZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">zoneID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">maxCountByZone</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">maxCountByZone</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">countsByZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">zoneID</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">haveZones</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">countsByZone</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxCountByNodeNameFloat64</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxCountByNodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxCountByZoneFloat64</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxCountByZone</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MaxPriorityFloat64</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxPriority</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// initializing to the default/max node score of maxPriority
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">fScore</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">MaxPriorityFloat64</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">maxCountByNodeName</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fScore</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">MaxPriorityFloat64</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxCountByNodeName</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">maxCountByNodeNameFloat64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// If there is zone information present, incorporate it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">haveZones</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilnode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetZoneKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">zoneScore</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">MaxPriorityFloat64</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">maxCountByZone</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">zoneScore</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">MaxPriorityFloat64</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxCountByZone</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">countsByZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">zoneID</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">maxCountByZoneFloat64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fScore</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fScore</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1.0</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">zoneWeighting</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">zoneWeighting</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">zoneScore</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fScore</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#4e9a06">&#34;%v -&gt; %v: SelectorSpreadPriority, Score: (%d)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fScore</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下分段分析：</p>
<p>先获取所有节点中匹配到的pod最多的个数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">maxCountByNodeName</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">maxCountByNodeName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilnode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetZoneKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">countsByZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">zoneID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>遍历所有的节点，按比例取十分制的得分。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// initializing to the default/max node score of maxPriority
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fScore</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">MaxPriorityFloat64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">maxCountByNodeName</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fScore</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">MaxPriorityFloat64</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxCountByNodeName</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">maxCountByNodeNameFloat64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><h1 id="9-总结">9. 总结</h1>
<p>优选，从满足的节点中选择出最优的节点。<code>PrioritizeNodes</code>最终返回是一个记录了各个节点分数的列表。</p>
<h2 id="9-1-prioritizenodes">9.1. PrioritizeNodes</h2>
<p><strong>主要流程如下：</strong></p>
<ol>
<li>如果没有设置优选函数和拓展函数，则全部节点设置相同的分数，直接返回。</li>
<li>依次给node执行map函数进行打分。</li>
<li>再对上述map函数的执行结果执行reduce函数计算最终得分。</li>
<li>最后根据不同优先级函数的权重对得分取加权平均数。</li>
</ol>
<p>其中每类优选函数会包含map函数和reduce函数两种。</p>
<h2 id="9-2-newselectorspreadpriority">9.2. NewSelectorSpreadPriority</h2>
<p>其中以<code>NewSelectorSpreadPriority</code>这个优选函数为例作分析，该函数的功能是将相同service、RS、RC或statefulset下pod尽量分散到不同的节点上。包括map函数和reduce函数两部分，具体如下。</p>
<h3 id="9-2-1-calculatespreadprioritymap">9.2.1. CalculateSpreadPriorityMap</h3>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>寻找与该pod对应的service、RS、RC、statefulset匹配的selector。</li>
<li>遍历当前节点的所有pod，将该节点上已存在的selector匹配到的pod的个数作为该节点的分数（此时，分数大的表示匹配到的pod越多，越不符合被调度的条件，该分数在reduce阶段会被按10分制处理成分数大的越符合被调度的条件）。</li>
</ol>
<h3 id="9-2-2-calculatespreadpriorityreduce">9.2.2. CalculateSpreadPriorityReduce</h3>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>记录所有节点中匹配到pod个数最多的节点的分数（即匹配到的pod最多的个数）。</li>
<li>遍历所有的节点，按比例取十分制的得分，计算方式为：(节点中最多匹配pod的个数-当前节点pod的个数)/节点中最多匹配pod的个数。此时，分数越高表示该节点上匹配到的pod的个数越少，越可能被调度到，即满足把相同selector的pod分散到不同节点的需求。</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithm/priorities/selector_spreading.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithm/priorities/selector_spreading.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-198aaa69380bc8e1d54162e3ae00b4be">4.7 - kube-scheduler源码分析（六）之 抢占逻辑</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析调度中的抢占逻辑，当pod不适合任何节点的时候，可能pod会调度失败，这时候可能会发生抢占。抢占逻辑的具体实现函数为<code>Scheduler.preempt</code>。</p>
<h1 id="1-调用入口">1. 调用入口</h1>
<p>当pod不适合任何节点的时候，可能pod会调度失败。这时候可能会发生抢占。</p>
<p><code>scheduleOne</code>函数中关于抢占调用的逻辑如下：</p>
<blockquote>
<p>此部分的代码位于/pkg/scheduler/scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// scheduleOne does the entire scheduling workflow for a single pod.  It is serialized on the scheduling algorithm&#39;s host fitting.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">scheduleOne</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// schedule() may have failed because the pod would not fit on any host, so we try to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// preempt, with the expectation that the next time the pod is tried for scheduling it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// will fit due to the preemption. It is also possible that a different pod will schedule
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// into the resources that were preempted, but this is harmless.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">preemptionStartTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// 执行抢占逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionAttempts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Inc</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPremptionEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><p>其中核心代码为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 基于sched.schedule(pod)返回的err和当前待调度的pod执行抢占策略
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="2-scheduler-preempt">2. Scheduler.preempt</h1>
<p>当pod调度失败的时候，会抢占低优先级pod的空间来给高优先级的pod。其中入参为调度失败的pod对象和调度失败的err。</p>
<p><strong>抢占的基本流程如下：</strong></p>
<ol>
<li>判断是否有关闭抢占机制，如果关闭抢占机制则直接返回。</li>
<li>获取调度失败pod的最新对象数据。</li>
<li>执行抢占算法<code>Algorithm.Preempt</code>，返回预调度节点和需要被剔除的pod列表。</li>
<li>将抢占算法返回的node添加到pod的<code>Status.NominatedNodeName</code>中，并删除需要被剔除的pod。</li>
<li>当抢占算法返回的node是nil的时候，清除pod的<code>Status.NominatedNodeName</code>信息。</li>
</ol>
<p>整个抢占流程的最终结果实际上是更新<code>Pod.Status.NominatedNodeName</code>属性的信息。如果抢占算法返回的节点不为空，则将该node更新到<code>Pod.Status.NominatedNodeName</code>中，否则就将<code>Pod.Status.NominatedNodeName</code>设置为空。</p>
<h2 id="2-1-preempt">2.1. preempt</h2>
<p>preempt的具体实现函数：</p>
<blockquote>
<p>此部分的代码位于/pkg/scheduler/scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// preempt tries to create room for a pod that has failed to schedule, by preempting lower priority pods if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If it succeeds, it adds the name of the node where preemption has happened to the pod annotations.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It returns the node name and an error if any.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">scheduleErr</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPriorityEnabled</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DisablePreemption</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Pod priority feature is not enabled or preemption is disabled by scheduler configuration.&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34; No preemption is performed.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetUpdatedPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error getting the updated preemptor pod object: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">victims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nominatedPodsToClear</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">scheduleErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionVictims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victims</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error preempting victims to make room for %v/%v.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">nodeName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error in preemption process. Cannot update pod %v/%v annotations: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">victim</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">victims</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victim</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error preempting pod %v/%v: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">victim</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">victim</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victim</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Preempted&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;by %v/%v on node %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Clearing nominated pods should happen outside of &#34;if node != nil&#34;. Node could
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// be nil when a pod with nominated node name is eligible to preempt again,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// but preemption logic does not find any node for it. In that case Preempt()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// function of generic_scheduler.go returns the pod itself for removal of the annotation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nominatedPodsToClear</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">rErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rErr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Cannot remove nominated node annotation of pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// We do not return as this error is not critical.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下对<code>preempt</code>的实现分段分析。</p>
<p>如果设置关闭抢占机制，则直接返回。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPriorityEnabled</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DisablePreemption</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Pod priority feature is not enabled or preemption is disabled by scheduler configuration.&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34; No preemption is performed.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>获取当前pod的最新状态。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetUpdatedPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error getting the updated preemptor pod object: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>GetUpdatedPod</code>的实现就是去拿pod的对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podPreemptor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">GetUpdatedPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>接着执行抢占的算法。抢占的算法返回预调度节点的信息和因抢占被剔除的pod的信息。具体的抢占算法逻辑下文分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">victims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nominatedPodsToClear</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">scheduleErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>将预调度节点的信息更新到pod的<code>Status.NominatedNodeName</code>属性中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>SetNominatedNodeName</code>的具体实现为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podPreemptor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">SetNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nominatedNodeName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podCopy</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podCopy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NominatedNodeName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">nominatedNodeName</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">UpdateStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podCopy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>接着删除因抢占而需要被剔除的pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victim</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>PodPreemptor.DeletePod</code>的具体实现就是删除具体的pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podPreemptor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">DeletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果抢占算法得出的node对象为nil，则将pod的<code>Status.NominatedNodeName</code>属性设置为空。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Clearing nominated pods should happen outside of &#34;if node != nil&#34;. Node could
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// be nil when a pod with nominated node name is eligible to preempt again,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// but preemption logic does not find any node for it. In that case Preempt()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// function of generic_scheduler.go returns the pod itself for removal of the annotation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nominatedPodsToClear</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rErr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Cannot remove nominated node annotation of pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// We do not return as this error is not critical.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>RemoveNominatedNodeName</code>的具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podPreemptor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">RemoveNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NominatedNodeName</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-nominatednodename">2.2. NominatedNodeName</h2>
<p><code>Pod.Status.NominatedNodeName</code>的说明：</p>
<p><code>nominatedNodeName</code>是调度失败的pod抢占别的pod的时候，被抢占pod的运行节点。但在剔除被抢占pod之前该调度失败的pod不会被调度。同时也不保证最终该pod一定会调度到<code>nominatedNodeName</code>的机器上，也可能因为之后资源充足等原因调度到其他节点上。最终该pod会被加到调度的队列中。</p>
<p>其中加入到调度队列的具体过程如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewConfigFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ConfigFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">scheduler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Configurator</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#8f5902;font-style:italic">// unscheduled pod queue
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addPodToSchedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updatePodInSchedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deletePodFromSchedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><p><strong>addPodToSchedulingQueue:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">configFactory</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">addPodToSchedulingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unable to queue %T: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>PriorityQueue.Add:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Add adds a pod to the active queue. It should be called only when a new pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// is added so there is no chance the pod is already in either queue.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PriorityQueue</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">activeQ</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error adding pod %v/%v to the scheduling queue: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unschedulableQ</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error: pod %v/%v is already in the unschedulable queue.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteNominatedPodIfExists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unschedulableQ</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addNominatedPodIfNeeded</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cond</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Broadcast</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>addNominatedPodIfNeeded:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// addNominatedPodIfNeeded adds a pod to nominatedPods if it has a NominatedNodeName and it does not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// already exist in the map. Adding an existing pod is not going to update the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PriorityQueue</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">addNominatedPodIfNeeded</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nnn</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nnn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">np</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nominatedPods</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nnn</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">np</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Pod %v/%v already exists in the nominated map!&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nominatedPods</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nnn</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nominatedPods</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nnn</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>NominatedNodeName:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NominatedNodeName returns nominated node name of a Pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NominatedNodeName</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-genericscheduler-preempt">3. genericScheduler.Preempt</h1>
<p>抢占算法依然是在<code>ScheduleAlgorithm</code>接口中定义。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ScheduleAlgorithm is an interface implemented by things that know how to schedule pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// onto machines.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ScheduleAlgorithm</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">selectedMachine</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Preempt receives scheduling errors for a pod and tries to create room for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the pod by preempting lower priority pods if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// It returns the node where preemption happened, a list of preempted pods, a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// list of pods whose nominated node name should be removed, and error if any.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">selectedNode</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptedPods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cleanupNominatedPods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Predicates() returns a pointer to a map of predicate functions. This is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// exposed for testing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Predicates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">FitPredicate</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Prioritizers returns a slice of priority config. This is exposed for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// testing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Prioritizers</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">PriorityConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>Preempt</code>的具体实现为<code>genericScheduler</code>结构体。</p>
<p><code>Preempt</code>的主要实现是找到可以调度的节点和上面因抢占而需要被剔除的pod。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>根据调度失败的原因对所有节点先进行一批筛选，筛选出潜在的被调度节点列表。</li>
<li>通过<code>selectNodesForPreemption</code>筛选出需要牺牲的pod和其节点。</li>
<li>基于拓展抢占逻辑再次对上述筛选出来的牺牲者做过滤。</li>
<li>基于上述的过滤结果，选择一个最终可能因抢占被调度的节点。</li>
<li>基于上述的候选节点，找出该节点上优先级低于当前被调度pod的牺牲者pod列表。</li>
</ol>
<p>完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// preempt finds nodes with pods that can be preempted to make room for &#34;pod&#34; to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// schedule. It chooses one of the nodes and preempts the pods on the node and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// returns 1) the node, 2) the list of preempted pods if such a node is found,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 3) A list of pods whose nominated node name should be cleared, and 4) any
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// possible error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">scheduleErr</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Scheduler may return various types of errors. Consider preemption only if
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the error is of type FitError.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">scheduleErr</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">fitError</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateNodeNameToInfoMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">podEligibleToPreemptOthers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Pod %v/%v is not eligible for more preemption.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ErrNoNodesAvailable</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">potentialNodes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodesWherePreemptionMightHelp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedPredicates</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potentialNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Preemption will not help schedule pod %v/%v on any node.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// In this case, we should clean-up any existing nominated node name of the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pdbs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListPDBs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">labels</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Everything</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 找出可能被抢占的节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">selectNodesForPreemption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">potentialNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicateMetaProducer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedulingQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pdbs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We will only check nodeToVictims with extenders that support preemption.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Extenders which do not support preemption may later prevent preemptor from being scheduled on the nominated
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// node. In that case, scheduler will find a different host for the preemptor in subsequent scheduling cycles.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processPreemptionWithExtenders</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 选出最终被抢占的节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">candidateNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pickOneNodeForPreemption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">candidateNode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Lower priority pods nominated to run on this node, may no longer fit on
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// this node. So, we should remove their nomination. Removing their
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// nomination updates these pods and moves them to the active queue. It
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// lets scheduler find another place for them.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// 找出被强占节点上牺牲者pod列表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">nominatedPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getLowerPriorityNominatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nominatedPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;preemption failed: the target node %s has been deleted from scheduler cache&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<p>以下对<code>genericScheduler.Preempt</code>分段进行分析。</p>
<h2 id="3-1-selectnodesforpreemption">3.1. selectNodesForPreemption</h2>
<p><code>selectNodesForPreemption</code>并行地所有节点中找可能被抢占的节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">selectNodesForPreemption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">potentialNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicateMetaProducer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedulingQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pdbs</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>selectNodesForPreemption</code>主要基于<code>selectVictimsOnNode</code>构造一个checkNode的函数，然后并发执行该函数。</p>
<p><code>selectNodesForPreemption</code>具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// selectNodesForPreemption finds all the nodes with possible victims for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// preemption in parallel.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">selectNodesForPreemption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeNameToInfo</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">potentialNodes</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicates</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metadataProducer</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadataProducer</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">queue</span> <span style="color:#000">SchedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pdbs</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">policy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodDisruptionBudget</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Victims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeToVictims</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Victims</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">resultLock</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We can use the same metadata producer for all nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">meta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metadataProducer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">checkNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">potentialNodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">metaCopy</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadata</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">meta</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metaCopy</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ShallowCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">numPDBViolations</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fits</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">selectVictimsOnNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaCopy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pdbs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fits</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">resultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">victims</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Victims</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">pods</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">NumPDBViolations</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">numPDBViolations</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">potentialNodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">victims</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">resultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parallelize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potentialNodes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">checkNode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-1-selectvictimsonnode">3.1.1. selectVictimsOnNode</h3>
<p><code>selectVictimsOnNode</code>找到应该被抢占的给定节点上的最小pod集合，以便给调度失败的pod安排足够的空间。该函数最终返回的是一个pod的数组。当有更低优先级的pod可能被选择的时候，较高优先级的pod不会被选入该待剔除的pod集合。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>先检查当该节点上所有低于预被调度pod优先级的pod移除后，该pod能否被调度到当前节点上。</li>
<li>如果上述检查可以，则将该节点的所有低优先级pod按照优先级来排序。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// selectVictimsOnNode finds minimum set of pods on the given node that should
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// be preempted in order to make enough room for &#34;pod&#34; to be scheduled. The
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// minimum set selected is subject to the constraint that a higher-priority pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// is never preempted when a lower-priority pod could be (higher/lower relative
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to one another, not relative to the preemptor &#34;pod&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The algorithm first checks if the pod can be scheduled on the node when all the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// lower priority pods are gone. If so, it sorts all the lower priority pods by
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// their priority and then puts them into two groups of those whose PodDisruptionBudget
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// will be violated if preempted and other non-violating pods. Both groups are
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// sorted by priority. It first tries to reprieve as many PDB violating pods as
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// possible and then does them same for non-PDB-violating pods while checking
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// that the &#34;pod&#34; can still fit on the node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NOTE: This function assumes that it is never called if &#34;pod&#34; cannot be scheduled
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// due to pod affinity, node affinity, or node anti-affinity reasons. None of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// these predicates can be satisfied by removing more pods from the node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">selectVictimsOnNode</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">meta</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadata</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fitPredicates</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">queue</span> <span style="color:#000">SchedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pdbs</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">policy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodDisruptionBudget</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">potentialVictims</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SortableList</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">CompFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HigherPriorityPod</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeInfoCopy</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Clone</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">removePod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rp</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeInfoCopy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">meta</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">addPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ap</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeInfoCopy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">meta</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoCopy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// As the first step, remove all the lower priority pods from the node and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// check if the given pod can be scheduled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">podPriority</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodeInfoCopy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podPriority</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">potentialVictims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Items</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potentialVictims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Items</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">removePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">potentialVictims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sort</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If the new pod does not fit after removing all the lower priority pods,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// we are almost done and this node is not suitable for preemption. The only condition
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// that we should check is if the &#34;pod&#34; is failing to schedule due to pod affinity
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// failure.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// TODO(bsalamat): Consider checking affinity to lower priority pods if feasible with reasonable performance.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podFitsOnNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoCopy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitPredicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">fits</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Encountered error while selecting victims on node %v: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">victims</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">numViolatingVictim</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Try to reprieve as many pods as possible. We first try to reprieve the PDB
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// violating victims and then other non-violating ones. In both cases, we start
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// from the highest priority victims.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">violatingVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nonViolatingVictims</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filterPodsWithPDBViolation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potentialVictims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Items</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pdbs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">reprievePod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">addPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podFitsOnNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoCopy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitPredicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">fits</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">removePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">victims</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Pod %v is a potential preemption victim on node %v.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fits</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">violatingVictims</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">reprievePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">numViolatingVictim</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Now we try to reprieve non-violating victims.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nonViolatingVictims</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">reprievePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">victims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">numViolatingVictim</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-processpreemptionwithextenders">3.2. processPreemptionWithExtenders</h2>
<p><code>processPreemptionWithExtenders</code>基于<code>selectNodesForPreemption</code>选出的牺牲者进行扩展的抢占逻辑继续筛选牺牲者。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// We will only check nodeToVictims with extenders that support preemption.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Extenders which do not support preemption may later prevent preemptor from being scheduled on the nominated
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// node. In that case, scheduler will find a different host for the preemptor in subsequent scheduling cycles.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processPreemptionWithExtenders</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>processPreemptionWithExtenders</code>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// processPreemptionWithExtenders processes preemption with extenders
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">processPreemptionWithExtenders</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeToVictims</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Victims</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Victims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">extender</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SupportsPreemption</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsInterested</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">newNodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProcessPreemption</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsIgnorable</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Skipping extender %v as it returned error %v and has ignorable flag set&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>							<span style="color:#000">extender</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// Replace nodeToVictims with new result after preemption. So the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#8f5902;font-style:italic">// rest of extenders can continue use it as parameter.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">nodeToVictims</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newNodeToVictims</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// If node list becomes empty, no preemption can happen regardless of other extenders.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-pickonenodeforpreemption">3.3. pickOneNodeForPreemption</h2>
<p><code>pickOneNodeForPreemption</code>从筛选出的node中再挑选一个节点作为最终调度节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">candidateNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pickOneNodeForPreemption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">candidateNode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>pickOneNodeForPreemption</code>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pickOneNodeForPreemption chooses one node among the given nodes. It assumes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pods in each map entry are ordered by decreasing priority.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It picks a node based on the following criteria:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 1. A node with minimum number of PDB violations.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 2. A node with minimum highest priority victim is picked.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 3. Ties are broken by sum of priorities of all victims.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 4. If there are still ties, node with the minimum number of victims is picked.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 5. If there are still ties, the first such node is picked (sort of randomly).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The &#39;minNodes1&#39; and &#39;minNodes2&#39; are being reused here to save the memory
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// allocation and garbage collection time.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">pickOneNodeForPreemption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodesToVictims</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Victims</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodesToVictims</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">minNumPDBViolatingPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxInt32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">minNodes1</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lenNodes1</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">victims</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodesToVictims</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// We found a node that doesn&#39;t need any preemption. Return it!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// This should happen rarely when one or more pods are terminated between
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// the time that scheduler tries to schedule the pod and the time that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// preemption logic tries to find nodes for preemption.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">node</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">numPDBViolatingPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">victims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumPDBViolations</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">numPDBViolatingPods</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minNumPDBViolatingPods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNumPDBViolatingPods</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">numPDBViolatingPods</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNodes1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">numPDBViolatingPods</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">minNumPDBViolatingPods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNodes1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">minNodes1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes1</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">lenNodes1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">minNodes1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// There are more than one node with minimum number PDB violating pods. Find
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the one with minimum highest priority victim.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">minHighestPriority</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxInt32</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">minNodes2</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lenNodes1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lenNodes2</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">lenNodes1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">minNodes1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">victims</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodesToVictims</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// highestPodPriority is the highest priority among the victims on this node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">highestPodPriority</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">highestPodPriority</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minHighestPriority</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minHighestPriority</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">highestPodPriority</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes2</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">highestPodPriority</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">minHighestPriority</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNodes2</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">lenNodes2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">node</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes2</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">lenNodes2</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">minNodes2</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// There are a few nodes with minimum highest priority victim. Find the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// smallest sum of priorities.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">minSumPriorities</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxInt64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lenNodes1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">lenNodes2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sumPriorities</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">minNodes2</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodesToVictims</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// We add MaxInt32+1 to all priorities to make all of them &gt;= 0. This is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// needed so that a node with a few pods with negative priority is not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// picked over a node with a smaller number of pods with the same negative
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// priority (and similar scenarios).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">sumPriorities</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxInt32</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">sumPriorities</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minSumPriorities</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minSumPriorities</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sumPriorities</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">sumPriorities</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">minSumPriorities</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNodes1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">lenNodes1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">node</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes1</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">lenNodes1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">minNodes1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// There are a few nodes with minimum highest priority victim and sum of priorities.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Find one with the minimum number of pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">minNumPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxInt32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lenNodes2</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">lenNodes1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">minNodes1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">numPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodesToVictims</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">numPods</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minNumPods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNumPods</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">numPods</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes2</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">numPods</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">minNumPods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNodes2</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">lenNodes2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">node</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes2</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// At this point, even if there are more than one node with the same score,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// return the first one.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">lenNodes2</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">minNodes2</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error in logic of node scoring for preemption. We should never reach here!&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-4-getlowerprioritynominatedpods">3.4. getLowerPriorityNominatedPods</h2>
<p><code>getLowerPriorityNominatedPods</code>的基本流程如下：</p>
<ol>
<li>获取候选节点上的pod列表。</li>
<li>获取待调度pod的优先级值。</li>
<li>遍历该节点的pod列表，如果低于待调度pod的优先级则放入低优先级pod列表中。</li>
</ol>
<p>genericScheduler.Preempt中相关代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Lower priority pods nominated to run on this node, may no longer fit on
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// this node. So, we should remove their nomination. Removing their
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// nomination updates these pods and moves them to the active queue. It
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// lets scheduler find another place for them.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">nominatedPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getLowerPriorityNominatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nominatedPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>getLowerPriorityNominatedPods</code>代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// getLowerPriorityNominatedPods returns pods whose priority is smaller than the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// priority of the given &#34;pod&#34; and are nominated to run on the given node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Note: We could possibly check if the nominated lower priority pods still fit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and return those that no longer fit, but that would require lots of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// manipulation of NodeInfo and PredicateMeta per nominated pod. It may not be
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// worth the complexity, especially because we generally expect to have a very
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// small number of nominated pods per node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">getLowerPriorityNominatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedulingQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitingPodsForNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">lowerPriorityPods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podPriority</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podPriority</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lowerPriorityPods</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lowerPriorityPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">lowerPriorityPods</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-总结">4. 总结</h1>
<h2 id="4-1-scheduler-preempt">4.1. Scheduler.preempt</h2>
<p>当pod调度失败的时候，会抢占低优先级pod的空间来给高优先级的pod。其中入参为调度失败的pod对象和调度失败的err。</p>
<p><strong>抢占的基本流程如下：</strong></p>
<ol>
<li>判断是否有关闭抢占机制，如果关闭抢占机制则直接返回。</li>
<li>获取调度失败pod的最新对象数据。</li>
<li>执行抢占算法<code>Algorithm.Preempt</code>，返回预调度节点和需要被剔除的pod列表。</li>
<li>将抢占算法返回的node添加到pod的<code>Status.NominatedNodeName</code>中，并删除需要被剔除的pod。</li>
<li>当抢占算法返回的node是nil的时候，清除pod的<code>Status.NominatedNodeName</code>信息。</li>
</ol>
<p>整个抢占流程的最终结果实际上是更新<code>Pod.Status.NominatedNodeName</code>属性的信息。如果抢占算法返回的节点不为空，则将该node更新到<code>Pod.Status.NominatedNodeName</code>中，否则就将<code>Pod.Status.NominatedNodeName</code>设置为空。</p>
<h2 id="4-2-genericscheduler-preempt">4.2. genericScheduler.Preempt</h2>
<p><code>Preempt</code>的主要实现是找到可以调度的节点和上面因抢占而需要被剔除的pod。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>根据调度失败的原因对所有节点先进行一批筛选，筛选出潜在的被调度节点列表。</li>
<li>通过<code>selectNodesForPreemption</code>筛选出需要牺牲的pod和其节点。</li>
<li>基于拓展抢占逻辑再次对上述筛选出来的牺牲者做过滤。</li>
<li>基于上述的过滤结果，选择一个最终可能因抢占被调度的节点。</li>
<li>基于上述的候选节点，找出该节点上优先级低于当前被调度pod的牺牲者pod列表。</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/scheduler.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b7be2a83ad06d778ca900e4c7dc85b09">5 - kubelet</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-5516fcb212e4fbbdc29a202ed629314d">5.1 - kubelet 源码思维导图</h1>
    
	<h2 id="源码整体结构图">源码整体结构图</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1618721742/article/code-analysis/kubelet/kubelet.png" width="100%">

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e2cf6c7dbb69ed9905bbe6a48da441ab">5.2 - kubelet源码分析（一）之 NewKubeletCommand</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
<p>本文主要分析 <a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kubelet">https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kubelet</a> 部分的代码。</p>
</blockquote>
<p>本文主要分析 <code>kubernetes/cmd/kubelet</code>部分，该部分主要涉及<code>kubelet</code>的参数解析，及初始化和构造相关的依赖组件（主要在<code>kubeDeps</code>结构体中），并没有<code>kubelet</code>运行的详细逻辑，该部分位于<code>kubernetes/pkg/kubelet</code>模块，待后续文章分析。</p>
<p><code>kubelet</code>的<code>cmd</code>代码目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubelet
</span></span><span style="display:flex;"><span>├── app
</span></span><span style="display:flex;"><span>│   ├── auth.go
</span></span><span style="display:flex;"><span>│   ├── init_others.go
</span></span><span style="display:flex;"><span>│   ├── init_windows.go
</span></span><span style="display:flex;"><span>│   ├── options              <span style="color:#8f5902;font-style:italic"># 包括kubelet使用到的option</span>
</span></span><span style="display:flex;"><span>│   │   ├── container_runtime.go
</span></span><span style="display:flex;"><span>│   │   ├── globalflags.go
</span></span><span style="display:flex;"><span>│   │   ├── globalflags_linux.go
</span></span><span style="display:flex;"><span>│   │   ├── globalflags_other.go
</span></span><span style="display:flex;"><span>│   │   ├── options.go     <span style="color:#8f5902;font-style:italic"># 包括KubeletFlags、AddFlags、AddKubeletConfigFlags等</span>
</span></span><span style="display:flex;"><span>│   │   ├── osflags_others.go
</span></span><span style="display:flex;"><span>│   │   └── osflags_windows.go
</span></span><span style="display:flex;"><span>│   ├── plugins.go
</span></span><span style="display:flex;"><span>│   ├── server.go <span style="color:#8f5902;font-style:italic"># 包括NewKubeletCommand、Run、RunKubelet、CreateAndInitKubelet、startKubelet等</span>
</span></span><span style="display:flex;"><span>│   ├── server_linux.go
</span></span><span style="display:flex;"><span>│   └── server_unsupported.go
</span></span><span style="display:flex;"><span>└── kubelet.go              <span style="color:#8f5902;font-style:italic"># kubelet的main入口函数</span>
</span></span></code></pre></div><h1 id="1-main-函数-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kubelet-kubelet-go-l36">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/kubelet.go#L36">Main 函数</a></h1>
<p><code>kubelet</code>的入口函数<code> Main</code> 函数，具体代码参考：https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/kubelet.go。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UTC</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UnixNano</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewKubeletCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetupSignalHandler</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlushLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>kubelet代码主要采用了<a href="https://github.com/spf13/cobra">Cobra</a>命令行框架，核心代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 初始化命令行
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewKubeletCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetupSignalHandler</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 执行Execute
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h1 id="2-newkubeletcommand-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kubelet-app-server-go-l108">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/server.go#L108">NewKubeletCommand</a></h1>
<p><code>NewKubeletCommand</code>基于参数创建了一个<code>*cobra.Command</code>对象。其中核心部分代码为参数解析部分和<code>Run</code>函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewKubeletCommand creates a *cobra.Command object with default parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewKubeletCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentKubelet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Long</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`...`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// The Kubelet has special flag parsing requirements to enforce flag precedence rules,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// so we do all our parsing manually in Run, below.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// DisableFlagParsing=true provides the full set of flags passed to the kubelet in the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// `args` arg to Run, without Cobra&#39;s interference.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">DisableFlagParsing</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Run</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// run the kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KubeletConfiguration: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-1-参数解析">2.1. 参数解析</h2>
<p>kubelet开启了<code>DisableFlagParsing</code>参数，没有使用<code>Cobra</code>框架中的默认参数解析，而是自定义参数解析。</p>
<h3 id="2-1-1-初始化参数和配置">2.1.1. 初始化参数和配置</h3>
<p>初始化参数解析，初始化<code>cleanFlagSet</code>，<code>kubeletFlags</code>，<code>kubeletConfig</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">cleanFlagSet</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">componentKubelet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContinueOnError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetNormalizeFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WordSepNormalizeFunc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kubeletFlags</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewKubeletFlags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewKubeletConfiguration</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="2-1-2-打印帮助信息和版本信息">2.1.2. 打印帮助信息和版本信息</h3>
<p>如果输入非法参数则打印使用帮助信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// initial flag parse, since we disable cobra&#39;s flag parsing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// check if there are non-flag arguments in the command line
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">cmds</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmds</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unknown command: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmds</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>遇到<code>help</code>和<code>version</code>参数则打印相关内容并退出。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// short-circuit on help
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">help</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetBool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;help&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`&#34;help&#34; flag is non-bool, programmer error, please correct`</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">help</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Help</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// short-circuit on verflag
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">verflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintAndExitIfRequested</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">utilflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="2-1-3-kubelet-config">2.1.3. kubelet config</h3>
<p>加载并校验<code>kubelet config</code>。其中包括校验初始化的<code>kubeletFlags</code>，并从<code>kubeletFlags</code>的<code>KubeletConfigFile</code>参数获取<code>kubelet config</code>的内容。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// set feature gates from initial flags-based config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetFromMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FeatureGates</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// validate the initial KubeletFlags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValidateKubeletFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletFlags</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeletFlags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntime</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;remote&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Changed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pod-infra-container-image&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Warning: For remote container runtime, --pod-infra-container-image is ignored in kubelet, which should be set in that remote runtime instead&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// load kubelet config file, if provided
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">configFile</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeletFlags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfigFile</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configFile</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">loadConfigFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configFile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We must enforce flag precedence by re-parsing the command line into the new object.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This is necessary to preserve backwards-compatibility across binary upgrades.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// See issue #56171 for more details.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeletConfigFlagPrecedence</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// update feature gates based on new config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetFromMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FeatureGates</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// We always validate the local configuration (command line + config file).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This is the default &#34;last-known-good&#34; config for dynamic config, and must always remain valid.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeletconfigvalidation</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValidateKubeletConfiguration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-1-4-dynamic-kubelet-config">2.1.4. dynamic kubelet config</h3>
<p>如果开启使用动态kubelet的配置，则由动态配置文件替换kubelet配置文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// use dynamic kubelet config, if enabled
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">kubeletConfigController</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dynamickubeletconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">dynamicConfigDir</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeletFlags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DynamicConfigDir</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Value</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dynamicConfigDir</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">dynamicKubeletConfig</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dynamicKubeletConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletConfigController</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">BootstrapKubeletConfigController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dynamicConfigDir</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Here, we enforce flag precedence inside the controller, prior to the controller&#39;s validation sequence,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// so that we get a complete validation at the same point where we can decide to reject dynamic config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// This fixes the flag-precedence component of issue #63305.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// See issue #56171 for general details on flag precedence.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">kubeletConfigFlagPrecedence</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If we should just use our existing, local config, the controller will return a nil config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">dynamicKubeletConfig</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeletConfig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dynamicKubeletConfig</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Note: flag precedence was already enforced in the controller, prior to validation,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// by our above transform function. Now we simply update feature gates from the new config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetFromMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FeatureGates</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>总结：以上通过对各种特定参数的解析，最终生成<code>kubeletFlags</code>和<code>kubeletConfig</code>两个重要的参数对象，用来构造<code>kubeletServer</code>和其他需求。</p>
<h2 id="2-2-初始化kubeletserver和kubeletdeps">2.2. 初始化kubeletServer和kubeletDeps</h2>
<h3 id="2-2-1-kubeletserver">2.2.1. kubeletServer</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// construct a KubeletServer from kubeletFlags and kubeletConfig
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kubeletServer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletServer</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">KubeletFlags</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletFlags</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-2-2-kubeletdeps">2.2.2. kubeletDeps</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// use kubeletServer to construct the default KubeletDeps
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kubeletDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">UnsecuredDependencies</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// add the kubelet config controller to kubeletDeps
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kubeletDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfigController</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kubeletConfigController</span>
</span></span></code></pre></div><h3 id="2-2-3-docker-shim">2.2.3. docker shim</h3>
<p>如果开启了docker shim参数，则执行<code>RunDockershim</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// start the experimental docker shim, if enabled
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletFlags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExperimentalDockershim</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">RunDockershim</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletFlags</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-addflags">2.3. AddFlags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// keep cleanFlagSet separate, so Cobra doesn&#39;t pollute it with the global flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kubeletFlags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddKubeletConfigFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddGlobalFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BoolP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;help&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;h&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;help for %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ugly, but necessary, because Cobra&#39;s default UsageFunc and HelpFunc pollute the flagset with global flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">usageFmt</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Usage:\n  %s\n\nFlags:\n%s&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetUsageFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStderr</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">usageFmt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseLine</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagUsagesWrapped</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetHelpFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;%s\n\n&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">usageFmt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Long</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseLine</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagUsagesWrapped</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><p>其中：</p>
<ul>
<li><code>AddFlags</code>代码可参考：<a href="https://github.com/kubernetes/kubernetes/blob/0ed33881dc4355495f623c6f22e7dd0b7632b7c0/cmd/kubelet/app/options/options.go#L323">kubernetes/cmd/kubelet/app/options/options.go#L323</a></li>
<li><code>AddKubeletConfigFlags</code>代码可参考：<a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/options/options.go#L424">kubernetes/cmd/kubelet/app/options/options.go#L424</a></li>
</ul>
<h2 id="2-4-运行kubelet">2.4. 运行kubelet</h2>
<p>运行kubelet并且不退出。由Run函数进入后续的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// run the kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KubeletConfiguration: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-run-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kubelet-app-server-go-l406">3. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/server.go#L406">Run</a></h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run runs the specified KubeletServer with the given Dependencies. This should never exit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The kubeDeps argument may be nil - if so, it is initialized from the settings on KubeletServer.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Otherwise, the caller is assumed to have set up the Dependencies object and a default one will
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// not be generated.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dependencies</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// To help debugging, immediately log version
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Version: %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">initForOS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletFlags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WindowsService</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed OS init: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to run Kubelet: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>当运行环境是Windows的时候，初始化操作，但是该操作为空，只是预留。具体执行<code>run(s, kubeDeps, stopCh)</code>函数。</p>
<h2 id="3-1-构造kubedeps">3.1. 构造kubeDeps</h2>
<h3 id="3-1-1-clientconfig">3.1.1. clientConfig</h3>
<p>创建<code>clientConfig</code>，该对象用来创建各种的<code>kubeDeps</code>属性中包含的<code>client</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">clientConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createAPIServerClientConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;invalid kubeconfig: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-2-kubeclient">3.1.2. kubeClient</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;New kubeClient from clientConfig error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertificatesV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">clientCertificateManager</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting client certificate rotation.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">clientCertificateManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetCertificateSigningRequestClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertificatesV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">CertificateSigningRequests</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">clientCertificateManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-3-dynamickubeclient">3.1.3. dynamicKubeClient</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#000">dynamicKubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dynamic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to initialize dynamic KubeClient: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-4-eventclient">3.1.4. eventClient</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// make a separate client for events
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">eventClientConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">clientConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#000">eventClientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QPS</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">float32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventRecordQPS</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">eventClientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Burst</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventBurst</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">eventClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">v1core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">eventClientConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create API Server client for Events: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-5-heartbeatclient">3.1.5. heartbeatClient</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// make a separate client for heartbeat with throttling disabled and a timeout attached
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">heartbeatClientConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">clientConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#000">heartbeatClientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeStatusUpdateFrequency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// if the NodeLease feature is enabled, the timeout is the minimum of the lease duration and status update frequency
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLease</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">leaseTimeout</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLeaseDurationSeconds</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">heartbeatClientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">leaseTimeout</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">heartbeatClientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">leaseTimeout</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">heartbeatClientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QPS</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">float32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">heartbeatClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">heartbeatClientConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create API Server client for heartbeat: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-6-csiclient">3.1.6. csiClient</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// csiClient works with CRDs that support json only
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">clientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContentType</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csiclientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create CSI API client: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>client赋值</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kubeClient</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DynamicKubeClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dynamicKubeClient</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">heartbeatClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HeartbeatClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">heartbeatClient</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnHeartbeatFailure</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">closeAllConns</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">eventClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">eventClient</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CSIClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">csiClient</span>
</span></span></code></pre></div><h3 id="3-1-7-cadvisorinterface">3.1.7. CAdvisorInterface</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CAdvisorInterface</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">imageFsInfoProvider</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cadvisor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewImageFsInfoProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntime</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteRuntimeEndpoint</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CAdvisorInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cadvisor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">imageFsInfoProvider</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RootDirectory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cadvisor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UsingLegacyCadvisorStats</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntime</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteRuntimeEndpoint</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-8-containermanager">3.1.8. ContainerManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerManager</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupsPerQOS</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupRoot</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;--cgroups-per-qos enabled, but --cgroup-root was not specified.  defaulting to /&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupRoot</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeReserved</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">parseResourceList</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeReserved</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">systemReserved</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">parseResourceList</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SystemReserved</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">hardEvictionThresholds</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">evictionapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Threshold</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If the user requested to ignore eviction thresholds, then do not set valid values for hardEvictionThresholds here.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExperimentalNodeAllocatableIgnoreEvictionThreshold</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">hardEvictionThresholds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">eviction</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseThresholdConfig</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EvictionHard</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">experimentalQOSReserved</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseQOSReserved</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QOSReserved</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">devicePluginEnabled</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DevicePlugins</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewContainerManager</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mounter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CAdvisorInterface</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeConfig</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">RuntimeCgroupsName</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RuntimeCgroups</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">SystemCgroupsName</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SystemCgroups</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">KubeletCgroupsName</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletCgroups</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ContainerRuntime</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntime</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">CgroupsPerQOS</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupsPerQOS</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">CgroupRoot</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupRoot</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">CgroupDriver</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupDriver</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">KubeletRootDir</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RootDirectory</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ProtectKernelDefaults</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProtectKernelDefaults</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">NodeAllocatableConfig</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeAllocatableConfig</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">KubeReservedCgroupName</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeReservedCgroup</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">SystemReservedCgroupName</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SystemReservedCgroup</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">EnforceNodeAllocatable</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnforceNodeAllocatable</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">KubeReserved</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">kubeReserved</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">SystemReserved</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">systemReserved</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">HardEvictionThresholds</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">hardEvictionThresholds</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">QOSReserved</span><span style="color:#000;font-weight:bold">:</span>                           <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">experimentalQOSReserved</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ExperimentalCPUManagerPolicy</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CPUManagerPolicy</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ExperimentalCPUManagerReconcilePeriod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CPUManagerReconcilePeriod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ExperimentalPodPidsLimit</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPidsLimit</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">EnforceCPULimits</span><span style="color:#000;font-weight:bold">:</span>                      <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CPUCFSQuota</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">CPUCFSQuotaPeriod</span><span style="color:#000;font-weight:bold">:</span>                     <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CPUCFSQuotaPeriod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailSwapOn</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">devicePluginEnabled</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-9-oomadjuster">3.1.9. oomAdjuster</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO(vmarmol): Do this through container config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">oomAdjuster</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OOMAdjuster</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">oomAdjuster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ApplyOOMScoreAdj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OOMScoreAdj</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-health-check">3.2. Health check</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HealthzPort</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">healthz</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultHealthz</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">JoinHostPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HealthzBindAddress</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Itoa</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HealthzPort</span><span style="color:#000;font-weight:bold">))),</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting health server failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-runkubelet">3.3. RunKubelet</h2>
<p>通过各种赋值构造了完整的<code>kubeDeps</code>结构体，最后再执行<code>RunKubelet</code>转入后续的kubelet执行流程。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">RunKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunOnce</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-runkubelet-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kubelet-app-server-go-l914">4. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/server.go#L914">RunKubelet</a></h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// RunKubelet is responsible for setting up and running a kubelet.  It is used in three different applications:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   1 Integration tests
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   2 Kubelet binary
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   3 Standalone &#39;kubernetes&#39; binary
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Eventually, #2 will be replaced with instances of #3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">RunKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeServer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dependencies</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runOnce</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">CreateAndInitKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeStatusMaxImages</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to create kubelet: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// NewMainKubelet should have set up a pod source config if one didn&#39;t exist
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// when the builder was run. This is just a precaution.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to create kubelet, pod source config was nil&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podCfg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rlimit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RlimitNumFiles</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">uint64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxOpenFiles</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// process pods and exit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">runOnce</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunOnce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Updates</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;runonce failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Started kubelet as runonce&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">startKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableServer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Started kubelet&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><p><code>RunKubelet</code>函数核心代码为执行了<code>CreateAndInitKubelet</code>和<code>startKubelet</code>两个函数的操作，以下对这两个函数进行分析。</p>
<h2 id="4-1-createandinitkubelet">4.1. CreateAndInitKubelet</h2>
<p>通过传入<code>kubeDeps</code>调用<code>CreateAndInitKubelet</code>初始化Kubelet。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">CreateAndInitKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntimeOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntime</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RuntimeCgroups</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostnameOverride</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeIP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProviderID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CloudProvider</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertDirectory</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RootDirectory</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterNode</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterWithTaints</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllowedUnsafeSysctls</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteRuntimeEndpoint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteImageEndpoint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExperimentalMounterPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExperimentalKernelMemcgNotification</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExperimentalCheckNodeCapabilitiesBeforeMount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExperimentalNodeAllocatableIgnoreEvictionThreshold</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MinimumGCAge</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxPerPodContainerCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxContainerCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MasterServiceNamespace</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterSchedulable</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NonMasqueradeCIDR</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeepTerminatedPodVolumes</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLabels</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SeccompProfileRoot</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BootstrapCheckpointPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeStatusMaxImages</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to create kubelet: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-1-1-newmainkubelet">4.1.1. NewMainKubelet</h3>
<p><code>CreateAndInitKubelet</code>方法中执行的核心函数是<code>NewMainKubelet</code>，<code>NewMainKubelet</code>实例化一个<code>kubelet</code>对象，该部分的具体代码在<code>kubernetes/pkg/kubelet</code>中，具体参考：<a href="https://github.com/kubernetes/kubernetes/blob/0ed33881dc4355495f623c6f22e7dd0b7632b7c0/pkg/kubelet/kubelet.go#L325">kubernetes/pkg/kubelet/kubelet.go#L325</a>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">CreateAndInitKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeStatusMaxImages</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bootstrap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: block until all sources have delivered at least one update to the channel, or break the sync loop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// up into &#34;per source&#34; synchronizations
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMainKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">runtimeCgroups</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">hostnameOverride</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeIP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">providerID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cloudProvider</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">certDirectory</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">rootDirectory</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">registerNode</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">registerWithTaints</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">allowedUnsafeSysctls</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">remoteRuntimeEndpoint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">remoteImageEndpoint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">experimentalMounterPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">experimentalKernelMemcgNotification</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">experimentalCheckNodeCapabilitiesBeforeMount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">experimentalNodeAllocatableIgnoreEvictionThreshold</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">minimumGCAge</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">maxPerPodContainerCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">maxContainerCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">masterServiceNamespace</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">registerSchedulable</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nonMasqueradeCIDR</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">keepTerminatedPodVolumes</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeLabels</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">seccompProfileRoot</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">bootstrapCheckpointPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeStatusMaxImages</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BirthCry</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartGarbageCollection</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-1-2-podconfig">4.1.2. PodConfig</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">makePodSourceConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bootstrapCheckpointPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>NewMainKubelet--&gt;PodConfig--&gt;NewPodConfig--&gt;kubetypes.PodUpdate</code>。会生成一个<code>podUpdate</code>的channel来监听pod的变化，该channel会在<code>k.Run(podCfg.Updates())</code>中作为关键入参。</p>
<h2 id="4-2-startkubelet">4.2. startKubelet</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// process pods and exit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">runOnce</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunOnce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Updates</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;runonce failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Started kubelet as runonce&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableServer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Started kubelet&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果设置了只运行一次的参数，则执行<code>k.RunOnce</code>，否则执行核心函数<code>startKubelet</code>。具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">startKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bootstrap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dependencies</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">enableServer</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// start the kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Updates</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// start the kubelet server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">enableServer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseIP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Port</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TLSOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Auth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableDebuggingHandlers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableContentionProfiling</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadOnlyPort</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServeReadOnly</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseIP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadOnlyPort</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-2-1-k-run">4.2.1. k.Run</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// start the kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Updates</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>通过长驻进程的方式运行<code>k.Run</code>，不退出，将kubelet的运行逻辑引入<a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L1382">kubernetes/pkg/kubelet/kubelet.go</a>部分，<code>kubernetes/pkg/kubelet</code>部分的运行逻辑待后续文章分析。</p>
<h1 id="5-总结">5. 总结</h1>
<ol>
<li>
<p>kubelet采用<a href="https://github.com/spf13/cobra">Cobra</a>命令行框架和<a href="https://github.com/spf13/pflag">pflag</a>参数解析框架，和apiserver、scheduler、controller-manager形成统一的代码风格。</p>
</li>
<li>
<p><code>kubernetes/cmd/kubelet</code>部分主要对运行参数进行定义和解析，初始化和构造相关的依赖组件（主要在<code>kubeDeps</code>结构体中），并没有kubelet运行的详细逻辑，该部分位于<code>kubernetes/pkg/kubelet</code>模块。</p>
</li>
<li>
<p>cmd部分调用流程如下：<code>Main--&gt;NewKubeletCommand--&gt;Run(kubeletServer, kubeletDeps, stopCh)--&gt;run(s *options.KubeletServer, kubeDeps ..., stopCh ...)--&gt; RunKubelet(s, kubeDeps, s.RunOnce)--&gt;startKubelet--&gt;k.Run(podCfg.Updates())--&gt;pkg/kubelet</code>。</p>
<p>同时<code>RunKubelet(s, kubeDeps, s.RunOnce)--&gt;CreateAndInitKubelet--&gt;kubelet.NewMainKubelet--&gt;pkg/kubelet</code>。</p>
</li>
</ol>
<p>参考文章：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0">https://github.com/kubernetes/kubernetes/tree/v1.12.0</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f143779d871d6a62ac575beff2e8515b">5.3 - kubelet源码分析（二）之 NewMainKubelet</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
<p>本文主要分析 <a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0/pkg/kubelet">https://github.com/kubernetes/kubernetes/tree/v1.12.0/pkg/kubelet</a> 部分的代码。</p>
</blockquote>
<p>本文主要分析kubelet中的<code>NewMainKubelet</code>部分。</p>
<h1 id="1-newmainkubelet-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l327">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L327">NewMainKubelet</a></h1>
<p><code>NewMainKubelet</code>主要用来初始化和构造一个<code>kubelet</code>结构体，kubelet结构体定义参考:https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L888</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewMainKubelet instantiates a new Kubelet object along with all the required internal modules.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// No initialization of Kubelet and its modules should happen here.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewMainKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Dependencies</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">crOptions</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntimeOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">containerRuntime</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">runtimeCgroups</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">hostnameOverride</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeIP</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">providerID</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cloudProvider</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">certDirectory</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rootDirectory</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">registerNode</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">registerWithTaints</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Taint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">allowedUnsafeSysctls</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">remoteRuntimeEndpoint</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">remoteImageEndpoint</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">experimentalMounterPath</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">experimentalKernelMemcgNotification</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">experimentalCheckNodeCapabilitiesBeforeMount</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">experimentalNodeAllocatableIgnoreEvictionThreshold</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">minimumGCAge</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxPerPodContainerCount</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxContainerCount</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">masterServiceNamespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">registerSchedulable</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nonMasqueradeCIDR</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">keepTerminatedPodVolumes</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeLabels</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">seccompProfileRoot</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">bootstrapCheckpointPath</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeStatusMaxImages</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><h2 id="1-1-podconfig">1.1. PodConfig</h2>
<p>通过<code>makePodSourceConfig</code>生成Pod config。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">makePodSourceConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bootstrapCheckpointPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-1-1-makepodsourceconfig">1.1.1. makePodSourceConfig</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// makePodSourceConfig creates a config.PodConfig from the given
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// KubeletConfiguration or returns an error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">makePodSourceConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Dependencies</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bootstrapCheckpointPath</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// source of all configuration
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPodConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfigNotificationIncremental</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// define file config source
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StaticPodPath</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Adding pod path: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StaticPodPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSourceFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StaticPodPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileCheckFrequency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Channel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileSource</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// define url config source
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StaticPodURL</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Adding pod url %q with HTTP header %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StaticPodURL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">manifestURLHeader</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSourceURL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StaticPodURL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">manifestURLHeader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HTTPCheckFrequency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Channel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HTTPSource</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Restore from the checkpoint path
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// NOTE: This MUST happen before creating the apiserver source
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// below, or the checkpoint would override the source of truth.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Watching apiserver&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">updatechannel</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">updatechannel</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Channel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ApiserverSource</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSourceApiserver</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">updatechannel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-1-2-newpodconfig">1.1.2. NewPodConfig</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewPodConfig creates an object that can merge many configuration sources into a stream
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// of normalized updates to a pod configuration.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewPodConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mode</span> <span style="color:#000">PodConfigNotificationMode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">recorder</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventRecorder</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PodConfig</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">updates</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodUpdate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">storage</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">newPodStorage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">PodConfig</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pods</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">storage</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mux</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMux</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">storage</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">updates</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">updates</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sources</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">podConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-1-3-newsourceapiserver">1.1.3. NewSourceApiserver</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewSourceApiserver creates a config source that watches and pulls from the apiserver.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewSourceApiserver</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">updates</span> <span style="color:#204a87;font-weight:bold">chan</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lw</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewListWatchFromClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;pods&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceAll</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OneTermEqualSelector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodHostField</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">newSourceApiserverFromLW</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">updates</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-2-lister">1.2. Lister</h2>
<p><code>serviceLister</code>和<code>nodeLister</code>分别通过<code>List-Watch</code>机制监听<code>service</code>和<code>node</code>的列表变化。</p>
<h3 id="1-2-1-servicelister">1.2.1. serviceLister</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">serviceIndexer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewIndexer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MetaNamespaceKeyFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Indexers</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceIndex</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MetaNamespaceIndexFunc</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">serviceLW</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewListWatchFromClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;services&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceAll</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Everything</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewReflector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serviceLW</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Service</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">serviceIndexer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">serviceLister</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">corelisters</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServiceLister</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serviceIndexer</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-2-2-nodelister">1.2.2. nodeLister</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">nodeIndexer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewIndexer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MetaNamespaceKeyFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Indexers</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fieldSelector</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectNameField</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)}.</span><span style="color:#000">AsSelector</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeLW</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewListWatchFromClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;nodes&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceAll</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fieldSelector</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewReflector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeLW</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">nodeIndexer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CachedNodeInfo</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">corelisters</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNodeLister</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeIndexer</span><span style="color:#000;font-weight:bold">)}</span>
</span></span></code></pre></div><h2 id="1-3-各种manager">1.3. 各种Manager</h2>
<h3 id="1-3-1-containerrefmanager">1.3.1. containerRefManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">containerRefManager</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRefManager</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="1-3-2-oomwatcher">1.3.2. oomWatcher</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">oomWatcher</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewOOMWatcher</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CAdvisorInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-3-dnsconfigurer">1.3.3. dnsConfigurer</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">clusterDNS</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClusterDNS</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ipEntry</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClusterDNS</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ip</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseIP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ipEntry</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ip</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Invalid clusterDNS ip &#39;%q&#39;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ipEntry</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">clusterDNS</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clusterDNS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ip</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">dns</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewConfigurer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">parsedNodeIP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clusterDNS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClusterDomain</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResolverConfig</span><span style="color:#000;font-weight:bold">),</span>
</span></span></code></pre></div><h3 id="1-3-4-secretmanager-configmapmanager">1.3.4. secretManager &amp; configMapManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">secretManager</span> <span style="color:#000">secret</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">configMapManager</span> <span style="color:#000">configmap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigMapAndSecretChangeDetectionStrategy</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WatchChangeDetectionStrategy</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">secretManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">secret</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewWatchingSecretManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">configMapManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">configmap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewWatchingConfigMapManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TTLCacheChangeDetectionStrategy</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">secretManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">secret</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCachingSecretManager</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetObjectTTLFromNodeFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNode</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">configMapManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">configmap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCachingConfigMapManager</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetObjectTTLFromNodeFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNode</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetChangeDetectionStrategy</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">secretManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">secret</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSimpleSecretManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">configMapManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">configmap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSimpleConfigMapManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unknown configmap and secret manager mode: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigMapAndSecretChangeDetectionStrategy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">secretManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">secretManager</span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">configMapManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">configMapManager</span>
</span></span></code></pre></div><h3 id="1-3-5-livenessmanager">1.3.5. livenessManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">livenessManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">proberesults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="1-3-6-podmanager">1.3.6. podManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// podManager is also responsible for keeping secretManager and configMapManager contents up-to-date.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kubepod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBasicPodManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubepod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBasicMirrorClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">secretManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">configMapManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">checkpointManager</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-7-resourceanalyzer">1.3.7. resourceAnalyzer</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resourceAnalyzer</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">serverstats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewResourceAnalyzer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumeStatsAggPeriod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-8-containergc">1.3.8. containerGC</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// setup containerGC
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">containerGC</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewContainerGC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerGCPolicy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sourcesReady</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerGC</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">containerGC</span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerDeletor</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newPodContainerDeletor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">integer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IntMax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerGCPolicy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxPerPodContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">minDeadContainerInPod</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h3 id="1-3-9-imagemanager">1.3.9. imageManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// setup imageManager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">imageManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">images</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewImageGCManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatsProvider</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">imageGCPolicy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodSandboxImage</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to initialize image manager: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">imageManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">imageManager</span>
</span></span></code></pre></div><h3 id="1-3-10-statusmanager">1.3.10. statusManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-11-probemanager">1.3.11. probeManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">prober</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">livenessManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runner</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">containerRefManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-12-tokenmanager">1.3.12. tokenManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">tokenManager</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">token</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-13-volumepluginmgr">1.3.13. volumePluginMgr</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumePluginMgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NewInitializedVolumePluginMgr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">secretManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">configMapManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tokenManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumePlugins</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DynamicPluginProber</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enablePluginsWatcher</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pluginWatcher</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pluginwatcher</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewWatcher</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPluginsDir</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-3-14-volumemanager">1.3.14. volumeManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// setup volumeManager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">volumemanager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewVolumeManager</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableControllerAttachDetach</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumePluginMgr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mounter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodsDir</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">experimentalCheckNodeCapabilitiesBeforeMount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">keepTerminatedPodVolumes</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-15-evictionmanager">1.3.15. evictionManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// setup eviction manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">evictionManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evictionAdmitHandler</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">eviction</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resourceAnalyzer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evictionConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">killPodNow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">imageManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerGC</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">evictionManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">evictionManager</span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">admitHandlers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPodAdmitHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evictionAdmitHandler</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="1-4-containerruntime">1.4. containerRuntime</h2>
<p>目前pod所使用的<code>runtime</code>只有<code>docker</code>和<code>remote</code>两种，<code>rkt</code>已经废弃。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">containerRuntime</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;rkt&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;rktnetes has been deprecated in favor of rktlet. Please see https://github.com/kubernetes-incubator/rktlet for more information.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>当<code>runtime</code>是<code>docker</code>的时候，会执行<code>docker</code>相关操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">containerRuntime</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DockerContainerRuntime</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Create and start the CRI shim running as a grpc server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// The unix socket for kubelet &lt;-&gt; dockershim communication.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Create dockerLegacyService when the logging driver is not supported.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteContainerRuntime</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// No-op.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unsupported CRI runtime: %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-4-1-newdockerservice">1.4.1. NewDockerService</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create and start the CRI shim running as a grpc server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">streamingConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getStreamingConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dockershim</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDockerService</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DockerClientConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodSandboxImage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">streamingConfig</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pluginSettings</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runtimeCgroups</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupDriver</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DockershimRootDirectory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RedirectContainerStreaming</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RedirectContainerStreaming</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">criHandler</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ds</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-4-2-newdockerserver">1.4.2. NewDockerServer</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The unix socket for kubelet &lt;-&gt; dockershim communication.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RemoteRuntimeEndpoint: %q, RemoteImageEndpoint: %q&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">remoteRuntimeEndpoint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">remoteImageEndpoint</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting the GRPC server for the docker CRI shim.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dockerremote</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDockerServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">remoteRuntimeEndpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-4-3-dockerserver-start">1.4.3. DockerServer.Start</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start starts the dockershim grpc server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DockerServer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the internal service.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unable to start docker service&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Start dockershim grpc server&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">l</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateListener</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endpoint</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to listen on %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Create the grpc server and register runtime and image services.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxRecvMsgSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxMsgSize</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxSendMsgSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxMsgSize</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">runtimeapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterRuntimeServiceServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">runtimeapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterImageServiceServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">l</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to serve connections: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-5-podworker">1.5. podWorker</h2>
<p>构造<code>podWorkers</code>和<code>workQueue</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workQueue</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBasicWorkQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newPodWorkers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncInterval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backOffPeriod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-5-1-podworkers接口">1.5.1. PodWorkers接口</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodWorkers is an abstract interface for testability.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PodWorkers</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ForgetNonExistingPodWorkers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">desiredPods</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ForgetWorker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>podWorker</code>主要用来对pod相应事件进行处理和同步，包含以下三个方法：<code>UpdatePod</code>、<code>ForgetNonExistingPodWorkers</code>、<code>ForgetWorker</code>。</p>
<h1 id="2-总结">2. 总结</h1>
<ol>
<li>
<p><code>NewMainKubelet</code>主要用来构造<code>kubelet</code>结构体，其中kubelet除了包含必要的配置和client（例如：kubeClient、csiClient等）外，最主要的包含各种manager来管理不同的任务。</p>
</li>
<li>
<p>核心的manager有以下几种：</p>
<ul>
<li><code>oomWatcher</code>：监控pod内存是否发生OOM。</li>
<li><code>podManager</code>：管理pod的生命周期，包括对pod的增删改查操作等。</li>
<li><code>containerGC</code>：对死亡容器进行垃圾回收。</li>
<li><code>imageManager</code>：对容器镜像进行垃圾回收。</li>
<li><code>statusManager</code>：与apiserver同步pod状态，同时也作状态缓存。</li>
<li><code>volumeManager</code>：对pod的volume进行<code>attached/detached/mounted/unmounted</code>操作。</li>
<li><code>evictionManager</code>：保证节点稳定，必要时对pod进行驱逐（例如资源不足的情况下）。</li>
</ul>
</li>
<li>
<p><code>NewMainKubelet</code>还包含了<code>serviceLister</code>和<code>nodeLister</code>来监听<code>service</code>和<code>node</code>的列表变化。</p>
</li>
<li>
<p>kubelet使用到的<code>containerRuntime</code>目前主要是<code>docker</code>，其中<code>rkt</code>已废弃。<code>NewMainKubelet</code>启动了<code>dockershim grpc server</code>来执行docker相关操作。</p>
</li>
<li>
<p>构建了<code>podWorker</code>来对pod相关的更新逻辑进行处理。</p>
</li>
</ol>
<p>参考文章：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0">https://github.com/kubernetes/kubernetes/tree/v1.12.0</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0/pkg/kubelet">https://github.com/kubernetes/kubernetes/tree/v1.12.0/pkg/kubelet</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-81cae8093c76076822c064c1cb2ac31c">5.4 - kubelet源码分析（三）之 RunKubelet</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析<code>startKubelet</code>，其中主要是<code>kubelet.Run</code>部分，该部分的内容主要是初始化并运行一些manager。对于kubelet所包含的各种manager的执行逻辑和pod的生命周期管理逻辑待后续文章分析。</p>
<p>后续的文章主要会分类分析<code>pkg/kubelet</code>部分的代码实现。</p>
<p><code>kubelet</code>的<code>pkg</code>代码目录结构：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubelet
</span></span><span style="display:flex;"><span>├── apis  <span style="color:#8f5902;font-style:italic"># 定义一些相关接口</span>
</span></span><span style="display:flex;"><span>├── cadvisor <span style="color:#8f5902;font-style:italic"># cadvisor</span>
</span></span><span style="display:flex;"><span>├── cm <span style="color:#8f5902;font-style:italic"># ContainerManager、cpu manger、cgroup manager </span>
</span></span><span style="display:flex;"><span>├── config
</span></span><span style="display:flex;"><span>├── configmap <span style="color:#8f5902;font-style:italic"># configmap manager</span>
</span></span><span style="display:flex;"><span>├── container  <span style="color:#8f5902;font-style:italic"># Runtime、ImageService</span>
</span></span><span style="display:flex;"><span>├── dockershim  <span style="color:#8f5902;font-style:italic"># docker的相关调用</span>
</span></span><span style="display:flex;"><span>├── eviction <span style="color:#8f5902;font-style:italic"># eviction manager</span>
</span></span><span style="display:flex;"><span>├── images  <span style="color:#8f5902;font-style:italic"># image manager</span>
</span></span><span style="display:flex;"><span>├── kubeletconfig  
</span></span><span style="display:flex;"><span>├── kuberuntime <span style="color:#8f5902;font-style:italic"># 核心：kubeGenericRuntimeManager、runtime容器的相关操作</span>
</span></span><span style="display:flex;"><span>├── lifecycle
</span></span><span style="display:flex;"><span>├── mountpod
</span></span><span style="display:flex;"><span>├── network  <span style="color:#8f5902;font-style:italic"># pod dns</span>
</span></span><span style="display:flex;"><span>├── nodelease
</span></span><span style="display:flex;"><span>├── nodestatus  <span style="color:#8f5902;font-style:italic"># MachineInfo、节点相关信息</span>
</span></span><span style="display:flex;"><span>├── pleg  <span style="color:#8f5902;font-style:italic"># PodLifecycleEventGenerator</span>
</span></span><span style="display:flex;"><span>├── pod  <span style="color:#8f5902;font-style:italic"># 核心：pod manager、mirror pod</span>
</span></span><span style="display:flex;"><span>├── preemption
</span></span><span style="display:flex;"><span>├── qos  <span style="color:#8f5902;font-style:italic"># 资源服务质量，不过暂时内容很少</span>
</span></span><span style="display:flex;"><span>├── remote <span style="color:#8f5902;font-style:italic"># RemoteRuntimeService</span>
</span></span><span style="display:flex;"><span>├── server
</span></span><span style="display:flex;"><span>├── stats <span style="color:#8f5902;font-style:italic"># StatsProvider</span>
</span></span><span style="display:flex;"><span>├── status <span style="color:#8f5902;font-style:italic"># status manager</span>
</span></span><span style="display:flex;"><span>├── types  <span style="color:#8f5902;font-style:italic"># PodUpdate、PodOperation</span>
</span></span><span style="display:flex;"><span>├── volumemanager <span style="color:#8f5902;font-style:italic"># VolumeManager</span>
</span></span><span style="display:flex;"><span>├── kubelet.go  <span style="color:#8f5902;font-style:italic"># 核心: SyncHandler、kubelet的大部分操作</span>
</span></span><span style="display:flex;"><span>├── kubelet_getters.go <span style="color:#8f5902;font-style:italic"># 各种get操作，例如获取相关目录：getRootDir、getPodsDir、getPluginsDir</span>
</span></span><span style="display:flex;"><span>├── kubelet_network.go <span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span>├── kubelet_network_linux.go
</span></span><span style="display:flex;"><span>├── kubelet_node_status.go <span style="color:#8f5902;font-style:italic"># registerWithAPIServer、initialNode、syncNodeStatus</span>
</span></span><span style="display:flex;"><span>├── kubelet_pods.go <span style="color:#8f5902;font-style:italic"># 核心：pod的增删改查等相关操作、podKiller、</span>
</span></span><span style="display:flex;"><span>├── kubelet_resources.go
</span></span><span style="display:flex;"><span>├── kubelet_volumes.go <span style="color:#8f5902;font-style:italic"># ListVolumesForPod、cleanupOrphanedPodDirs</span>
</span></span><span style="display:flex;"><span>├── oom_watcher.go  <span style="color:#8f5902;font-style:italic"># OOMWatcher</span>
</span></span><span style="display:flex;"><span>├── pod_container_deletor.go
</span></span><span style="display:flex;"><span>├── pod_workers.go <span style="color:#8f5902;font-style:italic"># 核心：PodWorkers、UpdatePodOptions、syncPodOptions、managePodLoop</span>
</span></span><span style="display:flex;"><span>├── runonce.go  <span style="color:#8f5902;font-style:italic"># RunOnce</span>
</span></span><span style="display:flex;"><span>├── runtime.go
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h1 id="1-startkubelet-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kubelet-app-server-go-l1018">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/server.go#L1018">startKubelet</a></h1>
<p><code>startKubelet</code>的函数位于<code>cmd/kubelet/app/server.go</code>，启动并运行一个kubelet，运行kubelet的逻辑代码位于<code>pkg/kubelet/kubelet.go</code>。</p>
<p><strong>主要内容如下：</strong></p>
<ol>
<li>运行一个kubelet，执行kubelet中各种manager的相关逻辑。</li>
<li>运行kubelet server启动监听服务。</li>
</ol>
<blockquote>
<p>此部分代码位于cmd/kubelet/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">startKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bootstrap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dependencies</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">enableServer</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// start the kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Updates</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// start the kubelet server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">enableServer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseIP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Port</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TLSOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Auth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableDebuggingHandlers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableContentionProfiling</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadOnlyPort</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServeReadOnly</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseIP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadOnlyPort</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-kubelet-run-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l1382">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L1382">Kubelet.Run</a></h1>
<p><code>Kubelet.Run</code>方法主要将<code>NewMainKubelet</code>构造的各种manager运行起来，让各种manager执行相应的功能，大部分manager为常驻进程的方式运行。</p>
<p>Kubelet.Run完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/kubelet.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run starts the kubelet reacting to config updates
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodUpdate</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logServer</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logServer</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StripPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/logs/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/var/log/&#34;</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;No api server defined - no node status update will be sent.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the cloud provider sync manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cloudResourceSyncManager</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cloudResourceSyncManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">initializeModules</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletSetupFailed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start volume manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sourcesReady</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Start syncing node status immediately, this may set up things the runtime needs to run.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncNodeStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeStatusUpdateFrequency</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fastStatusUpdateOnce</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// start syncing lease
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLease</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeLeaseController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateRuntimeUp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start loop to sync iptables util rules
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">makeIPTablesUtilChains</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncNetworkUtil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Minute</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start a goroutine responsible for killing pods (that are not properly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// handled by pod workers).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podKiller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start component sync loops.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start syncing RuntimeClasses if enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeClassManager</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeClassManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the pod lifecycle event generator.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pleg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<p>以下对<code>Kubelet.Run</code>分段进行分析。</p>
<h1 id="3-initializemodules">3. initializeModules</h1>
<p><code>initializeModules</code>包含了<code>imageManager</code>、<code>serverCertificateManager</code>、<code>oomWatcher</code>和<code>resourceAnalyzer</code>。</p>
<p><strong>主要流程如下：</strong></p>
<ol>
<li>创建文件系统目录，包括kubelet的root目录、pods的目录、plugins的目录和容器日志目录。</li>
<li>启动imageManager、serverCertificateManager、oomWatcher、resourceAnalyzer。</li>
</ol>
<p><strong>各种manager的说明如下：</strong></p>
<ul>
<li><code>imageManager</code>：负责镜像垃圾回收。</li>
<li><code>serverCertificateManager</code>：负责处理证书。</li>
<li><code>oomWatcher</code>：监控内存使用，是否发生内存耗尽。</li>
<li><code>resourceAnalyzer</code>：监控资源使用情况。</li>
</ul>
<p>完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/kubelet.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// initializeModules will initialize internal modules that do not require the container runtime to be up.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Note that the modules here must not depend on modules that are not initialized here.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">initializeModules</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Prometheus metrics.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeCache</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">collectors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewVolumeStatsCollector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Setup filesystem directories.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setupDataDirs</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If the container logs directory does not exist, create it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ContainerLogsDir</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ContainerLogsDir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0755</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create directory %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ContainerLogsDir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the image manager.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">imageManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the certificate manager if it was enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCertificateManager</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCertificateManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start out of memory watcher.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oomWatcher</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeRef</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to start OOM watcher %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start resource analyzer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resourceAnalyzer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-1-setupdatadirs">3.1. setupDataDirs</h2>
<p><code>initializeModules</code>先创建相关目录。</p>
<p>具体目录如下：</p>
<ul>
<li><code>ContainerLogsDir</code>：目录为/var/log/containers。</li>
<li><code>rootDirectory</code>：由参数传入，一般为<code>/var/lib/kubelet</code>。</li>
<li><code>PodsDir</code>：目录为{rootDirectory}/pods。</li>
<li><code>PluginsDir</code>：目录为{rootDirectory}/plugins。</li>
</ul>
<p><strong>initializeModules中setupDataDirs的相关代码如下：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Setup filesystem directories.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setupDataDirs</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If the container logs directory does not exist, create it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ContainerLogsDir</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ContainerLogsDir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0755</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create directory %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ContainerLogsDir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>setupDataDirs代码如下</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// setupDataDirs creates:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 1.  the root directory
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 2.  the pods directory
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 3.  the plugins directory
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">setupDataDirs</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rootDirectory</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Clean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rootDirectory</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getRootDir</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">0750</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error creating root directory: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mounter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MakeRShared</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getRootDir</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error configuring root directory: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodsDir</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">0750</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error creating pods directory: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPluginsDir</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">0750</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error creating plugins directory: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-manager">3.2. manager</h2>
<p><strong>initializeModules中的manager如下：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start the image manager.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">imageManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start the certificate manager if it was enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCertificateManager</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCertificateManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start out of memory watcher.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oomWatcher</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeRef</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to start OOM watcher %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start resource analyzer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resourceAnalyzer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h1 id="4-运行各种manager">4. 运行各种manager</h1>
<h2 id="4-1-volumemanager">4.1. volumeManager</h2>
<p><code>volumeManager</code>主要运行一组异步循环，根据在此节点上安排的pod调整哪些volume需要<code>attached/detached/mounted/unmounted</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start volume manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sourcesReady</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>volumeManager.Run</code>实现代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">vm</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">volumeManager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sourcesReady</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SourcesReady</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">vm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">desiredStateOfWorldPopulator</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sourcesReady</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;The desired_state_of_world populator starts&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting Kubelet Volume Manager&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">vm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reconciler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">actualStateOfWorld</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">desiredStateOfWorld</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumePluginMgr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Shutting down Kubelet Volume Manager&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-2-syncnodestatus">4.2. syncNodeStatus</h2>
<p><code>syncNodeStatus</code>通过goroutine的方式定期执行，它将节点的状态同步给master，必要的时候注册kubelet。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start syncing node status immediately, this may set up things the runtime needs to run.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncNodeStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeStatusUpdateFrequency</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fastStatusUpdateOnce</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// start syncing lease
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLease</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeLeaseController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-3-updateruntimeup">4.3. updateRuntimeUp</h2>
<p><code>updateRuntimeUp</code>调用容器运行时状态回调，在容器运行时首次启动时初始化运行时相关模块，如果状态检查失败则返回错误。 如果状态检查正常，在kubelet runtimeState中更新容器运行时的正常运行时间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateRuntimeUp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="4-4-syncnetworkutil">4.4. syncNetworkUtil</h2>
<p>通过循环的方式同步iptables的规则，不过当前代码并没有执行任何操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start loop to sync iptables util rules
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">makeIPTablesUtilChains</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncNetworkUtil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Minute</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-5-podkiller">4.5. podKiller</h2>
<p>但pod没有被podworker正确处理的时候，启动一个goroutine负责杀死pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start a goroutine responsible for killing pods (that are not properly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// handled by pod workers).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podKiller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>podKiller</code>代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/kubelet_pods.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// podKiller launches a goroutine to kill a pod received from the channel if
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// another goroutine isn&#39;t already in action.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">podKiller</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">killing</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// guard for the killing set
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">lock</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">podPair</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podKillingCh</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">runningPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podPair</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunningPod</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">apiPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podPair</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">APIPod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">exists</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">killing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Has</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">killing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">apiPod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runningPod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Killing unwanted pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">apiPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed killing the pod %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">killing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">apiPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-6-statusmanager">4.6. statusManager</h2>
<p>使用apiserver同步pods状态; 也用作状态缓存。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start component sync loops.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><code>statusManager.Start</code>的实现代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">manager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Don&#39;t start the status manager if we don&#39;t have a client. This will happen
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// on the master, where the kubelet is responsible for bootstrapping the pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// of the master components.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Kubernetes client is nil, not starting status manager.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting to sync pod status with apiserver&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">syncTicker</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Tick</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncPeriod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// syncPod and syncBatch share the same go routine to avoid sync races.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Forever</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">syncRequest</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podStatusChannel</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Status Manager: syncing pod: %q, with status: (%d, %v) from podStatusChannel&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">syncRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podUID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">version</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podUID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">syncTicker</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncBatch</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-7-probemanager">4.7. probeManager</h2>
<p>处理容器探针</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h2 id="4-8-runtimeclassmanager">4.8. runtimeClassManager</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start syncing RuntimeClasses if enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeClassManager</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeClassManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-9-podlifecycleeventgenerator">4.9. PodLifecycleEventGenerator</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start the pod lifecycle event generator.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pleg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><code>PodLifecycleEventGenerator</code>是一个pod生命周期时间生成器接口，具体如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodLifecycleEventGenerator contains functions for generating pod life cycle events.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PodLifecycleEventGenerator</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PodLifecycleEvent</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Healthy</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>start方法具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start spawns a goroutine to relist periodically.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">GenericPLEG</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relist</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relistPeriod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-10-syncloop">4.10. syncLoop</h2>
<p>最后调用<code>syncLoop</code>来执行同步变化变更的循环。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="5-syncloop">5. syncLoop</h1>
<p><code>syncLoop</code>是处理变化的循环。 它监听来自三种channel（file，apiserver和http）的更改。 对于看到的任何新更改，将针对所需状态和运行状态运行同步。 如果没有看到配置的变化，将在每个同步频率秒同步最后已知的所需状态。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// syncLoop is the main loop for processing changes. It watches for changes from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// three channels (file, apiserver, and http) and creates a union of them. For
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// any new change seen, will run a sync against desired state and running state. If
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// no changes are seen to the configuration, will synchronize the last known desired
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// state every sync-frequency seconds. Never returns.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodUpdate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#000">SyncHandler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting kubelet main sync loop.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// The resyncTicker wakes up kubelet to checks if there are any pod workers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// that need to be sync&#39;d. A one-second period is sufficient because the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// sync interval is defaulted to 10s.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">syncTicker</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTicker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">syncTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">housekeepingTicker</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTicker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">housekeepingPeriod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">housekeepingTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">plegCh</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pleg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">base</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">max</span>    <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factor</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">duration</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">base</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeState</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeErrors</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;skipping pod synchronization - %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// exponential backoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">duration</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">duration</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">factor</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">duration</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// reset backoff if we have a success
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">duration</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">base</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoopMonitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoopIteration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">C</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">housekeepingTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">C</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plegCh</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoopMonitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中调用了<code>syncLoopIteration</code>的函数来执行更具体的监控pod变化的循环。<code>syncLoopIteration</code>代码逻辑待后续单独分析。</p>
<h1 id="6-总结">6. 总结</h1>
<h2 id="6-1-基本流程">6.1. 基本流程</h2>
<p><code>Kubelet.Run</code>主要流程如下：</p>
<ol>
<li>初始化模块，其实就是运行<code>imageManager</code>、<code>serverCertificateManager</code>、<code>oomWatcher</code>、<code>resourceAnalyzer</code>。</li>
<li>运行各种manager，大部分以常驻goroutine的方式运行，其中包括<code>volumeManager</code>、<code>statusManager</code>等。</li>
<li>执行处理变更的循环函数<code>syncLoop</code>，对pod的生命周期进行管理。</li>
</ol>
<p><strong>syncLoop：</strong></p>
<p><code>syncLoop</code>函数，对pod的生命周期进行管理，其中<code>syncLoop</code>调用了<code>syncLoopIteration</code>函数，该函数根据<code>podUpdate</code>的信息，针对不同的操作，由<code>SyncHandler</code>来执行pod的增删改查等生命周期的管理，其中的<code>syncHandler</code>包括<code>HandlePodSyncs</code>和<code>HandlePodCleanups</code>等。该部分逻辑待后续文章具体分析。</p>
<h2 id="6-2-manager">6.2. Manager</h2>
<p>以下介绍kubelet运行时涉及到的manager的内容。</p>
<table>
<thead>
<tr>
<th>manager</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>imageManager</td>
<td>负责镜像垃圾回收</td>
</tr>
<tr>
<td>serverCertificateManager</td>
<td>负责处理证书</td>
</tr>
<tr>
<td>oomWatcher</td>
<td>监控内存使用，是否发生内存耗尽即OOM</td>
</tr>
<tr>
<td>resourceAnalyzer</td>
<td>监控资源使用情况</td>
</tr>
<tr>
<td>volumeManager</td>
<td>对pod执行<code>attached/detached/mounted/unmounted</code>操作</td>
</tr>
<tr>
<td>statusManager</td>
<td>使用apiserver同步pods状态; 也用作状态缓存</td>
</tr>
<tr>
<td>probeManager</td>
<td>处理容器探针</td>
</tr>
<tr>
<td>runtimeClassManager</td>
<td>同步RuntimeClasses</td>
</tr>
<tr>
<td>podKiller</td>
<td>负责杀死pod</td>
</tr>
</tbody>
</table>
<p>参考文章：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/server.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/server.go</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a2b7e6297d422710a490f3a64d66c478">5.5 - kubelet源码分析（四）之 syncLoopIteration</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析kubelet中<code>syncLoopIteration</code>部分。<code>syncLoopIteration</code>通过几种<code>channel</code>来对不同类型的事件进行监听并做增删改查的处理。</p>
<h1 id="1-syncloop">1. syncLoop</h1>
<p><code>syncLoop</code>是处理变更的循环。 它监听来自三种channel（file，apiserver和http）的更改。 对于看到的任何新更改，将针对所需状态和运行状态运行同步。 如果没有看到配置的变化，将在每个同步频率秒同步最后已知的所需状态。</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/kubelet.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// syncLoop is the main loop for processing changes. It watches for changes from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// three channels (file, apiserver, and http) and creates a union of them. For
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// any new change seen, will run a sync against desired state and running state. If
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// no changes are seen to the configuration, will synchronize the last known desired
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// state every sync-frequency seconds. Never returns.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodUpdate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#000">SyncHandler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting kubelet main sync loop.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// The resyncTicker wakes up kubelet to checks if there are any pod workers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// that need to be sync&#39;d. A one-second period is sufficient because the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// sync interval is defaulted to 10s.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">syncTicker</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTicker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">syncTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">housekeepingTicker</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTicker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">housekeepingPeriod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">housekeepingTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">plegCh</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pleg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">base</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">max</span>    <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factor</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">duration</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">base</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeState</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeErrors</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;skipping pod synchronization - %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// exponential backoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">duration</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">duration</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">factor</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">duration</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// reset backoff if we have a success
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">duration</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">base</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoopMonitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoopIteration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">C</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">housekeepingTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">C</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plegCh</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoopMonitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中调用了<code>syncLoopIteration</code>的函数来执行更具体的监控pod变化的循环。</p>
<h1 id="2-syncloopiteration-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l1870">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L1870">syncLoopIteration</a></h1>
<p><code>syncLoopIteration</code>主要通过几种<code>channel</code>来对不同类型的事件进行监听并处理。其中包括：<code>configCh</code>、<code>plegCh</code>、<code>syncCh</code>、<code>houseKeepingCh</code>、<code>livenessManager.Updates()</code>。</p>
<p><code>syncLoopIteration</code>实际执行了pod的操作，此部分设置了几种不同的channel:</p>
<ul>
<li><code>configCh</code>：将配置更改的pod分派给事件类型的相应处理程序回调。</li>
<li><code>plegCh</code>：更新runtime缓存，同步pod。</li>
<li><code>syncCh</code>：同步所有等待同步的pod。</li>
<li><code>houseKeepingCh</code>：触发清理pod。</li>
<li><code>livenessManager.Updates()</code>：对失败的pod或者liveness检查失败的pod进行sync操作。</li>
</ul>
<blockquote>
<p>syncLoopIteration部分代码位于pkg/kubelet/kubelet.go</p>
</blockquote>
<h2 id="2-1-configch">2.1. configCh</h2>
<p><code>configCh</code>将配置更改的pod分派给事件类型的相应处理程序回调，该部分主要通过<code>SyncHandler</code>对pod的不同事件进行增删改查等操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncLoopIteration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodUpdate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#000">SyncHandler</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">syncCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">housekeepingCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plegCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pleg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodLifecycleEvent</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">open</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">configCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Update from a config source; dispatch it to the right handler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// callback.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">open</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Update channel is closed. Exiting the sync loop.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Op</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ADD</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (ADD, %q): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// After restarting, kubelet will get all existing pods through
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// ADD as if they are new pods. These pods will then go through the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// admission process and *may* be rejected. This can be resolved
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// once we have checkpointing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodAdditions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UPDATE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (UPDATE, %q): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodsWithDeletionTimestamps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodUpdates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">REMOVE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (REMOVE, %q): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodRemoves</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RECONCILE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (RECONCILE, %q): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodReconcile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DELETE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (DELETE, %q): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// DELETE is treated as a UPDATE because of graceful deletion.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodUpdates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RESTORE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (RESTORE, %q): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// These are pods restored from the checkpoint. Treat them as new
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodAdditions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SET</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// TODO: Do we want to support this?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Kubelet does not support snapshot update&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>可以看出<code>syncLoopIteration</code>根据<code>podUpdate</code>的值来执行不同的pod操作，具体如下：</p>
<ul>
<li><code>ADD</code>：HandlePodAdditions</li>
<li><code>UPDATE</code>：HandlePodUpdates</li>
<li><code>REMOVE</code>：HandlePodRemoves</li>
<li><code>RECONCILE</code>：HandlePodReconcile</li>
<li><code>DELETE</code>：HandlePodUpdates</li>
<li><code>RESTORE</code>：HandlePodAdditions</li>
<li><code>podsToSync</code>：HandlePodSyncs</li>
</ul>
<p>其中执行pod的handler操作的是<code>SyncHandler</code>，该类型是一个接口，实现体为kubelet本身，具体见后续分析。</p>
<h2 id="2-2-plegch">2.2. plegCh</h2>
<p><code>plegCh</code>：更新runtime缓存，同步pod。此处调用了<code>HandlePodSyncs</code>的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">plegCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isSyncPodWorthy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// PLEG event for a pod; sync it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodByUID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (PLEG): %q, event: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodSyncs</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// If the pod no longer exists, ignore the event.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (PLEG): ignore irrelevant event: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">pleg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerDied</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Data</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cleanUpContainersInPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-syncch">2.3. syncCh</h2>
<p><code>syncCh</code>：同步所有等待同步的pod。此处调用了<code>HandlePodSyncs</code>的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">syncCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Sync pods waiting for sync
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">podsToSync</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodsToSync</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podsToSync</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (SYNC): %d pods; %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podsToSync</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podsToSync</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodSyncs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podsToSync</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-4-livenessmanager-update">2.4. livenessManager.Update</h2>
<p><code>livenessManager.Updates()</code>：对失败的pod或者liveness检查失败的pod进行sync操作。此处调用了<code>HandlePodSyncs</code>的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">update</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">livenessManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Updates</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Result</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">proberesults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Failure</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// The liveness manager detected a failure; sync the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// We should not use the pod from livenessManager, because it is never updated after
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// initialization.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodByUID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodUID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// If the pod no longer exists, ignore the update.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (container unhealthy): ignore irrelevant update: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (container unhealthy): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodSyncs</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-5-housekeepingch">2.5. housekeepingCh</h2>
<p><code>houseKeepingCh</code>：触发清理pod。此处调用了<code>HandlePodCleanups</code>的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">housekeepingCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sourcesReady</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllReady</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// If the sources aren&#39;t ready or volume manager has not yet synced the states,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// skip housekeeping, as we may accidentally delete pods from unready sources.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (housekeeping, skipped): sources aren&#39;t ready yet.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (housekeeping)&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodCleanups</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed cleaning pods: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-synchandler-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l177">3. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L177">SyncHandler</a></h1>
<p><code>SyncHandler</code>是一个定义Pod的不同Handler的接口，具体是实现者是<code>kubelet</code>，该接口的方法主要在<a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L1870">syncLoopIteration</a>中调用，接口定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// SyncHandler is an interface implemented by Kubelet, for testability
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">SyncHandler</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">HandlePodAdditions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">HandlePodUpdates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">HandlePodRemoves</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">HandlePodReconcile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">HandlePodSyncs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">HandlePodCleanups</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p>SyncHandler部分代码位于pkg/kubelet/kubelet.go</p>
</blockquote>
<h2 id="3-1-handlepodadditions-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l2021">3.1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L2021">HandlePodAdditions</a></h2>
<p><code>HandlePodAdditions</code>先根据pod创建时间对pod进行排序，然后遍历pod列表，来执行pod的相关操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandlePodAdditions is the callback in SyncHandler for pods being added from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// a config source.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandlePodAdditions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sort</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sliceutils</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodsByCreationTime</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>将pod添加到pod manager中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Responsible for checking limits in resolv.conf
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dnsConfigurer</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dnsConfigurer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResolverConfig</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dnsConfigurer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckLimitsForResolvConf</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">existingPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPods</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Always add the pod to the pod manager. Kubelet relies on the pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// manager as the source of truth for the desired state. If a pod does
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// not exist in the pod manager, it means that it has been deleted in
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the apiserver and no action (other than cleanup) is required.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>如果是mirror pod，则对mirror pod进行处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubepod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handleMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果当前pod的状态不是<code>Terminated</code>状态，则判断是否接受该pod，如果不接受则将pod状态改为<code>Failed</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podIsTerminated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Only go through the admission process if the pod is not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// terminated.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We failed pods that we rejected, so activePods include all admitted
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// pods that are alive.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">activePods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filterOutTerminatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">existingPods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Check if we can admit the pod; if not, reject it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ok</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reason</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">canAdmitPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">activePods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rejectPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reason</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>执行<code>dispatchWork</code>函数，该函数是syncHandler中调用到的核心函数，该函数在pod worker中启动一个异步循环，来分派pod的相关操作。该函数的具体操作待后续分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMirrorPodByPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dispatchWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodCreate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>最后加pod添加到probe manager中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="3-2-handlepodupdates-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l2063">3.2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L2063">HandlePodUpdates</a></h2>
<p><code>HandlePodUpdates</code>同样遍历pod列表，执行相应的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandlePodUpdates is the callback in the SyncHandler interface for pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// being updated from a config source.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandlePodUpdates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>将pod更新到pod manager中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Responsible for checking limits in resolv.conf
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dnsConfigurer</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dnsConfigurer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResolverConfig</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dnsConfigurer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckLimitsForResolvConf</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>如果是mirror pod，则对mirror pod进行处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubepod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handleMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>执行<code>dispatchWork</code>函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: Evaluate if we need to validate and reject updates.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMirrorPodByPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dispatchWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodUpdate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="3-3-handlepodremoves-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l2084">3.3. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L2084">HandlePodRemoves</a></h2>
<p><code>HandlePodRemoves</code>遍历pod列表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandlePodRemoves is the callback in the SyncHandler interface for pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// being removed from a config source.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandlePodRemoves</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>从pod manager中删除pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>如果是mirror pod，则对mirror pod进行处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubepod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handleMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>调用kubelet的<code>deletePod</code>函数来删除pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Deletion is allowed to fail because the periodic cleanup routine
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// will trigger deletion again.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to delete pod %q, err: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>deletePod</code> 函数将需要删除的pod加入<code>podKillingCh</code>的channel中，有<code>podKiller</code>监听这个channel去执行删除任务，实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// deletePod deletes the pod from the internal state of the kubelet by:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 1.  stopping the associated pod worker asynchronously
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 2.  signaling to kill the pod by sending on the podKillingCh channel
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// deletePod returns an error if not all sources are ready or the pod is not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// found in the runtime cache.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">deletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;deletePod does not allow nil pod&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sourcesReady</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllReady</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// If the sources aren&#39;t ready, skip deletion, as we may accidentally delete pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// for sources that haven&#39;t reported yet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;skipping delete because sources aren&#39;t ready yet&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ForgetWorker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Runtime cache may not have been updated to with the pod, but it&#39;s okay
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// because the periodic cleanup routine will attempt to delete again later.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">runningPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPods</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error listing containers: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">runningPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runningPods</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">FindPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsEmpty</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pod not found&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podPair</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPair</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">APIPod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">RunningPod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podKillingCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">podPair</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: delete the mirror pod here?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We leave the volume/directory cleanup to the periodic cleanup routine.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>从probe manager中移除pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="3-4-handlepodreconcile-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l2103">3.4. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L2103">HandlePodReconcile</a></h2>
<p>遍历pod列表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandlePodReconcile is the callback in the SyncHandler interface for pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// that should be reconciled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandlePodReconcile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>   
</span></span></code></pre></div><p>将pod更新到pod manager中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Update the pod in pod manager, status manager will do periodically reconcile according
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// to the pod manager.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>必要时调整pod的<code>Ready</code>状态，执行<code>dispatchWork</code>函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Reconcile Pod &#34;Ready&#34; condition if necessary. Trigger sync pod for reconciliation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeedToReconcilePodReadiness</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMirrorPodByPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dispatchWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodSync</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果pod被设定为需要被驱逐的，则删除pod中的容器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// After an evicted pod is synced, all dead containers in the pod can be removed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">eviction</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodIsEvicted</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerDeletor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteContainersInPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-5-handlepodsyncs-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l2127">3.5. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L2127">HandlePodSyncs</a></h2>
<p><code>HandlePodSyncs</code>是<code>syncHandler</code>接口回调函数，调用<code>dispatchWork</code>，通过pod worker来执行任务。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandlePodSyncs is the callback in the syncHandler interface for pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// that should be dispatched to pod workers for sync.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandlePodSyncs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMirrorPodByPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dispatchWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodSync</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-6-handlepodcleanups-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-pods-go-l979">3.6. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet_pods.go#L979">HandlePodCleanups</a></h2>
<p><code>HandlePodCleanups</code>主要用来执行pod的清理任务，其中包括<code>terminating</code>的pod，<code>orphaned</code>的pod等。</p>
<p>首先查看pod使用到的cgroup。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandlePodCleanups performs a series of cleanup work, including terminating
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pod workers, killing unwanted pods, and removing orphaned volumes/pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// directories.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NOTE: This function is executed by the main sync loop, so it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// should not contain any blocking calls.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandlePodCleanups</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// The kubelet lacks checkpointing, so we need to introspect the set of pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// in the cgroup tree prior to inspecting the set of pods in our pod manager.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// this ensures our view of the cgroup tree does not mistakenly observe pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// that are added after the fact...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cgroupPods</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span>        <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cgroupsPerQOS</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pcm</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPodContainerManager</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cgroupPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetAllPodsFromCgroups</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to get list of pods that still exist on cgroup mounts: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>列出所有pod包括mirror pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">allPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodsAndMirrorPods</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Pod phase progresses monotonically. Once a pod has reached a final state,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// it should never leave regardless of the restart policy. The statuses
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// of such pods should not be changed, and there is no need to sync them.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: the logic here does not handle two cases:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   1. If the containers were removed immediately after they died, kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      may fail to generate correct statuses, let alone filtering correctly.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   2. If kubelet restarted before writing the terminated status for a pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      to the apiserver, it could still restart the terminated pod (even
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      though the pod was not considered terminated by the apiserver).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// These two conditions could be alleviated by checkpointing kubelet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">activePods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filterOutTerminatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allPods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">desiredPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">activePods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">desiredPods</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">empty</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>pod worker停止不再存在的pod的任务，并从probe manager中清除pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Stop the workers for no-longer existing pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: is here the best place to forget pod workers?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ForgetNonExistingPodWorkers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">desiredPods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CleanupPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">activePods</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>将需要杀死的pod加入到<code>podKillingCh</code>的channel中，<code>podKiller</code>的任务会监听该channel并获取需要杀死的pod列表来执行杀死pod的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">runningPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPods</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error listing containers: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">runningPods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">found</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">desiredPods</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">found</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podKillingCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPair</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">APIPod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">RunningPod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>当pod不再被绑定到该节点，移除<code>podStatus</code>，其中<code>removeOrphanedPodStatuses</code>最后调用的函数是<code>statusManager</code>的<code>RemoveOrphanedStatuses</code>方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">removeOrphanedPodStatuses</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPods</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>移除所有的orphaned volume。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Remove any orphaned volumes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Note that we pass all pods (including terminated pods) to the function,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// so that we don&#39;t remove volumes associated with terminated but not yet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// deleted pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cleanupOrphanedPodDirs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runningPods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We want all cleanup tasks to be run even if one of them failed. So
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// we just log an error here and continue other cleanup tasks.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This also applies to the other clean up tasks.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed cleaning up orphaned pod directories: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>移除mirror pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Remove any orphaned mirror pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOrphanedMirrorPods</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>删除不再运行的pod的cgroup。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Remove any cgroups in the hierarchy for pods that are no longer running.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cgroupsPerQOS</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cleanupOrphanedPodCgroups</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cgroupPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">activePods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>执行垃圾回收（GC）操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">backOff</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GC</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h1 id="4-dispatchwork-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l1981">4. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L1981">dispatchWork</a></h1>
<p><code>dispatchWork</code>通过pod worker启动一个异步的循环。</p>
<p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// dispatchWork starts the asynchronous sync of the pod in a pod worker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If the pod is terminated, dispatchWork
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">dispatchWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncType</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podIsTerminated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// If the pod is in a terminated state, there is no pod worker to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// handle the work item. Check if the DeletionTimestamp has been
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// set, and force a status update to trigger a pod deletion request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// to the apiserver.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TerminatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Run the sync in an async worker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MirrorPod</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateType</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">syncType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">OnCompleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodWorkerLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncType</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Note the number of containers for new pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">syncType</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodCreate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainersPerPodCount</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Containers</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下分段进行分析：</p>
<p>如果pod的状态是处于<code>Terminated</code>状态，则执行<code>statusManager</code>的<code>TerminatePod</code>操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// dispatchWork starts the asynchronous sync of the pod in a pod worker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If the pod is terminated, dispatchWork
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">dispatchWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncType</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podIsTerminated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// If the pod is in a terminated state, there is no pod worker to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// handle the work item. Check if the DeletionTimestamp has been
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// set, and force a status update to trigger a pod deletion request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// to the apiserver.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TerminatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>执行pod worker的<code>UpdatePod</code>函数，该函数是pod worker的核心函数，来执行pod相关操作。具体逻辑待下文分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run the sync in an async worker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MirrorPod</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateType</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">syncType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OnCompleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodWorkerLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncType</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><p>当创建类型是<code>SyncPodCreate</code>（即创建pod的时候），统计新pod中容器的数目。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Note the number of containers for new pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">syncType</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodCreate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainersPerPodCount</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Containers</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-podworkers-updatepod-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-pod-workers-go-l195">5. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go#L195">PodWorkers.UpdatePod</a></h1>
<p>PodWorkers是一个接口类型：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodWorkers is an abstract interface for testability.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PodWorkers</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ForgetNonExistingPodWorkers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">desiredPods</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ForgetWorker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中<code>UpdatePod</code>是一个核心方法，通过<code>podUpdates</code>的channel来传递需要处理的pod信息，对于新创建的pod每个pod都会由一个goroutine来执行<code>managePodLoop</code>。</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/pod_workers.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Apply the new setting to the specified pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If the options provide an OnCompleteFunc, the function is invoked if the update is accepted.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Update requests are ignored if a kill pod request is pending.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">podUpdates</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">UpdatePodOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">exists</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podUpdates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podUpdates</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">uid</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// We need to have a buffer here, because checkForUpdates() method that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// puts an update into channel is called from the same goroutine where
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// the channel is consumed. However, it is guaranteed that in such case
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// the channel is empty, so buffer of size 1 is enough.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">podUpdates</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podUpdates</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">uid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">podUpdates</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Creating a new pod worker either means this is a new pod, or that the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// kubelet just restarted. In either case the kubelet is willing to believe
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// the status of the pod for the first pod worker sync. See corresponding
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// comment in syncPod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">managePodLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podUpdates</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isWorking</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isWorking</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podUpdates</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// if a request to kill a pod is pending, we do not let anything overwrite that request.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">update</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">found</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastUndeliveredWorkUpdate</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">found</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateType</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodKill</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastUndeliveredWorkUpdate</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="6-managepodloop-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-pod-workers-go-l153">6. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go#L153">managePodLoop</a></h1>
<p><code>managePodLoop</code>通过读取<code>podUpdates</code>channel的信息，执行<code>syncPodFn</code>函数，而<code>syncPodFn</code>函数在<code>newPodWorkers</code>的时候赋值了，即<code>kubelet.syncPod</code>。<code>kubelet.syncPod</code>具体代码逻辑待后续文章单独分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// newPodWorkers传入syncPod函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newPodWorkers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncInterval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backOffPeriod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>newPodWorkers</code>函数参考：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">newPodWorkers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncPodFn</span> <span style="color:#000">syncPodFnType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">recorder</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventRecorder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">workQueue</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">resyncInterval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backOffPeriod</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podCache</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cache</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podWorkers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podUpdates</span><span style="color:#000;font-weight:bold">:</span>                <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">isWorking</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">lastUndeliveredWorkUpdate</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">syncPodFn</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">syncPodFn</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// 构造传入klet.syncPod函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">workQueue</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">workQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">resyncInterval</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">resyncInterval</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">backOffPeriod</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">backOffPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>managePodLoop</code>函数参考：</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/pod_workers.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">managePodLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podUpdates</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">lastSyncTime</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">update</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podUpdates</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">podUID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// This is a blocking call that would return only if the cache
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// has an entry for the pod that is newer than minRuntimeCache
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// Time. This ensures the worker doesn&#39;t start syncing until
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// after the cache is at least newer than the finished time of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// the previous sync.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNewerThan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podUID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastSyncTime</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// This is the legacy event thrown by manage pod loop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#8f5902;font-style:italic">// all other events are now dispatched from syncPodFn
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedSync</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error determining status: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncPodFn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncPodOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MirrorPod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">pod</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">killPodOptions</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KillPodOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">updateType</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lastSyncTime</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// notify the call-back function if the operation succeeded or not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnCompleteFunc</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnCompleteFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// IMPORTANT: we do not log errors here, the syncPodFn is responsible for logging errors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error syncing pod %s (%q), skipping: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrapUp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="7-总结">7. 总结</h1>
<p><code>syncLoopIteration</code>基本流程如下：</p>
<ol>
<li>通过几种<code>channel</code>来对不同类型的事件进行监听并处理。其中channel包括：<code>configCh</code>、<code>plegCh</code>、<code>syncCh</code>、<code>houseKeepingCh</code>、<code>livenessManager.Updates()</code>。</li>
<li>不同的SyncHandler执行不同的增删改查操作。</li>
<li>其中<code>HandlePodAdditions</code>、<code>HandlePodUpdates</code>、<code>HandlePodReconcile</code>、<code>HandlePodSyncs</code>都调用到了<code>dispatchWork</code>来执行pod的相关操作。<code>HandlePodCleanups</code>的pod清理任务，通过channel的方式加需要清理的pod给<code>podKiller</code>来清理。</li>
<li><code>dispatchWork</code>调用<code>podWorkers.UpdatePod</code>执行异步操作。</li>
<li><code>podWorkers.UpdatePod</code>中调用<code>managePodLoop</code>来执行pod相关操作循环。</li>
</ol>
<p><strong>channel类型及作用：</strong></p>
<ul>
<li><code>configCh</code>：将配置更改的pod分派给事件类型的相应处理程序回调。</li>
<li><code>plegCh</code>：更新runtime缓存，同步pod。</li>
<li><code>syncCh</code>：同步所有等待同步的pod。</li>
<li><code>houseKeepingCh</code>：触发清理pod。</li>
<li><code>livenessManager.Updates()</code>：对失败的pod或者liveness检查失败的pod进行sync操作。</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-46bab922ea9b5daead85570c299c80aa">5.6 - kubelet源码分析（五）之 syncPod</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析<code>kubelet</code>中<code>syncPod</code>的部分。</p>
<h1 id="1-managepodloop-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-pod-workers-go-l153">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go#L153">managePodLoop</a></h1>
<p><code>managePodLoop</code>通过读取<code>podUpdates</code>channel的信息，执行<code>syncPodFn</code>函数，而<code>syncPodFn</code>函数在<code>newPodWorkers</code>的时候赋值了，即<code>kubelet.syncPod</code>。</p>
<p>managePodLoop完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/pod_workers.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">managePodLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podUpdates</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">lastSyncTime</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">update</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podUpdates</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">podUID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// This is a blocking call that would return only if the cache
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// has an entry for the pod that is newer than minRuntimeCache
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// Time. This ensures the worker doesn&#39;t start syncing until
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// after the cache is at least newer than the finished time of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// the previous sync.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNewerThan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podUID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastSyncTime</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// This is the legacy event thrown by manage pod loop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#8f5902;font-style:italic">// all other events are now dispatched from syncPodFn
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedSync</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error determining status: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// 该部分的syncPodFn实际上的实现函数是kubelet.syncPod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncPodFn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncPodOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MirrorPod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">pod</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">killPodOptions</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KillPodOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">updateType</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lastSyncTime</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// notify the call-back function if the operation succeeded or not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnCompleteFunc</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnCompleteFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// IMPORTANT: we do not log errors here, the syncPodFn is responsible for logging errors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error syncing pod %s (%q), skipping: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrapUp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下分析<code>syncPod</code>相关逻辑。</p>
<h1 id="2-syncpod-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l1465">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L1465">syncPod</a></h1>
<p><code>syncPod</code>可以理解为是一个单个pod进行同步任务的事务脚本。其中入参是<code>syncPodOptions</code>，<code>syncPodOptions</code>记录了需要同步的pod的相关信息。具体定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// syncPodOptions provides the arguments to a SyncPod operation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">syncPodOptions</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// the mirror pod for the pod to sync, if it is a static pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">mirrorPod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// pod to sync
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// the type of update (create, update, sync)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">updateType</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodType</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// the current status
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">podStatus</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodStatus</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// if update type is kill, use the specified options to kill the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">killPodOptions</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">KillPodOptions</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>syncPod</code>主要执行以下的工作流：</p>
<ul>
<li>如果是正在创建的pod，则记录pod worker的启动<code>latency</code>。</li>
<li>调用<code>generateAPIPodStatus</code>为pod提供<code>v1.PodStatus</code>信息。</li>
<li>如果pod是第一次运行，记录pod的启动<code>latency</code>。</li>
<li>更新<code>status manager</code>中的pod状态。</li>
<li>如果pod不应该被运行则杀死pod。</li>
<li>如果pod是一个<code>static pod</code>，并且没有对应的<code>mirror pod</code>，则创建一个<code>mirror pod</code>。</li>
<li>如果没有pod的数据目录则给pod创建对应的数据目录。</li>
<li>等待volume被attach或mount。</li>
<li>获取pod的secret数据。</li>
<li>调用<code>container runtime</code>的<code>SyncPod</code>函数，执行相关pod操作。</li>
<li>更新pod的<code>ingress</code>和<code>egress</code>的<code>traffic limit</code>。</li>
</ul>
<p>当以上任务流中有任何的error，则return error。在下一次执行<code>syncPod</code>的任务流会被再次执行。对于错误信息会被记录到event中，方便debug。</p>
<p>以下对<code>syncPod</code>的执行过程进行分析。</p>
<blockquote>
<p>syncPod的代码位于pkg/kubelet/kubelet.go</p>
</blockquote>
<h2 id="2-1-syncpodkill">2.1. SyncPodKill</h2>
<p>首先，获取<code>syncPodOptions</code>的pod信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span> <span style="color:#000">syncPodOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// pull out the required options
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mirrorPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mirrorPod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podStatus</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">updateType</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateType</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>如果pod是需要被杀死的，则执行<code>killPod</code>，会在指定的宽限期内杀死pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// if we want to kill a pod, do it now!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">updateType</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodKill</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">killPodOptions</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killPodOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">killPodOptions</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">killPodOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodStatusFunc</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kill pod options are required if update type is kill&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">apiPodStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">killPodOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodStatusFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetPodStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// we kill the pod with the specified grace period since this is a termination
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">killPodOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodTerminationGracePeriodSecondsOverride</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToKillPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error killing pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// there was an error killing the pod, so we return that error directly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-syncpodcreate">2.2. SyncPodCreate</h2>
<p>如果pod是需要被创建的，则记录pod的启动<code>latency</code>，<code>latency</code>与pod在apiserver中第一次被记录相关。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Latency measurements for the main workflow are relative to the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// first time the pod was seen by the API server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">firstSeenTime</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">firstSeenTimeStr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Annotations</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigFirstSeenAnnotationKey</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">firstSeenTime</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConvertToTimestamp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">firstSeenTimeStr</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Record pod worker start latency if being created
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: make pod workers record their own latencies
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">updateType</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodCreate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">firstSeenTime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsZero</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// This is the first time we are syncing the pod. Record the latency
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// since kubelet first saw the pod if firstSeenTime is set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodWorkerStartLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">firstSeenTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;First seen time not recorded for pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过pod和pod status生成最终的api pod status并设置pod的IP。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Generate final API pod status with pod and status manager status
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">apiPodStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">generateAPIPodStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The pod IP may be changed in generateAPIPodStatus if the pod is using host network. (See #24576)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO(random-liu): After writing pod spec into container labels, check whether pod is using host network, and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// set pod IP to hostIP directly in runtime.GetPodStatus
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IP</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodIP</span>
</span></span></code></pre></div><p>记录pod到running状态的时间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Record the time it takes for the pod to become running.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">existingStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">existingStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Phase</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPending</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Phase</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodRunning</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">!</span><span style="color:#000">firstSeenTime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsZero</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodStartLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">firstSeenTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果pod是不可运行的，则更新pod和container的状态和相应的原因。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">runnable</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">canRunPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">runnable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Admit</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Pod is not runnable; update the Pod and Container statuses to why.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">runnable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Message</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">runnable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Message</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Waiting containers are not creating.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">waitingReason</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Blocked&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitContainerStatuses</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">State</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Waiting</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">State</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Waiting</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">waitingReason</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerStatuses</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">State</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Waiting</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">State</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Waiting</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">waitingReason</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>并更新status manager中的状态信息，杀死不可运行的pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Update status in the status manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetPodStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Kill pod if it should not be running
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">runnable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Admit</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Phase</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFailed</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">syncErr</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToKillPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error killing pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">syncErr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error killing pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">runnable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Admit</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// There was no error killing the pod, but the pod cannot be run.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// Return an error to signal that the sync loop should back off.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">syncErr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pod cannot be run: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runnable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Message</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">syncErr</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果网络插件还没到<code>Ready</code>状态，则只有在使用<code>host</code>网络模式的情况下才启动pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If the network plugin is not ready, only start the pod if it uses the host network
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeState</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">networkErrors</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsHostNetworkPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NetworkNotReady</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%s: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NetworkNotReadyErrorMsg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NetworkNotReadyErrorMsg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-cgroups">2.3. Cgroups</h2>
<p>给pod创建<code>Cgroups</code>，如果<code>cgroups-per-qos</code>参数开启，则申请相应的资源。对于<code>terminated</code>的pod不需要创建或更新pod的<code>Cgroups</code>。</p>
<p>当重新启动<code>kubelet</code>并且启用<code>cgroups-per-qos</code>时，应该间歇性地终止所有pod的运行容器并在<code>qos cgroup hierarchy</code>下重新启动。</p>
<p>如果pod的cgroup已经存在或者pod第一次运行，不杀死pod中容器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create Cgroups for the pod and apply resource parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to them if cgroups-per-qos flag is enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pcm</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPodContainerManager</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If pod has already been terminated then we need not create
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// or update the pod&#39;s cgroup
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podIsTerminated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// When the kubelet is restarted with the cgroups-per-qos
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// flag enabled, all the pod&#39;s running containers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// should be killed intermittently and brought back up
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// under the qos cgroup hierarchy.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Check if this is the pod&#39;s first sync
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">firstSync</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerStatuses</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">containerStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">State</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Running</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">firstSync</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Don&#39;t kill containers in pod if pod&#39;s cgroups already
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// exists or the pod is running for the first time
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">podKilled</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">pcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">firstSync</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">podKilled</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><p>如果pod被杀死并且重启策略是<code>Never</code>，则不创建或更新对应的<code>Cgroups</code>，否则创建和更新pod的<code>Cgroups</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create and Update pod&#39;s Cgroups
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Don&#39;t create cgroups for run once pod if it was killed above
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The current policy is not to restart the run once pods when
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the kubelet is restarted with the new flag as run once pods are
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// expected to run only once and if the kubelet is restarted then
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// they are not expected to run again.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// We don&#39;t create and apply updates to cgroup if its a run once pod and was killed above
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!(</span><span style="color:#000">podKilled</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RestartPolicy</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RestartPolicyNever</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">pcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateQOSCgroups</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to update QoS cgroups while syncing pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnsureExists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreatePodContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unable to ensure pod container exists: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to ensure that the pod: %v cgroups exist and are correctly applied: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中创建<code>Cgroups</code>是通过<code>containerManager</code>的<code>UpdateQOSCgroups</code>来执行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateQOSCgroups</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to update QoS cgroups while syncing pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-4-mirror-pod">2.4. Mirror Pod</h2>
<p>如果pod是一个<code>static pod</code>，没有对应的<code>mirror pod</code>，则创建一个<code>mirror pod</code>；如果存在<code>mirror pod</code>则删除再重建一个<code>mirror pod</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create Mirror Pod for Static Pod if it doesn&#39;t already exist
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubepod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsStaticPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podFullName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodFullName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">deleted</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">mirrorPod</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsMirrorPodOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// The mirror pod is semantically different from the static pod. Remove
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// it. The mirror pod will get recreated later.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Deleting mirror pod %q because it is outdated&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podFullName</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed deleting mirror pod %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">deleted</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">mirrorPod</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">deleted</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNode</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;No need to create a mirror pod, since node %q has been removed from the cluster&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Creating a mirror pod for static pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed creating a mirror pod for %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-5-makepoddatadirs">2.5. makePodDataDirs</h2>
<p>给pod创建数据目录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Make data directories for the pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">makePodDataDirs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToMakePodDataDirectories</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error making pod data directories: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unable to make pod data directories for pod %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中数据目录包括</p>
<ul>
<li><code>PodDir</code>：{kubelet.rootDirectory}/pods/podUID</li>
<li><code>PodVolumesDir</code>：{PodDir}/volumes</li>
<li><code>PodPluginsDir</code>：{PodDir}/plugins</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// makePodDataDirs creates the dirs for the pod datas.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">makePodDataDirs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodDir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0750</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodVolumesDir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0750</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodPluginsDir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0750</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-6-mount-volumes">2.6. mount volumes</h2>
<p>对非<code>terminated</code>状态的pod挂载<code>volume</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Volume manager will not mount volumes for terminated pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podIsTerminated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Wait for volumes to attach/mount
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForAttachAndMount</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedMountVolume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unable to mount volumes for pod %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unable to mount volumes for pod %q: %v; skipping pod&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-7-pullsecretsforpod">2.7. PullSecretsForPod</h2>
<p>获取pod的secret数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Fetch the pull secrets for the pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pullSecrets</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPullSecretsForPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>getPullSecretsForPod</code>具体实现函数如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// getPullSecretsForPod inspects the Pod and retrieves the referenced pull
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// secrets.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">getPullSecretsForPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Secret</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pullSecrets</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Secret</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">secretRef</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ImagePullSecrets</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">secret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">secretManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetSecret</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">secretRef</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unable to retrieve pull secret %s/%s for %s/%s due to %v.  The image pull may not succeed.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">secretRef</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pullSecrets</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pullSecrets</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">secret</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pullSecrets</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-8-containerruntime-syncpod">2.8. containerRuntime.SyncPod</h2>
<p>调用<code>container runtime</code>的<code>SyncPod</code>函数，执行相关pod操作，由此<code>kubelet.syncPod</code>的操作逻辑转入<code>containerRuntime.SyncPod</code>函数中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Call the container runtime&#39;s SyncPod callback
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pullSecrets</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">backOff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reasonCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Do not return error if the only failures were pods in backoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncResults</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrCrashLoopBackOff</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">images</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrImagePullBackOff</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Do not record an event here, as we keep all event logging for sync pod failures
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// local to container runtime so we get better errors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-runtime-syncpod-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kuberuntime-kuberuntime-manager-go-l578">3. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kuberuntime/kuberuntime_manager.go#L578">Runtime.SyncPod</a></h1>
<p><code>SyncPod</code>主要执行sync操作使得运行的pod达到期望状态的pod。主要执行以下操作：</p>
<ul>
<li>计算<code>sandbox</code>和<code>container</code>的变化。</li>
<li>必要的时候杀死pod。</li>
<li>杀死所有不需要运行的<code>container</code>。</li>
<li>必要时创建<code>sandbox</code>。</li>
<li>创建<code>init container</code>。</li>
<li>创建正常的<code>container</code>。</li>
</ul>
<blockquote>
<p>Runtime.SyncPod部分代码位于pkg/kubelet/kuberuntime/kuberuntime_manager.go</p>
</blockquote>
<h2 id="3-1-computepodactions">3.1. computePodActions</h2>
<p>计算<code>sandbox</code>和<code>container</code>的变化。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 1: Compute sandbox and container changes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">podContainerChanges</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">computePodActions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;computePodActions got %+v for pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateSandbox</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ref</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ref</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetReference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">legacyscheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Couldn&#39;t make a ref to pod %q: &#39;%v&#39;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SandboxID</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ref</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SandboxChanged</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Pod sandbox changed, it will be killed and re-created.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncPod received new pod %q, will create a sandbox for it&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-killpodwithsyncresult">3.2. killPodWithSyncResult</h2>
<p>必要的时候杀死pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 2: Kill the pod if the sandbox has changed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KillPod</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateSandbox</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Stopping PodSandbox for %q because all other containers are dead.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Stopping PodSandbox for %q, will start new one&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">killResult</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killPodWithSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConvertPodStatusToRunningPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPodSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">killResult</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">killResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;killPodWithSyncResult failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">killResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateSandbox</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">purgeInitContainers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-killcontainer">3.3. killContainer</h2>
<p>杀死所有不需要运行的<code>container</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 3: kill any running containers in this pod which are not to keep.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerInfo</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainersToKill</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Killing unwanted container %q(id=%q) for pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">killContainerResult</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KillContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">killContainerResult</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">killContainerResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrKillContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;killContainer %q(id=%q) for pod %q failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-4-createpodsandbox">3.4. createPodSandbox</h2>
<p>必要时创建<code>sandbox</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 4: Create a sandbox for the pod if necessary.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Creating sandbox for pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000">createSandboxResult</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreatePodSandbox</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">createSandboxResult</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">podSandboxID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createPodSandbox</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Attempt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">createSandboxResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrCreatePodSandbox</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;createPodSandbox for pod %q failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ref</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">referr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ref</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetReference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">legacyscheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">referr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Couldn&#39;t make a ref to pod %q: &#39;%v&#39;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">referr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ref</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedCreatePodSandBox</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed create pod sandbox: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Created PodSandbox %q for pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podSandboxID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h2 id="3-5-start-init-container">3.5. start init container</h2>
<p>创建<code>init container</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 5: start the init container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">container</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NextInitContainerToStart</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">container</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the next init container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">startContainerResult</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startContainerResult</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">isInBackOff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">doBackOff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backOff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isInBackOff</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">startContainerResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Backing Off restarting init container %+v in pod %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Creating init container %+v in pod %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pullSecrets</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podIP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerTypeInit</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">startContainerResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;init container start failed: %v: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Successfully started the container; clear the entry in the failure
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Completed init container %q for pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-6-start-containers">3.6. start containers</h2>
<p>创建正常的<code>container</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 6: start containers in podContainerChanges.ContainersToStart.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">idx</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainersToStart</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">container</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Containers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">idx</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startContainerResult</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startContainerResult</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">isInBackOff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">doBackOff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backOff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isInBackOff</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">startContainerResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Backing Off restarting container %+v in pod %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Creating container %+v in pod %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 通过startContainer来运行容器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pullSecrets</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podIP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerTypeRegular</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">startContainerResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// known errors that are logged in other places are logged at higher levels here to avoid
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// repetitive log spam
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">images</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrImagePullBackOff</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;container start failed: %v: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;container start failed: %v: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-startcontainer-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kuberuntime-kuberuntime-container-go-l89">4. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kuberuntime/kuberuntime_container.go#L89">startContainer</a></h1>
<p><code>startContainer</code>启动一个容器并返回是否成功。</p>
<p>主要包括以下几个步骤：</p>
<ol>
<li>拉取镜像</li>
<li>创建容器</li>
<li>启动容器</li>
<li>运行post start lifecycle hooks(如果有设置此项)</li>
</ol>
<p><code>startContainer</code>完整代码如下：</p>
<blockquote>
<p>startContainer部分代码位于pkg/kubelet/kuberuntime/kuberuntime_container.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// startContainer starts a container and returns a message indicates why it is failed on error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It starts the container through the following steps:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// * pull the image
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// * create the container
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// * start the container
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// * run the post start lifecycle hooks (if applicable)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeGenericRuntimeManager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">startContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxID</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podSandboxConfig</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">runtimeapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodSandboxConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pullSecrets</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Secret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podIP</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerType</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerType</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Step 1: pull the image.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">imageRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">imagePuller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnsureImageExists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pullSecrets</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreateContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Step 2: create the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ref</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenerateContainerRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Can&#39;t make a ref to pod %q, container %v: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Generating ref for container %s: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// For a new container, the RestartCount should be 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">restartCount</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">containerStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FindContainerStatusByName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">containerStatus</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">restartCount</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">containerStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RestartCount</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cleanupAction</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">generateContainerConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">restartCount</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podIP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">imageRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerType</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cleanupAction</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cleanupAction</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreateContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrCreateContainerConfig</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreateContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrCreateContainer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">internalLifecycle</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreStartContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToStartContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Internal PreStartContainer hook failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrPreStartHook</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreatedContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Created container&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ref</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRefManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerID</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ID</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span> <span style="color:#000">ref</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Step 3: start the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToStartContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrRunContainer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartedContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Started container&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Symlink container logs to the legacy container log location for cluster logging
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// support.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// TODO(random-liu): Remove this after cluster logging supports CRI container log path.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">containerMeta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMetadata</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sandboxMeta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMetadata</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">legacySymlink</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">legacyLogSymlink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sandboxMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sandboxMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">containerLog</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogDirectory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// only create legacy symlink if containerLog path exists (or the error is not IsNotExist).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Because if containerLog path does not exist, only dandling legacySymlink is created.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This dangling legacySymlink is later removed by container gc, so it does not make sense
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// to create it in the first place. it happens when journald logging driver is used with docker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">osInterface</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerLog</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">osInterface</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Symlink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerLog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">legacySymlink</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create legacy symbolic link %q to container %q log %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">legacySymlink</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerLog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Step 4: execute the post start hook.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lifecycle</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lifecycle</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PostStart</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeContainerID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerID</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ID</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handlerErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runner</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lifecycle</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PostStart</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">handlerErr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedPostStartHook&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to kill container %q(id=%q) in pod %q: %v, %v&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ErrPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handlerErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下对<code>startContainer</code>分段分析：</p>
<h2 id="4-1-pull-image">4.1. pull image</h2>
<p>通过<code>EnsureImageExists</code>方法拉取拉取指定pod容器的镜像，并返回镜像信息和错误。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 1: pull the image.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">imageRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">imagePuller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnsureImageExists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pullSecrets</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreateContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-2-createcontainer">4.2. CreateContainer</h2>
<p>首先生成container的<code>*v1.ObjectReference</code>对象，该对象包括container的相关信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 2: create the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ref</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenerateContainerRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Can&#39;t make a ref to pod %q, container %v: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Generating ref for container %s: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>统计container的重启次数，新的容器默认重启次数为0。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// For a new container, the RestartCount should be 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">restartCount</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">containerStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FindContainerStatusByName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">containerStatus</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">restartCount</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">containerStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RestartCount</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>生成container的配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cleanupAction</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">generateContainerConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">restartCount</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podIP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">imageRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerType</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cleanupAction</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cleanupAction</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreateContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrCreateContainerConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>调用<code>runtimeService</code>，执行<code>CreateContainer</code>的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreateContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrCreateContainer</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">internalLifecycle</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreStartContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToStartContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Internal PreStartContainer hook failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrPreStartHook</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreatedContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Created container&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ref</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRefManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerID</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ID</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#000">ref</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-3-startcontainer">4.3. StartContainer</h2>
<p>执行<code>runtimeService</code>的<code>StartContainer</code>方法，来启动容器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 3: start the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToStartContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrRunContainer</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartedContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Started container&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Symlink container logs to the legacy container log location for cluster logging
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// support.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO(random-liu): Remove this after cluster logging supports CRI container log path.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">containerMeta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMetadata</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sandboxMeta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMetadata</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">legacySymlink</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">legacyLogSymlink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sandboxMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sandboxMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">containerLog</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogDirectory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// only create legacy symlink if containerLog path exists (or the error is not IsNotExist).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Because if containerLog path does not exist, only dandling legacySymlink is created.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This dangling legacySymlink is later removed by container gc, so it does not make sense
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to create it in the first place. it happens when journald logging driver is used with docker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">osInterface</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerLog</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">osInterface</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Symlink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerLog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">legacySymlink</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create legacy symbolic link %q to container %q log %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">legacySymlink</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerLog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-4-execute-post-start-hook">4.4. execute post start hook</h2>
<p>如果有指定<code>Lifecycle.PostStart</code>，则执行<code>PostStart</code>操作，<code>PostStart</code>如果执行失败，则容器会根据重启的规则进行重启。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 4: execute the post start hook.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lifecycle</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lifecycle</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PostStart</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeContainerID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerID</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ID</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handlerErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runner</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lifecycle</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PostStart</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">handlerErr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedPostStartHook&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to kill container %q(id=%q) in pod %q: %v, %v&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ErrPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handlerErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-总结">5. 总结</h1>
<p>kubelet的工作是管理pod在Node上的生命周期（包括增删改查），kubelet通过各种类型的manager异步工作各自执行各自的任务，其中使用到了多种的channel来控制状态信号变化的传递，例如比较重要的channel有<code>podUpdates &lt;-chan UpdatePodOptions</code>，来传递pod的变化情况。</p>
<p><strong>创建pod的调用逻辑</strong></p>
<p><code>syncLoopIteration--&gt;kubetypes.ADD--&gt;HandlePodAdditions(u.Pods)--&gt;dispatchWork(pod, kubetypes.SyncPodCreate, mirrorPod, start)--&gt;podWorkers.UpdatePod--&gt;managePodLoop(podUpdates)--&gt;syncPod(o syncPodOptions)--&gt;containerRuntime.SyncPod--&gt;startContainer</code></p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kuberuntime/kuberuntime_container.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kuberuntime/kuberuntime_container.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-530d7df789771887e02908b769f6701c">5.7 - runc源码分析</h1>
    
	<h1 id="runc代码目录结构">runc代码目录结构</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>├── create.go  <span style="color:#8f5902;font-style:italic"># createCommand</span>
</span></span><span style="display:flex;"><span>├── delete.go  <span style="color:#8f5902;font-style:italic"># deleteCommand</span>
</span></span><span style="display:flex;"><span>├── events.go  <span style="color:#8f5902;font-style:italic"># eventsCommand</span>
</span></span><span style="display:flex;"><span>├── exec.go    <span style="color:#8f5902;font-style:italic"># execCommand</span>
</span></span><span style="display:flex;"><span>├── features.go  <span style="color:#8f5902;font-style:italic"># featuresCommand</span>
</span></span><span style="display:flex;"><span>├── kill.go     <span style="color:#8f5902;font-style:italic"># killCommand</span>
</span></span><span style="display:flex;"><span>├── libcontainer  <span style="color:#8f5902;font-style:italic"># 核心实现逻辑</span>
</span></span><span style="display:flex;"><span>├── list.go  <span style="color:#8f5902;font-style:italic">#  listCommand</span>
</span></span><span style="display:flex;"><span>├── main.go  <span style="color:#8f5902;font-style:italic"># main函数</span>
</span></span><span style="display:flex;"><span>├── pause.go  <span style="color:#8f5902;font-style:italic"># pauseCommand</span>
</span></span><span style="display:flex;"><span>├── ps.go  <span style="color:#8f5902;font-style:italic"># psCommand </span>
</span></span><span style="display:flex;"><span>├── restore.go <span style="color:#8f5902;font-style:italic"># restoreCommand</span>
</span></span><span style="display:flex;"><span>├── run.go <span style="color:#8f5902;font-style:italic"># runCommand</span>
</span></span><span style="display:flex;"><span>├── spec.go <span style="color:#8f5902;font-style:italic"># specCommand</span>
</span></span><span style="display:flex;"><span>├── start.go <span style="color:#8f5902;font-style:italic"># startCommand</span>
</span></span><span style="display:flex;"><span>├── state.go <span style="color:#8f5902;font-style:italic"># stateCommand</span>
</span></span><span style="display:flex;"><span>├── update.go <span style="color:#8f5902;font-style:italic"># updateCommand</span>
</span></span><span style="display:flex;"><span>├── utils_linux.go <span style="color:#8f5902;font-style:italic"># startContainer</span>
</span></span></code></pre></div><h2 id="libcontainer目录结构">libcontainer目录结构</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>libcontainer
</span></span><span style="display:flex;"><span>├── apparmor
</span></span><span style="display:flex;"><span>├── capabilities
</span></span><span style="display:flex;"><span>├── cgroups
</span></span><span style="display:flex;"><span>├── configs
</span></span><span style="display:flex;"><span>├── console_linux.go
</span></span><span style="display:flex;"><span>├── container.go
</span></span><span style="display:flex;"><span>├── container_linux.go
</span></span><span style="display:flex;"><span>├── container_linux_test.go
</span></span><span style="display:flex;"><span>├── criu_opts_linux.go
</span></span><span style="display:flex;"><span>├── devices
</span></span><span style="display:flex;"><span>├── error.go
</span></span><span style="display:flex;"><span>├── factory_linux.go
</span></span><span style="display:flex;"><span>├── factory_linux_test.go
</span></span><span style="display:flex;"><span>├── init_linux.go
</span></span><span style="display:flex;"><span>├── integration
</span></span><span style="display:flex;"><span>├── intelrdt
</span></span><span style="display:flex;"><span>├── keys
</span></span><span style="display:flex;"><span>├── logs
</span></span><span style="display:flex;"><span>├── message_linux.go
</span></span><span style="display:flex;"><span>├── mount_linux.go
</span></span><span style="display:flex;"><span>├── network_linux.go
</span></span><span style="display:flex;"><span>├── notify_linux.go
</span></span><span style="display:flex;"><span>├── notify_linux_test.go
</span></span><span style="display:flex;"><span>├── notify_v2_linux.go
</span></span><span style="display:flex;"><span>├── nsenter
</span></span><span style="display:flex;"><span>├── process.go
</span></span><span style="display:flex;"><span>├── process_linux.go
</span></span><span style="display:flex;"><span>├── restored_process.go
</span></span><span style="display:flex;"><span>├── rootfs_linux.go
</span></span><span style="display:flex;"><span>├── rootfs_linux_test.go
</span></span><span style="display:flex;"><span>├── seccomp
</span></span><span style="display:flex;"><span>├── setns_init_linux.go
</span></span><span style="display:flex;"><span>├── specconv
</span></span><span style="display:flex;"><span>├── standard_init_linux.go
</span></span><span style="display:flex;"><span>├── state_linux.go
</span></span><span style="display:flex;"><span>├── state_linux_test.go
</span></span><span style="display:flex;"><span>├── stats_linux.go
</span></span><span style="display:flex;"><span>├── sync.go
</span></span><span style="display:flex;"><span>├── system
</span></span><span style="display:flex;"><span>├── user
</span></span><span style="display:flex;"><span>├── userns
</span></span><span style="display:flex;"><span>└── utils
</span></span></code></pre></div><h1 id="main函数">Main函数</h1>
<p>runc的代码仓库主要使用了<a href="github.com/urfave/cli">github.com/urfave/cli</a>的命令框架（该框架与cobra命令框架类似）。添加了多个重要的子命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;runc&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Usage</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">usage</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Commands</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">checkpointCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">createCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">deleteCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">eventsCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">execCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">killCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">listCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pauseCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">psCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">restoreCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">resumeCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">runCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">specCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">startCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">stateCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">updateCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">featuresCommand</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="runcommand">runCommand</h1>
<p>以<code>runCommand</code>为例分析子命令的调用流程。</p>
<p><a href="github.com/urfave/cli">github.com/urfave/cli</a>命令框架代码格式：</p>
<p>创建一个Command结构体，包含：</p>
<ul>
<li>
<p>Name：命名名称</p>
</li>
<li>
<p>Usage：使用说明</p>
</li>
<li>
<p>Description：描述命令信息</p>
</li>
<li>
<p>Flags：解析参数</p>
</li>
<li>
<p>Action: command run的核心逻辑。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// default action is to start a container
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">runCommand</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;run&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;create and run a container&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 删除描述信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">ArgsUsage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">``</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Description</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">``</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringFlag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;bundle, b&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">Value</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`path to the root of the bundle directory, defaults to the current directory`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 删除多余的FLAG代码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Action</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">checkArgs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exactArgs</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 核心代码，启动容器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">startContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CT_ACT_RUN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// exit with the container&#39;s exit status so any external supervisor is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#8f5902;font-style:italic">// notified of the exit with the correct exit status.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;runc run failed: %w&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="startcontainer">startContainer</h1>
<p>启动容器的流程：</p>
<ol>
<li>
<p>setup spec信息。</p>
</li>
<li>
<p>基于spec信息创建container。</p>
</li>
<li>
<p>通过runner启动进程。</p>
</li>
</ol>
<blockquote>
<p>删除error处理代码</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">startContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">action</span> <span style="color:#000">CtAct</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">criuOpts</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">libcontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CriuOpts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">revisePidFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">spec</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">setupSpec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">First</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">notifySocket</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">newNotifySocket</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NOTIFY_SOCKET&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">notifySocket</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">notifySocket</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setupSpec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">spec</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">spec</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">notifySocket</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">notifySocket</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setupSocketDirectory</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">action</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">CT_ACT_RUN</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">notifySocket</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bindSocket</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Support on-demand socket activation by passing file descriptors into the container init process.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">listenFDs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;LISTEN_FDS&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">listenFDs</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">activation</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Files</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">runner</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">enableSubreaper</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;no-subreaper&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">shouldDestroy</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000;font-weight:bold">!</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;keep&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">container</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">listenFDs</span><span style="color:#000;font-weight:bold">:</span>       <span style="color:#000">listenFDs</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">notifySocket</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">notifySocket</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">consoleSocket</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;console-socket&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">detach</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;detach&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">pidFile</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pid-file&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">preserveFDs</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;preserve-fds&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">action</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#000">action</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">criuOpts</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">criuOpts</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">init</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Process</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p>待完善</p>
</blockquote>

</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2025 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
