<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/k8s-source-code-analysis/kubelet/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/k8s-source-code-analysis/kubelet/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>kubelet | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="kubelet" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/k8s-source-code-analysis/kubelet/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="kubelet">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="kubelet"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/kubernetes-notes/" ><span>Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/k8s-source-code-analysis/" ><span class="active">Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/linux-notes/" ><span>Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.b53179dcc72342bcd73c09bc0f2ec912.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/k8s-source-code-analysis/kubelet/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">kubelet</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-5516fcb212e4fbbdc29a202ed629314d">kubelet 源码思维导图</a></li>


    
  
    
    
	
<li>2: <a href="#pg-e2cf6c7dbb69ed9905bbe6a48da441ab">kubelet源码分析（一）之 NewKubeletCommand</a></li>


    
  
    
    
	
<li>3: <a href="#pg-f143779d871d6a62ac575beff2e8515b">kubelet源码分析（二）之 NewMainKubelet</a></li>


    
  
    
    
	
<li>4: <a href="#pg-81cae8093c76076822c064c1cb2ac31c">kubelet源码分析（三）之 RunKubelet</a></li>


    
  
    
    
	
<li>5: <a href="#pg-a2b7e6297d422710a490f3a64d66c478">kubelet源码分析（四）之 syncLoopIteration</a></li>


    
  
    
    
	
<li>6: <a href="#pg-46bab922ea9b5daead85570c299c80aa">kubelet源码分析（五）之 syncPod</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-5516fcb212e4fbbdc29a202ed629314d">1 - kubelet 源码思维导图</h1>
    
	<h2 id="源码整体结构图">源码整体结构图</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1618721742/article/code-analysis/kubelet/kubelet.png" width="100%">

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e2cf6c7dbb69ed9905bbe6a48da441ab">2 - kubelet源码分析（一）之 NewKubeletCommand</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
<p>本文主要分析 <a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kubelet">https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kubelet</a> 部分的代码。</p>
</blockquote>
<p>本文主要分析 <code>kubernetes/cmd/kubelet</code>部分，该部分主要涉及<code>kubelet</code>的参数解析，及初始化和构造相关的依赖组件（主要在<code>kubeDeps</code>结构体中），并没有<code>kubelet</code>运行的详细逻辑，该部分位于<code>kubernetes/pkg/kubelet</code>模块，待后续文章分析。</p>
<p><code>kubelet</code>的<code>cmd</code>代码目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubelet
</span></span><span style="display:flex;"><span>├── app
</span></span><span style="display:flex;"><span>│   ├── auth.go
</span></span><span style="display:flex;"><span>│   ├── init_others.go
</span></span><span style="display:flex;"><span>│   ├── init_windows.go
</span></span><span style="display:flex;"><span>│   ├── options              <span style="color:#8f5902;font-style:italic"># 包括kubelet使用到的option</span>
</span></span><span style="display:flex;"><span>│   │   ├── container_runtime.go
</span></span><span style="display:flex;"><span>│   │   ├── globalflags.go
</span></span><span style="display:flex;"><span>│   │   ├── globalflags_linux.go
</span></span><span style="display:flex;"><span>│   │   ├── globalflags_other.go
</span></span><span style="display:flex;"><span>│   │   ├── options.go     <span style="color:#8f5902;font-style:italic"># 包括KubeletFlags、AddFlags、AddKubeletConfigFlags等</span>
</span></span><span style="display:flex;"><span>│   │   ├── osflags_others.go
</span></span><span style="display:flex;"><span>│   │   └── osflags_windows.go
</span></span><span style="display:flex;"><span>│   ├── plugins.go
</span></span><span style="display:flex;"><span>│   ├── server.go <span style="color:#8f5902;font-style:italic"># 包括NewKubeletCommand、Run、RunKubelet、CreateAndInitKubelet、startKubelet等</span>
</span></span><span style="display:flex;"><span>│   ├── server_linux.go
</span></span><span style="display:flex;"><span>│   └── server_unsupported.go
</span></span><span style="display:flex;"><span>└── kubelet.go              <span style="color:#8f5902;font-style:italic"># kubelet的main入口函数</span>
</span></span></code></pre></div><h1 id="1-main-函数-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kubelet-kubelet-go-l36">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/kubelet.go#L36">Main 函数</a></h1>
<p><code>kubelet</code>的入口函数<code> Main</code> 函数，具体代码参考：https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/kubelet.go。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UTC</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UnixNano</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewKubeletCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetupSignalHandler</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlushLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>kubelet代码主要采用了<a href="https://github.com/spf13/cobra">Cobra</a>命令行框架，核心代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 初始化命令行
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewKubeletCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetupSignalHandler</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 执行Execute
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h1 id="2-newkubeletcommand-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kubelet-app-server-go-l108">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/server.go#L108">NewKubeletCommand</a></h1>
<p><code>NewKubeletCommand</code>基于参数创建了一个<code>*cobra.Command</code>对象。其中核心部分代码为参数解析部分和<code>Run</code>函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewKubeletCommand creates a *cobra.Command object with default parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewKubeletCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">componentKubelet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Long</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`...`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// The Kubelet has special flag parsing requirements to enforce flag precedence rules,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// so we do all our parsing manually in Run, below.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// DisableFlagParsing=true provides the full set of flags passed to the kubelet in the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// `args` arg to Run, without Cobra&#39;s interference.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">DisableFlagParsing</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Run</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// run the kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KubeletConfiguration: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-1-参数解析">2.1. 参数解析</h2>
<p>kubelet开启了<code>DisableFlagParsing</code>参数，没有使用<code>Cobra</code>框架中的默认参数解析，而是自定义参数解析。</p>
<h3 id="2-1-1-初始化参数和配置">2.1.1. 初始化参数和配置</h3>
<p>初始化参数解析，初始化<code>cleanFlagSet</code>，<code>kubeletFlags</code>，<code>kubeletConfig</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">cleanFlagSet</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">componentKubelet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContinueOnError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetNormalizeFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WordSepNormalizeFunc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kubeletFlags</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewKubeletFlags</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewKubeletConfiguration</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="2-1-2-打印帮助信息和版本信息">2.1.2. 打印帮助信息和版本信息</h3>
<p>如果输入非法参数则打印使用帮助信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// initial flag parse, since we disable cobra&#39;s flag parsing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// check if there are non-flag arguments in the command line
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">cmds</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmds</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unknown command: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmds</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>遇到<code>help</code>和<code>version</code>参数则打印相关内容并退出。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// short-circuit on help
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">help</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetBool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;help&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`&#34;help&#34; flag is non-bool, programmer error, please correct`</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">help</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Help</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// short-circuit on verflag
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">verflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintAndExitIfRequested</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">utilflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="2-1-3-kubelet-config">2.1.3. kubelet config</h3>
<p>加载并校验<code>kubelet config</code>。其中包括校验初始化的<code>kubeletFlags</code>，并从<code>kubeletFlags</code>的<code>KubeletConfigFile</code>参数获取<code>kubelet config</code>的内容。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// set feature gates from initial flags-based config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetFromMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FeatureGates</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// validate the initial KubeletFlags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValidateKubeletFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletFlags</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeletFlags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntime</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;remote&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Changed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pod-infra-container-image&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Warning: For remote container runtime, --pod-infra-container-image is ignored in kubelet, which should be set in that remote runtime instead&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// load kubelet config file, if provided
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">configFile</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeletFlags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfigFile</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configFile</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">loadConfigFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configFile</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We must enforce flag precedence by re-parsing the command line into the new object.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This is necessary to preserve backwards-compatibility across binary upgrades.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// See issue #56171 for more details.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeletConfigFlagPrecedence</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// update feature gates based on new config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetFromMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FeatureGates</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// We always validate the local configuration (command line + config file).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This is the default &#34;last-known-good&#34; config for dynamic config, and must always remain valid.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeletconfigvalidation</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValidateKubeletConfiguration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-1-4-dynamic-kubelet-config">2.1.4. dynamic kubelet config</h3>
<p>如果开启使用动态kubelet的配置，则由动态配置文件替换kubelet配置文件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// use dynamic kubelet config, if enabled
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">kubeletConfigController</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dynamickubeletconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">dynamicConfigDir</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeletFlags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DynamicConfigDir</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Value</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dynamicConfigDir</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">dynamicKubeletConfig</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dynamicKubeletConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletConfigController</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">BootstrapKubeletConfigController</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dynamicConfigDir</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kc</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Here, we enforce flag precedence inside the controller, prior to the controller&#39;s validation sequence,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// so that we get a complete validation at the same point where we can decide to reject dynamic config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// This fixes the flag-precedence component of issue #63305.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// See issue #56171 for general details on flag precedence.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">kubeletConfigFlagPrecedence</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If we should just use our existing, local config, the controller will return a nil config
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">dynamicKubeletConfig</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeletConfig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dynamicKubeletConfig</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Note: flag precedence was already enforced in the controller, prior to validation,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// by our above transform function. Now we simply update feature gates from the new config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetFromMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FeatureGates</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>总结：以上通过对各种特定参数的解析，最终生成<code>kubeletFlags</code>和<code>kubeletConfig</code>两个重要的参数对象，用来构造<code>kubeletServer</code>和其他需求。</p>
<h2 id="2-2-初始化kubeletserver和kubeletdeps">2.2. 初始化kubeletServer和kubeletDeps</h2>
<h3 id="2-2-1-kubeletserver">2.2.1. kubeletServer</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// construct a KubeletServer from kubeletFlags and kubeletConfig
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kubeletServer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletServer</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">KubeletFlags</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletFlags</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="2-2-2-kubeletdeps">2.2.2. kubeletDeps</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// use kubeletServer to construct the default KubeletDeps
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kubeletDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">UnsecuredDependencies</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// add the kubelet config controller to kubeletDeps
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kubeletDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfigController</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kubeletConfigController</span>
</span></span></code></pre></div><h3 id="2-2-3-docker-shim">2.2.3. docker shim</h3>
<p>如果开启了docker shim参数，则执行<code>RunDockershim</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// start the experimental docker shim, if enabled
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletFlags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExperimentalDockershim</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">RunDockershim</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletFlags</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-addflags">2.3. AddFlags</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// keep cleanFlagSet separate, so Cobra doesn&#39;t pollute it with the global flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kubeletFlags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddKubeletConfigFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddGlobalFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BoolP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;help&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;h&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;help for %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ugly, but necessary, because Cobra&#39;s default UsageFunc and HelpFunc pollute the flagset with global flags
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">usageFmt</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Usage:\n  %s\n\nFlags:\n%s&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetUsageFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStderr</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">usageFmt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseLine</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagUsagesWrapped</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetHelpFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OutOrStdout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;%s\n\n&#34;</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">usageFmt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Long</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseLine</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cleanFlagSet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagUsagesWrapped</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><p>其中：</p>
<ul>
<li><code>AddFlags</code>代码可参考：<a href="https://github.com/kubernetes/kubernetes/blob/0ed33881dc4355495f623c6f22e7dd0b7632b7c0/cmd/kubelet/app/options/options.go#L323">kubernetes/cmd/kubelet/app/options/options.go#L323</a></li>
<li><code>AddKubeletConfigFlags</code>代码可参考：<a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/options/options.go#L424">kubernetes/cmd/kubelet/app/options/options.go#L424</a></li>
</ul>
<h2 id="2-4-运行kubelet">2.4. 运行kubelet</h2>
<p>运行kubelet并且不退出。由Run函数进入后续的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// run the kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;KubeletConfiguration: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeletServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeletDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-run-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kubelet-app-server-go-l406">3. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/server.go#L406">Run</a></h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run runs the specified KubeletServer with the given Dependencies. This should never exit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The kubeDeps argument may be nil - if so, it is initialized from the settings on KubeletServer.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Otherwise, the caller is assumed to have set up the Dependencies object and a default one will
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// not be generated.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dependencies</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// To help debugging, immediately log version
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Version: %+v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">version</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">initForOS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletFlags</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WindowsService</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed OS init: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to run Kubelet: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>当运行环境是Windows的时候，初始化操作，但是该操作为空，只是预留。具体执行<code>run(s, kubeDeps, stopCh)</code>函数。</p>
<h2 id="3-1-构造kubedeps">3.1. 构造kubeDeps</h2>
<h3 id="3-1-1-clientconfig">3.1.1. clientConfig</h3>
<p>创建<code>clientConfig</code>，该对象用来创建各种的<code>kubeDeps</code>属性中包含的<code>client</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">clientConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createAPIServerClientConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;invalid kubeconfig: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-2-kubeclient">3.1.2. kubeClient</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;New kubeClient from clientConfig error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertificatesV1beta1</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">clientCertificateManager</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting client certificate rotation.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">clientCertificateManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetCertificateSigningRequestClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertificatesV1beta1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">CertificateSigningRequests</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">clientCertificateManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-3-dynamickubeclient">3.1.3. dynamicKubeClient</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#000">dynamicKubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dynamic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to initialize dynamic KubeClient: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-4-eventclient">3.1.4. eventClient</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// make a separate client for events
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">eventClientConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">clientConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#000">eventClientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QPS</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">float32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventRecordQPS</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">eventClientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Burst</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventBurst</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">eventClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">v1core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">eventClientConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create API Server client for Events: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-5-heartbeatclient">3.1.5. heartbeatClient</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// make a separate client for heartbeat with throttling disabled and a timeout attached
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">heartbeatClientConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">clientConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#000">heartbeatClientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeStatusUpdateFrequency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// if the NodeLease feature is enabled, the timeout is the minimum of the lease duration and status update frequency
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLease</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">leaseTimeout</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLeaseDurationSeconds</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">heartbeatClientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">leaseTimeout</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">heartbeatClientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">leaseTimeout</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">heartbeatClientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QPS</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">float32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">heartbeatClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">heartbeatClientConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create API Server client for heartbeat: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-6-csiclient">3.1.6. csiClient</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// csiClient works with CRDs that support json only
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">clientConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContentType</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;application/json&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">csiClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">csiclientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewForConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create CSI API client: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>client赋值</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kubeClient</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DynamicKubeClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dynamicKubeClient</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">heartbeatClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HeartbeatClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">heartbeatClient</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnHeartbeatFailure</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">closeAllConns</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">eventClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">eventClient</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CSIClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">csiClient</span>
</span></span></code></pre></div><h3 id="3-1-7-cadvisorinterface">3.1.7. CAdvisorInterface</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CAdvisorInterface</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">imageFsInfoProvider</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cadvisor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewImageFsInfoProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntime</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteRuntimeEndpoint</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CAdvisorInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cadvisor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">imageFsInfoProvider</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RootDirectory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cadvisor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UsingLegacyCadvisorStats</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntime</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteRuntimeEndpoint</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-8-containermanager">3.1.8. ContainerManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerManager</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupsPerQOS</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupRoot</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;--cgroups-per-qos enabled, but --cgroup-root was not specified.  defaulting to /&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupRoot</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeReserved</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">parseResourceList</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeReserved</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">systemReserved</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">parseResourceList</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SystemReserved</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">hardEvictionThresholds</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">evictionapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Threshold</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If the user requested to ignore eviction thresholds, then do not set valid values for hardEvictionThresholds here.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExperimentalNodeAllocatableIgnoreEvictionThreshold</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">hardEvictionThresholds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">eviction</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseThresholdConfig</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EvictionHard</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">experimentalQOSReserved</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseQOSReserved</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QOSReserved</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">devicePluginEnabled</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DevicePlugins</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewContainerManager</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mounter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CAdvisorInterface</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeConfig</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">RuntimeCgroupsName</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RuntimeCgroups</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">SystemCgroupsName</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SystemCgroups</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">KubeletCgroupsName</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletCgroups</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ContainerRuntime</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntime</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">CgroupsPerQOS</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupsPerQOS</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">CgroupRoot</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupRoot</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">CgroupDriver</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupDriver</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">KubeletRootDir</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RootDirectory</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ProtectKernelDefaults</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProtectKernelDefaults</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">NodeAllocatableConfig</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeAllocatableConfig</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">KubeReservedCgroupName</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeReservedCgroup</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">SystemReservedCgroupName</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SystemReservedCgroup</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">EnforceNodeAllocatable</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnforceNodeAllocatable</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">KubeReserved</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">kubeReserved</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">SystemReserved</span><span style="color:#000;font-weight:bold">:</span>           <span style="color:#000">systemReserved</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">HardEvictionThresholds</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">hardEvictionThresholds</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">QOSReserved</span><span style="color:#000;font-weight:bold">:</span>                           <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">experimentalQOSReserved</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ExperimentalCPUManagerPolicy</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CPUManagerPolicy</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ExperimentalCPUManagerReconcilePeriod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CPUManagerReconcilePeriod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ExperimentalPodPidsLimit</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPidsLimit</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">EnforceCPULimits</span><span style="color:#000;font-weight:bold">:</span>                      <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CPUCFSQuota</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">CPUCFSQuotaPeriod</span><span style="color:#000;font-weight:bold">:</span>                     <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CPUCFSQuotaPeriod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailSwapOn</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">devicePluginEnabled</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-9-oomadjuster">3.1.9. oomAdjuster</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO(vmarmol): Do this through container config.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">oomAdjuster</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OOMAdjuster</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">oomAdjuster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ApplyOOMScoreAdj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OOMScoreAdj</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-health-check">3.2. Health check</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HealthzPort</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">healthz</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultHealthz</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">JoinHostPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HealthzBindAddress</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Itoa</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HealthzPort</span><span style="color:#000;font-weight:bold">))),</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting health server failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-runkubelet">3.3. RunKubelet</h2>
<p>通过各种赋值构造了完整的<code>kubeDeps</code>结构体，最后再执行<code>RunKubelet</code>转入后续的kubelet执行流程。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">RunKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunOnce</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-runkubelet-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kubelet-app-server-go-l914">4. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/server.go#L914">RunKubelet</a></h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// RunKubelet is responsible for setting up and running a kubelet.  It is used in three different applications:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   1 Integration tests
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   2 Kubelet binary
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   3 Standalone &#39;kubernetes&#39; binary
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Eventually, #2 will be replaced with instances of #3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">RunKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeServer</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletServer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dependencies</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runOnce</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">CreateAndInitKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeStatusMaxImages</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to create kubelet: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// NewMainKubelet should have set up a pod source config if one didn&#39;t exist
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// when the builder was run. This is just a precaution.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to create kubelet, pod source config was nil&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podCfg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rlimit</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RlimitNumFiles</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">uint64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxOpenFiles</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// process pods and exit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">runOnce</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunOnce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Updates</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;runonce failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Started kubelet as runonce&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">startKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableServer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Started kubelet&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><p><code>RunKubelet</code>函数核心代码为执行了<code>CreateAndInitKubelet</code>和<code>startKubelet</code>两个函数的操作，以下对这两个函数进行分析。</p>
<h2 id="4-1-createandinitkubelet">4.1. CreateAndInitKubelet</h2>
<p>通过传入<code>kubeDeps</code>调用<code>CreateAndInitKubelet</code>初始化Kubelet。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">CreateAndInitKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntimeOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntime</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RuntimeCgroups</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostnameOverride</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeIP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProviderID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CloudProvider</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CertDirectory</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RootDirectory</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterNode</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterWithTaints</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllowedUnsafeSysctls</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteRuntimeEndpoint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteImageEndpoint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExperimentalMounterPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExperimentalKernelMemcgNotification</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExperimentalCheckNodeCapabilitiesBeforeMount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExperimentalNodeAllocatableIgnoreEvictionThreshold</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MinimumGCAge</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxPerPodContainerCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxContainerCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MasterServiceNamespace</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterSchedulable</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NonMasqueradeCIDR</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KeepTerminatedPodVolumes</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLabels</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SeccompProfileRoot</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BootstrapCheckpointPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeStatusMaxImages</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to create kubelet: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-1-1-newmainkubelet">4.1.1. NewMainKubelet</h3>
<p><code>CreateAndInitKubelet</code>方法中执行的核心函数是<code>NewMainKubelet</code>，<code>NewMainKubelet</code>实例化一个<code>kubelet</code>对象，该部分的具体代码在<code>kubernetes/pkg/kubelet</code>中，具体参考：<a href="https://github.com/kubernetes/kubernetes/blob/0ed33881dc4355495f623c6f22e7dd0b7632b7c0/pkg/kubelet/kubelet.go#L325">kubernetes/pkg/kubelet/kubelet.go#L325</a>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">CreateAndInitKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeStatusMaxImages</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bootstrap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: block until all sources have delivered at least one update to the channel, or break the sync loop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// up into &#34;per source&#34; synchronizations
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMainKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">runtimeCgroups</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">hostnameOverride</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeIP</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">providerID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cloudProvider</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">certDirectory</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">rootDirectory</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">registerNode</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">registerWithTaints</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">allowedUnsafeSysctls</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">remoteRuntimeEndpoint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">remoteImageEndpoint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">experimentalMounterPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">experimentalKernelMemcgNotification</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">experimentalCheckNodeCapabilitiesBeforeMount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">experimentalNodeAllocatableIgnoreEvictionThreshold</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">minimumGCAge</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">maxPerPodContainerCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">maxContainerCount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">masterServiceNamespace</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">registerSchedulable</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nonMasqueradeCIDR</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">keepTerminatedPodVolumes</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeLabels</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">seccompProfileRoot</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">bootstrapCheckpointPath</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeStatusMaxImages</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BirthCry</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartGarbageCollection</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-1-2-podconfig">4.1.2. PodConfig</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">makePodSourceConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bootstrapCheckpointPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>NewMainKubelet--&gt;PodConfig--&gt;NewPodConfig--&gt;kubetypes.PodUpdate</code>。会生成一个<code>podUpdate</code>的channel来监听pod的变化，该channel会在<code>k.Run(podCfg.Updates())</code>中作为关键入参。</p>
<h2 id="4-2-startkubelet">4.2. startKubelet</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// process pods and exit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">runOnce</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunOnce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Updates</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;runonce failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Started kubelet as runonce&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeServer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableServer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Started kubelet&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果设置了只运行一次的参数，则执行<code>k.RunOnce</code>，否则执行核心函数<code>startKubelet</code>。具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">startKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bootstrap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dependencies</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">enableServer</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// start the kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Updates</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// start the kubelet server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">enableServer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseIP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Port</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TLSOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Auth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableDebuggingHandlers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableContentionProfiling</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadOnlyPort</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServeReadOnly</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseIP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadOnlyPort</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="4-2-1-k-run">4.2.1. k.Run</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// start the kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Updates</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>通过长驻进程的方式运行<code>k.Run</code>，不退出，将kubelet的运行逻辑引入<a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L1382">kubernetes/pkg/kubelet/kubelet.go</a>部分，<code>kubernetes/pkg/kubelet</code>部分的运行逻辑待后续文章分析。</p>
<h1 id="5-总结">5. 总结</h1>
<ol>
<li>
<p>kubelet采用<a href="https://github.com/spf13/cobra">Cobra</a>命令行框架和<a href="https://github.com/spf13/pflag">pflag</a>参数解析框架，和apiserver、scheduler、controller-manager形成统一的代码风格。</p>
</li>
<li>
<p><code>kubernetes/cmd/kubelet</code>部分主要对运行参数进行定义和解析，初始化和构造相关的依赖组件（主要在<code>kubeDeps</code>结构体中），并没有kubelet运行的详细逻辑，该部分位于<code>kubernetes/pkg/kubelet</code>模块。</p>
</li>
<li>
<p>cmd部分调用流程如下：<code>Main--&gt;NewKubeletCommand--&gt;Run(kubeletServer, kubeletDeps, stopCh)--&gt;run(s *options.KubeletServer, kubeDeps ..., stopCh ...)--&gt; RunKubelet(s, kubeDeps, s.RunOnce)--&gt;startKubelet--&gt;k.Run(podCfg.Updates())--&gt;pkg/kubelet</code>。</p>
<p>同时<code>RunKubelet(s, kubeDeps, s.RunOnce)--&gt;CreateAndInitKubelet--&gt;kubelet.NewMainKubelet--&gt;pkg/kubelet</code>。</p>
</li>
</ol>
<p>参考文章：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0">https://github.com/kubernetes/kubernetes/tree/v1.12.0</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f143779d871d6a62ac575beff2e8515b">3 - kubelet源码分析（二）之 NewMainKubelet</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
<p>本文主要分析 <a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0/pkg/kubelet">https://github.com/kubernetes/kubernetes/tree/v1.12.0/pkg/kubelet</a> 部分的代码。</p>
</blockquote>
<p>本文主要分析kubelet中的<code>NewMainKubelet</code>部分。</p>
<h1 id="1-newmainkubelet-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l327">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L327">NewMainKubelet</a></h1>
<p><code>NewMainKubelet</code>主要用来初始化和构造一个<code>kubelet</code>结构体，kubelet结构体定义参考:https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L888</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewMainKubelet instantiates a new Kubelet object along with all the required internal modules.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// No initialization of Kubelet and its modules should happen here.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewMainKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Dependencies</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">crOptions</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerRuntimeOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">containerRuntime</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">runtimeCgroups</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">hostnameOverride</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeIP</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">providerID</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cloudProvider</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">certDirectory</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rootDirectory</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">registerNode</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">registerWithTaints</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Taint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">allowedUnsafeSysctls</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">remoteRuntimeEndpoint</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">remoteImageEndpoint</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">experimentalMounterPath</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">experimentalKernelMemcgNotification</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">experimentalCheckNodeCapabilitiesBeforeMount</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">experimentalNodeAllocatableIgnoreEvictionThreshold</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">minimumGCAge</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxPerPodContainerCount</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxContainerCount</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">masterServiceNamespace</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">registerSchedulable</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nonMasqueradeCIDR</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">keepTerminatedPodVolumes</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeLabels</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">seccompProfileRoot</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">bootstrapCheckpointPath</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeStatusMaxImages</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><h2 id="1-1-podconfig">1.1. PodConfig</h2>
<p>通过<code>makePodSourceConfig</code>生成Pod config。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">makePodSourceConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bootstrapCheckpointPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-1-1-makepodsourceconfig">1.1.1. makePodSourceConfig</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// makePodSourceConfig creates a config.PodConfig from the given
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// KubeletConfiguration or returns an error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">makePodSourceConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Dependencies</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bootstrapCheckpointPath</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// source of all configuration
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">cfg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPodConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfigNotificationIncremental</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// define file config source
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StaticPodPath</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Adding pod path: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StaticPodPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSourceFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StaticPodPath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileCheckFrequency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Channel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileSource</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// define url config source
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StaticPodURL</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Adding pod url %q with HTTP header %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StaticPodURL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">manifestURLHeader</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSourceURL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StaticPodURL</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">manifestURLHeader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HTTPCheckFrequency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Channel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HTTPSource</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Restore from the checkpoint path
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// NOTE: This MUST happen before creating the apiserver source
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// below, or the checkpoint would override the source of truth.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Watching apiserver&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">updatechannel</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">updatechannel</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Channel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ApiserverSource</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSourceApiserver</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">updatechannel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-1-2-newpodconfig">1.1.2. NewPodConfig</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewPodConfig creates an object that can merge many configuration sources into a stream
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// of normalized updates to a pod configuration.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewPodConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mode</span> <span style="color:#000">PodConfigNotificationMode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">recorder</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventRecorder</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PodConfig</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">updates</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodUpdate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">storage</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">newPodStorage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">PodConfig</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pods</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">storage</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mux</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMux</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">storage</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">updates</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">updates</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sources</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">podConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-1-3-newsourceapiserver">1.1.3. NewSourceApiserver</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewSourceApiserver creates a config source that watches and pulls from the apiserver.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewSourceApiserver</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">clientset</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">updates</span> <span style="color:#204a87;font-weight:bold">chan</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lw</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewListWatchFromClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;pods&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceAll</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OneTermEqualSelector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodHostField</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">newSourceApiserverFromLW</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lw</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">updates</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-2-lister">1.2. Lister</h2>
<p><code>serviceLister</code>和<code>nodeLister</code>分别通过<code>List-Watch</code>机制监听<code>service</code>和<code>node</code>的列表变化。</p>
<h3 id="1-2-1-servicelister">1.2.1. serviceLister</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">serviceIndexer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewIndexer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MetaNamespaceKeyFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Indexers</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceIndex</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MetaNamespaceIndexFunc</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">serviceLW</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewListWatchFromClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;services&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceAll</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Everything</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewReflector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serviceLW</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Service</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">serviceIndexer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">serviceLister</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">corelisters</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServiceLister</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">serviceIndexer</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-2-2-nodelister">1.2.2. nodeLister</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">nodeIndexer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewIndexer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MetaNamespaceKeyFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Indexers</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fieldSelector</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">api</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectNameField</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)}.</span><span style="color:#000">AsSelector</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeLW</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewListWatchFromClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">RESTClient</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;nodes&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceAll</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fieldSelector</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewReflector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeLW</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">nodeIndexer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CachedNodeInfo</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">corelisters</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewNodeLister</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeIndexer</span><span style="color:#000;font-weight:bold">)}</span>
</span></span></code></pre></div><h2 id="1-3-各种manager">1.3. 各种Manager</h2>
<h3 id="1-3-1-containerrefmanager">1.3.1. containerRefManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">containerRefManager</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRefManager</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="1-3-2-oomwatcher">1.3.2. oomWatcher</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">oomWatcher</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewOOMWatcher</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CAdvisorInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-3-dnsconfigurer">1.3.3. dnsConfigurer</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">clusterDNS</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClusterDNS</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ipEntry</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClusterDNS</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ip</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseIP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ipEntry</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ip</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Invalid clusterDNS ip &#39;%q&#39;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ipEntry</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">clusterDNS</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clusterDNS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ip</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">dns</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewConfigurer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">parsedNodeIP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clusterDNS</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClusterDomain</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResolverConfig</span><span style="color:#000;font-weight:bold">),</span>
</span></span></code></pre></div><h3 id="1-3-4-secretmanager-configmapmanager">1.3.4. secretManager &amp; configMapManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">secretManager</span> <span style="color:#000">secret</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">configMapManager</span> <span style="color:#000">configmap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Manager</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigMapAndSecretChangeDetectionStrategy</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WatchChangeDetectionStrategy</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">secretManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">secret</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewWatchingSecretManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">configMapManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">configmap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewWatchingConfigMapManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TTLCacheChangeDetectionStrategy</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">secretManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">secret</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCachingSecretManager</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetObjectTTLFromNodeFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNode</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">configMapManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">configmap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCachingConfigMapManager</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">manager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetObjectTTLFromNodeFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNode</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetChangeDetectionStrategy</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">secretManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">secret</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSimpleSecretManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">configMapManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">configmap</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSimpleConfigMapManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unknown configmap and secret manager mode: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigMapAndSecretChangeDetectionStrategy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">secretManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">secretManager</span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">configMapManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">configMapManager</span>
</span></span></code></pre></div><h3 id="1-3-5-livenessmanager">1.3.5. livenessManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">livenessManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">proberesults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="1-3-6-podmanager">1.3.6. podManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// podManager is also responsible for keeping secretManager and configMapManager contents up-to-date.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kubepod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBasicPodManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubepod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBasicMirrorClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">secretManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">configMapManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">checkpointManager</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-7-resourceanalyzer">1.3.7. resourceAnalyzer</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resourceAnalyzer</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">serverstats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewResourceAnalyzer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumeStatsAggPeriod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-8-containergc">1.3.8. containerGC</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// setup containerGC
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">containerGC</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewContainerGC</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerGCPolicy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sourcesReady</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerGC</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">containerGC</span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerDeletor</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newPodContainerDeletor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">integer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IntMax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerGCPolicy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxPerPodContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">minDeadContainerInPod</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h3 id="1-3-9-imagemanager">1.3.9. imageManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// setup imageManager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">imageManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">images</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewImageGCManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatsProvider</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">imageGCPolicy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodSandboxImage</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to initialize image manager: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">imageManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">imageManager</span>
</span></span></code></pre></div><h3 id="1-3-10-statusmanager">1.3.10. statusManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-11-probemanager">1.3.11. probeManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">prober</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">livenessManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runner</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">containerRefManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-12-tokenmanager">1.3.12. tokenManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">tokenManager</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">token</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeClient</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-13-volumepluginmgr">1.3.13. volumePluginMgr</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumePluginMgr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">NewInitializedVolumePluginMgr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">secretManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">configMapManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tokenManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumePlugins</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DynamicPluginProber</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">enablePluginsWatcher</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pluginWatcher</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pluginwatcher</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewWatcher</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPluginsDir</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-3-14-volumemanager">1.3.14. volumeManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// setup volumeManager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">volumemanager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewVolumeManager</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableControllerAttachDetach</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumePluginMgr</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mounter</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodsDir</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">experimentalCheckNodeCapabilitiesBeforeMount</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">keepTerminatedPodVolumes</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-3-15-evictionmanager">1.3.15. evictionManager</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// setup eviction manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">evictionManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evictionAdmitHandler</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">eviction</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewManager</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resourceAnalyzer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evictionConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">killPodNow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">imageManager</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerGC</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">evictionManager</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">evictionManager</span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">admitHandlers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPodAdmitHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">evictionAdmitHandler</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="1-4-containerruntime">1.4. containerRuntime</h2>
<p>目前pod所使用的<code>runtime</code>只有<code>docker</code>和<code>remote</code>两种，<code>rkt</code>已经废弃。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">containerRuntime</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;rkt&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;rktnetes has been deprecated in favor of rktlet. Please see https://github.com/kubernetes-incubator/rktlet for more information.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>当<code>runtime</code>是<code>docker</code>的时候，会执行<code>docker</code>相关操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">containerRuntime</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DockerContainerRuntime</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Create and start the CRI shim running as a grpc server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// The unix socket for kubelet &lt;-&gt; dockershim communication.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Create dockerLegacyService when the logging driver is not supported.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoteContainerRuntime</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// No-op.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unsupported CRI runtime: %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-4-1-newdockerservice">1.4.1. NewDockerService</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create and start the CRI shim running as a grpc server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">streamingConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">getStreamingConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dockershim</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDockerService</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DockerClientConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodSandboxImage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">streamingConfig</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pluginSettings</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runtimeCgroups</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupDriver</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DockershimRootDirectory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RedirectContainerStreaming</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">crOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RedirectContainerStreaming</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">criHandler</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ds</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-4-2-newdockerserver">1.4.2. NewDockerServer</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The unix socket for kubelet &lt;-&gt; dockershim communication.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;RemoteRuntimeEndpoint: %q, RemoteImageEndpoint: %q&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">remoteRuntimeEndpoint</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">remoteImageEndpoint</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting the GRPC server for the docker CRI shim.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">dockerremote</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewDockerServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">remoteRuntimeEndpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ds</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="1-4-3-dockerserver-start">1.4.3. DockerServer.Start</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start starts the dockershim grpc server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">DockerServer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the internal service.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unable to start docker service&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Start dockershim grpc server&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">l</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateListener</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endpoint</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to listen on %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">endpoint</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Create the grpc server and register runtime and image services.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServer</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxRecvMsgSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxMsgSize</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxSendMsgSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxMsgSize</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">runtimeapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterRuntimeServiceServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">runtimeapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterImageServiceServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">service</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Serve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">l</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to serve connections: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="1-5-podworker">1.5. podWorker</h2>
<p>构造<code>podWorkers</code>和<code>workQueue</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workQueue</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBasicWorkQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newPodWorkers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncInterval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backOffPeriod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="1-5-1-podworkers接口">1.5.1. PodWorkers接口</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodWorkers is an abstract interface for testability.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PodWorkers</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ForgetNonExistingPodWorkers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">desiredPods</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ForgetWorker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>podWorker</code>主要用来对pod相应事件进行处理和同步，包含以下三个方法：<code>UpdatePod</code>、<code>ForgetNonExistingPodWorkers</code>、<code>ForgetWorker</code>。</p>
<h1 id="2-总结">2. 总结</h1>
<ol>
<li>
<p><code>NewMainKubelet</code>主要用来构造<code>kubelet</code>结构体，其中kubelet除了包含必要的配置和client（例如：kubeClient、csiClient等）外，最主要的包含各种manager来管理不同的任务。</p>
</li>
<li>
<p>核心的manager有以下几种：</p>
<ul>
<li><code>oomWatcher</code>：监控pod内存是否发生OOM。</li>
<li><code>podManager</code>：管理pod的生命周期，包括对pod的增删改查操作等。</li>
<li><code>containerGC</code>：对死亡容器进行垃圾回收。</li>
<li><code>imageManager</code>：对容器镜像进行垃圾回收。</li>
<li><code>statusManager</code>：与apiserver同步pod状态，同时也作状态缓存。</li>
<li><code>volumeManager</code>：对pod的volume进行<code>attached/detached/mounted/unmounted</code>操作。</li>
<li><code>evictionManager</code>：保证节点稳定，必要时对pod进行驱逐（例如资源不足的情况下）。</li>
</ul>
</li>
<li>
<p><code>NewMainKubelet</code>还包含了<code>serviceLister</code>和<code>nodeLister</code>来监听<code>service</code>和<code>node</code>的列表变化。</p>
</li>
<li>
<p>kubelet使用到的<code>containerRuntime</code>目前主要是<code>docker</code>，其中<code>rkt</code>已废弃。<code>NewMainKubelet</code>启动了<code>dockershim grpc server</code>来执行docker相关操作。</p>
</li>
<li>
<p>构建了<code>podWorker</code>来对pod相关的更新逻辑进行处理。</p>
</li>
</ol>
<p>参考文章：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0">https://github.com/kubernetes/kubernetes/tree/v1.12.0</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0/pkg/kubelet">https://github.com/kubernetes/kubernetes/tree/v1.12.0/pkg/kubelet</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-81cae8093c76076822c064c1cb2ac31c">4 - kubelet源码分析（三）之 RunKubelet</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析<code>startKubelet</code>，其中主要是<code>kubelet.Run</code>部分，该部分的内容主要是初始化并运行一些manager。对于kubelet所包含的各种manager的执行逻辑和pod的生命周期管理逻辑待后续文章分析。</p>
<p>后续的文章主要会分类分析<code>pkg/kubelet</code>部分的代码实现。</p>
<p><code>kubelet</code>的<code>pkg</code>代码目录结构：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubelet
</span></span><span style="display:flex;"><span>├── apis  <span style="color:#8f5902;font-style:italic"># 定义一些相关接口</span>
</span></span><span style="display:flex;"><span>├── cadvisor <span style="color:#8f5902;font-style:italic"># cadvisor</span>
</span></span><span style="display:flex;"><span>├── cm <span style="color:#8f5902;font-style:italic"># ContainerManager、cpu manger、cgroup manager </span>
</span></span><span style="display:flex;"><span>├── config
</span></span><span style="display:flex;"><span>├── configmap <span style="color:#8f5902;font-style:italic"># configmap manager</span>
</span></span><span style="display:flex;"><span>├── container  <span style="color:#8f5902;font-style:italic"># Runtime、ImageService</span>
</span></span><span style="display:flex;"><span>├── dockershim  <span style="color:#8f5902;font-style:italic"># docker的相关调用</span>
</span></span><span style="display:flex;"><span>├── eviction <span style="color:#8f5902;font-style:italic"># eviction manager</span>
</span></span><span style="display:flex;"><span>├── images  <span style="color:#8f5902;font-style:italic"># image manager</span>
</span></span><span style="display:flex;"><span>├── kubeletconfig  
</span></span><span style="display:flex;"><span>├── kuberuntime <span style="color:#8f5902;font-style:italic"># 核心：kubeGenericRuntimeManager、runtime容器的相关操作</span>
</span></span><span style="display:flex;"><span>├── lifecycle
</span></span><span style="display:flex;"><span>├── mountpod
</span></span><span style="display:flex;"><span>├── network  <span style="color:#8f5902;font-style:italic"># pod dns</span>
</span></span><span style="display:flex;"><span>├── nodelease
</span></span><span style="display:flex;"><span>├── nodestatus  <span style="color:#8f5902;font-style:italic"># MachineInfo、节点相关信息</span>
</span></span><span style="display:flex;"><span>├── pleg  <span style="color:#8f5902;font-style:italic"># PodLifecycleEventGenerator</span>
</span></span><span style="display:flex;"><span>├── pod  <span style="color:#8f5902;font-style:italic"># 核心：pod manager、mirror pod</span>
</span></span><span style="display:flex;"><span>├── preemption
</span></span><span style="display:flex;"><span>├── qos  <span style="color:#8f5902;font-style:italic"># 资源服务质量，不过暂时内容很少</span>
</span></span><span style="display:flex;"><span>├── remote <span style="color:#8f5902;font-style:italic"># RemoteRuntimeService</span>
</span></span><span style="display:flex;"><span>├── server
</span></span><span style="display:flex;"><span>├── stats <span style="color:#8f5902;font-style:italic"># StatsProvider</span>
</span></span><span style="display:flex;"><span>├── status <span style="color:#8f5902;font-style:italic"># status manager</span>
</span></span><span style="display:flex;"><span>├── types  <span style="color:#8f5902;font-style:italic"># PodUpdate、PodOperation</span>
</span></span><span style="display:flex;"><span>├── volumemanager <span style="color:#8f5902;font-style:italic"># VolumeManager</span>
</span></span><span style="display:flex;"><span>├── kubelet.go  <span style="color:#8f5902;font-style:italic"># 核心: SyncHandler、kubelet的大部分操作</span>
</span></span><span style="display:flex;"><span>├── kubelet_getters.go <span style="color:#8f5902;font-style:italic"># 各种get操作，例如获取相关目录：getRootDir、getPodsDir、getPluginsDir</span>
</span></span><span style="display:flex;"><span>├── kubelet_network.go <span style="color:#8f5902;font-style:italic"># </span>
</span></span><span style="display:flex;"><span>├── kubelet_network_linux.go
</span></span><span style="display:flex;"><span>├── kubelet_node_status.go <span style="color:#8f5902;font-style:italic"># registerWithAPIServer、initialNode、syncNodeStatus</span>
</span></span><span style="display:flex;"><span>├── kubelet_pods.go <span style="color:#8f5902;font-style:italic"># 核心：pod的增删改查等相关操作、podKiller、</span>
</span></span><span style="display:flex;"><span>├── kubelet_resources.go
</span></span><span style="display:flex;"><span>├── kubelet_volumes.go <span style="color:#8f5902;font-style:italic"># ListVolumesForPod、cleanupOrphanedPodDirs</span>
</span></span><span style="display:flex;"><span>├── oom_watcher.go  <span style="color:#8f5902;font-style:italic"># OOMWatcher</span>
</span></span><span style="display:flex;"><span>├── pod_container_deletor.go
</span></span><span style="display:flex;"><span>├── pod_workers.go <span style="color:#8f5902;font-style:italic"># 核心：PodWorkers、UpdatePodOptions、syncPodOptions、managePodLoop</span>
</span></span><span style="display:flex;"><span>├── runonce.go  <span style="color:#8f5902;font-style:italic"># RunOnce</span>
</span></span><span style="display:flex;"><span>├── runtime.go
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><h1 id="1-startkubelet-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kubelet-app-server-go-l1018">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/server.go#L1018">startKubelet</a></h1>
<p><code>startKubelet</code>的函数位于<code>cmd/kubelet/app/server.go</code>，启动并运行一个kubelet，运行kubelet的逻辑代码位于<code>pkg/kubelet/kubelet.go</code>。</p>
<p><strong>主要内容如下：</strong></p>
<ol>
<li>运行一个kubelet，执行kubelet中各种manager的相关逻辑。</li>
<li>运行kubelet server启动监听服务。</li>
</ol>
<blockquote>
<p>此部分代码位于cmd/kubelet/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">startKubelet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bootstrap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeletconfiginternal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubelet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dependencies</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">enableServer</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// start the kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Updates</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// start the kubelet server
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">enableServer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseIP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Port</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TLSOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Auth</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableDebuggingHandlers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnableContentionProfiling</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadOnlyPort</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServeReadOnly</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseIP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Address</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeCfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadOnlyPort</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-kubelet-run-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l1382">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L1382">Kubelet.Run</a></h1>
<p><code>Kubelet.Run</code>方法主要将<code>NewMainKubelet</code>构造的各种manager运行起来，让各种manager执行相应的功能，大部分manager为常驻进程的方式运行。</p>
<p>Kubelet.Run完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/kubelet.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run starts the kubelet reacting to config updates
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodUpdate</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logServer</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">logServer</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StripPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/logs/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FileServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/var/log/&#34;</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warning</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;No api server defined - no node status update will be sent.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the cloud provider sync manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cloudResourceSyncManager</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cloudResourceSyncManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">initializeModules</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KubeletSetupFailed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start volume manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sourcesReady</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Start syncing node status immediately, this may set up things the runtime needs to run.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncNodeStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeStatusUpdateFrequency</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fastStatusUpdateOnce</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// start syncing lease
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLease</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeLeaseController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateRuntimeUp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start loop to sync iptables util rules
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">makeIPTablesUtilChains</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncNetworkUtil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Minute</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start a goroutine responsible for killing pods (that are not properly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// handled by pod workers).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podKiller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start component sync loops.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start syncing RuntimeClasses if enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeClassManager</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeClassManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the pod lifecycle event generator.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pleg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<p>以下对<code>Kubelet.Run</code>分段进行分析。</p>
<h1 id="3-initializemodules">3. initializeModules</h1>
<p><code>initializeModules</code>包含了<code>imageManager</code>、<code>serverCertificateManager</code>、<code>oomWatcher</code>和<code>resourceAnalyzer</code>。</p>
<p><strong>主要流程如下：</strong></p>
<ol>
<li>创建文件系统目录，包括kubelet的root目录、pods的目录、plugins的目录和容器日志目录。</li>
<li>启动imageManager、serverCertificateManager、oomWatcher、resourceAnalyzer。</li>
</ol>
<p><strong>各种manager的说明如下：</strong></p>
<ul>
<li><code>imageManager</code>：负责镜像垃圾回收。</li>
<li><code>serverCertificateManager</code>：负责处理证书。</li>
<li><code>oomWatcher</code>：监控内存使用，是否发生内存耗尽。</li>
<li><code>resourceAnalyzer</code>：监控资源使用情况。</li>
</ul>
<p>完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/kubelet.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// initializeModules will initialize internal modules that do not require the container runtime to be up.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Note that the modules here must not depend on modules that are not initialized here.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">initializeModules</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Prometheus metrics.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeCache</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">collectors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewVolumeStatsCollector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Setup filesystem directories.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setupDataDirs</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If the container logs directory does not exist, create it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ContainerLogsDir</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ContainerLogsDir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0755</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create directory %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ContainerLogsDir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the image manager.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">imageManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the certificate manager if it was enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCertificateManager</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCertificateManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start out of memory watcher.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oomWatcher</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeRef</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to start OOM watcher %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start resource analyzer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resourceAnalyzer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-1-setupdatadirs">3.1. setupDataDirs</h2>
<p><code>initializeModules</code>先创建相关目录。</p>
<p>具体目录如下：</p>
<ul>
<li><code>ContainerLogsDir</code>：目录为/var/log/containers。</li>
<li><code>rootDirectory</code>：由参数传入，一般为<code>/var/lib/kubelet</code>。</li>
<li><code>PodsDir</code>：目录为{rootDirectory}/pods。</li>
<li><code>PluginsDir</code>：目录为{rootDirectory}/plugins。</li>
</ul>
<p><strong>initializeModules中setupDataDirs的相关代码如下：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Setup filesystem directories.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setupDataDirs</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If the container logs directory does not exist, create it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ContainerLogsDir</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ContainerLogsDir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0755</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create directory %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ContainerLogsDir</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>setupDataDirs代码如下</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// setupDataDirs creates:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 1.  the root directory
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 2.  the pods directory
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 3.  the plugins directory
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">setupDataDirs</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rootDirectory</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Clean</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rootDirectory</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getRootDir</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">0750</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error creating root directory: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mounter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MakeRShared</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getRootDir</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error configuring root directory: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodsDir</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">0750</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error creating pods directory: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPluginsDir</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">0750</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error creating plugins directory: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-manager">3.2. manager</h2>
<p><strong>initializeModules中的manager如下：</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start the image manager.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">imageManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start the certificate manager if it was enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCertificateManager</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serverCertificateManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start out of memory watcher.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">oomWatcher</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeRef</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to start OOM watcher %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start resource analyzer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resourceAnalyzer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h1 id="4-运行各种manager">4. 运行各种manager</h1>
<h2 id="4-1-volumemanager">4.1. volumeManager</h2>
<p><code>volumeManager</code>主要运行一组异步循环，根据在此节点上安排的pod调整哪些volume需要<code>attached/detached/mounted/unmounted</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start volume manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sourcesReady</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>volumeManager.Run</code>实现代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">vm</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">volumeManager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sourcesReady</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SourcesReady</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">vm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">desiredStateOfWorldPopulator</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sourcesReady</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;The desired_state_of_world populator starts&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting Kubelet Volume Manager&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">vm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reconciler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">actualStateOfWorld</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">desiredStateOfWorld</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumePluginMgr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Shutting down Kubelet Volume Manager&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-2-syncnodestatus">4.2. syncNodeStatus</h2>
<p><code>syncNodeStatus</code>通过goroutine的方式定期执行，它将节点的状态同步给master，必要的时候注册kubelet。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start syncing node status immediately, this may set up things the runtime needs to run.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncNodeStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeStatusUpdateFrequency</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fastStatusUpdateOnce</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// start syncing lease
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLease</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeLeaseController</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-3-updateruntimeup">4.3. updateRuntimeUp</h2>
<p><code>updateRuntimeUp</code>调用容器运行时状态回调，在容器运行时首次启动时初始化运行时相关模块，如果状态检查失败则返回错误。 如果状态检查正常，在kubelet runtimeState中更新容器运行时的正常运行时间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateRuntimeUp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="4-4-syncnetworkutil">4.4. syncNetworkUtil</h2>
<p>通过循环的方式同步iptables的规则，不过当前代码并没有执行任何操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start loop to sync iptables util rules
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">makeIPTablesUtilChains</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncNetworkUtil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Minute</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-5-podkiller">4.5. podKiller</h2>
<p>但pod没有被podworker正确处理的时候，启动一个goroutine负责杀死pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start a goroutine responsible for killing pods (that are not properly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// handled by pod workers).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podKiller</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>podKiller</code>代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/kubelet_pods.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// podKiller launches a goroutine to kill a pod received from the channel if
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// another goroutine isn&#39;t already in action.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">podKiller</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">killing</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// guard for the killing set
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">lock</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">podPair</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podKillingCh</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">runningPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podPair</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunningPod</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">apiPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podPair</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">APIPod</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">exists</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">killing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Has</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">killing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">apiPod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runningPod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Killing unwanted pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">apiPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed killing the pod %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">killing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">apiPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-6-statusmanager">4.6. statusManager</h2>
<p>使用apiserver同步pods状态; 也用作状态缓存。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start component sync loops.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><code>statusManager.Start</code>的实现代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">manager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Don&#39;t start the status manager if we don&#39;t have a client. This will happen
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// on the master, where the kubelet is responsible for bootstrapping the pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// of the master components.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">kubeClient</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Kubernetes client is nil, not starting status manager.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting to sync pod status with apiserver&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">syncTicker</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Tick</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncPeriod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// syncPod and syncBatch share the same go routine to avoid sync races.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Forever</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">syncRequest</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podStatusChannel</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Status Manager: syncing pod: %q, with status: (%d, %v) from podStatusChannel&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">syncRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podUID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">version</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podUID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">syncTicker</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncBatch</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-7-probemanager">4.7. probeManager</h2>
<p>处理容器探针</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h2 id="4-8-runtimeclassmanager">4.8. runtimeClassManager</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start syncing RuntimeClasses if enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeClassManager</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeClassManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-9-podlifecycleeventgenerator">4.9. PodLifecycleEventGenerator</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start the pod lifecycle event generator.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pleg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><code>PodLifecycleEventGenerator</code>是一个pod生命周期时间生成器接口，具体如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodLifecycleEventGenerator contains functions for generating pod life cycle events.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PodLifecycleEventGenerator</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PodLifecycleEvent</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Healthy</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>start方法具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start spawns a goroutine to relist periodically.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">GenericPLEG</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relist</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relistPeriod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeverStop</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-10-syncloop">4.10. syncLoop</h2>
<p>最后调用<code>syncLoop</code>来执行同步变化变更的循环。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="5-syncloop">5. syncLoop</h1>
<p><code>syncLoop</code>是处理变化的循环。 它监听来自三种channel（file，apiserver和http）的更改。 对于看到的任何新更改，将针对所需状态和运行状态运行同步。 如果没有看到配置的变化，将在每个同步频率秒同步最后已知的所需状态。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// syncLoop is the main loop for processing changes. It watches for changes from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// three channels (file, apiserver, and http) and creates a union of them. For
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// any new change seen, will run a sync against desired state and running state. If
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// no changes are seen to the configuration, will synchronize the last known desired
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// state every sync-frequency seconds. Never returns.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodUpdate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#000">SyncHandler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting kubelet main sync loop.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// The resyncTicker wakes up kubelet to checks if there are any pod workers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// that need to be sync&#39;d. A one-second period is sufficient because the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// sync interval is defaulted to 10s.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">syncTicker</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTicker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">syncTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">housekeepingTicker</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTicker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">housekeepingPeriod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">housekeepingTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">plegCh</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pleg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">base</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">max</span>    <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factor</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">duration</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">base</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeState</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeErrors</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;skipping pod synchronization - %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// exponential backoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">duration</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">duration</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">factor</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">duration</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// reset backoff if we have a success
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">duration</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">base</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoopMonitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoopIteration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">C</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">housekeepingTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">C</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plegCh</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoopMonitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中调用了<code>syncLoopIteration</code>的函数来执行更具体的监控pod变化的循环。<code>syncLoopIteration</code>代码逻辑待后续单独分析。</p>
<h1 id="6-总结">6. 总结</h1>
<h2 id="6-1-基本流程">6.1. 基本流程</h2>
<p><code>Kubelet.Run</code>主要流程如下：</p>
<ol>
<li>初始化模块，其实就是运行<code>imageManager</code>、<code>serverCertificateManager</code>、<code>oomWatcher</code>、<code>resourceAnalyzer</code>。</li>
<li>运行各种manager，大部分以常驻goroutine的方式运行，其中包括<code>volumeManager</code>、<code>statusManager</code>等。</li>
<li>执行处理变更的循环函数<code>syncLoop</code>，对pod的生命周期进行管理。</li>
</ol>
<p><strong>syncLoop：</strong></p>
<p><code>syncLoop</code>函数，对pod的生命周期进行管理，其中<code>syncLoop</code>调用了<code>syncLoopIteration</code>函数，该函数根据<code>podUpdate</code>的信息，针对不同的操作，由<code>SyncHandler</code>来执行pod的增删改查等生命周期的管理，其中的<code>syncHandler</code>包括<code>HandlePodSyncs</code>和<code>HandlePodCleanups</code>等。该部分逻辑待后续文章具体分析。</p>
<h2 id="6-2-manager">6.2. Manager</h2>
<p>以下介绍kubelet运行时涉及到的manager的内容。</p>
<table>
<thead>
<tr>
<th>manager</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>imageManager</td>
<td>负责镜像垃圾回收</td>
</tr>
<tr>
<td>serverCertificateManager</td>
<td>负责处理证书</td>
</tr>
<tr>
<td>oomWatcher</td>
<td>监控内存使用，是否发生内存耗尽即OOM</td>
</tr>
<tr>
<td>resourceAnalyzer</td>
<td>监控资源使用情况</td>
</tr>
<tr>
<td>volumeManager</td>
<td>对pod执行<code>attached/detached/mounted/unmounted</code>操作</td>
</tr>
<tr>
<td>statusManager</td>
<td>使用apiserver同步pods状态; 也用作状态缓存</td>
</tr>
<tr>
<td>probeManager</td>
<td>处理容器探针</td>
</tr>
<tr>
<td>runtimeClassManager</td>
<td>同步RuntimeClasses</td>
</tr>
<tr>
<td>podKiller</td>
<td>负责杀死pod</td>
</tr>
</tbody>
</table>
<p>参考文章：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/server.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kubelet/app/server.go</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a2b7e6297d422710a490f3a64d66c478">5 - kubelet源码分析（四）之 syncLoopIteration</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析kubelet中<code>syncLoopIteration</code>部分。<code>syncLoopIteration</code>通过几种<code>channel</code>来对不同类型的事件进行监听并做增删改查的处理。</p>
<h1 id="1-syncloop">1. syncLoop</h1>
<p><code>syncLoop</code>是处理变更的循环。 它监听来自三种channel（file，apiserver和http）的更改。 对于看到的任何新更改，将针对所需状态和运行状态运行同步。 如果没有看到配置的变化，将在每个同步频率秒同步最后已知的所需状态。</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/kubelet.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// syncLoop is the main loop for processing changes. It watches for changes from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// three channels (file, apiserver, and http) and creates a union of them. For
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// any new change seen, will run a sync against desired state and running state. If
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// no changes are seen to the configuration, will synchronize the last known desired
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// state every sync-frequency seconds. Never returns.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodUpdate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#000">SyncHandler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting kubelet main sync loop.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// The resyncTicker wakes up kubelet to checks if there are any pod workers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// that need to be sync&#39;d. A one-second period is sufficient because the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// sync interval is defaulted to 10s.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">syncTicker</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTicker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">syncTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">housekeepingTicker</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTicker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">housekeepingPeriod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">housekeepingTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">plegCh</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pleg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Watch</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">base</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">max</span>    <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factor</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">duration</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">base</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeState</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeErrors</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;skipping pod synchronization - %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// exponential backoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">duration</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">duration</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">factor</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">duration</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// reset backoff if we have a success
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">duration</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">base</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoopMonitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoopIteration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">updates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">C</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">housekeepingTicker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">C</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plegCh</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncLoopMonitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Store</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中调用了<code>syncLoopIteration</code>的函数来执行更具体的监控pod变化的循环。</p>
<h1 id="2-syncloopiteration-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l1870">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L1870">syncLoopIteration</a></h1>
<p><code>syncLoopIteration</code>主要通过几种<code>channel</code>来对不同类型的事件进行监听并处理。其中包括：<code>configCh</code>、<code>plegCh</code>、<code>syncCh</code>、<code>houseKeepingCh</code>、<code>livenessManager.Updates()</code>。</p>
<p><code>syncLoopIteration</code>实际执行了pod的操作，此部分设置了几种不同的channel:</p>
<ul>
<li><code>configCh</code>：将配置更改的pod分派给事件类型的相应处理程序回调。</li>
<li><code>plegCh</code>：更新runtime缓存，同步pod。</li>
<li><code>syncCh</code>：同步所有等待同步的pod。</li>
<li><code>houseKeepingCh</code>：触发清理pod。</li>
<li><code>livenessManager.Updates()</code>：对失败的pod或者liveness检查失败的pod进行sync操作。</li>
</ul>
<blockquote>
<p>syncLoopIteration部分代码位于pkg/kubelet/kubelet.go</p>
</blockquote>
<h2 id="2-1-configch">2.1. configCh</h2>
<p><code>configCh</code>将配置更改的pod分派给事件类型的相应处理程序回调，该部分主要通过<code>SyncHandler</code>对pod的不同事件进行增删改查等操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncLoopIteration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">configCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodUpdate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handler</span> <span style="color:#000">SyncHandler</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">syncCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">housekeepingCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">plegCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pleg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodLifecycleEvent</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">open</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">configCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Update from a config source; dispatch it to the right handler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// callback.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">open</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Update channel is closed. Exiting the sync loop.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Op</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ADD</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (ADD, %q): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// After restarting, kubelet will get all existing pods through
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// ADD as if they are new pods. These pods will then go through the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// admission process and *may* be rejected. This can be resolved
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// once we have checkpointing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodAdditions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UPDATE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (UPDATE, %q): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodsWithDeletionTimestamps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodUpdates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">REMOVE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (REMOVE, %q): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodRemoves</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RECONCILE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (RECONCILE, %q): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodReconcile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DELETE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (DELETE, %q): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// DELETE is treated as a UPDATE because of graceful deletion.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodUpdates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RESTORE</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (RESTORE, %q): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// These are pods restored from the checkpoint. Treat them as new
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodAdditions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SET</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// TODO: Do we want to support this?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Kubelet does not support snapshot update&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>可以看出<code>syncLoopIteration</code>根据<code>podUpdate</code>的值来执行不同的pod操作，具体如下：</p>
<ul>
<li><code>ADD</code>：HandlePodAdditions</li>
<li><code>UPDATE</code>：HandlePodUpdates</li>
<li><code>REMOVE</code>：HandlePodRemoves</li>
<li><code>RECONCILE</code>：HandlePodReconcile</li>
<li><code>DELETE</code>：HandlePodUpdates</li>
<li><code>RESTORE</code>：HandlePodAdditions</li>
<li><code>podsToSync</code>：HandlePodSyncs</li>
</ul>
<p>其中执行pod的handler操作的是<code>SyncHandler</code>，该类型是一个接口，实现体为kubelet本身，具体见后续分析。</p>
<h2 id="2-2-plegch">2.2. plegCh</h2>
<p><code>plegCh</code>：更新runtime缓存，同步pod。此处调用了<code>HandlePodSyncs</code>的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">plegCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isSyncPodWorthy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// PLEG event for a pod; sync it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodByUID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (PLEG): %q, event: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodSyncs</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// If the pod no longer exists, ignore the event.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (PLEG): ignore irrelevant event: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">pleg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerDied</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Data</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cleanUpContainersInPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-syncch">2.3. syncCh</h2>
<p><code>syncCh</code>：同步所有等待同步的pod。此处调用了<code>HandlePodSyncs</code>的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">syncCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Sync pods waiting for sync
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">podsToSync</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodsToSync</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podsToSync</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (SYNC): %d pods; %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podsToSync</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podsToSync</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodSyncs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podsToSync</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-4-livenessmanager-update">2.4. livenessManager.Update</h2>
<p><code>livenessManager.Updates()</code>：对失败的pod或者liveness检查失败的pod进行sync操作。此处调用了<code>HandlePodSyncs</code>的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">update</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">livenessManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Updates</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Result</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">proberesults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Failure</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// The liveness manager detected a failure; sync the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// We should not use the pod from livenessManager, because it is never updated after
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// initialization.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodByUID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodUID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// If the pod no longer exists, ignore the update.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (container unhealthy): ignore irrelevant update: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (container unhealthy): %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodSyncs</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-5-housekeepingch">2.5. housekeepingCh</h2>
<p><code>houseKeepingCh</code>：触发清理pod。此处调用了<code>HandlePodCleanups</code>的函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">housekeepingCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sourcesReady</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllReady</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// If the sources aren&#39;t ready or volume manager has not yet synced the states,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// skip housekeeping, as we may accidentally delete pods from unready sources.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (housekeeping, skipped): sources aren&#39;t ready yet.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncLoop (housekeeping)&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">handler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlePodCleanups</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed cleaning pods: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-synchandler-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l177">3. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L177">SyncHandler</a></h1>
<p><code>SyncHandler</code>是一个定义Pod的不同Handler的接口，具体是实现者是<code>kubelet</code>，该接口的方法主要在<a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L1870">syncLoopIteration</a>中调用，接口定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// SyncHandler is an interface implemented by Kubelet, for testability
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">SyncHandler</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">HandlePodAdditions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">HandlePodUpdates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">HandlePodRemoves</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">HandlePodReconcile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">HandlePodSyncs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">HandlePodCleanups</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p>SyncHandler部分代码位于pkg/kubelet/kubelet.go</p>
</blockquote>
<h2 id="3-1-handlepodadditions-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l2021">3.1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L2021">HandlePodAdditions</a></h2>
<p><code>HandlePodAdditions</code>先根据pod创建时间对pod进行排序，然后遍历pod列表，来执行pod的相关操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandlePodAdditions is the callback in SyncHandler for pods being added from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// a config source.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandlePodAdditions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sort</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sliceutils</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodsByCreationTime</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>将pod添加到pod manager中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Responsible for checking limits in resolv.conf
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dnsConfigurer</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dnsConfigurer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResolverConfig</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dnsConfigurer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckLimitsForResolvConf</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">existingPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPods</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Always add the pod to the pod manager. Kubelet relies on the pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// manager as the source of truth for the desired state. If a pod does
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// not exist in the pod manager, it means that it has been deleted in
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the apiserver and no action (other than cleanup) is required.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>如果是mirror pod，则对mirror pod进行处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubepod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handleMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果当前pod的状态不是<code>Terminated</code>状态，则判断是否接受该pod，如果不接受则将pod状态改为<code>Failed</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podIsTerminated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Only go through the admission process if the pod is not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// terminated.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We failed pods that we rejected, so activePods include all admitted
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// pods that are alive.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">activePods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filterOutTerminatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">existingPods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Check if we can admit the pod; if not, reject it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ok</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reason</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">canAdmitPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">activePods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rejectPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reason</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>执行<code>dispatchWork</code>函数，该函数是syncHandler中调用到的核心函数，该函数在pod worker中启动一个异步循环，来分派pod的相关操作。该函数的具体操作待后续分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMirrorPodByPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dispatchWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodCreate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>最后加pod添加到probe manager中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="3-2-handlepodupdates-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l2063">3.2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L2063">HandlePodUpdates</a></h2>
<p><code>HandlePodUpdates</code>同样遍历pod列表，执行相应的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandlePodUpdates is the callback in the SyncHandler interface for pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// being updated from a config source.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandlePodUpdates</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>将pod更新到pod manager中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Responsible for checking limits in resolv.conf
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dnsConfigurer</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dnsConfigurer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResolverConfig</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dnsConfigurer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckLimitsForResolvConf</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>如果是mirror pod，则对mirror pod进行处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubepod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handleMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>执行<code>dispatchWork</code>函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: Evaluate if we need to validate and reject updates.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMirrorPodByPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dispatchWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodUpdate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="3-3-handlepodremoves-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l2084">3.3. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L2084">HandlePodRemoves</a></h2>
<p><code>HandlePodRemoves</code>遍历pod列表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandlePodRemoves is the callback in the SyncHandler interface for pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// being removed from a config source.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandlePodRemoves</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>从pod manager中删除pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>如果是mirror pod，则对mirror pod进行处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubepod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">handleMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>调用kubelet的<code>deletePod</code>函数来删除pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Deletion is allowed to fail because the periodic cleanup routine
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// will trigger deletion again.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to delete pod %q, err: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>deletePod</code> 函数将需要删除的pod加入<code>podKillingCh</code>的channel中，有<code>podKiller</code>监听这个channel去执行删除任务，实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// deletePod deletes the pod from the internal state of the kubelet by:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 1.  stopping the associated pod worker asynchronously
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 2.  signaling to kill the pod by sending on the podKillingCh channel
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// deletePod returns an error if not all sources are ready or the pod is not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// found in the runtime cache.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">deletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;deletePod does not allow nil pod&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sourcesReady</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllReady</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// If the sources aren&#39;t ready, skip deletion, as we may accidentally delete pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// for sources that haven&#39;t reported yet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;skipping delete because sources aren&#39;t ready yet&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ForgetWorker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Runtime cache may not have been updated to with the pod, but it&#39;s okay
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// because the periodic cleanup routine will attempt to delete again later.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">runningPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPods</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error listing containers: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">runningPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runningPods</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">FindPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsEmpty</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pod not found&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podPair</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPair</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">APIPod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">RunningPod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">runningPod</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podKillingCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">podPair</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: delete the mirror pod here?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We leave the volume/directory cleanup to the periodic cleanup routine.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>从probe manager中移除pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="3-4-handlepodreconcile-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l2103">3.4. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L2103">HandlePodReconcile</a></h2>
<p>遍历pod列表。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandlePodReconcile is the callback in the SyncHandler interface for pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// that should be reconciled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandlePodReconcile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>   
</span></span></code></pre></div><p>将pod更新到pod manager中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Update the pod in pod manager, status manager will do periodically reconcile according
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// to the pod manager.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>必要时调整pod的<code>Ready</code>状态，执行<code>dispatchWork</code>函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Reconcile Pod &#34;Ready&#34; condition if necessary. Trigger sync pod for reconciliation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NeedToReconcilePodReadiness</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMirrorPodByPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dispatchWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodSync</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果pod被设定为需要被驱逐的，则删除pod中的容器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// After an evicted pod is synced, all dead containers in the pod can be removed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">eviction</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodIsEvicted</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerDeletor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteContainersInPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-5-handlepodsyncs-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l2127">3.5. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L2127">HandlePodSyncs</a></h2>
<p><code>HandlePodSyncs</code>是<code>syncHandler</code>接口回调函数，调用<code>dispatchWork</code>，通过pod worker来执行任务。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandlePodSyncs is the callback in the syncHandler interface for pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// that should be dispatched to pod workers for sync.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandlePodSyncs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMirrorPodByPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dispatchWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodSync</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-6-handlepodcleanups-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-pods-go-l979">3.6. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet_pods.go#L979">HandlePodCleanups</a></h2>
<p><code>HandlePodCleanups</code>主要用来执行pod的清理任务，其中包括<code>terminating</code>的pod，<code>orphaned</code>的pod等。</p>
<p>首先查看pod使用到的cgroup。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HandlePodCleanups performs a series of cleanup work, including terminating
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pod workers, killing unwanted pods, and removing orphaned volumes/pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// directories.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NOTE: This function is executed by the main sync loop, so it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// should not contain any blocking calls.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">HandlePodCleanups</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// The kubelet lacks checkpointing, so we need to introspect the set of pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// in the cgroup tree prior to inspecting the set of pods in our pod manager.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// this ensures our view of the cgroup tree does not mistakenly observe pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// that are added after the fact...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cgroupPods</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">cm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CgroupName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span>        <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cgroupsPerQOS</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pcm</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPodContainerManager</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cgroupPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetAllPodsFromCgroups</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to get list of pods that still exist on cgroup mounts: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>列出所有pod包括mirror pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">allPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodsAndMirrorPods</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Pod phase progresses monotonically. Once a pod has reached a final state,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// it should never leave regardless of the restart policy. The statuses
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// of such pods should not be changed, and there is no need to sync them.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: the logic here does not handle two cases:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   1. If the containers were removed immediately after they died, kubelet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      may fail to generate correct statuses, let alone filtering correctly.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//   2. If kubelet restarted before writing the terminated status for a pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      to the apiserver, it could still restart the terminated pod (even
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      though the pod was not considered terminated by the apiserver).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// These two conditions could be alleviated by checkpointing kubelet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">activePods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">filterOutTerminatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allPods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">desiredPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">activePods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">desiredPods</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">empty</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>pod worker停止不再存在的pod的任务，并从probe manager中清除pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Stop the workers for no-longer existing pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: is here the best place to forget pod workers?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ForgetNonExistingPodWorkers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">desiredPods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">probeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CleanupPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">activePods</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>将需要杀死的pod加入到<code>podKillingCh</code>的channel中，<code>podKiller</code>的任务会监听该channel并获取需要杀死的pod列表来执行杀死pod的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">runningPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPods</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error listing containers: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">runningPods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">found</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">desiredPods</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">found</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podKillingCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPair</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">APIPod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">RunningPod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>当pod不再被绑定到该节点，移除<code>podStatus</code>，其中<code>removeOrphanedPodStatuses</code>最后调用的函数是<code>statusManager</code>的<code>RemoveOrphanedStatuses</code>方法。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">removeOrphanedPodStatuses</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPods</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>移除所有的orphaned volume。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Remove any orphaned volumes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Note that we pass all pods (including terminated pods) to the function,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// so that we don&#39;t remove volumes associated with terminated but not yet
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// deleted pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cleanupOrphanedPodDirs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runningPods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We want all cleanup tasks to be run even if one of them failed. So
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// we just log an error here and continue other cleanup tasks.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This also applies to the other clean up tasks.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed cleaning up orphaned pod directories: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>移除mirror pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Remove any orphaned mirror pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOrphanedMirrorPods</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>删除不再运行的pod的cgroup。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Remove any cgroups in the hierarchy for pods that are no longer running.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cgroupsPerQOS</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cleanupOrphanedPodCgroups</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cgroupPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">activePods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>执行垃圾回收（GC）操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">backOff</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GC</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h1 id="4-dispatchwork-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l1981">4. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L1981">dispatchWork</a></h1>
<p><code>dispatchWork</code>通过pod worker启动一个异步的循环。</p>
<p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// dispatchWork starts the asynchronous sync of the pod in a pod worker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If the pod is terminated, dispatchWork
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">dispatchWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncType</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podIsTerminated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// If the pod is in a terminated state, there is no pod worker to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// handle the work item. Check if the DeletionTimestamp has been
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// set, and force a status update to trigger a pod deletion request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// to the apiserver.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TerminatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Run the sync in an async worker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MirrorPod</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">UpdateType</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">syncType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">OnCompleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodWorkerLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncType</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Note the number of containers for new pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">syncType</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodCreate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainersPerPodCount</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Containers</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下分段进行分析：</p>
<p>如果pod的状态是处于<code>Terminated</code>状态，则执行<code>statusManager</code>的<code>TerminatePod</code>操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// dispatchWork starts the asynchronous sync of the pod in a pod worker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If the pod is terminated, dispatchWork
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">dispatchWork</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncType</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mirrorPod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podIsTerminated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// If the pod is in a terminated state, there is no pod worker to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// handle the work item. Check if the DeletionTimestamp has been
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// set, and force a status update to trigger a pod deletion request
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// to the apiserver.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TerminatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>执行pod worker的<code>UpdatePod</code>函数，该函数是pod worker的核心函数，来执行pod相关操作。具体逻辑待下文分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run the sync in an async worker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MirrorPod</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdateType</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">syncType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">OnCompleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodWorkerLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncType</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><p>当创建类型是<code>SyncPodCreate</code>（即创建pod的时候），统计新pod中容器的数目。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Note the number of containers for new pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">syncType</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodCreate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainersPerPodCount</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Containers</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-podworkers-updatepod-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-pod-workers-go-l195">5. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go#L195">PodWorkers.UpdatePod</a></h1>
<p>PodWorkers是一个接口类型：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodWorkers is an abstract interface for testability.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PodWorkers</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ForgetNonExistingPodWorkers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">desiredPods</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ForgetWorker</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span> <span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中<code>UpdatePod</code>是一个核心方法，通过<code>podUpdates</code>的channel来传递需要处理的pod信息，对于新创建的pod每个pod都会由一个goroutine来执行<code>managePodLoop</code>。</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/pod_workers.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Apply the new setting to the specified pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If the options provide an OnCompleteFunc, the function is invoked if the update is accepted.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Update requests are ignored if a kill pod request is pending.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">UpdatePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">podUpdates</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">UpdatePodOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">exists</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podUpdates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podUpdates</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">uid</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// We need to have a buffer here, because checkForUpdates() method that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// puts an update into channel is called from the same goroutine where
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// the channel is consumed. However, it is guaranteed that in such case
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// the channel is empty, so buffer of size 1 is enough.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">podUpdates</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podUpdates</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">uid</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">podUpdates</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Creating a new pod worker either means this is a new pod, or that the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// kubelet just restarted. In either case the kubelet is willing to believe
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// the status of the pod for the first pod worker sync. See corresponding
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// comment in syncPod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">managePodLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podUpdates</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isWorking</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isWorking</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podUpdates</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// if a request to kill a pod is pending, we do not let anything overwrite that request.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">update</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">found</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastUndeliveredWorkUpdate</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">found</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateType</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodKill</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastUndeliveredWorkUpdate</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">options</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="6-managepodloop-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-pod-workers-go-l153">6. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go#L153">managePodLoop</a></h1>
<p><code>managePodLoop</code>通过读取<code>podUpdates</code>channel的信息，执行<code>syncPodFn</code>函数，而<code>syncPodFn</code>函数在<code>newPodWorkers</code>的时候赋值了，即<code>kubelet.syncPod</code>。<code>kubelet.syncPod</code>具体代码逻辑待后续文章单独分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// newPodWorkers传入syncPod函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podWorkers</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newPodWorkers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeDeps</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">workQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resyncInterval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backOffPeriod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">klet</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>newPodWorkers</code>函数参考：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">newPodWorkers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncPodFn</span> <span style="color:#000">syncPodFnType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">recorder</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventRecorder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">workQueue</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WorkQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">resyncInterval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backOffPeriod</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podCache</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cache</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podWorkers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podUpdates</span><span style="color:#000;font-weight:bold">:</span>                <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">isWorking</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">lastUndeliveredWorkUpdate</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">types</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">syncPodFn</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">syncPodFn</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// 构造传入klet.syncPod函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">workQueue</span><span style="color:#000;font-weight:bold">:</span>                 <span style="color:#000">workQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">resyncInterval</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">resyncInterval</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">backOffPeriod</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">backOffPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">:</span>                  <span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>managePodLoop</code>函数参考：</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/pod_workers.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">managePodLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podUpdates</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">lastSyncTime</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">update</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podUpdates</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">podUID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// This is a blocking call that would return only if the cache
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// has an entry for the pod that is newer than minRuntimeCache
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// Time. This ensures the worker doesn&#39;t start syncing until
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// after the cache is at least newer than the finished time of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// the previous sync.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNewerThan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podUID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastSyncTime</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// This is the legacy event thrown by manage pod loop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#8f5902;font-style:italic">// all other events are now dispatched from syncPodFn
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedSync</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error determining status: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncPodFn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncPodOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MirrorPod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">pod</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">killPodOptions</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KillPodOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">updateType</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lastSyncTime</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// notify the call-back function if the operation succeeded or not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnCompleteFunc</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnCompleteFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// IMPORTANT: we do not log errors here, the syncPodFn is responsible for logging errors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error syncing pod %s (%q), skipping: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrapUp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="7-总结">7. 总结</h1>
<p><code>syncLoopIteration</code>基本流程如下：</p>
<ol>
<li>通过几种<code>channel</code>来对不同类型的事件进行监听并处理。其中channel包括：<code>configCh</code>、<code>plegCh</code>、<code>syncCh</code>、<code>houseKeepingCh</code>、<code>livenessManager.Updates()</code>。</li>
<li>不同的SyncHandler执行不同的增删改查操作。</li>
<li>其中<code>HandlePodAdditions</code>、<code>HandlePodUpdates</code>、<code>HandlePodReconcile</code>、<code>HandlePodSyncs</code>都调用到了<code>dispatchWork</code>来执行pod的相关操作。<code>HandlePodCleanups</code>的pod清理任务，通过channel的方式加需要清理的pod给<code>podKiller</code>来清理。</li>
<li><code>dispatchWork</code>调用<code>podWorkers.UpdatePod</code>执行异步操作。</li>
<li><code>podWorkers.UpdatePod</code>中调用<code>managePodLoop</code>来执行pod相关操作循环。</li>
</ol>
<p><strong>channel类型及作用：</strong></p>
<ul>
<li><code>configCh</code>：将配置更改的pod分派给事件类型的相应处理程序回调。</li>
<li><code>plegCh</code>：更新runtime缓存，同步pod。</li>
<li><code>syncCh</code>：同步所有等待同步的pod。</li>
<li><code>houseKeepingCh</code>：触发清理pod。</li>
<li><code>livenessManager.Updates()</code>：对失败的pod或者liveness检查失败的pod进行sync操作。</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-46bab922ea9b5daead85570c299c80aa">6 - kubelet源码分析（五）之 syncPod</h1>
    
	<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析<code>kubelet</code>中<code>syncPod</code>的部分。</p>
<h1 id="1-managepodloop-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-pod-workers-go-l153">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go#L153">managePodLoop</a></h1>
<p><code>managePodLoop</code>通过读取<code>podUpdates</code>channel的信息，执行<code>syncPodFn</code>函数，而<code>syncPodFn</code>函数在<code>newPodWorkers</code>的时候赋值了，即<code>kubelet.syncPod</code>。</p>
<p>managePodLoop完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/kubelet/pod_workers.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podWorkers</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">managePodLoop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podUpdates</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#000">UpdatePodOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">lastSyncTime</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">update</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podUpdates</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">podUID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// This is a blocking call that would return only if the cache
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// has an entry for the pod that is newer than minRuntimeCache
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// Time. This ensures the worker doesn&#39;t start syncing until
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// after the cache is at least newer than the finished time of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// the previous sync.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNewerThan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podUID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastSyncTime</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// This is the legacy event thrown by manage pod loop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#8f5902;font-style:italic">// all other events are now dispatched from syncPodFn
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedSync</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error determining status: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// 该部分的syncPodFn实际上的实现函数是kubelet.syncPod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">syncPodFn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncPodOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MirrorPod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">pod</span><span style="color:#000;font-weight:bold">:</span>            <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">killPodOptions</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KillPodOptions</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">updateType</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateType</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lastSyncTime</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// notify the call-back function if the operation succeeded or not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnCompleteFunc</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OnCompleteFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// IMPORTANT: we do not log errors here, the syncPodFn is responsible for logging errors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error syncing pod %s (%q), skipping: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">wrapUp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下分析<code>syncPod</code>相关逻辑。</p>
<h1 id="2-syncpod-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kubelet-go-l1465">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go#L1465">syncPod</a></h1>
<p><code>syncPod</code>可以理解为是一个单个pod进行同步任务的事务脚本。其中入参是<code>syncPodOptions</code>，<code>syncPodOptions</code>记录了需要同步的pod的相关信息。具体定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// syncPodOptions provides the arguments to a SyncPod operation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">syncPodOptions</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// the mirror pod for the pod to sync, if it is a static pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">mirrorPod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// pod to sync
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// the type of update (create, update, sync)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">updateType</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodType</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// the current status
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">podStatus</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodStatus</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// if update type is kill, use the specified options to kill the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">killPodOptions</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">KillPodOptions</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>syncPod</code>主要执行以下的工作流：</p>
<ul>
<li>如果是正在创建的pod，则记录pod worker的启动<code>latency</code>。</li>
<li>调用<code>generateAPIPodStatus</code>为pod提供<code>v1.PodStatus</code>信息。</li>
<li>如果pod是第一次运行，记录pod的启动<code>latency</code>。</li>
<li>更新<code>status manager</code>中的pod状态。</li>
<li>如果pod不应该被运行则杀死pod。</li>
<li>如果pod是一个<code>static pod</code>，并且没有对应的<code>mirror pod</code>，则创建一个<code>mirror pod</code>。</li>
<li>如果没有pod的数据目录则给pod创建对应的数据目录。</li>
<li>等待volume被attach或mount。</li>
<li>获取pod的secret数据。</li>
<li>调用<code>container runtime</code>的<code>SyncPod</code>函数，执行相关pod操作。</li>
<li>更新pod的<code>ingress</code>和<code>egress</code>的<code>traffic limit</code>。</li>
</ul>
<p>当以上任务流中有任何的error，则return error。在下一次执行<code>syncPod</code>的任务流会被再次执行。对于错误信息会被记录到event中，方便debug。</p>
<p>以下对<code>syncPod</code>的执行过程进行分析。</p>
<blockquote>
<p>syncPod的代码位于pkg/kubelet/kubelet.go</p>
</blockquote>
<h2 id="2-1-syncpodkill">2.1. SyncPodKill</h2>
<p>首先，获取<code>syncPodOptions</code>的pod信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">syncPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span> <span style="color:#000">syncPodOptions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// pull out the required options
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mirrorPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mirrorPod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podStatus</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">updateType</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updateType</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>    
</span></span></code></pre></div><p>如果pod是需要被杀死的，则执行<code>killPod</code>，会在指定的宽限期内杀死pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// if we want to kill a pod, do it now!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">updateType</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodKill</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">killPodOptions</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killPodOptions</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">killPodOptions</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">killPodOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodStatusFunc</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;kill pod options are required if update type is kill&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">apiPodStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">killPodOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodStatusFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetPodStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// we kill the pod with the specified grace period since this is a termination
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">killPodOptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodTerminationGracePeriodSecondsOverride</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToKillPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error killing pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// there was an error killing the pod, so we return that error directly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-syncpodcreate">2.2. SyncPodCreate</h2>
<p>如果pod是需要被创建的，则记录pod的启动<code>latency</code>，<code>latency</code>与pod在apiserver中第一次被记录相关。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Latency measurements for the main workflow are relative to the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// first time the pod was seen by the API server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">firstSeenTime</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Time</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">firstSeenTimeStr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Annotations</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigFirstSeenAnnotationKey</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">firstSeenTime</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConvertToTimestamp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">firstSeenTimeStr</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Record pod worker start latency if being created
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: make pod workers record their own latencies
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">updateType</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">kubetypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPodCreate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">firstSeenTime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsZero</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// This is the first time we are syncing the pod. Record the latency
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// since kubelet first saw the pod if firstSeenTime is set.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodWorkerStartLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">firstSeenTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;First seen time not recorded for pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>通过pod和pod status生成最终的api pod status并设置pod的IP。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Generate final API pod status with pod and status manager status
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">apiPodStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">generateAPIPodStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The pod IP may be changed in generateAPIPodStatus if the pod is using host network. (See #24576)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO(random-liu): After writing pod spec into container labels, check whether pod is using host network, and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// set pod IP to hostIP directly in runtime.GetPodStatus
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IP</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodIP</span>
</span></span></code></pre></div><p>记录pod到running状态的时间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Record the time it takes for the pod to become running.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">existingStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">existingStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Phase</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPending</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Phase</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodRunning</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">!</span><span style="color:#000">firstSeenTime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsZero</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodStartLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">firstSeenTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果pod是不可运行的，则更新pod和container的状态和相应的原因。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">runnable</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">canRunPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">runnable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Admit</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Pod is not runnable; update the Pod and Container statuses to why.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">runnable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Message</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">runnable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Message</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Waiting containers are not creating.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">waitingReason</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Blocked&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitContainerStatuses</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">State</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Waiting</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">State</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Waiting</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">waitingReason</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerStatuses</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">State</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Waiting</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">cs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">State</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Waiting</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">waitingReason</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>并更新status manager中的状态信息，杀死不可运行的pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Update status in the status manager
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statusManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetPodStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Kill pod if it should not be running
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">runnable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Admit</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Phase</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFailed</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">syncErr</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToKillPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error killing pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">syncErr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error killing pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">runnable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Admit</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// There was no error killing the pod, but the pod cannot be run.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// Return an error to signal that the sync loop should back off.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">syncErr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pod cannot be run: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">runnable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Message</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">syncErr</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果网络插件还没到<code>Ready</code>状态，则只有在使用<code>host</code>网络模式的情况下才启动pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If the network plugin is not ready, only start the pod if it uses the host network
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeState</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">networkErrors</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsHostNetworkPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NetworkNotReady</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%s: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NetworkNotReadyErrorMsg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NetworkNotReadyErrorMsg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-cgroups">2.3. Cgroups</h2>
<p>给pod创建<code>Cgroups</code>，如果<code>cgroups-per-qos</code>参数开启，则申请相应的资源。对于<code>terminated</code>的pod不需要创建或更新pod的<code>Cgroups</code>。</p>
<p>当重新启动<code>kubelet</code>并且启用<code>cgroups-per-qos</code>时，应该间歇性地终止所有pod的运行容器并在<code>qos cgroup hierarchy</code>下重新启动。</p>
<p>如果pod的cgroup已经存在或者pod第一次运行，不杀死pod中容器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create Cgroups for the pod and apply resource parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to them if cgroups-per-qos flag is enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pcm</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPodContainerManager</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If pod has already been terminated then we need not create
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// or update the pod&#39;s cgroup
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podIsTerminated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// When the kubelet is restarted with the cgroups-per-qos
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// flag enabled, all the pod&#39;s running containers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// should be killed intermittently and brought back up
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// under the qos cgroup hierarchy.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Check if this is the pod&#39;s first sync
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">firstSync</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerStatuses</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">containerStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">State</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Running</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">firstSync</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Don&#39;t kill containers in pod if pod&#39;s cgroups already
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// exists or the pod is running for the first time
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">podKilled</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">pcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">firstSync</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">podKilled</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><p>如果pod被杀死并且重启策略是<code>Never</code>，则不创建或更新对应的<code>Cgroups</code>，否则创建和更新pod的<code>Cgroups</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create and Update pod&#39;s Cgroups
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Don&#39;t create cgroups for run once pod if it was killed above
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The current policy is not to restart the run once pods when
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the kubelet is restarted with the new flag as run once pods are
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// expected to run only once and if the kubelet is restarted then
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// they are not expected to run again.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// We don&#39;t create and apply updates to cgroup if its a run once pod and was killed above
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!(</span><span style="color:#000">podKilled</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RestartPolicy</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RestartPolicyNever</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">pcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateQOSCgroups</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to update QoS cgroups while syncing pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnsureExists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreatePodContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;unable to ensure pod container exists: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;failed to ensure that the pod: %v cgroups exist and are correctly applied: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中创建<code>Cgroups</code>是通过<code>containerManager</code>的<code>UpdateQOSCgroups</code>来执行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateQOSCgroups</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to update QoS cgroups while syncing pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-4-mirror-pod">2.4. Mirror Pod</h2>
<p>如果pod是一个<code>static pod</code>，没有对应的<code>mirror pod</code>，则创建一个<code>mirror pod</code>；如果存在<code>mirror pod</code>则删除再重建一个<code>mirror pod</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create Mirror Pod for Static Pod if it doesn&#39;t already exist
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">kubepod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsStaticPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podFullName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodFullName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">deleted</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">mirrorPod</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsMirrorPodOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// The mirror pod is semantically different from the static pod. Remove
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// it. The mirror pod will get recreated later.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Deleting mirror pod %q because it is outdated&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podFullName</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed deleting mirror pod %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mirrorPod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">deleted</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">mirrorPod</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">deleted</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNode</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;No need to create a mirror pod, since node %q has been removed from the cluster&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Creating a mirror pod for static pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateMirrorPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed creating a mirror pod for %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-5-makepoddatadirs">2.5. makePodDataDirs</h2>
<p>给pod创建数据目录。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Make data directories for the pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">makePodDataDirs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToMakePodDataDirectories</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error making pod data directories: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unable to make pod data directories for pod %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中数据目录包括</p>
<ul>
<li><code>PodDir</code>：{kubelet.rootDirectory}/pods/podUID</li>
<li><code>PodVolumesDir</code>：{PodDir}/volumes</li>
<li><code>PodPluginsDir</code>：{PodDir}/plugins</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// makePodDataDirs creates the dirs for the pod datas.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">makePodDataDirs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">uid</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodDir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0750</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodVolumesDir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0750</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MkdirAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPodPluginsDir</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uid</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">0750</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-6-mount-volumes">2.6. mount volumes</h2>
<p>对非<code>terminated</code>状态的pod挂载<code>volume</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Volume manager will not mount volumes for terminated pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podIsTerminated</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Wait for volumes to attach/mount
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">volumeManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForAttachAndMount</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedMountVolume</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Unable to mount volumes for pod %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unable to mount volumes for pod %q: %v; skipping pod&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-7-pullsecretsforpod">2.7. PullSecretsForPod</h2>
<p>获取pod的secret数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Fetch the pull secrets for the pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pullSecrets</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getPullSecretsForPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>getPullSecretsForPod</code>具体实现函数如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// getPullSecretsForPod inspects the Pod and retrieves the referenced pull
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// secrets.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">kl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Kubelet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">getPullSecretsForPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Secret</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pullSecrets</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Secret</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">secretRef</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ImagePullSecrets</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">secret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">secretManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetSecret</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">secretRef</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unable to retrieve pull secret %s/%s for %s/%s due to %v.  The image pull may not succeed.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">secretRef</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pullSecrets</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pullSecrets</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">secret</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pullSecrets</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-8-containerruntime-syncpod">2.8. containerRuntime.SyncPod</h2>
<p>调用<code>container runtime</code>的<code>SyncPod</code>函数，执行相关pod操作，由此<code>kubelet.syncPod</code>的操作逻辑转入<code>containerRuntime.SyncPod</code>函数中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Call the container runtime&#39;s SyncPod callback
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRuntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">apiPodStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pullSecrets</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">backOff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">kl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reasonCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Do not return error if the only failures were pods in backoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SyncResults</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrCrashLoopBackOff</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">images</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrImagePullBackOff</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Do not record an event here, as we keep all event logging for sync pod failures
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// local to container runtime so we get better errors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-runtime-syncpod-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kuberuntime-kuberuntime-manager-go-l578">3. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kuberuntime/kuberuntime_manager.go#L578">Runtime.SyncPod</a></h1>
<p><code>SyncPod</code>主要执行sync操作使得运行的pod达到期望状态的pod。主要执行以下操作：</p>
<ul>
<li>计算<code>sandbox</code>和<code>container</code>的变化。</li>
<li>必要的时候杀死pod。</li>
<li>杀死所有不需要运行的<code>container</code>。</li>
<li>必要时创建<code>sandbox</code>。</li>
<li>创建<code>init container</code>。</li>
<li>创建正常的<code>container</code>。</li>
</ul>
<blockquote>
<p>Runtime.SyncPod部分代码位于pkg/kubelet/kuberuntime/kuberuntime_manager.go</p>
</blockquote>
<h2 id="3-1-computepodactions">3.1. computePodActions</h2>
<p>计算<code>sandbox</code>和<code>container</code>的变化。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 1: Compute sandbox and container changes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">podContainerChanges</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">computePodActions</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;computePodActions got %+v for pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateSandbox</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ref</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ref</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetReference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">legacyscheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Couldn&#39;t make a ref to pod %q: &#39;%v&#39;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SandboxID</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ref</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SandboxChanged</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Pod sandbox changed, it will be killed and re-created.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SyncPod received new pod %q, will create a sandbox for it&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-killpodwithsyncresult">3.2. killPodWithSyncResult</h2>
<p>必要的时候杀死pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 2: Kill the pod if the sandbox has changed.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KillPod</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateSandbox</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Stopping PodSandbox for %q because all other containers are dead.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Stopping PodSandbox for %q, will start new one&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">killResult</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killPodWithSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConvertPodStatusToRunningPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPodSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">killResult</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">killResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;killPodWithSyncResult failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">killResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateSandbox</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">purgeInitContainers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-killcontainer">3.3. killContainer</h2>
<p>杀死所有不需要运行的<code>container</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 3: kill any running containers in this pod which are not to keep.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerInfo</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainersToKill</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Killing unwanted container %q(id=%q) for pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">killContainerResult</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">KillContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">killContainerResult</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">killContainerResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrKillContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;killContainer %q(id=%q) for pod %q failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-4-createpodsandbox">3.4. createPodSandbox</h2>
<p>必要时创建<code>sandbox</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 4: Create a sandbox for the pod if necessary.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Creating sandbox for pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000">createSandboxResult</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreatePodSandbox</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">createSandboxResult</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">podSandboxID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createPodSandbox</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Attempt</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">createSandboxResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrCreatePodSandbox</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;createPodSandbox for pod %q failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ref</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">referr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ref</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetReference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">legacyscheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">referr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Couldn&#39;t make a ref to pod %q: &#39;%v&#39;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">referr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ref</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedCreatePodSandBox</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Failed create pod sandbox: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Created PodSandbox %q for pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podSandboxID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h2 id="3-5-start-init-container">3.5. start init container</h2>
<p>创建<code>init container</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 5: start the init container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">container</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NextInitContainerToStart</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">container</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Start the next init container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">startContainerResult</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startContainerResult</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">isInBackOff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">doBackOff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backOff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isInBackOff</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">startContainerResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Backing Off restarting init container %+v in pod %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Creating init container %+v in pod %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pullSecrets</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podIP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerTypeInit</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">startContainerResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;init container start failed: %v: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Successfully started the container; clear the entry in the failure
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Completed init container %q for pod %q&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-6-start-containers">3.6. start containers</h2>
<p>创建正常的<code>container</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 6: start containers in podContainerChanges.ContainersToStart.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">idx</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podContainerChanges</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainersToStart</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">container</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Containers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">idx</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startContainerResult</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddSyncResult</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startContainerResult</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">isInBackOff</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">doBackOff</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">backOff</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isInBackOff</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">startContainerResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Backing Off restarting container %+v in pod %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Creating container %+v in pod %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 通过startContainer来运行容器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pullSecrets</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podIP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerTypeRegular</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">startContainerResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// known errors that are logged in other places are logged at higher levels here to avoid
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// repetitive log spam
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">images</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrImagePullBackOff</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;container start failed: %v: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;container start failed: %v: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-startcontainer-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-kubelet-kuberuntime-kuberuntime-container-go-l89">4. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kuberuntime/kuberuntime_container.go#L89">startContainer</a></h1>
<p><code>startContainer</code>启动一个容器并返回是否成功。</p>
<p>主要包括以下几个步骤：</p>
<ol>
<li>拉取镜像</li>
<li>创建容器</li>
<li>启动容器</li>
<li>运行post start lifecycle hooks(如果有设置此项)</li>
</ol>
<p><code>startContainer</code>完整代码如下：</p>
<blockquote>
<p>startContainer部分代码位于pkg/kubelet/kuberuntime/kuberuntime_container.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// startContainer starts a container and returns a message indicates why it is failed on error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It starts the container through the following steps:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// * pull the image
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// * create the container
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// * start the container
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// * run the post start lifecycle hooks (if applicable)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubeGenericRuntimeManager</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">startContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxID</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podSandboxConfig</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">runtimeapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodSandboxConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podStatus</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodStatus</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pullSecrets</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Secret</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podIP</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerType</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerType</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Step 1: pull the image.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">imageRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">imagePuller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnsureImageExists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pullSecrets</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreateContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Step 2: create the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ref</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenerateContainerRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Can&#39;t make a ref to pod %q, container %v: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Generating ref for container %s: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// For a new container, the RestartCount should be 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">restartCount</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">containerStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FindContainerStatusByName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">containerStatus</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">restartCount</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">containerStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RestartCount</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cleanupAction</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">generateContainerConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">restartCount</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podIP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">imageRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerType</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cleanupAction</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cleanupAction</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreateContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrCreateContainerConfig</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreateContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrCreateContainer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">internalLifecycle</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreStartContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToStartContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Internal PreStartContainer hook failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrPreStartHook</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreatedContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Created container&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ref</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRefManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerID</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ID</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span> <span style="color:#000">ref</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Step 3: start the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToStartContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrRunContainer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartedContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Started container&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Symlink container logs to the legacy container log location for cluster logging
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// support.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// TODO(random-liu): Remove this after cluster logging supports CRI container log path.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">containerMeta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMetadata</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sandboxMeta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMetadata</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">legacySymlink</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">legacyLogSymlink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sandboxMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sandboxMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">containerLog</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogDirectory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// only create legacy symlink if containerLog path exists (or the error is not IsNotExist).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Because if containerLog path does not exist, only dandling legacySymlink is created.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This dangling legacySymlink is later removed by container gc, so it does not make sense
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// to create it in the first place. it happens when journald logging driver is used with docker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">osInterface</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerLog</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">osInterface</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Symlink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerLog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">legacySymlink</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create legacy symbolic link %q to container %q log %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">legacySymlink</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerLog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Step 4: execute the post start hook.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lifecycle</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lifecycle</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PostStart</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">kubeContainerID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerID</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ID</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handlerErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runner</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lifecycle</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PostStart</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">handlerErr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedPostStartHook&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to kill container %q(id=%q) in pod %q: %v, %v&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ErrPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handlerErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下对<code>startContainer</code>分段分析：</p>
<h2 id="4-1-pull-image">4.1. pull image</h2>
<p>通过<code>EnsureImageExists</code>方法拉取拉取指定pod容器的镜像，并返回镜像信息和错误。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 1: pull the image.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">imageRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">imagePuller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EnsureImageExists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pullSecrets</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreateContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-2-createcontainer">4.2. CreateContainer</h2>
<p>首先生成container的<code>*v1.ObjectReference</code>对象，该对象包括container的相关信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 2: create the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ref</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GenerateContainerRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Can&#39;t make a ref to pod %q, container %v: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Generating ref for container %s: %#v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ref</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>统计container的重启次数，新的容器默认重启次数为0。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// For a new container, the RestartCount should be 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">restartCount</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000">containerStatus</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FindContainerStatusByName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">containerStatus</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">restartCount</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">containerStatus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RestartCount</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>生成container的配置。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cleanupAction</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">generateContainerConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">restartCount</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podIP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">imageRef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerType</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cleanupAction</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cleanupAction</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreateContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrCreateContainerConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>调用<code>runtimeService</code>，执行<code>CreateContainer</code>的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToCreateContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrCreateContainer</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">internalLifecycle</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreStartContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToStartContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Internal PreStartContainer hook failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrPreStartHook</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreatedContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Created container&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ref</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">containerRefManager</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetRef</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerID</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ID</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#000">ref</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-3-startcontainer">4.3. StartContainer</h2>
<p>执行<code>runtimeService</code>的<code>StartContainer</code>方法，来启动容器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 3: start the container.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedToStartContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Error: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">grpc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrorDesc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ErrRunContainer</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartedContainer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Started container&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Symlink container logs to the legacy container log location for cluster logging
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// support.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO(random-liu): Remove this after cluster logging supports CRI container log path.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">containerMeta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMetadata</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">sandboxMeta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetMetadata</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">legacySymlink</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">legacyLogSymlink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sandboxMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sandboxMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">containerLog</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podSandboxConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogDirectory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogPath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// only create legacy symlink if containerLog path exists (or the error is not IsNotExist).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Because if containerLog path does not exist, only dandling legacySymlink is created.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This dangling legacySymlink is later removed by container gc, so it does not make sense
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to create it in the first place. it happens when journald logging driver is used with docker.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">osInterface</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerLog</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">osInterface</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Symlink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">containerLog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">legacySymlink</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to create legacy symbolic link %q to container %q log %q: %v&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">legacySymlink</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">containerLog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-4-execute-post-start-hook">4.4. execute post start hook</h2>
<p>如果有指定<code>Lifecycle.PostStart</code>，则执行<code>PostStart</code>操作，<code>PostStart</code>如果执行失败，则容器会根据重启的规则进行重启。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Step 4: execute the post start hook.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lifecycle</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lifecycle</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PostStart</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">kubeContainerID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">kubecontainer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ContainerID</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runtimeName</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ID</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">containerID</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handlerErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">runner</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lifecycle</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PostStart</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">handlerErr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">recordContainerEvent</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">events</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">killContainer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedPostStartHook&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to kill container %q(id=%q) in pod %q: %v, %v&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">container</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">kubeContainerID</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">format</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">ErrPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ErrPostStartHook</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">handlerErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-总结">5. 总结</h1>
<p>kubelet的工作是管理pod在Node上的生命周期（包括增删改查），kubelet通过各种类型的manager异步工作各自执行各自的任务，其中使用到了多种的channel来控制状态信号变化的传递，例如比较重要的channel有<code>podUpdates &lt;-chan UpdatePodOptions</code>，来传递pod的变化情况。</p>
<p><strong>创建pod的调用逻辑</strong></p>
<p><code>syncLoopIteration--&gt;kubetypes.ADD--&gt;HandlePodAdditions(u.Pods)--&gt;dispatchWork(pod, kubetypes.SyncPodCreate, mirrorPod, start)--&gt;podWorkers.UpdatePod--&gt;managePodLoop(podUpdates)--&gt;syncPod(o syncPodOptions)--&gt;containerRuntime.SyncPod--&gt;startContainer</code></p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kubelet.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/pod_workers.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kuberuntime/kuberuntime_container.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/kubelet/kuberuntime/kuberuntime_container.go</a></li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2025 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
