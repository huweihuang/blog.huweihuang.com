<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="https://blog.huweihuang.com/k8s-source-code-analysis/kube-scheduler/">
<link rel="alternate" type="application/rss&#43;xml" href="https://blog.huweihuang.com/k8s-source-code-analysis/kube-scheduler/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>kube-scheduler | 胡伟煌</title>
<meta name="description" content="">
<meta property="og:title" content="kube-scheduler" />
<meta property="og:description" content="Kubernetes学习笔记" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://blog.huweihuang.com/k8s-source-code-analysis/kube-scheduler/" /><meta property="og:site_name" content="胡伟煌" />

<meta itemprop="name" content="kube-scheduler">
<meta itemprop="description" content="Kubernetes学习笔记"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="kube-scheduler"/>
<meta name="twitter:description" content="Kubernetes学习笔记"/>




<link rel="preload" href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" as="style">
<link href="/scss/main.min.79e3930541ca05b5395c14b2a313b798fad1dc69f9a14aefa57b62eaa9f65f14.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-114718458-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32" width="64" height="64"><path d="M15.9.476a2.14 2.14.0 00-.823.218L3.932 6.01c-.582.277-1.005.804-1.15 1.432L.054 19.373c-.13.56-.025 1.147.3 1.627q.057.087.12.168l7.7 9.574c.407.5 1.018.787 1.662.784h12.35c.646.001 1.258-.3 1.664-.793l7.696-9.576c.404-.5.555-1.16.4-1.786L29.2 7.43c-.145-.628-.57-1.155-1.15-1.432L16.923.695A2.14 2.14.0 0015.89.476z" fill="#326ce5"/><path d="M16.002 4.542c-.384.027-.675.356-.655.74v.188c.018.213.05.424.092.633a6.22 6.22.0 01.066 1.21c-.038.133-.114.253-.218.345l-.015.282c-.405.034-.807.096-1.203.186-1.666.376-3.183 1.24-4.354 2.485l-.24-.17c-.132.04-.274.025-.395-.04a6.22 6.22.0 01-.897-.81 5.55 5.55.0 00-.437-.465l-.148-.118c-.132-.106-.294-.167-.463-.175a.64.64.0 00-.531.236c-.226.317-.152.756.164.983l.138.11a5.55 5.55.0 00.552.323c.354.197.688.428.998.7a.74.74.0 01.133.384l.218.2c-1.177 1.766-1.66 3.905-1.358 6.006l-.28.08c-.073.116-.17.215-.286.288a6.22 6.22.0 01-1.194.197 5.57 5.57.0 00-.64.05l-.177.04h-.02a.67.67.0 00-.387 1.132.67.67.0 00.684.165h.013l.18-.02c.203-.06.403-.134.598-.218.375-.15.764-.265 1.162-.34.138.008.27.055.382.135l.3-.05c.65 2.017 2.016 3.726 3.84 4.803l-.122.255c.056.117.077.247.06.376-.165.382-.367.748-.603 1.092a5.58 5.58.0 00-.358.533l-.085.18a.67.67.0 00.65 1.001.67.67.0 00.553-.432l.083-.17c.076-.2.14-.404.192-.61.177-.437.273-.906.515-1.196a.54.54.0 01.286-.14l.15-.273a8.62 8.62.0 006.146.015l.133.255c.136.02.258.095.34.205.188.358.34.733.456 1.12a5.57 5.57.0 00.194.611l.083.17a.67.67.0 001.187.131.67.67.0 00.016-.701l-.087-.18a5.55 5.55.0 00-.358-.531c-.23-.332-.428-.686-.6-1.057a.52.52.0 01.068-.4 2.29 2.29.0 01-.111-.269c1.82-1.085 3.18-2.8 3.823-4.82l.284.05c.102-.093.236-.142.373-.138.397.076.786.2 1.162.34.195.09.395.166.598.23.048.013.118.024.172.037h.013a.67.67.0 00.841-.851.67.67.0 00-.544-.446l-.194-.046a5.57 5.57.0 00-.64-.05c-.404-.026-.804-.092-1.194-.197-.12-.067-.22-.167-.288-.288l-.27-.08a8.65 8.65.0 00-1.386-5.993l.236-.218c-.01-.137.035-.273.124-.378.307-.264.64-.497.99-.696a5.57 5.57.0 00.552-.323l.146-.118a.67.67.0 00-.133-1.202.67.67.0 00-.696.161l-.148.118a5.57 5.57.0 00-.437.465c-.264.302-.556.577-.873.823a.74.74.0 01-.404.044l-.253.18c-1.46-1.53-3.427-2.48-5.535-2.67.0-.1-.013-.25-.015-.297-.113-.078-.192-.197-.218-.332a6.23 6.23.0 01.076-1.207c.043-.21.073-.42.092-.633v-.2c.02-.384-.27-.713-.655-.74zm-.834 5.166-.2 3.493h-.015c-.01.216-.137.4-.332.504s-.426.073-.6-.054l-2.865-2.03a6.86 6.86.0 013.303-1.799c.234-.05.47-.088.707-.114zm1.668.0c1.505.187 2.906.863 3.99 1.924l-2.838 2.017c-.175.14-.415.168-.618.072s-.333-.3-.336-.524zm-6.72 3.227 2.62 2.338v.015c.163.142.234.363.186.574s-.21.378-.417.435v.01l-3.362.967a6.86 6.86.0 01.974-4.34zm11.753.0c.796 1.295 1.148 2.814 1.002 4.327l-3.367-.97v-.013c-.21-.057-.37-.224-.417-.435s.023-.43.186-.574l2.6-2.327zm-6.404 2.52h1.072l.655.832-.238 1.04-.963.463-.965-.463-.227-1.04zm3.434 2.838c.045-.005.1-.005.135.0l3.467.585c-.5 1.44-1.487 2.67-2.775 3.493l-1.34-3.244a.59.59.0 01.509-.819zm-5.823.015c.196.003.377.104.484.268s.124.37.047.55v.013l-1.332 3.218C11 21.54 10.032 20.325 9.517 18.9l3.437-.583c.038-.004.077-.004.116.0zm2.904 1.4a.59.59.0 01.537.308h.013l1.694 3.057-.677.2c-1.246.285-2.547.218-3.758-.194l1.7-3.057c.103-.18.293-.29.5-.295z" fill="#fff" stroke="#fff" stroke-width=".055"/></svg></span><span class="font-weight-bold">胡伟煌</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/kubernetes-notes/" ><span>Kubernetes学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/k8s-source-code-analysis/" ><span class="active">Kubernetes源码分析</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/golang-notes/" ><span>Golang学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/linux-notes/" ><span>Linux学习笔记</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>About</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; 站内搜索…"
  aria-label="站内搜索…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.b2745fcc2a3e037e276fb2a08da4b47d.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/k8s-source-code-analysis/kube-scheduler/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">kube-scheduler</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-81ad0a7153dd8d183646f8d1ebd1c6a5"></a></li>


    
  
    
    
	
<li>2: <a href="#pg-450020ba5dcfaba3eb90de8c14204285"></a></li>


    
  
    
    
	
<li>3: <a href="#pg-098ce169e4f76190487656ba8c3899d7"></a></li>


    
  
    
    
	
<li>4: <a href="#pg-1b30fb2a64678cfd3eec2198ed1461cc"></a></li>


    
  
    
    
	
<li>5: <a href="#pg-ea2ce71fd47cea6adf169e5d35e56977"></a></li>


    
  
    
    
	
<li>6: <a href="#pg-8621391b1d2292ec57a9ce7538fe1a47"></a></li>


    
  
    
    
	
<li>7: <a href="#pg-198aaa69380bc8e1d54162e3ae00b4be"></a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-81ad0a7153dd8d183646f8d1ebd1c6a5">1 - </h1>
    
	<h1 id="kube-scheduler-源码思维导图">kube-scheduler 源码思维导图</h1>
<h2 id="源码整体结构图">源码整体结构图</h2>
<img src="https://res.cloudinary.com/dqxtn0ick/image/upload/v1618721802/article/code-analysis/kube-scheduler/scheduler.png" width="100%">

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-450020ba5dcfaba3eb90de8c14204285">2 - </h1>
    
	<h1 id="kube-scheduler源码分析-一-之-newschedulercommand">kube-scheduler源码分析（一）之 NewSchedulerCommand</h1>
<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>scheduler的<code>cmd</code>代码目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kube-scheduler
</span></span><span style="display:flex;"><span>├── BUILD
</span></span><span style="display:flex;"><span>├── OWNERS
</span></span><span style="display:flex;"><span>├── app            <span style="color:#8f5902;font-style:italic"># app的目录下主要为运行scheduler相关的对象</span>
</span></span><span style="display:flex;"><span>│   ├── BUILD
</span></span><span style="display:flex;"><span>│   ├── config      
</span></span><span style="display:flex;"><span>│   │   ├── BUILD
</span></span><span style="display:flex;"><span>│   │   └── config.go    <span style="color:#8f5902;font-style:italic"># Scheduler的配置对象config</span>
</span></span><span style="display:flex;"><span>│   ├── options      <span style="color:#8f5902;font-style:italic"># options主要记录 Scheduler 使用到的参数</span>
</span></span><span style="display:flex;"><span>│   │   ├── BUILD
</span></span><span style="display:flex;"><span>│   │   ├── configfile.go
</span></span><span style="display:flex;"><span>│   │   ├── deprecated.go
</span></span><span style="display:flex;"><span>│   │   ├── deprecated_test.go
</span></span><span style="display:flex;"><span>│   │   ├── insecure_serving.go
</span></span><span style="display:flex;"><span>│   │   ├── insecure_serving_test.go
</span></span><span style="display:flex;"><span>│   │   ├── options.go    <span style="color:#8f5902;font-style:italic"># 主要包括Options、NewOptions、AddFlags、Config等函数</span>
</span></span><span style="display:flex;"><span>│   │   └── options_test.go
</span></span><span style="display:flex;"><span>│   └── server.go    <span style="color:#8f5902;font-style:italic"># 主要包括 NewSchedulerCommand、NewSchedulerConfig、Run等函数</span>
</span></span><span style="display:flex;"><span>└── scheduler.go     <span style="color:#8f5902;font-style:italic"># main入口函数</span>
</span></span></code></pre></div><h1 id="1-main-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kube-scheduler-scheduler-go-l34-函数">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/scheduler.go#L34">Main</a>函数</h1>
<blockquote>
<p>此部分的代码为/cmd/kube-scheduler/scheduler.go</p>
</blockquote>
<p><code>kube-scheduler</code>的入口函数<code>Main</code>函数，仍然是采用统一的代码风格，使用<a href="https://github.com/spf13/cobra">Cobra</a>命令行框架。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rand</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seed</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UTC</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">UnixNano</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSchedulerCommand</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: once we switch everything over to Cobra commands, we can go back to calling
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// utilflag.InitFlags() (by removing its pflag.Parse() call). For now, we have to set the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// normalize func and add the go flag set by hand.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetNormalizeFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">utilflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WordSepNormalizeFunc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddGoFlagSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">goflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandLine</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// utilflag.InitFlags()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">logs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlushLogs</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 初始化scheduler命令结构体
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">command</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSchedulerCommand</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 执行Execute
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h1 id="2-newschedulercommand-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kube-scheduler-app-server-go-l68">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/app/server.go#L68">NewSchedulerCommand</a></h1>
<blockquote>
<p>此部分的代码为/cmd/kube-scheduler/app/server.go</p>
</blockquote>
<p><code>NewSchedulerCommand</code>主要用来构造和初始化SchedulerCommand结构体，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewSchedulerCommand creates a *cobra.Command object with default parameters
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewSchedulerCommand</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unable to initialize command options: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Use</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;kube-scheduler&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Long</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">`The Kubernetes scheduler is a policy-rich, topology-aware,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">workload-specific function that significantly impacts availability, performance,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">and capacity. The scheduler needs to take into account individual and collective
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">resource requirements, quality of service requirements, hardware/software/policy
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">constraints, affinity and anti-affinity specifications, data locality, inter-workload
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">interference, deadlines, and so on. Workload-specific requirements will be exposed
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">through the API as necessary.`</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Run</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cobra</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">verflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintAndExitIfRequested</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">utilflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PrintFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;arguments are not supported\n&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">errs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Validate</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">utilerrors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAggregate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteConfigTo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteConfigFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteConfigTo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Wrote configuration to: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteConfigTo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MarkFlagFilename</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;yaml&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;yml&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;json&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cmd</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 构造option
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 初始化config对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 执行run函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 添加参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><h2 id="2-1-newoptions">2.1. NewOptions</h2>
<p>NewOptions主要用来构造SchedulerServer使用的参数和上下文，其中核心参数是<code>KubeSchedulerConfiguration</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewOptions</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p><strong>NewOptions</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewOptions returns default scheduler app options.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewOptions</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Options</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">newDefaultComponentConfig</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">hhost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hport</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">splitHostIntPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HealthzBindAddress</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Options</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// TODO: enable with apiserveroptions.NewSecureServingOptions()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">CombinedInsecureServing</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">CombinedInsecureServingOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Healthz</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">apiserveroptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeprecatedInsecureServingOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">BindNetwork</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Metrics</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">apiserveroptions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeprecatedInsecureServingOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">BindNetwork</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">BindPort</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">hport</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">BindAddress</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">hhost</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// TODO: enable with apiserveroptions.NewDelegatingAuthenticationOptions()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">Authorization</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// TODO: enable with apiserveroptions.NewDelegatingAuthorizationOptions()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">Deprecated</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">DeprecatedOptions</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">UseLegacyPolicyConfig</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">PolicyConfigMapNamespace</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NamespaceSystem</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-options-config">2.2. Options.Config</h2>
<p>Config初始化调度器的配置对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>Config函数主要执行以下操作：</p>
<ul>
<li>构建scheduler client、leaderElectionClient、eventClient。</li>
<li>创建event recorder</li>
<li>设置leader选举</li>
<li>创建informer对象，主要函数有<code>NewSharedInformerFactory</code>和<code>NewPodInformer</code>。</li>
</ul>
<p>Config具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Config return a scheduler config object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Options</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Config</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulerappconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">schedulerappconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ApplyTo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// prepare kube clients.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">leaderElectionClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">eventClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">createClients</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConnection</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Master</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RenewDeadline</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Prepare event clients.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">eventBroadcaster</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">record</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewBroadcaster</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">recorder</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">eventBroadcaster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewRecorder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">legacyscheme</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Scheme</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">corev1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventSource</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Component</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerName</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Set up leader election if enabled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">leaderElectionConfig</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">leaderelection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElectionConfig</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElect</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">leaderElectionConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">makeLeaderElectionConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">leaderElectionClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">recorder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">client</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">informers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSharedInformerFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPodInformer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">eventClient</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">recorder</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Broadcaster</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">eventBroadcaster</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">leaderElectionConfig</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-3-addflags">2.3. AddFlags</h2>
<p><code>AddFlags</code>为SchedulerServer添加指定的参数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cmd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>AddFlags函数的具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// AddFlags adds flags for the scheduler options.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Options</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pflag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagSet</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConfigFile</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;The path to the configuration file. Flags override values in this file.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteConfigTo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;write-config-to&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteConfigTo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;If set, write the configuration values to this file and exit.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Master</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;master&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Master</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;The address of the Kubernetes API server (overrides any value in kubeconfig)&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CombinedInsecureServing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authentication</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Authorization</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deprecated</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">leaderelectionconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BindFlags</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComponentConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElectionConfiguration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddFlag</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-run-https-github-com-kubernetes-kubernetes-blob-v1-12-0-cmd-kube-scheduler-app-server-go-l126">3. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/app/server.go#L126">Run</a></h1>
<blockquote>
<p>此部分的代码为/cmd/kube-scheduler/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Complete</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code> Run</code>运行一个不退出的常驻进程，来执行scheduler的相关操作。</p>
<p>Run函数的主要内容如下：</p>
<ul>
<li>通过scheduler config来创建scheduler的结构体。</li>
<li>运行event broadcaster、healthz server、metrics server。</li>
<li>运行所有的informer并在调度前等待cache的同步（重点）。</li>
<li>执行<code>sched.Run()</code>来运行scheduler的调度逻辑。</li>
<li>如果多个scheduler并开启了<code>LeaderElect</code>，则执行leader选举。</li>
</ul>
<p>以下对重点代码分开分析：</p>
<h2 id="3-1-newschedulerconfig">3.1. NewSchedulerConfig</h2>
<blockquote>
<p>NewSchedulerConfig初始化SchedulerConfig（此部分具体逻辑待后续专门分析），最后初始化生成scheduler结构体。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Build a scheduler config from the provided algorithm source.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">schedulerConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewSchedulerConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create the scheduler.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">scheduler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewFromConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="3-2-informerfactory-start">3.2. InformerFactory.Start</h2>
<p>运行PodInformer，并运行InformerFactory。此部分的逻辑为client-go的informer机制，在<a href="https://www.huweihuang.com/kubernetes-notes/code-analysis/kube-controller-manager/sharedIndexInformer.html">Informer机制</a>中有详细分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Start all informers.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="3-3-waitforcachesync">3.3. WaitForCacheSync</h2>
<p>在调度前等待cache同步。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Wait for all caches to sync before scheduling.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerFactory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scheduler&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="3-3-1-informerfactory-waitforcachesync">3.3.1. InformerFactory.WaitForCacheSync</h3>
<p><code>InformerFactory.WaitForCacheSync</code>等待所有启动的informer的cache进行同步，保持本地的store信息与etcd的信息是最新一致的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// WaitForCacheSync waits for all started informers&#39; cache were synced.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sharedInformerFactory</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">informers</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedIndexInformer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">informers</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SharedIndexInformer</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">informerType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">informer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">informers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startedInformers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">informerType</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">informers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">informerType</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">informer</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">informers</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">informType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">informer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">informers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">res</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">informType</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">informer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HasSynced</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">res</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>接着调用<code> cache.WaitForCacheSync</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// WaitForCacheSync waits for caches to populate.  It returns true if it was successful, false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// if the controller should shutdown
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">cacheSyncs</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">InformerSynced</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PollUntil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">syncedPollPeriod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">syncFunc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">cacheSyncs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">syncFunc</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;stop requested&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;caches populated&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-3-2-controller-waitforcachesync">3.3.2. controller.WaitForCacheSync</h3>
<p><code>controller.WaitForCacheSync</code>是对<code>cache.WaitForCacheSync</code>的一层封装，通过不同的controller的名字来记录不同controller等待cache同步。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scheduler&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stop</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">HasSynced</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>controller.WaitForCacheSync</code>具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// WaitForCacheSync is a wrapper around cache.WaitForCacheSync that generates log messages
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// indicating that the controller identified by controllerName is waiting for syncs, followed by
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// either a successful or failed sync.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">controllerName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">cacheSyncs</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InformerSynced</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Waiting for caches to sync for %s controller&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cacheSyncs</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Unable to sync caches for %s controller&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Caches are synced for %s controller&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">controllerName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-4-leaderelection">3.4. LeaderElection</h2>
<p>如果有多个scheduler，并开启leader选举，则运行<code>LeaderElector</code>直到选举结束或退出。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If leader election is enabled, run via LeaderElector until done and exit.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Callbacks</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">leaderelection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderCallbacks</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">OnStartedLeading</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">run</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">OnStoppedLeading</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;lost master&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">leaderElector</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">leaderelection</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewLeaderElector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeaderElection</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;couldn&#39;t create leader elector: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">leaderElector</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;lost lease&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-5-scheduler-run">3.5. Scheduler.Run</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Prepare a reusable run function.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">run</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithCancel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TODO</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#8f5902;font-style:italic">// TODO once Run() accepts a context, it should be used here
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stopCh</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>Scheduler.Run</code>先等待cache同步，然后开启调度逻辑的goroutine。</p>
<p>Scheduler.Run的具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run begins watching and scheduling. It waits for cache to be synced, then starts a goroutine and returns immediately.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scheduleOne</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StopEverything</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以上是对<code>/cmd/kube-scheduler/scheduler.go</code>部分代码的分析，<code>Scheduler.Run</code>后续的具体代码位于<code>pkg/scheduler/scheduler.go</code>待后续文章分析。</p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kube-scheduler">https://github.com/kubernetes/kubernetes/tree/v1.12.0/cmd/kube-scheduler</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/scheduler.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/app/server.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/cmd/kube-scheduler/app/server.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-098ce169e4f76190487656ba8c3899d7">3 - </h1>
    
	<h1 id="kube-scheduler源码分析-二-之-registeralgorithmprovider">kube-scheduler源码分析（二）之 registerAlgorithmProvider</h1>
<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>此部分主要介绍调度中使用的各种调度算法，包括调度算法的注册部分。注册部分的代码主要在<code>/pkg/scheduler/algorithmprovider</code>中，具体的预选策略和优选策略的算法实现在<code>/pkg/scheduler/algorithm</code>中。</p>
<h1 id="1-applyfeaturegates">1. ApplyFeatureGates</h1>
<p>注册调度算法的调用入口在SchedulerCommand的Run函数中。</p>
<blockquote>
<p>此部分代码位于/cmd/kube-scheduler/app/server.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run runs the Scheduler.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">schedulerserverconfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CompletedConfig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stopCh</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Apply algorithms based on feature gates.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// TODO: make configurable?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">algorithmprovider</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ApplyFeatureGates</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><p>ApplyFeatureGates的具体实现在<code>pkg/scheduler/algorithmprovider</code>的包中。</p>
<blockquote>
<p>此部分代码位于/pkg/scheduler/algorithmprovider/plugins.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ApplyFeatureGates applies algorithm by feature gates.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ApplyFeatureGates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">defaults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ApplyFeatureGates</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>ApplyFeatureGates具体实现如下：</p>
<blockquote>
<p>此部分代码位于/pkg/scheduler/algorithmprovider/defaults/defaults.go</p>
</blockquote>
<p>根据feature移除部分调度策略。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ApplyFeatureGates applies algorithm by feature gates.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ApplyFeatureGates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TaintNodesByCondition</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Remove &#34;CheckNodeCondition&#34;, &#34;CheckNodeMemoryPressure&#34;, &#34;CheckNodePIDPressurePred&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// and &#34;CheckNodeDiskPressure&#34; predicates
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeConditionPred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeMemoryPressurePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeDiskPressurePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodePIDPressurePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Remove key &#34;CheckNodeCondition&#34;, &#34;CheckNodeMemoryPressure&#34; and &#34;CheckNodeDiskPressure&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// from ALL algorithm provider
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// The key will be removed from all providers which in algorithmProviderMap[]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// if you just want remove specific provider, call func RemovePredicateKeyFromAlgoProvider()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePredicateKeyFromAlgorithmProviderMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeConditionPred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePredicateKeyFromAlgorithmProviderMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeMemoryPressurePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePredicateKeyFromAlgorithmProviderMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeDiskPressurePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePredicateKeyFromAlgorithmProviderMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodePIDPressurePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined based on whether a pod can tolerate all of the node&#39;s taints
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterMandatoryFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodToleratesNodeTaintsPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodToleratesNodeTaints</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined based on whether a pod can tolerate unschedulable of node
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterMandatoryFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeUnschedulablePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeUnschedulablePredicate</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Insert Key &#34;PodToleratesNodeTaints&#34; and &#34;CheckNodeUnschedulable&#34; To All Algorithm Provider
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// The key will insert to all providers which in algorithmProviderMap[]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// if you just want insert to specific provider, call func InsertPredicateKeyToAlgoProvider()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InsertPredicateKeyToAlgorithmProviderMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodToleratesNodeTaintsPred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InsertPredicateKeyToAlgorithmProviderMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeUnschedulablePred</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;TaintNodesByCondition is enabled, PodToleratesNodeTaints predicate is mandatory&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Prioritizes nodes that satisfy pod&#39;s resource limits
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">utilfeature</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultFeatureGate</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Enabled</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">features</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceLimitsPriorityFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ResourceLimitsPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceLimitsPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-init">2. init</h1>
<p>当函数逻辑调用到<code>algorithmprovider</code>包时，就会自动调用init的初始化函数，此部分主要包括对预选算法和优选算法的注册。</p>
<blockquote>
<p>此部分代码位于/pkg/scheduler/algorithmprovider/defaults/defaults.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Register functions that extract metadata used by predicates and priorities computations.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPredicateMetadataProducerFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadataProducer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPredicateMetadataFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityMetadataProducerFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityMetadataProducer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPriorityMetadataFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatefulSetLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">registerAlgorithmProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">defaultPredicates</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">defaultPriorities</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// IMPORTANT NOTES for predicate developers:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// We are using cached predicate result for pods belonging to the same equivalence class.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// So when implementing a new predicate, you are expected to check whether the result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// of your predicate function can be affected by related API object change (ADD/DELETE/UPDATE).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If yes, you are expected to invalidate the cached predicate result for related API object change.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// For example:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// https://github.com/kubernetes/kubernetes/blob/36a218e/plugin/pkg/scheduler/factory/factory.go#L422
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Registers predicates and priorities that are not enabled by default, but user can pick when creating their
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// own set of priorities/predicates.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// PodFitsPorts has been replaced by PodFitsHostPorts for better user understanding.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// For backwards compatibility with 1.0, PodFitsPorts is registered as well.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PodFitsPorts&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHostPorts</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Fit is defined based on the absence of port conflicts.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This predicate is actually a default predicate, because it is invoked from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// predicates.GeneralPredicates()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHostPortsPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHostPorts</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Fit is determined by resource availability.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This predicate is actually a default predicate, because it is invoked from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// predicates.GeneralPredicates()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsResourcesPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsResources</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Fit is determined by the presence of the Host parameter and a string match
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This predicate is actually a default predicate, because it is invoked from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// predicates.GeneralPredicates()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostNamePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Fit is determined by node selector query.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MatchNodeSelectorPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodMatchNodeSelector</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// ServiceSpreadingPriority is a priority config factory that spreads pods by minimizing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the number of pods (belonging to the same service) on the same node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Register the factory so that it&#39;s available, but do not include it as part of the default priorities
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Largely replaced by &#34;SelectorSpreadPriority&#34;, but registered for backward compatibility with 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityConfigFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;ServiceSpreadingPriority&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfigFactory</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">MapReduceFunction</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityMapFunction</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityReduceFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSelectorSpreadPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EmptyControllerLister</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EmptyReplicaSetLister</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EmptyStatefulSetLister</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Weight</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// EqualPriority is a prioritizer function that gives an equal weight of one to all nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Register the priority function so that its available
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// but do not include it as part of the default priorities
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;EqualPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EqualPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Optional, cluster-autoscaler friendly priority function - give used nodes higher priority.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MostRequestedPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MostRequestedPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;RequestedToCapacityRatioPriority&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedToCapacityRatioResourceAllocationPriorityDefault</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PriorityMap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下对init中的注册进行拆分介绍。</p>
<h2 id="2-1-registeralgorithmprovider">2.1. registerAlgorithmProvider</h2>
<p>此部分主要注册默认的预选和优选策略。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Register functions that extract metadata used by predicates and priorities computations.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPredicateMetadataProducerFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadataProducer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPredicateMetadataFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityMetadataProducerFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityMetadataProducer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPriorityMetadataFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatefulSetLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">registerAlgorithmProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">defaultPredicates</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">defaultPriorities</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p><strong>registerAlgorithmProvider</strong></p>
<p>注册AlgorithmProvider，其中包括<code>DefaultProvider</code>和<code>ClusterAutoscalerProvider</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">registerAlgorithmProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priSet</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Registers algorithm providers. By default we use &#39;DefaultProvider&#39;, but user can specify one to be used
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// by specifying flag.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterAlgorithmProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultProvider</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priSet</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Cluster autoscaler friendly scheduling algorithm.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterAlgorithmProvider</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ClusterAutoscalerProvider</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predSet</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">copyAndReplace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priSet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;LeastRequestedPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;MostRequestedPriority&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-registerfitpredicate">2.2. RegisterFitPredicate</h2>
<p>在init部分注册预选策略函数。</p>
<p>预选策略如下：</p>
<table>
<thead>
<tr>
<th>调度策略</th>
<th>函数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>PodFitsPorts</td>
<td>PodFitsHostPorts</td>
<td>PodFitsPorts已经被PodFitsHostPorts代替，此处主要是为了兼容性。</td>
</tr>
<tr>
<td>PodFitsHostPortsPred</td>
<td>PodFitsHostPorts</td>
<td>判断是否与宿主机的端口冲突。</td>
</tr>
<tr>
<td>PodFitsResourcesPred</td>
<td>PodFitsResources</td>
<td>判断node资源是否充足。</td>
</tr>
<tr>
<td>HostNamePred</td>
<td>PodFitsHost</td>
<td>判断pod所指定调度的节点是否是当前的节点。</td>
</tr>
<tr>
<td>MatchNodeSelectorPred</td>
<td>PodMatchNodeSelector</td>
<td>判断pod指定的node selector是否匹配当前的node。</td>
</tr>
</tbody>
</table>
<p>具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodFitsPorts has been replaced by PodFitsHostPorts for better user understanding.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// For backwards compatibility with 1.0, PodFitsPorts is registered as well.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;PodFitsPorts&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHostPorts</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Fit is defined based on the absence of port conflicts.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This predicate is actually a default predicate, because it is invoked from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// predicates.GeneralPredicates()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHostPortsPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHostPorts</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Fit is determined by resource availability.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This predicate is actually a default predicate, because it is invoked from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// predicates.GeneralPredicates()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsResourcesPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsResources</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Fit is determined by the presence of the Host parameter and a string match
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This predicate is actually a default predicate, because it is invoked from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// predicates.GeneralPredicates()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostNamePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Fit is determined by node selector query.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MatchNodeSelectorPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodMatchNodeSelector</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="2-3-registerpriorityfunction2">2.3. RegisterPriorityFunction2</h2>
<p>在init部分注册优选策略函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// EqualPriority is a prioritizer function that gives an equal weight of one to all nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Register the priority function so that its available
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// but do not include it as part of the default priorities
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;EqualPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EqualPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Optional, cluster-autoscaler friendly priority function - give used nodes higher priority.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MostRequestedPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MostRequestedPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;RequestedToCapacityRatioPriority&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedToCapacityRatioResourceAllocationPriorityDefault</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">PriorityMap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="3-defaultpredicates">3. defaultPredicates</h1>
<p>此部分为默认预选策略的注册函数。</p>
<p>默认的预选策略如下：</p>
<table>
<thead>
<tr>
<th>预选策略</th>
<th>函数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>NoVolumeZoneConflictPred</td>
<td>NewVolumeZonePredicate</td>
<td>判断pod使用到的volume是否有节点的要求。目前只支持pvc。</td>
</tr>
<tr>
<td>MaxEBSVolumeCountPred</td>
<td>NewMaxPDVolumeCountPredicate</td>
<td>判断pod使用EBSVolume在该节点上是否已经达到上限了。</td>
</tr>
<tr>
<td>MaxGCEPDVolumeCountPred</td>
<td>NewMaxPDVolumeCountPredicate</td>
<td>判断pod使用GCEPDVolume在该节点上是否已经达到上限了。</td>
</tr>
<tr>
<td>MaxAzureDiskVolumeCountPred</td>
<td>NewMaxPDVolumeCountPredicate</td>
<td>判断pod使用AzureDiskVolume在该节点上是否已经达到上限了。</td>
</tr>
<tr>
<td>MaxCSIVolumeCountPred</td>
<td>NewCSIMaxVolumeLimitPredicate</td>
<td>判断CSIVolume是否达到上限了。</td>
</tr>
<tr>
<td>MatchInterPodAffinityPred</td>
<td>NewPodAffinityPredicate</td>
<td>匹配pod的亲缘性。</td>
</tr>
<tr>
<td>NoDiskConflictPred</td>
<td>NoDiskConflict</td>
<td>判断是否有disk volumes的冲突。</td>
</tr>
<tr>
<td>GeneralPred</td>
<td>GeneralPredicates</td>
<td>通用的预选策略</td>
</tr>
<tr>
<td>CheckNodeMemoryPressurePred</td>
<td>CheckNodeMemoryPressurePredicate</td>
<td>判断节点内存是否充足。</td>
</tr>
<tr>
<td>CheckNodeDiskPressurePred</td>
<td>CheckNodeDiskPressurePredicate</td>
<td>判断节点是否有磁盘压力。</td>
</tr>
<tr>
<td>CheckNodePIDPressurePred</td>
<td>CheckNodePIDPressurePredicate</td>
<td>判断节点上的PID</td>
</tr>
<tr>
<td>CheckNodeConditionPred</td>
<td>CheckNodeConditionPredicate</td>
<td>判断node是否ready。</td>
</tr>
<tr>
<td>PodToleratesNodeTaintsPred</td>
<td>PodToleratesNodeTaints</td>
<td>判断pod是否可以容忍节点的taints。</td>
</tr>
<tr>
<td>CheckVolumeBindingPred</td>
<td>NewVolumeBindingPredicate</td>
<td>判断是否有volume拓扑的要求。</td>
</tr>
</tbody>
</table>
<p>具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">defaultPredicates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewString</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by volume zone requirements.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NoVolumeZoneConflictPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewVolumeZonePredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVCInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StorageClassInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by whether or not there would be too many AWS EBS volumes attached to the node
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxEBSVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMaxPDVolumeCountPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EBSVolumeFilterType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVCInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by whether or not there would be too many GCE PD volumes attached to the node
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxGCEPDVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMaxPDVolumeCountPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GCEPDVolumeFilterType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVCInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by whether or not there would be too many Azure Disk volumes attached to the node
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxAzureDiskVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewMaxPDVolumeCountPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AzureDiskVolumeFilterType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVCInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxCSIVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCSIMaxVolumeLimitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PVCInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by inter-pod affinity.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MatchInterPodAffinityPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewPodAffinityPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by non-conflicting disk volumes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NoDiskConflictPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NoDiskConflict</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// GeneralPredicates are the predicates that are enforced by all Kubernetes components
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// (e.g. kubelet and all schedulers)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GeneralPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GeneralPredicates</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by node memory pressure condition.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeMemoryPressurePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeMemoryPressurePredicate</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by node disk pressure condition.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeDiskPressurePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeDiskPressurePredicate</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by node pid pressure condition.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodePIDPressurePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodePIDPressurePredicate</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by node conditions: not ready, network unavailable or out of disk.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterMandatoryFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeConditionPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckNodeConditionPredicate</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined based on whether a pod can tolerate all of the node&#39;s taints
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodToleratesNodeTaintsPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodToleratesNodeTaints</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Fit is determined by volume topology requirements.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicateFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CheckVolumeBindingPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewVolumeBindingPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VolumeBinder</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-defaultpriorities">4. defaultPriorities</h1>
<p>此部分主要为默认优选策略的注册函数。</p>
<p>默认优选策略如下：</p>
<table>
<thead>
<tr>
<th>优选策略</th>
<th>函数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>SelectorSpreadPriority</td>
<td>NewSelectorSpreadPriority</td>
<td>属于相同service和rs下的pod尽量分布在不同的node上。</td>
</tr>
<tr>
<td>InterPodAffinityPriority</td>
<td>NewInterPodAffinityPriority</td>
<td>根据pod的亲缘性，将相同拓扑域中的pod放在同一个节点</td>
</tr>
<tr>
<td>LeastRequestedPriority</td>
<td>LeastRequestedPriorityMap</td>
<td>按最少请求的利用率对节点进行优先级排序。</td>
</tr>
<tr>
<td>BalancedResourceAllocation</td>
<td>BalancedResourceAllocationMap</td>
<td>实现资源的平衡使用。</td>
</tr>
<tr>
<td>NodePreferAvoidPodsPriority</td>
<td>CalculateNodePreferAvoidPodsPriorityMap</td>
<td>将此权重设置为足以覆盖所有其他优先级函数。</td>
</tr>
<tr>
<td>NodeAffinityPriority</td>
<td>CalculateNodeAffinityPriorityMap</td>
<td>pod指定label节点调度，来匹配node亲缘性。</td>
</tr>
<tr>
<td>TaintTolerationPriority</td>
<td>ComputeTaintTolerationPriorityMap</td>
<td>pod有设置tolerate属性来容忍node的taint。</td>
</tr>
<tr>
<td>ImageLocalityPriority</td>
<td>ImageLocalityPriorityMap</td>
<td>根据节点上是否有该pod使用到的镜像打分。</td>
</tr>
</tbody>
</table>
<p>具体代码实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">defaultPriorities</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewString</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// spreads pods by minimizing the number of pods (belonging to the same service or replication controller) on the same node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityConfigFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34;SelectorSpreadPriority&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfigFactory</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">MapReduceFunction</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityMapFunction</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityReduceFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSelectorSpreadPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatefulSetLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Weight</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// pods should be placed in the same topological domain (e.g. same node, same rack, same zone, same power domain, etc.)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// as some other pods, or, conversely, should not be placed in the same topological domain as some other pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityConfigFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34;InterPodAffinityPriority&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfigFactory</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Function</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityFunction</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewInterPodAffinityPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HardPodAffinitySymmetricWeight</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Weight</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Prioritize nodes by least requested utilization.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;LeastRequestedPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LeastRequestedPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Prioritizes nodes to help achieve balanced resource usage
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;BalancedResourceAllocation&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BalancedResourceAllocationMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Set this weight large enough to override all other priority functions.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// TODO: Figure out a better way to do this, maybe at same time as fixing #24720.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NodePreferAvoidPodsPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CalculateNodePreferAvoidPodsPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Prioritizes nodes that have labels matching NodeAffinity
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NodeAffinityPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CalculateNodeAffinityPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CalculateNodeAffinityPriorityReduce</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Prioritizes nodes that marked with taint which pod can tolerate.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;TaintTolerationPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComputeTaintTolerationPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ComputeTaintTolerationPriorityReduce</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// ImageLocalityPriority prioritizes nodes that have images requested by the pod present.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityFunction2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ImageLocalityPriority&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ImageLocalityPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithmprovider/defaults/defaults.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithmprovider/defaults/defaults.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1b30fb2a64678cfd3eec2198ed1461cc">4 - </h1>
    
	<h1 id="kube-scheduler源码分析-三-之-scheduleone">kube-scheduler源码分析（三）之 scheduleOne</h1>
<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析<code>/pkg/scheduler/</code>中调度的基本流程。具体的<code>预选调度逻辑</code>、<code>优选调度逻辑</code>、<code>节点抢占逻辑</code>待后续再独立分析。</p>
<p>scheduler的<code>pkg</code>代码目录结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>scheduler
</span></span><span style="display:flex;"><span>├── algorithm         <span style="color:#8f5902;font-style:italic"># 主要包含调度的算法</span>
</span></span><span style="display:flex;"><span>│   ├── predicates    <span style="color:#8f5902;font-style:italic"># 预选的策略</span>
</span></span><span style="display:flex;"><span>│   ├── priorities    <span style="color:#8f5902;font-style:italic"># 优选的策略</span>
</span></span><span style="display:flex;"><span>│   ├── scheduler_interface.go    <span style="color:#8f5902;font-style:italic"># ScheduleAlgorithm、SchedulerExtender接口定义</span>
</span></span><span style="display:flex;"><span>│   ├── types.go      <span style="color:#8f5902;font-style:italic"># 使用到的type的定义</span>
</span></span><span style="display:flex;"><span>├── algorithmprovider
</span></span><span style="display:flex;"><span>│   ├── defaults
</span></span><span style="display:flex;"><span>│   │   ├── defaults.go    <span style="color:#8f5902;font-style:italic"># 默认算法的初始化操作，包括预选和优选策略</span>
</span></span><span style="display:flex;"><span>├── cache      <span style="color:#8f5902;font-style:italic"># scheduler调度使用到的cache</span>
</span></span><span style="display:flex;"><span>│   ├── cache.go    <span style="color:#8f5902;font-style:italic"># schedulerCache</span>
</span></span><span style="display:flex;"><span>│   ├── interface.go
</span></span><span style="display:flex;"><span>│   ├── node_info.go
</span></span><span style="display:flex;"><span>│   ├── node_tree.go
</span></span><span style="display:flex;"><span>├── core       <span style="color:#8f5902;font-style:italic"># 调度逻辑的核心代码</span>
</span></span><span style="display:flex;"><span>│   ├── equivalence
</span></span><span style="display:flex;"><span>│   │   ├── eqivalence.go       <span style="color:#8f5902;font-style:italic"># 存储相同pod的调度结果缓存，主要给预选策略使用</span>
</span></span><span style="display:flex;"><span>│   ├── extender.go
</span></span><span style="display:flex;"><span>│   ├── generic_scheduler.go    <span style="color:#8f5902;font-style:italic"># genericScheduler,主要包含默认调度器的调度逻辑</span>
</span></span><span style="display:flex;"><span>│   ├── scheduling_queue.go     <span style="color:#8f5902;font-style:italic"># 调度使用到的队列，主要用来存储需要被调度的pod</span>
</span></span><span style="display:flex;"><span>├── factory
</span></span><span style="display:flex;"><span>│   ├── factory.go   <span style="color:#8f5902;font-style:italic"># 主要包括NewConfigFactory、NewPodInformer，监听pod事件来更新调度队列</span>
</span></span><span style="display:flex;"><span>├── metrics
</span></span><span style="display:flex;"><span>│   └── metrics.go   <span style="color:#8f5902;font-style:italic"># 主要给prometheus使用</span>
</span></span><span style="display:flex;"><span>├── scheduler.go <span style="color:#8f5902;font-style:italic"># pkg部分的Run入口(核心代码)，主要包含Run、scheduleOne、schedule、preempt等函数</span>
</span></span><span style="display:flex;"><span>└── volumebinder
</span></span><span style="display:flex;"><span>    └── volume_binder.go   <span style="color:#8f5902;font-style:italic"># volume bind</span>
</span></span></code></pre></div><h1 id="1-scheduler-run-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-scheduler-go-l181">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/scheduler.go#L181">Scheduler.Run</a></h1>
<blockquote>
<p>此部分代码位于pkg/scheduler/scheduler.go</p>
</blockquote>
<p>此处为具体调度逻辑的入口。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Run begins watching and scheduling. It waits for cache to be synced, then starts a goroutine and returns immediately.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitForCacheSync</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Until</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scheduleOne</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StopEverything</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="2-scheduler-scheduleone-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-scheduler-go-l395">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/scheduler.go#L395">Scheduler.scheduleOne</a></h1>
<blockquote>
<p>此部分代码位于pkg/scheduler/scheduler.go</p>
</blockquote>
<p><code>scheduleOne</code>主要为单个pod选择一个适合的节点，为调度逻辑的核心函数。</p>
<p><strong>对单个pod进行调度的基本流程如下：</strong></p>
<ol>
<li>通过podQueue的待调度队列中弹出需要调度的pod。</li>
<li>通过具体的调度算法为该pod选出合适的节点，其中调度算法就包括预选和优选两步策略。</li>
<li>如果上述调度失败，则会尝试抢占机制，将优先级低的pod剔除，让优先级高的pod调度成功。</li>
<li>将该pod和选定的节点进行假性绑定，存入scheduler cache中，方便具体绑定操作可以异步进行。</li>
<li>实际执行绑定操作，将node的名字添加到pod的节点相关属性中。</li>
</ol>
<p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// scheduleOne does the entire scheduling workflow for a single pod.  It is serialized on the scheduling algorithm&#39;s host fitting.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">scheduleOne</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NextPod</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedScheduling&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;skip schedule deleting pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Skip schedule deleting pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Attempting to schedule pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Synchronously attempt to find a fit for the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// schedule() may have failed because the pod would not fit on any host, so we try to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// preempt, with the expectation that the next time the pod is tried for scheduling it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// will fit due to the preemption. It is also possible that a different pod will schedule
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// into the resources that were preempted, but this is harmless.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">preemptionStartTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionAttempts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Inc</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPremptionEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Tell the cache to assume that a pod now is running on a given node, even though it hasn&#39;t been bound yet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This allows us to keep scheduling without waiting on binding to occur.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">assumedPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Assume volumes first before assuming the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If all volumes are completely bound, then allBound is true and binding will be skipped.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Otherwise, binding of volumes is started after the pod is assumed, but before pod binding.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This function modifies &#39;assumedPod&#39; if volume binding is required.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">allBound</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">assumeVolumes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// assume modifies `assumedPod` by setting NodeName=suggestedHost
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">assume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// bind the pod to its host asynchronously (we can do this b/c of the assumption step above).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Bind volumes first before Pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">allBound</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bindVolumes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Binding</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UID</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Target</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectReference</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Node&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">E2eSchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Internal error binding pod: (%v)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下对重要代码分别进行分析。</p>
<h1 id="3-config-nextpod">3. config.NextPod</h1>
<p>通过<code>podQueue</code>的方式存储待调度的pod队列，<code>NextPod</code>拿出下一个需要被调度的pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NextPod</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedScheduling&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;skip schedule deleting pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Skip schedule deleting pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Attempting to schedule pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>NextPod</code>的具体函数在factory.go的CreateFromKey函数中定义，如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">configFactory</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">CreateFromKeys</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateKeys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityKeys</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">extenders</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerExtender</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">scheduler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">scheduler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Config</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">NextPod</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getNextPod</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>      
</span></span></code></pre></div><h2 id="3-1-getnextpod">3.1. getNextPod</h2>
<p>通过一个podQueue来存储需要调度的pod的队列，通过队列Pop的方式弹出需要被调度的pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">configFactory</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">getNextPod</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pop</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;About to try and schedule pod %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error while retrieving next pod from scheduling queue: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-scheduler-schedule">4. Scheduler.schedule</h1>
<blockquote>
<p>此部分代码位于pkg/scheduler/scheduler.go</p>
</blockquote>
<p>此部分为调度逻辑的核心，通过不同的算法为具体的pod选择一个最合适的节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Synchronously attempt to find a fit for the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// schedule() may have failed because the pod would not fit on any host, so we try to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// preempt, with the expectation that the next time the pod is tried for scheduling it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// will fit due to the preemption. It is also possible that a different pod will schedule
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// into the resources that were preempted, but this is harmless.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">preemptionStartTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionAttempts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Inc</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPremptionEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>schedule</code>通过调度算法返回一个最优的节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// schedule implements the scheduling algorithm and returns the suggested host.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pod</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedScheduling&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConditionUpdater</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodCondition</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodScheduled</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Status</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionFalse</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Reason</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodReasonUnschedulable</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Message</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="4-1-schedulealgorithm">4.1. ScheduleAlgorithm</h2>
<p><code>ScheduleAlgorithm</code>是一个调度算法的接口，主要的实现体是<code>genericScheduler</code>，后续分析<code>genericScheduler.Schedule</code>。</p>
<p><code>ScheduleAlgorithm</code>接口定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ScheduleAlgorithm is an interface implemented by things that know how to schedule pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// onto machines.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ScheduleAlgorithm</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">selectedMachine</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Preempt receives scheduling errors for a pod and tries to create room for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the pod by preempting lower priority pods if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// It returns the node where preemption happened, a list of preempted pods, a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// list of pods whose nominated node name should be removed, and error if any.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">selectedNode</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptedPods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cleanupNominatedPods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Predicates() returns a pointer to a map of predicate functions. This is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// exposed for testing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Predicates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">FitPredicate</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Prioritizers returns a slice of priority config. This is exposed for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// testing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Prioritizers</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">PriorityConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-genericscheduler-schedule-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-core-generic-scheduler-go-l117">5. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go#L117">genericScheduler.Schedule</a></h1>
<blockquote>
<p>此部分代码位于/pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<p><code>genericScheduler.Schedule</code>实现了基本的调度逻辑，基于给定需要调度的pod和node列表，如果执行成功返回调度的节点的名字，如果执行失败，则返回错误和原因。主要通过预选和优选两步操作完成调度的逻辑。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>对pod做基本性检查，目前主要是对pvc的检查。</li>
<li>通过<code>findNodesThatFit</code>预选策略选出满足调度条件的node列表。</li>
<li>通过<code>PrioritizeNodes</code>优选策略给预选的node列表中的node进行打分。</li>
<li>在打分的node列表中选择一个分数最高的node作为调度的节点。</li>
</ol>
<p>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Schedule tries to schedule the given pod to one of the nodes in the node list.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If it succeeds, it will return the name of the node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If it fails, it will return a FitError error with reasons.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utiltrace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Scheduling %s/%s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LogIfLong</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podPassesBasicChecks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pvcLister</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ErrNoNodesAvailable</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Used for all fit and priority funcs.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateNodeNameToInfoMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Computing predicates&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startPredicateEvalTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findNodesThatFit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">NumAllNodes</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">FailedPredicates</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPredicateEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPredicateEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPredicateEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Prioritizing&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startPriorityEvalTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// When only one node after predicate, just use it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPriorityEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metaPrioritiesInterface</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">priorityMetaProducer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">PrioritizeNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaPrioritiesInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prioritizers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPriorityEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Selecting host&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">selectHost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-1-podpassesbasicchecks">5.1. podPassesBasicChecks</h2>
<p>podPassesBasicChecks主要做一下基本性检查，目前主要是对pvc的检查。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-GO" data-lang="GO"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podPassesBasicChecks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pvcLister</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>podPassesBasicChecks具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// podPassesBasicChecks makes sanity checks on the pod if it can be scheduled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">podPassesBasicChecks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvcLister</span> <span style="color:#000">corelisters</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaimLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Check PVCs used by the pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">namespace</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">manifest</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">manifest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volumes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">volume</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">manifest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Volumes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaim</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Volume is not a PVC, ignore
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pvcName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">volume</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaim</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClaimName</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pvc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pvcLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PersistentVolumeClaims</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pvcName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// The error has already enough context (&#34;persistentvolumeclaim &#34;myclaim&#34; not found&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pvc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;persistentvolumeclaim %q is being deleted&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pvc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-2-findnodesthatfit">5.2. findNodesThatFit</h2>
<p>预选，通过预选函数来判断每个节点是否适合被该Pod调度。</p>
<blockquote>
<p>具体的<code>findNodesThatFit</code>代码实现细节待后续文章独立分析。</p>
</blockquote>
<p><code>genericScheduler.Schedule</code>中对<code>findNodesThatFit</code>的调用过程如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Computing predicates&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">startPredicateEvalTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findNodesThatFit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">NumAllNodes</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">FailedPredicates</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPredicateEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPredicateEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPredicateEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h2 id="5-3-prioritizenodes">5.3. PrioritizeNodes</h2>
<p>优选，从满足的节点中选择出最优的节点。</p>
<p>具体操作如下：</p>
<ul>
<li>PrioritizeNodes通过并行运行各个优先级函数来对节点进行优先级排序。</li>
<li>每个优先级函数会给节点打分，打分范围为0-10分。</li>
<li>0 表示优先级最低的节点，10表示优先级最高的节点。</li>
<li>每个优先级函数也有各自的权重。</li>
<li>优先级函数返回的节点分数乘以权重以获得加权分数。</li>
<li>最后组合（添加）所有分数以获得所有节点的总加权分数。</li>
</ul>
<blockquote>
<p>具体<code>PrioritizeNodes</code>的实现逻辑待后续文章独立分析。</p>
</blockquote>
<p><code>genericScheduler.Schedule</code>中对<code>PrioritizeNodes</code>的调用过程如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Prioritizing&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">startPriorityEvalTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// When only one node after predicate, just use it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPriorityEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">metaPrioritiesInterface</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">priorityMetaProducer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">PrioritizeNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaPrioritiesInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prioritizers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPriorityEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><h2 id="5-4-selecthost">5.4. selectHost</h2>
<p><code>scheduler</code>在最后会从<code>priorityList</code>中选择分数最高的一个节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Selecting host&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">selectHost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>selectHost</code>获取优先级的节点列表，然后从分数最高的节点以循环方式选择一个节点。</p>
<p>具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// selectHost takes a prioritized list of nodes and then picks one
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// in a round-robin manner from the nodes that had the highest score.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">selectHost</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;empty priorityList&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxScores</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">findMaxScores</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ix</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastNodeIndex</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#204a87">uint64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxScores</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lastNodeIndex</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">maxScores</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ix</span><span style="color:#000;font-weight:bold">]].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="5-4-1-findmaxscores">5.4.1. findMaxScores</h3>
<p><code>findMaxScores</code>返回<code>priorityList</code>中具有最高<code>Score</code>的节点的索引。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// findMaxScores returns the indexes of nodes in the &#34;priorityList&#34; that has the highest &#34;Score&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">findMaxScores</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxScoreIndexes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxScore</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hp</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityList</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">hp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Score</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">maxScore</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">maxScore</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">hp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">maxScoreIndexes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">maxScoreIndexes</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">maxScoreIndexes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxScoreIndexes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">hp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">maxScore</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">maxScoreIndexes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxScoreIndexes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">maxScoreIndexes</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="6-scheduler-preempt">6. Scheduler.preempt</h1>
<p>如果pod在预选和优选调度中失败，则执行抢占操作。抢占主要是将低优先级的pod的资源空间腾出给待调度的高优先级的pod。</p>
<blockquote>
<p>具体<code>Scheduler.preempt</code>的实现逻辑待后续文章独立分析。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// schedule() may have failed because the pod would not fit on any host, so we try to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// preempt, with the expectation that the next time the pod is tried for scheduling it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// will fit due to the preemption. It is also possible that a different pod will schedule
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// into the resources that were preempted, but this is harmless.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">preemptionStartTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionAttempts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Inc</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPremptionEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="7-scheduler-assume">7. Scheduler.assume</h1>
<p>将该pod和选定的节点进行假性绑定，存入scheduler cache中，方便可以继续执行调度逻辑，而不需要等待绑定操作的发生，具体绑定操作可以异步进行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Tell the cache to assume that a pod now is running on a given node, even though it hasn&#39;t been bound yet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This allows us to keep scheduling without waiting on binding to occur.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">assumedPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Assume volumes first before assuming the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If all volumes are completely bound, then allBound is true and binding will be skipped.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Otherwise, binding of volumes is started after the pod is assumed, but before pod binding.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This function modifies &#39;assumedPod&#39; if volume binding is required.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">allBound</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">assumeVolumes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// assume modifies `assumedPod` by setting NodeName=suggestedHost
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">assume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果假性绑定成功则发送请求给apiserver，如果失败则scheduler会立即释放已分配给假性绑定的pod的资源。</p>
<p>assume方法的具体实现：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// assume signals to the cache that a pod is already in the cache, so that binding can be asynchronous.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// assume modifies `assumed`.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">assume</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Optimistically assume that the binding will succeed and send it to apiserver
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// in the background.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If the binding fails, scheduler will release resources allocated to assumed pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// immediately.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Spec</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">host</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// NOTE: Because the scheduler uses snapshots of SchedulerCache and the live
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// version of Ecache, updates must be written to SchedulerCache before
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// invalidating Ecache.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AssumePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scheduler cache AssumePod failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// This is most probably result of a BUG in retrying logic.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// We report an error here so that pod scheduling can be retried.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// This relies on the fact that Error will check if the pod has been bound
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// to a node and if so will not add it back to the unscheduled pods queue
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// (otherwise this would cause an infinite loop).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedScheduling&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;AssumePod failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConditionUpdater</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodCondition</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodScheduled</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Status</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionFalse</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Reason</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;SchedulerError&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Message</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Optimistically assume that the binding will succeed, so we need to invalidate affected
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// predicates in equivalence cache.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If the binding fails, these invalidated item will not break anything.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ecache</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ecache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InvalidateCachedPredicateItemForPodAdd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="8-scheduler-bind">8. Scheduler.bind</h1>
<p>异步的方式给pod绑定到具体的调度节点上。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// bind the pod to its host asynchronously (we can do this b/c of the assumption step above).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Bind volumes first before Pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">allBound</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bindVolumes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Binding</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UID</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">assumedPod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Target</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectReference</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Node&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">E2eSchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Internal error binding pod: (%v)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}()</span>
</span></span></code></pre></div><p>bind具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// bind binds a pod to a given node defined in a binding object.  We expect this to run asynchronously, so we
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// handle binding metrics internally.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Binding</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">bindingStart</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If binding succeeded then PodScheduled condition will be updated in apiserver so that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// it&#39;s atomic with setting host.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetBinder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FinishBinding</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scheduler cache FinishBinding failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to bind pod: %v/%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ForgetPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;scheduler cache ForgetPod failed: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeWarning</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;FailedScheduling&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Binding rejected: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodConditionUpdater</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodCondition</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodScheduled</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Status</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionFalse</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Reason</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;BindingRejected&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BindingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bindingStart</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Binding</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bindingStart</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Scheduled&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Successfully assigned %v/%v to %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">assumed</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Target</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="9-总结">9. 总结</h1>
<p>本文主要分析了单个pod的调度过程。具体流程如下：</p>
<ol>
<li>通过podQueue的待调度队列中弹出需要调度的pod。</li>
<li>通过具体的调度算法为该pod选出合适的节点，其中调度算法就包括预选和优选两步策略。</li>
<li>如果上述调度失败，则会尝试抢占机制，将优先级低的pod剔除，让优先级高的pod调度成功。</li>
<li>将该pod和选定的节点进行假性绑定，存入scheduler cache中，方便具体绑定操作可以异步进行。</li>
<li>实际执行绑定操作，将node的名字添加到pod的节点相关属性中。</li>
</ol>
<p>其中核心的部分为通过具体的调度算法选出调度节点的过程，即<code>genericScheduler.Schedule</code>的实现部分。该部分包括预选和优选两个部分。</p>
<p><code>genericScheduler.Schedule</code>调度的基本流程如下：</p>
<ol>
<li>对pod做基本性检查，目前主要是对pvc的检查。</li>
<li>通过<code>findNodesThatFit</code>预选策略选出满足调度条件的node列表。</li>
<li>通过<code>PrioritizeNodes</code>优选策略给预选的node列表中的node进行打分。</li>
<li>在打分的node列表中选择一个分数最高的node作为调度的节点。</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/scheduler.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ea2ce71fd47cea6adf169e5d35e56977">5 - </h1>
    
	<h1 id="kube-scheduler源码分析-四-之-findnodesthatfit">kube-scheduler源码分析（四）之 findNodesThatFit</h1>
<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析调度逻辑中的预选策略，即第一步筛选出符合pod调度条件的节点。</p>
<h1 id="1-调用入口-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-core-generic-scheduler-go-l117">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go#L117">调用入口</a></h1>
<p>预选，通过预选函数来判断每个节点是否适合被该Pod调度。</p>
<p><code>genericScheduler.Schedule</code>中对<code>findNodesThatFit</code>的调用过程如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 列出所有的节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ErrNoNodesAvailable</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Used for all fit and priority funcs.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateNodeNameToInfoMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Computing predicates&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startPredicateEvalTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 调用findNodesThatFit过滤出预选节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findNodesThatFit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">:</span>              <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">NumAllNodes</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">FailedPredicates</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// metrics
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPredicateEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPredicateEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			  <span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPredicateEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 调用findNodesThatFit过滤出预选节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findNodesThatFit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="2-findnodesthatfit-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-core-generic-scheduler-go-l365">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go#L365">findNodesThatFit</a></h1>
<p><code>findNodesThatFit</code>基于给定的预选函数过滤node，每个node传入到预选函数中来确实该节点是否符合要求。</p>
<p><code>findNodesThatFit</code>的入参是被调度的pod和当前的节点列表，返回预选节点列表和错误。</p>
<p><code>findNodesThatFit</code>基本流程如下：</p>
<ol>
<li>设置可行节点的总数，作为预选节点数组的容量，避免总节点过多需要筛选的节点过多。</li>
<li>通过<code>NodeTree</code>不断获取下一个节点来判断该节点是否满足pod的调度条件。</li>
<li>通过之前注册的各种预选函数来判断当前节点是否符合pod的调度条件。</li>
<li>最后返回满足调度条件的node列表，供下一步的优选操作。</li>
</ol>
<p><code>findNodesThatFit</code>完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Filters the nodes to find the ones that fit based on the given predicate functions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Each node is passed through the predicate functions to determine if it is a fit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">findNodesThatFit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">FailedPredicateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">filtered</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000">failedPredicateMap</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">FailedPredicateMap</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">filtered</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">nodes</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">allNodes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeTree</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">NumNodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">numNodesToFind</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">numFeasibleNodesToFind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// Create filtered list with enough space to avoid growing it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// and allow assigning.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">filtered</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">numNodesToFind</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">errs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MessageCountMap</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">predicateResultLock</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">filteredLen</span>         <span style="color:#204a87;font-weight:bold">int32</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">equivClass</span>          <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">equivalence</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Class</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithCancel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// We can use the same metadata producer for all nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">meta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicateMetaProducer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equivalenceCache</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#8f5902;font-style:italic">// getEquivalenceClassInfo will return immediately if no equivalence pod found
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>         <span style="color:#000">equivClass</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">equivalence</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewClass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">checkNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">nodeCache</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">equivalence</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeCache</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">nodeName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeTree</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Next</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equivalenceCache</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">nodeCache</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equivalenceCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNodeCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">fits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podFitsOnNode</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">nodeCache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">alwaysCheckAllPredicates</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">equivClass</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">errs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">()]</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fits</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">filteredLen</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">length</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">numNodesToFind</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">filteredLen</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">length</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">failedPredicates</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// Stops searching for more nodes once the configured number of feasible nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// are found.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParallelizeUntil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">checkNode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">filtered</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#000">filteredLen</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">FailedPredicateMap</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CreateAggregateFromMessageCountMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">extender</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsInterested</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">filteredList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Filter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsIgnorable</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Skipping extender %v as it returned error %v and has ignorable flag set&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>               <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">FailedPredicateMap</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">failedNodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedMsg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">failedMap</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">found</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">failedNodeName</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">found</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>               <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">failedNodeName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">failedNodeName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">failedNodeName</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewFailureReason</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedMsg</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000">filtered</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">filteredList</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下对<code>findNodesThatFit</code>分段分析。</p>
<h1 id="3-numfeasiblenodestofind">3. numFeasibleNodesToFind</h1>
<p><code>findNodesThatFit</code>先基于所有的节点找出可行的节点是总数。<code>numFeasibleNodesToFind</code>的作用主要是避免当节点过多（超过100）影响调度的效率。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">allNodes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeTree</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">NumNodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">numNodesToFind</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">numFeasibleNodesToFind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Create filtered list with enough space to avoid growing it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and allow assigning.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">filtered</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">numNodesToFind</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>numFeasibleNodesToFind</code>基本流程如下：</p>
<ul>
<li>如果所有的node节点小于<code>minFeasibleNodesToFind</code>(当前默认为100)则返回节点数。</li>
<li>如果节点数超100，则取指定计分的百分比的节点数，当该百分比后的数目仍小于<code>minFeasibleNodesToFind</code>，则返回<code>minFeasibleNodesToFind</code>。</li>
<li>如果百分比后的数目大于<code>minFeasibleNodesToFind</code>，则返回该百分比。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// numFeasibleNodesToFind returns the number of feasible nodes that once found, the scheduler stops
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// its search for more feasible nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">numFeasibleNodesToFind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">numAllNodes</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">numAllNodes</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minFeasibleNodesToFind</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">percentageOfNodesToScore</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">||</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">percentageOfNodesToScore</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">numAllNodes</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">numNodes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">numAllNodes</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">percentageOfNodesToScore</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">numNodes</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minFeasibleNodesToFind</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">minFeasibleNodesToFind</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">numNodes</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-checknode">4. checkNode</h1>
<p><code>checkNode</code>是一个校验node是否符合要求的函数，其中实际调用到的核心函数是<code>podFitsOnNode</code>。再通过<code>workqueue</code>并发执行<code>checkNode</code>操作。</p>
<p><strong><code>checkNode</code>主要流程如下：</strong></p>
<ol>
<li>通过cache中的nodeTree不断获取下一个node。</li>
<li>将当前node和pod传入<code>podFitsOnNode</code>判断当前node是否符合要求。</li>
<li>如果当前node符合要求就将当前node加入预选节点的数组中<code>filtered</code>。</li>
<li>如果当前node不满足要求，则加入到失败的数组中，并记录原因。</li>
<li>通过<code>workqueue.ParallelizeUntil</code>并发执行<code>checkNode</code>函数，一旦找到配置的可行节点数，就停止搜索更多节点。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">checkNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">nodeCache</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">equivalence</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeCache</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeTree</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Next</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equivalenceCache</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeCache</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equivalenceCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetNodeCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podFitsOnNode</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeCache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">alwaysCheckAllPredicates</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">equivClass</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">errs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">()]</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fits</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">filteredLen</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">length</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">numNodesToFind</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">filteredLen</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">filtered</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">length</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">failedPredicateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">failedPredicates</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateResultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>workqueue的并发操作：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Stops searching for more nodes once the configured number of feasible nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// are found.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParallelizeUntil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">checkNode</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>ParallelizeUntil</code>具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ParallelizeUntil is a framework that allows for parallelizing N
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// independent pieces of work until done or the context is canceled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ParallelizeUntil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">workers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pieces</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">doWorkPiece</span> <span style="color:#000">DoWorkPieceFunc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">stop</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">toProcess</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pieces</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">pieces</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">toProcess</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">i</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">toProcess</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pieces</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">workers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">workers</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pieces</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">workers</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">workers</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">utilruntime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleCrash</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">piece</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">toProcess</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">stop</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">doWorkPiece</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">piece</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="5-podfitsonnode">5. podFitsOnNode</h1>
<p><code>podFitsOnNode</code>主要内容如下：</p>
<ul>
<li>
<p><code>podFitsOnNode</code>会检查给定的某个Node是否满足预选的函数。</p>
</li>
<li>
<p>对于给定的pod，<code>podFitsOnNode</code>会检查是否有相同的pod存在，尽量复用缓存过的预选结果。</p>
</li>
</ul>
<p><code>podFitsOnNode</code>主要在<code>Schedule</code>（调度）和<code>Preempt</code>（抢占）的时候被调用。</p>
<p>当在<code>Schedule</code>中被调用的时候，主要判断是否可以被调度到当前节点，依据为当前节点上所有已存在的pod及被提名要运行到该节点的具有相等或更高优先级的pod。</p>
<p>当在<code>Preempt</code>中被调用的时候，即发生抢占的时候，通过<code>SelectVictimsOnNode</code>函数选出需要被移除的pod，移除后然后将预调度的pod调度到该节点上。</p>
<p><strong>podFitsOnNode基本流程如下：</strong></p>
<ol>
<li>遍历之前注册好的预选策略<code>predicates.Ordering</code>，并获取预选策略的执行函数。</li>
<li>遍历执行每个预选函数，并返回是否合适，预选失败的原因和错误。</li>
<li>如果预选函数执行的结果不合适，则加入预选失败的数组中。</li>
<li>最后返回预选失败的个数是否为0，和预选失败的原因。</li>
</ol>
<p><strong>入参：</strong></p>
<ul>
<li>pod</li>
<li>PredicateMetadata</li>
<li>NodeInfo</li>
<li>predicateFuncs</li>
<li>schedulercache.Cache</li>
<li>nodeCache</li>
<li>SchedulingQueue</li>
<li>alwaysCheckAllPredicates</li>
<li>equivClass</li>
</ul>
<p><strong>出参：</strong></p>
<ul>
<li>fit</li>
<li>PredicateFailureReason</li>
</ul>
<p>完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// podFitsOnNode checks whether a node given by NodeInfo satisfies the given predicate functions.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// For given pod, podFitsOnNode will check if any equivalent pod exists and try to reuse its cached
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// predicate results as possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This function is called from two different places: Schedule and Preempt.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// When it is called from Schedule, we want to test whether the pod is schedulable
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// on the node with all the existing pods on the node plus higher and equal priority
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pods nominated to run on the node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// When it is called from Preempt, we should remove the victims of preemption and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// add the nominated pods. Removal of the victims is done by SelectVictimsOnNode().
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It removes victims from meta and NodeInfo before calling this function.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">podFitsOnNode</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">meta</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadata</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">info</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicateFuncs</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cache</span> <span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeCache</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">equivalence</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeCache</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">queue</span> <span style="color:#000">SchedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">alwaysCheckAllPredicates</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">equivClass</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">equivalence</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Class</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">eCacheAvailable</span>  <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">failedPredicates</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podsAdded</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We run predicates twice in some cases. If the node has greater or equal priority
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// nominated pods, we run them when those pods are added to meta and nodeInfo.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If all predicates succeed in this pass, we run them again when these
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// nominated pods are not added. This second pass is necessary because some
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// predicates such as inter-pod affinity may not pass without the nominated pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// If there are no nominated pods for the node or if the first run of the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// predicates fail, we don&#39;t run the second pass.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// We consider only equal or higher priority pods in the first pass, because
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// those are the current &#34;pod&#34; must yield to them and not take a space opened
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// for running them. It is ok if the current &#34;pod&#34; take resources freed for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// lower priority pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Requiring that the new pod is schedulable in both circumstances ensures that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// we are making a conservative decision: predicates like resources and inter-pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// anti-affinity are more likely to fail when the nominated pods are treated
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// as running, while predicates like pod affinity are more likely to fail when
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the nominated pods are treated as not running. We can&#39;t just assume the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// nominated pods are running because they are not running right now and in fact,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// they may end up getting scheduled to a different node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metaToUse</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">meta</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeInfoToUse</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">info</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">podsAdded</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoToUse</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">addNominatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">info</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">podsAdded</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedPredicates</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Bypass eCache if node has any nominated pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// TODO(bsalamat): consider using eCache and adding proper eCache invalidations
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// when pods are nominated or their nominations change.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">eCacheAvailable</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">equivClass</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">nodeCache</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">podsAdded</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateKey</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ordering</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fit</span>     <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">reasons</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">err</span>     <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">//TODO (yastij) : compute average predicate restrictiveness to export it as Prometheus metric
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exist</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">predicateFuncs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">predicateKey</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">exist</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">eCacheAvailable</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">fit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reasons</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">nodeCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">equivClass</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">fit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reasons</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoToUse</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">fit</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#8f5902;font-style:italic">// eCache is available and valid, and predicates result is unfit, record the fail reasons
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>					<span style="color:#000">failedPredicates</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedPredicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reasons</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>					<span style="color:#8f5902;font-style:italic">// if alwaysCheckAllPredicates is false, short circuit all predicates when one predicate fails.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>					<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">alwaysCheckAllPredicates</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infoln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;since alwaysCheckAllPredicates has not been set, the predicate &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>							<span style="color:#4e9a06">&#34;evaluation is short circuited and there are chances &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>							<span style="color:#4e9a06">&#34;of other predicates failing as well.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">failedPredicates</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">failedPredicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="5-1-predicatefuncs">5.1. predicateFuncs</h2>
<p>根据之前初注册好的预选策略函数来执行预选，判断节点是否符合调度。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateKey</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ordering</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exist</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">predicateFuncs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">predicateKey</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">exist</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">eCacheAvailable</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reasons</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">nodeCache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RunPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">equivClass</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fit</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reasons</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">predicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaToUse</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoToUse</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>预选策略如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicatesOrdering</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">CheckNodeConditionPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CheckNodeUnschedulablePred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">GeneralPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HostNamePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PodFitsHostPortsPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MatchNodeSelectorPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PodFitsResourcesPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NoDiskConflictPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">PodToleratesNodeTaintsPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PodToleratesNodeNoExecuteTaintsPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CheckNodeLabelPresencePred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">CheckServiceAffinityPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxEBSVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxGCEPDVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MaxCSIVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MaxAzureDiskVolumeCountPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CheckVolumeBindingPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NoVolumeZoneConflictPred</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">CheckNodeMemoryPressurePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CheckNodePIDPressurePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CheckNodeDiskPressurePred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MatchInterPodAffinityPred</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="6-podfitsresources">6. PodFitsResources</h1>
<p>以下以<code>PodFitsResources</code>这个预选函数为例做分析，其他重要的预选函数待后续单独分析。</p>
<p><code>PodFitsResources</code>用来检查一个节点是否有足够的资源来运行当前的pod，包括CPU、内存、GPU等。</p>
<p><strong>PodFitsResources基本流程如下：</strong></p>
<ol>
<li>判断当前节点上pod总数加上预调度pod个数是否大于node的可分配pod总数，若是则不允许调度。</li>
<li>判断pod的request值是否都为0，若是则允许调度。</li>
<li>判断pod的request值加上当前node上所有pod的request值总和是否大于node的可分配资源，若是则不允许调度。</li>
<li>判断pod的拓展资源request值加上当前node上所有pod对应的request值总和是否大于node对应的可分配资源，若是则不允许调度。</li>
</ol>
<p><code>PodFitsResources</code>的注册代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterFitPredicate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsResourcesPred</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodFitsResources</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>PodFitsResources入参：</strong></p>
<ul>
<li>
<p>pod</p>
</li>
<li>
<p>nodeInfo</p>
</li>
<li>
<p>PredicateMetadata</p>
</li>
</ul>
<p><strong>PodFitsResources出参：</strong></p>
<ul>
<li>fit</li>
<li>PredicateFailureReason</li>
</ul>
<p>PodFitsResources完整代码：</p>
<blockquote>
<p>此部分的代码位于pkg/scheduler/algorithm/predicates/predicates.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PodFitsResources checks if a node has sufficient resources, such as cpu, memory, gpu, opaque int resources etc to run a pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// First return value indicates whether a node has sufficient resources to run a pod while the second return value indicates the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// predicate failure reasons if the node has insufficient resources to run the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">PodFitsResources</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;node not found&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">allowedPodNumber</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllowedPodNumber</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">())</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">allowedPodNumber</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourcePods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">())),</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allowedPodNumber</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// No extended resources should be ignored by default.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ignoredExtendedResources</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewString</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">podRequest</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Resource</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">predicateMeta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">predicateMetadata</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podRequest</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">predicateMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podRequest</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">predicateMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ignoredExtendedResources</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ignoredExtendedResources</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">predicateMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ignoredExtendedResources</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// We couldn&#39;t parse metadata - fallback to computing it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">podRequest</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">GetResourceRequest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">allocatable</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllocatableResource</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">MilliCPU</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceCPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">MilliCPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Memory</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceMemory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">EphemeralStorage</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEphemeralStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">EphemeralStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">rName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rQuant</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v1helper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsExtendedResourceName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// If this resource is one of the extended resources that should be
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// ignored, we will skip checking it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ignoredExtendedResources</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Has</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">rQuant</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">]))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// We explicitly don&#39;t do glog.V(10).Infof() to avoid computing all the parameters if this is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// not logged. There is visible performance gain from it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Schedule Pod %+v on Node %+v is allowed, Node is running only %v out of %v Pods.&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">podName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">allowedPodNumber</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-1-nodeinfo">6.1. NodeInfo</h2>
<p><code>NodeInfo</code>是node的聚合信息，主要包括：</p>
<ul>
<li>node：k8s node的结构体</li>
<li>pods：当前node上pod的数量</li>
<li>requestedResource：当前node上所有pod的request总和</li>
<li>allocatableResource：node的实际所有的可分配资源(对应于Node.Status.Allocatable.*)，可理解为node的资源总量。</li>
</ul>
<blockquote>
<p>此部分代码位于pkg/scheduler/cache/node_info.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NodeInfo is node level aggregated information.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">NodeInfo</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Overall node information.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pods</span>             <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podsWithAffinity</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">usedPorts</span>        <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPortInfo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Total requested resource of all pods on this node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// It includes assumed pods which scheduler sends binding to apiserver but
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// didn&#39;t get it as scheduled yet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">requestedResource</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Resource</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nonzeroRequest</span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Resource</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We store allocatedResources (which is Node.Status.Allocatable.*) explicitly
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// as int64, to avoid conversions and accessing map.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">allocatableResource</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Resource</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Cached taints of the node for faster lookup.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">taints</span>    <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Taint</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">taintsErr</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// imageStates holds the entry of an image if and only if this image is on the node. The entry can be used for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// checking an image&#39;s existence and advanced usage (e.g., image locality scheduling policy) based on the image
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// state information.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">imageStates</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ImageStateSummary</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TransientInfo holds the information pertaining to a scheduling cycle. This will be destructed at the end of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// scheduling cycle.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// TODO: @ravig. Remove this once we have a clear approach for message passing across predicates and priorities.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">TransientInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">transientSchedulerInfo</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Cached conditions of node for faster lookup.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">memoryPressureCondition</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionStatus</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">diskPressureCondition</span>   <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionStatus</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pidPressureCondition</span>    <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ConditionStatus</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Whenever NodeInfo changes, generation is bumped.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This is used to avoid cloning it if the object didn&#39;t change.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">generation</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-2-resource">6.2. Resource</h2>
<p><code>Resource</code>是可计算资源的集合体。主要包括：</p>
<ul>
<li>MilliCPU</li>
<li>Memory</li>
<li>EphemeralStorage</li>
<li>AllowedPodNumber：允许的pod总数(对应于Node.Status.Allocatable.Pods().Value())，一般为110。</li>
<li>ScalarResources</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Resource is a collection of compute resource.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Resource</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MilliCPU</span>         <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Memory</span>           <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">EphemeralStorage</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We store allowedPodNumber (which is Node.Status.Allocatable.Pods().Value())
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// explicitly as int, to avoid conversions and improve performance.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">AllowedPodNumber</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// ScalarResources
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ScalarResources</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceName</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<p>以下分析podFitsOnNode的具体流程。</p>
<h2 id="6-3-allowedpodnumber">6.3. allowedPodNumber</h2>
<p>首先获取节点的信息，先判断如果该节点当前所有的pod的个数加上当前预调度的pod是否会大于该节点允许的pod的总数，一般为110个。如果超过，则<code>predicateFails</code>数组增加1，即当前节点不适合该pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;node not found&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateFailureReason</span>
</span></span><span style="display:flex;"><span><span style="color:#000">allowedPodNumber</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllowedPodNumber</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">())</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">allowedPodNumber</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourcePods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">())),</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allowedPodNumber</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-4-podrequest">6.4. podRequest</h2>
<p>如果podRequest都为0，则允许调度到该节点，直接返回结果。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-5-allocatableresource">6.5. AllocatableResource</h2>
<p>如果当前预调度的pod的request资源加上当前node上所有pod的request总和大于该node的可分配资源总量，则不允许调度到该节点，直接返回结果。其中request资源包括CPU、内存、storage。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">allocatable</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AllocatableResource</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">MilliCPU</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceCPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">MilliCPU</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MilliCPU</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Memory</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceMemory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Memory</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">EphemeralStorage</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEphemeralStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">EphemeralStorage</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EphemeralStorage</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="6-6-scalarresources">6.6. ScalarResources</h2>
<p>判断其他拓展的标量资源，是否该pod的request值加上当前node上所有pod的对应资源的request总和大于该node上对应资源的可分配总量，如果是，则不允许调度到该节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">rName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rQuant</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v1helper</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsExtendedResourceName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// If this resource is one of the extended resources that should be
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// ignored, we will skip checking it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ignoredExtendedResources</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Has</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">rQuant</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">predicateFails</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">predicateFails</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NewInsufficientResourceError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">podRequest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RequestedResource</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">allocatable</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ScalarResources</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">rName</span><span style="color:#000;font-weight:bold">]))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="7-总结">7. 总结</h1>
<p><code>findNodesThatFit</code>基于给定的预选函数过滤node，每个node传入到预选函数中来确实该节点是否符合要求。</p>
<p><code>findNodesThatFit</code>的入参是被调度的pod和当前的节点列表，返回预选节点列表和错误。</p>
<p><strong><code>findNodesThatFit</code>基本流程如下：</strong></p>
<ol>
<li>设置可行节点的总数，作为预选节点数组的容量，避免总节点过多导致需要筛选的节点过多，效率低。</li>
<li>通过<code>NodeTree</code>不断获取下一个节点来判断该节点是否满足pod的调度条件。</li>
<li>通过之前注册的各种预选函数来判断当前节点是否符合pod的调度条件。</li>
<li>最后返回满足调度条件的node列表，供下一步的优选操作。</li>
</ol>
<h2 id="7-1-checknode">7.1. checkNode</h2>
<p><code>checkNode</code>是一个校验node是否符合要求的函数，其中实际调用到的核心函数是<code>podFitsOnNode</code>。再通过<code>workqueue</code>并发执行<code>checkNode</code>操作。</p>
<p><strong><code>checkNode</code>主要流程如下：</strong></p>
<ol>
<li>通过cache中的nodeTree不断获取下一个node。</li>
<li>将当前node和pod传入<code>podFitsOnNode</code>判断当前node是否符合要求。</li>
<li>如果当前node符合要求就将当前node加入预选节点的数组中<code>filtered</code>。</li>
<li>如果当前node不满足要求，则加入到失败的数组中，并记录原因。</li>
<li>通过<code>workqueue.ParallelizeUntil</code>并发执行<code>checkNode</code>函数，一旦找到配置的可行节点数，就停止搜索更多节点。</li>
</ol>
<h2 id="7-2-podfitsonnode">7.2. podFitsOnNode</h2>
<p>其中会调用到核心函数podFitsOnNode。</p>
<p><code>podFitsOnNode</code>主要内容如下：</p>
<ul>
<li>
<p><code>podFitsOnNode</code>会检查给定的某个Node是否满足预选的函数。</p>
</li>
<li>
<p>对于给定的pod，<code>podFitsOnNode</code>会检查是否有相同的pod存在，尽量复用缓存过的预选结果。</p>
</li>
</ul>
<p><code>podFitsOnNode</code>主要在<code>Schedule</code>（调度）和<code>Preempt</code>（抢占）的时候被调用。</p>
<p>当在<code>Schedule</code>中被调用的时候，主要判断是否可以被调度到当前节点，依据为当前节点上所有已存在的pod及被提名要运行到该节点的具有相等或更高优先级的pod。</p>
<p>当在<code>Preempt</code>中被调用的时候，即发生抢占的时候，通过<code>SelectVictimsOnNode</code>函数选出需要被移除的pod，移除后然后将预调度的pod调度到该节点上。</p>
<p><strong>podFitsOnNode基本流程如下：</strong></p>
<ol>
<li>遍历之前注册好的预选策略<code>predicates.Ordering</code>，并获取预选策略的执行函数。</li>
<li>遍历执行每个<code>预选函数</code>，并返回是否合适，预选失败的原因和错误。</li>
<li>如果预选函数执行的结果不合适，则加入预选失败的数组中。</li>
<li>最后返回预选失败的个数是否为0，和预选失败的原因。</li>
</ol>
<h2 id="7-3-podfitsresources">7.3. PodFitsResources</h2>
<blockquote>
<p>本文只示例分析了其中一个重要的预选函数：PodFitsResources</p>
</blockquote>
<p><code>PodFitsResources</code>用来检查一个节点是否有足够的资源来运行当前的pod，包括CPU、内存、GPU等。</p>
<p><strong>PodFitsResources基本流程如下：</strong></p>
<ol>
<li>判断当前节点上pod总数加上预调度pod个数是否大于node的可分配pod总数，若是则不允许调度。</li>
<li>判断pod的request值是否都为0，若是则允许调度。</li>
<li>判断pod的request值加上当前node上所有pod的request值总和是否大于node的可分配资源，若是则不允许调度。</li>
<li>判断pod的拓展资源request值加上当前node上所有pod对应的request值总和是否大于node对应的可分配资源，若是则不允许调度。</li>
</ol>
<p>参考：</p>
<ul>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go</a></p>
</li>
<li>
<p><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithm/predicates/predicates.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithm/predicates/predicates.go</a></p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8621391b1d2292ec57a9ce7538fe1a47">6 - </h1>
    
	<h1 id="kube-scheduler源码分析-五-之-prioritizenodes">kube-scheduler源码分析（五）之 PrioritizeNodes</h1>
<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析<code>优选策略</code>逻辑，即从预选的节点中选择出最优的节点。优选策略的具体实现函数为<code>PrioritizeNodes</code>。<code>PrioritizeNodes</code>最终返回是一个记录了各个节点分数的列表。</p>
<h1 id="1-调用入口-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-core-generic-scheduler-go-l165">1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go#L165">调用入口</a></h1>
<p><code>genericScheduler.Schedule</code>中对<code>PrioritizeNodes</code>的调用过程如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">trace</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Step</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Prioritizing&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">startPriorityEvalTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// When only one node after predicate, just use it.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPriorityEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metaPrioritiesInterface</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">priorityMetaProducer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 执行优选逻辑的操作，返回记录各个节点分数的列表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">PrioritizeNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaPrioritiesInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prioritizers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPriorityEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">startPriorityEvalTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><p>核心代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 基于预选节点filteredNodes进一步筛选优选的节点，返回记录各个节点分数的列表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">priorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">PrioritizeNodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaPrioritiesInterface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prioritizers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">filteredNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="2-prioritizenodes-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-core-generic-scheduler-go-l602">2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go#L602">PrioritizeNodes</a></h1>
<p>优选，从满足的节点中选择出最优的节点。<code>PrioritizeNodes</code>最终返回是一个记录了各个节点分数的列表。</p>
<p>具体操作如下：</p>
<ul>
<li>PrioritizeNodes通过并行运行各个优先级函数来对节点进行优先级排序。</li>
<li>每个优先级函数会给节点打分，打分范围为0-10分。</li>
<li>0 表示优先级最低的节点，10表示优先级最高的节点。</li>
<li>每个优先级函数也有各自的权重。</li>
<li>优先级函数返回的节点分数乘以权重以获得加权分数。</li>
<li>最后组合（添加）所有分数以获得所有节点的总加权分数。</li>
</ul>
<p><strong>PrioritizeNodes主要流程如下：</strong></p>
<ol>
<li>如果没有设置优选函数和拓展函数，则全部节点设置相同的分数，直接返回。</li>
<li>依次给node执行map函数进行打分。</li>
<li>再对上述map函数的执行结果执行reduce函数计算最终得分。</li>
<li>最后根据不同优先级函数的权重对得分取加权平均数。</li>
</ol>
<p><strong>入参：</strong></p>
<ul>
<li>pod</li>
<li>nodeNameToInfo</li>
<li>meta interface{},</li>
<li>priorityConfigs</li>
<li>nodes</li>
<li>extenders</li>
</ul>
<p><strong>出参：</strong></p>
<ul>
<li>HostPriorityList：记录节点分数的列表。</li>
</ul>
<p><code>HostPriority</code>定义如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// HostPriority represents the priority of scheduling to a particular host, higher priority is better.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">HostPriority</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Name of the host
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Host</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Score associated with the host
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Score</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>PrioritizeNodes</code>完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PrioritizeNodes prioritizes the nodes by running the individual priority functions in parallel.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Each priority function is expected to set a score of 0-10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 0 is the lowest priority score (least preferred node) and 10 is the highest
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Each priority function can also have its own weight
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The node scores returned by the priority function are multiplied by the weights to get weighted scores
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// All scores are finally combined (added) to get the total weighted scores of all nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">PrioritizeNodes</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeNameToInfo</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">meta</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfig</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodes</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">extenders</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerExtender</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If no priority configs are provided, then the EqualPriority function is applied
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// This is required to generate the priority list in the required format
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">EqualPriorityMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">result</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">errs</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">appendError</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">errs</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">priorityConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Function</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// DEPRECATED
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfig</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Function</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">appendError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">processNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Function</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">appendError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parallelize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">processNode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">priorityConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reduce</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfig</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reduce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">appendError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%v -&gt; %v: %v, Score: (%d)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Score</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Wait for all computations to be finished.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAggregate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Summarize all scores.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Score</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Weight</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">nodes</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">combinedScores</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">extender</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">extenders</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsInterested</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ext</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerExtender</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">prioritizedList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">weight</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prioritize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#8f5902;font-style:italic">// Prioritization errors from extender can be ignored, let k8s/other extenders determine the priorities
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>					<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prioritizedList</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">score</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prioritizedList</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prioritizedList</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">combinedScores</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">host</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">score</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">weight</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">extender</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// wait for all go routines to finish
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">combinedScores</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Host %s =&gt; Score %d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<p>以下对<code>PrioritizeNodes</code>分段进行分析。</p>
<h1 id="3-equalprioritymap">3. EqualPriorityMap</h1>
<p>如果没有提供优选函数和拓展函数，则将所有的节点设置为相同的优先级，即节点的score都为1，然后直接返回结果。(但一般情况下优选函数列表都不为空)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If no priority configs are provided, then the EqualPriority function is applied
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This is required to generate the priority list in the required format
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">EqualPriorityMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>EqualPriorityMap具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// EqualPriorityMap is a prioritizer function that gives an equal weight of one to all nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">EqualPriorityMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;node not found&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Host</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Score</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-processnode">4. processNode</h1>
<p><code>processNode</code>就是基于index拿出node的信息，调用之前注册的各种优选函数（此处是<code>mapFunction</code>），通过优选函数对node和pod进行处理，最后返回一个记录node分数的列表<code>result</code>。<code>processNode</code>同样也使用<code>workqueue.Parallelize</code>来进行并行处理。(<code>processNode</code>类似于预选逻辑<code>findNodesThatFit</code>中使用到的<code>checkNode</code>的作用)</p>
<p>其中优选函数是通过<code>priorityConfigs</code>来记录，每类优选函数包括<code>PriorityMapFunction</code>和<code>PriorityReduceFunction</code>两种函数。优选函数的注册部分可参考<a href="registerAlgorithmProvider.md">registerAlgorithmProvider</a>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">processNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Function</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">appendError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 并行执行processNode
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parallelize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">processNode</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>priorityConfigs</code>定义如下：</p>
<p>核心属性：</p>
<ul>
<li>Map ：PriorityMapFunction</li>
<li>Reduce：PriorityReduceFunction</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PriorityConfig is a config used for a priority function.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PriorityConfig</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span>   <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Map</span>    <span style="color:#000">PriorityMapFunction</span>   
</span></span><span style="display:flex;"><span>	<span style="color:#000">Reduce</span> <span style="color:#000">PriorityReduceFunction</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TODO: Remove it after migrating all functions to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Map-Reduce pattern.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Function</span> <span style="color:#000">PriorityFunction</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Weight</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>具体的优选函数处理逻辑待下文分析，本文会以<code>NewSelectorSpreadPriority</code>函数为例。</p>
<h1 id="5-prioritymapfunction">5. PriorityMapFunction</h1>
<p><code>PriorityMapFunction</code>是一个计算给定节点的每个节点结果的函数。</p>
<p><code>PriorityMapFunction</code>定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PriorityMapFunction is a function that computes per-node results for a given node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: Figure out the exact API of this method.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: Change interface{} to a specific type.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PriorityMapFunction</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>PriorityMapFunction是在<code>processNode</code>中调用的，代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>下文会分析<code>NewSelectorSpreadPriority</code>在的map函数<code>CalculateSpreadPriorityMap</code>。</p>
<h1 id="6-priorityreducefunction">6. PriorityReduceFunction</h1>
<p><code>PriorityReduceFunction</code>是一个聚合每个节点结果并计算所有节点的最终得分的函数。</p>
<p><code>PriorityReduceFunction</code>定义如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// PriorityReduceFunction is a function that aggregated per-node results and computes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// final scores for all nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: Figure out the exact API of this method.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TODO: Change interface{} to a specific type.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PriorityReduceFunction</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">nodeNameToInfo</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span></code></pre></div><p>PrioritizeNodes中对reduce函数调用部分如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityConfig</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">priorityConfig</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reduce</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfig</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reduce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">appendError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%v -&gt; %v: %v, Score: (%d)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hostPriority</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Score</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">priorityConfig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>下文会分析<code>NewSelectorSpreadPriority</code>在的reduce函数<code>CalculateSpreadPriorityReduce</code>。</p>
<h1 id="7-summarize-all-scores">7. Summarize all scores</h1>
<p>先等待计算完成再计算加权平均数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Wait for all computations to be finished.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewAggregate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">errs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>计算所有节点的加权平均数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Summarize all scores.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodes</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Score</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">priorityConfigs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">priorityConfigs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Weight</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>当设置了拓展的计算方式，则增加拓展计算方式的加权平均数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extenders</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">nodes</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">combinedScores</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">extender</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">extenders</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsInterested</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ext</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulerExtender</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">prioritizedList</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">weight</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ext</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Prioritize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// Prioritization errors from extender can be ignored, let k8s/other extenders determine the priorities
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prioritizedList</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">score</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prioritizedList</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prioritizedList</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">combinedScores</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">host</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">score</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">weight</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">extender</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// wait for all go routines to finish
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">combinedScores</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="8-newselectorspreadpriority">8. NewSelectorSpreadPriority</h1>
<p>以下以<code>NewSelectorSpreadPriority</code>这个优选函数来做分析，其他重要的优选函数待后续专门分析。</p>
<p><code>NewSelectorSpreadPriority</code>主要的功能是将属于相同service和rs下的pod尽量分布在不同的node上。</p>
<p>该函数的注册代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/algorithmprovider/defaults/defaults.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ServiceSpreadingPriority is a priority config factory that spreads pods by minimizing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the number of pods (belonging to the same service) on the same node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Register the factory so that it&#39;s available, but do not include it as part of the default priorities
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Largely replaced by &#34;SelectorSpreadPriority&#34;, but registered for backward compatibility with 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RegisterPriorityConfigFactory</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;ServiceSpreadingPriority&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityConfigFactory</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MapReduceFunction</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#000">factory</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PluginFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityMapFunction</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityReduceFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">priorities</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewSelectorSpreadPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EmptyControllerLister</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EmptyReplicaSetLister</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EmptyStatefulSetLister</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Weight</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>NewSelectorSpreadPriority</code>的具体实现如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/algorithm/priorities/selector_spreading.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NewSelectorSpreadPriority creates a SelectorSpread.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewSelectorSpreadPriority</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">serviceLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ServiceLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">controllerLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ControllerLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">replicaSetLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplicaSetLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">statefulSetLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StatefulSetLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityMapFunction</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PriorityReduceFunction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">selectorSpread</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">SelectorSpread</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">serviceLister</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">serviceLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">controllerLister</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">controllerLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">replicaSetLister</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">replicaSetLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">statefulSetLister</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">statefulSetLister</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">selectorSpread</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CalculateSpreadPriorityMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">selectorSpread</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CalculateSpreadPriorityReduce</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>NewSelectorSpreadPriority</code>主要包括map和reduce两种函数，分别对应<code>CalculateSpreadPriorityMap</code>，<code>CalculateSpreadPriorityReduce</code>。</p>
<h2 id="8-1-calculatespreadprioritymap-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-algorithm-priorities-selector-spreading-go-l66">8.1. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithm/priorities/selector_spreading.go#L66">CalculateSpreadPriorityMap</a></h2>
<p><code>CalculateSpreadPriorityMap</code>的主要作用是将相同service、RC、RS或statefulset的pod分布在不同的节点上。当调度一个pod的时候，先寻找与该pod匹配的service、RS、RC或statefulset，然后寻找与其selector匹配的已存在的pod，寻找存在这类pod最少的节点。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>寻找与该pod对应的service、RS、RC、statefulset匹配的selector。</li>
<li>遍历当前节点的所有pod，将该节点上已存在的selector匹配到的pod的个数作为该节点的分数（此时，分数大的表示匹配到的pod越多，越不符合被调度的条件，该分数在reduce阶段会被按10分制处理成分数大的越符合被调度的条件）。</li>
</ol>
<blockquote>
<p>此部分代码位于pkg/scheduler/algorithm/priorities/selector_spreading.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// CalculateSpreadPriorityMap spreads pods across hosts, considering pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// belonging to the same service,RC,RS or StatefulSet.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// When a pod is scheduled, it looks for services, RCs,RSs and StatefulSets that match the pod,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// then finds existing pods that match those selectors.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It favors nodes that have fewer existing matching pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// i.e. it pushes the scheduler towards a node where there&#39;s the smallest number of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pods which match the same service, RC,RSs or StatefulSets selectors as the pod being scheduled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">SelectorSpread</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">CalculateSpreadPriorityMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">selectors</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">labels</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Selector</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;node not found&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">priorityMeta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">priorityMetadata</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">selectors</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">priorityMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podSelectors</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">selectors</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">getSelectors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serviceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controllerLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">replicaSetLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statefulSetLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">selectors</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Host</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Score</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodePod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">nodePod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// When we are replacing a failed pod, we often see the previous
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// deleted version while scheduling the replacement.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// Ignore the previous deleted version for spreading purposes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// (it can still be considered for resource restrictions etc.)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">nodePod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletionTimestamp</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;skipping pending-deleted pod: %s/%s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodePod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodePod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">selector</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">selectors</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">selector</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Matches</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">labels</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodePod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Labels</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">count</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriority</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Host</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Score</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下分段分析：</p>
<p>先获得selector。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">selectors</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">getSelectors</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">serviceLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">controllerLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">replicaSetLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">statefulSetLister</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>计算节点上匹配selector的pod的个数，作为该节点分数，该分数并不是最终节点的分数，只是中间过渡的记录状态。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodePod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">selector</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">selectors</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">selector</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Matches</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">labels</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodePod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ObjectMeta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Labels</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">count</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="8-2-calculatespreadpriorityreduce-https-github-com-kubernetes-kubernetes-blob-v1-12-0-pkg-scheduler-algorithm-priorities-selector-spreading-go-l117">8.2. <a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithm/priorities/selector_spreading.go#L117">CalculateSpreadPriorityReduce</a></h2>
<p><code>CalculateSpreadPriorityReduce</code>根据节点上现有匹配pod的数量计算每个节点的十分制的分数，具有较少现有匹配pod的节点的分数越高，表示节点越可能被调度到。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>记录所有节点中匹配到pod个数最多的节点的分数（即匹配到的pod最多的个数）。</li>
<li>遍历所有的节点，按比例取十分制的得分，计算方式为：(节点中最多匹配pod的个数-当前节点pod的个数)/节点中最多匹配pod的个数。此时，分数越高表示该节点上匹配到的pod的个数越少，越可能被调度到，即满足把相同selector的pod分散到不同节点的需求。</li>
</ol>
<blockquote>
<p>此部分代码位于pkg/scheduler/algorithm/priorities/selector_spreading.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// CalculateSpreadPriorityReduce calculates the source of each node
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// based on the number of existing matching pods on the node
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// where zone information is included on the nodes, it favors nodes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// in zones with fewer existing matching pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">SelectorSpread</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">CalculateSpreadPriorityReduce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">nodeNameToInfo</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HostPriorityList</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">countsByZone</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxCountByZone</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxCountByNodeName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">maxCountByNodeName</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">maxCountByNodeName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilnode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetZoneKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">countsByZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">zoneID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">countsByZone</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">countsByZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">zoneID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">maxCountByZone</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">maxCountByZone</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">countsByZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">zoneID</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">haveZones</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">countsByZone</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxCountByNodeNameFloat64</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxCountByNodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">maxCountByZoneFloat64</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxCountByZone</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MaxPriorityFloat64</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxPriority</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// initializing to the default/max node score of maxPriority
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">fScore</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">MaxPriorityFloat64</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">maxCountByNodeName</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fScore</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">MaxPriorityFloat64</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxCountByNodeName</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">maxCountByNodeNameFloat64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// If there is zone information present, incorporate it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">haveZones</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilnode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetZoneKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">zoneScore</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">MaxPriorityFloat64</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">maxCountByZone</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">zoneScore</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">MaxPriorityFloat64</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxCountByZone</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">countsByZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">zoneID</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">maxCountByZoneFloat64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fScore</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fScore</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1.0</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">zoneWeighting</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">zoneWeighting</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">zoneScore</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fScore</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>				<span style="color:#4e9a06">&#34;%v -&gt; %v: SelectorSpreadPriority, Score: (%d)&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fScore</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下分段分析：</p>
<p>先获取所有节点中匹配到的pod最多的个数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">maxCountByNodeName</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">maxCountByNodeName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">utilnode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetZoneKey</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Host</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">zoneID</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">countsByZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">zoneID</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>遍历所有的节点，按比例取十分制的得分。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// initializing to the default/max node score of maxPriority
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fScore</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">MaxPriorityFloat64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">maxCountByNodeName</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fScore</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">MaxPriorityFloat64</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">maxCountByNodeName</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Score</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">maxCountByNodeNameFloat64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><h1 id="9-总结">9. 总结</h1>
<p>优选，从满足的节点中选择出最优的节点。<code>PrioritizeNodes</code>最终返回是一个记录了各个节点分数的列表。</p>
<h2 id="9-1-prioritizenodes">9.1. PrioritizeNodes</h2>
<p><strong>主要流程如下：</strong></p>
<ol>
<li>如果没有设置优选函数和拓展函数，则全部节点设置相同的分数，直接返回。</li>
<li>依次给node执行map函数进行打分。</li>
<li>再对上述map函数的执行结果执行reduce函数计算最终得分。</li>
<li>最后根据不同优先级函数的权重对得分取加权平均数。</li>
</ol>
<p>其中每类优选函数会包含map函数和reduce函数两种。</p>
<h2 id="9-2-newselectorspreadpriority">9.2. NewSelectorSpreadPriority</h2>
<p>其中以<code>NewSelectorSpreadPriority</code>这个优选函数为例作分析，该函数的功能是将相同service、RS、RC或statefulset下pod尽量分散到不同的节点上。包括map函数和reduce函数两部分，具体如下。</p>
<h3 id="9-2-1-calculatespreadprioritymap">9.2.1. CalculateSpreadPriorityMap</h3>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>寻找与该pod对应的service、RS、RC、statefulset匹配的selector。</li>
<li>遍历当前节点的所有pod，将该节点上已存在的selector匹配到的pod的个数作为该节点的分数（此时，分数大的表示匹配到的pod越多，越不符合被调度的条件，该分数在reduce阶段会被按10分制处理成分数大的越符合被调度的条件）。</li>
</ol>
<h3 id="9-2-2-calculatespreadpriorityreduce">9.2.2. CalculateSpreadPriorityReduce</h3>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>记录所有节点中匹配到pod个数最多的节点的分数（即匹配到的pod最多的个数）。</li>
<li>遍历所有的节点，按比例取十分制的得分，计算方式为：(节点中最多匹配pod的个数-当前节点pod的个数)/节点中最多匹配pod的个数。此时，分数越高表示该节点上匹配到的pod的个数越少，越可能被调度到，即满足把相同selector的pod分散到不同节点的需求。</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithm/priorities/selector_spreading.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/algorithm/priorities/selector_spreading.go</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-198aaa69380bc8e1d54162e3ae00b4be">7 - </h1>
    
	<h1 id="kube-scheduler源码分析-六-之-preempt">kube-scheduler源码分析（六）之 preempt</h1>
<blockquote>
<p>以下代码分析基于 <code>kubernetes v1.12.0</code> 版本。</p>
</blockquote>
<p>本文主要分析调度中的抢占逻辑，当pod不适合任何节点的时候，可能pod会调度失败，这时候可能会发生抢占。抢占逻辑的具体实现函数为<code>Scheduler.preempt</code>。</p>
<h1 id="1-调用入口">1. 调用入口</h1>
<p>当pod不适合任何节点的时候，可能pod会调度失败。这时候可能会发生抢占。</p>
<p><code>scheduleOne</code>函数中关于抢占调用的逻辑如下：</p>
<blockquote>
<p>此部分的代码位于/pkg/scheduler/scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// scheduleOne does the entire scheduling workflow for a single pod.  It is serialized on the scheduling algorithm&#39;s host fitting.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">scheduleOne</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">suggestedHost</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// schedule() may have failed because the pod would not fit on any host, so we try to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// preempt, with the expectation that the next time the pod is tried for scheduling it
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// will fit due to the preemption. It is also possible that a different pod will schedule
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// into the resources that were preempted, but this is harmless.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">core</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">preemptionStartTime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Now</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// 执行抢占逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionAttempts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Inc</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingAlgorithmPremptionEvaluationDuration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInMicroseconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SchedulingLatency</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithLabelValues</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionEvaluation</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SinceInSeconds</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptionStartTime</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><p>其中核心代码为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 基于sched.schedule(pod)返回的err和当前待调度的pod执行抢占策略
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="2-scheduler-preempt">2. Scheduler.preempt</h1>
<p>当pod调度失败的时候，会抢占低优先级pod的空间来给高优先级的pod。其中入参为调度失败的pod对象和调度失败的err。</p>
<p><strong>抢占的基本流程如下：</strong></p>
<ol>
<li>判断是否有关闭抢占机制，如果关闭抢占机制则直接返回。</li>
<li>获取调度失败pod的最新对象数据。</li>
<li>执行抢占算法<code>Algorithm.Preempt</code>，返回预调度节点和需要被剔除的pod列表。</li>
<li>将抢占算法返回的node添加到pod的<code>Status.NominatedNodeName</code>中，并删除需要被剔除的pod。</li>
<li>当抢占算法返回的node是nil的时候，清除pod的<code>Status.NominatedNodeName</code>信息。</li>
</ol>
<p>整个抢占流程的最终结果实际上是更新<code>Pod.Status.NominatedNodeName</code>属性的信息。如果抢占算法返回的节点不为空，则将该node更新到<code>Pod.Status.NominatedNodeName</code>中，否则就将<code>Pod.Status.NominatedNodeName</code>设置为空。</p>
<h2 id="2-1-preempt">2.1. preempt</h2>
<p>preempt的具体实现函数：</p>
<blockquote>
<p>此部分的代码位于/pkg/scheduler/scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// preempt tries to create room for a pod that has failed to schedule, by preempting lower priority pods if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// If it succeeds, it adds the name of the node where preemption has happened to the pod annotations.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It returns the node name and an error if any.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sched</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Scheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">scheduleErr</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPriorityEnabled</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DisablePreemption</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Pod priority feature is not enabled or preemption is disabled by scheduler configuration.&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>			<span style="color:#4e9a06">&#34; No preemption is performed.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetUpdatedPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error getting the updated preemptor pod object: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">victims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nominatedPodsToClear</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">scheduleErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metrics</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PreemptionVictims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victims</span><span style="color:#000;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error preempting victims to make room for %v/%v.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">nodeName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error in preemption process. Cannot update pod %v/%v annotations: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">victim</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">victims</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victim</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error preempting pod %v/%v: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">victim</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">victim</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Recorder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Eventf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victim</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EventTypeNormal</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Preempted&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;by %v/%v on node %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Clearing nominated pods should happen outside of &#34;if node != nil&#34;. Node could
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// be nil when a pod with nominated node name is eligible to preempt again,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// but preemption logic does not find any node for it. In that case Preempt()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// function of generic_scheduler.go returns the pod itself for removal of the annotation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nominatedPodsToClear</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">rErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rErr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Cannot remove nominated node annotation of pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// We do not return as this error is not critical.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以下对<code>preempt</code>的实现分段分析。</p>
<p>如果设置关闭抢占机制，则直接返回。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPriorityEnabled</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DisablePreemption</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Pod priority feature is not enabled or preemption is disabled by scheduler configuration.&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34; No preemption is performed.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>获取当前pod的最新状态。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetUpdatedPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error getting the updated preemptor pod object: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>GetUpdatedPod</code>的实现就是去拿pod的对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podPreemptor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">GetUpdatedPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>接着执行抢占的算法。抢占的算法返回预调度节点的信息和因抢占被剔除的pod的信息。具体的抢占算法逻辑下文分析。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">victims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nominatedPodsToClear</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">scheduleErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>将预调度节点的信息更新到pod的<code>Status.NominatedNodeName</code>属性中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">preemptor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>SetNominatedNodeName</code>的具体实现为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podPreemptor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">SetNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nominatedNodeName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podCopy</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeepCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podCopy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NominatedNodeName</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">nominatedNodeName</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">UpdateStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">podCopy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>接着删除因抢占而需要被剔除的pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victim</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>PodPreemptor.DeletePod</code>的具体实现就是删除具体的pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podPreemptor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">DeletePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CoreV1</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">metav1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DeleteOptions</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果抢占算法得出的node对象为nil，则将pod的<code>Status.NominatedNodeName</code>属性设置为空。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Clearing nominated pods should happen outside of &#34;if node != nil&#34;. Node could
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// be nil when a pod with nominated node name is eligible to preempt again,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// but preemption logic does not find any node for it. In that case Preempt()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// function of generic_scheduler.go returns the pod itself for removal of the annotation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nominatedPodsToClear</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sched</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodPreemptor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemoveNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rErr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Cannot remove nominated node annotation of pod: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rErr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// We do not return as this error is not critical.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>RemoveNominatedNodeName</code>的具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">podPreemptor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">RemoveNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NominatedNodeName</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetNominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="2-2-nominatednodename">2.2. NominatedNodeName</h2>
<p><code>Pod.Status.NominatedNodeName</code>的说明：</p>
<p><code>nominatedNodeName</code>是调度失败的pod抢占别的pod的时候，被抢占pod的运行节点。但在剔除被抢占pod之前该调度失败的pod不会被调度。同时也不保证最终该pod一定会调度到<code>nominatedNodeName</code>的机器上，也可能因为之后资源充足等原因调度到其他节点上。最终该pod会被加到调度的队列中。</p>
<p>其中加入到调度队列的具体过程如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewConfigFactory</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ConfigFactoryArgs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">scheduler</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Configurator</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#8f5902;font-style:italic">// unscheduled pod queue
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodInformer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Informer</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">AddEventHandler</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResourceEventHandlerFuncs</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">AddFunc</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addPodToSchedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">UpdateFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">updatePodInSchedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">DeleteFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deletePodFromSchedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>  
</span></span></code></pre></div><p><strong>addPodToSchedulingQueue:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">configFactory</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">addPodToSchedulingQueue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">podQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unable to queue %T: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>PriorityQueue.Add:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Add adds a pod to the active queue. It should be called only when a new pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// is added so there is no chance the pod is already in either queue.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PriorityQueue</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">activeQ</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error adding pod %v/%v to the scheduling queue: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unschedulableQ</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error: pod %v/%v is already in the unschedulable queue.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deleteNominatedPodIfExists</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unschedulableQ</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">addNominatedPodIfNeeded</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cond</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Broadcast</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>addNominatedPodIfNeeded:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// addNominatedPodIfNeeded adds a pod to nominatedPods if it has a NominatedNodeName and it does not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// already exist in the map. Adding an existing pod is not going to update the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">PriorityQueue</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">addNominatedPodIfNeeded</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nnn</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nnn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">np</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nominatedPods</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nnn</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">np</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UID</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Pod %v/%v already exists in the nominated map!&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nominatedPods</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nnn</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nominatedPods</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nnn</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>NominatedNodeName:</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NominatedNodeName returns nominated node name of a Pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NominatedNodeName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NominatedNodeName</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="3-genericscheduler-preempt">3. genericScheduler.Preempt</h1>
<p>抢占算法依然是在<code>ScheduleAlgorithm</code>接口中定义。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ScheduleAlgorithm is an interface implemented by things that know how to schedule pods
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// onto machines.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ScheduleAlgorithm</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Schedule</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">selectedMachine</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Preempt receives scheduling errors for a pod and tries to create room for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the pod by preempting lower priority pods if possible.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// It returns the node where preemption happened, a list of preempted pods, a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// list of pods whose nominated node name should be removed, and error if any.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">selectedNode</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preemptedPods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cleanupNominatedPods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Predicates() returns a pointer to a map of predicate functions. This is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// exposed for testing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Predicates</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">FitPredicate</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Prioritizers returns a slice of priority config. This is exposed for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// testing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">Prioritizers</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">PriorityConfig</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>Preempt</code>的具体实现为<code>genericScheduler</code>结构体。</p>
<p><code>Preempt</code>的主要实现是找到可以调度的节点和上面因抢占而需要被剔除的pod。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>根据调度失败的原因对所有节点先进行一批筛选，筛选出潜在的被调度节点列表。</li>
<li>通过<code>selectNodesForPreemption</code>筛选出需要牺牲的pod和其节点。</li>
<li>基于拓展抢占逻辑再次对上述筛选出来的牺牲者做过滤。</li>
<li>基于上述的过滤结果，选择一个最终可能因抢占被调度的节点。</li>
<li>基于上述的候选节点，找出该节点上优先级低于当前被调度pod的牺牲者pod列表。</li>
</ol>
<p>完整代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// preempt finds nodes with pods that can be preempted to make room for &#34;pod&#34; to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// schedule. It chooses one of the nodes and preempts the pods on the node and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// returns 1) the node, 2) the list of preempted pods if such a node is found,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 3) A list of pods whose nominated node name should be cleared, and 4) any
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// possible error.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Preempt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeLister</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeLister</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">scheduleErr</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Scheduler may return various types of errors. Consider preemption only if
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the error is of type FitError.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">scheduleErr</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">FitError</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">fitError</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UpdateNodeNameToInfoMap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">podEligibleToPreemptOthers</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Pod %v/%v is not eligible for more preemption.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeLister</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">List</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ErrNoNodesAvailable</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">potentialNodes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodesWherePreemptionMightHelp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">allNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FailedPredicates</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potentialNodes</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Preemption will not help schedule pod %v/%v on any node.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Namespace</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// In this case, we should clean-up any existing nominated node name of the pod.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pdbs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListPDBs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">labels</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Everything</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// 找出可能被抢占的节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">selectNodesForPreemption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">potentialNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicateMetaProducer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedulingQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pdbs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We will only check nodeToVictims with extenders that support preemption.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Extenders which do not support preemption may later prevent preemptor from being scheduled on the nominated
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// node. In that case, scheduler will find a different host for the preemptor in subsequent scheduling cycles.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processPreemptionWithExtenders</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 选出最终被抢占的节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">candidateNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pickOneNodeForPreemption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">candidateNode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Lower priority pods nominated to run on this node, may no longer fit on
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// this node. So, we should remove their nomination. Removing their
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// nomination updates these pods and moves them to the active queue. It
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// lets scheduler find another place for them.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// 找出被强占节点上牺牲者pod列表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">nominatedPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getLowerPriorityNominatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nominatedPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;preemption failed: the target node %s has been deleted from scheduler cache&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<p>以下对<code>genericScheduler.Preempt</code>分段进行分析。</p>
<h2 id="3-1-selectnodesforpreemption">3.1. selectNodesForPreemption</h2>
<p><code>selectNodesForPreemption</code>并行地所有节点中找可能被抢占的节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">selectNodesForPreemption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">potentialNodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predicateMetaProducer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedulingQueue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pdbs</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>selectNodesForPreemption</code>主要基于<code>selectVictimsOnNode</code>构造一个checkNode的函数，然后并发执行该函数。</p>
<p><code>selectNodesForPreemption</code>具体实现如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// selectNodesForPreemption finds all the nodes with possible victims for
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// preemption in parallel.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">selectNodesForPreemption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeNameToInfo</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">potentialNodes</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">predicates</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">metadataProducer</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadataProducer</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">queue</span> <span style="color:#000">SchedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pdbs</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">policy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodDisruptionBudget</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Victims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeToVictims</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Victims</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">resultLock</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// We can use the same metadata producer for all nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">meta</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">metadataProducer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">checkNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">potentialNodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Name</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">metaCopy</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadata</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">meta</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">metaCopy</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ShallowCopy</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">numPDBViolations</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fits</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">selectVictimsOnNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">metaCopy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeNameToInfo</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">predicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pdbs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fits</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">resultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">victims</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Victims</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">:</span>             <span style="color:#000">pods</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">NumPDBViolations</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">numPDBViolations</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">potentialNodes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">victims</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">resultLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">workqueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parallelize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potentialNodes</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">checkNode</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="3-1-1-selectvictimsonnode">3.1.1. selectVictimsOnNode</h3>
<p><code>selectVictimsOnNode</code>找到应该被抢占的给定节点上的最小pod集合，以便给调度失败的pod安排足够的空间。该函数最终返回的是一个pod的数组。当有更低优先级的pod可能被选择的时候，较高优先级的pod不会被选入该待剔除的pod集合。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>先检查当该节点上所有低于预被调度pod优先级的pod移除后，该pod能否被调度到当前节点上。</li>
<li>如果上述检查可以，则将该节点的所有低优先级pod按照优先级来排序。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// selectVictimsOnNode finds minimum set of pods on the given node that should
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// be preempted in order to make enough room for &#34;pod&#34; to be scheduled. The
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// minimum set selected is subject to the constraint that a higher-priority pod
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// is never preempted when a lower-priority pod could be (higher/lower relative
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// to one another, not relative to the preemptor &#34;pod&#34;).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The algorithm first checks if the pod can be scheduled on the node when all the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// lower priority pods are gone. If so, it sorts all the lower priority pods by
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// their priority and then puts them into two groups of those whose PodDisruptionBudget
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// will be violated if preempted and other non-violating pods. Both groups are
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// sorted by priority. It first tries to reprieve as many PDB violating pods as
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// possible and then does them same for non-PDB-violating pods while checking
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// that the &#34;pod&#34; can still fit on the node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NOTE: This function assumes that it is never called if &#34;pod&#34; cannot be scheduled
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// due to pod affinity, node affinity, or node anti-affinity reasons. None of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// these predicates can be satisfied by removing more pods from the node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">selectVictimsOnNode</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">meta</span> <span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PredicateMetadata</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeInfo</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulercache</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NodeInfo</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fitPredicates</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">algorithm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FitPredicate</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">queue</span> <span style="color:#000">SchedulingQueue</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pdbs</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">policy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">PodDisruptionBudget</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">potentialVictims</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SortableList</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">CompFunc</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HigherPriorityPod</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeInfoCopy</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Clone</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">removePod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rp</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeInfoCopy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">meta</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RemovePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">addPod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ap</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nodeInfoCopy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ap</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">meta</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">meta</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoCopy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// As the first step, remove all the lower priority pods from the node and
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// check if the given pod can be scheduled.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">podPriority</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodeInfoCopy</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podPriority</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">potentialVictims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Items</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potentialVictims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Items</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">removePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">potentialVictims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sort</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// If the new pod does not fit after removing all the lower priority pods,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// we are almost done and this node is not suitable for preemption. The only condition
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// that we should check is if the &#34;pod&#34; is failing to schedule due to pod affinity
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// failure.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// TODO(bsalamat): Consider checking affinity to lower priority pods if feasible with reasonable performance.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podFitsOnNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoCopy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitPredicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">fits</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Encountered error while selecting victims on node %v: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">victims</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">numViolatingVictim</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Try to reprieve as many pods as possible. We first try to reprieve the PDB
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// violating victims and then other non-violating ones. In both cases, we start
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// from the highest priority victims.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">violatingVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nonViolatingVictims</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">filterPodsWithPDBViolation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potentialVictims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Items</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pdbs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">reprievePod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">addPod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fits</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">podFitsOnNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">meta</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfoCopy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fitPredicates</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">fits</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">removePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">victims</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">V</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Infof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Pod %v is a potential preemption victim on node %v.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fits</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">violatingVictims</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">reprievePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">numViolatingVictim</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Now we try to reprieve non-violating victims.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nonViolatingVictims</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">reprievePod</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">victims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">numViolatingVictim</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-2-processpreemptionwithextenders">3.2. processPreemptionWithExtenders</h2>
<p><code>processPreemptionWithExtenders</code>基于<code>selectNodesForPreemption</code>选出的牺牲者进行扩展的抢占逻辑继续筛选牺牲者。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// We will only check nodeToVictims with extenders that support preemption.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Extenders which do not support preemption may later prevent preemptor from being scheduled on the nominated
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// node. In that case, scheduler will find a different host for the preemptor in subsequent scheduling cycles.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">processPreemptionWithExtenders</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>processPreemptionWithExtenders</code>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// processPreemptionWithExtenders processes preemption with extenders
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">processPreemptionWithExtenders</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nodeToVictims</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Victims</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Victims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">extender</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extenders</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SupportsPreemption</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsInterested</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">newNodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ProcessPreemption</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">extender</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsIgnorable</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Warningf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Skipping extender %v as it returned error %v and has ignorable flag set&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>							<span style="color:#000">extender</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>						<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// Replace nodeToVictims with new result after preemption. So the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#8f5902;font-style:italic">// rest of extenders can continue use it as parameter.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#000">nodeToVictims</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newNodeToVictims</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// If node list becomes empty, no preemption can happen regardless of other extenders.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-3-pickonenodeforpreemption">3.3. pickOneNodeForPreemption</h2>
<p><code>pickOneNodeForPreemption</code>从筛选出的node中再挑选一个节点作为最终调度节点。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">candidateNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pickOneNodeForPreemption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">candidateNode</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>pickOneNodeForPreemption</code>完整代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pickOneNodeForPreemption chooses one node among the given nodes. It assumes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// pods in each map entry are ordered by decreasing priority.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// It picks a node based on the following criteria:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 1. A node with minimum number of PDB violations.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 2. A node with minimum highest priority victim is picked.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 3. Ties are broken by sum of priorities of all victims.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 4. If there are still ties, node with the minimum number of victims is picked.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 5. If there are still ties, the first such node is picked (sort of randomly).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// The &#39;minNodes1&#39; and &#39;minNodes2&#39; are being reused here to save the memory
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// allocation and garbage collection time.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">pickOneNodeForPreemption</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodesToVictims</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">schedulerapi</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Victims</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodesToVictims</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">minNumPDBViolatingPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxInt32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">minNodes1</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lenNodes1</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">victims</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodesToVictims</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// We found a node that doesn&#39;t need any preemption. Return it!
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// This should happen rarely when one or more pods are terminated between
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// the time that scheduler tries to schedule the pod and the time that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// preemption logic tries to find nodes for preemption.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">node</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">numPDBViolatingPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">victims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumPDBViolations</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">numPDBViolatingPods</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minNumPDBViolatingPods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNumPDBViolatingPods</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">numPDBViolatingPods</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNodes1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">numPDBViolatingPods</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">minNumPDBViolatingPods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNodes1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">minNodes1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes1</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">lenNodes1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">minNodes1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// There are more than one node with minimum number PDB violating pods. Find
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// the one with minimum highest priority victim.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">minHighestPriority</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxInt32</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">minNodes2</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lenNodes1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lenNodes2</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">lenNodes1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">minNodes1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">victims</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">nodesToVictims</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// highestPodPriority is the highest priority among the victims on this node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">highestPodPriority</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">victims</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">highestPodPriority</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minHighestPriority</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minHighestPriority</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">highestPodPriority</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes2</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">highestPodPriority</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">minHighestPriority</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNodes2</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">lenNodes2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">node</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes2</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">lenNodes2</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">minNodes2</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// There are a few nodes with minimum highest priority victim. Find the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// smallest sum of priorities.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">minSumPriorities</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxInt64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lenNodes1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">lenNodes2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sumPriorities</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">minNodes2</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">nodesToVictims</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// We add MaxInt32+1 to all priorities to make all of them &gt;= 0. This is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// needed so that a node with a few pods with negative priority is not
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// picked over a node with a smaller number of pods with the same negative
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// priority (and similar scenarios).
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">sumPriorities</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxInt32</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">sumPriorities</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minSumPriorities</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minSumPriorities</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sumPriorities</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">sumPriorities</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">minSumPriorities</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNodes1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">lenNodes1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">node</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes1</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">lenNodes1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">minNodes1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// There are a few nodes with minimum highest priority victim and sum of priorities.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Find one with the minimum number of pods.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">minNumPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MaxInt32</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lenNodes2</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">lenNodes1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">minNodes1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">numPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodesToVictims</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">numPods</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minNumPods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNumPods</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">numPods</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes2</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">numPods</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">minNumPods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minNodes2</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">lenNodes2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">node</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lenNodes2</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// At this point, even if there are more than one node with the same score,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// return the first one.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">lenNodes2</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">minNodes2</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">glog</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error in logic of node scoring for preemption. We should never reach here!&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="3-4-getlowerprioritynominatedpods">3.4. getLowerPriorityNominatedPods</h2>
<p><code>getLowerPriorityNominatedPods</code>的基本流程如下：</p>
<ol>
<li>获取候选节点上的pod列表。</li>
<li>获取待调度pod的优先级值。</li>
<li>遍历该节点的pod列表，如果低于待调度pod的优先级则放入低优先级pod列表中。</li>
</ol>
<p>genericScheduler.Preempt中相关代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Lower priority pods nominated to run on this node, may no longer fit on
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// this node. So, we should remove their nomination. Removing their
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// nomination updates these pods and moves them to the active queue. It
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// lets scheduler find another place for them.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">nominatedPods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getLowerPriorityNominatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedNodeInfoMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">nodeInfo</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">nodeToVictims</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">candidateNode</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">Pods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nominatedPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>getLowerPriorityNominatedPods</code>代码如下：</p>
<blockquote>
<p>此部分代码位于pkg/scheduler/core/generic_scheduler.go</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// getLowerPriorityNominatedPods returns pods whose priority is smaller than the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// priority of the given &#34;pod&#34; and are nominated to run on the given node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Note: We could possibly check if the nominated lower priority pods still fit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and return those that no longer fit, but that would require lots of
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// manipulation of NodeInfo and PredicateMeta per nominated pod. It may not be
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// worth the complexity, especially because we generally expect to have a very
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// small number of nominated pods per node.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">g</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">genericScheduler</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">getLowerPriorityNominatedPods</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nodeName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pods</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">g</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schedulingQueue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitingPodsForNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodeName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pods</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">lowerPriorityPods</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pod</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">podPriority</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pod</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">pods</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">util</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetPodPriority</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">podPriority</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">lowerPriorityPods</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lowerPriorityPods</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">lowerPriorityPods</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h1 id="4-总结">4. 总结</h1>
<h2 id="4-1-scheduler-preempt">4.1. Scheduler.preempt</h2>
<p>当pod调度失败的时候，会抢占低优先级pod的空间来给高优先级的pod。其中入参为调度失败的pod对象和调度失败的err。</p>
<p><strong>抢占的基本流程如下：</strong></p>
<ol>
<li>判断是否有关闭抢占机制，如果关闭抢占机制则直接返回。</li>
<li>获取调度失败pod的最新对象数据。</li>
<li>执行抢占算法<code>Algorithm.Preempt</code>，返回预调度节点和需要被剔除的pod列表。</li>
<li>将抢占算法返回的node添加到pod的<code>Status.NominatedNodeName</code>中，并删除需要被剔除的pod。</li>
<li>当抢占算法返回的node是nil的时候，清除pod的<code>Status.NominatedNodeName</code>信息。</li>
</ol>
<p>整个抢占流程的最终结果实际上是更新<code>Pod.Status.NominatedNodeName</code>属性的信息。如果抢占算法返回的节点不为空，则将该node更新到<code>Pod.Status.NominatedNodeName</code>中，否则就将<code>Pod.Status.NominatedNodeName</code>设置为空。</p>
<h2 id="4-2-genericscheduler-preempt">4.2. genericScheduler.Preempt</h2>
<p><code>Preempt</code>的主要实现是找到可以调度的节点和上面因抢占而需要被剔除的pod。</p>
<p><strong>基本流程如下：</strong></p>
<ol>
<li>根据调度失败的原因对所有节点先进行一批筛选，筛选出潜在的被调度节点列表。</li>
<li>通过<code>selectNodesForPreemption</code>筛选出需要牺牲的pod和其节点。</li>
<li>基于拓展抢占逻辑再次对上述筛选出来的牺牲者做过滤。</li>
<li>基于上述的过滤结果，选择一个最终可能因抢占被调度的节点。</li>
<li>基于上述的候选节点，找出该节点上优先级低于当前被调度pod的牺牲者pod列表。</li>
</ol>
<p>参考：</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/scheduler.go</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go">https://github.com/kubernetes/kubernetes/blob/v1.12.0/pkg/scheduler/core/generic_scheduler.go</a></li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/huweihuang/blog.huweihuang.com" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2023 www.huweihuang.com 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/about/">About</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
